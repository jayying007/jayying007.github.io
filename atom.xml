<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://jayying007.github.io</id>
    <title>å½±å¸çš„ç½‘ç»œæ—¥å¿—</title>
    <updated>2025-06-24T15:02:58.019Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://jayying007.github.io"/>
    <link rel="self" href="https://jayying007.github.io/atom.xml"/>
    <logo>https://jayying007.github.io/images/avatar.png</logo>
    <icon>https://jayying007.github.io/favicon.ico</icon>
    <rights>All rights reserved 2025, å½±å¸çš„ç½‘ç»œæ—¥å¿—</rights>
    <entry>
        <title type="html"><![CDATA[è®°ä¸€æ¬¡éº¦å…‹é£å¼‚å¸¸çš„æ’æŸ¥ç»å†]]></title>
        <id>https://jayying007.github.io/post/ji-yi-ci-mai-ke-feng-yi-chang-de-pai-cha-jing-li/</id>
        <link href="https://jayying007.github.io/post/ji-yi-ci-mai-ke-feng-yi-chang-de-pai-cha-jing-li/">
        </link>
        <updated>2025-06-24T00:40:40.000Z</updated>
        <content type="html"><![CDATA[<h2 id="å¤ç°æ–¹å¼">å¤ç°æ–¹å¼</h2>
<p>è¿›å…¥è…¾è®¯ä¼šè®®appï¼Œç„¶åæŠŠéº¦å…‹é£å…³é—­ï¼Œè¿™ä¸ªæ—¶å€™æ‰‹æœºä¸Šçš„å°é»„ç‚¹ä¼šæ¶ˆå¤±ã€‚<br>
ç„¶åä½¿ç”¨å…¶ä»–appçš„å½•éŸ³åŠŸèƒ½ï¼Œæ¯”å¦‚ç³»ç»Ÿçš„è¯­éŸ³å¤‡å¿˜å½•ã€QQã€å¾®ä¿¡ï¼Œè¿™ä¸ªæ—¶å€™è™½ç„¶å½•éŸ³æ­£å¸¸å¯åŠ¨ï¼Œä¹Ÿå‡ºç°å°é»„ç‚¹ï¼Œä½†å®é™…ä¸Šä»€ä¹ˆå£°éŸ³éƒ½æ²¡æœ‰ã€‚</p>
<h2 id="æ’æŸ¥è¿‡ç¨‹">æ’æŸ¥è¿‡ç¨‹</h2>
<p>é€šè¿‡AudioQueueå®ç°çš„å½•éŸ³ï¼Œå¯åŠ¨éƒ½æ²¡æœ‰ä»€ä¹ˆé”™è¯¯ã€‚<br>
ç„¶åé€šè¿‡LevelMeteræ£€æŸ¥æ•°æ®çš„éŸ³é‡ï¼Œå‘ç°å…¨æ˜¯0ã€‚</p>
<p>å†çœ‹çœ‹AudioSessionçš„å„ç§æ¥å£ï¼ŒsetActiveã€setCategoryéƒ½æ˜¯æ­£å¸¸çš„ã€‚</p>
<p>å¥½å¥‡æ€ªğŸ¤”</p>
<p>ç»è¿‡æµ‹è¯•ï¼Œè¿™æ—¶ä½¿ç”¨å¾®ä¿¡çš„è¯­éŸ³é€šè¯ï¼Œæ˜¯å¯ä»¥ä½¿ç”¨éº¦å…‹é£çš„ã€‚<br>
æ­¤æ—¶å›åˆ°è…¾è®¯ä¼šè®®ï¼Œä¼šå‡ºç°ä¸­æ–­çš„æç¤ºã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰ä½¿ç”¨AudioUnitæ‰èƒ½æŠŠéŸ³é¢‘æƒé™æŠ¢å›æ¥ï¼Œç„¶åè…¾è®¯ä¼šè®®æ”¶åˆ°AudioSessionInterruptçš„é€šçŸ¥ï¼Œå‡ºç°æç¤ºã€‚</p>
<p>äºæ˜¯ä¹ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªAudioUnitçš„å½•éŸ³demoï¼Œè€Œè¿™ä¸ªä¹‹å‰æ—©å°±å†™è¿‡äº†ã€‚<br>
https://github.com/jayying007/iOSDemos</p>
<p>æµ‹è¯•æ—¶å‘ç°ï¼Œå³ä½¿æ˜¯AudioUnitï¼Œé€‰æ‹©RemoteIOä¹Ÿæ˜¯ä¸è¡Œçš„ï¼Œéœ€è¦é€‰æ‹©VoiceProcessingIOã€‚</p>
<p>å¦å¤–ä¸€ä¸ªå‘ç°æ˜¯ï¼Œä½¿ç”¨AudioQueueï¼Œåªè¦æŠŠAudioSession setCategoryçš„option AudioSessionModeVoiceChatåŠ ä¸Šï¼Œä¹Ÿæ˜¯å¯ä»¥æ‰“æ–­è…¾è®¯ä¼šè®®ï¼ŒæŠŠéº¦å…‹é£æŠ¢å›æ¥çš„ã€‚</p>
<p>ä½†æ˜¯è¯è¯´å›æ¥ï¼ŒAudioUnitæœ¬èº«æ˜¯ç”¨äºé€šè¯ç±»åœºæ™¯çš„ï¼Œè¿™é‡Œå½•éŸ³ä½¿ç”¨çœŸçš„å¥½å—ï¼Ÿ</p>
<h2 id="ç–‘é—®">ç–‘é—®</h2>
<p>ä¸€ä¸ªæ”¯çº¿ä»»åŠ¡ï¼šå¦‚ä½•å®ç°å…³é—­éº¦å…‹é£ï¼Œå³ä¸Šè§’çš„å°é»„ç‚¹æ¶ˆå¤±ï¼ŸğŸ¤”</p>
<p>è¯•äº†ä¸‹ï¼ŒAudioUnité€šè¿‡EnableIOæŠŠè¾“å…¥é€šé“ç»™å…³é—­äº†ï¼Œä¾ç„¶ä¸è¡Œã€‚</p>
<p>æœ€åè¯•äº†ä¸‹setInputMutedè¿™ä¸ªæ¥å£ï¼Œå‘ç°å¯è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥ä»¿ç…§è…¾è®¯ä¼šè®®çš„é€»è¾‘ï¼Œå±è”½æ‰å…¶ä»–Appçš„å½•éŸ³ã€‚</p>
<h2 id="ç»“è®º">ç»“è®º</h2>
<p>æˆ‘è§‰å¾—è¿™æ˜¯è‹¹æœğŸçš„bugï¼Œå…¶ä»–AppæŠŠéº¦å…‹é£å…³é—­çš„æ—¶å€™æ— æ³•å½•éŸ³ï¼ŒæŠŠéº¦å…‹é£æ‰“å¼€çš„æ—¶å€™åˆå¯ä»¥å½•éŸ³ã€‚<br>
setInputMutedè¿™ä¸ªé€»è¾‘æœ¬æ¥æ˜¯æ¯ä¸ªAppå•ç‹¬è®¾ç½®çš„ï¼Œæ€ä¹ˆè¿™é‡Œä¼šå½±å“åˆ°å…¨éƒ¨appå‘¢ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[iOS æ˜¾ç¤ºHDRç»„ä»¶]]></title>
        <id>https://jayying007.github.io/post/ios-xian-shi-hdr-zu-jian/</id>
        <link href="https://jayying007.github.io/post/ios-xian-shi-hdr-zu-jian/">
        </link>
        <updated>2025-06-24T00:36:06.000Z</updated>
        <content type="html"><![CDATA[<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>åœ¨iOSä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºHDRå›¾ç‰‡ï¼Œæ’­æ”¾HDRè§†é¢‘ï¼Œä½†èƒ½ä¸èƒ½æ˜¾ç¤ºHDRæ§ä»¶å‘¢ï¼Ÿ</p>
<p>æ¯”å¦‚æ–‡å­—ã€æŒ‰é’®ã€è¿›åº¦æ¡è¿™äº›ã€‚åœ¨ç³»ç»Ÿç›¸å†Œä¸­ï¼Œæ’­æ”¾HDRè§†é¢‘æ—¶ï¼Œä½ ä¼šå‘ç°è¿›åº¦æ¡ä¹Ÿæœ‰HDRæ•ˆæœã€‚</p>
<h2 id="hdrå›¾ç‰‡">HDRå›¾ç‰‡</h2>
<p>åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹æ˜¾ç¤ºHDRå›¾ç‰‡çš„æ–¹æ³•ã€‚</p>
<pre><code class="language-objective-c">NSString *imagePath = [[NSBundle mainBundle] pathForResource:@&quot;IMG_4167.HEIC&quot; ofType:nil];

UIImage *image = [UIImageReader.defaultReader imageWithContentsOfFileURL:[NSURL fileURLWithPath:imagePath]];

UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake(60, 120, 120, 120)];
imageView.image = image;
imageView.preferredImageDynamicRange = UIImageDynamicRangeHigh;
</code></pre>
<p>é‚£ä¹ˆï¼Œæ˜¯ä¸æ˜¯ç”¨HDRå›¾ç‰‡ç”ŸæˆUIæ§ä»¶å°±å¥½äº†ï¼Ÿ</p>
<p>ç†è®ºä¸Šçœ‹èµ·æ¥æ˜¯å¯è¡Œçš„ï¼Œä¸è¿‡å®é™…ä¸Šæ–‡æœ¬è¦æ€ä¹ˆå¤„ç†ï¼Ÿ</p>
<h2 id="hdr-æ§ä»¶">HDR æ§ä»¶</h2>
<p>ç»è¿‡ä¸€ç•ªæœæŸ¥ï¼Œåœ¨Githubä¸Šå‘ç°äº†è¿™ä¸ªé¡¹ç›®ï¼š<br>
<a href="https://github.com/tsuzukihashi/EDR_Swift">GitHub - tsuzukihashi/EDR_Swift: I want to use EDR features easily.</a></p>
<p>ä½œè€…æ˜¯ç”¨CoreImageçš„æ–¹å¼ï¼Œç”Ÿæˆäº†HDRçš„äºŒç»´ç å’Œæ¡å½¢ç ï¼Œç„¶åç”¨MetalKitå°†å…¶æ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚</p>
<p>è¿™ç§æ–¹æ³•åœ¨ä¸€æ¬¡WWDCçš„åˆ†äº«ä¸­æœ‰æåŠè¿‡ï¼š<br>
<a href="https://developer.apple.com/videos/play/wwdc2022/10114/">Display EDR content with Core Image, Metal, and SwiftUI - WWDC22 - Videos - Apple Developer</a></p>
<p>æŸ¥çœ‹CoreImageçš„ç›¸å…³æ¥å£ï¼Œå‘ç°äº†ç”Ÿæˆæ–‡æœ¬å›¾ç‰‡çš„æ–¹å¼ã€‚</p>
<pre><code class="language-objective-c">@interface CIFilter (Builtins)
+ (CIFilter&lt;CITextImageGenerator&gt;*) textImageGeneratorFilter;
+ (CIFilter&lt;CIAttributedTextImageGenerator&gt;*) attributedTextImageGeneratorFilter;
@end
</code></pre>
<p>ä½†æ˜¯è¿™ä¸¤ä¸ªæ¥å£æ— æ³•å¤„ç†æ–‡æœ¬æˆªæ–­çš„åœºæ™¯ï¼ŒCoreImageæ²¡æœ‰å®½åº¦è¿™äº›ä¿¡æ¯ã€‚<br>
å®é™…ä¸Šï¼Œæˆ‘ä»¬è¦çš„æ˜¯CIImageï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡Core Graphicsç»˜åˆ¶æ–‡æœ¬ä¸ºCGImageï¼Œå†è½¬æ¢æˆCIImageå°±å¯ä»¥äº†ã€‚</p>
<hr>
<p>äºæ˜¯ä¹ï¼Œæ¸²æŸ“HDR Labelä¾¿æˆä¸ºäº†å¯èƒ½ã€‚<br>
å¯ä»¥ä»¿ç…§ä¸Šé¢çš„é¡¹ç›®å®ç°ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p>
<pre><code class="language-objective-c">#import &lt;Foundation/Foundation.h&gt;
#import &lt;MetalKit/MetalKit.h&gt;

@interface MetalRender : NSObject &lt;MTKViewDelegate&gt;

- (instancetype)initWithImageProvider:(CIImage * (^)(CGFloat contentScaleFactor, CGFloat headroom))imageProvider;

@property (nonatomic) id&lt;MTLDevice&gt; device;

@end
</code></pre>
<pre><code class="language-objective-c">#import &quot;MetalRender.h&quot;

@interface MetalRender ()

@property (nonatomic) id&lt;MTLCommandQueue&gt; commandQueue;
@property (nonatomic) CIContext *renderContext;

@property (nonatomic) CIImage * (^imageProvider)(CGFloat contentScaleFactor, CGFloat headroom);

@end

@implementation MetalRender

- (instancetype)initWithImageProvider:(CIImage * (^)(CGFloat, CGFloat))imageProvider {
	self = [super init];
	if (self) {
		self.imageProvider = imageProvider;
		self.device = MTLCreateSystemDefaultDevice();
		self.commandQueue = [self.device newCommandQueue];
		self.renderContext = [CIContext
		contextWithMTLCommandQueue:self.commandQueue
		options:@{ kCIContextName : @&quot;MetalRender&quot;, kCIContextCacheIntermediates : @(YES), kCIContextAllowLowPower : @(YES) }];
	}
	return self;
}

- (void)drawInMTKView:(MTKView *)view {
	// Create a new command buffer for each render pass to the current drawable.
	id&lt;MTLCommandBuffer&gt; commandBuffer = [_commandQueue commandBuffer];
	
	id&lt;CAMetalDrawable&gt; drawable = view.currentDrawable;
	if (drawable == nil) {
		return;
	}
	CGSize drawSize = view.drawableSize;
	CGFloat contentScaleFactor = view.contentScaleFactor;
	
	CIRenderDestination *destination = [[CIRenderDestination alloc] initWithWidth:drawSize.width
																		   height:drawSize.height
																	  pixelFormat:view.colorPixelFormat
																	commandBuffer:commandBuffer
															   mtlTextureProvider:^id&lt;MTLTexture&gt; {
																   return drawable.texture;
															   }];
																	
	if (@available(iOS 16.0, *)) {
		CGFloat headroom = view.window.screen.currentEDRHeadroom;
		CIImage *image = self.imageProvider(contentScaleFactor, headroom);
		
		CGRect iRect = [image extent];
		CGRect backBounds = CGRectMake(0, 0, drawSize.width, drawSize.height);
		CGFloat shiftX = round((backBounds.size.width + iRect.origin.x - iRect.size.width) * 0.5);
		CGFloat shiftY = round((backBounds.size.height + iRect.origin.y - iRect.size.height) * 0.5);
		image = [image imageByApplyingTransform:CGAffineTransformMakeTranslation(shiftX, shiftY)];
		
		[_renderContext startTaskToRender:image fromRect:backBounds toDestination:destination atPoint:CGPointZero error:nil];
	}
	
	[commandBuffer presentDrawable:drawable];
	[commandBuffer commit];
}

- (void)mtkView:(MTKView *)view drawableSizeWillChange:(CGSize)size {

}

@end
</code></pre>
<pre><code class="language-objective-c">#import &lt;MetalKit/MetalKit.h&gt;
#import &quot;MetalRender.h&quot;

@interface MetalView : MTKView

- (instancetype)initWithFrame:(CGRect)frame render:(MetalRender *)render;

@end
</code></pre>
<pre><code class="language-objective-c">#import &quot;MetalView.h&quot;

@interface MetalView ()

@property (nonatomic) MetalRender *render;

@end

@implementation MetalView

- (instancetype)initWithFrame:(CGRect)frame render:(MetalRender *)render {
	self = [super initWithFrame:frame device:render.device];
	if (self) {
		self.render = render;
		
		self.preferredFramesPerSecond = 10;
		self.framebufferOnly = NO;
		self.delegate = self.render;
		self.backgroundColor = UIColor.clearColor;
		
		CAMetalLayer *layer = (CAMetalLayer *)self.layer;
		if (@available(iOS 16.0, *)) {
			layer.wantsExtendedDynamicRangeContent = YES;
		}
		layer.colorspace = CGColorSpaceCreateWithName(kCGColorSpaceExtendedLinearSRGB);
		self.colorPixelFormat = MTLPixelFormatRGBA16Float;
	}
	return self;
}

@end
</code></pre>
<pre><code class="language-objective-c">#import &lt;UIKit/UIKit.h&gt;

@interface EDRLabel : UIView

@property (nonatomic) NSString *text;

- (void)applyStyleWithLabel:(UILabel *)label;

@end
</code></pre>
<pre><code class="language-objective-c">#import &quot;EDRLabel.h&quot;
#import &quot;MetalView.h&quot;
#import &lt;CoreImage/CIFilterBuiltins.h&gt;

@interface EDRLabel ()

@property (nonatomic) MetalView *metalView;
@property (nonatomic) CIImage *ciImage;

@property (nonatomic) UIFont *font;
@property (nonatomic) UIColor *textColor;
@property (nonatomic) NSLineBreakMode lineBreakMode;
@property (nonatomic) NSInteger numberOfLines;

@end

@implementation EDRLabel

- (instancetype)initWithFrame:(CGRect)frame {
	self = [super initWithFrame:frame];
	if (self) {
		__weak typeof(self) weakSelf = self;
		MetalRender *render = [[MetalRender alloc] initWithImageProvider:^CIImage *(CGFloat contentScaleFactor, CGFloat headroom) {
			__strong typeof(self) strongSelf = weakSelf;
			CIImage *image = strongSelf.ciImage;
			CGFloat red, green, blue, alpha;
			[strongSelf.textColor getRed:&amp;red green:&amp;green blue:&amp;blue alpha:&amp;alpha];
			
			CGColorSpaceRef colorSpace = CGColorSpaceCreateWithName(kCGColorSpaceExtendedLinearSRGB);
			CIColor *maxFillColor = [CIColor colorWithRed:headroom * red
													green:headroom * green
													 blue:headroom * blue
													alpha:alpha
											   colorSpace:colorSpace];
			
			CIImage *fillImage = [CIImage imageWithColor:maxFillColor];
			CIFilter&lt;CIBlendWithMask&gt; *maskFilter = [CIFilter blendWithAlphaMaskFilter];
			maskFilter.maskImage = image;
			maskFilter.inputImage = fillImage;
			
			return [maskFilter.outputImage
			imageByCroppingToRect:CGRectMake(0, 0, strongSelf.width * contentScaleFactor, strongSelf.height * contentScaleFactor)];
		}];
		
		self.metalView = [[MetalView alloc] initWithFrame:frame render:render];
		[self addSubview:self.metalView];
		self.userInteractionEnabled = NO;
	}
	return self;
}

- (void)applyStyleWithLabel:(UILabel *)label {
	self.text = label.text;
	self.font = label.font;
	self.textColor = label.textColor;
	self.lineBreakMode = label.lineBreakMode;
	self.numberOfLines = label.numberOfLines;
}

- (void)layoutSubviews {
	[super layoutSubviews];

	self.metalView.frame = self.bounds;
}

- (void)setFrame:(CGRect)frame {
	BOOL sizeChange = self.bounds.size.width != frame.size.width || self.bounds.size.height != frame.size.height;
	if (sizeChange) {
		_ciImage = nil;
	}
	
	[super setFrame:frame];
}

- (void)setText:(NSString *)text {
	_text = text;
	_ciImage = nil;
}

- (CIImage *)ciImage {
	if (_ciImage == nil) {
		UILabel *label = [[UILabel alloc] initWithFrame:self.bounds];
		label.text = self.text;
		label.font = self.font;
		label.lineBreakMode = self.lineBreakMode;
		label.numberOfLines = self.numberOfLines;
		
		UIGraphicsImageRenderer *render = [[UIGraphicsImageRenderer alloc] initWithBounds:label.bounds];
		UIImage *image = [render imageWithActions:^(UIGraphicsImageRendererContext *_Nonnull rendererContext) {
			[label.layer renderInContext:rendererContext.CGContext];
		}];
		
		_ciImage = [[CIImage alloc] initWithImage:image];
	}
	return _ciImage;
}

@end
</code></pre>
<p>æœ€éš¾çš„æ–‡æœ¬è§£å†³äº†ï¼Œé‚£å®ç°HDRçš„UILabelã€UIButtonã€UISliderå°±ä¸æ˜¯å¤ªå¤æ‚çš„äº‹æƒ…äº†ã€‚è¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h2 id="hdr-color">HDR Color</h2>
<p>ä¸Šé¢è¿™ç§æ–¹å¼è¿˜æ˜¯æŒºæ›²æŠ˜çš„ï¼Œè€ŒiOS 26è¿æ¥äº†æ–°æ¥å£ï¼Œå¯ä»¥ç›´æ¥æŠŠUIColorè®¾ç½®ä¸ºHDRæ¨¡å¼ï¼Œè¿™æ ·å¯¹äºUILabelã€UIButtonçš„æ¥å…¥å°±æ›´ç®€å•äº†ã€‚</p>
<p><a href="https://developer.apple.com/videos/play/wwdc2025/243/">Whatâ€™s new in UIKit - WWDC25 - Videos - Apple Developer</a></p>
<p>ç°é˜¶æ®µXcodeè¿˜æ²¡æœ‰iOS 26çš„SDKï¼Œæƒ³è¦å°é²œçš„å¯ä»¥é€šè¿‡runtimeçš„å½¢å¼è°ƒç”¨åˆ°ã€‚</p>
<pre><code class="language-objective-c">- (UIColor *)hdrColorWithHeadroom:(CGFloat)headroom {
	SEL sel = NSSelectorFromString(@&quot;colorWithRed:green:blue:alpha:linearExposure:&quot;);
	if ([UIColor.class respondsToSelector:sel] == NO) {
		return self;
	}
	
	CGFloat red = 1;
	CGFloat green = 1;
	CGFloat blue = 1;
	CGFloat alpha = 1;
	CGFloat linearExposure = headroom;
	[self getRed:&amp;red green:&amp;green blue:&amp;blue alpha:&amp;alpha];
	
	NSMethodSignature *signature = [UIColor methodSignatureForSelector:sel];
	NSInvocation *invocation = [NSInvocation invocationWithMethodSignature:signature];
	[invocation setTarget:UIColor.class];
	[invocation setSelector:sel];
	[invocation setArgument:&amp;red atIndex:2];
	[invocation setArgument:&amp;green atIndex:3];
	[invocation setArgument:&amp;blue atIndex:4];
	[invocation setArgument:&amp;alpha atIndex:5];
	[invocation setArgument:&amp;linearExposure atIndex:6];
	[invocation invoke];
	
	UIColor *__unsafe_unretained color = nil;
	[invocation getReturnValue:&amp;color];
	
	return color;
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[è·¨å¹³å°ç½‘ç»œæ¡†æ¶marsæµ…æ]]></title>
        <id>https://jayying007.github.io/post/è·¨å¹³å°ç½‘ç»œæ¡†æ¶marsæµ…æ/</id>
        <link href="https://jayying007.github.io/post/è·¨å¹³å°ç½‘ç»œæ¡†æ¶marsæµ…æ/">
        </link>
        <updated>2023-06-26T13:37:41.000Z</updated>
        <content type="html"><![CDATA[<p><a href="https://github.com/Tencent/mars">https://github.com/Tencent/mars</a></p>
<h2 id="mars-æ˜¯ä»€ä¹ˆ">Mars æ˜¯ä»€ä¹ˆ</h2>
<p>Mars æ˜¯å¾®ä¿¡å®˜æ–¹çš„ç»ˆç«¯åŸºç¡€ç»„ä»¶, æ˜¯ä¸€ä¸ªä¸šåŠ¡æ€§æ— å…³,å¹³å°æ€§æ— å…³ ä½¿ç”¨ C++ ç¼–å†™çš„åŸºç¡€ç»„ä»¶ã€‚<br>
å®ƒä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>Commï¼šåŸºç¡€åº“ï¼ŒåŒ…æ‹¬ socketã€çº¿ç¨‹ã€æ¶ˆæ¯é˜Ÿåˆ—ã€åç¨‹ç­‰åŸºç¡€å·¥å…·ï¼›</li>
<li>Xlogï¼šé€šç”¨æ—¥å¿—æ¨¡å—ï¼Œå……åˆ†è€ƒè™‘ç§»åŠ¨ç»ˆç«¯çš„ç‰¹ç‚¹ï¼Œæä¾›é«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€å®‰å…¨æ€§ã€å®¹é”™æ€§çš„æ—¥å¿—åŠŸèƒ½</li>
<li>SDTï¼šç½‘ç»œè¯Šæ–­æ¨¡å—ï¼›</li>
<li>STNï¼šä¿¡ä»¤ä¼ è¾“ç½‘ç»œæ¨¡å—ï¼Œè´Ÿè´£ç»ˆç«¯ä¸æœåŠ¡å™¨çš„å°æ•°æ®ä¿¡ä»¤é€šé“ã€‚åŒ…å«äº†å¾®ä¿¡ç»ˆç«¯åœ¨ç§»åŠ¨ç½‘ç»œä¸Šçš„å¤§é‡ä¼˜åŒ–ç»éªŒä¸æˆæœï¼Œç»å†äº†å¾®ä¿¡æµ·é‡ç”¨æˆ·çš„è€ƒéªŒã€‚</li>
</ol>
<figure data-type="image" tabindex="1"><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fhyysx-FjhKxqdzCMEJFhUJkBI8B.png" alt="" loading="lazy"></figure>
<blockquote>
<p>è¿™äº›ä»‹ç» Github ä¸Šéƒ½æœ‰ï¼Œæˆ‘å°±ä¸é‡å¤äº†ã€‚</p>
</blockquote>
<h3 id="ç»™çº¯å°ç™½çš„è¯´æ˜">ç»™çº¯å°ç™½çš„è¯´æ˜</h3>
<p>è¯´çœŸçš„ï¼Œå¦‚æœå¯¹ç½‘ç»œç¼–ç¨‹ä¸äº†è§£ï¼Œä¸Šé¢é‚£æ®µè¯ä¼°è®¡æ˜¯çœ‹ä¸æ˜ç™½çš„ï¼Œè¿™é‡Œå†ç®€å•è¯´æ˜ä¸€ä¸‹ã€‚<br>
ä¸€èˆ¬æ¥è¯´ï¼Œå®¢æˆ·ç«¯å’Œåå°é€šè¿‡ TCP ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FiDGKMV1hcl3Xzb0vgYyiaufhoff.png" alt="" loading="lazy"><br>
è¿™ç»„è¿æ¥é€šè¿‡ï¼ˆIP1,Socket1,IP2,Socket2ï¼‰å”¯ä¸€æ ‡è¯†ï¼Œ<br>
ä½ æƒ³ç»™åå°å‘æ¶ˆæ¯ï¼Œå°±å¾€è¿™ä¸ª Socket å†™æ•°æ®ã€‚ä½ æƒ³ä»åå°æ”¶æ¶ˆæ¯ï¼Œå°±ä»è¿™ä¸ª Socket è¯»æ•°æ®ã€‚</p>
<p>å¸¸è§çš„é€šä¿¡æ–¹å¼æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®ï¼Œåå°è¿”å›ï¼›</li>
<li>åå°ä¸»åŠ¨æ¨æ•°æ®ï¼›</li>
</ul>
<p><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FhhYotVyo-F3BIJ5hjpeQHrFBPTg.png" alt="" loading="lazy"><br>
å…¶ä¸­ï¼Œæƒ³è¦è®©åå°åœ¨éœ€è¦çš„æ—¶å€™å‘æ¶ˆæ¯ç»™ä½ ï¼Œå°±å¾—ä¿æŒ Socket ä¸€ç›´è¿æ¥ç€ï¼Œå³æ‰€è°“çš„é•¿è¿æ¥ã€‚è€Œå‰é¢é‚£ç§ä¸€æ¥ä¸€å›çš„ï¼Œå°±æ— æ‰€è°“çŸ­è¿æ¥è¿˜æ˜¯é•¿è¿æ¥äº†ã€‚</p>
<blockquote>
<p>å…¶å®è¿˜æœ‰å®¢æˆ·ç«¯ç»™åå°å‘é€šçŸ¥çš„åœºæ™¯ï¼Œåªä¸è¿‡è¿™ç§æ¯”è¾ƒå°‘è§ã€‚<br>
ä¾‹å¦‚å¾®ä¿¡é‡Œé¢çš„ã€Œå¯¹æ–¹æ­£åœ¨è¾“å…¥ã€ï¼Œå°±æ˜¯ç”¨è¿™ç§èƒ½åŠ›å®ç°çš„ã€‚</p>
</blockquote>
<p>ç½‘ç»œä¸Šä¼ è¾“çš„åªæ˜¯å•çº¯çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå…·ä½“ä»£è¡¨ä»€ä¹ˆå«ä¹‰å°±çœ‹å®¢æˆ·ç«¯è·Ÿåå°åå•†çš„ç»“æœäº†ã€‚å°±åƒ TCP åè®®å»ºç«‹åœ¨ IP åè®®çš„åŸºç¡€ä¹‹ä¸Šï¼Œå®¢æˆ·ç«¯å’Œåå°é—´çš„åè®®å»ºç«‹åœ¨ TCP åè®®ä¹‹ä¸Šï¼Œè¿™ä¸ªå­¦è¿‡è®¡ç®—æœºç½‘ç»œçš„éƒ½æ‡‚ã€‚</p>
<p>socket ç¼–ç¨‹å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨æ¥å£å¦‚ä¸‹<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FqjBttbkDx0-tt7TbICebMVCywHq.png" alt="" loading="lazy"></p>
<p>åˆ°è¿™é‡Œï¼Œæ€»ç®—å¯ä»¥çŸ¥é“ Mars æ˜¯ä»€ä¹ˆäº†ã€‚ç®€å•è¯´ï¼ŒMars å°±æ˜¯å¯¹ä¸Šé¢ Socket å»ºç«‹çš„å°è£…ï¼Œç”±å®ƒè´Ÿè´£å»ºç«‹è·Ÿåå°çš„è¿æ¥ä»¥åŠæ•°æ®è¯»å†™ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fl927kybOs6pEyV318Rp0G8h8WMU.png" alt="" loading="lazy"></p>
<h2 id="å…³äºå®˜æ–¹-demo">å…³äºå®˜æ–¹ Demo</h2>
<p>æ¯•ç«Ÿæ˜¯å¾®ä¿¡æ¨å‡ºçš„ï¼Œæä¾›çš„ demo æ˜¯åŸºäºèŠå¤©åœºæ™¯è®¾è®¡çš„ã€‚<br>
å…³äº IM ç³»ç»Ÿï¼Œç›¸ä¿¡å¤§éƒ¨åˆ†äººåœ¨ä¸Šå¤§å­¦æ—¶éƒ½åšè¿‡ç©å…·é¡¹ç›®äº†ã€‚<br>
æ¯”å¦‚æˆ‘çš„ï¼š<a href="https://github.com/jayying007/chatting-room">https://github.com/jayying007/chatting-room</a></p>
<p>è¿™é‡Œè¦åæ§½ä¸€ç‚¹æ˜¯ï¼ŒGithub ä¸Šçš„ demo åŸºæœ¬æ˜¯è¿è¡Œä¸èµ·æ¥çš„ï¼Œæˆ‘ç»å†äº†ä¹ä¹å…«åä¸€éš¾æ‰æå®šã€‚<br>
Server ç«¯å’Œ iOS ç«¯éƒ½æœ‰é—®é¢˜ï¼š<br>
Server ç«¯çš„ä¸»è¦é—®é¢˜æ˜¯ Gradle ç‰ˆæœ¬æ¯”è¾ƒè€ï¼Œæˆ‘æœ¬åœ°çš„ JDK ç‰ˆæœ¬æ¯”è¾ƒæ–°ï¼Œè¿™é‡Œé€šè¿‡é™ä½åˆ° JDK8 è§£å†³ï¼›<br>
iOS ç«¯ä¸»è¦é—®é¢˜æ˜¯æ–°æ—§ç‰ˆæœ¬ç¬¦å·æœ‰æ‰€å˜æ›´ï¼Œè¿™ä¸ªæ ¹æ®æŠ¥é”™ä¿¡æ¯é€æ­¥ä¿®æ”¹è§£å†³ã€‚<br>
è§£å†³çš„è¿‡ç¨‹å› æœºå™¨è€Œå¼‚ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿä¸æ‰“ç®—è¯´æ˜ï¼Œåº”è¯¥æ²¡æœ‰äººä¸ä¼š Google å§ï¼Ÿ</p>
<h2 id="ios-demo-åˆ†æ">iOS Demo åˆ†æ</h2>
<p>æ ¸å¿ƒç»“æ„å¦‚ä¸‹ï¼š<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FktXpXlVXPYxrm7LZrVLNJyhJcHQ.png" alt="" loading="lazy"></p>
<p>å…¶ä¸­ï¼ŒNetworkService è´Ÿè´£è®¾ç½®å¯åŠ¨ marsï¼Œå¹¶æ¥å— mars å›è°ƒçš„æ•°æ®ï¼Œä¼ é€’ç»™ä¸Šå±‚ NetworkEventã€‚</p>
<pre><code class="language-objectivec">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {

    [NetworkService sharedInstance].delegate = [[NetworkEvent alloc] init];
    [[NetworkService sharedInstance] setCallBack];
    [[NetworkService sharedInstance] createMars];
    [[NetworkService sharedInstance] setClientVersion:200];
    [[NetworkService sharedInstance] setLongLinkAddress:@&quot;192.168.1.101&quot; port:8081];
    [[NetworkService sharedInstance] setShortLinkPort:8080];
    [[NetworkService sharedInstance] reportEvent_OnForeground:YES];
    [[NetworkService sharedInstance] makesureLongLinkConnect];

    [[NetworkStatus sharedInstance] Start:[NetworkService sharedInstance]];

    return YES;
}
</code></pre>
<h3 id="ä¸€æ¬¡è¯·æ±‚çš„è¿‡ç¨‹">ä¸€æ¬¡è¯·æ±‚çš„è¿‡ç¨‹</h3>
<p>ä»¥ PingServerController ä¸­çš„ä»£ç ä¸ºä¾‹ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FiMp7oM8ynpTtNNeQNRvsNCboyqS.png" alt="" loading="lazy"></p>
<p>ç‚¹å‡» Click æ—¶ï¼Œå®¢æˆ·ç«¯åˆ›å»ºäº†ä¸€ä¸ª CGITaskï¼Œä¼ é€’ç»™ NetworkServiceï¼Œå¹¶æŠŠè‡ªå·±ä½œä¸ºç›‘å¬è€…ã€‚</p>
<pre><code class="language-objectivec">- (IBAction)onButtonClick:(id)sender forEvent:(UIEvent *)event {
    CGITask *helloCGI = [[CGITask alloc] initAll:ChannelType_All AndCmdId:kSayHello AndCGIUri:@&quot;/mars/hello&quot; AndHost:@&quot;192.168.1.101&quot;];
    [[NetworkService sharedInstance] startTask:helloCGI ForUI:self];
}
</code></pre>
<p>è¿™ä¸ª CGITask åªæ˜¯å®¢æˆ·ç«¯å¯¹æ•°æ®çš„å°è£…ï¼Œåœ¨ NetworkService å±‚ä¼šè§£æä¸º mars çš„ä¸€ä¸ª Taskï¼Œç„¶åå¯åŠ¨è¿™ä¸ª Taskã€‚<br>
æ¯æ¬¡åˆ›å»º Task éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ taskidï¼Œä¹‹åå°†è¿™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯æ³¨å†Œåˆ° NetworkEvent ä¸­ã€‚</p>
<pre><code class="language-objectivec">- (int)startTask:(CGITask *)task ForUI:(id&lt;UINotifyDelegate&gt;)delegateUI {
    Task ctask;
    ctask.cmdid = task.cmdid;
    ctask.channel_select = task.channel_select;
    ctask.cgi = std::string(task.cgi.UTF8String);
    ctask.shortlink_host_list.push_back(std::string(task.host.UTF8String));
    ctask.user_context = (__bridge void*)task;

    NSString *taskIdKey = [NSString stringWithFormat:@&quot;%d&quot;, ctask.taskid];
    [_delegate addObserver:delegateUI forKey:taskIdKey];
    [_delegate addCGITasks:task forKey:taskIdKey];

    mars::stn::StartTask(ctask);

    return ctask.taskid;
}
</code></pre>
<p>æ¥ä¸‹æ¥ Task å¯åŠ¨ï¼Œè¦çœŸæ­£å‘é€æ•°æ®äº†ï¼Œmars é€šè¿‡ callback æ¥ç´¢å–æ•°æ®</p>
<pre><code class="language-objectivec">// StnCallBack
bool StnCallBack::Req2Buf(uint32_t _taskid, void* const _user_context, const std::string&amp; _user_id, AutoBuffer&amp; _outbuffer, AutoBuffer&amp; _extend, int&amp; _error_code, const int _channel_select, const std::string&amp; host) {
    NSData* requestData =  [[NetworkService sharedInstance] Request2BufferWithTaskID:_taskid userContext:_user_context];
    if (requestData == nil) {
        requestData = [[NSData alloc] init];
    }
    _outbuffer.AllocWrite(requestData.length);
    _outbuffer.Write(requestData.bytes,requestData.length);
    return requestData.length &gt; 0;
}
// NetworkService
- (NSData*)Request2BufferWithTaskID:(uint32_t)tid userContext:(const void *)context {
    CGITask *task = (__bridge CGITask *)context;
    return [_delegate Request2BufferWithTaskID:tid task:task];
}
// NetworkEvent
- (NSData*)Request2BufferWithTaskID:(uint32_t)tid task:(CGITask *)task {
    NSData* data = NULL;

    NSString *taskIdKey = [NSString stringWithFormat:@&quot;%d&quot;, tid];

    id&lt;UINotifyDelegate&gt; uiObserver = [controllers objectForKey:taskIdKey];
    if (uiObserver != nil) {
        data = [uiObserver requestSendData];
    }

    return data;
}
// PingServerController
- (NSData*)requestSendData {
    HelloRequest *helloRequest = [HelloRequest new];
    helloRequest.user = [self username];
    helloRequest.text = @&quot;Hello world&quot;;
    NSData *data = [helloRequest data];
    return data;
}
</code></pre>
<p>ç»è¿‡å±‚å±‚ä¼ é€’ï¼Œæœ€åæ¥åˆ°äº† PingServerControllerï¼Œå¾—åˆ°ä¸€ä¸ª HelloRequest çš„åºåˆ—åŒ–æ•°æ®ã€‚è¿™é‡Œçš„ä¸šåŠ¡å±‚æ•°æ®æ˜¯ä¸€ä¸ª protobuf å¯¹è±¡ï¼Œä¹Ÿæ˜¯ç½‘ç»œç¼–ç¨‹å¸¸ç”¨çš„åºåˆ—åŒ–æ–¹å¼ï¼Œå…³äº protobuf çš„ä»‹ç»å¯ä»¥çœ‹ä»¥å‰å†™çš„åšå®¢ã€‚</p>
<p>å› ä¸ºè¿™æ˜¯ä¸ªæœ‰æ¥æœ‰å›çš„è¯·æ±‚ï¼Œæ‰€ä»¥åå°è¿˜ä¼šå›æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œä¹Ÿæ˜¯ mars é€šè¿‡ callback æ¥è¿”å›æ•°æ®ã€‚</p>
<pre><code class="language-objectivec">// StnCallBack
int StnCallBack::Buf2Resp(uint32_t _taskid, void* const _user_context, const std::string&amp; _user_id, const AutoBuffer&amp; _inbuffer, const AutoBuffer&amp; _extend, int&amp; _error_code, const int _channel_select) {
    int handle_type = mars::stn::kTaskFailHandleNormal;
    NSData* responseData = [NSData dataWithBytes:(const void *) _inbuffer.Ptr() length:_inbuffer.Length()];
    NSInteger errorCode = [[NetworkService sharedInstance] Buffer2ResponseWithTaskID:_taskid ResponseData:responseData userContext:_user_context];

    if (errorCode != 0) {
        handle_type = mars::stn::kTaskFailHandleDefault;
    }
    return handle_type;
}
// NetworkService
- (NSInteger)Buffer2ResponseWithTaskID:(uint32_t)tid ResponseData:(NSData *)data userContext:(const void *)context {
    CGITask *task = (__bridge CGITask *)context;
    return [_delegate Buffer2ResponseWithTaskID:tid responseData:data task:task];
}
// NetworkEvent
- (NSInteger)Buffer2ResponseWithTaskID:(uint32_t)tid responseData:(NSData *)data task:(CGITask *)task {
    int returnType = 0;

    NSString *taskIdKey = [NSString stringWithFormat:@&quot;%d&quot;, tid];

    id&lt;UINotifyDelegate&gt; uiObserver = [controllers objectForKey:taskIdKey];
    if (uiObserver != nil) {
        returnType = [uiObserver onPostDecode:data];
    } else {
        returnType = -1;
    }

    return returnType;
}
// PingServerController
- (int)onPostDecode:(NSData*)responseData {
    helloResponse = [HelloResponse parseFromData:responseData error:nil];
    if ([helloResponse hasErrmsg]) {
        dispatch_async(dispatch_get_main_queue(), ^{
            UIAlertController *alert = [UIAlertController alertControllerWithTitle:nil message:helloResponse.errmsg preferredStyle:UIAlertControllerStyleAlert];
            [alert addAction:[UIAlertAction actionWithTitle:@&quot;OK&quot; style:UIAlertActionStyleDefault handler:nil]];
            [self presentViewController:alert animated:YES completion:nil];
        });
        LOG_INFO(kModuleViewController, @&quot;recv hello response: %@&quot;, helloResponse.errmsg);
    }

    return helloResponse.retcode == 0 ? 0 : -1;
}
</code></pre>
<h3 id="ä¸€æ¬¡-push-çš„è¿‡ç¨‹">ä¸€æ¬¡ Push çš„è¿‡ç¨‹</h3>
<p>ä¸ºäº†æµ‹è¯•è¿™ä¸ªè¿‡ç¨‹ï¼Œéœ€è¦å‡†å¤‡ä¸¤å°æ‰‹æœºã€‚è¿™é‡Œä»¥ TopicViewController ä¸­çš„ä»£ç ä¸ºä¾‹ã€‚<br>
é¦–å…ˆä¸€å°æ‰‹æœºå‘é€æ¶ˆæ¯ï¼Œè¿‡ç¨‹å’Œä¸Šé¢çš„ç±»ä¼¼ï¼Œä¼šæœ‰ request å’Œ responseã€‚</p>
<pre><code class="language-objectivec">// requestæ—¶è°ƒç”¨
- (NSData*)requestSendData {
    SendMessageRequest *sendMsgRequest = [SendMessageRequest new];
    sendMsgRequest.from = [self username];
    sendMsgRequest.to = @&quot;all&quot;;
    sendMsgRequest.text = _textField.text;
    sendMsgRequest.accessToken = @&quot;123456&quot;;
    sendMsgRequest.topic = _conversation.topic;
    LOG_INFO(kModuleViewController, @&quot;send msg to topic:%@&quot;, _conversation.notice);
    NSData* data = [sendMsgRequest data];
    dispatch_async(dispatch_get_main_queue(), ^{
        _textField.text = @&quot;&quot;;
    });
    return data;
}
// responseæ—¶è°ƒç”¨
- (int)onPostDecode:(NSData*)responseData {
    SendMessageResponse *sendMsgResponse = [SendMessageResponse parseFromData:responseData error:nil];
    dispatch_async(dispatch_get_main_queue(), ^{
        NSString *recvtext = [NSString stringWithFormat:@&quot;%@ : %@&quot;, sendMsgResponse.from, sendMsgResponse.text];
        [self.messages addObject:recvtext];
        [self.tableView reloadData];
        NSIndexPath *indexPath = [NSIndexPath indexPathForRow:self.messages.count-1 inSection:0];
        [self.tableView scrollToRowAtIndexPath:indexPath atScrollPosition:UITableViewScrollPositionBottom animated:YES];
    });
    return sendMsgResponse.errCode == 0 ? 0 : -1;
}
</code></pre>
<p>åœ¨è¿›å…¥ TopicViewController æ—¶ï¼Œæ³¨å†Œäº† PushObserver</p>
<pre><code class="language-objectivec">- (void)viewDidLoad {
    [super viewDidLoad];
	// ç•¥...
    [[NetworkService sharedInstance] addPushObserver:self withCmdId:kPushMessageCmdId];
}
</code></pre>
<p>è¿™æ ·å½“åå° Push æ•°æ®æ—¶ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”çš„å¤„ç†è€…ã€‚è¿™æ ·å¦ä¸€å°æ‰‹æœºå°±èƒ½æ”¶åˆ°æ¶ˆæ¯äº†ã€‚</p>
<pre><code class="language-objectivec">// StnCallBack
void StnCallBack::OnPush(const std::string&amp; _channel_id, uint32_t _cmdid, uint32_t _taskid, const AutoBuffer&amp; _body, const AutoBuffer&amp; _extend) {
    if (_body.Length() &gt; 0) {
        NSData* recvData = [NSData dataWithBytes:(const void *) _body.Ptr() length:_body.Length()];
        [[NetworkService sharedInstance] OnPushWithCmd:_cmdid data:recvData];
    }
}
// NetworkService
- (void)OnPushWithCmd:(NSInteger)cid data:(NSData *)data {
    return [_delegate OnPushWithCmd:cid data:data];
}
// NetworkEvent
- (void)OnPushWithCmd:(NSInteger)cid data:(NSData *)data {
    id&lt;PushNotifyDelegate&gt; pushObserver = [pushrecvers objectForKey:[NSString stringWithFormat:@&quot;%d&quot;, cid]];
    if (pushObserver != nil) {
        [pushObserver notifyPushMessage:data withCmdId:cid];
    }
}
// TopicViewController
- (void)notifyPushMessage:(NSData*)pushData withCmdId:(int)cmdId {
    MessagePush* messagePush = [MessagePush parseFromData:pushData error:nil];
    if (messagePush != nil) {
        dispatch_async(dispatch_get_main_queue(), ^{
            NSString *recvtext = [NSString stringWithFormat:@&quot;%@ : %@&quot;, messagePush.from, messagePush.content];
            [self.messages addObject:recvtext];
            [self.tableView reloadData];
            NSIndexPath *indexPath = [NSIndexPath indexPathForRow:self.messages.count-1 inSection:0];
            [self.tableView scrollToRowAtIndexPath:indexPath atScrollPosition:UITableViewScrollPositionBottom animated:YES];
        });
    }
}
</code></pre>
<p>ç”»æˆå›¾å¤§æ¦‚é•¿è¿™æ ·ï¼š<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FtRSj6-8QkS9QFzBs7CYSRH9l5YO.png" alt="" loading="lazy"></p>
<h2 id="å†™åˆ°æœ€å">å†™åˆ°æœ€å</h2>
<p>è¿™é‡Œè¦æä¸ªé†’ï¼Œå¦‚æœä½ ä»¥ä¸ºç½‘ç»œä¸Šä¼ è¾“çš„å°±æ˜¯çº¯ HelloRequestã€HelloResponseã€MessagePush è¿™æ ·çš„æ•°æ®ï¼Œé‚£è¯´æ˜ä½ è¿˜æ²¡å®Œå…¨ç†è§£ã€‚<br>
æ¯•ç«Ÿè¿™é‡Œè¿˜æœ‰ä¸ªç–‘é—®ï¼Œæ€ä¹ˆåŒºåˆ†åå°è¿”å›çš„æ•°æ®æ˜¯ HelloResponse è¿˜æ˜¯ MessagePushğŸ¤”ã€‚</p>
<p>å›æƒ³å‰é¢åˆ›å»º CGITask çš„è¿‡ç¨‹ï¼Œå…¶å®è¿˜æœ‰ cmdid è¿™ä¸ªä¸œè¥¿ã€‚</p>
<pre><code class="language-objectivec">- (IBAction)onButtonClick:(id)sender forEvent:(UIEvent *)event {
    CGITask *helloCGI = [[CGITask alloc] initAll:ChannelType_All AndCmdId:kSayHello AndCGIUri:@&quot;/mars/hello&quot; AndHost:@&quot;192.168.1.101&quot;];
    [[NetworkService sharedInstance] startTask:helloCGI ForUI:self];
}
</code></pre>
<p>è¿™æ ·ï¼Œå®¢æˆ·ç«¯åœ¨è¯·æ±‚æ—¶æŠŠè¿™ä¸ª cmdid ä¹Ÿå¸¦ä¸Šï¼Œåå°å°±çŸ¥é“å®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯ä»€ä¹ˆå†…å®¹ã€‚<br>
åå°è¿”å›æ—¶æŠŠ cmdid å¸¦ä¸Šï¼Œå®¢æˆ·ç«¯å°±çŸ¥é“åå°è¿”å›çš„æ˜¯ä»€ä¹ˆå†…å®¹ã€‚<br>
åœ¨ Demo ä¸­ï¼Œå®¢æˆ·ç«¯å’Œåå°ä¹‹é—´çš„ä¼ è¾“åè®®å¦‚ä¸‹ï¼š<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fjf92KFNF4RKejLQe3RcksxEdxSr.png" alt="" loading="lazy"></p>
<p>å®¢æˆ·ç«¯è¿™éƒ¨åˆ†ä»£ç åœ¨ longlink_packer.cc ä¸­</p>
<pre><code class="language-objectivec">void (*longlink_pack)(uint32_t _cmdid, uint32_t _seq, const AutoBuffer&amp; _body, const AutoBuffer&amp; _extension, AutoBuffer&amp; _packed, longlink_tracker* _tracker)
    = [](uint32_t _cmdid, uint32_t _seq, const AutoBuffer&amp; _body, const AutoBuffer&amp; _extension, AutoBuffer&amp; _packed, longlink_tracker* _tracker) {
    __STNetMsgXpHeader st = {0};
    st.head_length = htonl(sizeof(__STNetMsgXpHeader));
    st.client_version = htonl(sg_client_version);
    st.cmdid = htonl(_cmdid);
    st.seq = htonl(_seq);
    st.body_length = htonl(_body.Length());

    _packed.AllocWrite(sizeof(__STNetMsgXpHeader) + _body.Length());
    _packed.Write(&amp;st, sizeof(st));

    if (NULL != _body.Ptr()) _packed.Write(_body.Ptr(), _body.Length());

    _packed.Seek(0, AutoBuffer::ESeekStart);
};
</code></pre>
<p>æœåŠ¡å™¨è¿™éƒ¨åˆ†ä»£ç åœ¨ NetMsgHeader.java ä¸­</p>
<pre><code class="language-java">public byte[] encode() throws InvalidHeaderException {
    if (body == null &amp;&amp; cmdId != CMDID_NOOPING &amp;&amp; cmdId != CMDID_NOOPING_RESP) {
        throw new InvalidHeaderException(&quot;invalid header body&quot;);
    }

    final int headerLength = FIXED_HEADER_SKIP + (options == null ? 0 : options.length);
    final int bodyLength = (body == null ? 0 : body.length);
    final int packLength = headerLength + bodyLength;
    final ByteArrayOutputStream baos = new ByteArrayOutputStream(packLength);

    try {
        final DataOutputStream dos = new DataOutputStream(baos);

        dos.writeInt(headerLength);
        dos.writeInt(CLIENTVERSION);
        dos.writeInt(cmdId);
        dos.writeInt(seq);
        dos.writeInt(bodyLength);

        if (options != null) {
            dos.write(options);
        }

        if (body != null) {
            dos.write(body);
        }

    } catch (IOException e) {
        e.printStackTrace();

    } finally {
        try {
            baos.close();

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    return baos.toByteArray();
}
</code></pre>
<p>æœ€åçš„æœ€åï¼Œæˆ‘è¿˜è¦æ’ä¸€å¥ã€‚è¿™ä¸ªåè®®æ˜¯å®¢æˆ·ç«¯è·Ÿåå°åå•†çš„ï¼Œæ¯ä¸ªä¸šåŠ¡å®šçš„éƒ½ä¸ä¸€æ ·ï¼Œå¾®ä¿¡ä¹Ÿä¸æ˜¯è¿™æ ·æçš„ã€‚å…·ä½“æ€ä¹ˆå®šä¹‰å–å†³äºè‡ªèº«ä¸šåŠ¡ï¼Œæ›´å¥½çš„è®¾è®¡æ˜¯å‡å°‘ä¼ è¾“æ•°æ®å¤§å°ï¼Œåˆèƒ½æœ‰æ‰©å±•æ€§ï¼Œæ›´å®‰å…¨ã€‚</p>
<h2 id="å…¶ä»–">å…¶ä»–</h2>
<p>å¦‚æœä½ å¯¹ mars çš„æºç æœ‰å…´è¶£ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„åšå®¢<br>
<a href="https://tbfungeek.github.io/2019/12/05/Tencent-Mars-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Tencent Mars æºç è§£æ</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[[è½¬] æ¸¸æˆä¸­çš„AI-è¡Œä¸ºæ ‘]]></title>
        <id>https://jayying007.github.io/post/[è½¬] æ¸¸æˆä¸­çš„AI-è¡Œä¸ºæ ‘/</id>
        <link href="https://jayying007.github.io/post/[è½¬] æ¸¸æˆä¸­çš„AI-è¡Œä¸ºæ ‘/">
        </link>
        <updated>2023-05-27T08:15:27.000Z</updated>
        <content type="html"><![CDATA[<p><a href="https://lifan.tech/2020/02/15/game/behavior-tree/">https://lifan.tech/2020/02/15/game/behavior-tree/</a></p>
<blockquote>
<p>æ¸¸æˆé‡Œæœ‰ä¸å°‘ç®—æ³•ï¼Œå¦‚æœ¬æ–‡çš„è¡Œä¸ºæ ‘ï¼Œä»¥åŠè¿˜æœ‰æ’è¡Œæ¦œçš„æ’åºç®—æ³•ã€å¯»è·¯ç®—æ³•ã€ç‰©ä½“ç¢°æ’ï¼Œå¦‚æœä½ æ˜¯åš 3D å¼•æ“çš„ï¼Œè¿˜å¾—æ‡‚å›¾å½¢å­¦ã€ç‰©ç†å­¦ã€æ•°å­¦...<br>
è¿™é‡Œçš„è¡Œä¸ºæ ‘è™½ç„¶åœ¨ iOS ä¸­åŸºæœ¬ç”¨ä¸åˆ°ï¼Œä½†è·Ÿå®ƒå…³è”çš„çŠ¶æ€æœºè¿˜æ˜¯æœ‰å¯èƒ½çš„ã€‚</p>
</blockquote>
<p>æ¸¸æˆä¸­ï¼Œå¸¸è§ç”¨ AI å®ç°æ–¹å¼æœ‰ 2 ç§ï¼ŒçŠ¶æ€æœºå’Œè¡Œä¸ºæ ‘ã€‚ä¸‹é¢ä¸»è¦ç®€ä»‹ç»è¡Œä¸ºæ ‘ï¼Œè¡Œä¸ºæ ‘æ˜¯ç”¨ä¸€æ£µå¤šå‰æ ‘æ¥è¡¨ç¤º AIï¼Œæ ‘çš„ä¸­é—´èŠ‚ç‚¹ä¸ºæ§åˆ¶èŠ‚ç‚¹æ§åˆ¶ç€ AI çš„æ‰§è¡Œæµç¨‹ï¼Œå¶å­èŠ‚ç‚¹ä¸ºè¡Œä¸ºèŠ‚ç‚¹ï¼Œæè¿°äº† AI çš„å…·ä½“è¡Œä¸ºã€‚</p>
<h4 id="ä¸€-æ¡ˆä¾‹æè¿°">ä¸€ã€æ¡ˆä¾‹æè¿°</h4>
<p>å±±è´¼çš„ AI éœ€æ±‚æè¿°å¦‚ä¸‹ï¼š</p>
<ul>
<li>è§†é‡å†…æ²¡æœ‰æ•Œäººåˆ™åœ¨ä¸€å®šèŒƒå›´å†…å·¡é€»</li>
<li>è§†é‡å‡ºç°æ•Œäººåˆ™èµ°è¿‡å»æ”»å‡»æ•Œäºº</li>
<li>å½“è‡ªå·±è¡€é‡ &lt; 20% åˆ™é€ƒè·‘</li>
</ul>
<p>ä¸‹é¢å°†åˆ†åˆ«ç”¨çŠ¶æ€æœºå’Œè¡Œä¸ºæ ‘æ¥æè¿°å±±è´¼çš„ AI</p>
<h4 id="äºŒ-çŠ¶æ€æœº">äºŒã€çŠ¶æ€æœº</h4>
<p><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FiihbE-NXdmVllv3lPin1dZ2iSlf.png" alt="" loading="lazy"><br>
ä¸Šå›¾æ˜¯ç”¨çŠ¶æ€æœºæ¥æè¿°å±±è´¼çš„ AI, ç›®å‰æ¥çœ‹çŠ¶æ€æœºçš„é€»è¾‘è¿˜æ˜¯éå¸¸æ¸…æ™°ï¼Œä»£ç å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ã€‚ä½†éšç€é¡¹ç›®çš„æ¨è¿›ï¼Œç­–åˆ’éšæ—¶å¯èƒ½å¢åŠ éœ€æ±‚ã€‚å‡å¦‚ç°åœ¨éœ€è¦åŠ ä¸€ä¸ª â€œçŸ³åŒ–â€çŠ¶æ€ï¼Œæè¿°å¦‚ä¸‹ï¼š<br>
åœ¨é€ƒè·‘çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿½å‡»è€…æ•°é‡&gt;2ï¼Œåˆ™ç«‹å³æŠŠè‡ªå·±çŸ³åŒ–ï¼ŒæŒç»­ 5sï¼Œæ­¤æ—¶è‡ªå·±ä¸èƒ½è¢«æ”»å‡»ä¹Ÿä¸èƒ½æ”»å‡»ç›®æ ‡<br>
åœ¨çŠ¶æ€æœºä¸­åŠ å…¥â€œçŸ³åŒ–â€çŠ¶æ€æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å®ƒè·Ÿç°æœ‰æ¯ä¸ªçŠ¶æ€ä¹‹é—´æ˜¯å¦æœ‰è”ç³»ï¼Œè¾“å…¥è¾“å‡ºçŠ¶æ€åˆ†åˆ«æœ‰å“ªäº›ã€‚</p>
<h5 id="11-çŠ¶æ€æœºå­˜åœ¨çš„ä¸è¶³">1.1 çŠ¶æ€æœºå­˜åœ¨çš„ä¸è¶³</h5>
<p>åœ¨é¡¹ç›®ä¸­éšæ—¶å¯èƒ½å¢åŠ æ–°çŠ¶æ€ã€å‡å°‘çŠ¶æ€æˆ–è€…æ”¹å˜çŠ¶æ€ä¹‹é—´çš„è¿ç§»å…³ç³»ï¼Œå¦‚æœçŠ¶æ€è¶Šæ¥è¶Šå¤šï¼Œä»»ä½•ä¸€ç‚¹å°ä¿®æ”¹éƒ½ä¼šäº§ç”Ÿå¾ˆå¤§çš„å·¥ä½œé‡ï¼Œä»£ç ä¸­ä¼šå‡ºç°å¤§é‡çš„åˆ¤æ–­è·³è½¬ï¼Œä»£ç çš„é€»è¾‘ä¼šå˜å¾—è¶Šæ¥è¶Šæ··ä¹±ï¼Œå¦‚æœè´Ÿè´£çŠ¶æ€æœºçš„åŒäº‹ç¦»èŒäº†ï¼Œè¿™ä¼šå¸¦æ¥å¾ˆå¤§çš„é—®é¢˜ã€‚<br>
è¡Œä¸ºæ ‘çš„å‡ºç°ä»æ ¹æœ¬ä¸Šè§£å†³äº†è¿™äº›é—®é¢˜ï¼Œå®ƒæŠŠæ¯ä¸ªè¡Œä¸ºä½œä¸ºä¸€ä¸ªåŸå­é¡¹ï¼Œæä¾›ç»™ç­–åˆ’ç¼–è¾‘ï¼Œè®©ç­–åˆ’æ¥å†³å®š AI çš„æ‰§è¡Œæµç¨‹ï¼Œç¨‹åºåªéœ€è¦é›†ä¸­ç²¾åŠ›æ ¹æ®éœ€æ±‚å¢åŠ æ–°çš„è¡Œä¸ºï¼Œä¸ç”¨å…³å¿ƒå…·ä½“æµç¨‹ã€‚ç”¨ç§æ–¹å¼ï¼Œç¨‹åºçš„å·¥ä½œä¼šå¾—åˆ°å¾ˆå¤§ç¨‹åº¦çš„è§£æ”¾ï¼Œå³ä½¿æœ‰ä¸€å¤©äº¤ç»™å…¶ä»–åŒäº‹ç»´æŠ¤ä¹Ÿæ¯”è¾ƒå®¹æ˜“ã€‚</p>
<h4 id="ä¸‰-è¡Œä¸ºæ ‘">ä¸‰ã€è¡Œä¸ºæ ‘</h4>
<p>è¡Œä¸ºæ ‘æ˜¯ç”±æ§åˆ¶èŠ‚ç‚¹ã€è£…é¥°èŠ‚ç‚¹ã€è¡Œä¸ºèŠ‚ç‚¹ç»„æˆçš„ä¸€æ£µ n å‰æ ‘ï¼Œä¸­é—´èŠ‚ç‚¹ä¸€èˆ¬ä¸ºæ§åˆ¶èŠ‚ç‚¹å’Œè£…é¥°èŠ‚ï¼Œç”¨äºæ§åˆ¶è¡Œä¸ºæ ‘çš„æ‰§è¡Œæµç¨‹ï¼Œå®ƒä»¬ç›¸å¯¹å›ºå®šï¼Œä¸€æ—¦ç¡®å®šå‡ ä¹ä¸ä¼šå˜åŒ–ï¼›å¶å­èŠ‚ç‚¹ç”±è¡Œä¸ºèŠ‚ç‚¹æˆ–æ¡ä»¶èŠ‚ç‚¹ç»„æˆï¼Œå®ƒå®ç°äº† AI ä¸­çš„å„ç§è¡Œä¸ºï¼Œç¨‹åºçš„å¤§éƒ¨åˆ†å·¥ä½œéƒ½æ˜¯ä¸°å¯Œè¡Œä¸ºèŠ‚ç‚¹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¡Œä¸ºæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªè¿”å›å€¼ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>æˆåŠŸï¼ˆSuccessï¼‰</li>
<li>å¤±è´¥ï¼ˆfailedï¼‰</li>
<li>è¿è¡Œä¸­ï¼ˆrunningï¼‰ï¼šè¡¨ç¤ºå½“å‰å¸§æ²¡æœ‰æ‰§è¡Œå®Œæˆã€ä¸‹å¸§ç»§ç»­æ‰§è¡Œã€‚</li>
</ul>
<p>ä¸‹é¢åˆ—å‡ºäº†è¡Œä¸ºæ ‘å¸¸ç”¨çš„èŠ‚ç‚¹ç±»å‹ï¼Œä¸»è¦ç”¨äºè¯´æ˜è¡Œä¸ºæ ‘çš„åŸç†ï¼Œç±»å‹å¯èƒ½ä¸å…¨é¢ï¼›ä½†åªè¦æ˜ç™½äº†åŸç†ï¼Œæ ¹æ®é¡¹ç›®éœ€æ±‚å¢åŠ ç±»å‹å³å¯ã€‚</p>
<h5 id="11-æ§åˆ¶ç±»èŠ‚ç‚¹">1.1 æ§åˆ¶ç±»èŠ‚ç‚¹</h5>
<p>æ§åˆ¶èŠ‚ç‚¹ä¸€èˆ¬ä¸ºä¸­é—´èŠ‚ç‚¹ï¼Œç”¨äºæ§åˆ¶è¡Œä¸ºæ ‘çš„æ‰§è¡Œæµç¨‹ï¼Œå†³å®šäº†å…¶å­èŠ‚ç‚¹æ˜¯ä»¥é¡ºåºã€å¹¶è¡Œã€éšæœºæˆ–å…¶å®ƒæ–¹å¼æ‰§è¡Œã€‚</p>
<ul>
<li>é¡ºåºèŠ‚ç‚¹ï¼ˆSequencesï¼‰<br>
ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰å­èŠ‚ç‚¹ï¼Œè‹¥å½“å‰å­èŠ‚ç‚¹è¿”å›æˆåŠŸï¼Œåˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå­èŠ‚ç‚¹ï¼›è‹¥å­å½“å‰èŠ‚ç‚¹è¿”å›å¤±è´¥ï¼Œåˆ™ä¸­æ–­åç»­å­èŠ‚ç‚¹çš„æ‰§è¡Œï¼Œå¹¶æŠŠç»“æœè¿”å›ç»™çˆ¶èŠ‚ç‚¹ã€‚<br>
å¦‚ä¸‹å›¾æ‰€æ±‚ï¼šèŠ‚ç‚¹ 1 è¿”å›æˆåŠŸï¼Œç»§ç»­æ‰§è¡ŒèŠ‚ç‚¹ 2ï¼›èŠ‚ç‚¹ 2 è¿”å›å¤±è´¥ï¼Œåˆ™æŠŠç»“æœè¿”å›ç»™ Sequences çš„çˆ¶èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ 3 å¹¶ä¸ä¼šæ‰§è¡Œã€‚é¡ºåºèŠ‚ç‚¹ç›¸å½“äº and è¯­ä¹‰ã€‚<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fs91eZc77NI6Z8Kgzs7Z6hpyC7cC.png" alt="" loading="lazy"></li>
<li>é€‰æ‹©èŠ‚ç‚¹ï¼ˆSelectorï¼‰<br>
ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰å­èŠ‚ç‚¹ï¼Œè‹¥å½“å‰å­èŠ‚ç‚¹è¿”å›æˆåŠŸï¼Œåˆ™ä¸­æ–­åç»­èŠ‚ç‚¹è¿è¡Œï¼Œå¹¶æŠŠç»“æœè¿”å›ç»™çˆ¶èŠ‚ç‚¹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br>
ç›¸å½“äº or è¯­ä¹‰<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FhJfP1dHbJzbgQkLfSEjgB28lkBQ.png" alt="" loading="lazy"></li>
<li>å¹¶è¡ŒèŠ‚ç‚¹ï¼ˆParallelï¼‰<br>
ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰å­èŠ‚ç‚¹ï¼Œæ— è®ºå¤±è´¥ä¸å¦ï¼Œéƒ½ä¼šæŠŠæ‰€æœ‰å­èŠ‚ç‚¹æ‰§è¡Œä¸€éã€‚è‡³äº Parallel èŠ‚ç‚¹è¯¥è¿”å›ä»€ä¹ˆå€¼ç»™çˆ¶èŠ‚ç‚¹ï¼Œè¿™è¦çœ‹éœ€æ±‚ã€‚æ¯”å¦‚ï¼šæˆåŠŸæ•° &gt; å¤±è´¥æ•°è¿”å›æˆåŠŸï¼Œå¦åˆ™è¿”å›å¤±è´¥ã€‚<br>
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Ftt3kut4XmIKOthbgNuffm_LXo81.png" alt="" loading="lazy"></li>
<li>éšæœºèŠ‚ç‚¹ï¼ˆRandomï¼‰<br>
éšæœºé€‰æ‹©ä¸€ä¸ªå­èŠ‚ç‚¹æ¥è¿è¡Œã€‚</li>
<li>è®°å¿†èŠ‚ç‚¹ï¼ˆMemSequencesã€MemSelectorï¼‰<br>
åŠŸèƒ½å’Œé¡ºåºèŠ‚ç‚¹ã€é€‰æ‹©èŠ‚ç‚¹ç±»ä¼¼ï¼Œå”¯ä¸€ä¸åŒæ˜¯ä¼šä¿å­˜å½“å‰æ‰§è¡Œè¿›åº¦ï¼ˆæ¯”å¦‚ï¼šä¿å­˜å½“å‰å­èŠ‚ç‚¹ç´¢å¼•ï¼‰ï¼Œä¸‹ä¸€å¸§ç»§ç»­æ‰§è¡Œå½“å‰èŠ‚ç‚¹ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯ä¸­é—´èŠ‚ç‚¹ï¼Œåˆ™ä¼šè·³è¿‡å‰é¢çš„èŠ‚ç‚¹ã€‚</li>
</ul>
<h5 id="12-è£…é¥°èŠ‚ç‚¹decorator">1.2 è£…é¥°èŠ‚ç‚¹ï¼ˆDecoratorï¼‰</h5>
<ul>
<li>é€†å˜èŠ‚ç‚¹ï¼ˆInverterï¼‰ï¼šå¯¹å­èŠ‚ç‚¹çš„è¿”å›å€¼å–åï¼Œç›¸å½“äº not è¯­ä¹‰ï¼Œå®ƒåªä¼šæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ã€‚</li>
<li>æˆåŠŸèŠ‚ç‚¹ï¼ˆSucceederï¼‰ï¼šä¸ç®¡å…¶å­èŠ‚ç‚¹è¿”å›ä½•å€¼ï¼Œéƒ½ä¼šè¿”å› Success ç»™çˆ¶èŠ‚ç‚¹</li>
<li>é‡å¤èŠ‚ç‚¹ï¼ˆRepeaterï¼‰ï¼šé‡å¤æ‰§è¡Œ n æ¬¡å­èŠ‚ç‚¹ã€‚</li>
<li>é‡å¤ç›´è‡³å¤±è´¥èŠ‚ç‚¹ï¼ˆRepeat Until Failï¼‰ï¼šé‡å¤æ‰§è¡Œå­èŠ‚ç‚¹ï¼Œç›´åˆ°å¤±è´¥ä¸ºä¸Šï¼›åŒæ ·ä¹Ÿæœ‰ç±»ä¼¼çš„é‡å¤ç›´è‡³æˆåŠŸèŠ‚ç‚¹è¿™é‡Œå°±ä¸åˆ—å‡ºäº†ã€‚</li>
<li>æ‰§è¡Œä¸€æ®µæ—¶é—´ï¼ˆMaxTimeï¼‰ï¼šé‡å¤æ‰§è¡Œå­èŠ‚ç‚¹ä¸€æ®µæ—¶é—´</li>
</ul>
<p>èŠ‚ç‚¹çš„ç±»å‹æ˜¯çµæ´»å¤šå˜çš„ï¼Œä¸åŒçš„é¡¹ç›®æœ‰ä¸åŒçš„éœ€æ±‚ï¼Œä¸Šé¢åªåˆ—å‡ºäº†å¸¸ç”¨çš„ã€‚</p>
<h5 id="13-è¡Œä¸ºèŠ‚ç‚¹action">1.3 è¡Œä¸ºèŠ‚ç‚¹ï¼ˆActionï¼‰</h5>
<p>è¡Œä¸ºèŠ‚ç‚¹éƒ½æ˜¯å¶èŠ‚ç‚¹ï¼Œæ§åˆ¶èŠ‚ç‚¹ç”¨äºæ§åˆ¶è¡Œä¸ºæ‰§è¡Œçš„æµç¨‹ï¼Œè¡Œä¸ºèŠ‚ç‚¹åˆ™è¡¨ç¤ºå…·ä½“åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼šæˆ˜æ–—ï¼Œé€ƒè·‘ï¼Œå·¡é€»ç­‰ã€‚å®ƒè‡³å°‘åŒ…å«ä¸¤ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li>Init:ç”¨äºåˆå§‹åŒ–èŠ‚ç‚¹ï¼Œæ¯”å¦‚è¯»å–é…ç½®æ•°æ®åˆå§‹åŒ–å½“å‰èŠ‚ç‚¹ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</li>
<li>OnTick:æ¯ä¸€å¸§éƒ½ä¼šæ‰§è¡Œï¼ŒèŠ‚ç‚¹çš„ä¸»è¦é€»è¾‘éƒ½åœ¨æ­¤å‡½æ•°ä¸­å®ç°æˆ–è°ƒç”¨ã€‚</li>
</ul>
<h6 id="131-è¡Œä¸ºèŠ‚ç‚¹ä»£ç å®ç°">1.3.1 è¡Œä¸ºèŠ‚ç‚¹ä»£ç å®ç°</h6>
<p>è¿™æ˜¯ä¸€ä¸ªåœ¨æŒ‡å®šèŒƒå›´å†…æŸ¥æ‰¾é“å…·çš„è¡Œä¸ºèŠ‚ç‚¹<a href="https://github.com/magicsea/h5game/blob/master/server/src/Server/battle/bevAction.go">ä¾‹å­</a>ï¼ˆAtionï¼‰:</p>
<pre><code class="language-go">//èŠ‚ç‚¹ç»“æ„
type FindItem struct {
    b3core.Action
    index string
    etype EntityType
    dis   float32
}

//åˆå§‹åŒ–å‡½æ•°ï¼Œå‚æ•°settingä¸ºèŠ‚ç‚¹çš„é…ç½®æ•°æ®
//æ­¤å‡½æ•°åœ¨åŠ è½½èŠ‚ç‚¹æ—¶è°ƒç”¨
func (this *FindItem) Initialize(setting *b3config.BTNodeCfg) {
    this.Action.Initialize(setting)
    this.index = setting.GetPropertyAsString(&quot;index&quot;) //é“å…·æšä¸¾ç”¨äºç¼“å­˜é“å…·çš„key
    this.etype = EntityType(setting.GetPropertyAsInt(&quot;etype&quot;))//é“å…·ç±»å‹
    this.dis = float32(setting.GetProperty(&quot;range&quot;))//æŸ¥æ‰¾èŒƒå›´
}

//éå†èŠ‚ç‚¹æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰OnTickå‡½æ•°
func (this *FindItem) OnTick(tick *b3core.Tick) b3.Status {
    f := tick.GetTarget().(*Fighter) //ç©å®¶å¯¹è±¡
    tick.Blackboard.Set(this.index, int32(0), &quot;&quot;, &quot;&quot;) //æ¸…ç©ºè€æ•°æ®
    ball := f.FindNearItem(this.dis, this.etype) //åœ¨é™„è¿‘æœç´¢é“å…·
    if nil == ball {//å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå‘çˆ¶èŠ‚ç‚¹è¿”å›FAILURE
        return b3.FAILURE
    }

    id := ball.GetID() //è·å–é“å…·id
    tick.Blackboard.Set(this.index, id, &quot;&quot;, &quot;&quot;) //ç¼“å­˜é“å…·id
    return b3.SUCCESS//å‘çˆ¶èŠ‚ç‚¹è¿”å›SUCCESS

    //å› ä¸ºè¡Œä¸ºæ ‘çš„èŠ‚ç‚¹è¿”å›å€¼å¿…é¡»æ˜¯FAILUREã€SUCCESSã€RUNNING, æ‰€ä»¥Tickä¸­äº§ç”Ÿçš„ç»“æœåªèƒ½é€šè¿‡å…¶å®ƒæ–¹å¼ä¼ å›å»ï¼Œæ¯”å¦‚ä¾‹å­ä¸­çš„Blackboard
}
</code></pre>
<h6 id="132-ç”¨è¡Œä¸ºæ ‘è¡¨ç¤ºå±±è´¼-ai">1.3.2 ç”¨è¡Œä¸ºæ ‘è¡¨ç¤ºå±±è´¼ AI</h6>
<p>ç”¨è¡Œä¸ºæ ‘æ¥è¡¨ç¤ºçš„å±±è´¼ AIï¼Œå¹¶åŠ ä¸Šäº†â€œçŸ³åŒ–â€éœ€æ±‚ï¼Œä¸‹å›¾é»„è‰²éƒ¨åˆ†ï¼š<br>
éœ€æ±‚æè¿°ï¼šåœ¨é€ƒè·‘çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿½å‡»è€…æ•°é‡&gt;2ï¼Œåˆ™ç«‹å³æŠŠè‡ªå·±çŸ³åŒ–ï¼ŒæŒç»­ 5sï¼Œæ­¤æ—¶è‡ªå·±ä¸èƒ½è¢«æ”»å‡»ä¹Ÿä¸èƒ½æ”»å‡»ç›®æ ‡ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fkec8UI8CjD1y2Bvb6dH0HRl6L7J.png" alt="" loading="lazy"><br>
å¯¹äºç¨‹åºæ¥è¯´ï¼Œåªéœ€è¦å†™â€çŸ³åŒ–â€çš„é€»è¾‘å³å¯ï¼Œè‡³äºè¿™ä¸ªè¡Œä¸ºç”¨åœ¨å“ªé‡Œï¼Œæ‰§è¡Œé¡ºåºä»¥åŠå’Œå…¶å®ƒè¡Œä¸ºçš„å…³ç³»ï¼Œåˆ™ç”±ç­–åˆ’æ¥å†³å®šã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ¡ä»¶åˆ¤æ–­å…¶å®å¯ä»¥æ”¾åœ¨è¡Œä¸ºèŠ‚é‡Œï¼Œè¿™é‡ŒæŠŠå®ƒç‹¬ç«‹å‡ºæ¥ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿è¡¨è¾¾ã€‚</p>
<h4 id="å››-çŠ¶æ€æœºä¸è¡Œä¸ºæ ‘æ¯”è¾ƒ">å››ã€çŠ¶æ€æœºä¸è¡Œä¸ºæ ‘æ¯”è¾ƒ</h4>
<h5 id="11-çŠ¶æ€æœº">1.1 çŠ¶æ€æœº</h5>
<ul>
<li>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ã€æ‰§è¡Œæ•ˆç‡é«˜ã€‚</li>
<li>ç¼ºç‚¹ï¼šéšç€çŠ¶æ€æ•°é‡çš„å¢å¤šï¼ŒçŠ¶æ€ä¹‹é—´çš„å…³ç³»ä¼šè¶Šæ¥è¶Šå¤æ‚ï¼Œä»£ç å˜å¾—éš¾ä»¥ç»´æŠ¤ã€‚</li>
</ul>
<h5 id="12-è¡Œä¸ºæ ‘">1.2 è¡Œä¸ºæ ‘</h5>
<ul>
<li>ä¼˜ç‚¹ï¼šç»“æ„æ¸…æ™°ã€èŠ‚ç‚¹é—´å…³ç³»å¼±ï¼Œç¨‹åºå¤§éƒ¨åˆ†å·¥ä½œæ˜¯ä¸°å¯Œè¡Œä¸ºèŠ‚ç‚¹ï¼ŒAI æµç¨‹äº¤ç”±ç­–åˆ’å®Œæˆã€‚</li>
<li>ç¼ºç‚¹ï¼šæ¯æ¬¡ tick éƒ½ä¼šéå†æ•´æ£µè¡Œä¸ºæ ‘(Mem å­èŠ‚ç‚¹é™¤å¤–)ï¼Œè‹¥æ ‘çš„æ·±åº¦å¾ˆæ·±ï¼Œæ•ˆç‡å°†å˜å¾—ä½ä¸‹ã€‚</li>
</ul>
<h4 id="äº”-å…³äºçŠ¶æ€æœºè¡Œä¸ºæ ‘çš„æ€è€ƒ">äº”ã€å…³äºçŠ¶æ€æœºè¡Œä¸ºæ ‘çš„æ€è€ƒ</h4>
<p>ä»çŠ¶æ€æœºå’Œè¡Œä¸ºæ ‘çš„ç‰¹å¾å¯ä»¥çœ‹å‡ºï¼ŒçŠ¶æ€æœºå’Œè¡Œä¸ºæ ‘éƒ½å­˜åœ¨æ˜æ˜¾çš„ä¼˜ç¼ºç‚¹ã€‚æˆ‘ä»¬å¯ä¸å¯ä»¥åªå–å®ƒä»¬çš„ä¼˜ç‚¹å‘¢ï¼Ÿ<br>
åœ¨æ¸¸æˆä¸­ï¼Œè‹¥ä¸»åŠ¨æ€ªçš„è§†é‡èŒƒå›´å†…æ²¡æœ‰ç›®æ ‡å®ƒçš„è¡Œä¸ºæ˜¯å¾ˆç®€å•çš„ï¼Œä¸€èˆ¬ä¼šåœ¨ä¸€å®šèŒƒå›´å†…å·¡é€»ã€‚å¦‚æœç”¨è¡Œä¸ºæ ‘ï¼Œä¸ç®¡è§†é‡å†…æœ‰æ²¡æœ‰äººï¼Œæ¯å¸§éƒ½ä¼šéå†æ‰€æœ‰éè¡Œä¸ºèŠ‚ç‚¹ï¼Œè¿™é€ æˆäº†å¾ˆå¤§çš„èµ„æºæµªè´¹ã€‚<br>
å¦‚æœç”¨çŠ¶æ€æœºå®ç°å·¡é€»ã€æ­»äº¡ã€é€ƒè·‘ï¼Œè¿›å…¥æˆ˜æ–—åçš„è¡Œä¸ºç”¨è¡Œä¸ºæ ‘ï¼Œè¿™ä¼šæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ä¼˜åŒ–ã€‚å°¤å…¶æ˜¯æ€ªç‰©å¾ˆå¤šæ—¶ï¼Œå¤§éƒ¨åˆ†æ—¶é—´æ®µï¼Œå¤§éƒ¨åˆ†æ€ªéƒ½å¤„äºå·¡é€»æˆ– idle çŠ¶æ€ï¼Œå®Œå…¨æ²¡æœ‰å¿…è¦éå†è¡Œä¸ºæ ‘ã€‚<br>
å¦‚æœé¡¹ç›®çš„ AI æ¯”è¾ƒç®€å•ï¼Œæ¯”å¦‚å°æ¸¸æˆä¹‹ç±»çš„ã€‚ç”¨çŠ¶æ€æœºæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[FastImageCacheæ¡†æ¶åˆ†æ]]></title>
        <id>https://jayying007.github.io/post/FastImageCacheæ¡†æ¶åˆ†æ/</id>
        <link href="https://jayying007.github.io/post/FastImageCacheæ¡†æ¶åˆ†æ/">
        </link>
        <updated>2023-05-14T04:12:18.000Z</updated>
        <content type="html"><![CDATA[<p><a href="https://github.com/path/FastImageCache">https://github.com/path/FastImageCache</a></p>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>FastImageCahce é¡¾åæ€ä¹‰ï¼Œç”¨äºå›¾åƒç¼“å­˜ã€‚<br>
ä¼ ç»Ÿçš„å›¾åƒåŠ è½½æ€§èƒ½æ¯”è¾ƒä½ï¼Œåœ¨åˆ—è¡¨æ»šåŠ¨åœºæ™¯ä¸‹ç‰¹åˆ«å®¹æ˜“æ‰å¸§ã€‚è€Œ FastImageCache å°±æ˜¯ä¸“é—¨é’ˆå¯¹åˆ—è¡¨æ»šåŠ¨åœºæ™¯åšçš„æ€§èƒ½ä¼˜åŒ–ã€‚<br>
å¯¹äºä¸¤è€…çš„æ€§èƒ½å¯¹æ¯”ï¼Œä½ å¯ä»¥å‚è€ƒå®˜æ–¹çš„ Demo å·¥ç¨‹å»æ„Ÿå—ä¸€ä¸‹ã€‚</p>
<h2 id="å›¾åƒåŠ è½½æµç¨‹">å›¾åƒåŠ è½½æµç¨‹</h2>
<ol>
<li>+[UIImage imageWithContentsOfFile:]é€šè¿‡ Image I/O æ¥å£åˆ›å»ºäº†ä¸€ä¸ª<code>CGImageRef</code>ï¼Œè¿™ä¸ªæ—¶å€™å›¾åƒè¿˜æ²¡æœ‰è§£ç ã€‚è€Œä¸”åˆ©ç”¨å†…å­˜æ˜ å°„ï¼Œæ•°æ®ä¹Ÿæ²¡åŠ åˆ°å†…å­˜ä¸­ã€‚</li>
<li>å°†å¾—åˆ°çš„å›¾åƒèµ‹å€¼åˆ° UIImageView ä¸­ã€‚</li>
<li>CATransaction æ•æ‰åˆ° Layer Tree å‘ç”Ÿå˜æ›´ã€‚</li>
<li>åœ¨ä¸‹ä¸€ä¸ª RunLoop ä¸­ï¼ŒCore Animation æäº¤è¯¥ CATransactionï¼Œæ ¹æ® UIImage è§£ç ä¸å¦ï¼Œä¼šæœ‰ä»¥ä¸‹æ­¥éª¤ï¼š
<ol>
<li>åˆ†é… Buffer ç”¨äºè§£ç ç›¸å…³æ“ä½œ</li>
<li>å°†æ•°æ®ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­</li>
<li><strong>è§£ç å›¾ç‰‡æˆä½å›¾ï¼Œè¿™ä¸ªè¿‡ç¨‹å‘ç”Ÿåœ¨ CPU</strong></li>
<li>å¾—åˆ°çš„ä½å›¾ä¼šè¢« Core Animation ç”¨äºæ¥ä¸‹æ¥çš„æ¸²æŸ“</li>
</ol>
</li>
</ol>
<h2 id="fastimagecache-å¦‚ä½•ä¼˜åŒ–çš„">FastImageCache å¦‚ä½•ä¼˜åŒ–çš„</h2>
<h3 id="å†…å­˜æ˜ å°„">å†…å­˜æ˜ å°„</h3>
<p>å¦‚æœæ¯å¼ å›¾ç‰‡éƒ½å­˜åœ¨ä¸åŒçš„ä½ç½®ï¼Œé‚£ä¹ˆå°†å®ƒä»¬ä»ç£ç›˜è¯»åˆ°å†…å­˜ä¸­å°±ä¼šæ¶‰åŠå¤šæ¬¡ IOã€‚<br>
FastImageCache åˆ™å°†å®ƒä»¬éƒ½å­˜åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶ååˆ©ç”¨ mmap æŠ€æœ¯ï¼Œä½ éœ€è¦è¯»å–å“ªå¼ å›¾ç‰‡ï¼Œå°±ä¼šåœ¨å¸¸é‡æ—¶é—´å†…è®¡ç®—å‡ºå…¶ä½ç½®ï¼Œç„¶åè¯»å–ã€‚<br>
è¿™ç§æŠ€æœ¯ä¼¼ä¹åœ¨ 2D æ¸¸æˆè´´å›¾ä¸­è¿˜æŒºå¸¸ç”¨çš„ã€‚</p>
<h3 id="è§£ç æ•°æ®">è§£ç æ•°æ®</h3>
<p>FastImageCache å­˜åˆ°æ–‡ä»¶ä¸­çš„éƒ½æ˜¯å·²ç»è§£ç çš„æ•°æ®ï¼Œæ‰€ä»¥åç»­ä¸å†éœ€è¦è§£ç ã€‚<br>
å½“ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå…¸å‹çš„ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ã€‚</p>
<h3 id="å­—èŠ‚å¯¹é½">å­—èŠ‚å¯¹é½</h3>
<p>Core Animation åœ¨æäº¤å›¾åƒæ•°æ®æ—¶ï¼Œå¦‚æœå…¶æ²¡æœ‰å­—èŠ‚å¯¹é½ï¼Œåˆ™ä¼šè§¦å‘ä¸€æ¬¡æ‹·è´è¿›è¡Œå¯¹é½ã€‚<br>
ä¸€ä¸ªåˆé€‚çš„å¯¹é½æ•°å€¼æ˜¯å›¾ç‰‡æ¯è¡Œçš„å­—èŠ‚æ•°è¦å¯¹é½<code>8 pixels x bytes per pixel</code>ï¼Œå¯¹äºå¸¸è§çš„ ARGB å›¾ç‰‡ï¼Œå°±æ˜¯ 64ã€‚</p>
<h2 id="fastimagecache-å¦‚ä½•è®¾è®¡çš„">FastImageCache å¦‚ä½•è®¾è®¡çš„</h2>
<p>å‰é¢æåˆ°æŠŠæ‰€æœ‰å›¾ç‰‡æ•°æ®éƒ½å­˜åˆ°åŒä¸€ä¸ªæ–‡ä»¶ä¸Šï¼Œå¤§æ¦‚é•¿è¿™ä¹ˆä¸ªæ ·å­ï¼š<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FjvQjPRjng0ERlGC011wEPKmr6QP.png" alt="" loading="lazy"></p>
<p>ä½†æ˜¯å…‰æœ‰è¿™ä¸ªæ–‡ä»¶è¿˜ä¸å¤Ÿï¼Œæ¯”å¦‚ä½ ä¸çŸ¥é“ç¬¬ä¸‰å¼ å›¾ç‰‡çš„åç§»é‡ï¼Œä¹Ÿä¸çŸ¥é“å›¾ç‰‡å¯¹åº”çš„æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚<br>
è§£å†³å›¾ç‰‡åç§»é‡çš„é—®é¢˜ï¼ŒFastImageCache æ˜¯<strong>é™åˆ¶äº†æ¯ä¸€å¼ å›¾ç‰‡éƒ½æ˜¯ä¸€æ ·çš„å¤§å°</strong>ï¼ŒåŒ…æ‹¬å›¾ç‰‡çš„æ¸²æŸ“æ ¼å¼ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ ImageFormat ä¸­ã€‚çŸ¥é“å›¾ç‰‡çš„å¤§å°ï¼Œè®¡ç®—åç§»é‡å°±ç®€å•å¤šäº†ã€‚<br>
è§£å†³å›¾ç‰‡æ˜¯ä»€ä¹ˆçš„é—®é¢˜ï¼Œè‡ªç„¶æ˜¯è¦ç»™æ¯ä¸ªå›¾ç‰‡åˆ†é…ä¸€ä¸ª UUIDï¼Œä»£ç ä¸­æ¯ä¸ªå›¾ç‰‡æ¨¡å‹éƒ½æ˜¯ FICEntity</p>
<pre><code class="language-objectivec">@protocol FICEntity &lt;NSObject&gt;
/**
 A string that uniquely identifies this entity.

 @discussion Within each image table, each entry is identified by an entity's UUID. Ideally, this value should never change for an entity. For example, if your entity class is a person
 model, its UUID might be an API-assigned, unchanging, unique user ID. No matter how the properties of the person change, its user ID should never change.
 */
@property (nonatomic, copy, readonly) NSString *fic_UUID;
@end
</code></pre>
<p>å¦å¤–è¿˜è¦è®°å½•å“ªä¸ª UUID æ˜¯æ–‡ä»¶çš„ç¬¬å‡ ä¸ªå›¾ç‰‡ï¼Œè¿™éƒ¨åˆ†ä¿¡æ¯è¢«è®°å½•åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç§°ä¸º Meta æ–‡ä»¶ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FiuQ7K8D94BId6xiWS-44B1hQCcH.png" alt="" loading="lazy"></p>
<p>æ€»ä½“ä¸Šçœ‹ï¼Œæ¯ä¸ª ImageFormat å¯¹åº”ä¸€ç§å›¾ç‰‡æ ¼å¼çš„æ–‡ä»¶å­˜å‚¨ï¼Œä»£ç ä¸­ç”¨ ImageTable ç»´æŠ¤æ¯ä¸ªå›¾ç‰‡æ–‡ä»¶ã€‚<br>
ç¼“å­˜çš„æ¥å£æ— éå°±æ˜¯ CRUD é‚£ä¸€å¥—ã€‚</p>
<pre><code class="language-objectivec">/**
 `FICImageTable` is the primary class that efficiently stores and retrieves cached image data. Image tables are defined by instances of `&lt;FICImageFormat&gt;`. Each image table is backed by a single
 file on disk that sequentially stores image entry data. All images in an image table are either opaque or not and have the same dimensions. Therefore, when defining your image formats, keep in
 mind that you cannot mix image dimensions or whether or not an image is opaque.
 */
@interface FICImageTable : NSObject

///------------------------------------------------
/// @name Storing, Retrieving, and Deleting Entries
///------------------------------------------------

/**
 Stores new image entry data in the image table.

 @param entityUUID The UUID of the entity that uniquely identifies an image table entry. Must not be `nil`.

 @param sourceImageUUID The UUID of the source image that represents the actual image data stored in an image table entry. Must not be `nil`.

 @param imageDrawingBlock The drawing block provided by the entity that actually draws the source image into a bitmap context. Must not be `nil`.

 @discussion Objects conforming to `&lt;FICEntity&gt;` are responsible for providing an image drawing block that does the actual drawing of their source images to a bitmap context provided
 by the image table. Drawing in the provided bitmap context writes the uncompressed image data directly to the image table file on disk.

 @note If any of the parameters to this method are `nil`, this method does nothing.

 @see [FICEntity drawingBlockForImage:withFormatName:]
 */
- (void)setEntryForEntityUUID:(NSString *)entityUUID sourceImageUUID:(NSString *)sourceImageUUID imageDrawingBlock:(FICEntityImageDrawingBlock)imageDrawingBlock;

/**
 Returns a new image from the image entry data in the image table.

 @param entityUUID The UUID of the entity that uniquely identifies an image table entry. Must not be `nil`.

 @param sourceImageUUID The UUID of the source image that represents the actual image data stored in an image table entry. Must not be `nil`.

 @param preheatData A `BOOL` indicating whether or not the entry's image data should be preheated. See `&lt;[FICImageTableEntry preheat]&gt;` for more information.

 @return A new image created from the entry data stored in the image table or `nil` if something went wrong.

 @discussion The `UIImage` returned by this method is initialized by a `CGImageRef` backed directly by mapped file data, so no memory copy occurs.

 @note If either of the first two parameters to this method are `nil`, the return value is `nil`.

 @note If either the entity UUID or the source image UUID doesn't match the corresponding UUIDs in the entry data, then something has changed. The entry data is deleted for the
 provided entity UUID, and `nil` is returned.
 */
- (nullable UIImage *)newImageForEntityUUID:(NSString *)entityUUID sourceImageUUID:(NSString *)sourceImageUUID preheatData:(BOOL)preheatData;

/**
 Deletes image entry data in the image table.

 @param entityUUID The UUID of the entity that uniquely identifies an image table entry. Must not be `nil`.

 @note If `entityUUID` is `nil`, this method does nothing.
 */
- (void)deleteEntryForEntityUUID:(NSString *)entityUUID;

@end
</code></pre>
<p>è¿™é‡Œç›´æ¥ä» Bang å“¥é‚£é‡Œæ¬å¼ å›¾è¿‡æ¥<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FjgUmgRTfNalj1Hei9isgz-VSaGz.png" alt="" loading="lazy"></p>
<p>å› ä¸ºé‡‡ç”¨äº† mmap æŠ€æœ¯ï¼Œæ‰€ä»¥æ¯å¼ å›¾ç‰‡çš„æ•°æ®å¤§å°éƒ½æ˜¯ page size align çš„ã€‚<br>
ImageTable å¹¶ä¸ç›´æ¥åŒ…å« Entryï¼Œè€Œæ˜¯åœ¨ä¸­é—´åŠ äº†ä¸€å±‚ Chunkã€‚è¿™ä¸ª Chunk æ˜¯æ¯æ¬¡è¿è¡Œæ—¶åˆ›å»ºçš„ï¼Œæ‰€ä»¥ä¸€ä¸ª Chunk çš„å¤§å°ã€åŒ…å«å¤šå°‘ Entry ä½ éƒ½å¯ä»¥éšæ„è®¾ç½®ã€‚<br>
mmap çš„ç²’åº¦æ˜¯æ¯ä¸€ä¸ª Chunkï¼Œè¿™æ ·æ—¢ä¸ä¼šå¤ªå¤§ä¹Ÿä¸ä¼šå¤ªå°ï¼Œç›¸å½“çµæ´»ã€‚</p>
<h3 id="åŸºæœ¬æµç¨‹">åŸºæœ¬æµç¨‹</h3>
<p>è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹æ•´ä¸ª FastImageCache ä¸ App çš„å·¥ä½œæµç¨‹ã€‚</p>
<ol>
<li>
<p>App è¿›å…¥æŸä¸ªåˆ—è¡¨ï¼Œéœ€è¦æ˜¾ç¤ºå›¾ç‰‡ï¼Œæ‰€ä»¥è°ƒç”¨äº†<code>retrieveImageForEntity</code>ç›¸å…³æ¥å£è·å–å›¾ç‰‡ã€‚</p>
</li>
<li>
<p>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œæ­¤æ—¶è¿˜æ²¡æœ‰æ•°æ®ï¼Œåˆ™ FastImageCache ä¼šè¦æ±‚ App æä¾›åŸå§‹å›¾ç‰‡çš„æ•°æ®ã€‚</p>
<ol>
<li>æ‹¿åˆ°åŸå§‹å›¾ç‰‡åï¼Œæ¥ä¸‹æ¥éœ€è¦å¯»æ‰¾æ”¾åˆ°æ–‡ä»¶çš„å“ªä¸ªåœ°æ–¹åˆé€‚ã€‚å¦‚æœæ–‡ä»¶ä¸å¤Ÿæ”¾ï¼Œåˆ™éœ€è¦<code>ftruncate</code>æ‰©å±•ä¸€ä¸‹æ–‡ä»¶å¤§å°ã€‚æ­¤æ—¶ä¼šå¾—åˆ°ä¸€ä¸ª ImageTableEntryã€‚</li>
<li>æ ¹æ® ImageFormat çš„ä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ª Bitmapï¼Œç„¶åå°†å›¾ç‰‡ç»˜åˆ¶åˆ° ImageTableEntry å…¶ä¸­çš„ bytesï¼Œå…¶å®å°±æ˜¯å†™åˆ°æ–‡ä»¶ä¸­ã€‚</li>
</ol>
</li>
<li>
<p>æ ¹æ®<code>indexMap</code>æŸ¥è¯¢åˆ°å›¾ç‰‡ UUID å¯¹åº”åœ¨æ–‡ä»¶å“ªä¸ªä½ç½®ï¼Œåˆ›å»ºå¯¹åº”çš„ ImageTableEntryã€‚</p>
</li>
<li>
<p>å°†è¯¥ä½å›¾æ•°æ®è¯»å–å‡ºæ¥ï¼Œè¿”å›ç»™ App</p>
</li>
</ol>
<p>è¿™é‡Œä¸æƒ³è´´å¤ªå¤šä»£ç ï¼Œè‡ªè¡ŒæŸ¥é˜…ã€‚<br>
è§£ç å›¾ç‰‡æˆä½å›¾çš„é€»è¾‘å‚è€ƒä»¥ä¸‹æ–¹æ³•ï¼š<br>
<code>-[FICImageTable setEntryForEntityUUID:sourceImageUUID:imageDrawingBlock:]</code><br>
ä»å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­è¯»å–ä½å›¾çš„é€»è¾‘å‚è€ƒä»¥ä¸‹æ–¹æ³•ï¼š<br>
<code>-[FICImageTable newImageForEntityUUID:sourceImageUUID:preheatData:]</code></p>
<h2 id="æ³¨æ„ç‚¹-åæ§½">æ³¨æ„ç‚¹ &amp; åæ§½</h2>
<p>ImageFormat é™åˆ¶äº†å›¾ç‰‡çš„å¤§å°ç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥ FastImageCache é€‚ç”¨äºé‚£ç§æœ‰ç»Ÿä¸€å›¾åƒå¤§å°çš„åœºæ™¯ï¼Œæ¯”å¦‚èŠå¤©å¤´åƒã€ç›¸å†Œã€‚</p>
<p>_sourceImageMap æ²¡çœ‹åˆ°æœ‰ä»€ä¹ˆä½œç”¨ï¼Œå¯èƒ½æ˜¯ä¸ªé—ç•™ä»£ç ã€‚</p>
<p>ImageTable ä¸­çš„_imageLength å’Œ Entry ä¸­çš„ imageLength æ˜¯ä¸ç›¸ç­‰çš„ï¼Œå‰è€…æ˜¯å‡†ç¡®çš„æ•°å€¼ï¼Œåè€…ç”±äº page size alignï¼Œç®—å‡ºæ¥çš„ä¸æ˜¯å‡†ç¡®çš„ã€‚è™½ç„¶ä¸å½±å“ä½¿ç”¨ã€‚</p>
<p>ImageTable é‡Œé¢ç”¨äº†ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„æ•°æ®ç»“æœï¼Œçœ‹äº†å¥½å‡ éä»£ç æ‰çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€ã€‚<br>
æ¯”å¦‚_indexNumbers ç¼“å­˜äº† index çš„ NSNumber è¡¨ç¤ºï¼Œç”¨æ¥**@synchronized**åŠ é”ï¼Œé¿å…æ¯æ¬¡é‡æ–°ç”Ÿæˆ NSNumber å˜äº†ã€‚æœ‰ HashMap é”è¡¨å¤´é‚£å‘³äº†ï½<br>
_inUseEntries ä»£è¡¨å“ªä¸ª Entry æ­£åœ¨ä½¿ç”¨ï¼Œå‘ç”Ÿç¼“å­˜æ·˜æ±°æ—¶ï¼Œä¸èƒ½é€‰è¿™ä¸ª Entryã€‚</p>
<p>åœ¨è¯·æ±‚å›¾ç‰‡æ—¶ï¼Œç”±äºæ˜¯å¼‚æ­¥çš„ï¼ŒImageCache ä¸­è®¾ç½®äº†ä¸€ä¸ªå¾ˆå¤æ‚çš„ç»“æ„ï¼Œæˆ‘æ„Ÿè§‰è¿™é‡Œæ˜¯æœ‰ bug çš„ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FsyA7ivTbHH3QIdyvnz0Gm0CCyHy.png" alt="" loading="lazy"></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒFormatKey åªå¯¹åº”ä¸€ä¸ª FormatNameã€‚ä½†æ˜¯ BlocksKey é‡Œé¢æœ‰å¯èƒ½æœ‰å¤šç§ FormatNameã€‚<br>
æ‰€ä»¥å¦‚æœä½ çš„ä»£ç å†™æˆä¸‹é¢è¿™æ ·ï¼ŒåŒæ—¶å›¾åƒåŠ è½½å¤±è´¥äº†ï¼Œä½ çŒœçŒœä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<pre><code class="language-objectivec">[[FICImageCache sharedImageCache] retrieveImageForEntity:photo withFormatName:FormatNameA completionBlock:^(id&lt;FICEntity&gt; entity, NSString *formatName, UIImage *image) {
    NSLog(@&quot;%@&quot;, formatName);
}];
[[FICImageCache sharedImageCache] retrieveImageForEntity:photo withFormatName:FormatNameB completionBlock:^(id&lt;FICEntity&gt; entity, NSString *formatName, UIImage *image) {
    NSLog(@&quot;%@&quot;, formatName);
}];
</code></pre>
<p>æ¡†æ¶æœ‰ç‚¹å¤æ‚ï¼Œå¦‚æœä½ åªæ˜¯æƒ³ç®€å•æå‡ä¸€ä¸‹æ»šåŠ¨æ€§èƒ½ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­åšä¸€ä¸‹ç¼“å­˜å³å¯ã€‚<br>
åœ¨å®˜æ–¹çš„ Demo å·¥ç¨‹ä¸­ï¼Œæˆ‘ç»™ FICDPhoto åŠ äº†å‡ è¡Œä»£ç ï¼Œæ€§èƒ½å°±é£ä¸Šå»äº† ğŸš€ã€‚</p>
<pre><code class="language-objectivec">- (UIImage *)thumbnailImage {
    if (_thumbImage) {
        return _thumbImage;
    }
    UIImage *thumbnailImage = [UIImage imageWithContentsOfFile:[self _thumbnailFilePath]];
    _thumbImage = thumbnailImage;

    return thumbnailImage;
}
</code></pre>
<p>è¿™é‡Œå› ä¸ºæ˜¯ç¼©ç•¥å›¾ï¼Œæ‰€ä»¥å†…å­˜ä¸ä¼šæœ‰å¤ªå¤§æ¶ˆè€—ã€‚ä¸è¿‡åˆ—è¡¨æ»šåŠ¨çš„åœºæ™¯ï¼ŒåŸºæœ¬éƒ½æ˜¯ç¼©ç•¥å›¾å§ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<p><a href="http://blog.cnbang.net/tech/2578/">iOS å›¾ç‰‡åŠ è½½é€Ÿåº¦æé™ä¼˜åŒ–â€”FastImageCache è§£æ Â« bangâ€™s blog</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[AFNetworkingæºç åˆ†æ]]></title>
        <id>https://jayying007.github.io/post/AFNetworkingæºç åˆ†æ/</id>
        <link href="https://jayying007.github.io/post/AFNetworkingæºç åˆ†æ/">
        </link>
        <updated>2023-05-07T11:56:55.000Z</updated>
        <content type="html"><![CDATA[<p><a href="https://github.com/AFNetworking/AFNetworking">https://github.com/AFNetworking/AFNetworking</a></p>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>AFNetworking è¿™ä¸ªç½‘ç»œæ¡†æ¶ï¼Œç›¸ä¿¡ iOS å¼€å‘éƒ½ä¸é™Œç”Ÿã€‚å¦‚æœä½ çš„é¡¹ç›®æ˜¯é€šè¿‡ Http è¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¡†æ¶å¯ä»¥å¸®ä½ ç®€åŒ–ç½‘ç»œè¯·æ±‚å’Œå“åº”çš„é€»è¾‘ã€‚<br>
å®é™…ä¸Šå®ƒå°±æ˜¯å¯¹ç³»ç»Ÿ NSURLSessionã€NSURLSessionTask è¿™äº›é€»è¾‘åšäº†å°è£…ï¼Œæä¾›äº†æ›´å®‰å…¨æ›´æ˜“ç”¨çš„æ¥å£ã€‚<br>
è™½ç„¶è€æ—©å°±çŸ¥é“è¿™ä¸ªæ¡†æ¶ï¼Œä½†ä¸€ç›´æ²¡æœ‰å»çœ‹å…¶æºç å®ç°ã€‚ç­‰åˆ°æœ€è¿‘ç»ˆäºæŠ½å‡ºæ—¶é—´çœ‹æ—¶ï¼Œè¿™ä¸ªæ¡†æ¶å·²ç»å¯¿ç»ˆæ­£å¯äº†ã€‚ã€‚ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FqCBsO0axNH87FQL-fAExyIN8FPr.png" alt="" loading="lazy"></p>
<blockquote>
<p>è™½ç„¶ä½†æ˜¯ï¼Œå¤§å‚ä¸€èˆ¬æ¯”è¾ƒå°‘ç”¨ Http è¿™ç§æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯ç›´æ¥åŸºäº TCP å®ç°ã€‚æ‰€ä»¥ AFNetworking çš„å¸®åŠ©å°±ä¸å¤§äº†ã€‚<br>
è¿™é‡Œæ¨èä¸€ä¸ªè·¨å¹³å°ç½‘ç»œæ¡†æ¶<a href="https://github.com/Tencent/mars">https://github.com/Tencent/mars</a>ï¼Œä¹Ÿæ˜¯å¾®ä¿¡å®¢æˆ·ç«¯ä½¿ç”¨çš„ç½‘ç»œæ¡†æ¶ã€‚</p>
</blockquote>
<h2 id="ä¸åŸç”Ÿçš„å¯¹æ¯”">ä¸åŸç”Ÿçš„å¯¹æ¯”</h2>
<p>è¿™é‡Œç®€å•å†™å‡ ä¸ªä¾‹å­ï¼Œæ¼”ç¤ºç”¨ AFNetworking å’Œä¸åŒ AFNetworking ä»£ç çš„åŒºåˆ«<br>
{% tabs Get %}</p>
<!-- tab åŸç”ŸGetè¯·æ±‚ -->
<pre><code class="language-objectivec">- (void)get {
  NSURL *url = [NSURL URLWithString:@&quot;https://httpbin.org/get?name=123&amp;password=456&quot;];
  NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:30];
  [request setValue:@&quot;testValue&quot; forHTTPHeaderField:@&quot;Test-Header-Field&quot;];
  NSURLSession *session = [NSURLSession sharedSession];
  NSURLSessionDataTask *task = [session dataTaskWithRequest:request
                                  completionHandler:^(NSData *_Nullable data, NSURLResponse *_Nullable response, NSError *_Nullable error) {
                                    if (error != nil) {
                                      NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error);
                                    } else {
                                      NSString *result = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
                                      NSLog(@&quot;%@&quot;, result);
                                    }
                                  }];
  [task resume];
}
</code></pre>
<!-- endtab -->
<!-- tab AFNetworking Getè¯·æ±‚ -->
<pre><code class="language-objectivec">- (void)af_get {
  [[AFHTTPSessionManager manager] GET:@&quot;https://httpbin.org/get&quot;
     parameters:@{ @&quot;name&quot; : @123, @&quot;password&quot; : @456 }
     headers:@{ @&quot;Test-Header-Field&quot; : @&quot;testValue&quot; }
     progress:nil
     success:^(NSURLSessionDataTask *_Nonnull task, id _Nullable responseObject) {
       NSLog(@&quot;%@&quot;, responseObject);
     }
     failure:^(NSURLSessionDataTask *_Nullable task, NSError *_Nonnull error) {
       NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error);
     }];
}
</code></pre>
<!-- endtab -->
<p>{% endtabs %}</p>
<p>{% tabs Post %}</p>
<!-- tab åŸç”ŸPostè¯·æ±‚ -->
<pre><code class="language-objectivec">- (void)post {
  NSURL *url = [NSURL URLWithString:@&quot;https://httpbin.org/post&quot;];
  NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:30];
  [request setHTTPMethod:@&quot;POST&quot;];
  NSURLSession *session = [NSURLSession sharedSession];
  NSURLSessionDataTask *task = [session dataTaskWithRequest:request
                                  completionHandler:^(NSData *_Nullable data, NSURLResponse *_Nullable response, NSError *_Nullable error) {
                                    if (error != nil) {
                                      NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error);
                                    } else {
                                      NSString *result = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
                                      NSLog(@&quot;%@&quot;, result);
                                    }
                                  }];
  [task resume];
}
</code></pre>
<!-- endtab -->
<!-- tab AFNetworking Postè¯·æ±‚ -->
<pre><code class="language-objectivec">- (void)af_post {
  [[AFHTTPSessionManager manager] POST:@&quot;https://httpbin.org/post&quot;
     parameters:nil
     headers:nil
     progress:nil
     success:^(NSURLSessionDataTask *_Nonnull task, id _Nullable responseObject) {
       NSLog(@&quot;%@&quot;, responseObject);
     }
     failure:^(NSURLSessionDataTask *_Nullable task, NSError *_Nonnull error) {
       NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error);
     }];
}
</code></pre>
<!-- endtab -->
<p>{% endtabs %}</p>
<p>{% tabs Download %}</p>
<!-- tab åŸç”ŸDownloadè¯·æ±‚ -->
<pre><code class="language-objectivec">- (void)download {
  NSURL *url = [NSURL URLWithString:@&quot;https://httpbin.org/image/jpeg&quot;];
  NSURLRequest *request = [[NSURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:30];
  NSURLSessionConfiguration *config = [NSURLSessionConfiguration defaultSessionConfiguration];
  NSURLSession *session = [NSURLSession sessionWithConfiguration:config delegate:self delegateQueue:nil];
  NSURLSessionDownloadTask *task = [session downloadTaskWithRequest:request];
  [task resume];
}
#pragma mark - NSURLSessionDownloadDelegate
- (void)URLSession:(NSURLSession *)session
             downloadTask:(NSURLSessionDownloadTask *)downloadTask
             didWriteData:(int64_t)bytesWritten
        totalBytesWritten:(int64_t)totalBytesWritten
totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite {
    float rate = 1.f * totalBytesWritten / totalBytesExpectedToWrite;
    NSLog(@&quot;ä¸‹è½½è¿›åº¦ï¼š%.2lf&quot;, rate);
}

- (void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask didFinishDownloadingToURL:(NSURL *)location {
    NSString *downloadPath = [location path];
    NSLog(@&quot;å·²ä¸‹è½½åˆ°è·¯å¾„ï¼š%@&quot;, downloadPath);
    UIImage *image = [UIImage imageWithContentsOfFile:downloadPath];
    dispatch_async(dispatch_get_main_queue(), ^{
        //self.imageView.image = image;
    });
}
</code></pre>
<!-- endtab -->
<!-- tab AFNetworking Downloadè¯·æ±‚ -->
<pre><code class="language-objectivec">- (void)af_download {
  AFHTTPSessionManager *manager = [[AFHTTPSessionManager alloc] init];
  manager.responseSerializer = [[AFImageResponseSerializer alloc] init];
  [manager GET:@&quot;https://httpbin.org/image/jpeg&quot;
     parameters:nil
     headers:nil
     progress:^(NSProgress *_Nonnull downloadProgress) {
       NSLog(@&quot;ä¸‹è½½è¿›åº¦ï¼š%.2lf&quot;, downloadProgress.fractionCompleted);
     }
     success:^(NSURLSessionDataTask *_Nonnull task, id _Nullable responseObject) {
       dispatch_async(dispatch_get_main_queue(), ^{
         //self.imageView.image = responseObject;
       });
     }
     failure:^(NSURLSessionDataTask *_Nullable task, NSError *_Nonnull error) {
       NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error);
     }];
}
</code></pre>
<!-- endtab -->
<p>{% endtabs %}<br>
å¦‚æœæ˜¯ä¸‹è½½å›¾ç‰‡ï¼Œå…¶å® AFNetworking è¿˜æ‰©å±•äº† UIKit ç»„ä»¶çš„åŠŸèƒ½ï¼Œå¯ä»¥å†™æ›´å°‘çš„ä»£ç ã€‚</p>
<p>{% tabs Upload %}</p>
<!-- tab åŸç”ŸUploadè¯·æ±‚ -->
<pre><code class="language-objectivec">- (void)upload {
  NSURL *url = [NSURL URLWithString:@&quot;https://httpbin.org/post&quot;];
  NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:30];
  [request setHTTPMethod:@&quot;POST&quot;];
  NSURLSession *session = [NSURLSession sharedSession];
  UIImage *image = [UIImage imageNamed:@&quot;boss&quot;];
  NSData *imgData = UIImagePNGRepresentation(image);
  NSURLSessionUploadTask *task =
    [session uploadTaskWithRequest:request
     fromData:imgData
     completionHandler:^(NSData *_Nullable data, NSURLResponse *_Nullable response, NSError *_Nullable error) {
       if (error != nil) {
         NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error);
       } else {
         NSString *result = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
         NSLog(@&quot;%@&quot;, result);
       }
     }];
  [task resume];
}
</code></pre>
<!-- endtab -->
<!-- tab AFNetworking Uploadè¯·æ±‚ -->
<pre><code class="language-objectivec">- (void)af_upload {
  [[AFHTTPSessionManager manager] POST:@&quot;https://httpbin.org/post&quot;
     parameters:nil
     headers:nil
     constructingBodyWithBlock:^(id&lt;AFMultipartFormData&gt; _Nonnull formData) {
       UIImage *image = [UIImage imageNamed:@&quot;boss&quot;];
       NSData *imgData = UIImagePNGRepresentation(image);
       [formData appendPartWithFormData:imgData name:@&quot;imgData&quot;];
     }
     progress:^(NSProgress *_Nonnull downloadProgress) {
       NSLog(@&quot;ä¸Šä¼ è¿›åº¦ï¼š%.2lf&quot;, downloadProgress.fractionCompleted);
     }
     success:^(NSURLSessionDataTask *_Nonnull task, id _Nullable responseObject) {
       NSLog(@&quot;%@&quot;, responseObject);
     }
     failure:^(NSURLSessionDataTask *_Nullable task, NSError *_Nonnull error) {
       NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error);
     }];
}
</code></pre>
<!-- endtab -->
<p>{% endtabs %}</p>
<p>å¯¹æ¯”ä»£ç çœ‹å‡ºï¼Œåœ¨ Apple æ¨å‡º NSURLSession ä¹‹åï¼ŒAFNetworking çš„ä½œç”¨ç›¸è¾ƒäºä¹‹å‰å°äº†ä¸€äº›ï¼Œä½†ä»ç„¶è¿˜æœ‰ç”¨å¤„ã€‚æ¯”å¦‚æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚éƒ½ç»Ÿä¸€ä¸º Block çš„å›è°ƒæ–¹å¼ï¼Œè€Œä¸”å¸¦æœ‰ progessã€‚</p>
<h2 id="ä»£ç ç»“æ„">ä»£ç ç»“æ„</h2>
<p>å¯¹å…¶æºç çš„é˜…è¯»å¯ä»¥åˆ†ä¸‹é¢å‡ ä¸ªç±»åˆ«å»çœ‹ï¼š</p>
<ol>
<li><strong>å¯¹ NSURLSession åŠå…¶ä¸Šä¼ /ä¸‹è½½ä»»åŠ¡çš„ç®¡ç†</strong></li>
</ol>
<p>ç›¸å…³æ–‡ä»¶ï¼šAFURLSessionManagerã€AFHTTPSessionManager<br>
è¿™ä¸¤ä¸ªç±»å¯ä»¥è¯´æ˜¯æ¡†æ¶çš„æ ¸å¿ƒäº†ï¼Œä¹Ÿæ˜¯ä½ ä½¿ç”¨ AFNetworking 99%çš„åŸå› ã€‚</p>
<ol start="2">
<li><strong>è¯·æ±‚å’Œå“åº”çš„åºåˆ—åŒ–</strong></li>
</ol>
<p>ç›¸å…³æ–‡ä»¶ï¼šAFURLRequestSerializationã€AFURLResponseSerialization<br>
æ¯”å¦‚ä½ è¯·æ±‚æ—¶å¸¦ä¸Šçš„ queryStringã€HttpHeaderã€HttpBodyï¼Œéƒ½å¯ä»¥é€šè¿‡ AFHTTPRequestSerializer æä¾›çš„æ›´ç®€å•çš„æ¥å£å®ç°ã€‚AFURLResponseSerialization åˆ™å¯ä»¥å°†è¿”å›çš„ NSData è§£ææˆä½ æƒ³è¦çš„æ•°æ®ç±»å‹ã€‚</p>
<ol start="3">
<li><strong>å®‰å…¨ç›¸å…³</strong></li>
</ol>
<p>ä¸»è¦å°±æ˜¯ AFSecurityPolicy è¿™ä¸ªç±»ï¼Œç”¨äº SSL Pinningã€‚</p>
<ol start="4">
<li><strong>ç½‘ç»œå¯è¾¾æ€§</strong></li>
</ol>
<p>AFNetworkReachabilityManager è¿™ä¸ªç±»æ¡†æ¶æœ¬èº«å¹¶æ²¡æœ‰ç”¨åˆ°ï¼Œæ˜¯ä¸ªç›¸å¯¹ç‹¬ç«‹çš„æ¨¡å—ã€‚</p>
<ol start="5">
<li><strong>UIKit çš„æ‰©å±•</strong></li>
</ol>
<p>å¦‚æ”¯æŒäº† UIButtonã€UIImageView è®¾ç½®ç½‘ç»œå›¾ç‰‡ï¼Œæœ‰ç‚¹åƒ SDWebImageã€‚</p>
<h2 id="æºç åˆ†æ">æºç åˆ†æ</h2>
<h3 id="å¯¹-nsurlsession-åŠå…¶ä¸Šä¼ ä¸‹è½½ä»»åŠ¡çš„ç®¡ç†">å¯¹ NSURLSession åŠå…¶ä¸Šä¼ /ä¸‹è½½ä»»åŠ¡çš„ç®¡ç†</h3>
<p>AFURLSessionManager å¯¹ NSURLSession åšäº†å°è£…ï¼Œä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œä½ ä¸éœ€è¦ç›´æ¥åˆ›å»º or è°ƒç”¨ NSURLSession çš„æ¥å£äº†ï¼Œåœ¨ AFURLSessionManager èƒ½æ‰¾åˆ°å¸¸è§çš„æ¥å£ã€‚</p>
<pre><code class="language-objectivec">/**
 Creates and returns a manager for a session created with the specified configuration. This is the designated initializer.

 @param configuration The configuration used to create the managed session.

 @return A manager for a newly-created session.
 */
- (instancetype)initWithSessionConfiguration:(nullable NSURLSessionConfiguration *)configuration NS_DESIGNATED_INITIALIZER;

/**
 Creates an `NSURLSessionDataTask` with the specified request.

 @param request The HTTP request for the request.
 @param uploadProgressBlock A block object to be executed when the upload progress is updated. Note this block is called on the session queue, not the main queue.
 @param downloadProgressBlock A block object to be executed when the download progress is updated. Note this block is called on the session queue, not the main queue.
 @param completionHandler A block object to be executed when the task finishes. This block has no return value and takes three arguments: the server response, the response object created by that serializer, and the error that occurred, if any.
 */
- (NSURLSessionDataTask *)dataTaskWithRequest:(NSURLRequest *)request
                               uploadProgress:(nullable void (^)(NSProgress *uploadProgress))uploadProgressBlock
                             downloadProgress:(nullable void (^)(NSProgress *downloadProgress))downloadProgressBlock
                            completionHandler:(nullable void (^)(NSURLResponse *response, id _Nullable responseObject,  NSError * _Nullable error))completionHandler;

/**
 Creates an `NSURLSessionUploadTask` with the specified request for an HTTP body.

 @param request The HTTP request for the request.
 @param bodyData A data object containing the HTTP body to be uploaded.
 @param uploadProgressBlock A block object to be executed when the upload progress is updated. Note this block is called on the session queue, not the main queue.
 @param completionHandler A block object to be executed when the task finishes. This block has no return value and takes three arguments: the server response, the response object created by that serializer, and the error that occurred, if any.
 */
- (NSURLSessionUploadTask *)uploadTaskWithRequest:(NSURLRequest *)request
                                         fromData:(nullable NSData *)bodyData
                                         progress:(nullable void (^)(NSProgress *uploadProgress))uploadProgressBlock
                                completionHandler:(nullable void (^)(NSURLResponse *response, id _Nullable responseObject, NSError * _Nullable error))completionHandler;
</code></pre>
<p>AFURLSessionManager å¯¹ NSURLSessionTask äº‹ä»¶çš„å›è°ƒé‡‡ç”¨çš„æ˜¯ Block+Notification çš„æ–¹å¼ã€‚</p>
<pre><code class="language-objectivec">/**
 Sets a block to be executed as the last message related to a specific task, as handled by the `NSURLSessionTaskDelegate` method `URLSession:task:didCompleteWithError:`.

 @param block A block object to be executed when a session task is completed. The block has no return value, and takes three arguments: the session, the task, and any error that occurred in the process of executing the task.
 */
- (void)setTaskDidCompleteBlock:(nullable void (^)(NSURLSession *session, NSURLSessionTask *task, NSError * _Nullable error))block;

/**
 Sets a block to be executed when a download task has completed a download, as handled by the `NSURLSessionDownloadDelegate` method `URLSession:downloadTask:didFinishDownloadingToURL:`.

 @param block A block object to be executed when a download task has completed. The block returns the URL the download should be moved to, and takes three arguments: the session, the download task, and the temporary location of the downloaded file. If the file manager encounters an error while attempting to move the temporary file to the destination, an `AFURLSessionDownloadTaskDidFailToMoveFileNotification` will be posted, with the download task as its object, and the user info of the error.
 */
- (void)setDownloadTaskDidFinishDownloadingBlock:(nullable NSURL * _Nullable  (^)(NSURLSession *session, NSURLSessionDownloadTask *downloadTask, NSURL *location))block;

/**
 Posted when a task suspends its execution.
 */
FOUNDATION_EXPORT NSString * const AFNetworkingTaskDidSuspendNotification;
</code></pre>
<p>AFURLSessionManager æŒæœ‰äº† NSURLSessionï¼Œå°† delegate è®¾ç½®ä¸ºè‡ªå·±ï¼ŒåŒæ—¶ä¹Ÿå­˜å‚¨äº†ä¸€ä¸ª AFURLSessionManagerTaskDelegate æ•°ç»„ï¼Œç”¨äºå…³è” NSURLSession åˆ›å»ºçš„ Taskã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FncP7pMujiV7TNkQsp_ODX34BZdw.png" alt="" loading="lazy"><br>
AFURLSessionManagerTaskDelegate ä¸­ç»´æŠ¤äº† progressBlockã€completeBlock ç­‰ä¿¡æ¯ã€‚<br>
å¤§è‡´é€»è¾‘æ˜¯ï¼Œå¯åŠ¨ NSURLSessionTask æ—¶ï¼ŒNSURLSession é€šè¿‡ NSURLSessionDelegate é€šçŸ¥åˆ° AFURLSessionManagerã€‚ç„¶å AFURLSessionManager å†æ‰¾å‡ºå¯¹åº”çš„ AFURLSessionManagerTaskDelegateï¼Œå°†ç›¸å…³ä¿¡æ¯ä¼ é€’è¿‡å»ã€‚<br>
æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-objectivec">- (void)URLSession:(__unused NSURLSession *)session
              task:(NSURLSessionTask *)task
didCompleteWithError:(NSError *)error
{
    error = objc_getAssociatedObject(task, AuthenticationChallengeErrorKey) ?: error;
    __strong AFURLSessionManager *manager = self.manager;

    __block id responseObject = nil;

    NSMutableDictionary *userInfo = [NSMutableDictionary dictionary];
    userInfo[AFNetworkingTaskDidCompleteResponseSerializerKey] = manager.responseSerializer;

    //Performance Improvement from #2672
    NSData *data = nil;
    if (self.mutableData) {
        data = [self.mutableData copy];
        //We no longer need the reference, so nil it out to gain back some memory.
        self.mutableData = nil;
    }

		//çœç•¥æ— å…³ä»£ç 

    if (error) {
        //ç•¥ç•¥ç•¥
    } else {
        dispatch_async(url_session_manager_processing_queue(), ^{
            NSError *serializationError = nil;
            responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError];

            //çœç•¥æ— å…³ä»£ç 

            dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^{
                if (self.completionHandler) {
                    self.completionHandler(task.response, responseObject, serializationError);
                }

                dispatch_async(dispatch_get_main_queue(), ^{
                    [[NSNotificationCenter defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];
                });
            });
        });
    }
}
</code></pre>
<h3 id="è¯·æ±‚å’Œå“åº”çš„åºåˆ—åŒ–">è¯·æ±‚å’Œå“åº”çš„åºåˆ—åŒ–</h3>
<p>AFHTTPRequestSerializer ç”¨äºç®€åŒ– queryStringã€HttpHeaderã€HttpBody ç­‰çš„è®¾ç½®ã€‚ä¾‹å¦‚å®ƒä¼šè‡ªåŠ¨å¸®ä½ åŠ ä¸Š User-Agentã€Accept-Languageã€‚</p>
<pre><code class="language-objectivec">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request
                               withParameters:(id)parameters
                                        error:(NSError *__autoreleasing *)error
{
    NSMutableURLRequest *mutableRequest = [request mutableCopy];

    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id value, BOOL * __unused stop) {
        if (![request valueForHTTPHeaderField:field]) {
            [mutableRequest setValue:value forHTTPHeaderField:field];
        }
    }];

    NSString *query = @&quot;&quot;;
    if (parameters) {
        if (self.queryStringSerialization) {
            //çœç•¥æ— å…³ä»£ç 
        } else {
            switch (self.queryStringSerializationStyle) {
                case AFHTTPRequestQueryStringDefaultStyle:
                    query = AFQueryStringFromParameters(parameters);
                    break;
            }
        }
    }

    if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) {
        if (query &amp;&amp; query.length &gt; 0) {
            mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? @&quot;&amp;%@&quot; : @&quot;?%@&quot;, query]];
        }
    } else {
        if (![mutableRequest valueForHTTPHeaderField:@&quot;Content-Type&quot;]) {
            [mutableRequest setValue:@&quot;application/x-www-form-urlencoded&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];
        }
        [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]];
    }

    return mutableRequest;
}
</code></pre>
<p>AFHTTPResponseSerializer ç”¨äºç®€åŒ–è¿”å›ç»“æœã€‚NSURLSession è¿”å›çš„æ˜¯ NSDataï¼Œåˆ©ç”¨ AFJSONResponseSerializerï¼Œå¯ä»¥å°†å…¶è½¬ä¸º NSDictionaryã€‚åˆ©ç”¨ AFImageResponseSerializerï¼Œå¯ä»¥å°†å…¶è½¬ä¸º UIImageã€‚çœä¸‹è‡ªå·±å»å†™è½¬æ¢çš„ä»£ç ã€‚</p>
<pre><code class="language-objectivec">- (id)responseObjectForResponse:(NSURLResponse *)response
                           data:(NSData *)data
                          error:(NSError *__autoreleasing *)error
{
    if (![self validateResponse:(NSHTTPURLResponse *)response data:data error:error]) {
        if (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, NSURLErrorCannotDecodeContentData, AFURLResponseSerializationErrorDomain)) {
            return nil;
        }
    }

    //çœç•¥æ— å…³ä»£ç 
    id responseObject = [NSJSONSerialization JSONObjectWithData:data options:self.readingOptions error:&amp;serializationError];

    //çœç•¥æ— å…³ä»£ç 
    return responseObject;
}

- (BOOL)validateResponse:(NSHTTPURLResponse *)response
                    data:(NSData *)data
                   error:(NSError * __autoreleasing *)error
{
    BOOL responseIsValid = YES;
    NSError *validationError = nil;

    if ([response isKindOfClass:[NSHTTPURLResponse class]]) {
        if (self.acceptableContentTypes &amp;&amp; ![self.acceptableContentTypes containsObject:[response MIMEType]] &amp;&amp;
            !([response MIMEType] == nil &amp;&amp; [data length] == 0)) {
            //çœç•¥æ— å…³ä»£ç 
            responseIsValid = NO;
        }

        if (self.acceptableStatusCodes &amp;&amp; ![self.acceptableStatusCodes containsIndex:(NSUInteger)response.statusCode] &amp;&amp; [response URL]) {
            //çœç•¥æ— å…³ä»£ç 
            responseIsValid = NO;
        }
    }

		//çœç•¥æ— å…³ä»£ç 

    return responseIsValid;
}
</code></pre>
<p>å…¶ä¸­ï¼ŒAFImageResponseSerializer å¯ä»¥é…ç½®å¯¹ UIImage ç«‹å³è§£ç ï¼Œç›´æ¥ç»˜åˆ¶ bitmapã€‚å› ä¸ºæ˜¯åœ¨å­çº¿ç¨‹ï¼Œæ‰€ä»¥é™ä½äº†ä¸»çº¿ç¨‹è§£ç çš„å‹åŠ›ã€‚</p>
<h3 id="uikit-çš„æ‰©å±•">UIKit çš„æ‰©å±•</h3>
<p>è¿™é‡Œä»¥ UIImageView æ”¯æŒè®¾ç½®ç½‘ç»œå›¾ç‰‡ä¸ºä¾‹ï¼Œå…³é”®æ­¥éª¤éƒ½åŠ äº†æ³¨é‡Šè¯´æ˜ã€‚</p>
<pre><code class="language-objectivec">- (void)setImageWithURLRequest:(NSURLRequest *)urlRequest
              placeholderImage:(UIImage *)placeholderImage
                       success:(void (^)(NSURLRequest *request, NSHTTPURLResponse *_Nullable response, UIImage *image))success
                       failure:(void (^)(NSURLRequest *request, NSHTTPURLResponse *_Nullable response, NSError *error))failure {
    //1.æ˜¯å¦å·²æœ‰ç›¸åŒçš„ä»»åŠ¡åœ¨ä¸‹è½½
    if ([self isActiveTaskURLEqualToURLRequest:urlRequest]) {
        return;
    }
    //2.å–æ¶ˆä¹‹å‰çš„ä¸‹è½½ä»»åŠ¡
    [self cancelImageDownloadTask];

    AFImageDownloader *downloader = [[self class] sharedImageDownloader];
    //3.æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜
    id&lt;AFImageRequestCache&gt; imageCache = downloader.imageCache;
    UIImage *cachedImage = [imageCache imageforRequest:urlRequest withAdditionalIdentifier:nil];
    if (cachedImage) {
        self.image = cachedImage;
        [self clearActiveDownloadInformation];
        return;
    }
    //4.æ²¡æœ‰ç¼“å­˜ï¼Œå¼€å§‹ä¸‹è½½å›¾ç‰‡
    if (placeholderImage) {
        self.image = placeholderImage;
    }
    __weak __typeof(self) weakSelf = self;
    NSUUID *downloadID = [NSUUID UUID];
    AFImageDownloadReceipt *receipt = [downloader downloadImageForURLRequest:urlRequest
    withReceiptID:downloadID
    success:^(NSURLRequest *_Nonnull request, NSHTTPURLResponse *_Nullable response, UIImage *_Nonnull responseObject) {
        __strong __typeof(weakSelf) strongSelf = weakSelf;
        //5.ä¸‹è½½å®Œæˆè¦æ£€æŸ¥downloadIDæ˜¯å¦è·Ÿå½“å‰æœ€æ–°çš„receiptåŒ¹é…ï¼Œæœ‰å¯èƒ½å‡ºç°ä¸‹è½½é€”ä¸­åŠ å…¥äº†æ–°çš„ä¸‹è½½ä»»åŠ¡oræ¸…é™¤äº†ä¸‹è½½ä»»åŠ¡
        if ([strongSelf.af_activeImageDownloadReceipt.receiptID isEqual:downloadID]) {
            strongSelf.image = responseObject;
            [strongSelf clearActiveDownloadInformation];
        }
    }
    failure:^(NSURLRequest *_Nonnull request, NSHTTPURLResponse *_Nullable response, NSError *_Nonnull error) {
        __strong __typeof(weakSelf) strongSelf = weakSelf;
        if ([strongSelf.af_activeImageDownloadReceipt.receiptID isEqual:downloadID]) {
            if (failure) {
                failure(request, response, error);
            }
            [strongSelf clearActiveDownloadInformation];
        }
    }];

    self.af_activeImageDownloadReceipt = receipt;
}
</code></pre>
<p>è¿™å…¶å®å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å›¾ç‰‡ä¸‹è½½æ¡†æ¶çš„å®ç°é€»è¾‘ã€‚</p>
<p>ä¸‹é¢ç®€å•çœ‹çœ‹ AFImageDownloader çš„å®ç°ã€‚</p>
<pre><code class="language-objectivec">- (nullable AFImageDownloadReceipt *)downloadImageForURLRequest:(NSURLRequest *)request
                                                  withReceiptID:(nonnull NSUUID *)receiptID
                                                        success:(nullable void (^)(NSURLRequest *request, NSHTTPURLResponse  * _Nullable response, UIImage *responseObject))success
                                                        failure:(nullable void (^)(NSURLRequest *request, NSHTTPURLResponse * _Nullable response, NSError *error))failure {
    __block NSURLSessionDataTask *task = nil;
    dispatch_sync(self.synchronizationQueue, ^{
        NSString *URLIdentifier = request.URL.absoluteString;
        if (URLIdentifier == nil) {
            if (failure) {
                NSError *error = [NSError errorWithDomain:NSURLErrorDomain code:NSURLErrorBadURL userInfo:nil];
                dispatch_async(dispatch_get_main_queue(), ^{
                    failure(request, nil, error);
                });
            }
            return;
        }

        // 1) Append the success and failure blocks to a pre-existing request if it already exists
        AFImageDownloaderMergedTask *existingMergedTask = self.mergedTasks[URLIdentifier];
        if (existingMergedTask != nil) {
            AFImageDownloaderResponseHandler *handler = [[AFImageDownloaderResponseHandler alloc] initWithUUID:receiptID success:success failure:failure];
            [existingMergedTask addResponseHandler:handler];
            task = existingMergedTask.task;
            return;
        }

        // 2) Attempt to load the image from the image cache if the cache policy allows it
        switch (request.cachePolicy) {
            case NSURLRequestUseProtocolCachePolicy:
            case NSURLRequestReturnCacheDataElseLoad:
            case NSURLRequestReturnCacheDataDontLoad: {
                UIImage *cachedImage = [self.imageCache imageforRequest:request withAdditionalIdentifier:nil];
                if (cachedImage != nil) {
                    if (success) {
                        dispatch_async(dispatch_get_main_queue(), ^{
                            success(request, nil, cachedImage);
                        });
                    }
                    return;
                }
                break;
            }
            default:
                break;
        }

        // 3) Create the request and set up authentication, validation and response serialization
        NSUUID *mergedTaskIdentifier = [NSUUID UUID];
        NSURLSessionDataTask *createdTask;
        __weak __typeof__(self) weakSelf = self;

        createdTask = [self.sessionManager
                       dataTaskWithRequest:request
                       uploadProgress:nil
                       downloadProgress:nil
                       completionHandler:^(NSURLResponse * _Nonnull response, id  _Nullable responseObject, NSError * _Nullable error) {
                           dispatch_async(self.responseQueue, ^{
                               __strong __typeof__(weakSelf) strongSelf = weakSelf;
                               AFImageDownloaderMergedTask *mergedTask = [strongSelf safelyGetMergedTask:URLIdentifier];
                               if ([mergedTask.identifier isEqual:mergedTaskIdentifier]) {
                                   mergedTask = [strongSelf safelyRemoveMergedTaskWithURLIdentifier:URLIdentifier];
                                   if (error) {
                                       for (AFImageDownloaderResponseHandler *handler in mergedTask.responseHandlers) {
                                           if (handler.failureBlock) {
                                               dispatch_async(dispatch_get_main_queue(), ^{
                                                   handler.failureBlock(request, (NSHTTPURLResponse *)response, error);
                                               });
                                           }
                                       }
                                   } else {
                                       if ([strongSelf.imageCache shouldCacheImage:responseObject forRequest:request withAdditionalIdentifier:nil]) {
                                           [strongSelf.imageCache addImage:responseObject forRequest:request withAdditionalIdentifier:nil];
                                       }

                                       for (AFImageDownloaderResponseHandler *handler in mergedTask.responseHandlers) {
                                           if (handler.successBlock) {
                                               dispatch_async(dispatch_get_main_queue(), ^{
                                                   handler.successBlock(request, (NSHTTPURLResponse *)response, responseObject);
                                               });
                                           }
                                       }

                                   }
                               }
                               [strongSelf safelyDecrementActiveTaskCount];
                               [strongSelf safelyStartNextTaskIfNecessary];
                           });
                       }];

        // 4) Store the response handler for use when the request completes
        AFImageDownloaderResponseHandler *handler = [[AFImageDownloaderResponseHandler alloc] initWithUUID:receiptID
                                                                                                   success:success
                                                                                                   failure:failure];
        AFImageDownloaderMergedTask *mergedTask = [[AFImageDownloaderMergedTask alloc]
                                                   initWithURLIdentifier:URLIdentifier
                                                   identifier:mergedTaskIdentifier
                                                   task:createdTask];
        [mergedTask addResponseHandler:handler];
        self.mergedTasks[URLIdentifier] = mergedTask;

        // 5) Either start the request or enqueue it depending on the current active request count
        if ([self isActiveRequestCountBelowMaximumLimit]) {
            [self startMergedTask:mergedTask];
        } else {
            [self enqueueMergedTask:mergedTask];
        }

        task = mergedTask.task;
    });
    if (task) {
        return [[AFImageDownloadReceipt alloc] initWithReceiptID:receiptID task:task];
    } else {
        return nil;
    }
}
</code></pre>
<p><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FoYzJoQkRF0LogflV8nay1RhJtl_.png" alt="" loading="lazy"><br>
ä¸‹è½½æŸä¸ª URLRequest æ—¶ï¼Œä¼šå…ˆåœ¨ä¸‹è½½é˜Ÿåˆ— mergedTasks ä¸­æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ã€‚<br>
å¦‚æœä»»åŠ¡å·²å­˜åœ¨ï¼Œåˆ™ç»™ AFImageDownloaderMergedTask æ·»åŠ ä¸€ä¸ªæ–°çš„ç›‘å¬è€…å³å¯ï¼ˆä¸‹è½½å®Œæˆæ—¶ä¼šé€šçŸ¥æ‰€æœ‰ç›‘å¬è€…ï¼‰ï¼Œç„¶åè¿”å›ä¸€ä¸ªä¸‹è½½ç¥¨æ® AFImageDownloadReceiptã€‚<br>
å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å…ˆæŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼Œæœ‰çš„è¯ç›´æ¥è¿”å›ï¼›<br>
æœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œåˆ™éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ AFImageDownloaderMergedTaskï¼Œç„¶ååŠ ä¸Šç›‘å¬è€…ã€‚è¿™ä¸ªè¿‡ç¨‹é€šè¿‡ AFURLSessionManager åˆ›å»ºäº†ä¸€ä¸ª NSURLSessionDataTaskã€‚å¦‚æœå½“å‰å¹¶å‘ä¸‹è½½çš„æ¬¡æ•°è¿˜æ²¡è¾¾åˆ°ä¸Šé™çš„è¯ï¼Œåˆ™ç›´æ¥å¯åŠ¨ Taskï¼Œå¦åˆ™å°±å…ˆè¿›å…¥é˜Ÿåˆ—ç­‰å¾…ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<p>æ‰¾çš„èµ„æ–™æœ‰ç‚¹å¤è€ï¼Œä¸€äº›è¿˜æ˜¯è®²çš„ NSURLConnectionï¼Œå¯ä»¥ç›´æ¥è·³è¿‡ã€‚<br>
<a href="https://nshipster.cn/afnetworking-2/">AFNetworking 2.0</a><br>
<a href="http://blog.cnbang.net/tech/2320/">AFNetworking2.0 æºç è§£æ Â« bangâ€™s blog</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[FBRetainCycleDetectoræºç åˆ†æ]]></title>
        <id>https://jayying007.github.io/post/FBRetainCycleDetectoræºç åˆ†æ/</id>
        <link href="https://jayying007.github.io/post/FBRetainCycleDetectoræºç åˆ†æ/">
        </link>
        <updated>2023-04-23T15:02:06.000Z</updated>
        <content type="html"><![CDATA[<p><a href="https://github.com/facebook/FBRetainCycleDetector">https://github.com/facebook/FBRetainCycleDetector</a></p>
<h2 id="å†…å­˜ç®¡ç†æ¦‚å¿µ">å†…å­˜ç®¡ç†æ¦‚å¿µ</h2>
<p>å¯¹äºç¨‹åºä¸­çš„å†…å­˜å¯¹è±¡ç®¡ç†ï¼Œä¸€èˆ¬åˆ†ä¸ºæ‰‹åŠ¨ç®¡ç†ã€å¼•ç”¨è®¡æ•°ç®¡ç†ã€åƒåœ¾å›æ”¶ã€‚<br>
æ‰‹åŠ¨ç®¡ç†ï¼šä¾‹å¦‚ C è¯­è¨€ï¼Œmalloc åä¸éœ€è¦æ—¶ï¼Œéœ€è¦ freeï¼Œä¸ç„¶å°±ä¼šå†…å­˜æ³„éœ²ã€‚<br>
å¼•ç”¨è®¡æ•°ï¼šObjective-C çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼Œç¨æœ‰ä¸æ…å°±ä¼šé€ æˆå¾ªç¯å¼•ç”¨ï¼Œè¿™ä¹Ÿæ˜¯<code>FBRetainCycleDetector</code>è¦è§£å†³çš„é—®é¢˜ã€‚<br>
åƒåœ¾å›æ”¶ï¼šJava çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼Œä¹‹å‰å†™è¿‡æ–‡ç« <a href="https://blog.csdn.net/qq_17190121/article/details/115145066">ç®€è¿° - åƒåœ¾å›æ”¶ç®—æ³•_Mrzhuang007 çš„åšå®¢-CSDN åšå®¢</a></p>
<h2 id="å¾ªç¯å¼•ç”¨çš„æ£€æµ‹åŸç†">å¾ªç¯å¼•ç”¨çš„æ£€æµ‹åŸç†</h2>
<p>é¦–å…ˆéœ€è¦çŸ¥é“ç¨‹åºåˆ›å»ºäº†å“ªäº› OC å¯¹è±¡ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡ hook alloc æˆ–è€… allocWithZone å»ç›‘æµ‹ï¼›<br>
æ¥ä¸‹æ¥è¦çŸ¥é“æ¯ä¸ªå¯¹è±¡å¼ºå¼•ç”¨äº†å“ªäº›å¯¹è±¡ï¼›<br>
å¯»æ‰¾æ˜¯å¦æœ‰å¼•ç”¨å›è·¯ï¼›<br>
æœ€åéœ€è¦å»é‡ï¼Œæ¯”å¦‚ A-&gt;B-&gt;C-&gt;A å’Œ B-&gt;C-&gt;A-&gt;B å±äºåŒä¸€æ¡é“¾è·¯ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FoazLbNEWxnVBY3mFjcpTFyvo734.png" alt="" loading="lazy"><br>
å¯ä»¥çœ‹å‡ºï¼Œæ£€æµ‹å¾ªç¯å¼•ç”¨ï¼Œç›¸å½“äºåœ¨ä¸€ä¸ªæœ‰å‘å›¾ä¸­æ‰¾åˆ°ç¯ã€‚<br>
è¿™å°±å¾ˆç®€å•äº†ï¼Œéå†æ¯ä¸ªå¯¹è±¡åšä¸€ä¸‹ dfsï¼Œå°±å¯ä»¥çŸ¥é“æ¯ä¸ªå¯¹è±¡æ˜¯å¦ä½äºç¯ä¸­ï¼Œä»¥åŠå±äºå“ªä¸ªç¯ã€‚</p>
<h2 id="fbretaincycledetector-çš„å®ç°">FBRetainCycleDetector çš„å®ç°</h2>
<h3 id="å¯¹è±¡æ£€æµ‹">å¯¹è±¡æ£€æµ‹</h3>
<p><code>FBRetainCycleDetector</code>å®é™…ä¸Šæ²¡æœ‰ hook alloc ä¹‹ç±»çš„æ–¹æ³•ï¼Œè¦æ£€æµ‹æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ä¸»åŠ¨æ·»åŠ å¯¹è±¡ï¼Œé€šè¿‡<code>addCandidate:</code>æ–¹æ³•ã€‚<br>
å³åªå¯¹è¿™äº›å¯¹è±¡åš dfsï¼Œæ¯•ç«Ÿå®é™…é¡¹ç›®ä¸­å¯¹è±¡å®åœ¨å¤ªå¤šäº†ï¼Œæ£€æµ‹èµ·æ¥å†…å­˜å’Œæ€§èƒ½éƒ½æ˜¯é—®é¢˜ã€‚</p>
<p><code>FBRetainCycleDetector</code>çš„æ–¹æ³•åªæœ‰ä¸‰ä¸ªï¼š</p>
<ul>
<li>æ„é€ å‡½æ•°å¯é…ç½®å“ªäº›è¾¹å¯ä»¥å¿½ç•¥ï¼Œæ¯•ç«Ÿæœ‰äº›å¾ªç¯å¼•ç”¨æ˜¯æ•…æ„çš„ï¼Œä¼šåœ¨ä¹‹åè‡ªè¡Œæ‰“æ–­ï¼›</li>
<li>æ·»åŠ  dfs æœç´¢çš„åˆå§‹å¯¹è±¡ï¼›</li>
<li>è¿”å›æœç´¢ç»“æœï¼Œæ•°ç»„ä»£è¡¨ç¯çš„æ•°é‡ï¼Œæ•°ç»„é‡Œçš„å…ƒç´ ä¸ºé›†åˆï¼Œä»£è¡¨æ¯ä¸ªç¯çš„ç»„æˆã€‚</li>
</ul>
<pre><code class="language-objectivec">/**
 FBRetainCycleDetector

 The main class responsible for detecting retain cycles.

 Be cautious, the class is NOT thread safe.

 The process of detecting retain cycles is relatively slow and consumes a lot of CPU.
 */

@interface FBRetainCycleDetector : NSObject

/**
 Designated initializer

 @param configuration Configuration for detector. Can include specific filters and options.
 @see FBRetainCycleDetectorConfiguration
 */
- (nonnull instancetype)initWithConfiguration:(nonnull FBObjectGraphConfiguration *)configuration NS_DESIGNATED_INITIALIZER;

/**
 Adds candidate you are interested in getting retain cycles from.

 @param candidate Any Objective-C object you want to verify for cycles.
 */
- (void)addCandidate:(nonnull id)candidate;

/**
 Searches for all retain cycles for all candidates the detector has been
 provided with.

 @return NSSet with retain cycles. An element of this array will be
 an array representing retain cycle. That array will hold elements
 of type FBObjectiveCGraphElement.

 @discussion For given candidate, the detector will go through all object graph rooted in this candidate and return
 ALL retain cycles that this candidate references. It will also take care of removing duplicates. It will not look for
 cycles longer than 10 elements. If you want to look for longer ones use findRetainCyclesWithMaxCycleLenght:
 */
- (nonnull NSSet&lt;NSArray&lt;FBObjectiveCGraphElement *&gt; *&gt; *)findRetainCycles;

@end
</code></pre>
<h3 id="å¯¹è±¡ç»“æ„ä¸å¼•ç”¨æè¿°">å¯¹è±¡ç»“æ„ä¸å¼•ç”¨æè¿°</h3>
<p>å¯¹äºæœ‰å‘å›¾ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œéƒ½æ˜¯ç”¨<code>FBObjectiveCGraphElement</code>æ¥æè¿°ã€‚</p>
<pre><code class="language-objectivec">/**
 Base Graph Element representation. It carries some data about the object and should be overridden in subclass
 to provide references that subclass holds strongly (different for blocks, objects, other specializations).
 The Graph Element itself can only provide references from FBAssociationManager.
 */
@interface FBObjectiveCGraphElement : NSObject

/**
 Designated initializer.
 @param object Object this Graph Element will represent.
 @param configuration Provides detector's configuration that contains filters and options
 @param namePath Description of how the object was retrieved from it's parent. Check namePath property.
 */
- (nonnull instancetype)initWithObject:(nullable id)object
                         configuration:(nonnull FBObjectGraphConfiguration *)configuration
                              namePath:(nullable NSArray&lt;NSString *&gt; *)namePath;
/**
 Name path that describes how this object was retrieved from its parent object by names
 (for example ivar names, struct references). For more check FBObjectReference protocol.
 */
@property (nonatomic, copy, readonly, nullable) NSArray&lt;NSString *&gt; *namePath;
@property (nonatomic, weak, nullable) id object;
@property (nonatomic, readonly, nonnull) FBObjectGraphConfiguration *configuration;

/**
 Main accessor to all objects that the given object is retaining. Thread unsafe.
 @return NSSet of all objects this object is retaining.
 */
- (nullable NSSet *)allRetainedObjects;

@end
</code></pre>
<p>ç»“åˆ ObjC çš„ç‰¹æ€§ï¼Œå¯ä»¥æ‰©å±•å‡ºä»¥ä¸‹ç±»å‹ï¼š<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FuFB3_C4YzH9LzT3UB7wD93CpJkQ.png" alt="" loading="lazy"><br>
ä¹‹æ‰€ä»¥æœ‰ä¸åŒçš„æ´¾ç”Ÿç±»ï¼Œä¸»è¦æ˜¯è·å–å¼ºå¼•ç”¨å¯¹è±¡çš„æ–¹æ³•<code>allRetainedObjects</code>æœ‰æ‰€ä¸åŒ</p>
<p><strong>FBObjectiveCGraphElement</strong>ï¼šè·å– associate ç»‘å®šçš„å¯¹è±¡ï¼›<br>
<strong>FBObjectiveCBlock</strong>ï¼šåŸæœ‰åŸºç¡€ä¸Šï¼Œåˆ©ç”¨ Block çš„ç»“æ„ä½“ï¼Œè®¡ç®—å‡ºå¼ºå¼•ç”¨çš„å¯¹è±¡ï¼›<br>
<strong>FBObjectiveCObject</strong>ï¼šåŸæœ‰åŸºç¡€ä¸Šï¼Œè·å– Ivarsï¼Œå¦‚æœä¸ºé›†åˆå¯¹è±¡ï¼Œåˆ™è·å–å…¶ keys å’Œ valuesï¼›<br>
<strong>FBObjectiveCNSCFTimer</strong>ï¼šåŸæœ‰åŸºç¡€ä¸Šï¼Œè·å– NSTimer ä¸­çš„ target å’Œ userInfoï¼›</p>
<blockquote>
<p>Ivars å¯ä»¥åˆ©ç”¨ ObjC Runtime è·å–ï¼Œåˆ©ç”¨ IvarsLayout å¯ä»¥çŸ¥é“æ˜¯å¼±å¼•ç”¨è¿˜æ˜¯å¼ºå¼•ç”¨ã€‚å¯¹äº IvarsLayout çš„è¯´æ˜å¯ä»¥å‚è€ƒ<a href="https://www.jianshu.com/p/6b218d12caae">è¿™ç¯‡æ–‡ç« </a><br>
å¯¹äºç»“æ„ä½“å†…éƒ¨å˜é‡çš„è·å–åˆ™ç¨å¾®å¤æ‚ä¸€äº›ï¼Œéœ€è¦è€ƒè™‘ç»“æ„ä½“å¯¹é½é—®é¢˜ï¼Œç„¶ååˆ©ç”¨ typeEncoding è·å¾— OC å¯¹è±¡ã€‚<br>
Block åˆ™åˆ›å»ºä¸€äº›è™šæ‹Ÿçš„å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ Block çš„ dispose æ–¹æ³•ï¼Œè°è°ƒç”¨äº† release æ–¹æ³•å°±å¯ä»¥çŸ¥é“å“ªä¸ªæ˜¯çœŸæ­£çš„ OC å¼ºå¼•ç”¨å¯¹è±¡ã€‚<br>
Ivarsã€ç»“æ„ä½“ã€Block å¼ºå¼•ç”¨å¯¹è±¡çš„æ–¹æ³•è¿˜æŒºæœ‰æ„æ€çš„ï¼Œå»ºè®®è‡ªè¡Œé˜…è¯»æºç ï¼Œæ„Ÿå—å…¶å¥¥ç§˜ã€‚</p>
</blockquote>
<h3 id="å¾ªç¯å¼•ç”¨çš„æ£€æµ‹">å¾ªç¯å¼•ç”¨çš„æ£€æµ‹</h3>
<p>ä¸Šæ–‡ä¹Ÿè¯´äº†ï¼Œæ£€æµ‹ç”¨çš„æ˜¯ DFSï¼Œä¸è¿‡è¿™é‡Œå¹¶æ²¡æœ‰ç”¨é€’å½’ï¼Œè€Œæ˜¯åˆ©ç”¨å¾ªç¯å»æ¨¡æ‹Ÿæ¡Ÿçš„è¿è¡Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-objectivec">- (NSSet&lt;NSArray&lt;FBObjectiveCGraphElement *&gt; *&gt; *)_findRetainCyclesInObject:(FBObjectiveCGraphElement *)graphElement
                                                                 stackDepth:(NSUInteger)stackDepth
{
  NSMutableSet&lt;NSArray&lt;FBObjectiveCGraphElement *&gt; *&gt; *retainCycles = [NSMutableSet new];
  FBNodeEnumerator *wrappedObject = [[FBNodeEnumerator alloc] initWithObject:graphElement];

  // We will be doing DFS over graph of objects
  // Stack will keep current path in the graph
  NSMutableArray&lt;FBNodeEnumerator *&gt; *stack = [NSMutableArray new];

  // To make the search non-linear we will also keep
  // a set of previously visited nodes.
  NSMutableSet&lt;FBNodeEnumerator *&gt; *objectsOnPath = [NSMutableSet new];

  // Let's start with the root
  [stack addObject:wrappedObject];

  while ([stack count] &gt; 0) {
    // Take topmost node in stack and mark it as visited
    FBNodeEnumerator *top = [stack lastObject];
    [objectsOnPath addObject:top];
    // Take next adjecent node to that child. Wrapper object can
    // persist iteration state. If we see that node again, it will
    // give us new adjacent node unless it runs out of them
    FBNodeEnumerator *firstAdjacent = [top nextObject];
    if (firstAdjacent) {
      // Current node still has some adjacent not-visited nodes
      BOOL shouldPushToStack = NO;

      // Check if child was already seen in that path
      if ([objectsOnPath containsObject:firstAdjacent]) {
        // We have caught a retain cycle
        NSUInteger index = [stack indexOfObject:firstAdjacent];
        NSInteger length = [stack count] - index;
        NSRange cycleRange = NSMakeRange(index, length);
        NSMutableArray&lt;FBNodeEnumerator *&gt; *cycle = [[stack subarrayWithRange:cycleRange] mutableCopy];
        [cycle replaceObjectAtIndex:0 withObject:firstAdjacent];
        [retainCycles addObject:[self _unwrapCycle:cycle]];
      } else {
        // Node is clear to check, add it to stack and continue
        shouldPushToStack = YES;
      }

      if (shouldPushToStack &amp;&amp; [stack count] &lt; stackDepth) {
        [stack addObject:firstAdjacent];
      }
    } else {
      // Node has no more adjacent nodes, it itself is done, move on
      [stack removeLastObject];
      [objectsOnPath removeObject:top];
    }
  }
  return retainCycles;
}
</code></pre>
<p>ä¸ºäº†ä»£ç çš„æ˜“è¯»æ€§ï¼Œè¿™é‡Œåˆ äº†ä¸€äº›ä»£ç ã€‚</p>
<p>å…¶å®è¿™é‡Œè¿˜åšäº† dfs çš„å‰ªæä¼˜åŒ–ï¼Œè·³è¿‡äº†ä¸€äº›ä¸å¿…è¦çš„éå†è·¯å¾„ï¼Œä»£ç å¦‚ä¸‹</p>
<pre><code class="language-objectivec">// We don't want to retraverse the same subtree
if (![objectsOnPath containsObject:top]) {
  if ([_objectSet containsObject:@([top.object objectAddress])]) {
    [stack removeLastObject];
    continue;
  }
  // Add the object address to the set as an NSNumber to avoid
  // unnecessarily retaining the object
  [_objectSet addObject:@([top.object objectAddress])];
}
</code></pre>
<p>è®¾æƒ³ä¸‹é¢çš„åœºæ™¯<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FvpEz6JhKUJOpfa1mel8YBdZxq4U.png" alt="" loading="lazy"><br>
dfs é€šè¿‡è·¯å¾„ A-&gt;B-&gt;D-&gt;E-&gt;F-&gt;Dï¼Œå·²ç»å‘ç°äº† Dã€Eã€F ä¹‹é—´çš„å¾ªç¯å¼•ç”¨ã€‚è€Œä¸”æŒ‰ç…§ dfs çš„ç‰¹æ€§ï¼ŒDã€Eã€F æ‰€æœ‰å…³è”çš„è·¯å¾„éƒ½å·²ç»éå†å®Œäº†ã€‚<br>
åé¢å½“ dfs æ¥åˆ° A-&gt;C-&gt;E æ—¶ï¼Œå…¶å®å°±æ²¡å¿…è¦å†å¾€ä¸‹æ£€æµ‹äº†ï¼Œå› ä¸º E æ‰€æœ‰è·¯å¾„éƒ½æ£€æŸ¥è¿‡äº†ã€‚</p>
<h3 id="è¡¥å……">è¡¥å……</h3>
<p>å¯¹äºæœ€åæ£€æµ‹å‡ºæ¥çš„ç¯ï¼Œé€‰æ‹©å…¶ä¸­å¯¹è±¡åœ°å€æœ€å°çš„ä½œä¸ºç¯çš„å¤´èŠ‚ç‚¹ã€‚ç„¶ååœ¨æ ¹æ®ç±»åè¿›è¡Œå­—ç¬¦ä¸²æ’åºï¼Œæ‰¾åˆ°ä¸€ä¸ªå­—å…¸åºæœ€å°çš„ã€‚<br>
æœ€åè¿™ä¸¤ä¸ªæ„Ÿè§‰å¯æœ‰å¯æ— ï¼Œæ²¡å‘ç°æœ‰ä»€ä¹ˆåœºæ™¯éœ€è¦ç”¨åˆ°ã€‚<br>
æŸ¥çœ‹ Git çš„æäº¤è®°å½•ï¼Œå¯ä»¥å‘ç°æ˜¯æœ€åˆçš„å»é‡ç‰ˆæœ¬ã€‚åé¢å¼•å…¥å‰ªæåï¼Œå°±æ²¡ä½œç”¨äº†ï¼Œåªæ˜¯ä»£ç è¿˜æ²¡åˆ ã€‚ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Mach-Oæ–‡ä»¶çš„æ„å»ºã€è§£æä¸è¿è¡Œ]]></title>
        <id>https://jayying007.github.io/post/Mach-Oæ–‡ä»¶çš„æ„å»ºã€è§£æä¸è¿è¡Œ/</id>
        <link href="https://jayying007.github.io/post/Mach-Oæ–‡ä»¶çš„æ„å»ºã€è§£æä¸è¿è¡Œ/">
        </link>
        <updated>2023-04-09T04:40:54.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>çœæµï¼šå¦‚æœä½ è¿˜æ²¡æœ‰çœ‹è¿‡ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹ï¼Œé‚£å»ºè®®è¿˜æ˜¯å…ˆå»çœ‹å®Œè¿™æœ¬ä¹¦å§ã€‚</p>
</blockquote>
<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>ç±»ä¼¼äº Window çš„ PE æ–‡ä»¶ã€Linux çš„ ELF æ–‡ä»¶ï¼ŒOS X ä¸Šæ‰€æœ‰çš„ Appã€Frameworkã€Libiaryã€Command-Line Tool éƒ½å¯ä»¥ç§°ä¸º Mach-O æ–‡ä»¶ã€‚<br>
å¯¹è¿™äº› Mach-O æ–‡ä»¶çš„è¿›ä¸€æ­¥æè¿°ï¼Œå¯ä»¥å‚è€ƒ<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/1-Articles/building_files.html#//apple_ref/doc/uid/TP40001828-97030">The Productsâ€”Types of Mach-O Files You Can Build</a></p>
<p>ä¸€ä¸ª Mach-O æ–‡ä»¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šHeaderã€Load Commandsã€Dataã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fkk8pOAP_-UZXZta955gFg_tffP0.png" alt="" loading="lazy"><br>
Headerï¼šåŒ…å«è¯¥æ–‡ä»¶çš„ç›®æ ‡æ¶æ„ç­‰ä¿¡æ¯ï¼›<br>
Load Commandsï¼šæè¿°äº†è¯¥æ–‡ä»¶çš„åŸºæœ¬ç»“æ„ï¼ˆæ¯”å¦‚ç¬¦å·è¡¨åœ¨å“ªä¸ªåœ°æ–¹ï¼ŒSegment è¦åŠ åˆ°è™šæ‹Ÿå†…å­˜åœ°å€çš„å“ªä¸ªåœ°æ–¹ï¼‰ï¼›<br>
Dataï¼šè£¸çš„æ•°æ®ï¼Œå…·ä½“æ¯ä¸ª Byte ä»£è¡¨å•¥å°±çœ‹ Load Commands ä¸­çš„å®šä¹‰äº†ã€‚</p>
<p>ä¸€ä¸ª Mach-O åªåŒ…å«ä¸€ç§æ¶æ„çš„ä»£ç å’Œæ•°æ®ï¼ŒåŒ…å«å¤šä¸ªçš„è¢«ç§°ä¸º universal binaryã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ–‡ä»¶å¼€å¤´ä¸ºä¸€ä¸ª<code>fat_header</code>ç»“æ„ä½“ï¼Œè·Ÿéšä¸€ä¸ª<code>fat_arch</code>ç»“æ„ä½“æ•°ç»„ï¼Œæ ¹æ®è¿™ä¸ª<code>fat_arch</code>çš„ä¿¡æ¯ï¼Œå°±èƒ½å¿«é€Ÿæ‰¾åˆ°é€‚åˆå½“å‰æœºå™¨æ‰§è¡Œçš„ä»£ç å’Œæ•°æ®çš„ä½ç½®ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FqtXecpFB_uJTRut3aLKSlmRSXwM.png" alt="" loading="lazy"></p>
<h1 id="ç¨‹åºè¿è¡Œè¿‡ç¨‹æµ…æ">ç¨‹åºè¿è¡Œè¿‡ç¨‹æµ…æ</h1>
<p>Mach-O æ–‡ä»¶æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ç±»å‹ï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹é€šè¿‡å‘½ä»¤è¡Œæˆ–åŒå‡»å¯åŠ¨ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ã€‚<br>
å†è¯´ä¸€æ¬¡ï¼Œæƒ³è·å–è¿™éƒ¨åˆ†æ›´å®Œæ•´çš„çŸ¥è¯†ï¼Œå»çœ‹ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹ã€‚</p>
<p>å½“è¿è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼Œå†…æ ¸ä¸ºè¯¥ç¨‹åºåˆ›å»ºå¯¹åº”çš„è¿›ç¨‹ï¼Œå¹¶å°†å…¶è½½å…¥è¿›ç¨‹ç©ºé—´ä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠåŠ¨æ€é“¾æ¥å™¨ï¼ˆé€šå¸¸æ˜¯/usr/lib/dyldï¼‰è½½å…¥è¿›ç¨‹ç©ºé—´ä¸­ã€‚éšåæŠŠæ§åˆ¶å™¨äº¤ç»™åŠ¨æ€é“¾æ¥å™¨ï¼Œå³è·³è½¬åˆ°åŠ¨æ€é“¾æ¥å™¨æŒ‡å®šçš„å…¥å£åœ°å€ã€‚<br>
è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œ<code>fork</code>å’Œ<code>execve</code>ã€‚<code>fork</code>åˆ›å»ºäº†è¿›ç¨‹ï¼Œ<code>execve</code>å°†ç¨‹åºè½½å…¥è¿›ç¨‹ç©ºé—´å¹¶æ‰§è¡Œã€‚è½½å…¥çš„ Mach-O æ–‡ä»¶ä¸­ï¼Œä¼šæœ‰ä¸€æ¡ load command æŒ‡ç¤ºä»å“ªé‡ŒåŠ è½½åŠ¨æ€é“¾æ¥å™¨ã€‚</p>
<p>åŠ¨æ€é“¾æ¥å™¨ä¼šæŸ¥æ‰¾ç¨‹åºä¾èµ–çš„æ‰€æœ‰åŠ¨æ€åº“ï¼ˆè¿™éƒ¨åˆ†ä¿¡æ¯ä¹Ÿåœ¨ load command ä¸­ï¼‰ï¼Œç„¶åé€’å½’å°†å®ƒä»¬ä¹ŸåŠ è¿›æ¥ã€‚<br>
éšååŠ¨æ€é“¾æ¥å™¨ä¼šåšå¿…è¦çš„<strong>ç¬¦å·ç»‘å®š</strong>ï¼Œç„¶åè°ƒç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚è¿™ä¸ªå…¥å£ç‚¹å‡½æ•°æ˜¯é™æ€é“¾æ¥æ—¶æ·»åŠ çš„ï¼Œå®ƒä¼šåšä¸€äº› C++é™æ€å¯¹è±¡åˆå§‹åŒ–ã€ObjC è¿è¡Œæ—¶ä¹‹ç±»çš„æ“ä½œï¼Œæœ€åä¼šè°ƒç”¨ main å‡½æ•°ã€‚</p>
<h2 id="å°ç»“">å°ç»“</h2>
<p>App å¯åŠ¨è¿‡ç¨‹å…¶å®ä¹‹å‰ä¹Ÿå†™è¿‡æ–‡ç« åˆ†äº«ï¼Œä¼ é€é—¨ <a href="https://www.yuque.com/jayying/uk3dsf/ntpxwg">iOS App çš„å¯åŠ¨è¿‡ç¨‹ï¼ˆæµç¨‹ç¯‡ï¼‰</a><br>
æˆ–è€…çœ‹ä¸‹è‹¹æœæ–‡æ¡£ï¼š<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/1-Articles/executing_files.html#//apple_ref/doc/uid/TP40001829-96913-TPXREF103">Forking and Executing the Process</a>ã€<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/1-Articles/executing_files.html#//apple_ref/doc/uid/TP40001829-97021-TPXREF121">Finding Imported Symbols</a><br>
ä¸‹é¢ç¨å¾®ä»‹ç»ä¸€ä¸‹ç¬¦å·ç»‘å®šã€‚</p>
<h2 id="ç¬¦å·ç»‘å®š">ç¬¦å·ç»‘å®š</h2>
<p>è®²è§£ç¬¦åˆç»‘å®šä¹‹å‰ï¼Œå…ˆç®€å•è¯´æ˜ä¸€ä¸‹æ¨¡å—ï¼ˆmoduleï¼‰çš„å«ä¹‰ï¼Œæ¨¡å—æ˜¯ç”±æ•°æ®å’Œä»£ç æ„æˆçš„æœ€å°å•å…ƒï¼Œå¯ä»¥ç‹¬ç«‹è·Ÿå…¶ä»–å•å…ƒé“¾æ¥ã€‚ä¾‹å¦‚ç¼–è¯‘æ–‡ä»¶ main.cã€thing.cã€foo.cï¼Œäº§ç”Ÿäº† main.oã€thing.oã€foo.oï¼Œè¿™é‡Œå°±æ˜¯ä¸‰ä¸ªæ¨¡å—ã€‚ä¸è¿‡åœ¨ç¼–è¯‘ App æ—¶ï¼Œé™æ€é“¾æ¥å™¨ä¼šæŠŠå®ƒä»¬åˆå¹¶ä¸ºåŒä¸€æ¨¡å—ã€‚</p>
<p>åŒä¸€æ¨¡å—å†…ï¼Œç”±äºçŸ¥é“å‡½æ•°ã€æ•°æ®çš„åœ°å€ï¼Œæ‰€æœ‰æ¨¡å—å†…çš„ç¬¦å·å¼•ç”¨éƒ½å¯ä»¥åœ¨é™æ€é˜¶æ®µç¡®å®šä¸‹æ¥ã€‚ä½†æ˜¯ç¨‹åºä¹Ÿä¼šå­˜åœ¨å¼•ç”¨ openã€printf è¿™ç±»ç³»ç»Ÿåº“ä¸­çš„ç¬¦å·ï¼Œå±äºè·¨æ¨¡å—ç¬¦å·å¼•ç”¨ã€‚<br>
ä¸€ä¸ªæ¨¡å—ï¼ˆæºç¨‹åºï¼‰å¼•ç”¨äº†å¦ä¸€ä¸ªæ¨¡å—ï¼ˆåŠ¨æ€åº“ï¼‰çš„æ•°æ®æˆ–å‡½æ•°ï¼Œéœ€è¦ç­‰å¦ä¸€ä¸ªæ¨¡å—åŠ è½½åˆ°è¿›ç¨‹ç©ºé—´åï¼Œæ‰èƒ½ç¡®å®šè¯¥æ¨¡å—å‡½æ•°å’Œæ•°æ®çš„å…·ä½“åœ°å€ï¼Œç„¶åå†åšå¼•ç”¨ç¬¦å·åœ°å€çš„ä¿®æ­£ï¼Œæˆ–è€…å«ç¬¦å·ç»‘å®šã€‚</p>
<p>ç¬¦å·ç»‘å®šçš„æ–¹å¼é€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§ï¼š<br>
lazy-bindingï¼Œè™½ç„¶ç¨‹åºè¿è¡Œæ—¶å°±æŠŠå…±äº«åº“åŠ åˆ°è¿›ç¨‹ç©ºé—´ä¸­ï¼Œä½†ç›´åˆ°ç¬¬ä¸€æ¬¡å¼•ç”¨ç¬¦å·æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨æ‰å»åšç»‘å®šã€‚<br>
load-time bindingï¼Œé¡¾åæ€ä¹‰ï¼Œç¨‹åºè¿è¡Œæ—¶å°±è¿›è¡Œç»‘å®šã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŠ¨æ€é“¾æ¥å™¨æ‰§è¡Œ lazy-binding çš„ç­–ç•¥ã€‚åœ¨ ld é˜¶æ®µï¼Œé€šè¿‡æ·»åŠ å‚æ•°<code>-bind_at_load</code>å³å¯å¼ºåˆ¶è¿è¡Œæ—¶ç»‘å®šã€‚<br>
prebindingï¼Œå°‘ç”¨ï¼Œä¸å¤šåšè¯´æ˜ã€‚</p>
<p>ä¸è¿‡ç¬¦å·ç»‘å®šæ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œä»”ç»†ä¸€æƒ³ï¼Œä½ çŸ¥é“äº† openã€printf ç­‰å‡½æ•°çš„åœ°å€ï¼Œä½†æ˜¯ä½ æ— æ³•å°†è¿™äº›ä¿¡æ¯å¡«å……åˆ°æºç¨‹åºçš„ä»£ç æ®µä¸­ï¼Œå› ä¸ºä»£ç æ®µçš„æƒé™æ˜¯åªè¯»å’Œå¯æ‰§è¡Œï¼Œä¸èƒ½å†™ã€‚<br>
ä¼¼ä¹é™·å…¥äº†åƒµå±€ï¼ŒåŠ¨æ€åº“çš„å‡½æ•°åœ°å€è¦è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šï¼Œè€Œä¿®æ”¹ä»£ç æ®µåªèƒ½åœ¨é™æ€é“¾æ¥é˜¶æ®µï¼Œä¸€æ—¦è½½å…¥å†…å­˜å°±æ— æ³•ä¿®æ”¹ã€‚<br>
ä¸è¿‡é€€ä¸€ä¸‡æ­¥è®²ï¼Œå³ä½¿ä»£ç æ®µå¯å†™ï¼Œä¹Ÿä¼šæœ‰å…¶ä»–é—®é¢˜ã€‚é™¤äº†æºç¨‹åºå¼•ç”¨åŠ¨æ€åº“ï¼Œä¹Ÿä¼šæœ‰åŠ¨æ€åº“å¼•ç”¨å¦ä¸€ä¸ªåŠ¨æ€åº“çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ¨æ€åº“é‡Œé¢ä¹Ÿæœ‰å¼•ç”¨ç¬¦å·éœ€è¦ä¿®æ­£ã€‚é—®é¢˜å°±åœ¨è¿™é‡Œï¼Œä½ çš„ç¨‹åºä¿®æ­£äº†åŠ¨æ€åº“é‡Œé¢çš„ç¬¦å·å¼•ç”¨åœ°å€ï¼Œä½†æ˜¯åŠ¨æ€åº“æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«çš„å‘€ã€‚æœ‰å¯èƒ½å…¶ä»–è¿›ç¨‹ä¹Ÿä¾èµ–è¿™ä¸ªåŠ¨æ€åº“ï¼Œè€Œå®ƒå¯¹åº”çš„ç¬¦å·åœ°å€ä¸è§å¾—è·Ÿä½ çš„ä¸€æ ·ï¼Œè¿™æ ·æå…¶ä»–è¿›ç¨‹å°±å´©æºƒäº†ã€‚é‚£ä½ åªèƒ½æ¯ä¸ªè¿›ç¨‹éƒ½æä¸€ä»½è‡ªå·±çš„ï¼Œä¸è¿‡è¿™æ ·å°±å¤±å»äº†åŠ¨æ€åº“èŠ‚çœç©ºé—´çš„ä¸€å¤§ä¼˜åŠ¿äº†ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FiYfAS7bDkO0ZSxJZKrc_9sb7mPx.png" alt="" loading="lazy"></p>
<p>ä¸è¿‡åŠæ³•æ€»æ¯”å›°éš¾å¤šï¼Œä»£ç æ®µä¸å¯å†™ï¼Œä½†æ˜¯æ•°æ®æ®µå¯å†™å‘€ï¼Œäºæ˜¯å°±æœ‰äº†æ›²çº¿æ•‘å›½çš„æ–¹å¼ã€‚åŠ¨æ€åº“çš„å‡½æ•°åœ°å€è¿è¡Œæ—¶ç¡®å®šåï¼ŒæŠŠåœ°å€å†™åˆ°<code>__DATA</code>çš„æŸä¸ªåœ°æ–¹ã€‚ç”±äº<code>__TEXT</code>å’Œ<code>__DATA</code>çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ä»£ç ä¸Šå¯ä»¥åˆ©ç”¨å½“å‰ PC+åç§»é‡å¾—åˆ°åœ°å€å­˜æ”¾çš„ä½ç½®ï¼Œç„¶åå†è®¿é—®åœ°å€ã€‚è¿™ç§æ–¹å¼åˆå«é—´æ¥ç¬¦å·å¼•ç”¨ã€‚</p>
<blockquote>
<p><a href="https://github.com/facebook/fishhook">fishhook</a>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å®ç°äº† Hook C å‡½æ•°ã€‚<br>
PSï¼šæœ¬æ¥æƒ³å†™ä¸€ç¯‡æºç åˆ†ææ–‡ç« çš„ï¼Œä½†æºç å…¶å®å°±ä¸¤ç™¾æ¥è¡Œï¼ŒçŸ¥é“ Mach-O å’ŒåŠ¨æ€é“¾æ¥çš„ç‰¹æ€§åä¹Ÿä¸éš¾ç†è§£ï¼Œäºæ˜¯æ”¾å¼ƒäº†ã€‚</p>
</blockquote>
<h1 id="åº–ä¸è§£ç‰›">åº–ä¸è§£ç‰›</h1>
<p>å‰é¢å·²ç»è®²äº† Mach-O æ–‡ä»¶æ‰§è¡Œçš„ä¸€äº›ç»†èŠ‚ï¼Œæ¥ä¸‹æ¥å°±äº²è‡ªåŠ¨æ‰‹ï¼Œé€ä¸ª Byte åˆ†æ Mach-O æ–‡ä»¶çš„å¥¥ç§˜ã€‚ä¸­é—´ä¼šç©¿æ’å„ç§ ğŸ§‘â€ğŸ’»Codingï¼Œç”¨äºéªŒè¯ã€‚</p>
<h2 id="å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨">å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨</h2>
<p>æŸ¥çœ‹ä¸€ä¸ª Mach-O æ–‡ä»¶åŒ…å«ä»€ä¹ˆä¿¡æ¯ï¼Œæœ‰å¾ˆå¤šå·¥å…·å¯ä»¥ä½¿ç”¨ã€‚<br>
lipoï¼šåˆ†æä½“ç³»ç»“æ„<br>
fileï¼šæ˜¾ç¤ºæ–‡ä»¶ç±»å‹<br>
otoolï¼šæŸ¥çœ‹ Mach-O æ–‡ä»¶å…·ä½“çš„ Segmentã€Section æ•°æ®<br>
pagestuffï¼šæŒ‰é¡µæŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯<br>
nmï¼šæŸ¥çœ‹ç¬¦å·è¡¨<br>
libtoolï¼šå¯å°†å¤šä¸ªä¸­é—´æ–‡ä»¶åˆå¹¶ä¸ºé™æ€åº“ a</p>
<blockquote>
<p>ğŸ’¡ ä¸Šé¢çš„éƒ½æ˜¯å‘½ä»¤è¡Œå·¥å…·ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªå¸¸ç”¨çš„å¯è§†åŒ–å·¥å…· MachOView</p>
</blockquote>
<p>å¦å¤–å†è¡¥ä¸€ä¸‹æˆ‘çš„ç”µè„‘é…ç½®<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FgzxoCveBndgMDmE_NSkEI74FzF6.png" alt="" loading="lazy"><br>
emmmï¼Œå½“æ—¶ M1 Max åˆšå‡ºæ—¶ä¹°çš„ï¼Œç­‰äº†å¿«ä¸€ä¸ªæœˆæ‰åˆ°è´§...</p>
<h2 id="coding-ç¯èŠ‚">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h2>
<p>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶<code>file_b.c</code>ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre><code class="language-c">int base = 0xfff0;

int getAddress(int base, int offset) {
    return base + offset;
}
</code></pre>
<p>ç„¶åç¼–è¯‘</p>
<pre><code class="language-shell">//å•ç‹¬ç¼–è¯‘ï¼Œä¸é“¾æ¥
clang -c file_b.c -o file_b.o
</code></pre>
<h2 id="header">Header</h2>
<p>Mach-O æ–‡ä»¶å¼€å¤´æ˜¯ä¸€ä¸ª<code>mach_header</code>ç»“æ„ä½“ã€‚ä»£ç ä½äº mach-o/loader.hï¼Œå…¶åœ¨ 32 ä½å’Œ 64 ä½æœºå™¨ä¸‹ç»“æ„ç¨æœ‰ä¸åŒã€‚</p>
<pre><code class="language-c">/*
 * The 32-bit mach header appears at the very beginning of the object file for
 * 32-bit architectures.
 */
struct mach_header {
	uint32_t	magic;		/* mach magic number identifier */
	int32_t		cputype;	/* cpu specifier */
	int32_t		cpusubtype;	/* machine specifier */
	uint32_t	filetype;	/* type of file */
	uint32_t	ncmds;		/* number of load commands */
	uint32_t	sizeofcmds;	/* the size of all the load commands */
	uint32_t	flags;		/* flags */
};

struct mach_header_64 {
	uint32_t	magic;		/* mach magic number identifier */
	int32_t		cputype;	/* cpu specifier */
	int32_t		cpusubtype;	/* machine specifier */
	uint32_t	filetype;	/* type of file */
	uint32_t	ncmds;		/* number of load commands */
	uint32_t	sizeofcmds;	/* the size of all the load commands */
	uint32_t	flags;		/* flags */
	uint32_t	reserved;	/* reserved */
};
</code></pre>
<p>magic è¡¨ç¤ºå½“å‰ Mach-O æ–‡ä»¶å¯è¿è¡Œäº 32 ä½è¿˜æ˜¯ 64 ä½æœºå™¨ï¼Œä»¥åŠæœºå™¨çš„ç«¯åºã€‚</p>
<pre><code class="language-c">/* Constant for the magic field of the mach_header (32-bit architectures) */
#define	MH_MAGIC	0xfeedface	/* the mach magic number */
#define MH_CIGAM	0xcefaedfe	/* NXSwapInt(MH_MAGIC) */

/* Constant for the magic field of the mach_header_64 (64-bit architectures) */
#define MH_MAGIC_64 0xfeedfacf /* the 64-bit mach magic number */
#define MH_CIGAM_64 0xcffaedfe /* NXSwapInt(MH_MAGIC_64) */
</code></pre>
<p>cputypeã€cpusubtype è¡¨ç¤ºæœºå™¨æ¶æ„ï¼Œå¦‚ CPU_TYPE_ARM64ã€CPU_TYPE_X86_64ã€‚æ›´å¤šå®šä¹‰å¯ä»¥æŸ¥çœ‹ mach/machine.h</p>
<p>filetype è¡¨ç¤º Mach-O æ–‡ä»¶çš„ç±»å‹ï¼Œå¸¸è§çš„æœ‰ï¼šä¸­é—´å¯¹è±¡æ–‡ä»¶ï¼ˆMH_OBJECTï¼‰ã€å¯æ‰§è¡ŒäºŒè¿›åˆ¶ï¼ˆMH_EXECUTEï¼‰ã€VM å…±äº«åº“æ–‡ä»¶ï¼ˆMH_FVMLIBï¼‰ã€Crash äº§ç”Ÿçš„ Core æ–‡ä»¶ï¼ˆMH_COREï¼‰ã€åŠ¨æ€å…±äº«åº“ï¼ˆMH_DYLIBï¼‰ã€åŠ¨æ€é“¾æ¥å™¨ï¼ˆMH_DYLINKERï¼‰ã€é™æ€é“¾æ¥æ–‡ä»¶ï¼ˆMH_DYLIB_STUBï¼‰ã€ç¬¦å·æ–‡ä»¶å’Œè°ƒè¯•ä¿¡æ¯ï¼ˆMH_DSYMï¼‰</p>
<p>ncmds å’Œ sizeofcmds ä»£è¡¨æœ‰å¤šå°‘ load command ä»¥åŠæ‰€å å¤§å°</p>
<p>flags æ˜¯ä¸€äº›æ ‡è®°å­—æ®µï¼Œå…·ä½“å«ä¹‰å¯å‚è€ƒ loader.h ä¸­çš„è¯´æ˜ã€‚</p>
<h3 id="coding-ç¯èŠ‚-2">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h3>
<p>æˆ‘ä»¬å¯ä»¥ç”¨å‘½ä»¤è¡Œå·¥å…·æ‰“å°ä¸€ä¸‹</p>
<pre><code class="language-shell">otool -v -h file_b.o
</code></pre>
<p>ç»“æœå¦‚ä¸‹</p>
<pre><code>Mach header
magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags
MH_MAGIC_64    ARM64        ALL  0x00      OBJECT     4        440 SUBSECTIONS_VIA_SYMBOLS
</code></pre>
<p>ç›´æ¥ç”¨ä»£ç éªŒè¯<br>
ä¸ºäº†ä¾¿äºåç»­ä»£ç ç¼–å†™ï¼Œè¿™é‡ŒåŠ å‡ ä¸ªåˆ«åå’Œå®å®šä¹‰ï¼Œæ–°å‡ºç°çš„ä¹ŸæŒ‰åŒæ ·è§„åˆ™å¤„ç†</p>
<pre><code class="language-c">#ifdef __LP64__
typedef struct mach_header_64 mach_header_t;
typedef struct segment_command_64 segment_command_t;
typedef struct section_64 section_t;
typedef struct nlist_64 nlist_t;
#define LC_SEGMENT_ARCH_DEPENDENT LC_SEGMENT_64
#else
typedef struct mach_header mach_header_t;
typedef struct segment_command segment_command_t;
typedef struct section section_t;
typedef struct nlist nlist_t;
#define LC_SEGMENT_ARCH_DEPENDENT LC_SEGMENT
#endif

#ifndef SEG_DATA_CONST
#define SEG_DATA_CONST  &quot;__DATA_CONST&quot;
#endif

typedef struct load_command load_command_t;
typedef struct dylib_command dylib_command_t;
typedef struct dylinker_command dylinker_command_t;
typedef struct symtab_command symtab_command_t;
typedef struct dysymtab_command dysymtab_command_t;
</code></pre>
<pre><code class="language-c">void *getFilePointer(const char *filePath) {
    int fd = open(filePath, O_RDONLY, S_IRUSR);
    struct stat st = {};
    fstat(fd, &amp;st);
    uint64_t fileSize = (uint64_t)st.st_size;
    void *ptr = mmap(NULL, fileSize, PROT_READ, MAP_SHARED, fd, 0);
    return ptr;
}

void startReadMachO(const char *filePath) {
    void *filePtr = getFilePointer(filePath);
    void *curPtr = filePtr;

    mach_header_t *header = (mach_header_t *)curPtr;
    printf(&quot;magic: %x\n&quot;, header-&gt;magic);
    printf(&quot;cputype: %u\n&quot;, header-&gt;cputype);
    printf(&quot;cpusubtype: %u\n&quot;, header-&gt;cpusubtype);
    printf(&quot;filetype: %u\n&quot;, header-&gt;filetype);
    printf(&quot;ncmds: %u\n&quot;, header-&gt;ncmds);
    printf(&quot;sizeofcmds: %u\n&quot;, header-&gt;sizeofcmds);
    printf(&quot;flags: %u\n&quot;, header-&gt;flags);
}
</code></pre>
<p>ä¼ å…¥ file_b.o çš„è·¯å¾„ï¼Œå¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼Œæ•°æ®å»åˆ</p>
<pre><code>magic: feedfacf
cputype: 16777228
cpusubtype: 0
filetype: 1
ncmds: 4
sizeofcmds: 440
flags: 8192
</code></pre>
<h2 id="load-commands">Load Commands</h2>
<p>ä¸‹ä¸€æ­¥æ¥åˆ° load commandï¼Œä» mach_header é‚£é‡Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† load commands çš„æ€»ä½“å¤§å°ã€‚<br>
load command æœ‰å¾ˆå¤šç§ï¼Œä½†æ˜¯æ‰€æœ‰ load command ç»“æ„ä½“çš„å‰ä¸¤ä¸ªå±æ€§æ˜¯ä¸€æ ·çš„ï¼Œç±»ä¼¼äºé¢å‘å¯¹è±¡ä¸­çš„åŸºç±»ã€‚</p>
<pre><code class="language-c">struct load_command {
	uint32_t cmd;		/* type of load command */
	uint32_t cmdsize;	/* total size of command in bytes */
};
</code></pre>
<p>cmd ä»£è¡¨äº† load command çš„ç±»å‹ï¼Œcmdsize ä»£è¡¨å…·ä½“ load command çš„ç»“æ„ä½“å¤§å° + é¢å¤–æ•°æ®å¤§å°ã€‚å…·ä½“çš„ load command ç»“æ„å¯åœ¨ loader.h ä¸­æŸ¥çœ‹</p>
<p>åœ¨æˆ‘ä»¬çš„<code>file_b.o</code>ä¸­ï¼Œå…±æœ‰ 4 ä¸ª load commandsï¼Œåˆ†åˆ«ä¸º LC_BUILD_VERSIONã€LC_SEGMENT_64ã€LC_SYMTABã€LC_DYSYMTABï¼Œç¬¬ä¸€ä¸ªä¸å¤ªé‡è¦ï¼Œç›´æ¥å¿½ç•¥ã€‚</p>
<h3 id="lc_segment_64">LC_SEGMENT_64</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>segment_command_64</code>ï¼ŒæŒ‡å®šäº† Mach-O æ–‡ä»¶æŸä¸ªæ®µçš„ä¿¡æ¯ï¼Œæ®µæ˜¯ä¼šè¢«è½½å…¥è¿›ç¨‹ç©ºé—´çš„ï¼Œç»“æ„ä½“ä¸­åŒæ—¶è¿˜è¯´æ˜äº†è½½å…¥çš„è™šæ‹Ÿåœ°å€ä½ç½®ã€‚</p>
<p>å†æ¬¡ç¥­å‡ºè¿™å¼ å›¾<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fkk8pOAP_-UZXZta955gFg_tffP0.png" alt="" loading="lazy"><br>
Data åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª segment çš„æ•°æ®ï¼Œä¸€ä¸ª segment æœ‰ 0 ä¸ªæˆ–å¤šä¸ª sectionï¼Œæ¯ä¸ª section åŒ…å« code æˆ–è€… dataã€‚<br>
æ¯ä¸ª section éƒ½æœ‰ç¼–å·ï¼Œä» 1 å¼€å§‹ï¼Œä¸”è·¨å¤šä¸ª segmentã€‚æ¯”å¦‚ç¬¬ä¸€ä¸ª segment æœ‰ section1 section2 section3ï¼Œç¬¬äºŒä¸ª segment æœ‰ section4 section5...</p>
<p>section å¯¹åº”ç»“æ„ä½“<code>section_64</code>ï¼Œè·Ÿåœ¨<code>segment_command_64</code>ä¹‹åã€‚</p>
<pre><code class="language-c">/*
 * The 64-bit segment load command indicates that a part of this file is to be
 * mapped into a 64-bit task's address space.  If the 64-bit segment has
 * sections then section_64 structures directly follow the 64-bit segment
 * command and their size is reflected in cmdsize.
 */
struct segment_command_64 { /* for 64-bit architectures */
	uint32_t	cmd;		/* LC_SEGMENT_64 */
	uint32_t	cmdsize;	/* includes sizeof section_64 structs */
	char		segname[16];	/* segment name */
	uint64_t	vmaddr;		/* memory address of this segment */
	uint64_t	vmsize;		/* memory size of this segment */
	uint64_t	fileoff;	/* file offset of this segment */
	uint64_t	filesize;	/* amount to map from the file */
	int32_t		maxprot;	/* maximum VM protection */
	int32_t		initprot;	/* initial VM protection */
	uint32_t	nsects;		/* number of sections in segment */
	uint32_t	flags;		/* flags */
};


struct section_64 { /* for 64-bit architectures */
	char		sectname[16];	/* name of this section */
	char		segname[16];	/* segment this section goes in */
	uint64_t	addr;		/* memory address of this section */
	uint64_t	size;		/* size in bytes of this section */
	uint32_t	offset;		/* file offset of this section */
	uint32_t	align;		/* section alignment (power of 2) */
	uint32_t	reloff;		/* file offset of relocation entries */
	uint32_t	nreloc;		/* number of relocation entries */
	uint32_t	flags;		/* flags (section type and attributes)*/
	uint32_t	reserved1;	/* reserved (for offset or index) */
	uint32_t	reserved2;	/* reserved (for count or sizeof) */
	uint32_t	reserved3;	/* reserved */
};
</code></pre>
<p>segment å’Œ section éƒ½æœ‰åå­—ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œsegment ç”¨åŒä¸‹åˆ’çº¿+å¤§å†™å­—æ¯ï¼Œsection ç”¨åŒä¸‹åˆ’çº¿+å°å†™å­—æ¯ã€‚</p>
<p>å¯æ‰§è¡Œæ–‡ä»¶çš„ segment é€šå¸¸æœ‰ä»¥ä¸‹å…­ç§ç±»å‹ï¼š</p>
<ul>
<li>__PAGEZEROï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ª segmentï¼Œåœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€ä¸ºé›¶ï¼Œsize ä»£è¡¨è™šæ‹Ÿå†…å­˜ä¸­ä¸€é¡µçš„å¤§å°ã€‚</li>
<li>__TEXTï¼ŒåŒ…å«å¯æ‰§è¡Œçš„ä»£ç ã€åªè¯»æ•°æ®ã€‚å› ä¸ºä¸å¯å†™ï¼Œæ‰€ä»¥å¯ä»¥å½“åšå…±äº«å†…å­˜ï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿèƒ½è·å–ã€‚ä¾‹å¦‚è¿è¡ŒåŒä¸€ä¸ªç¨‹åºå¤šæ¬¡ã€Framework çš„ä»£ç ã€å…±äº«åº“ã€‚</li>
<li>__DATAï¼Œå¯è¯»å†™çš„æ•°æ®ã€‚å› æ­¤æ¯ä¸ªè¿›ç¨‹éƒ½è¦å•ç‹¬æ‹·è´ä¸€ä»½ Frameworkã€å…±äº«åº“çš„æ•°æ®ï¼Œæ‹·è´é‡‡ç”¨ copy-on-write ç­–ç•¥ã€‚</li>
<li>__OBJCï¼Œç”¨äºæ”¯æŒ Objective-C Runtime çš„ç›¸å…³æ•°æ®</li>
<li>__IMPORTï¼ŒåŒ…å«ä¸€äº›æœªè¢«å®šä¹‰çš„ç¬¦å·ï¼Œåªä¸º IA-32 æ¶æ„ä½¿ç”¨ï¼Œç°åœ¨å¯ä»¥å¿½ç•¥ã€‚</li>
<li>__LINKEDITï¼ŒåŒ…å«ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨ã€é‡å®šä½è¡¨ç­‰æ•°æ®ã€‚</li>
</ul>
<p>åœ¨ç”¨æˆ·æœ€ç»ˆé“¾æ¥æˆçš„ Mach-O æ–‡ä»¶ä¸­ï¼Œæœ€åä¸€ä¸ª segment ä¸º__LINKEDITã€‚</p>
<h4 id="coding-ç¯èŠ‚-3">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h4>
<pre><code class="language-c">curPtr = curPtr + sizeof(mach_header_t);
load_command_t *command;
for (int i = 0; i &lt; header-&gt;ncmds; i++, curPtr += command-&gt;cmdsize) {
    command = (load_command_t *)curPtr;
    if (command-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) {
        segment_command_t *segment_command = (segment_command_t *)command;
        printf(&quot;segment: %s \n&quot;, segment_command-&gt;segname);
        printf(&quot;sections:\n&quot;);
        section_t *sections = (section_t *)(curPtr + sizeof(segment_command_t));
        for (int j = 0; j &lt; segment_command-&gt;nsects; j++) {
            printf(&quot;%s %s \n&quot;, sections[j].segname, sections[j].sectname);
            printf(&quot;flags: 0x%x \n&quot;, sections[j].flags);
        }
        printf(&quot;\n\n&quot;);
    }
}
</code></pre>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹</p>
<pre><code>segment:
sections:
__TEXT __text
flags: 0x80000400
__DATA __data
flags: 0x0
__LD __compact_unwind__LD
flags: 0x2000000
</code></pre>
<p>æ‰“å°ä¹‹åä½ ä¼šå‘ç°ï¼Œåªæœ‰ä¸€ä¸ª segmentï¼Œè€Œä¸”è¿˜æ²¡æœ‰åå­—ã€‚è¿™æ˜¯ä¸ºäº†ä¸­é—´ç›®æ ‡æ–‡ä»¶çš„ç´§å‡‘æ€§æ•…æ„å¤„ç†çš„ï¼Œè¿™ä¸ª segment é‡Œé¢åŒ…å«äº†å„ç§å„æ ·çš„ sectionï¼Œå±äºä¸åŒ segmentï¼Œä¼šåœ¨é™æ€é“¾æ¥æ—¶æ”¾ç½®åˆ°åˆç†çš„ä½ç½®ä¸Šã€‚</p>
<p>è¿™é‡Œæœ‰ä¸‰ä¸ª sectionã€‚</p>
<ul>
<li><code>__compact_unwind__LD</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª debug ç”¨çš„ï¼Œå¯ä»¥å¿½ç•¥ã€‚</li>
<li><code>__text</code>ï¼ŒåŒ…å«å¯æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤ã€‚</li>
<li><code>__data</code>ï¼ŒåŒ…å«æœ‰åˆå§‹åŒ–å€¼çš„å˜é‡ã€‚åœ¨<code>file_b.c</code>ä¸­ï¼Œæˆ‘ä»¬åªæœ‰<code>int base = 0xfff0</code>è¿™ä¹ˆä¸ªåˆå§‹åŒ–å˜é‡ã€‚</li>
</ul>
<p>å¯ä»¥æ‰“å°å‡ºæ¥éªŒè¯</p>
<pre><code class="language-c">if (strcmp(sections[j].sectname, SECT_DATA) == 0) {
    int *value = (int *)(filePtr + sections[j].offset);
    printf(&quot;%x \n&quot;, *value);
}
</code></pre>
<h3 id="lc_symtab">LC_SYMTAB</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>symtab_command</code>ï¼Œæè¿°äº†ç¬¦å·è¡¨çš„ä½ç½®å’Œå¤§å°ã€‚æ‰€è°“çš„ç¬¦å·è¡¨ï¼Œæ˜¯ç”±<code>nlist_64</code>æ„æˆçš„ç»“æ„ä½“æ•°ç»„ã€‚</p>
<pre><code class="language-c">/*
 * The symtab_command contains the offsets and sizes of the link-edit 4.3BSD
 * &quot;stab&quot; style symbol table information as described in the header files
 * &lt;nlist.h&gt; and &lt;stab.h&gt;.
 */
struct symtab_command {
	uint32_t	cmd;		/* LC_SYMTAB */
	uint32_t	cmdsize;	/* sizeof(struct symtab_command) */
	uint32_t	symoff;		/* symbol table offset */
	uint32_t	nsyms;		/* number of symbol table entries */
	uint32_t	stroff;		/* string table offset */
	uint32_t	strsize;	/* string table size in bytes */
};

/*
 * This is the symbol table entry structure for 64-bit architectures.
 */
struct nlist_64 {
    union {
        uint32_t  n_strx; /* index into the string table */
    } n_un;
    uint8_t n_type;        /* type flag, see below */
    uint8_t n_sect;        /* section number or NO_SECT */
    uint16_t n_desc;       /* see &lt;mach-o/stab.h&gt; */
    uint64_t n_value;      /* value of this symbol (or stab offset) */
};
</code></pre>
<h4 id="coding-ç¯èŠ‚-4">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h4>
<pre><code class="language-c">if (command-&gt;cmd == LC_SYMTAB) {
    symtab_command_t *symtab_command = (symtab_command_t *)command;
    nlist_t *nlists = (nlist_t *)(filePtr + symtab_command-&gt;symoff);
    uint32_t strOffset = symtab_command-&gt;stroff;
    for (int j = 0; j &lt; symtab_command-&gt;nsyms; j++) {
        nlist_t nlist = nlists[j];
        printf(&quot;symbol: %s type:%u sect:%u desc:%u value:%llu \n&quot;, (char *)(filePtr + strOffset + nlist.n_un.n_strx), nlist.n_type, nlist.n_sect, nlist.n_desc, nlist.n_value);
    }
}
</code></pre>
<p>è¾“å‡ºç»“æœä¸­ï¼Œå¯ä»¥çœ‹åˆ°ç¬¦å·_base å’Œ_getAddress</p>
<pre><code>symbol: ltmp0 type:14 sect:1 desc:0 value:0
symbol: ltmp1 type:14 sect:2 desc:0 value:32
symbol: ltmp2 type:14 sect:3 desc:0 value:40
symbol: _base type:15 sect:2 desc:0 value:32
symbol: _getAddress type:15 sect:1 desc:0 value:0
</code></pre>
<p>æ ¹æ® value å¯ä»¥çŸ¥é“_base æ˜¯ä¸€ä¸ªå…¨å±€ç¬¦å·</p>
<pre><code class="language-c">#define	N_GSYM		0x20	/* global symbol */
</code></pre>
<h3 id="lc_dysymtab">LC_DYSYMTAB</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>dysymtab_command</code>ï¼Œæè¿°äº†ç”¨äºåŠ¨æ€é“¾æ¥éƒ¨åˆ†çš„ç¬¦å·è¡¨ã€‚</p>
<h4 id="coding-ç¯èŠ‚-5">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h4>
<pre><code class="language-c">if (command-&gt;cmd == LC_DYSYMTAB) {
    dysymtab_command_t *dysymtab_command = (dysymtab_command_t *)command;
    printf(&quot;local: %u extdef: %u undef: %u \n&quot;, dysymtab_command-&gt;nlocalsym, dysymtab_command-&gt;nextdefsym, dysymtab_command-&gt;nundefsym);
}
</code></pre>
<p>è¿™é‡Œæœ‰ä¸‰ä¸ªæœ¬åœ°ç¬¦å·ï¼Œä¸¤ä¸ªå¯¹å¤–ç¬¦å·ï¼Œç¬¦åˆé¢„æœŸ</p>
<pre><code>local: 3 extdef: 2 undef: 0
</code></pre>
<h3 id="coding-ç¯èŠ‚-6">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h3>
<p>file_b.o æˆ‘ä»¬å·²ç»æ‰’å¾—å·®ä¸å¤šäº†ï¼Œæ˜¯æ—¶å€™å†™ä¸ªæ–°çš„ä»£ç äº†ï¼Œå°±å« file_a.c</p>
<pre><code class="language-c">#include &quot;file_b.h&quot;

int printf(const char *, ...);

int main(int argc, char *argv[]) {
    int offset = 0x10;
    int address = getAddress(base, offset);
    printf(&quot;address is %x&quot;, address);
    return 0;
}
</code></pre>
<p>file_a.c éœ€è¦ç”¨åˆ° base å’Œ getAddressï¼Œæ‰€ä»¥è¦æŠŠè¿™ä¸¤ä¸ªä¿¡æ¯æä¾›å‡ºæ¥</p>
<pre><code class="language-c">extern int base;

int getAddress(int base, int offset);
</code></pre>
<p>ç„¶åç¼–è¯‘</p>
<pre><code class="language-shell">//å•ç‹¬ç¼–è¯‘ï¼Œä¸é“¾æ¥
clang -c file_a.c -o file_a.o
</code></pre>
<p>æ¥ä¸‹æ¥çš„ä»£ç è·Ÿä¹‹å‰çš„ä¸€æ ·ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹è¾“å‡º</p>
<pre><code>magic: feedfacf
cputype: 16777228
cpusubtype: 0
filetype: 1
ncmds: 4
sizeofcmds: 440
flags: 8192

segment:
sections:
__TEXT __text
flags: 0x80000400
__TEXT __cstring
flags: 0x2
__LD __compact_unwind__LD
flags: 0x2000000


symbol: ltmp0 type:14 sect:1 desc:0 value:0
symbol: l_.str type:14 sect:2 desc:0 value:108
symbol: ltmp1 type:14 sect:2 desc:0 value:108
symbol: ltmp2 type:14 sect:3 desc:0 value:128
symbol: _main type:15 sect:1 desc:0 value:0
symbol: _base type:1 sect:0 desc:0 value:0
symbol: _getAddress type:1 sect:0 desc:0 value:0
symbol: _printf type:1 sect:0 desc:0 value:0


local: 4 extdef: 1 undef: 3
</code></pre>
<p>è¿™é‡Œå¤šäº†ä¸€ä¸ªå‰é¢æ²¡æœ‰çš„ section __cstringï¼Œé‡Œé¢åŒ…å« C å­—ç¬¦ä¸²ï¼Œå³<code>&quot;address is %x&quot;</code>ï¼Œå¯ä»¥éªŒè¯ä¸‹</p>
<pre><code class="language-c">if (sections[j].flags == S_CSTRING_LITERALS) {
    printf(&quot;%s \n&quot;, (char *)(filePtr + sections[j].offset));
}
</code></pre>
<p>ç„¶åä¹Ÿæ²¡æœ‰å¤šä½™çš„å¯åˆ†æäº†ï¼ŒæŠŠä¸¤ä¸ª Mach-O é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶çœ‹çœ‹</p>
<pre><code class="language-shell">//é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶target.o
ld -lSystem -syslibroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -o target.o file_a.o file_b.o
//æ‰§è¡Œä¸€ä¸‹target.oï¼Œå¯æ­£å¸¸è¿è¡Œ
./target.o
</code></pre>
<p>é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶åï¼Œåˆå¤šäº†å¥½å‡ ä¸ª load commandsï¼Œè¿™é‡ŒåŒæ ·åªæŒ‘å‡ ä¸ªæœ‰æ„æ€çš„è®²è®²</p>
<h3 id="lc_load_dylinker">LC_LOAD_DYLINKER</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>dylinker_command</code>ï¼ŒæŒ‡ç¤ºäº†åŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„ã€‚<br>
æ¯ä¸ªåŠ¨æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶éƒ½åŒ…å«è¯¥ commandï¼Œè¯¥ command åŒ…å«æŒ‡æ˜äº†å†…æ ¸åœ¨å¯åŠ¨è¿›ç¨‹æ—¶ï¼Œä»å“ªä¸ªåœ°æ–¹å¯åŠ¨ dyldã€‚å¦‚æœè¿™ä¸ªæ–‡ä»¶å°±æ˜¯åŠ¨æ€é“¾æ¥å™¨æœ¬èº«ï¼Œåˆ™é€šè¿‡ LC_ID_DYLINKER æŒ‡æ˜ã€‚</p>
<pre><code class="language-c">if (command-&gt;cmd == LC_LOAD_DYLINKER) {
    dylinker_command_t *dylinker_command = (dylinker_command_t *)command;
    uint32_t length = dylinker_command-&gt;cmdsize - sizeof(dylinker_command_t);
    uint32_t offset = dylinker_command-&gt;name.offset;
    printf(&quot;length: %u dylinker: %s \n\n&quot;, length, (char *)(curPtr + offset));
}
</code></pre>
<p>è¾“å‡º</p>
<pre><code>length: 20 dylinker: /usr/lib/dyld
</code></pre>
<h3 id="lc_load_dylib">LC_LOAD_DYLIB</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>dylib_command</code>ï¼ŒæŒ‡ç¤ºäº†ä¾èµ–çš„åŠ¨æ€åº“ã€‚å‰é¢æè¿‡ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šæŠŠæ‰€æœ‰ä¾èµ–çš„åº“åŠ åˆ°è¿›ç¨‹ä¸­ï¼Œå¦‚æœåŠ¨æ€åº“ä¾èµ–å…¶ä»–åŠ¨æ€åº“ï¼Œåˆ™é€’å½’è¿›è¡ŒåŠ è½½ï¼Œç„¶åå†åšç¬¦å·ç»‘å®šã€‚</p>
<pre><code class="language-c">if (command-&gt;cmd == LC_LOAD_DYLIB) {
    dylib_command_t *dylib_command = (dylib_command_t *)command;
    uint32_t length = dylib_command-&gt;cmdsize - sizeof(dylib_command_t); //å¾—åˆ°dylib.nameçš„é•¿åº¦
    uint32_t offset = dylib_command-&gt;dylib.name.offset;
    printf(&quot;length:%u  dylib: %s \n\n&quot;, length, (char *)(curPtr + offset));
}
</code></pre>
<p>è¾“å‡º</p>
<pre><code>length:32  dylib: /usr/lib/libSystem.B.dylib
</code></pre>
<h3 id="lc_main">LC_MAIN</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>entry_point_command</code>ï¼Œå³ main å‡½æ•°çš„åœ°å€</p>
<h3 id="lc_data_in_code">LC_DATA_IN_CODE</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>linkedit_data_command</code>ï¼Œåœ¨ä»£ç æ®µçš„æ•°æ®ï¼Œå³åªè¯»æ•°æ®ã€‚</p>
<pre><code class="language-c">/*
 * The linkedit_data_command contains the offsets and sizes of a blob
 * of data in the __LINKEDIT segment.
 */
struct linkedit_data_command {
    uint32_t	cmd;		/* LC_CODE_SIGNATURE, LC_SEGMENT_SPLIT_INFO,
				   LC_FUNCTION_STARTS, LC_DATA_IN_CODE,
				   LC_DYLIB_CODE_SIGN_DRS,
				   LC_LINKER_OPTIMIZATION_HINT,
				   LC_DYLD_EXPORTS_TRIE, or
				   LC_DYLD_CHAINED_FIXUPS. */
    uint32_t	cmdsize;	/* sizeof(struct linkedit_data_command) */
    uint32_t	dataoff;	/* file offset of data in __LINKEDIT segment */
    uint32_t	datasize;	/* file size of data in __LINKEDIT segment  */
};
</code></pre>
<p><code>linkedit_data_command</code>ç»“æ„ä½“è¢«å¾ˆå¤š load command å…±ç”¨ã€‚</p>
<h2 id="data">Data</h2>
<p>åœ¨æœ€ç»ˆçš„ target.o ä¸­ï¼Œå¤šäº†ä¸€ä¸ª segment,<code>__DATA_CONST</code>ï¼Œé‡Œé¢æœ‰ä¸€ä¸ª section,<code>__got</code>ã€‚è¿™å…¶å®å°±æ˜¯æˆ‘ä»¬ç¬¦å·ç»‘å®šæ—¶æåˆ°çš„é—´æ¥ç¬¦å·å¼•ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œå¼•ç”¨äº† printf è¿™ä¸ªåŠ¨æ€åº“ç¬¦å·ã€‚<br>
å…³äºå¦‚ä½•åˆ¤æ–­è¿™ä¸ª section æ¯ä¸ªä½ç½®ä»£è¡¨å“ªä¸ªé—´æ¥ç¬¦å·å¼•ç”¨çš„åœ°å€ï¼Œå¯ä»¥å‚è€ƒ<a href="https://github.com/facebook/fishhook">fishhook</a>ä¸­çš„å®ç°ã€‚</p>
<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>
<p>é™¤äº†ä¸Šé¢è´´è¿‡çš„é“¾æ¥å¤–<br>
<a href="https://github.com/aidansteele/osx-abi-macho-file-format-reference">https://github.com/aidansteele/osx-abi-macho-file-format-reference</a><br>
<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/0-Introduction/introduction.html">Mach-O Programming Topics</a><br>
<a href="https://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/">Apple æ“ä½œç³»ç»Ÿå¯æ‰§è¡Œæ–‡ä»¶ Mach-O</a><br>
ã€ŠiOS åº”ç”¨å®‰å…¨ä¸é€†å‘ä¹‹é“ã€‹<br>
<a href="https://draveness.me/fishhook/">åŠ¨æ€ä¿®æ”¹ C è¯­è¨€å‡½æ•°çš„å®ç° - é¢å‘ä¿¡ä»°ç¼–ç¨‹</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä¸€ä¸ªç®€å•çš„å¤©æ°”App]]></title>
        <id>https://jayying007.github.io/post/ä¸€ä¸ªç®€å•çš„å¤©æ°”App/</id>
        <link href="https://jayying007.github.io/post/ä¸€ä¸ªç®€å•çš„å¤©æ°”App/">
        </link>
        <updated>2023-04-02T07:19:12.000Z</updated>
        <content type="html"><![CDATA[<p>è¿™ä¸¤å¤©çœ‹äº†ä¸€ä¸ª iOS å¼€å‘æ•™ç¨‹ï¼Œè™½ç„¶æ˜¯ iOS7 é‚£ä¼šçš„ï¼Œä½†è¿™ç¯‡æ•™ç¨‹éå¸¸ç»†è‡´ï¼Œå³ä½¿æ˜¯ä»Šå¤©ä¹Ÿæœ‰å¯å­¦ä¹ çš„åœ°æ–¹ã€‚å½“åšå¯¹ iOS å¼€å‘çš„å›é¡¾ä¹ŸæŒºä¸é”™çš„ã€‚<br>
<a href="https://www.kodeco.com/2579-ios-7-best-practices-a-weather-app-case-study-part-1-2">iOS 7 Best Practices; A Weather App Case Study: Part 1/2</a><br>
<a href="https://www.kodeco.com/2578-ios-7-best-practices-a-weather-app-case-study-part-2-2">iOS 7 Best Practices; A Weather App Case Study: Part 2/2</a><br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Ftby4P9z0qTiSNzdbmYuFVX4vIpA.png" alt="" loading="lazy"></p>
<p>å°±æ˜¯ä½ æ˜¯ä¸€ä¸ª iOS å°ç™½ï¼Œç›¸ä¿¡ä¹Ÿèƒ½å¾ˆå®¹æ˜“å­¦ä¼šã€‚</p>
<h3 id="çŸ¥è¯†ç‚¹">çŸ¥è¯†ç‚¹</h3>
<p>ä¸»è¦ç”¨çš„æŠ€æœ¯æœ‰ Mantleï¼ˆç±»ä¼¼ YYModelï¼‰ã€ReactiveCocoaã€‚<br>
YYModel ä¹‹å‰åˆ†æè¿‡æºç ï¼ŒMantle å€’è¿˜æ²¡ç ”ç©¶è¿‡ï¼Œï¼ˆå°è±¡é‡Œ YYModel ä½œè€…çš„æµ‹è¯•ä¸­ï¼ŒMantle çš„æ€§èƒ½æ˜¯å¾ˆå·®çš„ï¼Œä½†å¥½åœ¨ç¨³å®šï¼‰<br>
è¿™ä¸ª App å¯ä»¥å½“åš ReactiveCocoa ä½¿ç”¨çš„å…¥é—¨æ•™ç¨‹ï¼Œè™½ç„¶åªç”¨äº†å¾ˆå°‘éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä½†è¿˜æ˜¯å¯ä»¥æ„Ÿå—åˆ°å“åº”å¼ç¼–ç¨‹çš„æ€ç»´æ¨¡å¼ã€‚ï¼ˆå°±è¿™ä¸ªé¡¹ç›®ç”¨åˆ°çš„éƒ¨åˆ†åŠŸèƒ½ï¼Œä¸ªäººæ„Ÿè§‰å¦‚æœç”¨ä¹‹å‰çš„ç¼–ç¨‹æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ç”¨ KVO æˆ– Notification çš„æ–¹å¼è§£å†³ï¼Œåªæ˜¯ä»£ç ä½ç½®ç›¸å¯¹åˆ†æ•£ï¼‰</p>
<p>æœ€è¿‘ä¹Ÿæœ‰åš App å†…é€šçŸ¥ View çš„éœ€æ±‚ï¼Œæ‰€ä»¥é¡ºä¾¿å­¦ä¹ äº† TSMessage çš„æºç ã€‚</p>
<h3 id="å°é—®é¢˜">å°é—®é¢˜</h3>
<p>å½“æ—¶çš„ iPhone è¿˜æ²¡æœ‰åˆ˜æµ·ï¼Œåœ¨æˆ‘çš„ iPhone 13 Pro ä¸Šï¼ŒUI å¸ƒå±€å…¶å®æ˜¯æœ‰ bug çš„ï¼Œå½“ç„¶è¿™ä¸æ˜¯é‡ç‚¹ã€‚</p>
<p>å¦ä¸€ä¸ªå°±æ˜¯ iOS8 ä¹‹åï¼Œè¯»å–ä½ç½®éœ€è¦æˆæƒï¼Œéœ€è¦åœ¨ Info.plist é‡Œé¢è¡¥å……<br>
iOS9 ä¹‹å Https éœ€è¦é…ç½®ï¼Œåœ¨ Info.plist é‡Œé¢è¡¥å……</p>
<p>ä½œè€…ä½¿ç”¨çš„å…è´¹å¤©æ°” APIï¼Œåœ¨æˆ‘çš„å°è¯•æ—¶æ˜¯ç”¨ä¸äº†çš„ï¼Œç°åœ¨å®˜ç½‘ä¼šè¦æ±‚å¤šåŠ ä¸€ä¸ª appid çš„å‚æ•°ï¼Œç„¶è€Œå³ä½¿ä¼ äº†ï¼Œä¹Ÿæ˜¯è¿”å› 401ã€‚è¿™ä¹Ÿä¸æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥æˆ‘ç”¨äº†æœ¬åœ°æ¨¡æ‹Ÿçš„ json æ–‡ä»¶å»æ›¿ä»£ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[mmap--è¯»å†™æ–‡ä»¶çš„å¦ä¸€ç§é€‰æ‹©]]></title>
        <id>https://jayying007.github.io/post/mmap--è¯»å†™æ–‡ä»¶çš„å¦ä¸€ç§é€‰æ‹©/</id>
        <link href="https://jayying007.github.io/post/mmap--è¯»å†™æ–‡ä»¶çš„å¦ä¸€ç§é€‰æ‹©/">
        </link>
        <updated>2023-03-25T14:00:44.000Z</updated>
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2>
<p>åœ¨ç¼–å†™ C/C++ç­‰è¯­è¨€æ—¶ï¼Œå¦‚æœéœ€è¦è¯»å†™æ–‡ä»¶ï¼Œé€šå¸¸ä¼šæƒ³åˆ°ç”¨ read å’Œ write ä¸¤ä¸ªç³»ç»Ÿåº“æ¥å£ã€‚æˆ–è€…æ˜¯ freadã€fwrite ç­‰æ ‡å‡†åº“æ¥å£ã€‚</p>
<p>è¿‘æœŸåœ¨åšä¸€ä¸ªéœ€æ±‚ï¼Œä¸ºäº†é¿å…æ•°æ®ä¸¢å¤±ï¼Œæ¯æ¬¡æœ‰æ–°æ•°æ®æ—¶ï¼Œæˆ‘éƒ½ä¼šç«‹å³è°ƒç”¨ write ç›¸å…³æ¥å£å†™å…¥ç£ç›˜ã€‚å¦‚æœé¢‘ç‡å¾ˆé«˜ï¼Œå°±ä¼šé€ æˆå¤§é‡çš„ IOã€‚<br>
äºæ˜¯å¼€å§‹å¯»æ‰¾æ˜¯å¦æœ‰èƒ½é¿å…é¢‘ç¹ IOï¼ŒåŒæ—¶åˆä¿è¯æ•°æ®ä¸ä¸¢å¤±çš„æ–¹å¼ï¼Œæœ€ç»ˆå‘ç°äº† mmapã€‚</p>
<h2 id="mmap-ä»‹ç»">mmap ä»‹ç»</h2>
<p>mmap æ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå®ç°æ–‡ä»¶ç£ç›˜åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸€æ®µè™šæ‹Ÿåœ°å€çš„ä¸€ä¸€å¯¹æ˜ å…³ç³»ã€‚å®ç°è¿™æ ·çš„æ˜ å°„å…³ç³»åï¼Œè¿›ç¨‹å°±å¯ä»¥é‡‡ç”¨æŒ‡é’ˆçš„æ–¹å¼è¯»å†™æ“ä½œè¿™ä¸€æ®µå†…å­˜ï¼Œè€Œç³»ç»Ÿä¼šè‡ªåŠ¨å›å†™è„é¡µé¢åˆ°å¯¹åº”çš„æ–‡ä»¶ç£ç›˜ä¸Šï¼Œå³å®Œæˆäº†å¯¹æ–‡ä»¶çš„æ“ä½œè€Œä¸å¿…å†è°ƒç”¨ read,write ç­‰ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚ç›¸åï¼Œå†…æ ¸ç©ºé—´å¯¹è¿™æ®µåŒºåŸŸçš„ä¿®æ”¹ä¹Ÿç›´æ¥åæ˜ ç”¨æˆ·ç©ºé—´ï¼Œä»è€Œå¯ä»¥å®ç°ä¸åŒè¿›ç¨‹é—´çš„æ–‡ä»¶å…±äº«ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fg7AaBgkvED4-xohi4D7XBoG0yGv.png" alt="" loading="lazy"></p>
<p>ç›¸å…³çš„æ¥å£æœ‰ï¼šmmap()ï¼Œmunmap()ï¼Œmsync()<br>
å…·ä½“çš„ç”¨æ³•å’Œå‚æ•°ç­‰è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒæ–‡æ¡£<a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap(2) - Linux manual page</a></p>
<blockquote>
<p>è°ƒç”¨ mmap æ¥å£ï¼Œéœ€è¦ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ fdã€‚è€Œä¸€æ—¦åˆ›å»ºå®Œæˆï¼Œå°±å¯ä»¥å…³é—­æ–‡ä»¶æè¿°ç¬¦äº†ã€‚å› ä¸ºæ˜ å°„çš„æ˜¯ç£ç›˜çš„åœ°å€ï¼Œä¸æ˜¯æ–‡ä»¶æœ¬èº«ï¼Œå’Œæ–‡ä»¶å¥æŸ„æ— å…³ã€‚</p>
</blockquote>
<h2 id="mmap-å’Œå¸¸è§„æ–‡ä»¶è¯»å†™çš„åŒºåˆ«">mmap å’Œå¸¸è§„æ–‡ä»¶è¯»å†™çš„åŒºåˆ«</h2>
<h3 id="å¸¸è§„æ–‡ä»¶è¯»å†™">å¸¸è§„æ–‡ä»¶è¯»å†™</h3>
<ol>
<li>è¿›ç¨‹å‘èµ·è¯»æ–‡ä»¶è¯·æ±‚ã€‚</li>
<li>å†…æ ¸é€šè¿‡æŸ¥æ‰¾è¿›ç¨‹æ–‡ä»¶ç¬¦è¡¨ï¼Œå®šä½åˆ°å†…æ ¸å·²æ‰“å¼€æ–‡ä»¶é›†ä¸Šçš„æ–‡ä»¶ä¿¡æ¯ï¼Œä»è€Œæ‰¾åˆ°æ­¤æ–‡ä»¶çš„ inodeã€‚</li>
<li>inode åœ¨ address_space ä¸ŠæŸ¥æ‰¾è¦è¯·æ±‚çš„æ–‡ä»¶é¡µæ˜¯å¦å·²ç»ç¼“å­˜åœ¨é¡µç¼“å­˜ä¸­ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ç‰‡æ–‡ä»¶é¡µçš„å†…å®¹ã€‚</li>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™é€šè¿‡ inode å®šä½åˆ°æ–‡ä»¶ç£ç›˜åœ°å€ï¼Œå°†æ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°é¡µç¼“å­˜ã€‚ä¹‹åå†æ¬¡å‘èµ·è¯»é¡µé¢è¿‡ç¨‹ï¼Œè¿›è€Œå°†é¡µç¼“å­˜ä¸­çš„æ•°æ®å‘ç»™ç”¨æˆ·è¿›ç¨‹ã€‚</li>
</ol>
<p><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Frfys7m3-Mu6PWdlL_wY4ugQC3wa.png" alt="" loading="lazy"><br>
æ€»ç»“æ¥è¯´ï¼Œ<strong>å¸¸è§„æ–‡ä»¶æ“ä½œä¸ºäº†æé«˜è¯»å†™æ•ˆç‡å’Œä¿æŠ¤ç£ç›˜ï¼Œä½¿ç”¨äº†é¡µç¼“å­˜æœºåˆ¶ã€‚<strong>è¿™æ ·é€ æˆè¯»æ–‡ä»¶æ—¶éœ€è¦å…ˆ</strong>å°†æ–‡ä»¶é¡µä»ç£ç›˜æ‹·è´åˆ°é¡µç¼“å­˜ä¸­</strong>ï¼Œç”±äºé¡µç¼“å­˜å¤„åœ¨å†…æ ¸ç©ºé—´ï¼Œä¸èƒ½è¢«ç”¨æˆ·è¿›ç¨‹ç›´æ¥å¯»å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦<strong>å°†æ•°æ®é¡µä»é¡µç¼“å­˜ä¸­å†æ¬¡æ‹·è´åˆ°å†…å­˜å¯¹åº”çš„ç”¨æˆ·ç©ºé—´ä¸­</strong>ã€‚è¿™æ ·ï¼Œé€šè¿‡äº†ä¸¤æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œæ‰èƒ½å®Œæˆè¿›ç¨‹å¯¹æ–‡ä»¶å†…å®¹çš„è·å–ä»»åŠ¡ã€‚å†™æ“ä½œä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¾…å†™å…¥çš„ buffer åœ¨å†…æ ¸ç©ºé—´ä¸èƒ½ç›´æ¥è®¿é—®ï¼Œå¿…é¡»è¦å…ˆæ‹·è´è‡³å†…æ ¸ç©ºé—´å¯¹åº”çš„ä¸»å­˜ï¼Œå†å†™å›ç£ç›˜ä¸­ï¼ˆå»¶è¿Ÿå†™å›ï¼‰ï¼Œä¹Ÿæ˜¯éœ€è¦ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚</p>
<h3 id="mmap-è¯»å†™">mmap è¯»å†™</h3>
<ol>
<li>è¿›ç¨‹å¯åŠ¨æ˜ å°„è¿‡ç¨‹ï¼Œå¹¶åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸ºæ˜ å°„åˆ›å»ºè™šæ‹Ÿæ˜ å°„åŒºåŸŸ</li>
<li>è°ƒç”¨å†…æ ¸ç©ºé—´çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•° mmapï¼ˆä¸åŒäºç”¨æˆ·ç©ºé—´å‡½æ•°ï¼‰ï¼Œå®ç°æ–‡ä»¶ç‰©ç†åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€çš„ä¸€ä¸€æ˜ å°„å…³ç³»</li>
<li>è¿›ç¨‹å‘èµ·å¯¹è¿™ç‰‡æ˜ å°„ç©ºé—´çš„è®¿é—®ï¼Œå¼•å‘ç¼ºé¡µå¼‚å¸¸ï¼Œå®ç°æ–‡ä»¶å†…å®¹åˆ°ç‰©ç†å†…å­˜ï¼ˆä¸»å­˜ï¼‰çš„æ‹·è´</li>
</ol>
<p><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fu3iCjrI2mGAKx_9z6Xdjf6uaYLH.png" alt="" loading="lazy"><br>
**æ€»è€Œè¨€ä¹‹ï¼Œå¸¸è§„æ–‡ä»¶æ“ä½œéœ€è¦ä»ç£ç›˜åˆ°é¡µç¼“å­˜å†åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚è€Œ mmap æ“æ§æ–‡ä»¶ï¼Œåªéœ€è¦ä»ç£ç›˜åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸€æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ã€‚**è¯´ç™½äº†ï¼Œmmap çš„å…³é”®ç‚¹æ˜¯å®ç°äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®ç›´æ¥äº¤äº’è€Œçœå»äº†ç©ºé—´ä¸åŒæ•°æ®ä¸é€šçš„ç¹çè¿‡ç¨‹ã€‚å› æ­¤ mmap æ•ˆç‡æ›´é«˜ã€‚</p>
<h2 id="mmap-å›å†™æ—¶æœº">mmap å›å†™æ—¶æœº</h2>
<p>mmap æ˜¯æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´çš„ï¼Œå¦‚æœåˆš memcpy ä¸€ä»½æ•°æ®ï¼Œè¿›ç¨‹å°±æŒ‚äº†ï¼Œé‚£æ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œä»¥ä¸‹æ˜¯ Linus çš„å›å¤ï¼š<br>
{% note %}</p>
<h4 id="linus-torvalds">Linus Torvalds</h4>
<p>The mapped pages are part of the filesystem cache,which means that even if the user process that made a change to that page dies, the page is still managed by the kernel and as all concurrent accesses to that file will go through the kernel, other processes will get served from that cache. In some old Linux kernels it was different, thatâ€™s the reason why some kernel documents still tell to force msync.<br>
{% endnote %}</p>
<p>æŸ¥çœ‹ Linux å†…æ ¸ä»£ç ï¼Œå¯ä»¥å‘ç°åœ¨æ”¶åˆ°å¼‚å¸¸ä¿¡å·æ—¶ï¼Œæ˜¯ä¼šå¸®ä½ æŠŠ mmap æ•°æ®å†™ä¼šç£ç›˜çš„ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FvJ0iHeTq0mZZUqiWCdWHHDNgVM9.png" alt="" loading="lazy"></p>
<p>do_exit çš„ä»£ç åœ¨ kernel/exit.cï¼Œé‡Œé¢ä¼šè°ƒç”¨ exit_mmï¼Œexit_mm åˆè°ƒç”¨ mmput</p>
<figure data-type="image" tabindex="1"><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fqgwo9apdnqNNSnZnoHvz27gzwvj.png" alt="" loading="lazy"></figure>
<p>ä¸è¿‡æ­£å¦‚ Linus æ‰€è¯´ï¼Œéƒ¨åˆ†è€çš„ Linux å†…æ ¸å¯èƒ½è¡¨ç°ä¸åŒï¼Œæ‰€ä»¥ä¸ºäº†ç¡®ä¿æ•°æ®å›å†™ï¼Œä½ å¯ä»¥ç”¨ msync</p>
<h2 id="mmap-ä¼˜ç¼ºç‚¹">mmap ä¼˜ç¼ºç‚¹</h2>
<p>ä¸€è·¯çœ‹ä¸‹æ¥ï¼Œå¥½åƒ mmap å®Œå…¨ç¢¾å‹ read ç³»ç»Ÿæ¥å£ï¼Ÿ<br>
mmap å‡å°‘äº†æ•°æ®çš„æ‹·è´æ¬¡æ•°ï¼Œç”¨å†…å­˜è¯»å†™å–ä»£ I/O è¯»å†™ï¼Œæé«˜äº†æ–‡ä»¶è¯»å–æ•ˆç‡ã€‚<br>
mmap åœ¨éšæœºè®¿é—®åœºæ™¯ä¸‹å¾ˆæœ‰ä¼˜åŠ¿ã€‚</p>
<p>ä¸è¿‡ mmap ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼Œå› ä¸º mmap æ˜ å°„åˆ°äº†è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå…¶æœ€å°ç²’åº¦ä¸ºé¡µï¼Œæ‰€ä»¥å…¶å ç”¨å¤§å°åœ¨å†…å­˜ä¸­æ˜¯é¡µçš„æ•´æ•°å€ã€‚</p>
<blockquote>
<p>å½“æŠŠä¸€ä¸ªæ–‡ä»¶å¤§å°ä¸ä¸ºé¡µçš„å€æ•°æ˜ å°„è¿›æ¥æ—¶ï¼Œå¯ä»¥è®¿é—®æœ€åé¡µå…¶ä»–éƒ¨åˆ†ï¼Œä¸ä¼šæŠ¥é”™ã€‚ä½†æ˜¯å¯¹è¯¥åŒºåŸŸçš„ä¿®æ”¹ä¹Ÿä¸ä¼šå½±å“åŸæ–‡ä»¶ã€‚</p>
</blockquote>
<figure data-type="image" tabindex="2"><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Foa54Ba7c-2CEpQ3TmWHH0S421N0.png" alt="" loading="lazy"></figure>
<p>mmap åå†…å­˜å¤§å°å°±æ˜¯å›ºå®šçš„äº†ï¼Œå¦‚æœä¹‹åæœ‰å…¶ä»–åœ°æ–¹æ”¹å˜äº†æ–‡ä»¶çš„å¤§å°ï¼Œå°±ä¼šå‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p>
<p>å¦å¤–ï¼Œå› ä¸ºæ–‡ä»¶æ˜¯æ˜ å°„åˆ°å†…å­˜ç©ºé—´çš„ï¼Œå¦‚æœæ–‡ä»¶å¾ˆå¤§ï¼Œå°±ä¼šå ç”¨å¾ˆå¤šå†…å­˜ç©ºé—´ã€‚å³æŠŠæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜åï¼Œè¿™éƒ¨åˆ†å†…å­˜åœ°å€å°±ä¸èƒ½ç”¨åšå…¶ä»–äº†ï¼Œåªèƒ½ç”¨äºè¯¥æ–‡ä»¶è¯»å†™ã€‚è€Œä¸”è™šæ‹Ÿå†…å­˜ç©ºé—´ä¹Ÿå¾ˆéš¾æ‰¾åˆ°é‚£ä¹ˆå¤§ä¸€å—è¿ç»­çš„åœ°å€ã€‚</p>
<h2 id="è®¨è®º">è®¨è®º</h2>
<p>å…³äºä»€ä¹ˆæ—¶å€™ç”¨ readã€writeï¼Œä»€ä¹ˆæ—¶å€™ç”¨ mmapï¼ŒStackOverflow ä¸Šæœ‰å¾ˆä¸é”™çš„è®¨è®ºï¼š<br>
ä¼ é€é—¨ï¼š<a href="https://stackoverflow.com/questions/258091/when-should-i-use-mmap-for-file-access">When should I use mmap for file access?</a></p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<p><a href="https://www.jianshu.com/p/59dad2d290a1">mmap()çš„åŸç†ä¸åº”ç”¨</a><br>
<a href="http://nineright.github.io/2014/03/12/mmap-io.html">mmap ä¸ read write çš„å¯¹æ¯”</a><br>
<a href="https://www.cnblogs.com/zhujiwei/p/14726211.html">ä»€ä¹ˆæ—¶å€™é€‰æ‹© mmap è€Œé read? - ç ç‘ä½ - åšå®¢å›­</a><br>
<a href="http://wangxuemin.github.io/2015/07/24/linux%E4%B8%ADmmap%E6%96%87%E4%BB%B6%E5%88%B0%E5%86%85%E5%AD%98%E4%B8%AD%EF%BC%8C%E8%AF%A5%E8%BF%9B%E7%A8%8B%E5%8F%91%E7%94%9F%E9%94%99%E8%AF%AF%E8%A2%AB%E6%8C%82%E6%8E%89%E5%90%8Emmap%E6%98%A0%E5%B0%84%E7%9A%84%E5%86%85%E5%AD%98%E8%83%BD%E5%90%A6%E5%86%99%E5%9B%9E%E5%88%B0%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98/">linux ä¸­ mmap æ–‡ä»¶åˆ°å†…å­˜ä¸­ï¼Œè¯¥è¿›ç¨‹å‘ç”Ÿé”™è¯¯è¢«æŒ‚æ‰å mmap æ˜ å°„çš„å†…å­˜èƒ½å¦å†™å›åˆ°æ–‡ä»¶ä¸­çš„é—®é¢˜</a></p>
]]></content>
    </entry>
</feed>