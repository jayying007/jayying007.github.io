<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>è·¨å¹³å°ç½‘ç»œæ¡†æ¶marsæµ…æ | å½±å¸çš„ç½‘ç»œæ—¥å¿—</title>

<link rel="shortcut icon" href="https://jayying007.github.io/favicon.ico?v=1750777237119">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://jayying007.github.io/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages//dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-T5DQK64QPQ-G"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-T5DQK64QPQ-G');
</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
    
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            å½±å¸çš„ç½‘ç»œæ—¥å¿—
        </div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" id="changeNavbar">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    é¦–é¡µ
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    å½’æ¡£
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    æ ‡ç­¾
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/about" class="menu gt-a-link">
                    å…³äº
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1750777237119"
                action="/search/">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* ç§»åŠ¨ç«¯å¯¼èˆªæ å±•å¼€/æ”¶èµ·åˆ‡æ¢ */
    document.getElementById('changeNavbar').onclick = () => {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    è·¨å¹³å°ç½‘ç»œæ¡†æ¶marsæµ…æ
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2023-06-26 Â·
                    </time>
                    
                        <a href="https://jayying007.github.io/tag/WMOdcFhyli/" class="post-tags">
                            # Mars
                        </a>
                    
                        <a href="https://jayying007.github.io/tag/ptmLnGCxnGr/" class="post-tags">
                            # ç½‘ç»œç¼–ç¨‹
                        </a>
                    
                </div>
                <div class="post-content">
                    <p><a href="https://github.com/Tencent/mars">https://github.com/Tencent/mars</a></p>
<h2 id="mars-æ˜¯ä»€ä¹ˆ">Mars æ˜¯ä»€ä¹ˆ</h2>
<p>Mars æ˜¯å¾®ä¿¡å®˜æ–¹çš„ç»ˆç«¯åŸºç¡€ç»„ä»¶, æ˜¯ä¸€ä¸ªä¸šåŠ¡æ€§æ— å…³,å¹³å°æ€§æ— å…³ ä½¿ç”¨ C++ ç¼–å†™çš„åŸºç¡€ç»„ä»¶ã€‚<br>
å®ƒä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>Commï¼šåŸºç¡€åº“ï¼ŒåŒ…æ‹¬ socketã€çº¿ç¨‹ã€æ¶ˆæ¯é˜Ÿåˆ—ã€åç¨‹ç­‰åŸºç¡€å·¥å…·ï¼›</li>
<li>Xlogï¼šé€šç”¨æ—¥å¿—æ¨¡å—ï¼Œå……åˆ†è€ƒè™‘ç§»åŠ¨ç»ˆç«¯çš„ç‰¹ç‚¹ï¼Œæä¾›é«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€å®‰å…¨æ€§ã€å®¹é”™æ€§çš„æ—¥å¿—åŠŸèƒ½</li>
<li>SDTï¼šç½‘ç»œè¯Šæ–­æ¨¡å—ï¼›</li>
<li>STNï¼šä¿¡ä»¤ä¼ è¾“ç½‘ç»œæ¨¡å—ï¼Œè´Ÿè´£ç»ˆç«¯ä¸æœåŠ¡å™¨çš„å°æ•°æ®ä¿¡ä»¤é€šé“ã€‚åŒ…å«äº†å¾®ä¿¡ç»ˆç«¯åœ¨ç§»åŠ¨ç½‘ç»œä¸Šçš„å¤§é‡ä¼˜åŒ–ç»éªŒä¸æˆæœï¼Œç»å†äº†å¾®ä¿¡æµ·é‡ç”¨æˆ·çš„è€ƒéªŒã€‚</li>
</ol>
<figure data-type="image" tabindex="1"><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fhyysx-FjhKxqdzCMEJFhUJkBI8B.png" alt="" loading="lazy"></figure>
<blockquote>
<p>è¿™äº›ä»‹ç» Github ä¸Šéƒ½æœ‰ï¼Œæˆ‘å°±ä¸é‡å¤äº†ã€‚</p>
</blockquote>
<h3 id="ç»™çº¯å°ç™½çš„è¯´æ˜">ç»™çº¯å°ç™½çš„è¯´æ˜</h3>
<p>è¯´çœŸçš„ï¼Œå¦‚æœå¯¹ç½‘ç»œç¼–ç¨‹ä¸äº†è§£ï¼Œä¸Šé¢é‚£æ®µè¯ä¼°è®¡æ˜¯çœ‹ä¸æ˜ç™½çš„ï¼Œè¿™é‡Œå†ç®€å•è¯´æ˜ä¸€ä¸‹ã€‚<br>
ä¸€èˆ¬æ¥è¯´ï¼Œå®¢æˆ·ç«¯å’Œåå°é€šè¿‡ TCP ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FiDGKMV1hcl3Xzb0vgYyiaufhoff.png" alt="" loading="lazy"><br>
è¿™ç»„è¿æ¥é€šè¿‡ï¼ˆIP1,Socket1,IP2,Socket2ï¼‰å”¯ä¸€æ ‡è¯†ï¼Œ<br>
ä½ æƒ³ç»™åå°å‘æ¶ˆæ¯ï¼Œå°±å¾€è¿™ä¸ª Socket å†™æ•°æ®ã€‚ä½ æƒ³ä»åå°æ”¶æ¶ˆæ¯ï¼Œå°±ä»è¿™ä¸ª Socket è¯»æ•°æ®ã€‚</p>
<p>å¸¸è§çš„é€šä¿¡æ–¹å¼æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®ï¼Œåå°è¿”å›ï¼›</li>
<li>åå°ä¸»åŠ¨æ¨æ•°æ®ï¼›</li>
</ul>
<p><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FhhYotVyo-F3BIJ5hjpeQHrFBPTg.png" alt="" loading="lazy"><br>
å…¶ä¸­ï¼Œæƒ³è¦è®©åå°åœ¨éœ€è¦çš„æ—¶å€™å‘æ¶ˆæ¯ç»™ä½ ï¼Œå°±å¾—ä¿æŒ Socket ä¸€ç›´è¿æ¥ç€ï¼Œå³æ‰€è°“çš„é•¿è¿æ¥ã€‚è€Œå‰é¢é‚£ç§ä¸€æ¥ä¸€å›çš„ï¼Œå°±æ— æ‰€è°“çŸ­è¿æ¥è¿˜æ˜¯é•¿è¿æ¥äº†ã€‚</p>
<blockquote>
<p>å…¶å®è¿˜æœ‰å®¢æˆ·ç«¯ç»™åå°å‘é€šçŸ¥çš„åœºæ™¯ï¼Œåªä¸è¿‡è¿™ç§æ¯”è¾ƒå°‘è§ã€‚<br>
ä¾‹å¦‚å¾®ä¿¡é‡Œé¢çš„ã€Œå¯¹æ–¹æ­£åœ¨è¾“å…¥ã€ï¼Œå°±æ˜¯ç”¨è¿™ç§èƒ½åŠ›å®ç°çš„ã€‚</p>
</blockquote>
<p>ç½‘ç»œä¸Šä¼ è¾“çš„åªæ˜¯å•çº¯çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå…·ä½“ä»£è¡¨ä»€ä¹ˆå«ä¹‰å°±çœ‹å®¢æˆ·ç«¯è·Ÿåå°åå•†çš„ç»“æœäº†ã€‚å°±åƒ TCP åè®®å»ºç«‹åœ¨ IP åè®®çš„åŸºç¡€ä¹‹ä¸Šï¼Œå®¢æˆ·ç«¯å’Œåå°é—´çš„åè®®å»ºç«‹åœ¨ TCP åè®®ä¹‹ä¸Šï¼Œè¿™ä¸ªå­¦è¿‡è®¡ç®—æœºç½‘ç»œçš„éƒ½æ‡‚ã€‚</p>
<p>socket ç¼–ç¨‹å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨æ¥å£å¦‚ä¸‹<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FqjBttbkDx0-tt7TbICebMVCywHq.png" alt="" loading="lazy"></p>
<p>åˆ°è¿™é‡Œï¼Œæ€»ç®—å¯ä»¥çŸ¥é“ Mars æ˜¯ä»€ä¹ˆäº†ã€‚ç®€å•è¯´ï¼ŒMars å°±æ˜¯å¯¹ä¸Šé¢ Socket å»ºç«‹çš„å°è£…ï¼Œç”±å®ƒè´Ÿè´£å»ºç«‹è·Ÿåå°çš„è¿æ¥ä»¥åŠæ•°æ®è¯»å†™ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fl927kybOs6pEyV318Rp0G8h8WMU.png" alt="" loading="lazy"></p>
<h2 id="å…³äºå®˜æ–¹-demo">å…³äºå®˜æ–¹ Demo</h2>
<p>æ¯•ç«Ÿæ˜¯å¾®ä¿¡æ¨å‡ºçš„ï¼Œæä¾›çš„ demo æ˜¯åŸºäºèŠå¤©åœºæ™¯è®¾è®¡çš„ã€‚<br>
å…³äº IM ç³»ç»Ÿï¼Œç›¸ä¿¡å¤§éƒ¨åˆ†äººåœ¨ä¸Šå¤§å­¦æ—¶éƒ½åšè¿‡ç©å…·é¡¹ç›®äº†ã€‚<br>
æ¯”å¦‚æˆ‘çš„ï¼š<a href="https://github.com/jayying007/chatting-room">https://github.com/jayying007/chatting-room</a></p>
<p>è¿™é‡Œè¦åæ§½ä¸€ç‚¹æ˜¯ï¼ŒGithub ä¸Šçš„ demo åŸºæœ¬æ˜¯è¿è¡Œä¸èµ·æ¥çš„ï¼Œæˆ‘ç»å†äº†ä¹ä¹å…«åä¸€éš¾æ‰æå®šã€‚<br>
Server ç«¯å’Œ iOS ç«¯éƒ½æœ‰é—®é¢˜ï¼š<br>
Server ç«¯çš„ä¸»è¦é—®é¢˜æ˜¯ Gradle ç‰ˆæœ¬æ¯”è¾ƒè€ï¼Œæˆ‘æœ¬åœ°çš„ JDK ç‰ˆæœ¬æ¯”è¾ƒæ–°ï¼Œè¿™é‡Œé€šè¿‡é™ä½åˆ° JDK8 è§£å†³ï¼›<br>
iOS ç«¯ä¸»è¦é—®é¢˜æ˜¯æ–°æ—§ç‰ˆæœ¬ç¬¦å·æœ‰æ‰€å˜æ›´ï¼Œè¿™ä¸ªæ ¹æ®æŠ¥é”™ä¿¡æ¯é€æ­¥ä¿®æ”¹è§£å†³ã€‚<br>
è§£å†³çš„è¿‡ç¨‹å› æœºå™¨è€Œå¼‚ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿä¸æ‰“ç®—è¯´æ˜ï¼Œåº”è¯¥æ²¡æœ‰äººä¸ä¼š Google å§ï¼Ÿ</p>
<h2 id="ios-demo-åˆ†æ">iOS Demo åˆ†æ</h2>
<p>æ ¸å¿ƒç»“æ„å¦‚ä¸‹ï¼š<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FktXpXlVXPYxrm7LZrVLNJyhJcHQ.png" alt="" loading="lazy"></p>
<p>å…¶ä¸­ï¼ŒNetworkService è´Ÿè´£è®¾ç½®å¯åŠ¨ marsï¼Œå¹¶æ¥å— mars å›è°ƒçš„æ•°æ®ï¼Œä¼ é€’ç»™ä¸Šå±‚ NetworkEventã€‚</p>
<pre><code class="language-objectivec">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {

    [NetworkService sharedInstance].delegate = [[NetworkEvent alloc] init];
    [[NetworkService sharedInstance] setCallBack];
    [[NetworkService sharedInstance] createMars];
    [[NetworkService sharedInstance] setClientVersion:200];
    [[NetworkService sharedInstance] setLongLinkAddress:@&quot;192.168.1.101&quot; port:8081];
    [[NetworkService sharedInstance] setShortLinkPort:8080];
    [[NetworkService sharedInstance] reportEvent_OnForeground:YES];
    [[NetworkService sharedInstance] makesureLongLinkConnect];

    [[NetworkStatus sharedInstance] Start:[NetworkService sharedInstance]];

    return YES;
}
</code></pre>
<h3 id="ä¸€æ¬¡è¯·æ±‚çš„è¿‡ç¨‹">ä¸€æ¬¡è¯·æ±‚çš„è¿‡ç¨‹</h3>
<p>ä»¥ PingServerController ä¸­çš„ä»£ç ä¸ºä¾‹ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FiMp7oM8ynpTtNNeQNRvsNCboyqS.png" alt="" loading="lazy"></p>
<p>ç‚¹å‡» Click æ—¶ï¼Œå®¢æˆ·ç«¯åˆ›å»ºäº†ä¸€ä¸ª CGITaskï¼Œä¼ é€’ç»™ NetworkServiceï¼Œå¹¶æŠŠè‡ªå·±ä½œä¸ºç›‘å¬è€…ã€‚</p>
<pre><code class="language-objectivec">- (IBAction)onButtonClick:(id)sender forEvent:(UIEvent *)event {
    CGITask *helloCGI = [[CGITask alloc] initAll:ChannelType_All AndCmdId:kSayHello AndCGIUri:@&quot;/mars/hello&quot; AndHost:@&quot;192.168.1.101&quot;];
    [[NetworkService sharedInstance] startTask:helloCGI ForUI:self];
}
</code></pre>
<p>è¿™ä¸ª CGITask åªæ˜¯å®¢æˆ·ç«¯å¯¹æ•°æ®çš„å°è£…ï¼Œåœ¨ NetworkService å±‚ä¼šè§£æä¸º mars çš„ä¸€ä¸ª Taskï¼Œç„¶åå¯åŠ¨è¿™ä¸ª Taskã€‚<br>
æ¯æ¬¡åˆ›å»º Task éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ taskidï¼Œä¹‹åå°†è¿™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯æ³¨å†Œåˆ° NetworkEvent ä¸­ã€‚</p>
<pre><code class="language-objectivec">- (int)startTask:(CGITask *)task ForUI:(id&lt;UINotifyDelegate&gt;)delegateUI {
    Task ctask;
    ctask.cmdid = task.cmdid;
    ctask.channel_select = task.channel_select;
    ctask.cgi = std::string(task.cgi.UTF8String);
    ctask.shortlink_host_list.push_back(std::string(task.host.UTF8String));
    ctask.user_context = (__bridge void*)task;

    NSString *taskIdKey = [NSString stringWithFormat:@&quot;%d&quot;, ctask.taskid];
    [_delegate addObserver:delegateUI forKey:taskIdKey];
    [_delegate addCGITasks:task forKey:taskIdKey];

    mars::stn::StartTask(ctask);

    return ctask.taskid;
}
</code></pre>
<p>æ¥ä¸‹æ¥ Task å¯åŠ¨ï¼Œè¦çœŸæ­£å‘é€æ•°æ®äº†ï¼Œmars é€šè¿‡ callback æ¥ç´¢å–æ•°æ®</p>
<pre><code class="language-objectivec">// StnCallBack
bool StnCallBack::Req2Buf(uint32_t _taskid, void* const _user_context, const std::string&amp; _user_id, AutoBuffer&amp; _outbuffer, AutoBuffer&amp; _extend, int&amp; _error_code, const int _channel_select, const std::string&amp; host) {
    NSData* requestData =  [[NetworkService sharedInstance] Request2BufferWithTaskID:_taskid userContext:_user_context];
    if (requestData == nil) {
        requestData = [[NSData alloc] init];
    }
    _outbuffer.AllocWrite(requestData.length);
    _outbuffer.Write(requestData.bytes,requestData.length);
    return requestData.length &gt; 0;
}
// NetworkService
- (NSData*)Request2BufferWithTaskID:(uint32_t)tid userContext:(const void *)context {
    CGITask *task = (__bridge CGITask *)context;
    return [_delegate Request2BufferWithTaskID:tid task:task];
}
// NetworkEvent
- (NSData*)Request2BufferWithTaskID:(uint32_t)tid task:(CGITask *)task {
    NSData* data = NULL;

    NSString *taskIdKey = [NSString stringWithFormat:@&quot;%d&quot;, tid];

    id&lt;UINotifyDelegate&gt; uiObserver = [controllers objectForKey:taskIdKey];
    if (uiObserver != nil) {
        data = [uiObserver requestSendData];
    }

    return data;
}
// PingServerController
- (NSData*)requestSendData {
    HelloRequest *helloRequest = [HelloRequest new];
    helloRequest.user = [self username];
    helloRequest.text = @&quot;Hello world&quot;;
    NSData *data = [helloRequest data];
    return data;
}
</code></pre>
<p>ç»è¿‡å±‚å±‚ä¼ é€’ï¼Œæœ€åæ¥åˆ°äº† PingServerControllerï¼Œå¾—åˆ°ä¸€ä¸ª HelloRequest çš„åºåˆ—åŒ–æ•°æ®ã€‚è¿™é‡Œçš„ä¸šåŠ¡å±‚æ•°æ®æ˜¯ä¸€ä¸ª protobuf å¯¹è±¡ï¼Œä¹Ÿæ˜¯ç½‘ç»œç¼–ç¨‹å¸¸ç”¨çš„åºåˆ—åŒ–æ–¹å¼ï¼Œå…³äº protobuf çš„ä»‹ç»å¯ä»¥çœ‹ä»¥å‰å†™çš„åšå®¢ã€‚</p>
<p>å› ä¸ºè¿™æ˜¯ä¸ªæœ‰æ¥æœ‰å›çš„è¯·æ±‚ï¼Œæ‰€ä»¥åå°è¿˜ä¼šå›æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œä¹Ÿæ˜¯ mars é€šè¿‡ callback æ¥è¿”å›æ•°æ®ã€‚</p>
<pre><code class="language-objectivec">// StnCallBack
int StnCallBack::Buf2Resp(uint32_t _taskid, void* const _user_context, const std::string&amp; _user_id, const AutoBuffer&amp; _inbuffer, const AutoBuffer&amp; _extend, int&amp; _error_code, const int _channel_select) {
    int handle_type = mars::stn::kTaskFailHandleNormal;
    NSData* responseData = [NSData dataWithBytes:(const void *) _inbuffer.Ptr() length:_inbuffer.Length()];
    NSInteger errorCode = [[NetworkService sharedInstance] Buffer2ResponseWithTaskID:_taskid ResponseData:responseData userContext:_user_context];

    if (errorCode != 0) {
        handle_type = mars::stn::kTaskFailHandleDefault;
    }
    return handle_type;
}
// NetworkService
- (NSInteger)Buffer2ResponseWithTaskID:(uint32_t)tid ResponseData:(NSData *)data userContext:(const void *)context {
    CGITask *task = (__bridge CGITask *)context;
    return [_delegate Buffer2ResponseWithTaskID:tid responseData:data task:task];
}
// NetworkEvent
- (NSInteger)Buffer2ResponseWithTaskID:(uint32_t)tid responseData:(NSData *)data task:(CGITask *)task {
    int returnType = 0;

    NSString *taskIdKey = [NSString stringWithFormat:@&quot;%d&quot;, tid];

    id&lt;UINotifyDelegate&gt; uiObserver = [controllers objectForKey:taskIdKey];
    if (uiObserver != nil) {
        returnType = [uiObserver onPostDecode:data];
    } else {
        returnType = -1;
    }

    return returnType;
}
// PingServerController
- (int)onPostDecode:(NSData*)responseData {
    helloResponse = [HelloResponse parseFromData:responseData error:nil];
    if ([helloResponse hasErrmsg]) {
        dispatch_async(dispatch_get_main_queue(), ^{
            UIAlertController *alert = [UIAlertController alertControllerWithTitle:nil message:helloResponse.errmsg preferredStyle:UIAlertControllerStyleAlert];
            [alert addAction:[UIAlertAction actionWithTitle:@&quot;OK&quot; style:UIAlertActionStyleDefault handler:nil]];
            [self presentViewController:alert animated:YES completion:nil];
        });
        LOG_INFO(kModuleViewController, @&quot;recv hello response: %@&quot;, helloResponse.errmsg);
    }

    return helloResponse.retcode == 0 ? 0 : -1;
}
</code></pre>
<h3 id="ä¸€æ¬¡-push-çš„è¿‡ç¨‹">ä¸€æ¬¡ Push çš„è¿‡ç¨‹</h3>
<p>ä¸ºäº†æµ‹è¯•è¿™ä¸ªè¿‡ç¨‹ï¼Œéœ€è¦å‡†å¤‡ä¸¤å°æ‰‹æœºã€‚è¿™é‡Œä»¥ TopicViewController ä¸­çš„ä»£ç ä¸ºä¾‹ã€‚<br>
é¦–å…ˆä¸€å°æ‰‹æœºå‘é€æ¶ˆæ¯ï¼Œè¿‡ç¨‹å’Œä¸Šé¢çš„ç±»ä¼¼ï¼Œä¼šæœ‰ request å’Œ responseã€‚</p>
<pre><code class="language-objectivec">// requestæ—¶è°ƒç”¨
- (NSData*)requestSendData {
    SendMessageRequest *sendMsgRequest = [SendMessageRequest new];
    sendMsgRequest.from = [self username];
    sendMsgRequest.to = @&quot;all&quot;;
    sendMsgRequest.text = _textField.text;
    sendMsgRequest.accessToken = @&quot;123456&quot;;
    sendMsgRequest.topic = _conversation.topic;
    LOG_INFO(kModuleViewController, @&quot;send msg to topic:%@&quot;, _conversation.notice);
    NSData* data = [sendMsgRequest data];
    dispatch_async(dispatch_get_main_queue(), ^{
        _textField.text = @&quot;&quot;;
    });
    return data;
}
// responseæ—¶è°ƒç”¨
- (int)onPostDecode:(NSData*)responseData {
    SendMessageResponse *sendMsgResponse = [SendMessageResponse parseFromData:responseData error:nil];
    dispatch_async(dispatch_get_main_queue(), ^{
        NSString *recvtext = [NSString stringWithFormat:@&quot;%@ : %@&quot;, sendMsgResponse.from, sendMsgResponse.text];
        [self.messages addObject:recvtext];
        [self.tableView reloadData];
        NSIndexPath *indexPath = [NSIndexPath indexPathForRow:self.messages.count-1 inSection:0];
        [self.tableView scrollToRowAtIndexPath:indexPath atScrollPosition:UITableViewScrollPositionBottom animated:YES];
    });
    return sendMsgResponse.errCode == 0 ? 0 : -1;
}
</code></pre>
<p>åœ¨è¿›å…¥ TopicViewController æ—¶ï¼Œæ³¨å†Œäº† PushObserver</p>
<pre><code class="language-objectivec">- (void)viewDidLoad {
    [super viewDidLoad];
	// ç•¥...
    [[NetworkService sharedInstance] addPushObserver:self withCmdId:kPushMessageCmdId];
}
</code></pre>
<p>è¿™æ ·å½“åå° Push æ•°æ®æ—¶ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”çš„å¤„ç†è€…ã€‚è¿™æ ·å¦ä¸€å°æ‰‹æœºå°±èƒ½æ”¶åˆ°æ¶ˆæ¯äº†ã€‚</p>
<pre><code class="language-objectivec">// StnCallBack
void StnCallBack::OnPush(const std::string&amp; _channel_id, uint32_t _cmdid, uint32_t _taskid, const AutoBuffer&amp; _body, const AutoBuffer&amp; _extend) {
    if (_body.Length() &gt; 0) {
        NSData* recvData = [NSData dataWithBytes:(const void *) _body.Ptr() length:_body.Length()];
        [[NetworkService sharedInstance] OnPushWithCmd:_cmdid data:recvData];
    }
}
// NetworkService
- (void)OnPushWithCmd:(NSInteger)cid data:(NSData *)data {
    return [_delegate OnPushWithCmd:cid data:data];
}
// NetworkEvent
- (void)OnPushWithCmd:(NSInteger)cid data:(NSData *)data {
    id&lt;PushNotifyDelegate&gt; pushObserver = [pushrecvers objectForKey:[NSString stringWithFormat:@&quot;%d&quot;, cid]];
    if (pushObserver != nil) {
        [pushObserver notifyPushMessage:data withCmdId:cid];
    }
}
// TopicViewController
- (void)notifyPushMessage:(NSData*)pushData withCmdId:(int)cmdId {
    MessagePush* messagePush = [MessagePush parseFromData:pushData error:nil];
    if (messagePush != nil) {
        dispatch_async(dispatch_get_main_queue(), ^{
            NSString *recvtext = [NSString stringWithFormat:@&quot;%@ : %@&quot;, messagePush.from, messagePush.content];
            [self.messages addObject:recvtext];
            [self.tableView reloadData];
            NSIndexPath *indexPath = [NSIndexPath indexPathForRow:self.messages.count-1 inSection:0];
            [self.tableView scrollToRowAtIndexPath:indexPath atScrollPosition:UITableViewScrollPositionBottom animated:YES];
        });
    }
}
</code></pre>
<p>ç”»æˆå›¾å¤§æ¦‚é•¿è¿™æ ·ï¼š<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FtRSj6-8QkS9QFzBs7CYSRH9l5YO.png" alt="" loading="lazy"></p>
<h2 id="å†™åˆ°æœ€å">å†™åˆ°æœ€å</h2>
<p>è¿™é‡Œè¦æä¸ªé†’ï¼Œå¦‚æœä½ ä»¥ä¸ºç½‘ç»œä¸Šä¼ è¾“çš„å°±æ˜¯çº¯ HelloRequestã€HelloResponseã€MessagePush è¿™æ ·çš„æ•°æ®ï¼Œé‚£è¯´æ˜ä½ è¿˜æ²¡å®Œå…¨ç†è§£ã€‚<br>
æ¯•ç«Ÿè¿™é‡Œè¿˜æœ‰ä¸ªç–‘é—®ï¼Œæ€ä¹ˆåŒºåˆ†åå°è¿”å›çš„æ•°æ®æ˜¯ HelloResponse è¿˜æ˜¯ MessagePushğŸ¤”ã€‚</p>
<p>å›æƒ³å‰é¢åˆ›å»º CGITask çš„è¿‡ç¨‹ï¼Œå…¶å®è¿˜æœ‰ cmdid è¿™ä¸ªä¸œè¥¿ã€‚</p>
<pre><code class="language-objectivec">- (IBAction)onButtonClick:(id)sender forEvent:(UIEvent *)event {
    CGITask *helloCGI = [[CGITask alloc] initAll:ChannelType_All AndCmdId:kSayHello AndCGIUri:@&quot;/mars/hello&quot; AndHost:@&quot;192.168.1.101&quot;];
    [[NetworkService sharedInstance] startTask:helloCGI ForUI:self];
}
</code></pre>
<p>è¿™æ ·ï¼Œå®¢æˆ·ç«¯åœ¨è¯·æ±‚æ—¶æŠŠè¿™ä¸ª cmdid ä¹Ÿå¸¦ä¸Šï¼Œåå°å°±çŸ¥é“å®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯ä»€ä¹ˆå†…å®¹ã€‚<br>
åå°è¿”å›æ—¶æŠŠ cmdid å¸¦ä¸Šï¼Œå®¢æˆ·ç«¯å°±çŸ¥é“åå°è¿”å›çš„æ˜¯ä»€ä¹ˆå†…å®¹ã€‚<br>
åœ¨ Demo ä¸­ï¼Œå®¢æˆ·ç«¯å’Œåå°ä¹‹é—´çš„ä¼ è¾“åè®®å¦‚ä¸‹ï¼š<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fjf92KFNF4RKejLQe3RcksxEdxSr.png" alt="" loading="lazy"></p>
<p>å®¢æˆ·ç«¯è¿™éƒ¨åˆ†ä»£ç åœ¨ longlink_packer.cc ä¸­</p>
<pre><code class="language-objectivec">void (*longlink_pack)(uint32_t _cmdid, uint32_t _seq, const AutoBuffer&amp; _body, const AutoBuffer&amp; _extension, AutoBuffer&amp; _packed, longlink_tracker* _tracker)
    = [](uint32_t _cmdid, uint32_t _seq, const AutoBuffer&amp; _body, const AutoBuffer&amp; _extension, AutoBuffer&amp; _packed, longlink_tracker* _tracker) {
    __STNetMsgXpHeader st = {0};
    st.head_length = htonl(sizeof(__STNetMsgXpHeader));
    st.client_version = htonl(sg_client_version);
    st.cmdid = htonl(_cmdid);
    st.seq = htonl(_seq);
    st.body_length = htonl(_body.Length());

    _packed.AllocWrite(sizeof(__STNetMsgXpHeader) + _body.Length());
    _packed.Write(&amp;st, sizeof(st));

    if (NULL != _body.Ptr()) _packed.Write(_body.Ptr(), _body.Length());

    _packed.Seek(0, AutoBuffer::ESeekStart);
};
</code></pre>
<p>æœåŠ¡å™¨è¿™éƒ¨åˆ†ä»£ç åœ¨ NetMsgHeader.java ä¸­</p>
<pre><code class="language-java">public byte[] encode() throws InvalidHeaderException {
    if (body == null &amp;&amp; cmdId != CMDID_NOOPING &amp;&amp; cmdId != CMDID_NOOPING_RESP) {
        throw new InvalidHeaderException(&quot;invalid header body&quot;);
    }

    final int headerLength = FIXED_HEADER_SKIP + (options == null ? 0 : options.length);
    final int bodyLength = (body == null ? 0 : body.length);
    final int packLength = headerLength + bodyLength;
    final ByteArrayOutputStream baos = new ByteArrayOutputStream(packLength);

    try {
        final DataOutputStream dos = new DataOutputStream(baos);

        dos.writeInt(headerLength);
        dos.writeInt(CLIENTVERSION);
        dos.writeInt(cmdId);
        dos.writeInt(seq);
        dos.writeInt(bodyLength);

        if (options != null) {
            dos.write(options);
        }

        if (body != null) {
            dos.write(body);
        }

    } catch (IOException e) {
        e.printStackTrace();

    } finally {
        try {
            baos.close();

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    return baos.toByteArray();
}
</code></pre>
<p>æœ€åçš„æœ€åï¼Œæˆ‘è¿˜è¦æ’ä¸€å¥ã€‚è¿™ä¸ªåè®®æ˜¯å®¢æˆ·ç«¯è·Ÿåå°åå•†çš„ï¼Œæ¯ä¸ªä¸šåŠ¡å®šçš„éƒ½ä¸ä¸€æ ·ï¼Œå¾®ä¿¡ä¹Ÿä¸æ˜¯è¿™æ ·æçš„ã€‚å…·ä½“æ€ä¹ˆå®šä¹‰å–å†³äºè‡ªèº«ä¸šåŠ¡ï¼Œæ›´å¥½çš„è®¾è®¡æ˜¯å‡å°‘ä¼ è¾“æ•°æ®å¤§å°ï¼Œåˆèƒ½æœ‰æ‰©å±•æ€§ï¼Œæ›´å®‰å…¨ã€‚</p>
<h2 id="å…¶ä»–">å…¶ä»–</h2>
<p>å¦‚æœä½ å¯¹ mars çš„æºç æœ‰å…´è¶£ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„åšå®¢<br>
<a href="https://tbfungeek.github.io/2019/12/05/Tencent-Mars-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Tencent Mars æºç è§£æ</a></p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="https://jayying007.github.io/post/[è½¬] æ¸¸æˆä¸­çš„AI-è¡Œä¸ºæ ‘/" class="post-title gt-a-link">
                    [è½¬] æ¸¸æˆä¸­çš„AI-è¡Œä¸ºæ ‘
                </a>
            </div>
        

        

        

        
            <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: 'JHsf6kk7u31nFtmMMtWqQyHl-gzGzoHsz',
		appKey: '6kuh7BaduW3qYuq5MUi7KaTm',
		avatar: '',
		pageSize: 5,
		recordIp: true,
		placeholder: 'Just Go Go',
		visitor: false,
	});
</script>

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"></div>
    <div class="social-container">
        
            
                <a href="https://github.com/jayying007" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        
    </div>
    <div>
        Theme <a href="https://github.com/imhanjie/gridea-theme-pure" target="_blank">Pure</a>, Powered by <a
                href="https://gridea.dev" target="_blank">Gridea</a> | <a href="https://jayying007.github.io/atom.xml" target="_blank">RSS</a>
    </div>
</div>

<script>
  hljs.highlightAll()
</script>

    </div>
</div>
</body>
</html>
