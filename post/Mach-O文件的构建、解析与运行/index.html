<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Mach-Oæ–‡ä»¶çš„æ„å»ºã€è§£æä¸è¿è¡Œ | å½±å¸çš„ç½‘ç»œæ—¥å¿—</title>

<link rel="shortcut icon" href="https://jayying007.github.io/favicon.ico?v=1750777237119">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://jayying007.github.io/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages//dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-T5DQK64QPQ-G"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-T5DQK64QPQ-G');
</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
    
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            å½±å¸çš„ç½‘ç»œæ—¥å¿—
        </div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" id="changeNavbar">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    é¦–é¡µ
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    å½’æ¡£
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    æ ‡ç­¾
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/about" class="menu gt-a-link">
                    å…³äº
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1750777237119"
                action="/search/">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* ç§»åŠ¨ç«¯å¯¼èˆªæ å±•å¼€/æ”¶èµ·åˆ‡æ¢ */
    document.getElementById('changeNavbar').onclick = () => {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    Mach-Oæ–‡ä»¶çš„æ„å»ºã€è§£æä¸è¿è¡Œ
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2023-04-09 Â·
                    </time>
                    
                        <a href="https://jayying007.github.io/tag/9geQNEqiroK/" class="post-tags">
                            # Mach-O
                        </a>
                    
                        <a href="https://jayying007.github.io/tag/Uii3Mk5puEf/" class="post-tags">
                            # dyld
                        </a>
                    
                        <a href="https://jayying007.github.io/tag/8Q9GjgvwlhA/" class="post-tags">
                            # é“¾æ¥
                        </a>
                    
                </div>
                <div class="post-content">
                    <blockquote>
<p>çœæµï¼šå¦‚æœä½ è¿˜æ²¡æœ‰çœ‹è¿‡ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹ï¼Œé‚£å»ºè®®è¿˜æ˜¯å…ˆå»çœ‹å®Œè¿™æœ¬ä¹¦å§ã€‚</p>
</blockquote>
<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>ç±»ä¼¼äº Window çš„ PE æ–‡ä»¶ã€Linux çš„ ELF æ–‡ä»¶ï¼ŒOS X ä¸Šæ‰€æœ‰çš„ Appã€Frameworkã€Libiaryã€Command-Line Tool éƒ½å¯ä»¥ç§°ä¸º Mach-O æ–‡ä»¶ã€‚<br>
å¯¹è¿™äº› Mach-O æ–‡ä»¶çš„è¿›ä¸€æ­¥æè¿°ï¼Œå¯ä»¥å‚è€ƒ<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/1-Articles/building_files.html#//apple_ref/doc/uid/TP40001828-97030">The Productsâ€”Types of Mach-O Files You Can Build</a></p>
<p>ä¸€ä¸ª Mach-O æ–‡ä»¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šHeaderã€Load Commandsã€Dataã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fkk8pOAP_-UZXZta955gFg_tffP0.png" alt="" loading="lazy"><br>
Headerï¼šåŒ…å«è¯¥æ–‡ä»¶çš„ç›®æ ‡æ¶æ„ç­‰ä¿¡æ¯ï¼›<br>
Load Commandsï¼šæè¿°äº†è¯¥æ–‡ä»¶çš„åŸºæœ¬ç»“æ„ï¼ˆæ¯”å¦‚ç¬¦å·è¡¨åœ¨å“ªä¸ªåœ°æ–¹ï¼ŒSegment è¦åŠ åˆ°è™šæ‹Ÿå†…å­˜åœ°å€çš„å“ªä¸ªåœ°æ–¹ï¼‰ï¼›<br>
Dataï¼šè£¸çš„æ•°æ®ï¼Œå…·ä½“æ¯ä¸ª Byte ä»£è¡¨å•¥å°±çœ‹ Load Commands ä¸­çš„å®šä¹‰äº†ã€‚</p>
<p>ä¸€ä¸ª Mach-O åªåŒ…å«ä¸€ç§æ¶æ„çš„ä»£ç å’Œæ•°æ®ï¼ŒåŒ…å«å¤šä¸ªçš„è¢«ç§°ä¸º universal binaryã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ–‡ä»¶å¼€å¤´ä¸ºä¸€ä¸ª<code>fat_header</code>ç»“æ„ä½“ï¼Œè·Ÿéšä¸€ä¸ª<code>fat_arch</code>ç»“æ„ä½“æ•°ç»„ï¼Œæ ¹æ®è¿™ä¸ª<code>fat_arch</code>çš„ä¿¡æ¯ï¼Œå°±èƒ½å¿«é€Ÿæ‰¾åˆ°é€‚åˆå½“å‰æœºå™¨æ‰§è¡Œçš„ä»£ç å’Œæ•°æ®çš„ä½ç½®ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FqtXecpFB_uJTRut3aLKSlmRSXwM.png" alt="" loading="lazy"></p>
<h1 id="ç¨‹åºè¿è¡Œè¿‡ç¨‹æµ…æ">ç¨‹åºè¿è¡Œè¿‡ç¨‹æµ…æ</h1>
<p>Mach-O æ–‡ä»¶æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ç±»å‹ï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹é€šè¿‡å‘½ä»¤è¡Œæˆ–åŒå‡»å¯åŠ¨ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ã€‚<br>
å†è¯´ä¸€æ¬¡ï¼Œæƒ³è·å–è¿™éƒ¨åˆ†æ›´å®Œæ•´çš„çŸ¥è¯†ï¼Œå»çœ‹ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹ã€‚</p>
<p>å½“è¿è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼Œå†…æ ¸ä¸ºè¯¥ç¨‹åºåˆ›å»ºå¯¹åº”çš„è¿›ç¨‹ï¼Œå¹¶å°†å…¶è½½å…¥è¿›ç¨‹ç©ºé—´ä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠåŠ¨æ€é“¾æ¥å™¨ï¼ˆé€šå¸¸æ˜¯/usr/lib/dyldï¼‰è½½å…¥è¿›ç¨‹ç©ºé—´ä¸­ã€‚éšåæŠŠæ§åˆ¶å™¨äº¤ç»™åŠ¨æ€é“¾æ¥å™¨ï¼Œå³è·³è½¬åˆ°åŠ¨æ€é“¾æ¥å™¨æŒ‡å®šçš„å…¥å£åœ°å€ã€‚<br>
è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œ<code>fork</code>å’Œ<code>execve</code>ã€‚<code>fork</code>åˆ›å»ºäº†è¿›ç¨‹ï¼Œ<code>execve</code>å°†ç¨‹åºè½½å…¥è¿›ç¨‹ç©ºé—´å¹¶æ‰§è¡Œã€‚è½½å…¥çš„ Mach-O æ–‡ä»¶ä¸­ï¼Œä¼šæœ‰ä¸€æ¡ load command æŒ‡ç¤ºä»å“ªé‡ŒåŠ è½½åŠ¨æ€é“¾æ¥å™¨ã€‚</p>
<p>åŠ¨æ€é“¾æ¥å™¨ä¼šæŸ¥æ‰¾ç¨‹åºä¾èµ–çš„æ‰€æœ‰åŠ¨æ€åº“ï¼ˆè¿™éƒ¨åˆ†ä¿¡æ¯ä¹Ÿåœ¨ load command ä¸­ï¼‰ï¼Œç„¶åé€’å½’å°†å®ƒä»¬ä¹ŸåŠ è¿›æ¥ã€‚<br>
éšååŠ¨æ€é“¾æ¥å™¨ä¼šåšå¿…è¦çš„<strong>ç¬¦å·ç»‘å®š</strong>ï¼Œç„¶åè°ƒç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚è¿™ä¸ªå…¥å£ç‚¹å‡½æ•°æ˜¯é™æ€é“¾æ¥æ—¶æ·»åŠ çš„ï¼Œå®ƒä¼šåšä¸€äº› C++é™æ€å¯¹è±¡åˆå§‹åŒ–ã€ObjC è¿è¡Œæ—¶ä¹‹ç±»çš„æ“ä½œï¼Œæœ€åä¼šè°ƒç”¨ main å‡½æ•°ã€‚</p>
<h2 id="å°ç»“">å°ç»“</h2>
<p>App å¯åŠ¨è¿‡ç¨‹å…¶å®ä¹‹å‰ä¹Ÿå†™è¿‡æ–‡ç« åˆ†äº«ï¼Œä¼ é€é—¨ <a href="https://www.yuque.com/jayying/uk3dsf/ntpxwg">iOS App çš„å¯åŠ¨è¿‡ç¨‹ï¼ˆæµç¨‹ç¯‡ï¼‰</a><br>
æˆ–è€…çœ‹ä¸‹è‹¹æœæ–‡æ¡£ï¼š<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/1-Articles/executing_files.html#//apple_ref/doc/uid/TP40001829-96913-TPXREF103">Forking and Executing the Process</a>ã€<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/1-Articles/executing_files.html#//apple_ref/doc/uid/TP40001829-97021-TPXREF121">Finding Imported Symbols</a><br>
ä¸‹é¢ç¨å¾®ä»‹ç»ä¸€ä¸‹ç¬¦å·ç»‘å®šã€‚</p>
<h2 id="ç¬¦å·ç»‘å®š">ç¬¦å·ç»‘å®š</h2>
<p>è®²è§£ç¬¦åˆç»‘å®šä¹‹å‰ï¼Œå…ˆç®€å•è¯´æ˜ä¸€ä¸‹æ¨¡å—ï¼ˆmoduleï¼‰çš„å«ä¹‰ï¼Œæ¨¡å—æ˜¯ç”±æ•°æ®å’Œä»£ç æ„æˆçš„æœ€å°å•å…ƒï¼Œå¯ä»¥ç‹¬ç«‹è·Ÿå…¶ä»–å•å…ƒé“¾æ¥ã€‚ä¾‹å¦‚ç¼–è¯‘æ–‡ä»¶ main.cã€thing.cã€foo.cï¼Œäº§ç”Ÿäº† main.oã€thing.oã€foo.oï¼Œè¿™é‡Œå°±æ˜¯ä¸‰ä¸ªæ¨¡å—ã€‚ä¸è¿‡åœ¨ç¼–è¯‘ App æ—¶ï¼Œé™æ€é“¾æ¥å™¨ä¼šæŠŠå®ƒä»¬åˆå¹¶ä¸ºåŒä¸€æ¨¡å—ã€‚</p>
<p>åŒä¸€æ¨¡å—å†…ï¼Œç”±äºçŸ¥é“å‡½æ•°ã€æ•°æ®çš„åœ°å€ï¼Œæ‰€æœ‰æ¨¡å—å†…çš„ç¬¦å·å¼•ç”¨éƒ½å¯ä»¥åœ¨é™æ€é˜¶æ®µç¡®å®šä¸‹æ¥ã€‚ä½†æ˜¯ç¨‹åºä¹Ÿä¼šå­˜åœ¨å¼•ç”¨ openã€printf è¿™ç±»ç³»ç»Ÿåº“ä¸­çš„ç¬¦å·ï¼Œå±äºè·¨æ¨¡å—ç¬¦å·å¼•ç”¨ã€‚<br>
ä¸€ä¸ªæ¨¡å—ï¼ˆæºç¨‹åºï¼‰å¼•ç”¨äº†å¦ä¸€ä¸ªæ¨¡å—ï¼ˆåŠ¨æ€åº“ï¼‰çš„æ•°æ®æˆ–å‡½æ•°ï¼Œéœ€è¦ç­‰å¦ä¸€ä¸ªæ¨¡å—åŠ è½½åˆ°è¿›ç¨‹ç©ºé—´åï¼Œæ‰èƒ½ç¡®å®šè¯¥æ¨¡å—å‡½æ•°å’Œæ•°æ®çš„å…·ä½“åœ°å€ï¼Œç„¶åå†åšå¼•ç”¨ç¬¦å·åœ°å€çš„ä¿®æ­£ï¼Œæˆ–è€…å«ç¬¦å·ç»‘å®šã€‚</p>
<p>ç¬¦å·ç»‘å®šçš„æ–¹å¼é€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§ï¼š<br>
lazy-bindingï¼Œè™½ç„¶ç¨‹åºè¿è¡Œæ—¶å°±æŠŠå…±äº«åº“åŠ åˆ°è¿›ç¨‹ç©ºé—´ä¸­ï¼Œä½†ç›´åˆ°ç¬¬ä¸€æ¬¡å¼•ç”¨ç¬¦å·æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨æ‰å»åšç»‘å®šã€‚<br>
load-time bindingï¼Œé¡¾åæ€ä¹‰ï¼Œç¨‹åºè¿è¡Œæ—¶å°±è¿›è¡Œç»‘å®šã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŠ¨æ€é“¾æ¥å™¨æ‰§è¡Œ lazy-binding çš„ç­–ç•¥ã€‚åœ¨ ld é˜¶æ®µï¼Œé€šè¿‡æ·»åŠ å‚æ•°<code>-bind_at_load</code>å³å¯å¼ºåˆ¶è¿è¡Œæ—¶ç»‘å®šã€‚<br>
prebindingï¼Œå°‘ç”¨ï¼Œä¸å¤šåšè¯´æ˜ã€‚</p>
<p>ä¸è¿‡ç¬¦å·ç»‘å®šæ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œä»”ç»†ä¸€æƒ³ï¼Œä½ çŸ¥é“äº† openã€printf ç­‰å‡½æ•°çš„åœ°å€ï¼Œä½†æ˜¯ä½ æ— æ³•å°†è¿™äº›ä¿¡æ¯å¡«å……åˆ°æºç¨‹åºçš„ä»£ç æ®µä¸­ï¼Œå› ä¸ºä»£ç æ®µçš„æƒé™æ˜¯åªè¯»å’Œå¯æ‰§è¡Œï¼Œä¸èƒ½å†™ã€‚<br>
ä¼¼ä¹é™·å…¥äº†åƒµå±€ï¼ŒåŠ¨æ€åº“çš„å‡½æ•°åœ°å€è¦è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šï¼Œè€Œä¿®æ”¹ä»£ç æ®µåªèƒ½åœ¨é™æ€é“¾æ¥é˜¶æ®µï¼Œä¸€æ—¦è½½å…¥å†…å­˜å°±æ— æ³•ä¿®æ”¹ã€‚<br>
ä¸è¿‡é€€ä¸€ä¸‡æ­¥è®²ï¼Œå³ä½¿ä»£ç æ®µå¯å†™ï¼Œä¹Ÿä¼šæœ‰å…¶ä»–é—®é¢˜ã€‚é™¤äº†æºç¨‹åºå¼•ç”¨åŠ¨æ€åº“ï¼Œä¹Ÿä¼šæœ‰åŠ¨æ€åº“å¼•ç”¨å¦ä¸€ä¸ªåŠ¨æ€åº“çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ¨æ€åº“é‡Œé¢ä¹Ÿæœ‰å¼•ç”¨ç¬¦å·éœ€è¦ä¿®æ­£ã€‚é—®é¢˜å°±åœ¨è¿™é‡Œï¼Œä½ çš„ç¨‹åºä¿®æ­£äº†åŠ¨æ€åº“é‡Œé¢çš„ç¬¦å·å¼•ç”¨åœ°å€ï¼Œä½†æ˜¯åŠ¨æ€åº“æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«çš„å‘€ã€‚æœ‰å¯èƒ½å…¶ä»–è¿›ç¨‹ä¹Ÿä¾èµ–è¿™ä¸ªåŠ¨æ€åº“ï¼Œè€Œå®ƒå¯¹åº”çš„ç¬¦å·åœ°å€ä¸è§å¾—è·Ÿä½ çš„ä¸€æ ·ï¼Œè¿™æ ·æå…¶ä»–è¿›ç¨‹å°±å´©æºƒäº†ã€‚é‚£ä½ åªèƒ½æ¯ä¸ªè¿›ç¨‹éƒ½æä¸€ä»½è‡ªå·±çš„ï¼Œä¸è¿‡è¿™æ ·å°±å¤±å»äº†åŠ¨æ€åº“èŠ‚çœç©ºé—´çš„ä¸€å¤§ä¼˜åŠ¿äº†ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FiYfAS7bDkO0ZSxJZKrc_9sb7mPx.png" alt="" loading="lazy"></p>
<p>ä¸è¿‡åŠæ³•æ€»æ¯”å›°éš¾å¤šï¼Œä»£ç æ®µä¸å¯å†™ï¼Œä½†æ˜¯æ•°æ®æ®µå¯å†™å‘€ï¼Œäºæ˜¯å°±æœ‰äº†æ›²çº¿æ•‘å›½çš„æ–¹å¼ã€‚åŠ¨æ€åº“çš„å‡½æ•°åœ°å€è¿è¡Œæ—¶ç¡®å®šåï¼ŒæŠŠåœ°å€å†™åˆ°<code>__DATA</code>çš„æŸä¸ªåœ°æ–¹ã€‚ç”±äº<code>__TEXT</code>å’Œ<code>__DATA</code>çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ä»£ç ä¸Šå¯ä»¥åˆ©ç”¨å½“å‰ PC+åç§»é‡å¾—åˆ°åœ°å€å­˜æ”¾çš„ä½ç½®ï¼Œç„¶åå†è®¿é—®åœ°å€ã€‚è¿™ç§æ–¹å¼åˆå«é—´æ¥ç¬¦å·å¼•ç”¨ã€‚</p>
<blockquote>
<p><a href="https://github.com/facebook/fishhook">fishhook</a>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å®ç°äº† Hook C å‡½æ•°ã€‚<br>
PSï¼šæœ¬æ¥æƒ³å†™ä¸€ç¯‡æºç åˆ†ææ–‡ç« çš„ï¼Œä½†æºç å…¶å®å°±ä¸¤ç™¾æ¥è¡Œï¼ŒçŸ¥é“ Mach-O å’ŒåŠ¨æ€é“¾æ¥çš„ç‰¹æ€§åä¹Ÿä¸éš¾ç†è§£ï¼Œäºæ˜¯æ”¾å¼ƒäº†ã€‚</p>
</blockquote>
<h1 id="åº–ä¸è§£ç‰›">åº–ä¸è§£ç‰›</h1>
<p>å‰é¢å·²ç»è®²äº† Mach-O æ–‡ä»¶æ‰§è¡Œçš„ä¸€äº›ç»†èŠ‚ï¼Œæ¥ä¸‹æ¥å°±äº²è‡ªåŠ¨æ‰‹ï¼Œé€ä¸ª Byte åˆ†æ Mach-O æ–‡ä»¶çš„å¥¥ç§˜ã€‚ä¸­é—´ä¼šç©¿æ’å„ç§ ğŸ§‘â€ğŸ’»Codingï¼Œç”¨äºéªŒè¯ã€‚</p>
<h2 id="å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨">å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨</h2>
<p>æŸ¥çœ‹ä¸€ä¸ª Mach-O æ–‡ä»¶åŒ…å«ä»€ä¹ˆä¿¡æ¯ï¼Œæœ‰å¾ˆå¤šå·¥å…·å¯ä»¥ä½¿ç”¨ã€‚<br>
lipoï¼šåˆ†æä½“ç³»ç»“æ„<br>
fileï¼šæ˜¾ç¤ºæ–‡ä»¶ç±»å‹<br>
otoolï¼šæŸ¥çœ‹ Mach-O æ–‡ä»¶å…·ä½“çš„ Segmentã€Section æ•°æ®<br>
pagestuffï¼šæŒ‰é¡µæŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯<br>
nmï¼šæŸ¥çœ‹ç¬¦å·è¡¨<br>
libtoolï¼šå¯å°†å¤šä¸ªä¸­é—´æ–‡ä»¶åˆå¹¶ä¸ºé™æ€åº“ a</p>
<blockquote>
<p>ğŸ’¡ ä¸Šé¢çš„éƒ½æ˜¯å‘½ä»¤è¡Œå·¥å…·ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªå¸¸ç”¨çš„å¯è§†åŒ–å·¥å…· MachOView</p>
</blockquote>
<p>å¦å¤–å†è¡¥ä¸€ä¸‹æˆ‘çš„ç”µè„‘é…ç½®<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FgzxoCveBndgMDmE_NSkEI74FzF6.png" alt="" loading="lazy"><br>
emmmï¼Œå½“æ—¶ M1 Max åˆšå‡ºæ—¶ä¹°çš„ï¼Œç­‰äº†å¿«ä¸€ä¸ªæœˆæ‰åˆ°è´§...</p>
<h2 id="coding-ç¯èŠ‚">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h2>
<p>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶<code>file_b.c</code>ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre><code class="language-c">int base = 0xfff0;

int getAddress(int base, int offset) {
    return base + offset;
}
</code></pre>
<p>ç„¶åç¼–è¯‘</p>
<pre><code class="language-shell">//å•ç‹¬ç¼–è¯‘ï¼Œä¸é“¾æ¥
clang -c file_b.c -o file_b.o
</code></pre>
<h2 id="header">Header</h2>
<p>Mach-O æ–‡ä»¶å¼€å¤´æ˜¯ä¸€ä¸ª<code>mach_header</code>ç»“æ„ä½“ã€‚ä»£ç ä½äº mach-o/loader.hï¼Œå…¶åœ¨ 32 ä½å’Œ 64 ä½æœºå™¨ä¸‹ç»“æ„ç¨æœ‰ä¸åŒã€‚</p>
<pre><code class="language-c">/*
 * The 32-bit mach header appears at the very beginning of the object file for
 * 32-bit architectures.
 */
struct mach_header {
	uint32_t	magic;		/* mach magic number identifier */
	int32_t		cputype;	/* cpu specifier */
	int32_t		cpusubtype;	/* machine specifier */
	uint32_t	filetype;	/* type of file */
	uint32_t	ncmds;		/* number of load commands */
	uint32_t	sizeofcmds;	/* the size of all the load commands */
	uint32_t	flags;		/* flags */
};

struct mach_header_64 {
	uint32_t	magic;		/* mach magic number identifier */
	int32_t		cputype;	/* cpu specifier */
	int32_t		cpusubtype;	/* machine specifier */
	uint32_t	filetype;	/* type of file */
	uint32_t	ncmds;		/* number of load commands */
	uint32_t	sizeofcmds;	/* the size of all the load commands */
	uint32_t	flags;		/* flags */
	uint32_t	reserved;	/* reserved */
};
</code></pre>
<p>magic è¡¨ç¤ºå½“å‰ Mach-O æ–‡ä»¶å¯è¿è¡Œäº 32 ä½è¿˜æ˜¯ 64 ä½æœºå™¨ï¼Œä»¥åŠæœºå™¨çš„ç«¯åºã€‚</p>
<pre><code class="language-c">/* Constant for the magic field of the mach_header (32-bit architectures) */
#define	MH_MAGIC	0xfeedface	/* the mach magic number */
#define MH_CIGAM	0xcefaedfe	/* NXSwapInt(MH_MAGIC) */

/* Constant for the magic field of the mach_header_64 (64-bit architectures) */
#define MH_MAGIC_64 0xfeedfacf /* the 64-bit mach magic number */
#define MH_CIGAM_64 0xcffaedfe /* NXSwapInt(MH_MAGIC_64) */
</code></pre>
<p>cputypeã€cpusubtype è¡¨ç¤ºæœºå™¨æ¶æ„ï¼Œå¦‚ CPU_TYPE_ARM64ã€CPU_TYPE_X86_64ã€‚æ›´å¤šå®šä¹‰å¯ä»¥æŸ¥çœ‹ mach/machine.h</p>
<p>filetype è¡¨ç¤º Mach-O æ–‡ä»¶çš„ç±»å‹ï¼Œå¸¸è§çš„æœ‰ï¼šä¸­é—´å¯¹è±¡æ–‡ä»¶ï¼ˆMH_OBJECTï¼‰ã€å¯æ‰§è¡ŒäºŒè¿›åˆ¶ï¼ˆMH_EXECUTEï¼‰ã€VM å…±äº«åº“æ–‡ä»¶ï¼ˆMH_FVMLIBï¼‰ã€Crash äº§ç”Ÿçš„ Core æ–‡ä»¶ï¼ˆMH_COREï¼‰ã€åŠ¨æ€å…±äº«åº“ï¼ˆMH_DYLIBï¼‰ã€åŠ¨æ€é“¾æ¥å™¨ï¼ˆMH_DYLINKERï¼‰ã€é™æ€é“¾æ¥æ–‡ä»¶ï¼ˆMH_DYLIB_STUBï¼‰ã€ç¬¦å·æ–‡ä»¶å’Œè°ƒè¯•ä¿¡æ¯ï¼ˆMH_DSYMï¼‰</p>
<p>ncmds å’Œ sizeofcmds ä»£è¡¨æœ‰å¤šå°‘ load command ä»¥åŠæ‰€å å¤§å°</p>
<p>flags æ˜¯ä¸€äº›æ ‡è®°å­—æ®µï¼Œå…·ä½“å«ä¹‰å¯å‚è€ƒ loader.h ä¸­çš„è¯´æ˜ã€‚</p>
<h3 id="coding-ç¯èŠ‚-2">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h3>
<p>æˆ‘ä»¬å¯ä»¥ç”¨å‘½ä»¤è¡Œå·¥å…·æ‰“å°ä¸€ä¸‹</p>
<pre><code class="language-shell">otool -v -h file_b.o
</code></pre>
<p>ç»“æœå¦‚ä¸‹</p>
<pre><code>Mach header
magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags
MH_MAGIC_64    ARM64        ALL  0x00      OBJECT     4        440 SUBSECTIONS_VIA_SYMBOLS
</code></pre>
<p>ç›´æ¥ç”¨ä»£ç éªŒè¯<br>
ä¸ºäº†ä¾¿äºåç»­ä»£ç ç¼–å†™ï¼Œè¿™é‡ŒåŠ å‡ ä¸ªåˆ«åå’Œå®å®šä¹‰ï¼Œæ–°å‡ºç°çš„ä¹ŸæŒ‰åŒæ ·è§„åˆ™å¤„ç†</p>
<pre><code class="language-c">#ifdef __LP64__
typedef struct mach_header_64 mach_header_t;
typedef struct segment_command_64 segment_command_t;
typedef struct section_64 section_t;
typedef struct nlist_64 nlist_t;
#define LC_SEGMENT_ARCH_DEPENDENT LC_SEGMENT_64
#else
typedef struct mach_header mach_header_t;
typedef struct segment_command segment_command_t;
typedef struct section section_t;
typedef struct nlist nlist_t;
#define LC_SEGMENT_ARCH_DEPENDENT LC_SEGMENT
#endif

#ifndef SEG_DATA_CONST
#define SEG_DATA_CONST  &quot;__DATA_CONST&quot;
#endif

typedef struct load_command load_command_t;
typedef struct dylib_command dylib_command_t;
typedef struct dylinker_command dylinker_command_t;
typedef struct symtab_command symtab_command_t;
typedef struct dysymtab_command dysymtab_command_t;
</code></pre>
<pre><code class="language-c">void *getFilePointer(const char *filePath) {
    int fd = open(filePath, O_RDONLY, S_IRUSR);
    struct stat st = {};
    fstat(fd, &amp;st);
    uint64_t fileSize = (uint64_t)st.st_size;
    void *ptr = mmap(NULL, fileSize, PROT_READ, MAP_SHARED, fd, 0);
    return ptr;
}

void startReadMachO(const char *filePath) {
    void *filePtr = getFilePointer(filePath);
    void *curPtr = filePtr;

    mach_header_t *header = (mach_header_t *)curPtr;
    printf(&quot;magic: %x\n&quot;, header-&gt;magic);
    printf(&quot;cputype: %u\n&quot;, header-&gt;cputype);
    printf(&quot;cpusubtype: %u\n&quot;, header-&gt;cpusubtype);
    printf(&quot;filetype: %u\n&quot;, header-&gt;filetype);
    printf(&quot;ncmds: %u\n&quot;, header-&gt;ncmds);
    printf(&quot;sizeofcmds: %u\n&quot;, header-&gt;sizeofcmds);
    printf(&quot;flags: %u\n&quot;, header-&gt;flags);
}
</code></pre>
<p>ä¼ å…¥ file_b.o çš„è·¯å¾„ï¼Œå¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼Œæ•°æ®å»åˆ</p>
<pre><code>magic: feedfacf
cputype: 16777228
cpusubtype: 0
filetype: 1
ncmds: 4
sizeofcmds: 440
flags: 8192
</code></pre>
<h2 id="load-commands">Load Commands</h2>
<p>ä¸‹ä¸€æ­¥æ¥åˆ° load commandï¼Œä» mach_header é‚£é‡Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† load commands çš„æ€»ä½“å¤§å°ã€‚<br>
load command æœ‰å¾ˆå¤šç§ï¼Œä½†æ˜¯æ‰€æœ‰ load command ç»“æ„ä½“çš„å‰ä¸¤ä¸ªå±æ€§æ˜¯ä¸€æ ·çš„ï¼Œç±»ä¼¼äºé¢å‘å¯¹è±¡ä¸­çš„åŸºç±»ã€‚</p>
<pre><code class="language-c">struct load_command {
	uint32_t cmd;		/* type of load command */
	uint32_t cmdsize;	/* total size of command in bytes */
};
</code></pre>
<p>cmd ä»£è¡¨äº† load command çš„ç±»å‹ï¼Œcmdsize ä»£è¡¨å…·ä½“ load command çš„ç»“æ„ä½“å¤§å° + é¢å¤–æ•°æ®å¤§å°ã€‚å…·ä½“çš„ load command ç»“æ„å¯åœ¨ loader.h ä¸­æŸ¥çœ‹</p>
<p>åœ¨æˆ‘ä»¬çš„<code>file_b.o</code>ä¸­ï¼Œå…±æœ‰ 4 ä¸ª load commandsï¼Œåˆ†åˆ«ä¸º LC_BUILD_VERSIONã€LC_SEGMENT_64ã€LC_SYMTABã€LC_DYSYMTABï¼Œç¬¬ä¸€ä¸ªä¸å¤ªé‡è¦ï¼Œç›´æ¥å¿½ç•¥ã€‚</p>
<h3 id="lc_segment_64">LC_SEGMENT_64</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>segment_command_64</code>ï¼ŒæŒ‡å®šäº† Mach-O æ–‡ä»¶æŸä¸ªæ®µçš„ä¿¡æ¯ï¼Œæ®µæ˜¯ä¼šè¢«è½½å…¥è¿›ç¨‹ç©ºé—´çš„ï¼Œç»“æ„ä½“ä¸­åŒæ—¶è¿˜è¯´æ˜äº†è½½å…¥çš„è™šæ‹Ÿåœ°å€ä½ç½®ã€‚</p>
<p>å†æ¬¡ç¥­å‡ºè¿™å¼ å›¾<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//Fkk8pOAP_-UZXZta955gFg_tffP0.png" alt="" loading="lazy"><br>
Data åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª segment çš„æ•°æ®ï¼Œä¸€ä¸ª segment æœ‰ 0 ä¸ªæˆ–å¤šä¸ª sectionï¼Œæ¯ä¸ª section åŒ…å« code æˆ–è€… dataã€‚<br>
æ¯ä¸ª section éƒ½æœ‰ç¼–å·ï¼Œä» 1 å¼€å§‹ï¼Œä¸”è·¨å¤šä¸ª segmentã€‚æ¯”å¦‚ç¬¬ä¸€ä¸ª segment æœ‰ section1 section2 section3ï¼Œç¬¬äºŒä¸ª segment æœ‰ section4 section5...</p>
<p>section å¯¹åº”ç»“æ„ä½“<code>section_64</code>ï¼Œè·Ÿåœ¨<code>segment_command_64</code>ä¹‹åã€‚</p>
<pre><code class="language-c">/*
 * The 64-bit segment load command indicates that a part of this file is to be
 * mapped into a 64-bit task's address space.  If the 64-bit segment has
 * sections then section_64 structures directly follow the 64-bit segment
 * command and their size is reflected in cmdsize.
 */
struct segment_command_64 { /* for 64-bit architectures */
	uint32_t	cmd;		/* LC_SEGMENT_64 */
	uint32_t	cmdsize;	/* includes sizeof section_64 structs */
	char		segname[16];	/* segment name */
	uint64_t	vmaddr;		/* memory address of this segment */
	uint64_t	vmsize;		/* memory size of this segment */
	uint64_t	fileoff;	/* file offset of this segment */
	uint64_t	filesize;	/* amount to map from the file */
	int32_t		maxprot;	/* maximum VM protection */
	int32_t		initprot;	/* initial VM protection */
	uint32_t	nsects;		/* number of sections in segment */
	uint32_t	flags;		/* flags */
};


struct section_64 { /* for 64-bit architectures */
	char		sectname[16];	/* name of this section */
	char		segname[16];	/* segment this section goes in */
	uint64_t	addr;		/* memory address of this section */
	uint64_t	size;		/* size in bytes of this section */
	uint32_t	offset;		/* file offset of this section */
	uint32_t	align;		/* section alignment (power of 2) */
	uint32_t	reloff;		/* file offset of relocation entries */
	uint32_t	nreloc;		/* number of relocation entries */
	uint32_t	flags;		/* flags (section type and attributes)*/
	uint32_t	reserved1;	/* reserved (for offset or index) */
	uint32_t	reserved2;	/* reserved (for count or sizeof) */
	uint32_t	reserved3;	/* reserved */
};
</code></pre>
<p>segment å’Œ section éƒ½æœ‰åå­—ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œsegment ç”¨åŒä¸‹åˆ’çº¿+å¤§å†™å­—æ¯ï¼Œsection ç”¨åŒä¸‹åˆ’çº¿+å°å†™å­—æ¯ã€‚</p>
<p>å¯æ‰§è¡Œæ–‡ä»¶çš„ segment é€šå¸¸æœ‰ä»¥ä¸‹å…­ç§ç±»å‹ï¼š</p>
<ul>
<li>__PAGEZEROï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ª segmentï¼Œåœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€ä¸ºé›¶ï¼Œsize ä»£è¡¨è™šæ‹Ÿå†…å­˜ä¸­ä¸€é¡µçš„å¤§å°ã€‚</li>
<li>__TEXTï¼ŒåŒ…å«å¯æ‰§è¡Œçš„ä»£ç ã€åªè¯»æ•°æ®ã€‚å› ä¸ºä¸å¯å†™ï¼Œæ‰€ä»¥å¯ä»¥å½“åšå…±äº«å†…å­˜ï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿèƒ½è·å–ã€‚ä¾‹å¦‚è¿è¡ŒåŒä¸€ä¸ªç¨‹åºå¤šæ¬¡ã€Framework çš„ä»£ç ã€å…±äº«åº“ã€‚</li>
<li>__DATAï¼Œå¯è¯»å†™çš„æ•°æ®ã€‚å› æ­¤æ¯ä¸ªè¿›ç¨‹éƒ½è¦å•ç‹¬æ‹·è´ä¸€ä»½ Frameworkã€å…±äº«åº“çš„æ•°æ®ï¼Œæ‹·è´é‡‡ç”¨ copy-on-write ç­–ç•¥ã€‚</li>
<li>__OBJCï¼Œç”¨äºæ”¯æŒ Objective-C Runtime çš„ç›¸å…³æ•°æ®</li>
<li>__IMPORTï¼ŒåŒ…å«ä¸€äº›æœªè¢«å®šä¹‰çš„ç¬¦å·ï¼Œåªä¸º IA-32 æ¶æ„ä½¿ç”¨ï¼Œç°åœ¨å¯ä»¥å¿½ç•¥ã€‚</li>
<li>__LINKEDITï¼ŒåŒ…å«ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨ã€é‡å®šä½è¡¨ç­‰æ•°æ®ã€‚</li>
</ul>
<p>åœ¨ç”¨æˆ·æœ€ç»ˆé“¾æ¥æˆçš„ Mach-O æ–‡ä»¶ä¸­ï¼Œæœ€åä¸€ä¸ª segment ä¸º__LINKEDITã€‚</p>
<h4 id="coding-ç¯èŠ‚-3">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h4>
<pre><code class="language-c">curPtr = curPtr + sizeof(mach_header_t);
load_command_t *command;
for (int i = 0; i &lt; header-&gt;ncmds; i++, curPtr += command-&gt;cmdsize) {
    command = (load_command_t *)curPtr;
    if (command-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) {
        segment_command_t *segment_command = (segment_command_t *)command;
        printf(&quot;segment: %s \n&quot;, segment_command-&gt;segname);
        printf(&quot;sections:\n&quot;);
        section_t *sections = (section_t *)(curPtr + sizeof(segment_command_t));
        for (int j = 0; j &lt; segment_command-&gt;nsects; j++) {
            printf(&quot;%s %s \n&quot;, sections[j].segname, sections[j].sectname);
            printf(&quot;flags: 0x%x \n&quot;, sections[j].flags);
        }
        printf(&quot;\n\n&quot;);
    }
}
</code></pre>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹</p>
<pre><code>segment:
sections:
__TEXT __text
flags: 0x80000400
__DATA __data
flags: 0x0
__LD __compact_unwind__LD
flags: 0x2000000
</code></pre>
<p>æ‰“å°ä¹‹åä½ ä¼šå‘ç°ï¼Œåªæœ‰ä¸€ä¸ª segmentï¼Œè€Œä¸”è¿˜æ²¡æœ‰åå­—ã€‚è¿™æ˜¯ä¸ºäº†ä¸­é—´ç›®æ ‡æ–‡ä»¶çš„ç´§å‡‘æ€§æ•…æ„å¤„ç†çš„ï¼Œè¿™ä¸ª segment é‡Œé¢åŒ…å«äº†å„ç§å„æ ·çš„ sectionï¼Œå±äºä¸åŒ segmentï¼Œä¼šåœ¨é™æ€é“¾æ¥æ—¶æ”¾ç½®åˆ°åˆç†çš„ä½ç½®ä¸Šã€‚</p>
<p>è¿™é‡Œæœ‰ä¸‰ä¸ª sectionã€‚</p>
<ul>
<li><code>__compact_unwind__LD</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª debug ç”¨çš„ï¼Œå¯ä»¥å¿½ç•¥ã€‚</li>
<li><code>__text</code>ï¼ŒåŒ…å«å¯æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤ã€‚</li>
<li><code>__data</code>ï¼ŒåŒ…å«æœ‰åˆå§‹åŒ–å€¼çš„å˜é‡ã€‚åœ¨<code>file_b.c</code>ä¸­ï¼Œæˆ‘ä»¬åªæœ‰<code>int base = 0xfff0</code>è¿™ä¹ˆä¸ªåˆå§‹åŒ–å˜é‡ã€‚</li>
</ul>
<p>å¯ä»¥æ‰“å°å‡ºæ¥éªŒè¯</p>
<pre><code class="language-c">if (strcmp(sections[j].sectname, SECT_DATA) == 0) {
    int *value = (int *)(filePtr + sections[j].offset);
    printf(&quot;%x \n&quot;, *value);
}
</code></pre>
<h3 id="lc_symtab">LC_SYMTAB</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>symtab_command</code>ï¼Œæè¿°äº†ç¬¦å·è¡¨çš„ä½ç½®å’Œå¤§å°ã€‚æ‰€è°“çš„ç¬¦å·è¡¨ï¼Œæ˜¯ç”±<code>nlist_64</code>æ„æˆçš„ç»“æ„ä½“æ•°ç»„ã€‚</p>
<pre><code class="language-c">/*
 * The symtab_command contains the offsets and sizes of the link-edit 4.3BSD
 * &quot;stab&quot; style symbol table information as described in the header files
 * &lt;nlist.h&gt; and &lt;stab.h&gt;.
 */
struct symtab_command {
	uint32_t	cmd;		/* LC_SYMTAB */
	uint32_t	cmdsize;	/* sizeof(struct symtab_command) */
	uint32_t	symoff;		/* symbol table offset */
	uint32_t	nsyms;		/* number of symbol table entries */
	uint32_t	stroff;		/* string table offset */
	uint32_t	strsize;	/* string table size in bytes */
};

/*
 * This is the symbol table entry structure for 64-bit architectures.
 */
struct nlist_64 {
    union {
        uint32_t  n_strx; /* index into the string table */
    } n_un;
    uint8_t n_type;        /* type flag, see below */
    uint8_t n_sect;        /* section number or NO_SECT */
    uint16_t n_desc;       /* see &lt;mach-o/stab.h&gt; */
    uint64_t n_value;      /* value of this symbol (or stab offset) */
};
</code></pre>
<h4 id="coding-ç¯èŠ‚-4">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h4>
<pre><code class="language-c">if (command-&gt;cmd == LC_SYMTAB) {
    symtab_command_t *symtab_command = (symtab_command_t *)command;
    nlist_t *nlists = (nlist_t *)(filePtr + symtab_command-&gt;symoff);
    uint32_t strOffset = symtab_command-&gt;stroff;
    for (int j = 0; j &lt; symtab_command-&gt;nsyms; j++) {
        nlist_t nlist = nlists[j];
        printf(&quot;symbol: %s type:%u sect:%u desc:%u value:%llu \n&quot;, (char *)(filePtr + strOffset + nlist.n_un.n_strx), nlist.n_type, nlist.n_sect, nlist.n_desc, nlist.n_value);
    }
}
</code></pre>
<p>è¾“å‡ºç»“æœä¸­ï¼Œå¯ä»¥çœ‹åˆ°ç¬¦å·_base å’Œ_getAddress</p>
<pre><code>symbol: ltmp0 type:14 sect:1 desc:0 value:0
symbol: ltmp1 type:14 sect:2 desc:0 value:32
symbol: ltmp2 type:14 sect:3 desc:0 value:40
symbol: _base type:15 sect:2 desc:0 value:32
symbol: _getAddress type:15 sect:1 desc:0 value:0
</code></pre>
<p>æ ¹æ® value å¯ä»¥çŸ¥é“_base æ˜¯ä¸€ä¸ªå…¨å±€ç¬¦å·</p>
<pre><code class="language-c">#define	N_GSYM		0x20	/* global symbol */
</code></pre>
<h3 id="lc_dysymtab">LC_DYSYMTAB</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>dysymtab_command</code>ï¼Œæè¿°äº†ç”¨äºåŠ¨æ€é“¾æ¥éƒ¨åˆ†çš„ç¬¦å·è¡¨ã€‚</p>
<h4 id="coding-ç¯èŠ‚-5">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h4>
<pre><code class="language-c">if (command-&gt;cmd == LC_DYSYMTAB) {
    dysymtab_command_t *dysymtab_command = (dysymtab_command_t *)command;
    printf(&quot;local: %u extdef: %u undef: %u \n&quot;, dysymtab_command-&gt;nlocalsym, dysymtab_command-&gt;nextdefsym, dysymtab_command-&gt;nundefsym);
}
</code></pre>
<p>è¿™é‡Œæœ‰ä¸‰ä¸ªæœ¬åœ°ç¬¦å·ï¼Œä¸¤ä¸ªå¯¹å¤–ç¬¦å·ï¼Œç¬¦åˆé¢„æœŸ</p>
<pre><code>local: 3 extdef: 2 undef: 0
</code></pre>
<h3 id="coding-ç¯èŠ‚-6">ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚</h3>
<p>file_b.o æˆ‘ä»¬å·²ç»æ‰’å¾—å·®ä¸å¤šäº†ï¼Œæ˜¯æ—¶å€™å†™ä¸ªæ–°çš„ä»£ç äº†ï¼Œå°±å« file_a.c</p>
<pre><code class="language-c">#include &quot;file_b.h&quot;

int printf(const char *, ...);

int main(int argc, char *argv[]) {
    int offset = 0x10;
    int address = getAddress(base, offset);
    printf(&quot;address is %x&quot;, address);
    return 0;
}
</code></pre>
<p>file_a.c éœ€è¦ç”¨åˆ° base å’Œ getAddressï¼Œæ‰€ä»¥è¦æŠŠè¿™ä¸¤ä¸ªä¿¡æ¯æä¾›å‡ºæ¥</p>
<pre><code class="language-c">extern int base;

int getAddress(int base, int offset);
</code></pre>
<p>ç„¶åç¼–è¯‘</p>
<pre><code class="language-shell">//å•ç‹¬ç¼–è¯‘ï¼Œä¸é“¾æ¥
clang -c file_a.c -o file_a.o
</code></pre>
<p>æ¥ä¸‹æ¥çš„ä»£ç è·Ÿä¹‹å‰çš„ä¸€æ ·ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹è¾“å‡º</p>
<pre><code>magic: feedfacf
cputype: 16777228
cpusubtype: 0
filetype: 1
ncmds: 4
sizeofcmds: 440
flags: 8192

segment:
sections:
__TEXT __text
flags: 0x80000400
__TEXT __cstring
flags: 0x2
__LD __compact_unwind__LD
flags: 0x2000000


symbol: ltmp0 type:14 sect:1 desc:0 value:0
symbol: l_.str type:14 sect:2 desc:0 value:108
symbol: ltmp1 type:14 sect:2 desc:0 value:108
symbol: ltmp2 type:14 sect:3 desc:0 value:128
symbol: _main type:15 sect:1 desc:0 value:0
symbol: _base type:1 sect:0 desc:0 value:0
symbol: _getAddress type:1 sect:0 desc:0 value:0
symbol: _printf type:1 sect:0 desc:0 value:0


local: 4 extdef: 1 undef: 3
</code></pre>
<p>è¿™é‡Œå¤šäº†ä¸€ä¸ªå‰é¢æ²¡æœ‰çš„ section __cstringï¼Œé‡Œé¢åŒ…å« C å­—ç¬¦ä¸²ï¼Œå³<code>&quot;address is %x&quot;</code>ï¼Œå¯ä»¥éªŒè¯ä¸‹</p>
<pre><code class="language-c">if (sections[j].flags == S_CSTRING_LITERALS) {
    printf(&quot;%s \n&quot;, (char *)(filePtr + sections[j].offset));
}
</code></pre>
<p>ç„¶åä¹Ÿæ²¡æœ‰å¤šä½™çš„å¯åˆ†æäº†ï¼ŒæŠŠä¸¤ä¸ª Mach-O é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶çœ‹çœ‹</p>
<pre><code class="language-shell">//é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶target.o
ld -lSystem -syslibroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -o target.o file_a.o file_b.o
//æ‰§è¡Œä¸€ä¸‹target.oï¼Œå¯æ­£å¸¸è¿è¡Œ
./target.o
</code></pre>
<p>é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶åï¼Œåˆå¤šäº†å¥½å‡ ä¸ª load commandsï¼Œè¿™é‡ŒåŒæ ·åªæŒ‘å‡ ä¸ªæœ‰æ„æ€çš„è®²è®²</p>
<h3 id="lc_load_dylinker">LC_LOAD_DYLINKER</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>dylinker_command</code>ï¼ŒæŒ‡ç¤ºäº†åŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„ã€‚<br>
æ¯ä¸ªåŠ¨æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶éƒ½åŒ…å«è¯¥ commandï¼Œè¯¥ command åŒ…å«æŒ‡æ˜äº†å†…æ ¸åœ¨å¯åŠ¨è¿›ç¨‹æ—¶ï¼Œä»å“ªä¸ªåœ°æ–¹å¯åŠ¨ dyldã€‚å¦‚æœè¿™ä¸ªæ–‡ä»¶å°±æ˜¯åŠ¨æ€é“¾æ¥å™¨æœ¬èº«ï¼Œåˆ™é€šè¿‡ LC_ID_DYLINKER æŒ‡æ˜ã€‚</p>
<pre><code class="language-c">if (command-&gt;cmd == LC_LOAD_DYLINKER) {
    dylinker_command_t *dylinker_command = (dylinker_command_t *)command;
    uint32_t length = dylinker_command-&gt;cmdsize - sizeof(dylinker_command_t);
    uint32_t offset = dylinker_command-&gt;name.offset;
    printf(&quot;length: %u dylinker: %s \n\n&quot;, length, (char *)(curPtr + offset));
}
</code></pre>
<p>è¾“å‡º</p>
<pre><code>length: 20 dylinker: /usr/lib/dyld
</code></pre>
<h3 id="lc_load_dylib">LC_LOAD_DYLIB</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>dylib_command</code>ï¼ŒæŒ‡ç¤ºäº†ä¾èµ–çš„åŠ¨æ€åº“ã€‚å‰é¢æè¿‡ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šæŠŠæ‰€æœ‰ä¾èµ–çš„åº“åŠ åˆ°è¿›ç¨‹ä¸­ï¼Œå¦‚æœåŠ¨æ€åº“ä¾èµ–å…¶ä»–åŠ¨æ€åº“ï¼Œåˆ™é€’å½’è¿›è¡ŒåŠ è½½ï¼Œç„¶åå†åšç¬¦å·ç»‘å®šã€‚</p>
<pre><code class="language-c">if (command-&gt;cmd == LC_LOAD_DYLIB) {
    dylib_command_t *dylib_command = (dylib_command_t *)command;
    uint32_t length = dylib_command-&gt;cmdsize - sizeof(dylib_command_t); //å¾—åˆ°dylib.nameçš„é•¿åº¦
    uint32_t offset = dylib_command-&gt;dylib.name.offset;
    printf(&quot;length:%u  dylib: %s \n\n&quot;, length, (char *)(curPtr + offset));
}
</code></pre>
<p>è¾“å‡º</p>
<pre><code>length:32  dylib: /usr/lib/libSystem.B.dylib
</code></pre>
<h3 id="lc_main">LC_MAIN</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>entry_point_command</code>ï¼Œå³ main å‡½æ•°çš„åœ°å€</p>
<h3 id="lc_data_in_code">LC_DATA_IN_CODE</h3>
<p>å¯¹åº”ç»“æ„ä½“<code>linkedit_data_command</code>ï¼Œåœ¨ä»£ç æ®µçš„æ•°æ®ï¼Œå³åªè¯»æ•°æ®ã€‚</p>
<pre><code class="language-c">/*
 * The linkedit_data_command contains the offsets and sizes of a blob
 * of data in the __LINKEDIT segment.
 */
struct linkedit_data_command {
    uint32_t	cmd;		/* LC_CODE_SIGNATURE, LC_SEGMENT_SPLIT_INFO,
				   LC_FUNCTION_STARTS, LC_DATA_IN_CODE,
				   LC_DYLIB_CODE_SIGN_DRS,
				   LC_LINKER_OPTIMIZATION_HINT,
				   LC_DYLD_EXPORTS_TRIE, or
				   LC_DYLD_CHAINED_FIXUPS. */
    uint32_t	cmdsize;	/* sizeof(struct linkedit_data_command) */
    uint32_t	dataoff;	/* file offset of data in __LINKEDIT segment */
    uint32_t	datasize;	/* file size of data in __LINKEDIT segment  */
};
</code></pre>
<p><code>linkedit_data_command</code>ç»“æ„ä½“è¢«å¾ˆå¤š load command å…±ç”¨ã€‚</p>
<h2 id="data">Data</h2>
<p>åœ¨æœ€ç»ˆçš„ target.o ä¸­ï¼Œå¤šäº†ä¸€ä¸ª segment,<code>__DATA_CONST</code>ï¼Œé‡Œé¢æœ‰ä¸€ä¸ª section,<code>__got</code>ã€‚è¿™å…¶å®å°±æ˜¯æˆ‘ä»¬ç¬¦å·ç»‘å®šæ—¶æåˆ°çš„é—´æ¥ç¬¦å·å¼•ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œå¼•ç”¨äº† printf è¿™ä¸ªåŠ¨æ€åº“ç¬¦å·ã€‚<br>
å…³äºå¦‚ä½•åˆ¤æ–­è¿™ä¸ª section æ¯ä¸ªä½ç½®ä»£è¡¨å“ªä¸ªé—´æ¥ç¬¦å·å¼•ç”¨çš„åœ°å€ï¼Œå¯ä»¥å‚è€ƒ<a href="https://github.com/facebook/fishhook">fishhook</a>ä¸­çš„å®ç°ã€‚</p>
<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>
<p>é™¤äº†ä¸Šé¢è´´è¿‡çš„é“¾æ¥å¤–<br>
<a href="https://github.com/aidansteele/osx-abi-macho-file-format-reference">https://github.com/aidansteele/osx-abi-macho-file-format-reference</a><br>
<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/0-Introduction/introduction.html">Mach-O Programming Topics</a><br>
<a href="https://ming1016.github.io/2020/03/29/apple-system-executable-file-macho/">Apple æ“ä½œç³»ç»Ÿå¯æ‰§è¡Œæ–‡ä»¶ Mach-O</a><br>
ã€ŠiOS åº”ç”¨å®‰å…¨ä¸é€†å‘ä¹‹é“ã€‹<br>
<a href="https://draveness.me/fishhook/">åŠ¨æ€ä¿®æ”¹ C è¯­è¨€å‡½æ•°çš„å®ç° - é¢å‘ä¿¡ä»°ç¼–ç¨‹</a></p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="https://jayying007.github.io/post/ä¸€ä¸ªç®€å•çš„å¤©æ°”App/" class="post-title gt-a-link">
                    ä¸€ä¸ªç®€å•çš„å¤©æ°”App
                </a>
            </div>
        

        

        

        
            <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: 'JHsf6kk7u31nFtmMMtWqQyHl-gzGzoHsz',
		appKey: '6kuh7BaduW3qYuq5MUi7KaTm',
		avatar: '',
		pageSize: 5,
		recordIp: true,
		placeholder: 'Just Go Go',
		visitor: false,
	});
</script>

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"></div>
    <div class="social-container">
        
            
                <a href="https://github.com/jayying007" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        
    </div>
    <div>
        Theme <a href="https://github.com/imhanjie/gridea-theme-pure" target="_blank">Pure</a>, Powered by <a
                href="https://gridea.dev" target="_blank">Gridea</a> | <a href="https://jayying007.github.io/atom.xml" target="_blank">RSS</a>
    </div>
</div>

<script>
  hljs.highlightAll()
</script>

    </div>
</div>
</body>
</html>
