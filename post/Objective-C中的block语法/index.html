<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Objective-Cä¸­çš„blockè¯­æ³• | å½±å¸çš„ç½‘ç»œæ—¥å¿—</title>

<link rel="shortcut icon" href="https://jayying007.github.io/favicon.ico?v=1750777237119">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://jayying007.github.io/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages//dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-T5DQK64QPQ-G"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-T5DQK64QPQ-G');
</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
    
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            å½±å¸çš„ç½‘ç»œæ—¥å¿—
        </div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" id="changeNavbar">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    é¦–é¡µ
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    å½’æ¡£
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    æ ‡ç­¾
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/about" class="menu gt-a-link">
                    å…³äº
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1750777237119"
                action="/search/">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* ç§»åŠ¨ç«¯å¯¼èˆªæ å±•å¼€/æ”¶èµ·åˆ‡æ¢ */
    document.getElementById('changeNavbar').onclick = () => {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    Objective-Cä¸­çš„blockè¯­æ³•
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2021-09-21 Â·
                    </time>
                    
                        <a href="https://jayying007.github.io/tag/2yd3XVCm-Ic/" class="post-tags">
                            # IOS
                        </a>
                    
                        <a href="https://jayying007.github.io/tag/HTgmVKsURQ_/" class="post-tags">
                            # Objective-C
                        </a>
                    
                </div>
                <div class="post-content">
                    <h1 id="objective-cä¸­çš„blockè¯­æ³•">Objective-Cä¸­çš„blockè¯­æ³•</h1>
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>ä¹‹å‰å­¦ä¹ Obj-Cçš„æ—¶å€™ï¼Œçœ‹è¿‡ã€ŠObjective-Cé«˜çº§ç¼–ç¨‹ã€‹ï¼Œæ˜¯ä¸­æ–‡ç¿»è¯‘ç‰ˆçš„ï¼Œè¯»èµ·æ¥æ€»æ„Ÿè§‰å°‘äº†äº›å‘³é“ã€‚</p>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921191536098.png" alt="image-20210921191536098" style="zoom:67%;" />
<p>ä¸è¿‡ä½œè€…æ˜¯æ—¥æœ¬çš„ï¼ŒåŸç‰ˆæ—¥æ–‡æˆ‘æ›´çœ‹ä¸æ‡‚ï¼Œå¹¸å¥½è‹±æ–‡ç‰ˆçš„ç¿»è¯‘å¥½äº†å¾ˆå¤šï¼Œè€Œä¸”è‹±è¯­å…­çº§ä¹Ÿè¿‡äº†ğŸ¶ï¼Œè¿™æ¬¡çœ‹å¾—ä¸‹å»ã€‚Blockçš„çŸ¥è¯†åœ¨ç¬¬å››ç« å’Œç¬¬äº”ç« ã€‚</p>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921193334781.png" alt="image-20210921193334781" style="zoom:67%;" />
<p>æœ¬ç¯‡æ–‡ç« å¤§éƒ¨åˆ†å›¾ç‰‡ä¹Ÿæ˜¯ä»é‡Œé¢æ‘˜è¿‡æ¥çš„ã€‚</p>
<!-- more -->
<h2 id="blockç®€ä»‹">Blockç®€ä»‹</h2>
<h3 id="ç®€å•å›é¡¾ä¸€ä¸‹blockçš„ç”¨æ³•">ç®€å•å›é¡¾ä¸€ä¸‹Blockçš„ç”¨æ³•</h3>
<p><code>Block</code>å¯ä»¥ç®—æ˜¯å¯¹Cè¯­è¨€è¯­æ³•çš„ä¸€ç§æ‰©å±•ï¼Œå€ŸåŠ©ç»“æ„ä½“å’Œå‡½æ•°æŒ‡é’ˆçš„æŠ€æœ¯å³å¯å®ç°ã€‚å¦‚æœä½ å¯¹å‡½æ•°æŒ‡é’ˆæ¯”è¾ƒç†Ÿæ‚‰ï¼Œé‚£ä½ å¾ˆå®¹æ˜“ç†è§£<code>Block</code>ã€‚ä¸è¿‡è·Ÿå‡½æ•°æŒ‡é’ˆç¨å¾®æœ‰äº›åŒºåˆ«ï¼Œå‡½æ•°æŒ‡é’ˆéœ€è¦å¯¹åº”å‡½æ•°çš„å‡½æ•°åï¼Œä½†æ˜¯Blockä¸éœ€è¦ï¼Œå®ƒåªè¦ä¸€ä¸ªåŒ¿åå‡½æ•°å³å¯ã€‚</p>
<p>åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥çœ‹ä»£ç ï¼š</p>
<pre><code class="language-objc">int main() {
	(void)(^blk_t)(void) = ^void (void) {
		printf(&quot;Hello world.&quot;);
	};
}
</code></pre>
<p>è¿™é‡Œçš„<code>blk_t</code>å°±æ˜¯å­˜æ”¾Blockçš„å˜é‡ï¼Œé€šè¿‡<code>blk_t()</code>å°±å¯ä»¥æ‰§è¡Œè¿™ä¸ªBlockï¼Œè¾“å‡ºHello worldã€‚å£°æ˜Blockå˜é‡çš„æ–¹å¼è·Ÿå£°æ˜å‡½æ•°æŒ‡é’ˆæœ‰ç‚¹åƒï¼Œçœ‹èµ·æ¥å°±æ˜¯æŠŠ*æ¢æˆäº†^ã€‚Blockçš„åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š</p>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921194833343.png" alt="image-20210921194833343" style="zoom: 50%;" />
<p>å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡æœ‰å‚æ•°åˆ—è¡¨ï¼Œåˆ™å¯ä»¥è¿›ä¸€æ­¥çœç•¥ã€‚</p>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921195017730.png" alt="image-20210921195017730" style="zoom:50%;" />
<p>Blockå†…éƒ¨å¯ä»¥ä½¿ç”¨å¤–é¢çš„å±€éƒ¨å˜é‡ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬é™æ€å˜é‡ã€å…¨å±€å˜é‡ç­‰ã€‚ä½†æ˜¯è¿™ä¸ªä½¿ç”¨çš„å˜é‡çš„å€¼åªæ˜¯åœ¨Blockåˆ›å»ºé‚£ä¸€åˆ»å¤åˆ¶çš„ï¼Œåé¢ä¿®æ”¹æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œè€Œä¸”ä½ ä¹Ÿä¸èƒ½åœ¨Blockå†…éƒ¨å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œä¿®æ”¹ã€‚</p>
<pre><code class="language-objc">int main() {
	int val = 10;
	(void)(^blk_t)(void) = ^void (void) {
		printf(&quot;value is :%d&quot;, val);
	};
	val = 2222;
	blk_t();
}
</code></pre>
<p>æ­¤æ—¶è¾“å‡ºä¸º<code>value is 10</code></p>
<p>è¦æƒ³åœ¨Blockå†…éƒ¨ä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œåªéœ€è¦åœ¨å˜é‡å‰åŠ ä¸Š<code>__block</code>å³å¯ï¼Œå˜æˆ<code>__block int val = 10;</code>ã€‚æˆ–è€…è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡æŒ‡é’ˆï¼Œå°±å¥½æ¯”è°ƒç”¨å‡½æ•°æ—¶çš„å®å‚å’Œå½¢å‚ï¼Œä¼ çš„å‚æ•°æ˜¯æŒ‡é’ˆå°±å¯ä¿®æ”¹åˆ°å¯¹åº”çš„æ•°å€¼ã€‚</p>
<pre><code class="language-objc">int main() {
	int val = 10;
	int *p = &amp;val;
	(void)(^blk_t)(void) = ^void (void) {
	  *p = 2222;
	};
	printf(&quot;value is :%d&quot;, val);
	blk_t();
  printf(&quot;value is :%d&quot;, val);
}
</code></pre>
<p>æŒ‡é’ˆçš„è¿™ç§æ–¹å¼ï¼Œåªè¦ä½ ä¸åœ¨Blockå†…éƒ¨ä¿®æ”¹å˜é‡pçš„å€¼å°±ä¸ä¼šæŠ¥é”™ï¼Œè‡³äºä¿®æ”¹å˜é‡pæŒ‡å‘çš„å†…å­˜ï¼Œåˆ™æ— æ‰€è°“ã€‚åŒç†å¯å¾—ä¸‹é¢è¿™ç§ä¹Ÿæ˜¯æ­£ç¡®çš„ï¼š</p>
<pre><code class="language-objc">int main() {
	id array = [[NSMutableArray alloc] init];
	(void)(^blk_t)(void) = ^void (void) {
	  id obj = [[NSObject alloc] init];
    [array addObject:obj];
	};
	blk_t();
}
</code></pre>
<h3 id="blockçš„å®ç°åŸç†">Blockçš„å®ç°åŸç†</h3>
<p>å€ŸåŠ©Clangï¼Œæˆ‘ä»¬å¯ä»¥å°†OCçš„ä»£ç è½¬æ¢ä¸ºC++ä»£ç ï¼Œä»è€Œçœ‹åˆ°Blockåœ¨Cå±‚é¢ä¸Šæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p><code>clang -rewrite-objc filename.m</code></p>
<blockquote>
<p>åé¢å¦‚æœä»£ç å«æœ‰<code>__weak</code>ï¼Œåˆ™éœ€è¦è¡¥å……å¤šå‡ ä¸ªå‚æ•°</p>
<p><code>clang -rewrite-objc -fobjc-arc -fobjc-runtime=ios-14.0.0 filename.m</code></p>
</blockquote>
<h4 id="ç¬¬ä¸€ç»„ä½¿ç”¨å±€éƒ¨å˜é‡ä½†æ˜¯ä¸ä½¿ç”¨__block">ç¬¬ä¸€ç»„ï¼ˆä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œä½†æ˜¯ä¸ä½¿ç”¨<code>__block</code>ï¼‰</h4>
<p>æºä»£ç </p>
<pre><code class="language-objc">#import &lt;Foundation/Foundation.h&gt;
int main() {
    int val = 10;
    void (^blk)(void) = ^ {
        printf(&quot;val:%d&quot;, val);
    };
    blk();
    return 0;
}
</code></pre>
<p>clangè½¬æ¢åçš„ä»£ç ï¼ˆçœç•¥ä¸€äº›æ— å…³çš„ï¼Œéƒ½æ˜¯importå¸¦æ¥çš„ä¸œè¥¿...ï¼‰</p>
<pre><code class="language-c++">struct __block_impl {
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
};

struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  int val;
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _val, int flags=0) : val(_val) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  int val = __cself-&gt;val; // bound by copy
  printf(&quot;val:%d&quot;, val);
}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};

int main() {
    int val = 10;
    void (*blk)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, val));
    ((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);
    return 0;
}
</code></pre>
<p>ç¬¬ä¸€æ¬¡çœ‹èµ·æ¥ç¡®å®æœ‰ç‚¹å¤´ç–¼ï¼Œä¸è¿‡ä¹¦ä¸­è®²çš„ä¹Ÿæ¯”è¾ƒè¯¦ç»†ï¼Œå¤šçœ‹å‡ éå°±å¥½äº†ã€‚</p>
<p>çœ‹åˆ°ç»“æ„ä½“<code>__main_block_impl_0</code>ï¼Œè¿™å°±æ˜¯Blockåœ¨Cå±‚é¢ä¸‹çš„é¢ç›®äº†ã€‚é‡Œé¢æœ‰ä¸ªå­—æ®µ<code>val</code>ï¼Œé€šè¿‡æ„é€ å‡½æ•°ä¼ é€’è¿‡æ¥çš„<code>_val</code>è¿›è¡Œèµ‹å€¼ã€‚</p>
<p>è€ŒåŸæœ¬blockçš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°è¢«æ”¾åˆ°å‡½æ•°<code>__main_block_func_0</code>é‡Œé¢å»äº†ï¼Œè€Œä¸”é‡Œé¢çš„<code>val</code>ä¹Ÿä¸æ˜¯åŸå…ˆçš„å±€éƒ¨å˜é‡çš„ï¼Œå°±æ˜¯ç»“æ„ä½“è‡ªå·±çš„å˜é‡è€Œå·²ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆå±€éƒ¨å˜é‡çš„å€¼æ”¹äº†ï¼ŒBlockæ‰§è¡Œçš„è¾“å‡ºç¡®è¿˜æ˜¯ä¹‹å‰çš„ï¼Œå› ä¸ºè¿™å·²ç»æ˜¯ä¸¤ä¸ªä¸åŒçš„å˜é‡äº†ã€‚</p>
<h4 id="ç¬¬äºŒç»„ä½¿ç”¨__block">ç¬¬äºŒç»„ï¼ˆä½¿ç”¨<code>__block</code>ï¼‰</h4>
<p>æºä»£ç </p>
<pre><code class="language-objc">#import &lt;Foundation/Foundation.h&gt;
int main() {
    __block int val = 10;
    void (^blk)(void) = ^ {
        val = 222;
    };
    printf(&quot;val:%d&quot;, val);
    blk();
    printf(&quot;val:%d&quot;, val);
    return 0;
}
</code></pre>
<p>clangè½¬æ¢åçš„ä»£ç </p>
<pre><code class="language-c++">struct __block_impl {
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
};

struct __Block_byref_val_0 {
  void *__isa;
	__Block_byref_val_0 *__forwarding;
 	int __flags;
 	int __size;
 	int val;
};

struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  __Block_byref_val_0 *val; // by ref
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, __Block_byref_val_0 *_val, int flags=0) : val(_val-&gt;__forwarding) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  __Block_byref_val_0 *val = __cself-&gt;val; // bound by ref
	(val-&gt;__forwarding-&gt;val) = 222;
}

static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {
  _Block_object_assign((void*)&amp;dst-&gt;val, (void*)src-&gt;val, 8/*BLOCK_FIELD_IS_BYREF*/);
}

static void __main_block_dispose_0(struct __main_block_impl_0*src) {
  _Block_object_dispose((void*)src-&gt;val, 8/*BLOCK_FIELD_IS_BYREF*/);
}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);
  void (*dispose)(struct __main_block_impl_0*);
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0};

int main() {
    __attribute__((__blocks__(byref))) __Block_byref_val_0 val = {(void*)0,(__Block_byref_val_0 *)&amp;val, 0, sizeof(__Block_byref_val_0), 10};
    void (*blk)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_val_0 *)&amp;val, 570425344));
    printf(&quot;val:%d&quot;, (val.__forwarding-&gt;val));
    ((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);
    printf(&quot;val:%d&quot;, (val.__forwarding-&gt;val));
    return 0;
}
</code></pre>
<p>ä»£ç åˆå¤æ‚äº†ä¸€äº›ï¼Œå…¶å®ä¸»è¦æ˜¯å¤šäº†ä¸€ä¸ªç»“æ„ä½“<code>__Block_byref_val_0</code>ï¼Œç»†çœ‹è¿™ä¸ªç»“æ„ä½“ï¼Œä½ ä¼šå‘ç°å®ƒè®°å½•äº†ä¹‹å‰å±€éƒ¨å˜é‡çš„å€¼ã€‚æ‰€ä»¥<code>__block</code>åŸºæœ¬ä¸Šå°±æŠŠå˜é‡åŒ…è£…æˆä¸€ä¸ªç»“æ„ä½“äº†ã€‚</p>
<p>å¯¹<code>val</code>çš„è®¿é—®å°±å˜æˆäº†<code>val.__forwarding-&gt;val</code>ï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¸ª<code>__forwarding</code>,è¿™ä¸»è¦å› ä¸ºBlockå¯ä»¥åœ¨æ ˆã€å †ã€å…¨å±€ä¸Šï¼Œå…·ä½“ç»†èŠ‚çœ‹ä¹¦ã€‚</p>
<h3 id="å…³äºblockå†…éƒ¨å¯¹å˜é‡çš„è¯»å†™">å…³äºBlockå†…éƒ¨å¯¹å˜é‡çš„è¯»å†™</h3>
<p>å‰é¢æˆ‘ä»¬çŸ¥é“å¯é€šè¿‡æ·»åŠ <code>__block</code>å®ç°ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›æƒ…å†µæ˜¯ä¸éœ€è¦çš„ã€‚</p>
<p>æ¯”å¦‚å½“ä½ è¿™ä¸ªå˜é‡æ˜¯å…¨å±€å˜é‡ã€é™æ€å…¨å±€å˜é‡ã€é™æ€å±€éƒ¨å˜é‡ï¼Œä¸éœ€è¦åœ¨å˜é‡åå‰å¢åŠ ä¿®é¥°ç¬¦ä¹Ÿå¯ä»¥è¯»å†™ã€‚</p>
<p>å‰ä¸¤ä¸ªå®¹æ˜“ç†è§£ï¼Œå› ä¸ºBlockæœ€ç»ˆè¿˜æ˜¯è½¬æ¢æˆå‡½æ•°ï¼Œåœ¨å‡½æ•°å†…éƒ¨è®¿é—®å…¨å±€å˜é‡æ˜¯OKçš„ï¼ŒBlockç»“æ„ä½“ä¸ç”¨æ–°å¢ä»€ä¹ˆå­—æ®µï¼›</p>
<p>é™æ€å±€éƒ¨å˜é‡åˆ™å¤šäº†äº›å·¥ä½œé‡ï¼Œé€šè¿‡clangè½¬æ¢ä»£ç åï¼Œå‘ç°Blockçš„ç»“æ„ä½“å†…éƒ¨ä¼šæœ‰ä¸€ä¸ªæŒ‡é’ˆå˜é‡æŒ‡å‘è¿™ä¸ªé™æ€å±€éƒ¨å˜é‡ã€‚</p>
<h3 id="å¾ªç¯å¼•ç”¨">å¾ªç¯å¼•ç”¨</h3>
<p>å‰é¢æˆ‘ä»¬åœ¨Blockä¸­ç”¨çš„éƒ½æ˜¯ä¸€äº›åŸºç¡€æ•°æ®ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨objectçš„ä¼šæ€æ ·å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ä¼šé€ æˆå¾ªç¯å¼•ç”¨ã€‚æ¯”å¦‚ä¸‹é¢è¿™ç§å†™æ³•</p>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921210540085.png" alt="image-20210921210540085" style="zoom: 67%;" />
<p>æˆ‘ä»¬çœ‹çœ‹Clangè½¬æ¢åçš„ä»£ç ï¼Œå…¶ä¸­å¸¦ä¸Šäº†<code>__strong</code>æ ‡è®°ï¼Œå¼•ç”¨è®¡æ•°+1</p>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921210517036.png" alt="image-20210921210517036" style="zoom: 50%;" />
<p>åœ¨å‰é¢åŠ ä¸Š<code>__block</code>ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯å¼ºå¼•ç”¨</p>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921210917823.png" alt="image-20210921210917823" style="zoom: 50%;" />
<p>è§£å†³æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ”¹ä¸ºå¼±å¼•ç”¨å³å¯</p>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921211111472.png" alt="image-20210921211111472" style="zoom: 67%;" />
<hr>
<h4 id="è¡¥å……ä¸€">è¡¥å……ä¸€</h4>
<p>å®é™…å¼€å‘ä¸­ä¸€èˆ¬é‡åˆ°çš„æ˜¯ä¸‹é¢è¿™ç§æƒ…å†µï¼Œä¸€ä¸ªObjectå¯¹è±¡æœ‰ä¸€ä¸ªå±æ€§Blockï¼Œç›¸äº’æŒæœ‰ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921211551509.png" alt="image-20210921211551509" loading="lazy"></figure>
<p>æˆ–è€…æŠŠselfç”¨<code>__block</code>ä¿®é¥°ï¼Œå½¢æˆä¸‹é¢è¿™ç§å¾ªç¯å¼•ç”¨ã€‚</p>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921212056815.png" alt="image-20210921212056815" style="zoom: 50%;" />
<p>è¿™ç§æ¯”è¾ƒæœ‰æ„æ€ï¼Œä½ å¯ä»¥åœ¨Blockå†…éƒ¨ç‰¹å®šæ—¶æœºå°†<code>__block variable</code>é‡Šæ”¾ï¼Œä»è€Œè§£é™¤å¾ªç¯å¼•ç”¨ï¼Œè¿™ç§ç”¨æ³•æ¯”è¾ƒé«˜çº§ã€‚</p>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com/image-20210921212317578.png" alt="image-20210921212317578" style="zoom:50%;" />
<h4 id="è¡¥å……äºŒ">è¡¥å……äºŒ</h4>
<p>ä¸€èˆ¬åœ¨Blockå‰ä½¿ç”¨__weakå°±å¯ä»¥äº†ï¼Œä½†æ˜¯å¯¹äºè®¿é—®æˆå‘˜å˜é‡å´è¡Œä¸é€šï¼Œè€Œä¿®æ”¹æˆå‘˜å˜é‡ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡æŒ‡é’ˆæ“ä½œã€‚</p>
<pre><code class="language-objc">__weak typeof(self) weakSelf = self;
blk = ^(id obj) {
	weakSelf.money = 100000;
	weakSelf-&gt;height = 222;
};
</code></pre>
<p>è¿™é‡Œç¬¬äºŒå¥<code>weakSelf-&gt;height = 222;</code>ç¼–è¯‘å™¨ä¼šæç¤ºé”™è¯¯ï¼Œå› ä¸ºweakSelfæœ‰å¯èƒ½å˜æˆnilï¼Œä¼šå¯¼è‡´éæ³•çš„å†…å­˜è®¿é—®ã€‚</p>
<blockquote>
<p>å¦ä¸€ç§ä¿®æ”¹æˆå‘˜å˜é‡çš„æ–¹æ³•æ˜¯é€šè¿‡<code>__block</code>çš„æ–¹å¼</p>
</blockquote>
<p>ä¹Ÿä¸ºäº†é˜²æ­¢Blockæ‰§è¡Œè¿‡ç¨‹ä¸­selfçªç„¶é‡Šæ”¾äº†ï¼Œåœ¨Blockä¸­ä¸€èˆ¬ä¼šå…ˆå¼ºå¼•ç”¨ä¸€ä¸‹selfï¼Œè€Œç¦»å¼€äº†Blockä½œç”¨åŸŸï¼Œå¼ºå¼•ç”¨è‡ªç„¶æ¶ˆå¤±äº†ï¼›</p>
<pre><code class="language-objc">__weak typeof(self) weakSelf = self;
blk = ^(id obj) {
  __strong typeof(self) strongSelf = weakSelf;
	strongSelf.money = 100000;
	strongSelf-&gt;height = 222;
};
</code></pre>
<p>ä¸è¿‡ä¸Šé¢è¿™ç§ä¹Ÿæœ‰ä¸€å®šæ¦‚ç‡crashï¼Œå³æœ‰å¯èƒ½strongSelfæ˜¯nilï¼›</p>
<p>æ¯”å¦‚å½“Blockæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡çš„æ—¶å€™ï¼Œè€ŒObjectç”Ÿå‘½å‘¨æœŸå…ˆç»“æŸå˜æˆnilï¼Œæ­¤æ—¶å†æ‰§è¡ŒBlockå°±ä¼šcrashã€‚å¦‚æœBlockæ˜¯Objectçš„ä¸€ä¸ªå±æ€§æˆ–æˆå‘˜å˜é‡ï¼Œä¹Ÿä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å¦å¤–ï¼Œåœ¨å¼€å‘ä¸­ä¸€èˆ¬ä¹Ÿä¸ä¼šå»å†™è¿™ä¹ˆé•¿çš„weakSelfå’ŒstrongSelfï¼Œæˆ‘ä»¬æ˜¯å¸Œæœ›ç›´æ¥ç”¨selfã€‚(æ¯”å¦‚ä½ çµæœºä¸€åŠ¨ï¼Œæƒ³ä»å…¶ä»–åœ°æ–¹copyä¸€ä»½ä»£ç ç›´æ¥æ”¾åˆ°Blockï¼Œç»“æœå‘ç°å¾—ä¸€æ­¥æ­¥æŠŠselfæ›¿æ¢æˆstrongSelfï¼Œè¿‡ç¨‹ç›¸å½“ç—›è‹¦ğŸ˜–)</p>
<p>è¿™éƒ¨åˆ†å†…å®¹RACæœ‰ç›¸å…³çš„å®ç°ï¼Œé€šè¿‡@weakify(self)å’Œ@strongify(self)ã€‚è¿™é‡Œæˆ‘ç®€åŒ–äº†ä¸€ä¸‹å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-objc">#define weakify(VAR) __weak typeof(VAR) _weak_ = VAR;
#define strongify(VAR) __strong typeof(VAR) VAR = _weak_;

//ä½¿ç”¨å®å®šä¹‰åçš„æ•ˆæœ
weakify(self);
blk = ^(id obj) {
  strongify(self);
	self.money = 100000;
	self-&gt;height = 222;
};
</code></pre>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="https://jayying007.github.io/post/iosæ’­æ”¾åŠ¨æ€å›¾/" class="post-title gt-a-link">
                    iosæ’­æ”¾åŠ¨æ€å›¾
                </a>
            </div>
        

        

        

        
            <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: 'JHsf6kk7u31nFtmMMtWqQyHl-gzGzoHsz',
		appKey: '6kuh7BaduW3qYuq5MUi7KaTm',
		avatar: '',
		pageSize: 5,
		recordIp: true,
		placeholder: 'Just Go Go',
		visitor: false,
	});
</script>

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"></div>
    <div class="social-container">
        
            
                <a href="https://github.com/jayying007" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        
    </div>
    <div>
        Theme <a href="https://github.com/imhanjie/gridea-theme-pure" target="_blank">Pure</a>, Powered by <a
                href="https://gridea.dev" target="_blank">Gridea</a> | <a href="https://jayying007.github.io/atom.xml" target="_blank">RSS</a>
    </div>
</div>

<script>
  hljs.highlightAll()
</script>

    </div>
</div>
</body>
</html>
