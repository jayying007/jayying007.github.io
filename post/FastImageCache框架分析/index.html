<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>FastImageCacheæ¡†æ¶åˆ†æ | å½±å¸çš„ç½‘ç»œæ—¥å¿—</title>

<link rel="shortcut icon" href="https://jayying007.github.io/favicon.ico?v=1750777237119">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://jayying007.github.io/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages//dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-T5DQK64QPQ-G"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-T5DQK64QPQ-G');
</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
    
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            å½±å¸çš„ç½‘ç»œæ—¥å¿—
        </div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" id="changeNavbar">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    é¦–é¡µ
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    å½’æ¡£
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    æ ‡ç­¾
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/about" class="menu gt-a-link">
                    å…³äº
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1750777237119"
                action="/search/">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* ç§»åŠ¨ç«¯å¯¼èˆªæ å±•å¼€/æ”¶èµ·åˆ‡æ¢ */
    document.getElementById('changeNavbar').onclick = () => {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    FastImageCacheæ¡†æ¶åˆ†æ
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2023-05-14 Â·
                    </time>
                    
                        <a href="https://jayying007.github.io/tag/Jyshrk607hz/" class="post-tags">
                            # æºç 
                        </a>
                    
                        <a href="https://jayying007.github.io/tag/E1Ls79mZbIj/" class="post-tags">
                            # å›¾åƒ
                        </a>
                    
                        <a href="https://jayying007.github.io/tag/x2NFXhFTQ7x/" class="post-tags">
                            # ç¼“å­˜
                        </a>
                    
                </div>
                <div class="post-content">
                    <p><a href="https://github.com/path/FastImageCache">https://github.com/path/FastImageCache</a></p>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>FastImageCahce é¡¾åæ€ä¹‰ï¼Œç”¨äºå›¾åƒç¼“å­˜ã€‚<br>
ä¼ ç»Ÿçš„å›¾åƒåŠ è½½æ€§èƒ½æ¯”è¾ƒä½ï¼Œåœ¨åˆ—è¡¨æ»šåŠ¨åœºæ™¯ä¸‹ç‰¹åˆ«å®¹æ˜“æ‰å¸§ã€‚è€Œ FastImageCache å°±æ˜¯ä¸“é—¨é’ˆå¯¹åˆ—è¡¨æ»šåŠ¨åœºæ™¯åšçš„æ€§èƒ½ä¼˜åŒ–ã€‚<br>
å¯¹äºä¸¤è€…çš„æ€§èƒ½å¯¹æ¯”ï¼Œä½ å¯ä»¥å‚è€ƒå®˜æ–¹çš„ Demo å·¥ç¨‹å»æ„Ÿå—ä¸€ä¸‹ã€‚</p>
<h2 id="å›¾åƒåŠ è½½æµç¨‹">å›¾åƒåŠ è½½æµç¨‹</h2>
<ol>
<li>+[UIImage imageWithContentsOfFile:]é€šè¿‡ Image I/O æ¥å£åˆ›å»ºäº†ä¸€ä¸ª<code>CGImageRef</code>ï¼Œè¿™ä¸ªæ—¶å€™å›¾åƒè¿˜æ²¡æœ‰è§£ç ã€‚è€Œä¸”åˆ©ç”¨å†…å­˜æ˜ å°„ï¼Œæ•°æ®ä¹Ÿæ²¡åŠ åˆ°å†…å­˜ä¸­ã€‚</li>
<li>å°†å¾—åˆ°çš„å›¾åƒèµ‹å€¼åˆ° UIImageView ä¸­ã€‚</li>
<li>CATransaction æ•æ‰åˆ° Layer Tree å‘ç”Ÿå˜æ›´ã€‚</li>
<li>åœ¨ä¸‹ä¸€ä¸ª RunLoop ä¸­ï¼ŒCore Animation æäº¤è¯¥ CATransactionï¼Œæ ¹æ® UIImage è§£ç ä¸å¦ï¼Œä¼šæœ‰ä»¥ä¸‹æ­¥éª¤ï¼š
<ol>
<li>åˆ†é… Buffer ç”¨äºè§£ç ç›¸å…³æ“ä½œ</li>
<li>å°†æ•°æ®ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­</li>
<li><strong>è§£ç å›¾ç‰‡æˆä½å›¾ï¼Œè¿™ä¸ªè¿‡ç¨‹å‘ç”Ÿåœ¨ CPU</strong></li>
<li>å¾—åˆ°çš„ä½å›¾ä¼šè¢« Core Animation ç”¨äºæ¥ä¸‹æ¥çš„æ¸²æŸ“</li>
</ol>
</li>
</ol>
<h2 id="fastimagecache-å¦‚ä½•ä¼˜åŒ–çš„">FastImageCache å¦‚ä½•ä¼˜åŒ–çš„</h2>
<h3 id="å†…å­˜æ˜ å°„">å†…å­˜æ˜ å°„</h3>
<p>å¦‚æœæ¯å¼ å›¾ç‰‡éƒ½å­˜åœ¨ä¸åŒçš„ä½ç½®ï¼Œé‚£ä¹ˆå°†å®ƒä»¬ä»ç£ç›˜è¯»åˆ°å†…å­˜ä¸­å°±ä¼šæ¶‰åŠå¤šæ¬¡ IOã€‚<br>
FastImageCache åˆ™å°†å®ƒä»¬éƒ½å­˜åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶ååˆ©ç”¨ mmap æŠ€æœ¯ï¼Œä½ éœ€è¦è¯»å–å“ªå¼ å›¾ç‰‡ï¼Œå°±ä¼šåœ¨å¸¸é‡æ—¶é—´å†…è®¡ç®—å‡ºå…¶ä½ç½®ï¼Œç„¶åè¯»å–ã€‚<br>
è¿™ç§æŠ€æœ¯ä¼¼ä¹åœ¨ 2D æ¸¸æˆè´´å›¾ä¸­è¿˜æŒºå¸¸ç”¨çš„ã€‚</p>
<h3 id="è§£ç æ•°æ®">è§£ç æ•°æ®</h3>
<p>FastImageCache å­˜åˆ°æ–‡ä»¶ä¸­çš„éƒ½æ˜¯å·²ç»è§£ç çš„æ•°æ®ï¼Œæ‰€ä»¥åç»­ä¸å†éœ€è¦è§£ç ã€‚<br>
å½“ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå…¸å‹çš„ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ã€‚</p>
<h3 id="å­—èŠ‚å¯¹é½">å­—èŠ‚å¯¹é½</h3>
<p>Core Animation åœ¨æäº¤å›¾åƒæ•°æ®æ—¶ï¼Œå¦‚æœå…¶æ²¡æœ‰å­—èŠ‚å¯¹é½ï¼Œåˆ™ä¼šè§¦å‘ä¸€æ¬¡æ‹·è´è¿›è¡Œå¯¹é½ã€‚<br>
ä¸€ä¸ªåˆé€‚çš„å¯¹é½æ•°å€¼æ˜¯å›¾ç‰‡æ¯è¡Œçš„å­—èŠ‚æ•°è¦å¯¹é½<code>8 pixels x bytes per pixel</code>ï¼Œå¯¹äºå¸¸è§çš„ ARGB å›¾ç‰‡ï¼Œå°±æ˜¯ 64ã€‚</p>
<h2 id="fastimagecache-å¦‚ä½•è®¾è®¡çš„">FastImageCache å¦‚ä½•è®¾è®¡çš„</h2>
<p>å‰é¢æåˆ°æŠŠæ‰€æœ‰å›¾ç‰‡æ•°æ®éƒ½å­˜åˆ°åŒä¸€ä¸ªæ–‡ä»¶ä¸Šï¼Œå¤§æ¦‚é•¿è¿™ä¹ˆä¸ªæ ·å­ï¼š<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FjvQjPRjng0ERlGC011wEPKmr6QP.png" alt="" loading="lazy"></p>
<p>ä½†æ˜¯å…‰æœ‰è¿™ä¸ªæ–‡ä»¶è¿˜ä¸å¤Ÿï¼Œæ¯”å¦‚ä½ ä¸çŸ¥é“ç¬¬ä¸‰å¼ å›¾ç‰‡çš„åç§»é‡ï¼Œä¹Ÿä¸çŸ¥é“å›¾ç‰‡å¯¹åº”çš„æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚<br>
è§£å†³å›¾ç‰‡åç§»é‡çš„é—®é¢˜ï¼ŒFastImageCache æ˜¯<strong>é™åˆ¶äº†æ¯ä¸€å¼ å›¾ç‰‡éƒ½æ˜¯ä¸€æ ·çš„å¤§å°</strong>ï¼ŒåŒ…æ‹¬å›¾ç‰‡çš„æ¸²æŸ“æ ¼å¼ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ ImageFormat ä¸­ã€‚çŸ¥é“å›¾ç‰‡çš„å¤§å°ï¼Œè®¡ç®—åç§»é‡å°±ç®€å•å¤šäº†ã€‚<br>
è§£å†³å›¾ç‰‡æ˜¯ä»€ä¹ˆçš„é—®é¢˜ï¼Œè‡ªç„¶æ˜¯è¦ç»™æ¯ä¸ªå›¾ç‰‡åˆ†é…ä¸€ä¸ª UUIDï¼Œä»£ç ä¸­æ¯ä¸ªå›¾ç‰‡æ¨¡å‹éƒ½æ˜¯ FICEntity</p>
<pre><code class="language-objectivec">@protocol FICEntity &lt;NSObject&gt;
/**
 A string that uniquely identifies this entity.

 @discussion Within each image table, each entry is identified by an entity's UUID. Ideally, this value should never change for an entity. For example, if your entity class is a person
 model, its UUID might be an API-assigned, unchanging, unique user ID. No matter how the properties of the person change, its user ID should never change.
 */
@property (nonatomic, copy, readonly) NSString *fic_UUID;
@end
</code></pre>
<p>å¦å¤–è¿˜è¦è®°å½•å“ªä¸ª UUID æ˜¯æ–‡ä»¶çš„ç¬¬å‡ ä¸ªå›¾ç‰‡ï¼Œè¿™éƒ¨åˆ†ä¿¡æ¯è¢«è®°å½•åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç§°ä¸º Meta æ–‡ä»¶ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FiuQ7K8D94BId6xiWS-44B1hQCcH.png" alt="" loading="lazy"></p>
<p>æ€»ä½“ä¸Šçœ‹ï¼Œæ¯ä¸ª ImageFormat å¯¹åº”ä¸€ç§å›¾ç‰‡æ ¼å¼çš„æ–‡ä»¶å­˜å‚¨ï¼Œä»£ç ä¸­ç”¨ ImageTable ç»´æŠ¤æ¯ä¸ªå›¾ç‰‡æ–‡ä»¶ã€‚<br>
ç¼“å­˜çš„æ¥å£æ— éå°±æ˜¯ CRUD é‚£ä¸€å¥—ã€‚</p>
<pre><code class="language-objectivec">/**
 `FICImageTable` is the primary class that efficiently stores and retrieves cached image data. Image tables are defined by instances of `&lt;FICImageFormat&gt;`. Each image table is backed by a single
 file on disk that sequentially stores image entry data. All images in an image table are either opaque or not and have the same dimensions. Therefore, when defining your image formats, keep in
 mind that you cannot mix image dimensions or whether or not an image is opaque.
 */
@interface FICImageTable : NSObject

///------------------------------------------------
/// @name Storing, Retrieving, and Deleting Entries
///------------------------------------------------

/**
 Stores new image entry data in the image table.

 @param entityUUID The UUID of the entity that uniquely identifies an image table entry. Must not be `nil`.

 @param sourceImageUUID The UUID of the source image that represents the actual image data stored in an image table entry. Must not be `nil`.

 @param imageDrawingBlock The drawing block provided by the entity that actually draws the source image into a bitmap context. Must not be `nil`.

 @discussion Objects conforming to `&lt;FICEntity&gt;` are responsible for providing an image drawing block that does the actual drawing of their source images to a bitmap context provided
 by the image table. Drawing in the provided bitmap context writes the uncompressed image data directly to the image table file on disk.

 @note If any of the parameters to this method are `nil`, this method does nothing.

 @see [FICEntity drawingBlockForImage:withFormatName:]
 */
- (void)setEntryForEntityUUID:(NSString *)entityUUID sourceImageUUID:(NSString *)sourceImageUUID imageDrawingBlock:(FICEntityImageDrawingBlock)imageDrawingBlock;

/**
 Returns a new image from the image entry data in the image table.

 @param entityUUID The UUID of the entity that uniquely identifies an image table entry. Must not be `nil`.

 @param sourceImageUUID The UUID of the source image that represents the actual image data stored in an image table entry. Must not be `nil`.

 @param preheatData A `BOOL` indicating whether or not the entry's image data should be preheated. See `&lt;[FICImageTableEntry preheat]&gt;` for more information.

 @return A new image created from the entry data stored in the image table or `nil` if something went wrong.

 @discussion The `UIImage` returned by this method is initialized by a `CGImageRef` backed directly by mapped file data, so no memory copy occurs.

 @note If either of the first two parameters to this method are `nil`, the return value is `nil`.

 @note If either the entity UUID or the source image UUID doesn't match the corresponding UUIDs in the entry data, then something has changed. The entry data is deleted for the
 provided entity UUID, and `nil` is returned.
 */
- (nullable UIImage *)newImageForEntityUUID:(NSString *)entityUUID sourceImageUUID:(NSString *)sourceImageUUID preheatData:(BOOL)preheatData;

/**
 Deletes image entry data in the image table.

 @param entityUUID The UUID of the entity that uniquely identifies an image table entry. Must not be `nil`.

 @note If `entityUUID` is `nil`, this method does nothing.
 */
- (void)deleteEntryForEntityUUID:(NSString *)entityUUID;

@end
</code></pre>
<p>è¿™é‡Œç›´æ¥ä» Bang å“¥é‚£é‡Œæ¬å¼ å›¾è¿‡æ¥<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FjgUmgRTfNalj1Hei9isgz-VSaGz.png" alt="" loading="lazy"></p>
<p>å› ä¸ºé‡‡ç”¨äº† mmap æŠ€æœ¯ï¼Œæ‰€ä»¥æ¯å¼ å›¾ç‰‡çš„æ•°æ®å¤§å°éƒ½æ˜¯ page size align çš„ã€‚<br>
ImageTable å¹¶ä¸ç›´æ¥åŒ…å« Entryï¼Œè€Œæ˜¯åœ¨ä¸­é—´åŠ äº†ä¸€å±‚ Chunkã€‚è¿™ä¸ª Chunk æ˜¯æ¯æ¬¡è¿è¡Œæ—¶åˆ›å»ºçš„ï¼Œæ‰€ä»¥ä¸€ä¸ª Chunk çš„å¤§å°ã€åŒ…å«å¤šå°‘ Entry ä½ éƒ½å¯ä»¥éšæ„è®¾ç½®ã€‚<br>
mmap çš„ç²’åº¦æ˜¯æ¯ä¸€ä¸ª Chunkï¼Œè¿™æ ·æ—¢ä¸ä¼šå¤ªå¤§ä¹Ÿä¸ä¼šå¤ªå°ï¼Œç›¸å½“çµæ´»ã€‚</p>
<h3 id="åŸºæœ¬æµç¨‹">åŸºæœ¬æµç¨‹</h3>
<p>è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹æ•´ä¸ª FastImageCache ä¸ App çš„å·¥ä½œæµç¨‹ã€‚</p>
<ol>
<li>
<p>App è¿›å…¥æŸä¸ªåˆ—è¡¨ï¼Œéœ€è¦æ˜¾ç¤ºå›¾ç‰‡ï¼Œæ‰€ä»¥è°ƒç”¨äº†<code>retrieveImageForEntity</code>ç›¸å…³æ¥å£è·å–å›¾ç‰‡ã€‚</p>
</li>
<li>
<p>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œæ­¤æ—¶è¿˜æ²¡æœ‰æ•°æ®ï¼Œåˆ™ FastImageCache ä¼šè¦æ±‚ App æä¾›åŸå§‹å›¾ç‰‡çš„æ•°æ®ã€‚</p>
<ol>
<li>æ‹¿åˆ°åŸå§‹å›¾ç‰‡åï¼Œæ¥ä¸‹æ¥éœ€è¦å¯»æ‰¾æ”¾åˆ°æ–‡ä»¶çš„å“ªä¸ªåœ°æ–¹åˆé€‚ã€‚å¦‚æœæ–‡ä»¶ä¸å¤Ÿæ”¾ï¼Œåˆ™éœ€è¦<code>ftruncate</code>æ‰©å±•ä¸€ä¸‹æ–‡ä»¶å¤§å°ã€‚æ­¤æ—¶ä¼šå¾—åˆ°ä¸€ä¸ª ImageTableEntryã€‚</li>
<li>æ ¹æ® ImageFormat çš„ä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ª Bitmapï¼Œç„¶åå°†å›¾ç‰‡ç»˜åˆ¶åˆ° ImageTableEntry å…¶ä¸­çš„ bytesï¼Œå…¶å®å°±æ˜¯å†™åˆ°æ–‡ä»¶ä¸­ã€‚</li>
</ol>
</li>
<li>
<p>æ ¹æ®<code>indexMap</code>æŸ¥è¯¢åˆ°å›¾ç‰‡ UUID å¯¹åº”åœ¨æ–‡ä»¶å“ªä¸ªä½ç½®ï¼Œåˆ›å»ºå¯¹åº”çš„ ImageTableEntryã€‚</p>
</li>
<li>
<p>å°†è¯¥ä½å›¾æ•°æ®è¯»å–å‡ºæ¥ï¼Œè¿”å›ç»™ App</p>
</li>
</ol>
<p>è¿™é‡Œä¸æƒ³è´´å¤ªå¤šä»£ç ï¼Œè‡ªè¡ŒæŸ¥é˜…ã€‚<br>
è§£ç å›¾ç‰‡æˆä½å›¾çš„é€»è¾‘å‚è€ƒä»¥ä¸‹æ–¹æ³•ï¼š<br>
<code>-[FICImageTable setEntryForEntityUUID:sourceImageUUID:imageDrawingBlock:]</code><br>
ä»å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­è¯»å–ä½å›¾çš„é€»è¾‘å‚è€ƒä»¥ä¸‹æ–¹æ³•ï¼š<br>
<code>-[FICImageTable newImageForEntityUUID:sourceImageUUID:preheatData:]</code></p>
<h2 id="æ³¨æ„ç‚¹-åæ§½">æ³¨æ„ç‚¹ &amp; åæ§½</h2>
<p>ImageFormat é™åˆ¶äº†å›¾ç‰‡çš„å¤§å°ç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥ FastImageCache é€‚ç”¨äºé‚£ç§æœ‰ç»Ÿä¸€å›¾åƒå¤§å°çš„åœºæ™¯ï¼Œæ¯”å¦‚èŠå¤©å¤´åƒã€ç›¸å†Œã€‚</p>
<p>_sourceImageMap æ²¡çœ‹åˆ°æœ‰ä»€ä¹ˆä½œç”¨ï¼Œå¯èƒ½æ˜¯ä¸ªé—ç•™ä»£ç ã€‚</p>
<p>ImageTable ä¸­çš„_imageLength å’Œ Entry ä¸­çš„ imageLength æ˜¯ä¸ç›¸ç­‰çš„ï¼Œå‰è€…æ˜¯å‡†ç¡®çš„æ•°å€¼ï¼Œåè€…ç”±äº page size alignï¼Œç®—å‡ºæ¥çš„ä¸æ˜¯å‡†ç¡®çš„ã€‚è™½ç„¶ä¸å½±å“ä½¿ç”¨ã€‚</p>
<p>ImageTable é‡Œé¢ç”¨äº†ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„æ•°æ®ç»“æœï¼Œçœ‹äº†å¥½å‡ éä»£ç æ‰çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€ã€‚<br>
æ¯”å¦‚_indexNumbers ç¼“å­˜äº† index çš„ NSNumber è¡¨ç¤ºï¼Œç”¨æ¥**@synchronized**åŠ é”ï¼Œé¿å…æ¯æ¬¡é‡æ–°ç”Ÿæˆ NSNumber å˜äº†ã€‚æœ‰ HashMap é”è¡¨å¤´é‚£å‘³äº†ï½<br>
_inUseEntries ä»£è¡¨å“ªä¸ª Entry æ­£åœ¨ä½¿ç”¨ï¼Œå‘ç”Ÿç¼“å­˜æ·˜æ±°æ—¶ï¼Œä¸èƒ½é€‰è¿™ä¸ª Entryã€‚</p>
<p>åœ¨è¯·æ±‚å›¾ç‰‡æ—¶ï¼Œç”±äºæ˜¯å¼‚æ­¥çš„ï¼ŒImageCache ä¸­è®¾ç½®äº†ä¸€ä¸ªå¾ˆå¤æ‚çš„ç»“æ„ï¼Œæˆ‘æ„Ÿè§‰è¿™é‡Œæ˜¯æœ‰ bug çš„ã€‚<br>
<img src="https://blog-img-1256061645.cos.ap-guangzhou.myqcloud.com//FsyA7ivTbHH3QIdyvnz0Gm0CCyHy.png" alt="" loading="lazy"></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒFormatKey åªå¯¹åº”ä¸€ä¸ª FormatNameã€‚ä½†æ˜¯ BlocksKey é‡Œé¢æœ‰å¯èƒ½æœ‰å¤šç§ FormatNameã€‚<br>
æ‰€ä»¥å¦‚æœä½ çš„ä»£ç å†™æˆä¸‹é¢è¿™æ ·ï¼ŒåŒæ—¶å›¾åƒåŠ è½½å¤±è´¥äº†ï¼Œä½ çŒœçŒœä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<pre><code class="language-objectivec">[[FICImageCache sharedImageCache] retrieveImageForEntity:photo withFormatName:FormatNameA completionBlock:^(id&lt;FICEntity&gt; entity, NSString *formatName, UIImage *image) {
    NSLog(@&quot;%@&quot;, formatName);
}];
[[FICImageCache sharedImageCache] retrieveImageForEntity:photo withFormatName:FormatNameB completionBlock:^(id&lt;FICEntity&gt; entity, NSString *formatName, UIImage *image) {
    NSLog(@&quot;%@&quot;, formatName);
}];
</code></pre>
<p>æ¡†æ¶æœ‰ç‚¹å¤æ‚ï¼Œå¦‚æœä½ åªæ˜¯æƒ³ç®€å•æå‡ä¸€ä¸‹æ»šåŠ¨æ€§èƒ½ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­åšä¸€ä¸‹ç¼“å­˜å³å¯ã€‚<br>
åœ¨å®˜æ–¹çš„ Demo å·¥ç¨‹ä¸­ï¼Œæˆ‘ç»™ FICDPhoto åŠ äº†å‡ è¡Œä»£ç ï¼Œæ€§èƒ½å°±é£ä¸Šå»äº† ğŸš€ã€‚</p>
<pre><code class="language-objectivec">- (UIImage *)thumbnailImage {
    if (_thumbImage) {
        return _thumbImage;
    }
    UIImage *thumbnailImage = [UIImage imageWithContentsOfFile:[self _thumbnailFilePath]];
    _thumbImage = thumbnailImage;

    return thumbnailImage;
}
</code></pre>
<p>è¿™é‡Œå› ä¸ºæ˜¯ç¼©ç•¥å›¾ï¼Œæ‰€ä»¥å†…å­˜ä¸ä¼šæœ‰å¤ªå¤§æ¶ˆè€—ã€‚ä¸è¿‡åˆ—è¡¨æ»šåŠ¨çš„åœºæ™¯ï¼ŒåŸºæœ¬éƒ½æ˜¯ç¼©ç•¥å›¾å§ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<p><a href="http://blog.cnbang.net/tech/2578/">iOS å›¾ç‰‡åŠ è½½é€Ÿåº¦æé™ä¼˜åŒ–â€”FastImageCache è§£æ Â« bangâ€™s blog</a></p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="https://jayying007.github.io/post/AFNetworkingæºç åˆ†æ/" class="post-title gt-a-link">
                    AFNetworkingæºç åˆ†æ
                </a>
            </div>
        

        

        

        
            <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: 'JHsf6kk7u31nFtmMMtWqQyHl-gzGzoHsz',
		appKey: '6kuh7BaduW3qYuq5MUi7KaTm',
		avatar: '',
		pageSize: 5,
		recordIp: true,
		placeholder: 'Just Go Go',
		visitor: false,
	});
</script>

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"></div>
    <div class="social-container">
        
            
                <a href="https://github.com/jayying007" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        
    </div>
    <div>
        Theme <a href="https://github.com/imhanjie/gridea-theme-pure" target="_blank">Pure</a>, Powered by <a
                href="https://gridea.dev" target="_blank">Gridea</a> | <a href="https://jayying007.github.io/atom.xml" target="_blank">RSS</a>
    </div>
</div>

<script>
  hljs.highlightAll()
</script>

    </div>
</div>
</body>
</html>
