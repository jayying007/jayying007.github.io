{"posts":[{"title":"è®°ä¸€æ¬¡éº¦å…‹é£å¼‚å¸¸çš„æ’æŸ¥ç»å†","content":"å¤ç°æ–¹å¼ è¿›å…¥è…¾è®¯ä¼šè®®appï¼Œç„¶åæŠŠéº¦å…‹é£å…³é—­ï¼Œè¿™ä¸ªæ—¶å€™æ‰‹æœºä¸Šçš„å°é»„ç‚¹ä¼šæ¶ˆå¤±ã€‚ ç„¶åä½¿ç”¨å…¶ä»–appçš„å½•éŸ³åŠŸèƒ½ï¼Œæ¯”å¦‚ç³»ç»Ÿçš„è¯­éŸ³å¤‡å¿˜å½•ã€QQã€å¾®ä¿¡ï¼Œè¿™ä¸ªæ—¶å€™è™½ç„¶å½•éŸ³æ­£å¸¸å¯åŠ¨ï¼Œä¹Ÿå‡ºç°å°é»„ç‚¹ï¼Œä½†å®é™…ä¸Šä»€ä¹ˆå£°éŸ³éƒ½æ²¡æœ‰ã€‚ æ’æŸ¥è¿‡ç¨‹ é€šè¿‡AudioQueueå®ç°çš„å½•éŸ³ï¼Œå¯åŠ¨éƒ½æ²¡æœ‰ä»€ä¹ˆé”™è¯¯ã€‚ ç„¶åé€šè¿‡LevelMeteræ£€æŸ¥æ•°æ®çš„éŸ³é‡ï¼Œå‘ç°å…¨æ˜¯0ã€‚ å†çœ‹çœ‹AudioSessionçš„å„ç§æ¥å£ï¼ŒsetActiveã€setCategoryéƒ½æ˜¯æ­£å¸¸çš„ã€‚ å¥½å¥‡æ€ªğŸ¤” ç»è¿‡æµ‹è¯•ï¼Œè¿™æ—¶ä½¿ç”¨å¾®ä¿¡çš„è¯­éŸ³é€šè¯ï¼Œæ˜¯å¯ä»¥ä½¿ç”¨éº¦å…‹é£çš„ã€‚ æ­¤æ—¶å›åˆ°è…¾è®¯ä¼šè®®ï¼Œä¼šå‡ºç°ä¸­æ–­çš„æç¤ºã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰ä½¿ç”¨AudioUnitæ‰èƒ½æŠŠéŸ³é¢‘æƒé™æŠ¢å›æ¥ï¼Œç„¶åè…¾è®¯ä¼šè®®æ”¶åˆ°AudioSessionInterruptçš„é€šçŸ¥ï¼Œå‡ºç°æç¤ºã€‚ äºæ˜¯ä¹ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªAudioUnitçš„å½•éŸ³demoï¼Œè€Œè¿™ä¸ªä¹‹å‰æ—©å°±å†™è¿‡äº†ã€‚ https://github.com/jayying007/iOSDemos æµ‹è¯•æ—¶å‘ç°ï¼Œå³ä½¿æ˜¯AudioUnitï¼Œé€‰æ‹©RemoteIOä¹Ÿæ˜¯ä¸è¡Œçš„ï¼Œéœ€è¦é€‰æ‹©VoiceProcessingIOã€‚ å¦å¤–ä¸€ä¸ªå‘ç°æ˜¯ï¼Œä½¿ç”¨AudioQueueï¼Œåªè¦æŠŠAudioSession setCategoryçš„option AudioSessionModeVoiceChatåŠ ä¸Šï¼Œä¹Ÿæ˜¯å¯ä»¥æ‰“æ–­è…¾è®¯ä¼šè®®ï¼ŒæŠŠéº¦å…‹é£æŠ¢å›æ¥çš„ã€‚ ä½†æ˜¯è¯è¯´å›æ¥ï¼ŒAudioUnitæœ¬èº«æ˜¯ç”¨äºé€šè¯ç±»åœºæ™¯çš„ï¼Œè¿™é‡Œå½•éŸ³ä½¿ç”¨çœŸçš„å¥½å—ï¼Ÿ ç–‘é—® ä¸€ä¸ªæ”¯çº¿ä»»åŠ¡ï¼šå¦‚ä½•å®ç°å…³é—­éº¦å…‹é£ï¼Œå³ä¸Šè§’çš„å°é»„ç‚¹æ¶ˆå¤±ï¼ŸğŸ¤” è¯•äº†ä¸‹ï¼ŒAudioUnité€šè¿‡EnableIOæŠŠè¾“å…¥é€šé“ç»™å…³é—­äº†ï¼Œä¾ç„¶ä¸è¡Œã€‚ æœ€åè¯•äº†ä¸‹setInputMutedè¿™ä¸ªæ¥å£ï¼Œå‘ç°å¯è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥ä»¿ç…§è…¾è®¯ä¼šè®®çš„é€»è¾‘ï¼Œå±è”½æ‰å…¶ä»–Appçš„å½•éŸ³ã€‚ ç»“è®º æˆ‘è§‰å¾—è¿™æ˜¯è‹¹æœğŸçš„bugï¼Œå…¶ä»–AppæŠŠéº¦å…‹é£å…³é—­çš„æ—¶å€™æ— æ³•å½•éŸ³ï¼ŒæŠŠéº¦å…‹é£æ‰“å¼€çš„æ—¶å€™åˆå¯ä»¥å½•éŸ³ã€‚ setInputMutedè¿™ä¸ªé€»è¾‘æœ¬æ¥æ˜¯æ¯ä¸ªAppå•ç‹¬è®¾ç½®çš„ï¼Œæ€ä¹ˆè¿™é‡Œä¼šå½±å“åˆ°å…¨éƒ¨appå‘¢ã€‚ ","link":"https://jayying007.github.io/post/ji-yi-ci-mai-ke-feng-yi-chang-de-pai-cha-jing-li/"},{"title":"iOS æ˜¾ç¤ºHDRç»„ä»¶","content":"æ¦‚è¿° åœ¨iOSä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºHDRå›¾ç‰‡ï¼Œæ’­æ”¾HDRè§†é¢‘ï¼Œä½†èƒ½ä¸èƒ½æ˜¾ç¤ºHDRæ§ä»¶å‘¢ï¼Ÿ æ¯”å¦‚æ–‡å­—ã€æŒ‰é’®ã€è¿›åº¦æ¡è¿™äº›ã€‚åœ¨ç³»ç»Ÿç›¸å†Œä¸­ï¼Œæ’­æ”¾HDRè§†é¢‘æ—¶ï¼Œä½ ä¼šå‘ç°è¿›åº¦æ¡ä¹Ÿæœ‰HDRæ•ˆæœã€‚ HDRå›¾ç‰‡ åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹æ˜¾ç¤ºHDRå›¾ç‰‡çš„æ–¹æ³•ã€‚ NSString *imagePath = [[NSBundle mainBundle] pathForResource:@&quot;IMG_4167.HEIC&quot; ofType:nil]; UIImage *image = [UIImageReader.defaultReader imageWithContentsOfFileURL:[NSURL fileURLWithPath:imagePath]]; UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake(60, 120, 120, 120)]; imageView.image = image; imageView.preferredImageDynamicRange = UIImageDynamicRangeHigh; é‚£ä¹ˆï¼Œæ˜¯ä¸æ˜¯ç”¨HDRå›¾ç‰‡ç”ŸæˆUIæ§ä»¶å°±å¥½äº†ï¼Ÿ ç†è®ºä¸Šçœ‹èµ·æ¥æ˜¯å¯è¡Œçš„ï¼Œä¸è¿‡å®é™…ä¸Šæ–‡æœ¬è¦æ€ä¹ˆå¤„ç†ï¼Ÿ HDR æ§ä»¶ ç»è¿‡ä¸€ç•ªæœæŸ¥ï¼Œåœ¨Githubä¸Šå‘ç°äº†è¿™ä¸ªé¡¹ç›®ï¼š GitHub - tsuzukihashi/EDR_Swift: I want to use EDR features easily. ä½œè€…æ˜¯ç”¨CoreImageçš„æ–¹å¼ï¼Œç”Ÿæˆäº†HDRçš„äºŒç»´ç å’Œæ¡å½¢ç ï¼Œç„¶åç”¨MetalKitå°†å…¶æ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚ è¿™ç§æ–¹æ³•åœ¨ä¸€æ¬¡WWDCçš„åˆ†äº«ä¸­æœ‰æåŠè¿‡ï¼š Display EDR content with Core Image, Metal, and SwiftUI - WWDC22 - Videos - Apple Developer æŸ¥çœ‹CoreImageçš„ç›¸å…³æ¥å£ï¼Œå‘ç°äº†ç”Ÿæˆæ–‡æœ¬å›¾ç‰‡çš„æ–¹å¼ã€‚ @interface CIFilter (Builtins) + (CIFilter&lt;CITextImageGenerator&gt;*) textImageGeneratorFilter; + (CIFilter&lt;CIAttributedTextImageGenerator&gt;*) attributedTextImageGeneratorFilter; @end ä½†æ˜¯è¿™ä¸¤ä¸ªæ¥å£æ— æ³•å¤„ç†æ–‡æœ¬æˆªæ–­çš„åœºæ™¯ï¼ŒCoreImageæ²¡æœ‰å®½åº¦è¿™äº›ä¿¡æ¯ã€‚ å®é™…ä¸Šï¼Œæˆ‘ä»¬è¦çš„æ˜¯CIImageï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡Core Graphicsç»˜åˆ¶æ–‡æœ¬ä¸ºCGImageï¼Œå†è½¬æ¢æˆCIImageå°±å¯ä»¥äº†ã€‚ äºæ˜¯ä¹ï¼Œæ¸²æŸ“HDR Labelä¾¿æˆä¸ºäº†å¯èƒ½ã€‚ å¯ä»¥ä»¿ç…§ä¸Šé¢çš„é¡¹ç›®å®ç°ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š #import &lt;Foundation/Foundation.h&gt; #import &lt;MetalKit/MetalKit.h&gt; @interface MetalRender : NSObject &lt;MTKViewDelegate&gt; - (instancetype)initWithImageProvider:(CIImage * (^)(CGFloat contentScaleFactor, CGFloat headroom))imageProvider; @property (nonatomic) id&lt;MTLDevice&gt; device; @end #import &quot;MetalRender.h&quot; @interface MetalRender () @property (nonatomic) id&lt;MTLCommandQueue&gt; commandQueue; @property (nonatomic) CIContext *renderContext; @property (nonatomic) CIImage * (^imageProvider)(CGFloat contentScaleFactor, CGFloat headroom); @end @implementation MetalRender - (instancetype)initWithImageProvider:(CIImage * (^)(CGFloat, CGFloat))imageProvider { self = [super init]; if (self) { self.imageProvider = imageProvider; self.device = MTLCreateSystemDefaultDevice(); self.commandQueue = [self.device newCommandQueue]; self.renderContext = [CIContext contextWithMTLCommandQueue:self.commandQueue options:@{ kCIContextName : @&quot;MetalRender&quot;, kCIContextCacheIntermediates : @(YES), kCIContextAllowLowPower : @(YES) }]; } return self; } - (void)drawInMTKView:(MTKView *)view { // Create a new command buffer for each render pass to the current drawable. id&lt;MTLCommandBuffer&gt; commandBuffer = [_commandQueue commandBuffer]; id&lt;CAMetalDrawable&gt; drawable = view.currentDrawable; if (drawable == nil) { return; } CGSize drawSize = view.drawableSize; CGFloat contentScaleFactor = view.contentScaleFactor; CIRenderDestination *destination = [[CIRenderDestination alloc] initWithWidth:drawSize.width height:drawSize.height pixelFormat:view.colorPixelFormat commandBuffer:commandBuffer mtlTextureProvider:^id&lt;MTLTexture&gt; { return drawable.texture; }]; if (@available(iOS 16.0, *)) { CGFloat headroom = view.window.screen.currentEDRHeadroom; CIImage *image = self.imageProvider(contentScaleFactor, headroom); CGRect iRect = [image extent]; CGRect backBounds = CGRectMake(0, 0, drawSize.width, drawSize.height); CGFloat shiftX = round((backBounds.size.width + iRect.origin.x - iRect.size.width) * 0.5); CGFloat shiftY = round((backBounds.size.height + iRect.origin.y - iRect.size.height) * 0.5); image = [image imageByApplyingTransform:CGAffineTransformMakeTranslation(shiftX, shiftY)]; [_renderContext startTaskToRender:image fromRect:backBounds toDestination:destination atPoint:CGPointZero error:nil]; } [commandBuffer presentDrawable:drawable]; [commandBuffer commit]; } - (void)mtkView:(MTKView *)view drawableSizeWillChange:(CGSize)size { } @end #import &lt;MetalKit/MetalKit.h&gt; #import &quot;MetalRender.h&quot; @interface MetalView : MTKView - (instancetype)initWithFrame:(CGRect)frame render:(MetalRender *)render; @end #import &quot;MetalView.h&quot; @interface MetalView () @property (nonatomic) MetalRender *render; @end @implementation MetalView - (instancetype)initWithFrame:(CGRect)frame render:(MetalRender *)render { self = [super initWithFrame:frame device:render.device]; if (self) { self.render = render; self.preferredFramesPerSecond = 10; self.framebufferOnly = NO; self.delegate = self.render; self.backgroundColor = UIColor.clearColor; CAMetalLayer *layer = (CAMetalLayer *)self.layer; if (@available(iOS 16.0, *)) { layer.wantsExtendedDynamicRangeContent = YES; } layer.colorspace = CGColorSpaceCreateWithName(kCGColorSpaceExtendedLinearSRGB); self.colorPixelFormat = MTLPixelFormatRGBA16Float; } return self; } @end #import &lt;UIKit/UIKit.h&gt; @interface EDRLabel : UIView @property (nonatomic) NSString *text; - (void)applyStyleWithLabel:(UILabel *)label; @end #import &quot;EDRLabel.h&quot; #import &quot;MetalView.h&quot; #import &lt;CoreImage/CIFilterBuiltins.h&gt; @interface EDRLabel () @property (nonatomic) MetalView *metalView; @property (nonatomic) CIImage *ciImage; @property (nonatomic) UIFont *font; @property (nonatomic) UIColor *textColor; @property (nonatomic) NSLineBreakMode lineBreakMode; @property (nonatomic) NSInteger numberOfLines; @end @implementation EDRLabel - (instancetype)initWithFrame:(CGRect)frame { self = [super initWithFrame:frame]; if (self) { __weak typeof(self) weakSelf = self; MetalRender *render = [[MetalRender alloc] initWithImageProvider:^CIImage *(CGFloat contentScaleFactor, CGFloat headroom) { __strong typeof(self) strongSelf = weakSelf; CIImage *image = strongSelf.ciImage; CGFloat red, green, blue, alpha; [strongSelf.textColor getRed:&amp;red green:&amp;green blue:&amp;blue alpha:&amp;alpha]; CGColorSpaceRef colorSpace = CGColorSpaceCreateWithName(kCGColorSpaceExtendedLinearSRGB); CIColor *maxFillColor = [CIColor colorWithRed:headroom * red green:headroom * green blue:headroom * blue alpha:alpha colorSpace:colorSpace]; CIImage *fillImage = [CIImage imageWithColor:maxFillColor]; CIFilter&lt;CIBlendWithMask&gt; *maskFilter = [CIFilter blendWithAlphaMaskFilter]; maskFilter.maskImage = image; maskFilter.inputImage = fillImage; return [maskFilter.outputImage imageByCroppingToRect:CGRectMake(0, 0, strongSelf.width * contentScaleFactor, strongSelf.height * contentScaleFactor)]; }]; self.metalView = [[MetalView alloc] initWithFrame:frame render:render]; [self addSubview:self.metalView]; self.userInteractionEnabled = NO; } return self; } - (void)applyStyleWithLabel:(UILabel *)label { self.text = label.text; self.font = label.font; self.textColor = label.textColor; self.lineBreakMode = label.lineBreakMode; self.numberOfLines = label.numberOfLines; } - (void)layoutSubviews { [super layoutSubviews]; self.metalView.frame = self.bounds; } - (void)setFrame:(CGRect)frame { BOOL sizeChange = self.bounds.size.width != frame.size.width || self.bounds.size.height != frame.size.height; if (sizeChange) { _ciImage = nil; } [super setFrame:frame]; } - (void)setText:(NSString *)text { _text = text; _ciImage = nil; } - (CIImage *)ciImage { if (_ciImage == nil) { UILabel *label = [[UILabel alloc] initWithFrame:self.bounds]; label.text = self.text; label.font = self.font; label.lineBreakMode = self.lineBreakMode; label.numberOfLines = self.numberOfLines; UIGraphicsImageRenderer *render = [[UIGraphicsImageRenderer alloc] initWithBounds:label.bounds]; UIImage *image = [render imageWithActions:^(UIGraphicsImageRendererContext *_Nonnull rendererContext) { [label.layer renderInContext:rendererContext.CGContext]; }]; _ciImage = [[CIImage alloc] initWithImage:image]; } return _ciImage; } @end æœ€éš¾çš„æ–‡æœ¬è§£å†³äº†ï¼Œé‚£å®ç°HDRçš„UILabelã€UIButtonã€UISliderå°±ä¸æ˜¯å¤ªå¤æ‚çš„äº‹æƒ…äº†ã€‚è¿™é‡Œä¸å†èµ˜è¿°ã€‚ HDR Color ä¸Šé¢è¿™ç§æ–¹å¼è¿˜æ˜¯æŒºæ›²æŠ˜çš„ï¼Œè€ŒiOS 26è¿æ¥äº†æ–°æ¥å£ï¼Œå¯ä»¥ç›´æ¥æŠŠUIColorè®¾ç½®ä¸ºHDRæ¨¡å¼ï¼Œè¿™æ ·å¯¹äºUILabelã€UIButtonçš„æ¥å…¥å°±æ›´ç®€å•äº†ã€‚ Whatâ€™s new in UIKit - WWDC25 - Videos - Apple Developer ç°é˜¶æ®µXcodeè¿˜æ²¡æœ‰iOS 26çš„SDKï¼Œæƒ³è¦å°é²œçš„å¯ä»¥é€šè¿‡runtimeçš„å½¢å¼è°ƒç”¨åˆ°ã€‚ - (UIColor *)hdrColorWithHeadroom:(CGFloat)headroom { SEL sel = NSSelectorFromString(@&quot;colorWithRed:green:blue:alpha:linearExposure:&quot;); if ([UIColor.class respondsToSelector:sel] == NO) { return self; } CGFloat red = 1; CGFloat green = 1; CGFloat blue = 1; CGFloat alpha = 1; CGFloat linearExposure = headroom; [self getRed:&amp;red green:&amp;green blue:&amp;blue alpha:&amp;alpha]; NSMethodSignature *signature = [UIColor methodSignatureForSelector:sel]; NSInvocation *invocation = [NSInvocation invocationWithMethodSignature:signature]; [invocation setTarget:UIColor.class]; [invocation setSelector:sel]; [invocation setArgument:&amp;red atIndex:2]; [invocation setArgument:&amp;green atIndex:3]; [invocation setArgument:&amp;blue atIndex:4]; [invocation setArgument:&amp;alpha atIndex:5]; [invocation setArgument:&amp;linearExposure atIndex:6]; [invocation invoke]; UIColor *__unsafe_unretained color = nil; [invocation getReturnValue:&amp;color]; return color; } ","link":"https://jayying007.github.io/post/ios-xian-shi-hdr-zu-jian/"},{"title":"è·¨å¹³å°ç½‘ç»œæ¡†æ¶marsæµ…æ","content":"https://github.com/Tencent/mars Mars æ˜¯ä»€ä¹ˆ Mars æ˜¯å¾®ä¿¡å®˜æ–¹çš„ç»ˆç«¯åŸºç¡€ç»„ä»¶, æ˜¯ä¸€ä¸ªä¸šåŠ¡æ€§æ— å…³,å¹³å°æ€§æ— å…³ ä½¿ç”¨ C++ ç¼–å†™çš„åŸºç¡€ç»„ä»¶ã€‚ å®ƒä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š Commï¼šåŸºç¡€åº“ï¼ŒåŒ…æ‹¬ socketã€çº¿ç¨‹ã€æ¶ˆæ¯é˜Ÿåˆ—ã€åç¨‹ç­‰åŸºç¡€å·¥å…·ï¼› Xlogï¼šé€šç”¨æ—¥å¿—æ¨¡å—ï¼Œå……åˆ†è€ƒè™‘ç§»åŠ¨ç»ˆç«¯çš„ç‰¹ç‚¹ï¼Œæä¾›é«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€å®‰å…¨æ€§ã€å®¹é”™æ€§çš„æ—¥å¿—åŠŸèƒ½ SDTï¼šç½‘ç»œè¯Šæ–­æ¨¡å—ï¼› STNï¼šä¿¡ä»¤ä¼ è¾“ç½‘ç»œæ¨¡å—ï¼Œè´Ÿè´£ç»ˆç«¯ä¸æœåŠ¡å™¨çš„å°æ•°æ®ä¿¡ä»¤é€šé“ã€‚åŒ…å«äº†å¾®ä¿¡ç»ˆç«¯åœ¨ç§»åŠ¨ç½‘ç»œä¸Šçš„å¤§é‡ä¼˜åŒ–ç»éªŒä¸æˆæœï¼Œç»å†äº†å¾®ä¿¡æµ·é‡ç”¨æˆ·çš„è€ƒéªŒã€‚ è¿™äº›ä»‹ç» Github ä¸Šéƒ½æœ‰ï¼Œæˆ‘å°±ä¸é‡å¤äº†ã€‚ ç»™çº¯å°ç™½çš„è¯´æ˜ è¯´çœŸçš„ï¼Œå¦‚æœå¯¹ç½‘ç»œç¼–ç¨‹ä¸äº†è§£ï¼Œä¸Šé¢é‚£æ®µè¯ä¼°è®¡æ˜¯çœ‹ä¸æ˜ç™½çš„ï¼Œè¿™é‡Œå†ç®€å•è¯´æ˜ä¸€ä¸‹ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œå®¢æˆ·ç«¯å’Œåå°é€šè¿‡ TCP ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ è¿™ç»„è¿æ¥é€šè¿‡ï¼ˆIP1,Socket1,IP2,Socket2ï¼‰å”¯ä¸€æ ‡è¯†ï¼Œ ä½ æƒ³ç»™åå°å‘æ¶ˆæ¯ï¼Œå°±å¾€è¿™ä¸ª Socket å†™æ•°æ®ã€‚ä½ æƒ³ä»åå°æ”¶æ¶ˆæ¯ï¼Œå°±ä»è¿™ä¸ª Socket è¯»æ•°æ®ã€‚ å¸¸è§çš„é€šä¿¡æ–¹å¼æœ‰ä¸¤ç§ï¼š å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®ï¼Œåå°è¿”å›ï¼› åå°ä¸»åŠ¨æ¨æ•°æ®ï¼› å…¶ä¸­ï¼Œæƒ³è¦è®©åå°åœ¨éœ€è¦çš„æ—¶å€™å‘æ¶ˆæ¯ç»™ä½ ï¼Œå°±å¾—ä¿æŒ Socket ä¸€ç›´è¿æ¥ç€ï¼Œå³æ‰€è°“çš„é•¿è¿æ¥ã€‚è€Œå‰é¢é‚£ç§ä¸€æ¥ä¸€å›çš„ï¼Œå°±æ— æ‰€è°“çŸ­è¿æ¥è¿˜æ˜¯é•¿è¿æ¥äº†ã€‚ å…¶å®è¿˜æœ‰å®¢æˆ·ç«¯ç»™åå°å‘é€šçŸ¥çš„åœºæ™¯ï¼Œåªä¸è¿‡è¿™ç§æ¯”è¾ƒå°‘è§ã€‚ ä¾‹å¦‚å¾®ä¿¡é‡Œé¢çš„ã€Œå¯¹æ–¹æ­£åœ¨è¾“å…¥ã€ï¼Œå°±æ˜¯ç”¨è¿™ç§èƒ½åŠ›å®ç°çš„ã€‚ ç½‘ç»œä¸Šä¼ è¾“çš„åªæ˜¯å•çº¯çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå…·ä½“ä»£è¡¨ä»€ä¹ˆå«ä¹‰å°±çœ‹å®¢æˆ·ç«¯è·Ÿåå°åå•†çš„ç»“æœäº†ã€‚å°±åƒ TCP åè®®å»ºç«‹åœ¨ IP åè®®çš„åŸºç¡€ä¹‹ä¸Šï¼Œå®¢æˆ·ç«¯å’Œåå°é—´çš„åè®®å»ºç«‹åœ¨ TCP åè®®ä¹‹ä¸Šï¼Œè¿™ä¸ªå­¦è¿‡è®¡ç®—æœºç½‘ç»œçš„éƒ½æ‡‚ã€‚ socket ç¼–ç¨‹å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨æ¥å£å¦‚ä¸‹ åˆ°è¿™é‡Œï¼Œæ€»ç®—å¯ä»¥çŸ¥é“ Mars æ˜¯ä»€ä¹ˆäº†ã€‚ç®€å•è¯´ï¼ŒMars å°±æ˜¯å¯¹ä¸Šé¢ Socket å»ºç«‹çš„å°è£…ï¼Œç”±å®ƒè´Ÿè´£å»ºç«‹è·Ÿåå°çš„è¿æ¥ä»¥åŠæ•°æ®è¯»å†™ã€‚ å…³äºå®˜æ–¹ Demo æ¯•ç«Ÿæ˜¯å¾®ä¿¡æ¨å‡ºçš„ï¼Œæä¾›çš„ demo æ˜¯åŸºäºèŠå¤©åœºæ™¯è®¾è®¡çš„ã€‚ å…³äº IM ç³»ç»Ÿï¼Œç›¸ä¿¡å¤§éƒ¨åˆ†äººåœ¨ä¸Šå¤§å­¦æ—¶éƒ½åšè¿‡ç©å…·é¡¹ç›®äº†ã€‚ æ¯”å¦‚æˆ‘çš„ï¼šhttps://github.com/jayying007/chatting-room è¿™é‡Œè¦åæ§½ä¸€ç‚¹æ˜¯ï¼ŒGithub ä¸Šçš„ demo åŸºæœ¬æ˜¯è¿è¡Œä¸èµ·æ¥çš„ï¼Œæˆ‘ç»å†äº†ä¹ä¹å…«åä¸€éš¾æ‰æå®šã€‚ Server ç«¯å’Œ iOS ç«¯éƒ½æœ‰é—®é¢˜ï¼š Server ç«¯çš„ä¸»è¦é—®é¢˜æ˜¯ Gradle ç‰ˆæœ¬æ¯”è¾ƒè€ï¼Œæˆ‘æœ¬åœ°çš„ JDK ç‰ˆæœ¬æ¯”è¾ƒæ–°ï¼Œè¿™é‡Œé€šè¿‡é™ä½åˆ° JDK8 è§£å†³ï¼› iOS ç«¯ä¸»è¦é—®é¢˜æ˜¯æ–°æ—§ç‰ˆæœ¬ç¬¦å·æœ‰æ‰€å˜æ›´ï¼Œè¿™ä¸ªæ ¹æ®æŠ¥é”™ä¿¡æ¯é€æ­¥ä¿®æ”¹è§£å†³ã€‚ è§£å†³çš„è¿‡ç¨‹å› æœºå™¨è€Œå¼‚ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿä¸æ‰“ç®—è¯´æ˜ï¼Œåº”è¯¥æ²¡æœ‰äººä¸ä¼š Google å§ï¼Ÿ iOS Demo åˆ†æ æ ¸å¿ƒç»“æ„å¦‚ä¸‹ï¼š å…¶ä¸­ï¼ŒNetworkService è´Ÿè´£è®¾ç½®å¯åŠ¨ marsï¼Œå¹¶æ¥å— mars å›è°ƒçš„æ•°æ®ï¼Œä¼ é€’ç»™ä¸Šå±‚ NetworkEventã€‚ - (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions { [NetworkService sharedInstance].delegate = [[NetworkEvent alloc] init]; [[NetworkService sharedInstance] setCallBack]; [[NetworkService sharedInstance] createMars]; [[NetworkService sharedInstance] setClientVersion:200]; [[NetworkService sharedInstance] setLongLinkAddress:@&quot;192.168.1.101&quot; port:8081]; [[NetworkService sharedInstance] setShortLinkPort:8080]; [[NetworkService sharedInstance] reportEvent_OnForeground:YES]; [[NetworkService sharedInstance] makesureLongLinkConnect]; [[NetworkStatus sharedInstance] Start:[NetworkService sharedInstance]]; return YES; } ä¸€æ¬¡è¯·æ±‚çš„è¿‡ç¨‹ ä»¥ PingServerController ä¸­çš„ä»£ç ä¸ºä¾‹ã€‚ ç‚¹å‡» Click æ—¶ï¼Œå®¢æˆ·ç«¯åˆ›å»ºäº†ä¸€ä¸ª CGITaskï¼Œä¼ é€’ç»™ NetworkServiceï¼Œå¹¶æŠŠè‡ªå·±ä½œä¸ºç›‘å¬è€…ã€‚ - (IBAction)onButtonClick:(id)sender forEvent:(UIEvent *)event { CGITask *helloCGI = [[CGITask alloc] initAll:ChannelType_All AndCmdId:kSayHello AndCGIUri:@&quot;/mars/hello&quot; AndHost:@&quot;192.168.1.101&quot;]; [[NetworkService sharedInstance] startTask:helloCGI ForUI:self]; } è¿™ä¸ª CGITask åªæ˜¯å®¢æˆ·ç«¯å¯¹æ•°æ®çš„å°è£…ï¼Œåœ¨ NetworkService å±‚ä¼šè§£æä¸º mars çš„ä¸€ä¸ª Taskï¼Œç„¶åå¯åŠ¨è¿™ä¸ª Taskã€‚ æ¯æ¬¡åˆ›å»º Task éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ taskidï¼Œä¹‹åå°†è¿™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯æ³¨å†Œåˆ° NetworkEvent ä¸­ã€‚ - (int)startTask:(CGITask *)task ForUI:(id&lt;UINotifyDelegate&gt;)delegateUI { Task ctask; ctask.cmdid = task.cmdid; ctask.channel_select = task.channel_select; ctask.cgi = std::string(task.cgi.UTF8String); ctask.shortlink_host_list.push_back(std::string(task.host.UTF8String)); ctask.user_context = (__bridge void*)task; NSString *taskIdKey = [NSString stringWithFormat:@&quot;%d&quot;, ctask.taskid]; [_delegate addObserver:delegateUI forKey:taskIdKey]; [_delegate addCGITasks:task forKey:taskIdKey]; mars::stn::StartTask(ctask); return ctask.taskid; } æ¥ä¸‹æ¥ Task å¯åŠ¨ï¼Œè¦çœŸæ­£å‘é€æ•°æ®äº†ï¼Œmars é€šè¿‡ callback æ¥ç´¢å–æ•°æ® // StnCallBack bool StnCallBack::Req2Buf(uint32_t _taskid, void* const _user_context, const std::string&amp; _user_id, AutoBuffer&amp; _outbuffer, AutoBuffer&amp; _extend, int&amp; _error_code, const int _channel_select, const std::string&amp; host) { NSData* requestData = [[NetworkService sharedInstance] Request2BufferWithTaskID:_taskid userContext:_user_context]; if (requestData == nil) { requestData = [[NSData alloc] init]; } _outbuffer.AllocWrite(requestData.length); _outbuffer.Write(requestData.bytes,requestData.length); return requestData.length &gt; 0; } // NetworkService - (NSData*)Request2BufferWithTaskID:(uint32_t)tid userContext:(const void *)context { CGITask *task = (__bridge CGITask *)context; return [_delegate Request2BufferWithTaskID:tid task:task]; } // NetworkEvent - (NSData*)Request2BufferWithTaskID:(uint32_t)tid task:(CGITask *)task { NSData* data = NULL; NSString *taskIdKey = [NSString stringWithFormat:@&quot;%d&quot;, tid]; id&lt;UINotifyDelegate&gt; uiObserver = [controllers objectForKey:taskIdKey]; if (uiObserver != nil) { data = [uiObserver requestSendData]; } return data; } // PingServerController - (NSData*)requestSendData { HelloRequest *helloRequest = [HelloRequest new]; helloRequest.user = [self username]; helloRequest.text = @&quot;Hello world&quot;; NSData *data = [helloRequest data]; return data; } ç»è¿‡å±‚å±‚ä¼ é€’ï¼Œæœ€åæ¥åˆ°äº† PingServerControllerï¼Œå¾—åˆ°ä¸€ä¸ª HelloRequest çš„åºåˆ—åŒ–æ•°æ®ã€‚è¿™é‡Œçš„ä¸šåŠ¡å±‚æ•°æ®æ˜¯ä¸€ä¸ª protobuf å¯¹è±¡ï¼Œä¹Ÿæ˜¯ç½‘ç»œç¼–ç¨‹å¸¸ç”¨çš„åºåˆ—åŒ–æ–¹å¼ï¼Œå…³äº protobuf çš„ä»‹ç»å¯ä»¥çœ‹ä»¥å‰å†™çš„åšå®¢ã€‚ å› ä¸ºè¿™æ˜¯ä¸ªæœ‰æ¥æœ‰å›çš„è¯·æ±‚ï¼Œæ‰€ä»¥åå°è¿˜ä¼šå›æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œä¹Ÿæ˜¯ mars é€šè¿‡ callback æ¥è¿”å›æ•°æ®ã€‚ // StnCallBack int StnCallBack::Buf2Resp(uint32_t _taskid, void* const _user_context, const std::string&amp; _user_id, const AutoBuffer&amp; _inbuffer, const AutoBuffer&amp; _extend, int&amp; _error_code, const int _channel_select) { int handle_type = mars::stn::kTaskFailHandleNormal; NSData* responseData = [NSData dataWithBytes:(const void *) _inbuffer.Ptr() length:_inbuffer.Length()]; NSInteger errorCode = [[NetworkService sharedInstance] Buffer2ResponseWithTaskID:_taskid ResponseData:responseData userContext:_user_context]; if (errorCode != 0) { handle_type = mars::stn::kTaskFailHandleDefault; } return handle_type; } // NetworkService - (NSInteger)Buffer2ResponseWithTaskID:(uint32_t)tid ResponseData:(NSData *)data userContext:(const void *)context { CGITask *task = (__bridge CGITask *)context; return [_delegate Buffer2ResponseWithTaskID:tid responseData:data task:task]; } // NetworkEvent - (NSInteger)Buffer2ResponseWithTaskID:(uint32_t)tid responseData:(NSData *)data task:(CGITask *)task { int returnType = 0; NSString *taskIdKey = [NSString stringWithFormat:@&quot;%d&quot;, tid]; id&lt;UINotifyDelegate&gt; uiObserver = [controllers objectForKey:taskIdKey]; if (uiObserver != nil) { returnType = [uiObserver onPostDecode:data]; } else { returnType = -1; } return returnType; } // PingServerController - (int)onPostDecode:(NSData*)responseData { helloResponse = [HelloResponse parseFromData:responseData error:nil]; if ([helloResponse hasErrmsg]) { dispatch_async(dispatch_get_main_queue(), ^{ UIAlertController *alert = [UIAlertController alertControllerWithTitle:nil message:helloResponse.errmsg preferredStyle:UIAlertControllerStyleAlert]; [alert addAction:[UIAlertAction actionWithTitle:@&quot;OK&quot; style:UIAlertActionStyleDefault handler:nil]]; [self presentViewController:alert animated:YES completion:nil]; }); LOG_INFO(kModuleViewController, @&quot;recv hello response: %@&quot;, helloResponse.errmsg); } return helloResponse.retcode == 0 ? 0 : -1; } ä¸€æ¬¡ Push çš„è¿‡ç¨‹ ä¸ºäº†æµ‹è¯•è¿™ä¸ªè¿‡ç¨‹ï¼Œéœ€è¦å‡†å¤‡ä¸¤å°æ‰‹æœºã€‚è¿™é‡Œä»¥ TopicViewController ä¸­çš„ä»£ç ä¸ºä¾‹ã€‚ é¦–å…ˆä¸€å°æ‰‹æœºå‘é€æ¶ˆæ¯ï¼Œè¿‡ç¨‹å’Œä¸Šé¢çš„ç±»ä¼¼ï¼Œä¼šæœ‰ request å’Œ responseã€‚ // requestæ—¶è°ƒç”¨ - (NSData*)requestSendData { SendMessageRequest *sendMsgRequest = [SendMessageRequest new]; sendMsgRequest.from = [self username]; sendMsgRequest.to = @&quot;all&quot;; sendMsgRequest.text = _textField.text; sendMsgRequest.accessToken = @&quot;123456&quot;; sendMsgRequest.topic = _conversation.topic; LOG_INFO(kModuleViewController, @&quot;send msg to topic:%@&quot;, _conversation.notice); NSData* data = [sendMsgRequest data]; dispatch_async(dispatch_get_main_queue(), ^{ _textField.text = @&quot;&quot;; }); return data; } // responseæ—¶è°ƒç”¨ - (int)onPostDecode:(NSData*)responseData { SendMessageResponse *sendMsgResponse = [SendMessageResponse parseFromData:responseData error:nil]; dispatch_async(dispatch_get_main_queue(), ^{ NSString *recvtext = [NSString stringWithFormat:@&quot;%@ : %@&quot;, sendMsgResponse.from, sendMsgResponse.text]; [self.messages addObject:recvtext]; [self.tableView reloadData]; NSIndexPath *indexPath = [NSIndexPath indexPathForRow:self.messages.count-1 inSection:0]; [self.tableView scrollToRowAtIndexPath:indexPath atScrollPosition:UITableViewScrollPositionBottom animated:YES]; }); return sendMsgResponse.errCode == 0 ? 0 : -1; } åœ¨è¿›å…¥ TopicViewController æ—¶ï¼Œæ³¨å†Œäº† PushObserver - (void)viewDidLoad { [super viewDidLoad]; // ç•¥... [[NetworkService sharedInstance] addPushObserver:self withCmdId:kPushMessageCmdId]; } è¿™æ ·å½“åå° Push æ•°æ®æ—¶ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”çš„å¤„ç†è€…ã€‚è¿™æ ·å¦ä¸€å°æ‰‹æœºå°±èƒ½æ”¶åˆ°æ¶ˆæ¯äº†ã€‚ // StnCallBack void StnCallBack::OnPush(const std::string&amp; _channel_id, uint32_t _cmdid, uint32_t _taskid, const AutoBuffer&amp; _body, const AutoBuffer&amp; _extend) { if (_body.Length() &gt; 0) { NSData* recvData = [NSData dataWithBytes:(const void *) _body.Ptr() length:_body.Length()]; [[NetworkService sharedInstance] OnPushWithCmd:_cmdid data:recvData]; } } // NetworkService - (void)OnPushWithCmd:(NSInteger)cid data:(NSData *)data { return [_delegate OnPushWithCmd:cid data:data]; } // NetworkEvent - (void)OnPushWithCmd:(NSInteger)cid data:(NSData *)data { id&lt;PushNotifyDelegate&gt; pushObserver = [pushrecvers objectForKey:[NSString stringWithFormat:@&quot;%d&quot;, cid]]; if (pushObserver != nil) { [pushObserver notifyPushMessage:data withCmdId:cid]; } } // TopicViewController - (void)notifyPushMessage:(NSData*)pushData withCmdId:(int)cmdId { MessagePush* messagePush = [MessagePush parseFromData:pushData error:nil]; if (messagePush != nil) { dispatch_async(dispatch_get_main_queue(), ^{ NSString *recvtext = [NSString stringWithFormat:@&quot;%@ : %@&quot;, messagePush.from, messagePush.content]; [self.messages addObject:recvtext]; [self.tableView reloadData]; NSIndexPath *indexPath = [NSIndexPath indexPathForRow:self.messages.count-1 inSection:0]; [self.tableView scrollToRowAtIndexPath:indexPath atScrollPosition:UITableViewScrollPositionBottom animated:YES]; }); } } ç”»æˆå›¾å¤§æ¦‚é•¿è¿™æ ·ï¼š å†™åˆ°æœ€å è¿™é‡Œè¦æä¸ªé†’ï¼Œå¦‚æœä½ ä»¥ä¸ºç½‘ç»œä¸Šä¼ è¾“çš„å°±æ˜¯çº¯ HelloRequestã€HelloResponseã€MessagePush è¿™æ ·çš„æ•°æ®ï¼Œé‚£è¯´æ˜ä½ è¿˜æ²¡å®Œå…¨ç†è§£ã€‚ æ¯•ç«Ÿè¿™é‡Œè¿˜æœ‰ä¸ªç–‘é—®ï¼Œæ€ä¹ˆåŒºåˆ†åå°è¿”å›çš„æ•°æ®æ˜¯ HelloResponse è¿˜æ˜¯ MessagePushğŸ¤”ã€‚ å›æƒ³å‰é¢åˆ›å»º CGITask çš„è¿‡ç¨‹ï¼Œå…¶å®è¿˜æœ‰ cmdid è¿™ä¸ªä¸œè¥¿ã€‚ - (IBAction)onButtonClick:(id)sender forEvent:(UIEvent *)event { CGITask *helloCGI = [[CGITask alloc] initAll:ChannelType_All AndCmdId:kSayHello AndCGIUri:@&quot;/mars/hello&quot; AndHost:@&quot;192.168.1.101&quot;]; [[NetworkService sharedInstance] startTask:helloCGI ForUI:self]; } è¿™æ ·ï¼Œå®¢æˆ·ç«¯åœ¨è¯·æ±‚æ—¶æŠŠè¿™ä¸ª cmdid ä¹Ÿå¸¦ä¸Šï¼Œåå°å°±çŸ¥é“å®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯ä»€ä¹ˆå†…å®¹ã€‚ åå°è¿”å›æ—¶æŠŠ cmdid å¸¦ä¸Šï¼Œå®¢æˆ·ç«¯å°±çŸ¥é“åå°è¿”å›çš„æ˜¯ä»€ä¹ˆå†…å®¹ã€‚ åœ¨ Demo ä¸­ï¼Œå®¢æˆ·ç«¯å’Œåå°ä¹‹é—´çš„ä¼ è¾“åè®®å¦‚ä¸‹ï¼š å®¢æˆ·ç«¯è¿™éƒ¨åˆ†ä»£ç åœ¨ longlink_packer.cc ä¸­ void (*longlink_pack)(uint32_t _cmdid, uint32_t _seq, const AutoBuffer&amp; _body, const AutoBuffer&amp; _extension, AutoBuffer&amp; _packed, longlink_tracker* _tracker) = [](uint32_t _cmdid, uint32_t _seq, const AutoBuffer&amp; _body, const AutoBuffer&amp; _extension, AutoBuffer&amp; _packed, longlink_tracker* _tracker) { __STNetMsgXpHeader st = {0}; st.head_length = htonl(sizeof(__STNetMsgXpHeader)); st.client_version = htonl(sg_client_version); st.cmdid = htonl(_cmdid); st.seq = htonl(_seq); st.body_length = htonl(_body.Length()); _packed.AllocWrite(sizeof(__STNetMsgXpHeader) + _body.Length()); _packed.Write(&amp;st, sizeof(st)); if (NULL != _body.Ptr()) _packed.Write(_body.Ptr(), _body.Length()); _packed.Seek(0, AutoBuffer::ESeekStart); }; æœåŠ¡å™¨è¿™éƒ¨åˆ†ä»£ç åœ¨ NetMsgHeader.java ä¸­ public byte[] encode() throws InvalidHeaderException { if (body == null &amp;&amp; cmdId != CMDID_NOOPING &amp;&amp; cmdId != CMDID_NOOPING_RESP) { throw new InvalidHeaderException(&quot;invalid header body&quot;); } final int headerLength = FIXED_HEADER_SKIP + (options == null ? 0 : options.length); final int bodyLength = (body == null ? 0 : body.length); final int packLength = headerLength + bodyLength; final ByteArrayOutputStream baos = new ByteArrayOutputStream(packLength); try { final DataOutputStream dos = new DataOutputStream(baos); dos.writeInt(headerLength); dos.writeInt(CLIENTVERSION); dos.writeInt(cmdId); dos.writeInt(seq); dos.writeInt(bodyLength); if (options != null) { dos.write(options); } if (body != null) { dos.write(body); } } catch (IOException e) { e.printStackTrace(); } finally { try { baos.close(); } catch (IOException e) { e.printStackTrace(); } } return baos.toByteArray(); } æœ€åçš„æœ€åï¼Œæˆ‘è¿˜è¦æ’ä¸€å¥ã€‚è¿™ä¸ªåè®®æ˜¯å®¢æˆ·ç«¯è·Ÿåå°åå•†çš„ï¼Œæ¯ä¸ªä¸šåŠ¡å®šçš„éƒ½ä¸ä¸€æ ·ï¼Œå¾®ä¿¡ä¹Ÿä¸æ˜¯è¿™æ ·æçš„ã€‚å…·ä½“æ€ä¹ˆå®šä¹‰å–å†³äºè‡ªèº«ä¸šåŠ¡ï¼Œæ›´å¥½çš„è®¾è®¡æ˜¯å‡å°‘ä¼ è¾“æ•°æ®å¤§å°ï¼Œåˆèƒ½æœ‰æ‰©å±•æ€§ï¼Œæ›´å®‰å…¨ã€‚ å…¶ä»– å¦‚æœä½ å¯¹ mars çš„æºç æœ‰å…´è¶£ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„åšå®¢ Tencent Mars æºç è§£æ ","link":"https://jayying007.github.io/post/è·¨å¹³å°ç½‘ç»œæ¡†æ¶marsæµ…æ/"},{"title":"[è½¬] æ¸¸æˆä¸­çš„AI-è¡Œä¸ºæ ‘","content":"https://lifan.tech/2020/02/15/game/behavior-tree/ æ¸¸æˆé‡Œæœ‰ä¸å°‘ç®—æ³•ï¼Œå¦‚æœ¬æ–‡çš„è¡Œä¸ºæ ‘ï¼Œä»¥åŠè¿˜æœ‰æ’è¡Œæ¦œçš„æ’åºç®—æ³•ã€å¯»è·¯ç®—æ³•ã€ç‰©ä½“ç¢°æ’ï¼Œå¦‚æœä½ æ˜¯åš 3D å¼•æ“çš„ï¼Œè¿˜å¾—æ‡‚å›¾å½¢å­¦ã€ç‰©ç†å­¦ã€æ•°å­¦... è¿™é‡Œçš„è¡Œä¸ºæ ‘è™½ç„¶åœ¨ iOS ä¸­åŸºæœ¬ç”¨ä¸åˆ°ï¼Œä½†è·Ÿå®ƒå…³è”çš„çŠ¶æ€æœºè¿˜æ˜¯æœ‰å¯èƒ½çš„ã€‚ æ¸¸æˆä¸­ï¼Œå¸¸è§ç”¨ AI å®ç°æ–¹å¼æœ‰ 2 ç§ï¼ŒçŠ¶æ€æœºå’Œè¡Œä¸ºæ ‘ã€‚ä¸‹é¢ä¸»è¦ç®€ä»‹ç»è¡Œä¸ºæ ‘ï¼Œè¡Œä¸ºæ ‘æ˜¯ç”¨ä¸€æ£µå¤šå‰æ ‘æ¥è¡¨ç¤º AIï¼Œæ ‘çš„ä¸­é—´èŠ‚ç‚¹ä¸ºæ§åˆ¶èŠ‚ç‚¹æ§åˆ¶ç€ AI çš„æ‰§è¡Œæµç¨‹ï¼Œå¶å­èŠ‚ç‚¹ä¸ºè¡Œä¸ºèŠ‚ç‚¹ï¼Œæè¿°äº† AI çš„å…·ä½“è¡Œä¸ºã€‚ ä¸€ã€æ¡ˆä¾‹æè¿° å±±è´¼çš„ AI éœ€æ±‚æè¿°å¦‚ä¸‹ï¼š è§†é‡å†…æ²¡æœ‰æ•Œäººåˆ™åœ¨ä¸€å®šèŒƒå›´å†…å·¡é€» è§†é‡å‡ºç°æ•Œäººåˆ™èµ°è¿‡å»æ”»å‡»æ•Œäºº å½“è‡ªå·±è¡€é‡ &lt; 20% åˆ™é€ƒè·‘ ä¸‹é¢å°†åˆ†åˆ«ç”¨çŠ¶æ€æœºå’Œè¡Œä¸ºæ ‘æ¥æè¿°å±±è´¼çš„ AI äºŒã€çŠ¶æ€æœº ä¸Šå›¾æ˜¯ç”¨çŠ¶æ€æœºæ¥æè¿°å±±è´¼çš„ AI, ç›®å‰æ¥çœ‹çŠ¶æ€æœºçš„é€»è¾‘è¿˜æ˜¯éå¸¸æ¸…æ™°ï¼Œä»£ç å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ã€‚ä½†éšç€é¡¹ç›®çš„æ¨è¿›ï¼Œç­–åˆ’éšæ—¶å¯èƒ½å¢åŠ éœ€æ±‚ã€‚å‡å¦‚ç°åœ¨éœ€è¦åŠ ä¸€ä¸ª â€œçŸ³åŒ–â€çŠ¶æ€ï¼Œæè¿°å¦‚ä¸‹ï¼š åœ¨é€ƒè·‘çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿½å‡»è€…æ•°é‡&gt;2ï¼Œåˆ™ç«‹å³æŠŠè‡ªå·±çŸ³åŒ–ï¼ŒæŒç»­ 5sï¼Œæ­¤æ—¶è‡ªå·±ä¸èƒ½è¢«æ”»å‡»ä¹Ÿä¸èƒ½æ”»å‡»ç›®æ ‡ åœ¨çŠ¶æ€æœºä¸­åŠ å…¥â€œçŸ³åŒ–â€çŠ¶æ€æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å®ƒè·Ÿç°æœ‰æ¯ä¸ªçŠ¶æ€ä¹‹é—´æ˜¯å¦æœ‰è”ç³»ï¼Œè¾“å…¥è¾“å‡ºçŠ¶æ€åˆ†åˆ«æœ‰å“ªäº›ã€‚ 1.1 çŠ¶æ€æœºå­˜åœ¨çš„ä¸è¶³ åœ¨é¡¹ç›®ä¸­éšæ—¶å¯èƒ½å¢åŠ æ–°çŠ¶æ€ã€å‡å°‘çŠ¶æ€æˆ–è€…æ”¹å˜çŠ¶æ€ä¹‹é—´çš„è¿ç§»å…³ç³»ï¼Œå¦‚æœçŠ¶æ€è¶Šæ¥è¶Šå¤šï¼Œä»»ä½•ä¸€ç‚¹å°ä¿®æ”¹éƒ½ä¼šäº§ç”Ÿå¾ˆå¤§çš„å·¥ä½œé‡ï¼Œä»£ç ä¸­ä¼šå‡ºç°å¤§é‡çš„åˆ¤æ–­è·³è½¬ï¼Œä»£ç çš„é€»è¾‘ä¼šå˜å¾—è¶Šæ¥è¶Šæ··ä¹±ï¼Œå¦‚æœè´Ÿè´£çŠ¶æ€æœºçš„åŒäº‹ç¦»èŒäº†ï¼Œè¿™ä¼šå¸¦æ¥å¾ˆå¤§çš„é—®é¢˜ã€‚ è¡Œä¸ºæ ‘çš„å‡ºç°ä»æ ¹æœ¬ä¸Šè§£å†³äº†è¿™äº›é—®é¢˜ï¼Œå®ƒæŠŠæ¯ä¸ªè¡Œä¸ºä½œä¸ºä¸€ä¸ªåŸå­é¡¹ï¼Œæä¾›ç»™ç­–åˆ’ç¼–è¾‘ï¼Œè®©ç­–åˆ’æ¥å†³å®š AI çš„æ‰§è¡Œæµç¨‹ï¼Œç¨‹åºåªéœ€è¦é›†ä¸­ç²¾åŠ›æ ¹æ®éœ€æ±‚å¢åŠ æ–°çš„è¡Œä¸ºï¼Œä¸ç”¨å…³å¿ƒå…·ä½“æµç¨‹ã€‚ç”¨ç§æ–¹å¼ï¼Œç¨‹åºçš„å·¥ä½œä¼šå¾—åˆ°å¾ˆå¤§ç¨‹åº¦çš„è§£æ”¾ï¼Œå³ä½¿æœ‰ä¸€å¤©äº¤ç»™å…¶ä»–åŒäº‹ç»´æŠ¤ä¹Ÿæ¯”è¾ƒå®¹æ˜“ã€‚ ä¸‰ã€è¡Œä¸ºæ ‘ è¡Œä¸ºæ ‘æ˜¯ç”±æ§åˆ¶èŠ‚ç‚¹ã€è£…é¥°èŠ‚ç‚¹ã€è¡Œä¸ºèŠ‚ç‚¹ç»„æˆçš„ä¸€æ£µ n å‰æ ‘ï¼Œä¸­é—´èŠ‚ç‚¹ä¸€èˆ¬ä¸ºæ§åˆ¶èŠ‚ç‚¹å’Œè£…é¥°èŠ‚ï¼Œç”¨äºæ§åˆ¶è¡Œä¸ºæ ‘çš„æ‰§è¡Œæµç¨‹ï¼Œå®ƒä»¬ç›¸å¯¹å›ºå®šï¼Œä¸€æ—¦ç¡®å®šå‡ ä¹ä¸ä¼šå˜åŒ–ï¼›å¶å­èŠ‚ç‚¹ç”±è¡Œä¸ºèŠ‚ç‚¹æˆ–æ¡ä»¶èŠ‚ç‚¹ç»„æˆï¼Œå®ƒå®ç°äº† AI ä¸­çš„å„ç§è¡Œä¸ºï¼Œç¨‹åºçš„å¤§éƒ¨åˆ†å·¥ä½œéƒ½æ˜¯ä¸°å¯Œè¡Œä¸ºèŠ‚ç‚¹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¡Œä¸ºæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªè¿”å›å€¼ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š æˆåŠŸï¼ˆSuccessï¼‰ å¤±è´¥ï¼ˆfailedï¼‰ è¿è¡Œä¸­ï¼ˆrunningï¼‰ï¼šè¡¨ç¤ºå½“å‰å¸§æ²¡æœ‰æ‰§è¡Œå®Œæˆã€ä¸‹å¸§ç»§ç»­æ‰§è¡Œã€‚ ä¸‹é¢åˆ—å‡ºäº†è¡Œä¸ºæ ‘å¸¸ç”¨çš„èŠ‚ç‚¹ç±»å‹ï¼Œä¸»è¦ç”¨äºè¯´æ˜è¡Œä¸ºæ ‘çš„åŸç†ï¼Œç±»å‹å¯èƒ½ä¸å…¨é¢ï¼›ä½†åªè¦æ˜ç™½äº†åŸç†ï¼Œæ ¹æ®é¡¹ç›®éœ€æ±‚å¢åŠ ç±»å‹å³å¯ã€‚ 1.1 æ§åˆ¶ç±»èŠ‚ç‚¹ æ§åˆ¶èŠ‚ç‚¹ä¸€èˆ¬ä¸ºä¸­é—´èŠ‚ç‚¹ï¼Œç”¨äºæ§åˆ¶è¡Œä¸ºæ ‘çš„æ‰§è¡Œæµç¨‹ï¼Œå†³å®šäº†å…¶å­èŠ‚ç‚¹æ˜¯ä»¥é¡ºåºã€å¹¶è¡Œã€éšæœºæˆ–å…¶å®ƒæ–¹å¼æ‰§è¡Œã€‚ é¡ºåºèŠ‚ç‚¹ï¼ˆSequencesï¼‰ ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰å­èŠ‚ç‚¹ï¼Œè‹¥å½“å‰å­èŠ‚ç‚¹è¿”å›æˆåŠŸï¼Œåˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå­èŠ‚ç‚¹ï¼›è‹¥å­å½“å‰èŠ‚ç‚¹è¿”å›å¤±è´¥ï¼Œåˆ™ä¸­æ–­åç»­å­èŠ‚ç‚¹çš„æ‰§è¡Œï¼Œå¹¶æŠŠç»“æœè¿”å›ç»™çˆ¶èŠ‚ç‚¹ã€‚ å¦‚ä¸‹å›¾æ‰€æ±‚ï¼šèŠ‚ç‚¹ 1 è¿”å›æˆåŠŸï¼Œç»§ç»­æ‰§è¡ŒèŠ‚ç‚¹ 2ï¼›èŠ‚ç‚¹ 2 è¿”å›å¤±è´¥ï¼Œåˆ™æŠŠç»“æœè¿”å›ç»™ Sequences çš„çˆ¶èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ 3 å¹¶ä¸ä¼šæ‰§è¡Œã€‚é¡ºåºèŠ‚ç‚¹ç›¸å½“äº and è¯­ä¹‰ã€‚ é€‰æ‹©èŠ‚ç‚¹ï¼ˆSelectorï¼‰ ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰å­èŠ‚ç‚¹ï¼Œè‹¥å½“å‰å­èŠ‚ç‚¹è¿”å›æˆåŠŸï¼Œåˆ™ä¸­æ–­åç»­èŠ‚ç‚¹è¿è¡Œï¼Œå¹¶æŠŠç»“æœè¿”å›ç»™çˆ¶èŠ‚ç‚¹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç›¸å½“äº or è¯­ä¹‰ å¹¶è¡ŒèŠ‚ç‚¹ï¼ˆParallelï¼‰ ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰å­èŠ‚ç‚¹ï¼Œæ— è®ºå¤±è´¥ä¸å¦ï¼Œéƒ½ä¼šæŠŠæ‰€æœ‰å­èŠ‚ç‚¹æ‰§è¡Œä¸€éã€‚è‡³äº Parallel èŠ‚ç‚¹è¯¥è¿”å›ä»€ä¹ˆå€¼ç»™çˆ¶èŠ‚ç‚¹ï¼Œè¿™è¦çœ‹éœ€æ±‚ã€‚æ¯”å¦‚ï¼šæˆåŠŸæ•° &gt; å¤±è´¥æ•°è¿”å›æˆåŠŸï¼Œå¦åˆ™è¿”å›å¤±è´¥ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š éšæœºèŠ‚ç‚¹ï¼ˆRandomï¼‰ éšæœºé€‰æ‹©ä¸€ä¸ªå­èŠ‚ç‚¹æ¥è¿è¡Œã€‚ è®°å¿†èŠ‚ç‚¹ï¼ˆMemSequencesã€MemSelectorï¼‰ åŠŸèƒ½å’Œé¡ºåºèŠ‚ç‚¹ã€é€‰æ‹©èŠ‚ç‚¹ç±»ä¼¼ï¼Œå”¯ä¸€ä¸åŒæ˜¯ä¼šä¿å­˜å½“å‰æ‰§è¡Œè¿›åº¦ï¼ˆæ¯”å¦‚ï¼šä¿å­˜å½“å‰å­èŠ‚ç‚¹ç´¢å¼•ï¼‰ï¼Œä¸‹ä¸€å¸§ç»§ç»­æ‰§è¡Œå½“å‰èŠ‚ç‚¹ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯ä¸­é—´èŠ‚ç‚¹ï¼Œåˆ™ä¼šè·³è¿‡å‰é¢çš„èŠ‚ç‚¹ã€‚ 1.2 è£…é¥°èŠ‚ç‚¹ï¼ˆDecoratorï¼‰ é€†å˜èŠ‚ç‚¹ï¼ˆInverterï¼‰ï¼šå¯¹å­èŠ‚ç‚¹çš„è¿”å›å€¼å–åï¼Œç›¸å½“äº not è¯­ä¹‰ï¼Œå®ƒåªä¼šæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ã€‚ æˆåŠŸèŠ‚ç‚¹ï¼ˆSucceederï¼‰ï¼šä¸ç®¡å…¶å­èŠ‚ç‚¹è¿”å›ä½•å€¼ï¼Œéƒ½ä¼šè¿”å› Success ç»™çˆ¶èŠ‚ç‚¹ é‡å¤èŠ‚ç‚¹ï¼ˆRepeaterï¼‰ï¼šé‡å¤æ‰§è¡Œ n æ¬¡å­èŠ‚ç‚¹ã€‚ é‡å¤ç›´è‡³å¤±è´¥èŠ‚ç‚¹ï¼ˆRepeat Until Failï¼‰ï¼šé‡å¤æ‰§è¡Œå­èŠ‚ç‚¹ï¼Œç›´åˆ°å¤±è´¥ä¸ºä¸Šï¼›åŒæ ·ä¹Ÿæœ‰ç±»ä¼¼çš„é‡å¤ç›´è‡³æˆåŠŸèŠ‚ç‚¹è¿™é‡Œå°±ä¸åˆ—å‡ºäº†ã€‚ æ‰§è¡Œä¸€æ®µæ—¶é—´ï¼ˆMaxTimeï¼‰ï¼šé‡å¤æ‰§è¡Œå­èŠ‚ç‚¹ä¸€æ®µæ—¶é—´ èŠ‚ç‚¹çš„ç±»å‹æ˜¯çµæ´»å¤šå˜çš„ï¼Œä¸åŒçš„é¡¹ç›®æœ‰ä¸åŒçš„éœ€æ±‚ï¼Œä¸Šé¢åªåˆ—å‡ºäº†å¸¸ç”¨çš„ã€‚ 1.3 è¡Œä¸ºèŠ‚ç‚¹ï¼ˆActionï¼‰ è¡Œä¸ºèŠ‚ç‚¹éƒ½æ˜¯å¶èŠ‚ç‚¹ï¼Œæ§åˆ¶èŠ‚ç‚¹ç”¨äºæ§åˆ¶è¡Œä¸ºæ‰§è¡Œçš„æµç¨‹ï¼Œè¡Œä¸ºèŠ‚ç‚¹åˆ™è¡¨ç¤ºå…·ä½“åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼šæˆ˜æ–—ï¼Œé€ƒè·‘ï¼Œå·¡é€»ç­‰ã€‚å®ƒè‡³å°‘åŒ…å«ä¸¤ä¸ªå‡½æ•°ï¼š Init:ç”¨äºåˆå§‹åŒ–èŠ‚ç‚¹ï¼Œæ¯”å¦‚è¯»å–é…ç½®æ•°æ®åˆå§‹åŒ–å½“å‰èŠ‚ç‚¹ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚ OnTick:æ¯ä¸€å¸§éƒ½ä¼šæ‰§è¡Œï¼ŒèŠ‚ç‚¹çš„ä¸»è¦é€»è¾‘éƒ½åœ¨æ­¤å‡½æ•°ä¸­å®ç°æˆ–è°ƒç”¨ã€‚ 1.3.1 è¡Œä¸ºèŠ‚ç‚¹ä»£ç å®ç° è¿™æ˜¯ä¸€ä¸ªåœ¨æŒ‡å®šèŒƒå›´å†…æŸ¥æ‰¾é“å…·çš„è¡Œä¸ºèŠ‚ç‚¹ä¾‹å­ï¼ˆAtionï¼‰: //èŠ‚ç‚¹ç»“æ„ type FindItem struct { b3core.Action index string etype EntityType dis float32 } //åˆå§‹åŒ–å‡½æ•°ï¼Œå‚æ•°settingä¸ºèŠ‚ç‚¹çš„é…ç½®æ•°æ® //æ­¤å‡½æ•°åœ¨åŠ è½½èŠ‚ç‚¹æ—¶è°ƒç”¨ func (this *FindItem) Initialize(setting *b3config.BTNodeCfg) { this.Action.Initialize(setting) this.index = setting.GetPropertyAsString(&quot;index&quot;) //é“å…·æšä¸¾ç”¨äºç¼“å­˜é“å…·çš„key this.etype = EntityType(setting.GetPropertyAsInt(&quot;etype&quot;))//é“å…·ç±»å‹ this.dis = float32(setting.GetProperty(&quot;range&quot;))//æŸ¥æ‰¾èŒƒå›´ } //éå†èŠ‚ç‚¹æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰OnTickå‡½æ•° func (this *FindItem) OnTick(tick *b3core.Tick) b3.Status { f := tick.GetTarget().(*Fighter) //ç©å®¶å¯¹è±¡ tick.Blackboard.Set(this.index, int32(0), &quot;&quot;, &quot;&quot;) //æ¸…ç©ºè€æ•°æ® ball := f.FindNearItem(this.dis, this.etype) //åœ¨é™„è¿‘æœç´¢é“å…· if nil == ball {//å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå‘çˆ¶èŠ‚ç‚¹è¿”å›FAILURE return b3.FAILURE } id := ball.GetID() //è·å–é“å…·id tick.Blackboard.Set(this.index, id, &quot;&quot;, &quot;&quot;) //ç¼“å­˜é“å…·id return b3.SUCCESS//å‘çˆ¶èŠ‚ç‚¹è¿”å›SUCCESS //å› ä¸ºè¡Œä¸ºæ ‘çš„èŠ‚ç‚¹è¿”å›å€¼å¿…é¡»æ˜¯FAILUREã€SUCCESSã€RUNNING, æ‰€ä»¥Tickä¸­äº§ç”Ÿçš„ç»“æœåªèƒ½é€šè¿‡å…¶å®ƒæ–¹å¼ä¼ å›å»ï¼Œæ¯”å¦‚ä¾‹å­ä¸­çš„Blackboard } 1.3.2 ç”¨è¡Œä¸ºæ ‘è¡¨ç¤ºå±±è´¼ AI ç”¨è¡Œä¸ºæ ‘æ¥è¡¨ç¤ºçš„å±±è´¼ AIï¼Œå¹¶åŠ ä¸Šäº†â€œçŸ³åŒ–â€éœ€æ±‚ï¼Œä¸‹å›¾é»„è‰²éƒ¨åˆ†ï¼š éœ€æ±‚æè¿°ï¼šåœ¨é€ƒè·‘çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿½å‡»è€…æ•°é‡&gt;2ï¼Œåˆ™ç«‹å³æŠŠè‡ªå·±çŸ³åŒ–ï¼ŒæŒç»­ 5sï¼Œæ­¤æ—¶è‡ªå·±ä¸èƒ½è¢«æ”»å‡»ä¹Ÿä¸èƒ½æ”»å‡»ç›®æ ‡ã€‚ å¯¹äºç¨‹åºæ¥è¯´ï¼Œåªéœ€è¦å†™â€çŸ³åŒ–â€çš„é€»è¾‘å³å¯ï¼Œè‡³äºè¿™ä¸ªè¡Œä¸ºç”¨åœ¨å“ªé‡Œï¼Œæ‰§è¡Œé¡ºåºä»¥åŠå’Œå…¶å®ƒè¡Œä¸ºçš„å…³ç³»ï¼Œåˆ™ç”±ç­–åˆ’æ¥å†³å®šã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ¡ä»¶åˆ¤æ–­å…¶å®å¯ä»¥æ”¾åœ¨è¡Œä¸ºèŠ‚é‡Œï¼Œè¿™é‡ŒæŠŠå®ƒç‹¬ç«‹å‡ºæ¥ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿è¡¨è¾¾ã€‚ å››ã€çŠ¶æ€æœºä¸è¡Œä¸ºæ ‘æ¯”è¾ƒ 1.1 çŠ¶æ€æœº ä¼˜ç‚¹ï¼šå®ç°ç®€å•ã€æ‰§è¡Œæ•ˆç‡é«˜ã€‚ ç¼ºç‚¹ï¼šéšç€çŠ¶æ€æ•°é‡çš„å¢å¤šï¼ŒçŠ¶æ€ä¹‹é—´çš„å…³ç³»ä¼šè¶Šæ¥è¶Šå¤æ‚ï¼Œä»£ç å˜å¾—éš¾ä»¥ç»´æŠ¤ã€‚ 1.2 è¡Œä¸ºæ ‘ ä¼˜ç‚¹ï¼šç»“æ„æ¸…æ™°ã€èŠ‚ç‚¹é—´å…³ç³»å¼±ï¼Œç¨‹åºå¤§éƒ¨åˆ†å·¥ä½œæ˜¯ä¸°å¯Œè¡Œä¸ºèŠ‚ç‚¹ï¼ŒAI æµç¨‹äº¤ç”±ç­–åˆ’å®Œæˆã€‚ ç¼ºç‚¹ï¼šæ¯æ¬¡ tick éƒ½ä¼šéå†æ•´æ£µè¡Œä¸ºæ ‘(Mem å­èŠ‚ç‚¹é™¤å¤–)ï¼Œè‹¥æ ‘çš„æ·±åº¦å¾ˆæ·±ï¼Œæ•ˆç‡å°†å˜å¾—ä½ä¸‹ã€‚ äº”ã€å…³äºçŠ¶æ€æœºè¡Œä¸ºæ ‘çš„æ€è€ƒ ä»çŠ¶æ€æœºå’Œè¡Œä¸ºæ ‘çš„ç‰¹å¾å¯ä»¥çœ‹å‡ºï¼ŒçŠ¶æ€æœºå’Œè¡Œä¸ºæ ‘éƒ½å­˜åœ¨æ˜æ˜¾çš„ä¼˜ç¼ºç‚¹ã€‚æˆ‘ä»¬å¯ä¸å¯ä»¥åªå–å®ƒä»¬çš„ä¼˜ç‚¹å‘¢ï¼Ÿ åœ¨æ¸¸æˆä¸­ï¼Œè‹¥ä¸»åŠ¨æ€ªçš„è§†é‡èŒƒå›´å†…æ²¡æœ‰ç›®æ ‡å®ƒçš„è¡Œä¸ºæ˜¯å¾ˆç®€å•çš„ï¼Œä¸€èˆ¬ä¼šåœ¨ä¸€å®šèŒƒå›´å†…å·¡é€»ã€‚å¦‚æœç”¨è¡Œä¸ºæ ‘ï¼Œä¸ç®¡è§†é‡å†…æœ‰æ²¡æœ‰äººï¼Œæ¯å¸§éƒ½ä¼šéå†æ‰€æœ‰éè¡Œä¸ºèŠ‚ç‚¹ï¼Œè¿™é€ æˆäº†å¾ˆå¤§çš„èµ„æºæµªè´¹ã€‚ å¦‚æœç”¨çŠ¶æ€æœºå®ç°å·¡é€»ã€æ­»äº¡ã€é€ƒè·‘ï¼Œè¿›å…¥æˆ˜æ–—åçš„è¡Œä¸ºç”¨è¡Œä¸ºæ ‘ï¼Œè¿™ä¼šæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ä¼˜åŒ–ã€‚å°¤å…¶æ˜¯æ€ªç‰©å¾ˆå¤šæ—¶ï¼Œå¤§éƒ¨åˆ†æ—¶é—´æ®µï¼Œå¤§éƒ¨åˆ†æ€ªéƒ½å¤„äºå·¡é€»æˆ– idle çŠ¶æ€ï¼Œå®Œå…¨æ²¡æœ‰å¿…è¦éå†è¡Œä¸ºæ ‘ã€‚ å¦‚æœé¡¹ç›®çš„ AI æ¯”è¾ƒç®€å•ï¼Œæ¯”å¦‚å°æ¸¸æˆä¹‹ç±»çš„ã€‚ç”¨çŠ¶æ€æœºæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ ","link":"https://jayying007.github.io/post/[è½¬] æ¸¸æˆä¸­çš„AI-è¡Œä¸ºæ ‘/"},{"title":"FastImageCacheæ¡†æ¶åˆ†æ","content":"https://github.com/path/FastImageCache ç®€ä»‹ FastImageCahce é¡¾åæ€ä¹‰ï¼Œç”¨äºå›¾åƒç¼“å­˜ã€‚ ä¼ ç»Ÿçš„å›¾åƒåŠ è½½æ€§èƒ½æ¯”è¾ƒä½ï¼Œåœ¨åˆ—è¡¨æ»šåŠ¨åœºæ™¯ä¸‹ç‰¹åˆ«å®¹æ˜“æ‰å¸§ã€‚è€Œ FastImageCache å°±æ˜¯ä¸“é—¨é’ˆå¯¹åˆ—è¡¨æ»šåŠ¨åœºæ™¯åšçš„æ€§èƒ½ä¼˜åŒ–ã€‚ å¯¹äºä¸¤è€…çš„æ€§èƒ½å¯¹æ¯”ï¼Œä½ å¯ä»¥å‚è€ƒå®˜æ–¹çš„ Demo å·¥ç¨‹å»æ„Ÿå—ä¸€ä¸‹ã€‚ å›¾åƒåŠ è½½æµç¨‹ +[UIImage imageWithContentsOfFile:]é€šè¿‡ Image I/O æ¥å£åˆ›å»ºäº†ä¸€ä¸ªCGImageRefï¼Œè¿™ä¸ªæ—¶å€™å›¾åƒè¿˜æ²¡æœ‰è§£ç ã€‚è€Œä¸”åˆ©ç”¨å†…å­˜æ˜ å°„ï¼Œæ•°æ®ä¹Ÿæ²¡åŠ åˆ°å†…å­˜ä¸­ã€‚ å°†å¾—åˆ°çš„å›¾åƒèµ‹å€¼åˆ° UIImageView ä¸­ã€‚ CATransaction æ•æ‰åˆ° Layer Tree å‘ç”Ÿå˜æ›´ã€‚ åœ¨ä¸‹ä¸€ä¸ª RunLoop ä¸­ï¼ŒCore Animation æäº¤è¯¥ CATransactionï¼Œæ ¹æ® UIImage è§£ç ä¸å¦ï¼Œä¼šæœ‰ä»¥ä¸‹æ­¥éª¤ï¼š åˆ†é… Buffer ç”¨äºè§£ç ç›¸å…³æ“ä½œ å°†æ•°æ®ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ è§£ç å›¾ç‰‡æˆä½å›¾ï¼Œè¿™ä¸ªè¿‡ç¨‹å‘ç”Ÿåœ¨ CPU å¾—åˆ°çš„ä½å›¾ä¼šè¢« Core Animation ç”¨äºæ¥ä¸‹æ¥çš„æ¸²æŸ“ FastImageCache å¦‚ä½•ä¼˜åŒ–çš„ å†…å­˜æ˜ å°„ å¦‚æœæ¯å¼ å›¾ç‰‡éƒ½å­˜åœ¨ä¸åŒçš„ä½ç½®ï¼Œé‚£ä¹ˆå°†å®ƒä»¬ä»ç£ç›˜è¯»åˆ°å†…å­˜ä¸­å°±ä¼šæ¶‰åŠå¤šæ¬¡ IOã€‚ FastImageCache åˆ™å°†å®ƒä»¬éƒ½å­˜åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶ååˆ©ç”¨ mmap æŠ€æœ¯ï¼Œä½ éœ€è¦è¯»å–å“ªå¼ å›¾ç‰‡ï¼Œå°±ä¼šåœ¨å¸¸é‡æ—¶é—´å†…è®¡ç®—å‡ºå…¶ä½ç½®ï¼Œç„¶åè¯»å–ã€‚ è¿™ç§æŠ€æœ¯ä¼¼ä¹åœ¨ 2D æ¸¸æˆè´´å›¾ä¸­è¿˜æŒºå¸¸ç”¨çš„ã€‚ è§£ç æ•°æ® FastImageCache å­˜åˆ°æ–‡ä»¶ä¸­çš„éƒ½æ˜¯å·²ç»è§£ç çš„æ•°æ®ï¼Œæ‰€ä»¥åç»­ä¸å†éœ€è¦è§£ç ã€‚ å½“ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå…¸å‹çš„ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ã€‚ å­—èŠ‚å¯¹é½ Core Animation åœ¨æäº¤å›¾åƒæ•°æ®æ—¶ï¼Œå¦‚æœå…¶æ²¡æœ‰å­—èŠ‚å¯¹é½ï¼Œåˆ™ä¼šè§¦å‘ä¸€æ¬¡æ‹·è´è¿›è¡Œå¯¹é½ã€‚ ä¸€ä¸ªåˆé€‚çš„å¯¹é½æ•°å€¼æ˜¯å›¾ç‰‡æ¯è¡Œçš„å­—èŠ‚æ•°è¦å¯¹é½8 pixels x bytes per pixelï¼Œå¯¹äºå¸¸è§çš„ ARGB å›¾ç‰‡ï¼Œå°±æ˜¯ 64ã€‚ FastImageCache å¦‚ä½•è®¾è®¡çš„ å‰é¢æåˆ°æŠŠæ‰€æœ‰å›¾ç‰‡æ•°æ®éƒ½å­˜åˆ°åŒä¸€ä¸ªæ–‡ä»¶ä¸Šï¼Œå¤§æ¦‚é•¿è¿™ä¹ˆä¸ªæ ·å­ï¼š ä½†æ˜¯å…‰æœ‰è¿™ä¸ªæ–‡ä»¶è¿˜ä¸å¤Ÿï¼Œæ¯”å¦‚ä½ ä¸çŸ¥é“ç¬¬ä¸‰å¼ å›¾ç‰‡çš„åç§»é‡ï¼Œä¹Ÿä¸çŸ¥é“å›¾ç‰‡å¯¹åº”çš„æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚ è§£å†³å›¾ç‰‡åç§»é‡çš„é—®é¢˜ï¼ŒFastImageCache æ˜¯é™åˆ¶äº†æ¯ä¸€å¼ å›¾ç‰‡éƒ½æ˜¯ä¸€æ ·çš„å¤§å°ï¼ŒåŒ…æ‹¬å›¾ç‰‡çš„æ¸²æŸ“æ ¼å¼ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ ImageFormat ä¸­ã€‚çŸ¥é“å›¾ç‰‡çš„å¤§å°ï¼Œè®¡ç®—åç§»é‡å°±ç®€å•å¤šäº†ã€‚ è§£å†³å›¾ç‰‡æ˜¯ä»€ä¹ˆçš„é—®é¢˜ï¼Œè‡ªç„¶æ˜¯è¦ç»™æ¯ä¸ªå›¾ç‰‡åˆ†é…ä¸€ä¸ª UUIDï¼Œä»£ç ä¸­æ¯ä¸ªå›¾ç‰‡æ¨¡å‹éƒ½æ˜¯ FICEntity @protocol FICEntity &lt;NSObject&gt; /** A string that uniquely identifies this entity. @discussion Within each image table, each entry is identified by an entity's UUID. Ideally, this value should never change for an entity. For example, if your entity class is a person model, its UUID might be an API-assigned, unchanging, unique user ID. No matter how the properties of the person change, its user ID should never change. */ @property (nonatomic, copy, readonly) NSString *fic_UUID; @end å¦å¤–è¿˜è¦è®°å½•å“ªä¸ª UUID æ˜¯æ–‡ä»¶çš„ç¬¬å‡ ä¸ªå›¾ç‰‡ï¼Œè¿™éƒ¨åˆ†ä¿¡æ¯è¢«è®°å½•åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç§°ä¸º Meta æ–‡ä»¶ã€‚ æ€»ä½“ä¸Šçœ‹ï¼Œæ¯ä¸ª ImageFormat å¯¹åº”ä¸€ç§å›¾ç‰‡æ ¼å¼çš„æ–‡ä»¶å­˜å‚¨ï¼Œä»£ç ä¸­ç”¨ ImageTable ç»´æŠ¤æ¯ä¸ªå›¾ç‰‡æ–‡ä»¶ã€‚ ç¼“å­˜çš„æ¥å£æ— éå°±æ˜¯ CRUD é‚£ä¸€å¥—ã€‚ /** `FICImageTable` is the primary class that efficiently stores and retrieves cached image data. Image tables are defined by instances of `&lt;FICImageFormat&gt;`. Each image table is backed by a single file on disk that sequentially stores image entry data. All images in an image table are either opaque or not and have the same dimensions. Therefore, when defining your image formats, keep in mind that you cannot mix image dimensions or whether or not an image is opaque. */ @interface FICImageTable : NSObject ///------------------------------------------------ /// @name Storing, Retrieving, and Deleting Entries ///------------------------------------------------ /** Stores new image entry data in the image table. @param entityUUID The UUID of the entity that uniquely identifies an image table entry. Must not be `nil`. @param sourceImageUUID The UUID of the source image that represents the actual image data stored in an image table entry. Must not be `nil`. @param imageDrawingBlock The drawing block provided by the entity that actually draws the source image into a bitmap context. Must not be `nil`. @discussion Objects conforming to `&lt;FICEntity&gt;` are responsible for providing an image drawing block that does the actual drawing of their source images to a bitmap context provided by the image table. Drawing in the provided bitmap context writes the uncompressed image data directly to the image table file on disk. @note If any of the parameters to this method are `nil`, this method does nothing. @see [FICEntity drawingBlockForImage:withFormatName:] */ - (void)setEntryForEntityUUID:(NSString *)entityUUID sourceImageUUID:(NSString *)sourceImageUUID imageDrawingBlock:(FICEntityImageDrawingBlock)imageDrawingBlock; /** Returns a new image from the image entry data in the image table. @param entityUUID The UUID of the entity that uniquely identifies an image table entry. Must not be `nil`. @param sourceImageUUID The UUID of the source image that represents the actual image data stored in an image table entry. Must not be `nil`. @param preheatData A `BOOL` indicating whether or not the entry's image data should be preheated. See `&lt;[FICImageTableEntry preheat]&gt;` for more information. @return A new image created from the entry data stored in the image table or `nil` if something went wrong. @discussion The `UIImage` returned by this method is initialized by a `CGImageRef` backed directly by mapped file data, so no memory copy occurs. @note If either of the first two parameters to this method are `nil`, the return value is `nil`. @note If either the entity UUID or the source image UUID doesn't match the corresponding UUIDs in the entry data, then something has changed. The entry data is deleted for the provided entity UUID, and `nil` is returned. */ - (nullable UIImage *)newImageForEntityUUID:(NSString *)entityUUID sourceImageUUID:(NSString *)sourceImageUUID preheatData:(BOOL)preheatData; /** Deletes image entry data in the image table. @param entityUUID The UUID of the entity that uniquely identifies an image table entry. Must not be `nil`. @note If `entityUUID` is `nil`, this method does nothing. */ - (void)deleteEntryForEntityUUID:(NSString *)entityUUID; @end è¿™é‡Œç›´æ¥ä» Bang å“¥é‚£é‡Œæ¬å¼ å›¾è¿‡æ¥ å› ä¸ºé‡‡ç”¨äº† mmap æŠ€æœ¯ï¼Œæ‰€ä»¥æ¯å¼ å›¾ç‰‡çš„æ•°æ®å¤§å°éƒ½æ˜¯ page size align çš„ã€‚ ImageTable å¹¶ä¸ç›´æ¥åŒ…å« Entryï¼Œè€Œæ˜¯åœ¨ä¸­é—´åŠ äº†ä¸€å±‚ Chunkã€‚è¿™ä¸ª Chunk æ˜¯æ¯æ¬¡è¿è¡Œæ—¶åˆ›å»ºçš„ï¼Œæ‰€ä»¥ä¸€ä¸ª Chunk çš„å¤§å°ã€åŒ…å«å¤šå°‘ Entry ä½ éƒ½å¯ä»¥éšæ„è®¾ç½®ã€‚ mmap çš„ç²’åº¦æ˜¯æ¯ä¸€ä¸ª Chunkï¼Œè¿™æ ·æ—¢ä¸ä¼šå¤ªå¤§ä¹Ÿä¸ä¼šå¤ªå°ï¼Œç›¸å½“çµæ´»ã€‚ åŸºæœ¬æµç¨‹ è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹æ•´ä¸ª FastImageCache ä¸ App çš„å·¥ä½œæµç¨‹ã€‚ App è¿›å…¥æŸä¸ªåˆ—è¡¨ï¼Œéœ€è¦æ˜¾ç¤ºå›¾ç‰‡ï¼Œæ‰€ä»¥è°ƒç”¨äº†retrieveImageForEntityç›¸å…³æ¥å£è·å–å›¾ç‰‡ã€‚ å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œæ­¤æ—¶è¿˜æ²¡æœ‰æ•°æ®ï¼Œåˆ™ FastImageCache ä¼šè¦æ±‚ App æä¾›åŸå§‹å›¾ç‰‡çš„æ•°æ®ã€‚ æ‹¿åˆ°åŸå§‹å›¾ç‰‡åï¼Œæ¥ä¸‹æ¥éœ€è¦å¯»æ‰¾æ”¾åˆ°æ–‡ä»¶çš„å“ªä¸ªåœ°æ–¹åˆé€‚ã€‚å¦‚æœæ–‡ä»¶ä¸å¤Ÿæ”¾ï¼Œåˆ™éœ€è¦ftruncateæ‰©å±•ä¸€ä¸‹æ–‡ä»¶å¤§å°ã€‚æ­¤æ—¶ä¼šå¾—åˆ°ä¸€ä¸ª ImageTableEntryã€‚ æ ¹æ® ImageFormat çš„ä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ª Bitmapï¼Œç„¶åå°†å›¾ç‰‡ç»˜åˆ¶åˆ° ImageTableEntry å…¶ä¸­çš„ bytesï¼Œå…¶å®å°±æ˜¯å†™åˆ°æ–‡ä»¶ä¸­ã€‚ æ ¹æ®indexMapæŸ¥è¯¢åˆ°å›¾ç‰‡ UUID å¯¹åº”åœ¨æ–‡ä»¶å“ªä¸ªä½ç½®ï¼Œåˆ›å»ºå¯¹åº”çš„ ImageTableEntryã€‚ å°†è¯¥ä½å›¾æ•°æ®è¯»å–å‡ºæ¥ï¼Œè¿”å›ç»™ App è¿™é‡Œä¸æƒ³è´´å¤ªå¤šä»£ç ï¼Œè‡ªè¡ŒæŸ¥é˜…ã€‚ è§£ç å›¾ç‰‡æˆä½å›¾çš„é€»è¾‘å‚è€ƒä»¥ä¸‹æ–¹æ³•ï¼š -[FICImageTable setEntryForEntityUUID:sourceImageUUID:imageDrawingBlock:] ä»å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­è¯»å–ä½å›¾çš„é€»è¾‘å‚è€ƒä»¥ä¸‹æ–¹æ³•ï¼š -[FICImageTable newImageForEntityUUID:sourceImageUUID:preheatData:] æ³¨æ„ç‚¹ &amp; åæ§½ ImageFormat é™åˆ¶äº†å›¾ç‰‡çš„å¤§å°ç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥ FastImageCache é€‚ç”¨äºé‚£ç§æœ‰ç»Ÿä¸€å›¾åƒå¤§å°çš„åœºæ™¯ï¼Œæ¯”å¦‚èŠå¤©å¤´åƒã€ç›¸å†Œã€‚ _sourceImageMap æ²¡çœ‹åˆ°æœ‰ä»€ä¹ˆä½œç”¨ï¼Œå¯èƒ½æ˜¯ä¸ªé—ç•™ä»£ç ã€‚ ImageTable ä¸­çš„_imageLength å’Œ Entry ä¸­çš„ imageLength æ˜¯ä¸ç›¸ç­‰çš„ï¼Œå‰è€…æ˜¯å‡†ç¡®çš„æ•°å€¼ï¼Œåè€…ç”±äº page size alignï¼Œç®—å‡ºæ¥çš„ä¸æ˜¯å‡†ç¡®çš„ã€‚è™½ç„¶ä¸å½±å“ä½¿ç”¨ã€‚ ImageTable é‡Œé¢ç”¨äº†ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„æ•°æ®ç»“æœï¼Œçœ‹äº†å¥½å‡ éä»£ç æ‰çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€ã€‚ æ¯”å¦‚_indexNumbers ç¼“å­˜äº† index çš„ NSNumber è¡¨ç¤ºï¼Œç”¨æ¥**@synchronized**åŠ é”ï¼Œé¿å…æ¯æ¬¡é‡æ–°ç”Ÿæˆ NSNumber å˜äº†ã€‚æœ‰ HashMap é”è¡¨å¤´é‚£å‘³äº†ï½ _inUseEntries ä»£è¡¨å“ªä¸ª Entry æ­£åœ¨ä½¿ç”¨ï¼Œå‘ç”Ÿç¼“å­˜æ·˜æ±°æ—¶ï¼Œä¸èƒ½é€‰è¿™ä¸ª Entryã€‚ åœ¨è¯·æ±‚å›¾ç‰‡æ—¶ï¼Œç”±äºæ˜¯å¼‚æ­¥çš„ï¼ŒImageCache ä¸­è®¾ç½®äº†ä¸€ä¸ªå¾ˆå¤æ‚çš„ç»“æ„ï¼Œæˆ‘æ„Ÿè§‰è¿™é‡Œæ˜¯æœ‰ bug çš„ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒFormatKey åªå¯¹åº”ä¸€ä¸ª FormatNameã€‚ä½†æ˜¯ BlocksKey é‡Œé¢æœ‰å¯èƒ½æœ‰å¤šç§ FormatNameã€‚ æ‰€ä»¥å¦‚æœä½ çš„ä»£ç å†™æˆä¸‹é¢è¿™æ ·ï¼ŒåŒæ—¶å›¾åƒåŠ è½½å¤±è´¥äº†ï¼Œä½ çŒœçŒœä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ [[FICImageCache sharedImageCache] retrieveImageForEntity:photo withFormatName:FormatNameA completionBlock:^(id&lt;FICEntity&gt; entity, NSString *formatName, UIImage *image) { NSLog(@&quot;%@&quot;, formatName); }]; [[FICImageCache sharedImageCache] retrieveImageForEntity:photo withFormatName:FormatNameB completionBlock:^(id&lt;FICEntity&gt; entity, NSString *formatName, UIImage *image) { NSLog(@&quot;%@&quot;, formatName); }]; æ¡†æ¶æœ‰ç‚¹å¤æ‚ï¼Œå¦‚æœä½ åªæ˜¯æƒ³ç®€å•æå‡ä¸€ä¸‹æ»šåŠ¨æ€§èƒ½ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­åšä¸€ä¸‹ç¼“å­˜å³å¯ã€‚ åœ¨å®˜æ–¹çš„ Demo å·¥ç¨‹ä¸­ï¼Œæˆ‘ç»™ FICDPhoto åŠ äº†å‡ è¡Œä»£ç ï¼Œæ€§èƒ½å°±é£ä¸Šå»äº† ğŸš€ã€‚ - (UIImage *)thumbnailImage { if (_thumbImage) { return _thumbImage; } UIImage *thumbnailImage = [UIImage imageWithContentsOfFile:[self _thumbnailFilePath]]; _thumbImage = thumbnailImage; return thumbnailImage; } è¿™é‡Œå› ä¸ºæ˜¯ç¼©ç•¥å›¾ï¼Œæ‰€ä»¥å†…å­˜ä¸ä¼šæœ‰å¤ªå¤§æ¶ˆè€—ã€‚ä¸è¿‡åˆ—è¡¨æ»šåŠ¨çš„åœºæ™¯ï¼ŒåŸºæœ¬éƒ½æ˜¯ç¼©ç•¥å›¾å§ã€‚ å‚è€ƒèµ„æ–™ iOS å›¾ç‰‡åŠ è½½é€Ÿåº¦æé™ä¼˜åŒ–â€”FastImageCache è§£æ Â« bangâ€™s blog ","link":"https://jayying007.github.io/post/FastImageCacheæ¡†æ¶åˆ†æ/"},{"title":"AFNetworkingæºç åˆ†æ","content":"https://github.com/AFNetworking/AFNetworking ç®€ä»‹ AFNetworking è¿™ä¸ªç½‘ç»œæ¡†æ¶ï¼Œç›¸ä¿¡ iOS å¼€å‘éƒ½ä¸é™Œç”Ÿã€‚å¦‚æœä½ çš„é¡¹ç›®æ˜¯é€šè¿‡ Http è¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¡†æ¶å¯ä»¥å¸®ä½ ç®€åŒ–ç½‘ç»œè¯·æ±‚å’Œå“åº”çš„é€»è¾‘ã€‚ å®é™…ä¸Šå®ƒå°±æ˜¯å¯¹ç³»ç»Ÿ NSURLSessionã€NSURLSessionTask è¿™äº›é€»è¾‘åšäº†å°è£…ï¼Œæä¾›äº†æ›´å®‰å…¨æ›´æ˜“ç”¨çš„æ¥å£ã€‚ è™½ç„¶è€æ—©å°±çŸ¥é“è¿™ä¸ªæ¡†æ¶ï¼Œä½†ä¸€ç›´æ²¡æœ‰å»çœ‹å…¶æºç å®ç°ã€‚ç­‰åˆ°æœ€è¿‘ç»ˆäºæŠ½å‡ºæ—¶é—´çœ‹æ—¶ï¼Œè¿™ä¸ªæ¡†æ¶å·²ç»å¯¿ç»ˆæ­£å¯äº†ã€‚ã€‚ã€‚ è™½ç„¶ä½†æ˜¯ï¼Œå¤§å‚ä¸€èˆ¬æ¯”è¾ƒå°‘ç”¨ Http è¿™ç§æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯ç›´æ¥åŸºäº TCP å®ç°ã€‚æ‰€ä»¥ AFNetworking çš„å¸®åŠ©å°±ä¸å¤§äº†ã€‚ è¿™é‡Œæ¨èä¸€ä¸ªè·¨å¹³å°ç½‘ç»œæ¡†æ¶https://github.com/Tencent/marsï¼Œä¹Ÿæ˜¯å¾®ä¿¡å®¢æˆ·ç«¯ä½¿ç”¨çš„ç½‘ç»œæ¡†æ¶ã€‚ ä¸åŸç”Ÿçš„å¯¹æ¯” è¿™é‡Œç®€å•å†™å‡ ä¸ªä¾‹å­ï¼Œæ¼”ç¤ºç”¨ AFNetworking å’Œä¸åŒ AFNetworking ä»£ç çš„åŒºåˆ« {% tabs Get %} - (void)get { NSURL *url = [NSURL URLWithString:@&quot;https://httpbin.org/get?name=123&amp;password=456&quot;]; NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:30]; [request setValue:@&quot;testValue&quot; forHTTPHeaderField:@&quot;Test-Header-Field&quot;]; NSURLSession *session = [NSURLSession sharedSession]; NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData *_Nullable data, NSURLResponse *_Nullable response, NSError *_Nullable error) { if (error != nil) { NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error); } else { NSString *result = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding]; NSLog(@&quot;%@&quot;, result); } }]; [task resume]; } - (void)af_get { [[AFHTTPSessionManager manager] GET:@&quot;https://httpbin.org/get&quot; parameters:@{ @&quot;name&quot; : @123, @&quot;password&quot; : @456 } headers:@{ @&quot;Test-Header-Field&quot; : @&quot;testValue&quot; } progress:nil success:^(NSURLSessionDataTask *_Nonnull task, id _Nullable responseObject) { NSLog(@&quot;%@&quot;, responseObject); } failure:^(NSURLSessionDataTask *_Nullable task, NSError *_Nonnull error) { NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error); }]; } {% endtabs %} {% tabs Post %} - (void)post { NSURL *url = [NSURL URLWithString:@&quot;https://httpbin.org/post&quot;]; NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:30]; [request setHTTPMethod:@&quot;POST&quot;]; NSURLSession *session = [NSURLSession sharedSession]; NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData *_Nullable data, NSURLResponse *_Nullable response, NSError *_Nullable error) { if (error != nil) { NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error); } else { NSString *result = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding]; NSLog(@&quot;%@&quot;, result); } }]; [task resume]; } - (void)af_post { [[AFHTTPSessionManager manager] POST:@&quot;https://httpbin.org/post&quot; parameters:nil headers:nil progress:nil success:^(NSURLSessionDataTask *_Nonnull task, id _Nullable responseObject) { NSLog(@&quot;%@&quot;, responseObject); } failure:^(NSURLSessionDataTask *_Nullable task, NSError *_Nonnull error) { NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error); }]; } {% endtabs %} {% tabs Download %} - (void)download { NSURL *url = [NSURL URLWithString:@&quot;https://httpbin.org/image/jpeg&quot;]; NSURLRequest *request = [[NSURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:30]; NSURLSessionConfiguration *config = [NSURLSessionConfiguration defaultSessionConfiguration]; NSURLSession *session = [NSURLSession sessionWithConfiguration:config delegate:self delegateQueue:nil]; NSURLSessionDownloadTask *task = [session downloadTaskWithRequest:request]; [task resume]; } #pragma mark - NSURLSessionDownloadDelegate - (void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask didWriteData:(int64_t)bytesWritten totalBytesWritten:(int64_t)totalBytesWritten totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite { float rate = 1.f * totalBytesWritten / totalBytesExpectedToWrite; NSLog(@&quot;ä¸‹è½½è¿›åº¦ï¼š%.2lf&quot;, rate); } - (void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask didFinishDownloadingToURL:(NSURL *)location { NSString *downloadPath = [location path]; NSLog(@&quot;å·²ä¸‹è½½åˆ°è·¯å¾„ï¼š%@&quot;, downloadPath); UIImage *image = [UIImage imageWithContentsOfFile:downloadPath]; dispatch_async(dispatch_get_main_queue(), ^{ //self.imageView.image = image; }); } - (void)af_download { AFHTTPSessionManager *manager = [[AFHTTPSessionManager alloc] init]; manager.responseSerializer = [[AFImageResponseSerializer alloc] init]; [manager GET:@&quot;https://httpbin.org/image/jpeg&quot; parameters:nil headers:nil progress:^(NSProgress *_Nonnull downloadProgress) { NSLog(@&quot;ä¸‹è½½è¿›åº¦ï¼š%.2lf&quot;, downloadProgress.fractionCompleted); } success:^(NSURLSessionDataTask *_Nonnull task, id _Nullable responseObject) { dispatch_async(dispatch_get_main_queue(), ^{ //self.imageView.image = responseObject; }); } failure:^(NSURLSessionDataTask *_Nullable task, NSError *_Nonnull error) { NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error); }]; } {% endtabs %} å¦‚æœæ˜¯ä¸‹è½½å›¾ç‰‡ï¼Œå…¶å® AFNetworking è¿˜æ‰©å±•äº† UIKit ç»„ä»¶çš„åŠŸèƒ½ï¼Œå¯ä»¥å†™æ›´å°‘çš„ä»£ç ã€‚ {% tabs Upload %} - (void)upload { NSURL *url = [NSURL URLWithString:@&quot;https://httpbin.org/post&quot;]; NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:30]; [request setHTTPMethod:@&quot;POST&quot;]; NSURLSession *session = [NSURLSession sharedSession]; UIImage *image = [UIImage imageNamed:@&quot;boss&quot;]; NSData *imgData = UIImagePNGRepresentation(image); NSURLSessionUploadTask *task = [session uploadTaskWithRequest:request fromData:imgData completionHandler:^(NSData *_Nullable data, NSURLResponse *_Nullable response, NSError *_Nullable error) { if (error != nil) { NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error); } else { NSString *result = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding]; NSLog(@&quot;%@&quot;, result); } }]; [task resume]; } - (void)af_upload { [[AFHTTPSessionManager manager] POST:@&quot;https://httpbin.org/post&quot; parameters:nil headers:nil constructingBodyWithBlock:^(id&lt;AFMultipartFormData&gt; _Nonnull formData) { UIImage *image = [UIImage imageNamed:@&quot;boss&quot;]; NSData *imgData = UIImagePNGRepresentation(image); [formData appendPartWithFormData:imgData name:@&quot;imgData&quot;]; } progress:^(NSProgress *_Nonnull downloadProgress) { NSLog(@&quot;ä¸Šä¼ è¿›åº¦ï¼š%.2lf&quot;, downloadProgress.fractionCompleted); } success:^(NSURLSessionDataTask *_Nonnull task, id _Nullable responseObject) { NSLog(@&quot;%@&quot;, responseObject); } failure:^(NSURLSessionDataTask *_Nullable task, NSError *_Nonnull error) { NSLog(@&quot;å‡ºé”™äº†ï¼Œ%@&quot;, error); }]; } {% endtabs %} å¯¹æ¯”ä»£ç çœ‹å‡ºï¼Œåœ¨ Apple æ¨å‡º NSURLSession ä¹‹åï¼ŒAFNetworking çš„ä½œç”¨ç›¸è¾ƒäºä¹‹å‰å°äº†ä¸€äº›ï¼Œä½†ä»ç„¶è¿˜æœ‰ç”¨å¤„ã€‚æ¯”å¦‚æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚éƒ½ç»Ÿä¸€ä¸º Block çš„å›è°ƒæ–¹å¼ï¼Œè€Œä¸”å¸¦æœ‰ progessã€‚ ä»£ç ç»“æ„ å¯¹å…¶æºç çš„é˜…è¯»å¯ä»¥åˆ†ä¸‹é¢å‡ ä¸ªç±»åˆ«å»çœ‹ï¼š å¯¹ NSURLSession åŠå…¶ä¸Šä¼ /ä¸‹è½½ä»»åŠ¡çš„ç®¡ç† ç›¸å…³æ–‡ä»¶ï¼šAFURLSessionManagerã€AFHTTPSessionManager è¿™ä¸¤ä¸ªç±»å¯ä»¥è¯´æ˜¯æ¡†æ¶çš„æ ¸å¿ƒäº†ï¼Œä¹Ÿæ˜¯ä½ ä½¿ç”¨ AFNetworking 99%çš„åŸå› ã€‚ è¯·æ±‚å’Œå“åº”çš„åºåˆ—åŒ– ç›¸å…³æ–‡ä»¶ï¼šAFURLRequestSerializationã€AFURLResponseSerialization æ¯”å¦‚ä½ è¯·æ±‚æ—¶å¸¦ä¸Šçš„ queryStringã€HttpHeaderã€HttpBodyï¼Œéƒ½å¯ä»¥é€šè¿‡ AFHTTPRequestSerializer æä¾›çš„æ›´ç®€å•çš„æ¥å£å®ç°ã€‚AFURLResponseSerialization åˆ™å¯ä»¥å°†è¿”å›çš„ NSData è§£ææˆä½ æƒ³è¦çš„æ•°æ®ç±»å‹ã€‚ å®‰å…¨ç›¸å…³ ä¸»è¦å°±æ˜¯ AFSecurityPolicy è¿™ä¸ªç±»ï¼Œç”¨äº SSL Pinningã€‚ ç½‘ç»œå¯è¾¾æ€§ AFNetworkReachabilityManager è¿™ä¸ªç±»æ¡†æ¶æœ¬èº«å¹¶æ²¡æœ‰ç”¨åˆ°ï¼Œæ˜¯ä¸ªç›¸å¯¹ç‹¬ç«‹çš„æ¨¡å—ã€‚ UIKit çš„æ‰©å±• å¦‚æ”¯æŒäº† UIButtonã€UIImageView è®¾ç½®ç½‘ç»œå›¾ç‰‡ï¼Œæœ‰ç‚¹åƒ SDWebImageã€‚ æºç åˆ†æ å¯¹ NSURLSession åŠå…¶ä¸Šä¼ /ä¸‹è½½ä»»åŠ¡çš„ç®¡ç† AFURLSessionManager å¯¹ NSURLSession åšäº†å°è£…ï¼Œä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œä½ ä¸éœ€è¦ç›´æ¥åˆ›å»º or è°ƒç”¨ NSURLSession çš„æ¥å£äº†ï¼Œåœ¨ AFURLSessionManager èƒ½æ‰¾åˆ°å¸¸è§çš„æ¥å£ã€‚ /** Creates and returns a manager for a session created with the specified configuration. This is the designated initializer. @param configuration The configuration used to create the managed session. @return A manager for a newly-created session. */ - (instancetype)initWithSessionConfiguration:(nullable NSURLSessionConfiguration *)configuration NS_DESIGNATED_INITIALIZER; /** Creates an `NSURLSessionDataTask` with the specified request. @param request The HTTP request for the request. @param uploadProgressBlock A block object to be executed when the upload progress is updated. Note this block is called on the session queue, not the main queue. @param downloadProgressBlock A block object to be executed when the download progress is updated. Note this block is called on the session queue, not the main queue. @param completionHandler A block object to be executed when the task finishes. This block has no return value and takes three arguments: the server response, the response object created by that serializer, and the error that occurred, if any. */ - (NSURLSessionDataTask *)dataTaskWithRequest:(NSURLRequest *)request uploadProgress:(nullable void (^)(NSProgress *uploadProgress))uploadProgressBlock downloadProgress:(nullable void (^)(NSProgress *downloadProgress))downloadProgressBlock completionHandler:(nullable void (^)(NSURLResponse *response, id _Nullable responseObject, NSError * _Nullable error))completionHandler; /** Creates an `NSURLSessionUploadTask` with the specified request for an HTTP body. @param request The HTTP request for the request. @param bodyData A data object containing the HTTP body to be uploaded. @param uploadProgressBlock A block object to be executed when the upload progress is updated. Note this block is called on the session queue, not the main queue. @param completionHandler A block object to be executed when the task finishes. This block has no return value and takes three arguments: the server response, the response object created by that serializer, and the error that occurred, if any. */ - (NSURLSessionUploadTask *)uploadTaskWithRequest:(NSURLRequest *)request fromData:(nullable NSData *)bodyData progress:(nullable void (^)(NSProgress *uploadProgress))uploadProgressBlock completionHandler:(nullable void (^)(NSURLResponse *response, id _Nullable responseObject, NSError * _Nullable error))completionHandler; AFURLSessionManager å¯¹ NSURLSessionTask äº‹ä»¶çš„å›è°ƒé‡‡ç”¨çš„æ˜¯ Block+Notification çš„æ–¹å¼ã€‚ /** Sets a block to be executed as the last message related to a specific task, as handled by the `NSURLSessionTaskDelegate` method `URLSession:task:didCompleteWithError:`. @param block A block object to be executed when a session task is completed. The block has no return value, and takes three arguments: the session, the task, and any error that occurred in the process of executing the task. */ - (void)setTaskDidCompleteBlock:(nullable void (^)(NSURLSession *session, NSURLSessionTask *task, NSError * _Nullable error))block; /** Sets a block to be executed when a download task has completed a download, as handled by the `NSURLSessionDownloadDelegate` method `URLSession:downloadTask:didFinishDownloadingToURL:`. @param block A block object to be executed when a download task has completed. The block returns the URL the download should be moved to, and takes three arguments: the session, the download task, and the temporary location of the downloaded file. If the file manager encounters an error while attempting to move the temporary file to the destination, an `AFURLSessionDownloadTaskDidFailToMoveFileNotification` will be posted, with the download task as its object, and the user info of the error. */ - (void)setDownloadTaskDidFinishDownloadingBlock:(nullable NSURL * _Nullable (^)(NSURLSession *session, NSURLSessionDownloadTask *downloadTask, NSURL *location))block; /** Posted when a task suspends its execution. */ FOUNDATION_EXPORT NSString * const AFNetworkingTaskDidSuspendNotification; AFURLSessionManager æŒæœ‰äº† NSURLSessionï¼Œå°† delegate è®¾ç½®ä¸ºè‡ªå·±ï¼ŒåŒæ—¶ä¹Ÿå­˜å‚¨äº†ä¸€ä¸ª AFURLSessionManagerTaskDelegate æ•°ç»„ï¼Œç”¨äºå…³è” NSURLSession åˆ›å»ºçš„ Taskã€‚ AFURLSessionManagerTaskDelegate ä¸­ç»´æŠ¤äº† progressBlockã€completeBlock ç­‰ä¿¡æ¯ã€‚ å¤§è‡´é€»è¾‘æ˜¯ï¼Œå¯åŠ¨ NSURLSessionTask æ—¶ï¼ŒNSURLSession é€šè¿‡ NSURLSessionDelegate é€šçŸ¥åˆ° AFURLSessionManagerã€‚ç„¶å AFURLSessionManager å†æ‰¾å‡ºå¯¹åº”çš„ AFURLSessionManagerTaskDelegateï¼Œå°†ç›¸å…³ä¿¡æ¯ä¼ é€’è¿‡å»ã€‚ æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š - (void)URLSession:(__unused NSURLSession *)session task:(NSURLSessionTask *)task didCompleteWithError:(NSError *)error { error = objc_getAssociatedObject(task, AuthenticationChallengeErrorKey) ?: error; __strong AFURLSessionManager *manager = self.manager; __block id responseObject = nil; NSMutableDictionary *userInfo = [NSMutableDictionary dictionary]; userInfo[AFNetworkingTaskDidCompleteResponseSerializerKey] = manager.responseSerializer; //Performance Improvement from #2672 NSData *data = nil; if (self.mutableData) { data = [self.mutableData copy]; //We no longer need the reference, so nil it out to gain back some memory. self.mutableData = nil; } //çœç•¥æ— å…³ä»£ç  if (error) { //ç•¥ç•¥ç•¥ } else { dispatch_async(url_session_manager_processing_queue(), ^{ NSError *serializationError = nil; responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError]; //çœç•¥æ— å…³ä»£ç  dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^{ if (self.completionHandler) { self.completionHandler(task.response, responseObject, serializationError); } dispatch_async(dispatch_get_main_queue(), ^{ [[NSNotificationCenter defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo]; }); }); }); } } è¯·æ±‚å’Œå“åº”çš„åºåˆ—åŒ– AFHTTPRequestSerializer ç”¨äºç®€åŒ– queryStringã€HttpHeaderã€HttpBody ç­‰çš„è®¾ç½®ã€‚ä¾‹å¦‚å®ƒä¼šè‡ªåŠ¨å¸®ä½ åŠ ä¸Š User-Agentã€Accept-Languageã€‚ - (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request withParameters:(id)parameters error:(NSError *__autoreleasing *)error { NSMutableURLRequest *mutableRequest = [request mutableCopy]; [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id value, BOOL * __unused stop) { if (![request valueForHTTPHeaderField:field]) { [mutableRequest setValue:value forHTTPHeaderField:field]; } }]; NSString *query = @&quot;&quot;; if (parameters) { if (self.queryStringSerialization) { //çœç•¥æ— å…³ä»£ç  } else { switch (self.queryStringSerializationStyle) { case AFHTTPRequestQueryStringDefaultStyle: query = AFQueryStringFromParameters(parameters); break; } } } if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) { if (query &amp;&amp; query.length &gt; 0) { mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? @&quot;&amp;%@&quot; : @&quot;?%@&quot;, query]]; } } else { if (![mutableRequest valueForHTTPHeaderField:@&quot;Content-Type&quot;]) { [mutableRequest setValue:@&quot;application/x-www-form-urlencoded&quot; forHTTPHeaderField:@&quot;Content-Type&quot;]; } [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]]; } return mutableRequest; } AFHTTPResponseSerializer ç”¨äºç®€åŒ–è¿”å›ç»“æœã€‚NSURLSession è¿”å›çš„æ˜¯ NSDataï¼Œåˆ©ç”¨ AFJSONResponseSerializerï¼Œå¯ä»¥å°†å…¶è½¬ä¸º NSDictionaryã€‚åˆ©ç”¨ AFImageResponseSerializerï¼Œå¯ä»¥å°†å…¶è½¬ä¸º UIImageã€‚çœä¸‹è‡ªå·±å»å†™è½¬æ¢çš„ä»£ç ã€‚ - (id)responseObjectForResponse:(NSURLResponse *)response data:(NSData *)data error:(NSError *__autoreleasing *)error { if (![self validateResponse:(NSHTTPURLResponse *)response data:data error:error]) { if (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, NSURLErrorCannotDecodeContentData, AFURLResponseSerializationErrorDomain)) { return nil; } } //çœç•¥æ— å…³ä»£ç  id responseObject = [NSJSONSerialization JSONObjectWithData:data options:self.readingOptions error:&amp;serializationError]; //çœç•¥æ— å…³ä»£ç  return responseObject; } - (BOOL)validateResponse:(NSHTTPURLResponse *)response data:(NSData *)data error:(NSError * __autoreleasing *)error { BOOL responseIsValid = YES; NSError *validationError = nil; if ([response isKindOfClass:[NSHTTPURLResponse class]]) { if (self.acceptableContentTypes &amp;&amp; ![self.acceptableContentTypes containsObject:[response MIMEType]] &amp;&amp; !([response MIMEType] == nil &amp;&amp; [data length] == 0)) { //çœç•¥æ— å…³ä»£ç  responseIsValid = NO; } if (self.acceptableStatusCodes &amp;&amp; ![self.acceptableStatusCodes containsIndex:(NSUInteger)response.statusCode] &amp;&amp; [response URL]) { //çœç•¥æ— å…³ä»£ç  responseIsValid = NO; } } //çœç•¥æ— å…³ä»£ç  return responseIsValid; } å…¶ä¸­ï¼ŒAFImageResponseSerializer å¯ä»¥é…ç½®å¯¹ UIImage ç«‹å³è§£ç ï¼Œç›´æ¥ç»˜åˆ¶ bitmapã€‚å› ä¸ºæ˜¯åœ¨å­çº¿ç¨‹ï¼Œæ‰€ä»¥é™ä½äº†ä¸»çº¿ç¨‹è§£ç çš„å‹åŠ›ã€‚ UIKit çš„æ‰©å±• è¿™é‡Œä»¥ UIImageView æ”¯æŒè®¾ç½®ç½‘ç»œå›¾ç‰‡ä¸ºä¾‹ï¼Œå…³é”®æ­¥éª¤éƒ½åŠ äº†æ³¨é‡Šè¯´æ˜ã€‚ - (void)setImageWithURLRequest:(NSURLRequest *)urlRequest placeholderImage:(UIImage *)placeholderImage success:(void (^)(NSURLRequest *request, NSHTTPURLResponse *_Nullable response, UIImage *image))success failure:(void (^)(NSURLRequest *request, NSHTTPURLResponse *_Nullable response, NSError *error))failure { //1.æ˜¯å¦å·²æœ‰ç›¸åŒçš„ä»»åŠ¡åœ¨ä¸‹è½½ if ([self isActiveTaskURLEqualToURLRequest:urlRequest]) { return; } //2.å–æ¶ˆä¹‹å‰çš„ä¸‹è½½ä»»åŠ¡ [self cancelImageDownloadTask]; AFImageDownloader *downloader = [[self class] sharedImageDownloader]; //3.æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜ id&lt;AFImageRequestCache&gt; imageCache = downloader.imageCache; UIImage *cachedImage = [imageCache imageforRequest:urlRequest withAdditionalIdentifier:nil]; if (cachedImage) { self.image = cachedImage; [self clearActiveDownloadInformation]; return; } //4.æ²¡æœ‰ç¼“å­˜ï¼Œå¼€å§‹ä¸‹è½½å›¾ç‰‡ if (placeholderImage) { self.image = placeholderImage; } __weak __typeof(self) weakSelf = self; NSUUID *downloadID = [NSUUID UUID]; AFImageDownloadReceipt *receipt = [downloader downloadImageForURLRequest:urlRequest withReceiptID:downloadID success:^(NSURLRequest *_Nonnull request, NSHTTPURLResponse *_Nullable response, UIImage *_Nonnull responseObject) { __strong __typeof(weakSelf) strongSelf = weakSelf; //5.ä¸‹è½½å®Œæˆè¦æ£€æŸ¥downloadIDæ˜¯å¦è·Ÿå½“å‰æœ€æ–°çš„receiptåŒ¹é…ï¼Œæœ‰å¯èƒ½å‡ºç°ä¸‹è½½é€”ä¸­åŠ å…¥äº†æ–°çš„ä¸‹è½½ä»»åŠ¡oræ¸…é™¤äº†ä¸‹è½½ä»»åŠ¡ if ([strongSelf.af_activeImageDownloadReceipt.receiptID isEqual:downloadID]) { strongSelf.image = responseObject; [strongSelf clearActiveDownloadInformation]; } } failure:^(NSURLRequest *_Nonnull request, NSHTTPURLResponse *_Nullable response, NSError *_Nonnull error) { __strong __typeof(weakSelf) strongSelf = weakSelf; if ([strongSelf.af_activeImageDownloadReceipt.receiptID isEqual:downloadID]) { if (failure) { failure(request, response, error); } [strongSelf clearActiveDownloadInformation]; } }]; self.af_activeImageDownloadReceipt = receipt; } è¿™å…¶å®å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å›¾ç‰‡ä¸‹è½½æ¡†æ¶çš„å®ç°é€»è¾‘ã€‚ ä¸‹é¢ç®€å•çœ‹çœ‹ AFImageDownloader çš„å®ç°ã€‚ - (nullable AFImageDownloadReceipt *)downloadImageForURLRequest:(NSURLRequest *)request withReceiptID:(nonnull NSUUID *)receiptID success:(nullable void (^)(NSURLRequest *request, NSHTTPURLResponse * _Nullable response, UIImage *responseObject))success failure:(nullable void (^)(NSURLRequest *request, NSHTTPURLResponse * _Nullable response, NSError *error))failure { __block NSURLSessionDataTask *task = nil; dispatch_sync(self.synchronizationQueue, ^{ NSString *URLIdentifier = request.URL.absoluteString; if (URLIdentifier == nil) { if (failure) { NSError *error = [NSError errorWithDomain:NSURLErrorDomain code:NSURLErrorBadURL userInfo:nil]; dispatch_async(dispatch_get_main_queue(), ^{ failure(request, nil, error); }); } return; } // 1) Append the success and failure blocks to a pre-existing request if it already exists AFImageDownloaderMergedTask *existingMergedTask = self.mergedTasks[URLIdentifier]; if (existingMergedTask != nil) { AFImageDownloaderResponseHandler *handler = [[AFImageDownloaderResponseHandler alloc] initWithUUID:receiptID success:success failure:failure]; [existingMergedTask addResponseHandler:handler]; task = existingMergedTask.task; return; } // 2) Attempt to load the image from the image cache if the cache policy allows it switch (request.cachePolicy) { case NSURLRequestUseProtocolCachePolicy: case NSURLRequestReturnCacheDataElseLoad: case NSURLRequestReturnCacheDataDontLoad: { UIImage *cachedImage = [self.imageCache imageforRequest:request withAdditionalIdentifier:nil]; if (cachedImage != nil) { if (success) { dispatch_async(dispatch_get_main_queue(), ^{ success(request, nil, cachedImage); }); } return; } break; } default: break; } // 3) Create the request and set up authentication, validation and response serialization NSUUID *mergedTaskIdentifier = [NSUUID UUID]; NSURLSessionDataTask *createdTask; __weak __typeof__(self) weakSelf = self; createdTask = [self.sessionManager dataTaskWithRequest:request uploadProgress:nil downloadProgress:nil completionHandler:^(NSURLResponse * _Nonnull response, id _Nullable responseObject, NSError * _Nullable error) { dispatch_async(self.responseQueue, ^{ __strong __typeof__(weakSelf) strongSelf = weakSelf; AFImageDownloaderMergedTask *mergedTask = [strongSelf safelyGetMergedTask:URLIdentifier]; if ([mergedTask.identifier isEqual:mergedTaskIdentifier]) { mergedTask = [strongSelf safelyRemoveMergedTaskWithURLIdentifier:URLIdentifier]; if (error) { for (AFImageDownloaderResponseHandler *handler in mergedTask.responseHandlers) { if (handler.failureBlock) { dispatch_async(dispatch_get_main_queue(), ^{ handler.failureBlock(request, (NSHTTPURLResponse *)response, error); }); } } } else { if ([strongSelf.imageCache shouldCacheImage:responseObject forRequest:request withAdditionalIdentifier:nil]) { [strongSelf.imageCache addImage:responseObject forRequest:request withAdditionalIdentifier:nil]; } for (AFImageDownloaderResponseHandler *handler in mergedTask.responseHandlers) { if (handler.successBlock) { dispatch_async(dispatch_get_main_queue(), ^{ handler.successBlock(request, (NSHTTPURLResponse *)response, responseObject); }); } } } } [strongSelf safelyDecrementActiveTaskCount]; [strongSelf safelyStartNextTaskIfNecessary]; }); }]; // 4) Store the response handler for use when the request completes AFImageDownloaderResponseHandler *handler = [[AFImageDownloaderResponseHandler alloc] initWithUUID:receiptID success:success failure:failure]; AFImageDownloaderMergedTask *mergedTask = [[AFImageDownloaderMergedTask alloc] initWithURLIdentifier:URLIdentifier identifier:mergedTaskIdentifier task:createdTask]; [mergedTask addResponseHandler:handler]; self.mergedTasks[URLIdentifier] = mergedTask; // 5) Either start the request or enqueue it depending on the current active request count if ([self isActiveRequestCountBelowMaximumLimit]) { [self startMergedTask:mergedTask]; } else { [self enqueueMergedTask:mergedTask]; } task = mergedTask.task; }); if (task) { return [[AFImageDownloadReceipt alloc] initWithReceiptID:receiptID task:task]; } else { return nil; } } ä¸‹è½½æŸä¸ª URLRequest æ—¶ï¼Œä¼šå…ˆåœ¨ä¸‹è½½é˜Ÿåˆ— mergedTasks ä¸­æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ã€‚ å¦‚æœä»»åŠ¡å·²å­˜åœ¨ï¼Œåˆ™ç»™ AFImageDownloaderMergedTask æ·»åŠ ä¸€ä¸ªæ–°çš„ç›‘å¬è€…å³å¯ï¼ˆä¸‹è½½å®Œæˆæ—¶ä¼šé€šçŸ¥æ‰€æœ‰ç›‘å¬è€…ï¼‰ï¼Œç„¶åè¿”å›ä¸€ä¸ªä¸‹è½½ç¥¨æ® AFImageDownloadReceiptã€‚ å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å…ˆæŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼Œæœ‰çš„è¯ç›´æ¥è¿”å›ï¼› æœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œåˆ™éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ AFImageDownloaderMergedTaskï¼Œç„¶ååŠ ä¸Šç›‘å¬è€…ã€‚è¿™ä¸ªè¿‡ç¨‹é€šè¿‡ AFURLSessionManager åˆ›å»ºäº†ä¸€ä¸ª NSURLSessionDataTaskã€‚å¦‚æœå½“å‰å¹¶å‘ä¸‹è½½çš„æ¬¡æ•°è¿˜æ²¡è¾¾åˆ°ä¸Šé™çš„è¯ï¼Œåˆ™ç›´æ¥å¯åŠ¨ Taskï¼Œå¦åˆ™å°±å…ˆè¿›å…¥é˜Ÿåˆ—ç­‰å¾…ã€‚ å‚è€ƒèµ„æ–™ æ‰¾çš„èµ„æ–™æœ‰ç‚¹å¤è€ï¼Œä¸€äº›è¿˜æ˜¯è®²çš„ NSURLConnectionï¼Œå¯ä»¥ç›´æ¥è·³è¿‡ã€‚ AFNetworking 2.0 AFNetworking2.0 æºç è§£æ Â« bangâ€™s blog ","link":"https://jayying007.github.io/post/AFNetworkingæºç åˆ†æ/"},{"title":"FBRetainCycleDetectoræºç åˆ†æ","content":"https://github.com/facebook/FBRetainCycleDetector å†…å­˜ç®¡ç†æ¦‚å¿µ å¯¹äºç¨‹åºä¸­çš„å†…å­˜å¯¹è±¡ç®¡ç†ï¼Œä¸€èˆ¬åˆ†ä¸ºæ‰‹åŠ¨ç®¡ç†ã€å¼•ç”¨è®¡æ•°ç®¡ç†ã€åƒåœ¾å›æ”¶ã€‚ æ‰‹åŠ¨ç®¡ç†ï¼šä¾‹å¦‚ C è¯­è¨€ï¼Œmalloc åä¸éœ€è¦æ—¶ï¼Œéœ€è¦ freeï¼Œä¸ç„¶å°±ä¼šå†…å­˜æ³„éœ²ã€‚ å¼•ç”¨è®¡æ•°ï¼šObjective-C çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼Œç¨æœ‰ä¸æ…å°±ä¼šé€ æˆå¾ªç¯å¼•ç”¨ï¼Œè¿™ä¹Ÿæ˜¯FBRetainCycleDetectorè¦è§£å†³çš„é—®é¢˜ã€‚ åƒåœ¾å›æ”¶ï¼šJava çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼Œä¹‹å‰å†™è¿‡æ–‡ç« ç®€è¿° - åƒåœ¾å›æ”¶ç®—æ³•_Mrzhuang007 çš„åšå®¢-CSDN åšå®¢ å¾ªç¯å¼•ç”¨çš„æ£€æµ‹åŸç† é¦–å…ˆéœ€è¦çŸ¥é“ç¨‹åºåˆ›å»ºäº†å“ªäº› OC å¯¹è±¡ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡ hook alloc æˆ–è€… allocWithZone å»ç›‘æµ‹ï¼› æ¥ä¸‹æ¥è¦çŸ¥é“æ¯ä¸ªå¯¹è±¡å¼ºå¼•ç”¨äº†å“ªäº›å¯¹è±¡ï¼› å¯»æ‰¾æ˜¯å¦æœ‰å¼•ç”¨å›è·¯ï¼› æœ€åéœ€è¦å»é‡ï¼Œæ¯”å¦‚ A-&gt;B-&gt;C-&gt;A å’Œ B-&gt;C-&gt;A-&gt;B å±äºåŒä¸€æ¡é“¾è·¯ã€‚ å¯ä»¥çœ‹å‡ºï¼Œæ£€æµ‹å¾ªç¯å¼•ç”¨ï¼Œç›¸å½“äºåœ¨ä¸€ä¸ªæœ‰å‘å›¾ä¸­æ‰¾åˆ°ç¯ã€‚ è¿™å°±å¾ˆç®€å•äº†ï¼Œéå†æ¯ä¸ªå¯¹è±¡åšä¸€ä¸‹ dfsï¼Œå°±å¯ä»¥çŸ¥é“æ¯ä¸ªå¯¹è±¡æ˜¯å¦ä½äºç¯ä¸­ï¼Œä»¥åŠå±äºå“ªä¸ªç¯ã€‚ FBRetainCycleDetector çš„å®ç° å¯¹è±¡æ£€æµ‹ FBRetainCycleDetectorå®é™…ä¸Šæ²¡æœ‰ hook alloc ä¹‹ç±»çš„æ–¹æ³•ï¼Œè¦æ£€æµ‹æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ä¸»åŠ¨æ·»åŠ å¯¹è±¡ï¼Œé€šè¿‡addCandidate:æ–¹æ³•ã€‚ å³åªå¯¹è¿™äº›å¯¹è±¡åš dfsï¼Œæ¯•ç«Ÿå®é™…é¡¹ç›®ä¸­å¯¹è±¡å®åœ¨å¤ªå¤šäº†ï¼Œæ£€æµ‹èµ·æ¥å†…å­˜å’Œæ€§èƒ½éƒ½æ˜¯é—®é¢˜ã€‚ FBRetainCycleDetectorçš„æ–¹æ³•åªæœ‰ä¸‰ä¸ªï¼š æ„é€ å‡½æ•°å¯é…ç½®å“ªäº›è¾¹å¯ä»¥å¿½ç•¥ï¼Œæ¯•ç«Ÿæœ‰äº›å¾ªç¯å¼•ç”¨æ˜¯æ•…æ„çš„ï¼Œä¼šåœ¨ä¹‹åè‡ªè¡Œæ‰“æ–­ï¼› æ·»åŠ  dfs æœç´¢çš„åˆå§‹å¯¹è±¡ï¼› è¿”å›æœç´¢ç»“æœï¼Œæ•°ç»„ä»£è¡¨ç¯çš„æ•°é‡ï¼Œæ•°ç»„é‡Œçš„å…ƒç´ ä¸ºé›†åˆï¼Œä»£è¡¨æ¯ä¸ªç¯çš„ç»„æˆã€‚ /** FBRetainCycleDetector The main class responsible for detecting retain cycles. Be cautious, the class is NOT thread safe. The process of detecting retain cycles is relatively slow and consumes a lot of CPU. */ @interface FBRetainCycleDetector : NSObject /** Designated initializer @param configuration Configuration for detector. Can include specific filters and options. @see FBRetainCycleDetectorConfiguration */ - (nonnull instancetype)initWithConfiguration:(nonnull FBObjectGraphConfiguration *)configuration NS_DESIGNATED_INITIALIZER; /** Adds candidate you are interested in getting retain cycles from. @param candidate Any Objective-C object you want to verify for cycles. */ - (void)addCandidate:(nonnull id)candidate; /** Searches for all retain cycles for all candidates the detector has been provided with. @return NSSet with retain cycles. An element of this array will be an array representing retain cycle. That array will hold elements of type FBObjectiveCGraphElement. @discussion For given candidate, the detector will go through all object graph rooted in this candidate and return ALL retain cycles that this candidate references. It will also take care of removing duplicates. It will not look for cycles longer than 10 elements. If you want to look for longer ones use findRetainCyclesWithMaxCycleLenght: */ - (nonnull NSSet&lt;NSArray&lt;FBObjectiveCGraphElement *&gt; *&gt; *)findRetainCycles; @end å¯¹è±¡ç»“æ„ä¸å¼•ç”¨æè¿° å¯¹äºæœ‰å‘å›¾ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œéƒ½æ˜¯ç”¨FBObjectiveCGraphElementæ¥æè¿°ã€‚ /** Base Graph Element representation. It carries some data about the object and should be overridden in subclass to provide references that subclass holds strongly (different for blocks, objects, other specializations). The Graph Element itself can only provide references from FBAssociationManager. */ @interface FBObjectiveCGraphElement : NSObject /** Designated initializer. @param object Object this Graph Element will represent. @param configuration Provides detector's configuration that contains filters and options @param namePath Description of how the object was retrieved from it's parent. Check namePath property. */ - (nonnull instancetype)initWithObject:(nullable id)object configuration:(nonnull FBObjectGraphConfiguration *)configuration namePath:(nullable NSArray&lt;NSString *&gt; *)namePath; /** Name path that describes how this object was retrieved from its parent object by names (for example ivar names, struct references). For more check FBObjectReference protocol. */ @property (nonatomic, copy, readonly, nullable) NSArray&lt;NSString *&gt; *namePath; @property (nonatomic, weak, nullable) id object; @property (nonatomic, readonly, nonnull) FBObjectGraphConfiguration *configuration; /** Main accessor to all objects that the given object is retaining. Thread unsafe. @return NSSet of all objects this object is retaining. */ - (nullable NSSet *)allRetainedObjects; @end ç»“åˆ ObjC çš„ç‰¹æ€§ï¼Œå¯ä»¥æ‰©å±•å‡ºä»¥ä¸‹ç±»å‹ï¼š ä¹‹æ‰€ä»¥æœ‰ä¸åŒçš„æ´¾ç”Ÿç±»ï¼Œä¸»è¦æ˜¯è·å–å¼ºå¼•ç”¨å¯¹è±¡çš„æ–¹æ³•allRetainedObjectsæœ‰æ‰€ä¸åŒ FBObjectiveCGraphElementï¼šè·å– associate ç»‘å®šçš„å¯¹è±¡ï¼› FBObjectiveCBlockï¼šåŸæœ‰åŸºç¡€ä¸Šï¼Œåˆ©ç”¨ Block çš„ç»“æ„ä½“ï¼Œè®¡ç®—å‡ºå¼ºå¼•ç”¨çš„å¯¹è±¡ï¼› FBObjectiveCObjectï¼šåŸæœ‰åŸºç¡€ä¸Šï¼Œè·å– Ivarsï¼Œå¦‚æœä¸ºé›†åˆå¯¹è±¡ï¼Œåˆ™è·å–å…¶ keys å’Œ valuesï¼› FBObjectiveCNSCFTimerï¼šåŸæœ‰åŸºç¡€ä¸Šï¼Œè·å– NSTimer ä¸­çš„ target å’Œ userInfoï¼› Ivars å¯ä»¥åˆ©ç”¨ ObjC Runtime è·å–ï¼Œåˆ©ç”¨ IvarsLayout å¯ä»¥çŸ¥é“æ˜¯å¼±å¼•ç”¨è¿˜æ˜¯å¼ºå¼•ç”¨ã€‚å¯¹äº IvarsLayout çš„è¯´æ˜å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  å¯¹äºç»“æ„ä½“å†…éƒ¨å˜é‡çš„è·å–åˆ™ç¨å¾®å¤æ‚ä¸€äº›ï¼Œéœ€è¦è€ƒè™‘ç»“æ„ä½“å¯¹é½é—®é¢˜ï¼Œç„¶ååˆ©ç”¨ typeEncoding è·å¾— OC å¯¹è±¡ã€‚ Block åˆ™åˆ›å»ºä¸€äº›è™šæ‹Ÿçš„å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ Block çš„ dispose æ–¹æ³•ï¼Œè°è°ƒç”¨äº† release æ–¹æ³•å°±å¯ä»¥çŸ¥é“å“ªä¸ªæ˜¯çœŸæ­£çš„ OC å¼ºå¼•ç”¨å¯¹è±¡ã€‚ Ivarsã€ç»“æ„ä½“ã€Block å¼ºå¼•ç”¨å¯¹è±¡çš„æ–¹æ³•è¿˜æŒºæœ‰æ„æ€çš„ï¼Œå»ºè®®è‡ªè¡Œé˜…è¯»æºç ï¼Œæ„Ÿå—å…¶å¥¥ç§˜ã€‚ å¾ªç¯å¼•ç”¨çš„æ£€æµ‹ ä¸Šæ–‡ä¹Ÿè¯´äº†ï¼Œæ£€æµ‹ç”¨çš„æ˜¯ DFSï¼Œä¸è¿‡è¿™é‡Œå¹¶æ²¡æœ‰ç”¨é€’å½’ï¼Œè€Œæ˜¯åˆ©ç”¨å¾ªç¯å»æ¨¡æ‹Ÿæ¡Ÿçš„è¿è¡Œã€‚ä»£ç å¦‚ä¸‹ï¼š - (NSSet&lt;NSArray&lt;FBObjectiveCGraphElement *&gt; *&gt; *)_findRetainCyclesInObject:(FBObjectiveCGraphElement *)graphElement stackDepth:(NSUInteger)stackDepth { NSMutableSet&lt;NSArray&lt;FBObjectiveCGraphElement *&gt; *&gt; *retainCycles = [NSMutableSet new]; FBNodeEnumerator *wrappedObject = [[FBNodeEnumerator alloc] initWithObject:graphElement]; // We will be doing DFS over graph of objects // Stack will keep current path in the graph NSMutableArray&lt;FBNodeEnumerator *&gt; *stack = [NSMutableArray new]; // To make the search non-linear we will also keep // a set of previously visited nodes. NSMutableSet&lt;FBNodeEnumerator *&gt; *objectsOnPath = [NSMutableSet new]; // Let's start with the root [stack addObject:wrappedObject]; while ([stack count] &gt; 0) { // Take topmost node in stack and mark it as visited FBNodeEnumerator *top = [stack lastObject]; [objectsOnPath addObject:top]; // Take next adjecent node to that child. Wrapper object can // persist iteration state. If we see that node again, it will // give us new adjacent node unless it runs out of them FBNodeEnumerator *firstAdjacent = [top nextObject]; if (firstAdjacent) { // Current node still has some adjacent not-visited nodes BOOL shouldPushToStack = NO; // Check if child was already seen in that path if ([objectsOnPath containsObject:firstAdjacent]) { // We have caught a retain cycle NSUInteger index = [stack indexOfObject:firstAdjacent]; NSInteger length = [stack count] - index; NSRange cycleRange = NSMakeRange(index, length); NSMutableArray&lt;FBNodeEnumerator *&gt; *cycle = [[stack subarrayWithRange:cycleRange] mutableCopy]; [cycle replaceObjectAtIndex:0 withObject:firstAdjacent]; [retainCycles addObject:[self _unwrapCycle:cycle]]; } else { // Node is clear to check, add it to stack and continue shouldPushToStack = YES; } if (shouldPushToStack &amp;&amp; [stack count] &lt; stackDepth) { [stack addObject:firstAdjacent]; } } else { // Node has no more adjacent nodes, it itself is done, move on [stack removeLastObject]; [objectsOnPath removeObject:top]; } } return retainCycles; } ä¸ºäº†ä»£ç çš„æ˜“è¯»æ€§ï¼Œè¿™é‡Œåˆ äº†ä¸€äº›ä»£ç ã€‚ å…¶å®è¿™é‡Œè¿˜åšäº† dfs çš„å‰ªæä¼˜åŒ–ï¼Œè·³è¿‡äº†ä¸€äº›ä¸å¿…è¦çš„éå†è·¯å¾„ï¼Œä»£ç å¦‚ä¸‹ // We don't want to retraverse the same subtree if (![objectsOnPath containsObject:top]) { if ([_objectSet containsObject:@([top.object objectAddress])]) { [stack removeLastObject]; continue; } // Add the object address to the set as an NSNumber to avoid // unnecessarily retaining the object [_objectSet addObject:@([top.object objectAddress])]; } è®¾æƒ³ä¸‹é¢çš„åœºæ™¯ dfs é€šè¿‡è·¯å¾„ A-&gt;B-&gt;D-&gt;E-&gt;F-&gt;Dï¼Œå·²ç»å‘ç°äº† Dã€Eã€F ä¹‹é—´çš„å¾ªç¯å¼•ç”¨ã€‚è€Œä¸”æŒ‰ç…§ dfs çš„ç‰¹æ€§ï¼ŒDã€Eã€F æ‰€æœ‰å…³è”çš„è·¯å¾„éƒ½å·²ç»éå†å®Œäº†ã€‚ åé¢å½“ dfs æ¥åˆ° A-&gt;C-&gt;E æ—¶ï¼Œå…¶å®å°±æ²¡å¿…è¦å†å¾€ä¸‹æ£€æµ‹äº†ï¼Œå› ä¸º E æ‰€æœ‰è·¯å¾„éƒ½æ£€æŸ¥è¿‡äº†ã€‚ è¡¥å…… å¯¹äºæœ€åæ£€æµ‹å‡ºæ¥çš„ç¯ï¼Œé€‰æ‹©å…¶ä¸­å¯¹è±¡åœ°å€æœ€å°çš„ä½œä¸ºç¯çš„å¤´èŠ‚ç‚¹ã€‚ç„¶ååœ¨æ ¹æ®ç±»åè¿›è¡Œå­—ç¬¦ä¸²æ’åºï¼Œæ‰¾åˆ°ä¸€ä¸ªå­—å…¸åºæœ€å°çš„ã€‚ æœ€åè¿™ä¸¤ä¸ªæ„Ÿè§‰å¯æœ‰å¯æ— ï¼Œæ²¡å‘ç°æœ‰ä»€ä¹ˆåœºæ™¯éœ€è¦ç”¨åˆ°ã€‚ æŸ¥çœ‹ Git çš„æäº¤è®°å½•ï¼Œå¯ä»¥å‘ç°æ˜¯æœ€åˆçš„å»é‡ç‰ˆæœ¬ã€‚åé¢å¼•å…¥å‰ªæåï¼Œå°±æ²¡ä½œç”¨äº†ï¼Œåªæ˜¯ä»£ç è¿˜æ²¡åˆ ã€‚ã€‚ ","link":"https://jayying007.github.io/post/FBRetainCycleDetectoræºç åˆ†æ/"},{"title":"Mach-Oæ–‡ä»¶çš„æ„å»ºã€è§£æä¸è¿è¡Œ","content":" çœæµï¼šå¦‚æœä½ è¿˜æ²¡æœ‰çœ‹è¿‡ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹ï¼Œé‚£å»ºè®®è¿˜æ˜¯å…ˆå»çœ‹å®Œè¿™æœ¬ä¹¦å§ã€‚ ç®€ä»‹ ç±»ä¼¼äº Window çš„ PE æ–‡ä»¶ã€Linux çš„ ELF æ–‡ä»¶ï¼ŒOS X ä¸Šæ‰€æœ‰çš„ Appã€Frameworkã€Libiaryã€Command-Line Tool éƒ½å¯ä»¥ç§°ä¸º Mach-O æ–‡ä»¶ã€‚ å¯¹è¿™äº› Mach-O æ–‡ä»¶çš„è¿›ä¸€æ­¥æè¿°ï¼Œå¯ä»¥å‚è€ƒThe Productsâ€”Types of Mach-O Files You Can Build ä¸€ä¸ª Mach-O æ–‡ä»¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šHeaderã€Load Commandsã€Dataã€‚ Headerï¼šåŒ…å«è¯¥æ–‡ä»¶çš„ç›®æ ‡æ¶æ„ç­‰ä¿¡æ¯ï¼› Load Commandsï¼šæè¿°äº†è¯¥æ–‡ä»¶çš„åŸºæœ¬ç»“æ„ï¼ˆæ¯”å¦‚ç¬¦å·è¡¨åœ¨å“ªä¸ªåœ°æ–¹ï¼ŒSegment è¦åŠ åˆ°è™šæ‹Ÿå†…å­˜åœ°å€çš„å“ªä¸ªåœ°æ–¹ï¼‰ï¼› Dataï¼šè£¸çš„æ•°æ®ï¼Œå…·ä½“æ¯ä¸ª Byte ä»£è¡¨å•¥å°±çœ‹ Load Commands ä¸­çš„å®šä¹‰äº†ã€‚ ä¸€ä¸ª Mach-O åªåŒ…å«ä¸€ç§æ¶æ„çš„ä»£ç å’Œæ•°æ®ï¼ŒåŒ…å«å¤šä¸ªçš„è¢«ç§°ä¸º universal binaryã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ–‡ä»¶å¼€å¤´ä¸ºä¸€ä¸ªfat_headerç»“æ„ä½“ï¼Œè·Ÿéšä¸€ä¸ªfat_archç»“æ„ä½“æ•°ç»„ï¼Œæ ¹æ®è¿™ä¸ªfat_archçš„ä¿¡æ¯ï¼Œå°±èƒ½å¿«é€Ÿæ‰¾åˆ°é€‚åˆå½“å‰æœºå™¨æ‰§è¡Œçš„ä»£ç å’Œæ•°æ®çš„ä½ç½®ã€‚ ç¨‹åºè¿è¡Œè¿‡ç¨‹æµ…æ Mach-O æ–‡ä»¶æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ç±»å‹ï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹é€šè¿‡å‘½ä»¤è¡Œæˆ–åŒå‡»å¯åŠ¨ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ã€‚ å†è¯´ä¸€æ¬¡ï¼Œæƒ³è·å–è¿™éƒ¨åˆ†æ›´å®Œæ•´çš„çŸ¥è¯†ï¼Œå»çœ‹ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹ã€‚ å½“è¿è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼Œå†…æ ¸ä¸ºè¯¥ç¨‹åºåˆ›å»ºå¯¹åº”çš„è¿›ç¨‹ï¼Œå¹¶å°†å…¶è½½å…¥è¿›ç¨‹ç©ºé—´ä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠåŠ¨æ€é“¾æ¥å™¨ï¼ˆé€šå¸¸æ˜¯/usr/lib/dyldï¼‰è½½å…¥è¿›ç¨‹ç©ºé—´ä¸­ã€‚éšåæŠŠæ§åˆ¶å™¨äº¤ç»™åŠ¨æ€é“¾æ¥å™¨ï¼Œå³è·³è½¬åˆ°åŠ¨æ€é“¾æ¥å™¨æŒ‡å®šçš„å…¥å£åœ°å€ã€‚ è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œforkå’Œexecveã€‚forkåˆ›å»ºäº†è¿›ç¨‹ï¼Œexecveå°†ç¨‹åºè½½å…¥è¿›ç¨‹ç©ºé—´å¹¶æ‰§è¡Œã€‚è½½å…¥çš„ Mach-O æ–‡ä»¶ä¸­ï¼Œä¼šæœ‰ä¸€æ¡ load command æŒ‡ç¤ºä»å“ªé‡ŒåŠ è½½åŠ¨æ€é“¾æ¥å™¨ã€‚ åŠ¨æ€é“¾æ¥å™¨ä¼šæŸ¥æ‰¾ç¨‹åºä¾èµ–çš„æ‰€æœ‰åŠ¨æ€åº“ï¼ˆè¿™éƒ¨åˆ†ä¿¡æ¯ä¹Ÿåœ¨ load command ä¸­ï¼‰ï¼Œç„¶åé€’å½’å°†å®ƒä»¬ä¹ŸåŠ è¿›æ¥ã€‚ éšååŠ¨æ€é“¾æ¥å™¨ä¼šåšå¿…è¦çš„ç¬¦å·ç»‘å®šï¼Œç„¶åè°ƒç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚è¿™ä¸ªå…¥å£ç‚¹å‡½æ•°æ˜¯é™æ€é“¾æ¥æ—¶æ·»åŠ çš„ï¼Œå®ƒä¼šåšä¸€äº› C++é™æ€å¯¹è±¡åˆå§‹åŒ–ã€ObjC è¿è¡Œæ—¶ä¹‹ç±»çš„æ“ä½œï¼Œæœ€åä¼šè°ƒç”¨ main å‡½æ•°ã€‚ å°ç»“ App å¯åŠ¨è¿‡ç¨‹å…¶å®ä¹‹å‰ä¹Ÿå†™è¿‡æ–‡ç« åˆ†äº«ï¼Œä¼ é€é—¨ iOS App çš„å¯åŠ¨è¿‡ç¨‹ï¼ˆæµç¨‹ç¯‡ï¼‰ æˆ–è€…çœ‹ä¸‹è‹¹æœæ–‡æ¡£ï¼šForking and Executing the Processã€Finding Imported Symbols ä¸‹é¢ç¨å¾®ä»‹ç»ä¸€ä¸‹ç¬¦å·ç»‘å®šã€‚ ç¬¦å·ç»‘å®š è®²è§£ç¬¦åˆç»‘å®šä¹‹å‰ï¼Œå…ˆç®€å•è¯´æ˜ä¸€ä¸‹æ¨¡å—ï¼ˆmoduleï¼‰çš„å«ä¹‰ï¼Œæ¨¡å—æ˜¯ç”±æ•°æ®å’Œä»£ç æ„æˆçš„æœ€å°å•å…ƒï¼Œå¯ä»¥ç‹¬ç«‹è·Ÿå…¶ä»–å•å…ƒé“¾æ¥ã€‚ä¾‹å¦‚ç¼–è¯‘æ–‡ä»¶ main.cã€thing.cã€foo.cï¼Œäº§ç”Ÿäº† main.oã€thing.oã€foo.oï¼Œè¿™é‡Œå°±æ˜¯ä¸‰ä¸ªæ¨¡å—ã€‚ä¸è¿‡åœ¨ç¼–è¯‘ App æ—¶ï¼Œé™æ€é“¾æ¥å™¨ä¼šæŠŠå®ƒä»¬åˆå¹¶ä¸ºåŒä¸€æ¨¡å—ã€‚ åŒä¸€æ¨¡å—å†…ï¼Œç”±äºçŸ¥é“å‡½æ•°ã€æ•°æ®çš„åœ°å€ï¼Œæ‰€æœ‰æ¨¡å—å†…çš„ç¬¦å·å¼•ç”¨éƒ½å¯ä»¥åœ¨é™æ€é˜¶æ®µç¡®å®šä¸‹æ¥ã€‚ä½†æ˜¯ç¨‹åºä¹Ÿä¼šå­˜åœ¨å¼•ç”¨ openã€printf è¿™ç±»ç³»ç»Ÿåº“ä¸­çš„ç¬¦å·ï¼Œå±äºè·¨æ¨¡å—ç¬¦å·å¼•ç”¨ã€‚ ä¸€ä¸ªæ¨¡å—ï¼ˆæºç¨‹åºï¼‰å¼•ç”¨äº†å¦ä¸€ä¸ªæ¨¡å—ï¼ˆåŠ¨æ€åº“ï¼‰çš„æ•°æ®æˆ–å‡½æ•°ï¼Œéœ€è¦ç­‰å¦ä¸€ä¸ªæ¨¡å—åŠ è½½åˆ°è¿›ç¨‹ç©ºé—´åï¼Œæ‰èƒ½ç¡®å®šè¯¥æ¨¡å—å‡½æ•°å’Œæ•°æ®çš„å…·ä½“åœ°å€ï¼Œç„¶åå†åšå¼•ç”¨ç¬¦å·åœ°å€çš„ä¿®æ­£ï¼Œæˆ–è€…å«ç¬¦å·ç»‘å®šã€‚ ç¬¦å·ç»‘å®šçš„æ–¹å¼é€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§ï¼š lazy-bindingï¼Œè™½ç„¶ç¨‹åºè¿è¡Œæ—¶å°±æŠŠå…±äº«åº“åŠ åˆ°è¿›ç¨‹ç©ºé—´ä¸­ï¼Œä½†ç›´åˆ°ç¬¬ä¸€æ¬¡å¼•ç”¨ç¬¦å·æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨æ‰å»åšç»‘å®šã€‚ load-time bindingï¼Œé¡¾åæ€ä¹‰ï¼Œç¨‹åºè¿è¡Œæ—¶å°±è¿›è¡Œç»‘å®šã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŠ¨æ€é“¾æ¥å™¨æ‰§è¡Œ lazy-binding çš„ç­–ç•¥ã€‚åœ¨ ld é˜¶æ®µï¼Œé€šè¿‡æ·»åŠ å‚æ•°-bind_at_loadå³å¯å¼ºåˆ¶è¿è¡Œæ—¶ç»‘å®šã€‚ prebindingï¼Œå°‘ç”¨ï¼Œä¸å¤šåšè¯´æ˜ã€‚ ä¸è¿‡ç¬¦å·ç»‘å®šæ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œä»”ç»†ä¸€æƒ³ï¼Œä½ çŸ¥é“äº† openã€printf ç­‰å‡½æ•°çš„åœ°å€ï¼Œä½†æ˜¯ä½ æ— æ³•å°†è¿™äº›ä¿¡æ¯å¡«å……åˆ°æºç¨‹åºçš„ä»£ç æ®µä¸­ï¼Œå› ä¸ºä»£ç æ®µçš„æƒé™æ˜¯åªè¯»å’Œå¯æ‰§è¡Œï¼Œä¸èƒ½å†™ã€‚ ä¼¼ä¹é™·å…¥äº†åƒµå±€ï¼ŒåŠ¨æ€åº“çš„å‡½æ•°åœ°å€è¦è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šï¼Œè€Œä¿®æ”¹ä»£ç æ®µåªèƒ½åœ¨é™æ€é“¾æ¥é˜¶æ®µï¼Œä¸€æ—¦è½½å…¥å†…å­˜å°±æ— æ³•ä¿®æ”¹ã€‚ ä¸è¿‡é€€ä¸€ä¸‡æ­¥è®²ï¼Œå³ä½¿ä»£ç æ®µå¯å†™ï¼Œä¹Ÿä¼šæœ‰å…¶ä»–é—®é¢˜ã€‚é™¤äº†æºç¨‹åºå¼•ç”¨åŠ¨æ€åº“ï¼Œä¹Ÿä¼šæœ‰åŠ¨æ€åº“å¼•ç”¨å¦ä¸€ä¸ªåŠ¨æ€åº“çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ¨æ€åº“é‡Œé¢ä¹Ÿæœ‰å¼•ç”¨ç¬¦å·éœ€è¦ä¿®æ­£ã€‚é—®é¢˜å°±åœ¨è¿™é‡Œï¼Œä½ çš„ç¨‹åºä¿®æ­£äº†åŠ¨æ€åº“é‡Œé¢çš„ç¬¦å·å¼•ç”¨åœ°å€ï¼Œä½†æ˜¯åŠ¨æ€åº“æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«çš„å‘€ã€‚æœ‰å¯èƒ½å…¶ä»–è¿›ç¨‹ä¹Ÿä¾èµ–è¿™ä¸ªåŠ¨æ€åº“ï¼Œè€Œå®ƒå¯¹åº”çš„ç¬¦å·åœ°å€ä¸è§å¾—è·Ÿä½ çš„ä¸€æ ·ï¼Œè¿™æ ·æå…¶ä»–è¿›ç¨‹å°±å´©æºƒäº†ã€‚é‚£ä½ åªèƒ½æ¯ä¸ªè¿›ç¨‹éƒ½æä¸€ä»½è‡ªå·±çš„ï¼Œä¸è¿‡è¿™æ ·å°±å¤±å»äº†åŠ¨æ€åº“èŠ‚çœç©ºé—´çš„ä¸€å¤§ä¼˜åŠ¿äº†ã€‚ ä¸è¿‡åŠæ³•æ€»æ¯”å›°éš¾å¤šï¼Œä»£ç æ®µä¸å¯å†™ï¼Œä½†æ˜¯æ•°æ®æ®µå¯å†™å‘€ï¼Œäºæ˜¯å°±æœ‰äº†æ›²çº¿æ•‘å›½çš„æ–¹å¼ã€‚åŠ¨æ€åº“çš„å‡½æ•°åœ°å€è¿è¡Œæ—¶ç¡®å®šåï¼ŒæŠŠåœ°å€å†™åˆ°__DATAçš„æŸä¸ªåœ°æ–¹ã€‚ç”±äº__TEXTå’Œ__DATAçš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ä»£ç ä¸Šå¯ä»¥åˆ©ç”¨å½“å‰ PC+åç§»é‡å¾—åˆ°åœ°å€å­˜æ”¾çš„ä½ç½®ï¼Œç„¶åå†è®¿é—®åœ°å€ã€‚è¿™ç§æ–¹å¼åˆå«é—´æ¥ç¬¦å·å¼•ç”¨ã€‚ fishhookåˆ©ç”¨è¿™ä¸ªç‰¹æ€§å®ç°äº† Hook C å‡½æ•°ã€‚ PSï¼šæœ¬æ¥æƒ³å†™ä¸€ç¯‡æºç åˆ†ææ–‡ç« çš„ï¼Œä½†æºç å…¶å®å°±ä¸¤ç™¾æ¥è¡Œï¼ŒçŸ¥é“ Mach-O å’ŒåŠ¨æ€é“¾æ¥çš„ç‰¹æ€§åä¹Ÿä¸éš¾ç†è§£ï¼Œäºæ˜¯æ”¾å¼ƒäº†ã€‚ åº–ä¸è§£ç‰› å‰é¢å·²ç»è®²äº† Mach-O æ–‡ä»¶æ‰§è¡Œçš„ä¸€äº›ç»†èŠ‚ï¼Œæ¥ä¸‹æ¥å°±äº²è‡ªåŠ¨æ‰‹ï¼Œé€ä¸ª Byte åˆ†æ Mach-O æ–‡ä»¶çš„å¥¥ç§˜ã€‚ä¸­é—´ä¼šç©¿æ’å„ç§ ğŸ§‘â€ğŸ’»Codingï¼Œç”¨äºéªŒè¯ã€‚ å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ æŸ¥çœ‹ä¸€ä¸ª Mach-O æ–‡ä»¶åŒ…å«ä»€ä¹ˆä¿¡æ¯ï¼Œæœ‰å¾ˆå¤šå·¥å…·å¯ä»¥ä½¿ç”¨ã€‚ lipoï¼šåˆ†æä½“ç³»ç»“æ„ fileï¼šæ˜¾ç¤ºæ–‡ä»¶ç±»å‹ otoolï¼šæŸ¥çœ‹ Mach-O æ–‡ä»¶å…·ä½“çš„ Segmentã€Section æ•°æ® pagestuffï¼šæŒ‰é¡µæŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯ nmï¼šæŸ¥çœ‹ç¬¦å·è¡¨ libtoolï¼šå¯å°†å¤šä¸ªä¸­é—´æ–‡ä»¶åˆå¹¶ä¸ºé™æ€åº“ a ğŸ’¡ ä¸Šé¢çš„éƒ½æ˜¯å‘½ä»¤è¡Œå·¥å…·ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªå¸¸ç”¨çš„å¯è§†åŒ–å·¥å…· MachOView å¦å¤–å†è¡¥ä¸€ä¸‹æˆ‘çš„ç”µè„‘é…ç½® emmmï¼Œå½“æ—¶ M1 Max åˆšå‡ºæ—¶ä¹°çš„ï¼Œç­‰äº†å¿«ä¸€ä¸ªæœˆæ‰åˆ°è´§... ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚ åˆ›å»ºä¸€ä¸ªæ–‡ä»¶file_b.cï¼Œå†…å®¹å¦‚ä¸‹ int base = 0xfff0; int getAddress(int base, int offset) { return base + offset; } ç„¶åç¼–è¯‘ //å•ç‹¬ç¼–è¯‘ï¼Œä¸é“¾æ¥ clang -c file_b.c -o file_b.o Header Mach-O æ–‡ä»¶å¼€å¤´æ˜¯ä¸€ä¸ªmach_headerç»“æ„ä½“ã€‚ä»£ç ä½äº mach-o/loader.hï¼Œå…¶åœ¨ 32 ä½å’Œ 64 ä½æœºå™¨ä¸‹ç»“æ„ç¨æœ‰ä¸åŒã€‚ /* * The 32-bit mach header appears at the very beginning of the object file for * 32-bit architectures. */ struct mach_header { uint32_t magic; /* mach magic number identifier */ int32_t cputype; /* cpu specifier */ int32_t cpusubtype; /* machine specifier */ uint32_t filetype; /* type of file */ uint32_t ncmds; /* number of load commands */ uint32_t sizeofcmds; /* the size of all the load commands */ uint32_t flags; /* flags */ }; struct mach_header_64 { uint32_t magic; /* mach magic number identifier */ int32_t cputype; /* cpu specifier */ int32_t cpusubtype; /* machine specifier */ uint32_t filetype; /* type of file */ uint32_t ncmds; /* number of load commands */ uint32_t sizeofcmds; /* the size of all the load commands */ uint32_t flags; /* flags */ uint32_t reserved; /* reserved */ }; magic è¡¨ç¤ºå½“å‰ Mach-O æ–‡ä»¶å¯è¿è¡Œäº 32 ä½è¿˜æ˜¯ 64 ä½æœºå™¨ï¼Œä»¥åŠæœºå™¨çš„ç«¯åºã€‚ /* Constant for the magic field of the mach_header (32-bit architectures) */ #define MH_MAGIC 0xfeedface /* the mach magic number */ #define MH_CIGAM 0xcefaedfe /* NXSwapInt(MH_MAGIC) */ /* Constant for the magic field of the mach_header_64 (64-bit architectures) */ #define MH_MAGIC_64 0xfeedfacf /* the 64-bit mach magic number */ #define MH_CIGAM_64 0xcffaedfe /* NXSwapInt(MH_MAGIC_64) */ cputypeã€cpusubtype è¡¨ç¤ºæœºå™¨æ¶æ„ï¼Œå¦‚ CPU_TYPE_ARM64ã€CPU_TYPE_X86_64ã€‚æ›´å¤šå®šä¹‰å¯ä»¥æŸ¥çœ‹ mach/machine.h filetype è¡¨ç¤º Mach-O æ–‡ä»¶çš„ç±»å‹ï¼Œå¸¸è§çš„æœ‰ï¼šä¸­é—´å¯¹è±¡æ–‡ä»¶ï¼ˆMH_OBJECTï¼‰ã€å¯æ‰§è¡ŒäºŒè¿›åˆ¶ï¼ˆMH_EXECUTEï¼‰ã€VM å…±äº«åº“æ–‡ä»¶ï¼ˆMH_FVMLIBï¼‰ã€Crash äº§ç”Ÿçš„ Core æ–‡ä»¶ï¼ˆMH_COREï¼‰ã€åŠ¨æ€å…±äº«åº“ï¼ˆMH_DYLIBï¼‰ã€åŠ¨æ€é“¾æ¥å™¨ï¼ˆMH_DYLINKERï¼‰ã€é™æ€é“¾æ¥æ–‡ä»¶ï¼ˆMH_DYLIB_STUBï¼‰ã€ç¬¦å·æ–‡ä»¶å’Œè°ƒè¯•ä¿¡æ¯ï¼ˆMH_DSYMï¼‰ ncmds å’Œ sizeofcmds ä»£è¡¨æœ‰å¤šå°‘ load command ä»¥åŠæ‰€å å¤§å° flags æ˜¯ä¸€äº›æ ‡è®°å­—æ®µï¼Œå…·ä½“å«ä¹‰å¯å‚è€ƒ loader.h ä¸­çš„è¯´æ˜ã€‚ ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚ æˆ‘ä»¬å¯ä»¥ç”¨å‘½ä»¤è¡Œå·¥å…·æ‰“å°ä¸€ä¸‹ otool -v -h file_b.o ç»“æœå¦‚ä¸‹ Mach header magic cputype cpusubtype caps filetype ncmds sizeofcmds flags MH_MAGIC_64 ARM64 ALL 0x00 OBJECT 4 440 SUBSECTIONS_VIA_SYMBOLS ç›´æ¥ç”¨ä»£ç éªŒè¯ ä¸ºäº†ä¾¿äºåç»­ä»£ç ç¼–å†™ï¼Œè¿™é‡ŒåŠ å‡ ä¸ªåˆ«åå’Œå®å®šä¹‰ï¼Œæ–°å‡ºç°çš„ä¹ŸæŒ‰åŒæ ·è§„åˆ™å¤„ç† #ifdef __LP64__ typedef struct mach_header_64 mach_header_t; typedef struct segment_command_64 segment_command_t; typedef struct section_64 section_t; typedef struct nlist_64 nlist_t; #define LC_SEGMENT_ARCH_DEPENDENT LC_SEGMENT_64 #else typedef struct mach_header mach_header_t; typedef struct segment_command segment_command_t; typedef struct section section_t; typedef struct nlist nlist_t; #define LC_SEGMENT_ARCH_DEPENDENT LC_SEGMENT #endif #ifndef SEG_DATA_CONST #define SEG_DATA_CONST &quot;__DATA_CONST&quot; #endif typedef struct load_command load_command_t; typedef struct dylib_command dylib_command_t; typedef struct dylinker_command dylinker_command_t; typedef struct symtab_command symtab_command_t; typedef struct dysymtab_command dysymtab_command_t; void *getFilePointer(const char *filePath) { int fd = open(filePath, O_RDONLY, S_IRUSR); struct stat st = {}; fstat(fd, &amp;st); uint64_t fileSize = (uint64_t)st.st_size; void *ptr = mmap(NULL, fileSize, PROT_READ, MAP_SHARED, fd, 0); return ptr; } void startReadMachO(const char *filePath) { void *filePtr = getFilePointer(filePath); void *curPtr = filePtr; mach_header_t *header = (mach_header_t *)curPtr; printf(&quot;magic: %x\\n&quot;, header-&gt;magic); printf(&quot;cputype: %u\\n&quot;, header-&gt;cputype); printf(&quot;cpusubtype: %u\\n&quot;, header-&gt;cpusubtype); printf(&quot;filetype: %u\\n&quot;, header-&gt;filetype); printf(&quot;ncmds: %u\\n&quot;, header-&gt;ncmds); printf(&quot;sizeofcmds: %u\\n&quot;, header-&gt;sizeofcmds); printf(&quot;flags: %u\\n&quot;, header-&gt;flags); } ä¼ å…¥ file_b.o çš„è·¯å¾„ï¼Œå¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼Œæ•°æ®å»åˆ magic: feedfacf cputype: 16777228 cpusubtype: 0 filetype: 1 ncmds: 4 sizeofcmds: 440 flags: 8192 Load Commands ä¸‹ä¸€æ­¥æ¥åˆ° load commandï¼Œä» mach_header é‚£é‡Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† load commands çš„æ€»ä½“å¤§å°ã€‚ load command æœ‰å¾ˆå¤šç§ï¼Œä½†æ˜¯æ‰€æœ‰ load command ç»“æ„ä½“çš„å‰ä¸¤ä¸ªå±æ€§æ˜¯ä¸€æ ·çš„ï¼Œç±»ä¼¼äºé¢å‘å¯¹è±¡ä¸­çš„åŸºç±»ã€‚ struct load_command { uint32_t cmd; /* type of load command */ uint32_t cmdsize; /* total size of command in bytes */ }; cmd ä»£è¡¨äº† load command çš„ç±»å‹ï¼Œcmdsize ä»£è¡¨å…·ä½“ load command çš„ç»“æ„ä½“å¤§å° + é¢å¤–æ•°æ®å¤§å°ã€‚å…·ä½“çš„ load command ç»“æ„å¯åœ¨ loader.h ä¸­æŸ¥çœ‹ åœ¨æˆ‘ä»¬çš„file_b.oä¸­ï¼Œå…±æœ‰ 4 ä¸ª load commandsï¼Œåˆ†åˆ«ä¸º LC_BUILD_VERSIONã€LC_SEGMENT_64ã€LC_SYMTABã€LC_DYSYMTABï¼Œç¬¬ä¸€ä¸ªä¸å¤ªé‡è¦ï¼Œç›´æ¥å¿½ç•¥ã€‚ LC_SEGMENT_64 å¯¹åº”ç»“æ„ä½“segment_command_64ï¼ŒæŒ‡å®šäº† Mach-O æ–‡ä»¶æŸä¸ªæ®µçš„ä¿¡æ¯ï¼Œæ®µæ˜¯ä¼šè¢«è½½å…¥è¿›ç¨‹ç©ºé—´çš„ï¼Œç»“æ„ä½“ä¸­åŒæ—¶è¿˜è¯´æ˜äº†è½½å…¥çš„è™šæ‹Ÿåœ°å€ä½ç½®ã€‚ å†æ¬¡ç¥­å‡ºè¿™å¼ å›¾ Data åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª segment çš„æ•°æ®ï¼Œä¸€ä¸ª segment æœ‰ 0 ä¸ªæˆ–å¤šä¸ª sectionï¼Œæ¯ä¸ª section åŒ…å« code æˆ–è€… dataã€‚ æ¯ä¸ª section éƒ½æœ‰ç¼–å·ï¼Œä» 1 å¼€å§‹ï¼Œä¸”è·¨å¤šä¸ª segmentã€‚æ¯”å¦‚ç¬¬ä¸€ä¸ª segment æœ‰ section1 section2 section3ï¼Œç¬¬äºŒä¸ª segment æœ‰ section4 section5... section å¯¹åº”ç»“æ„ä½“section_64ï¼Œè·Ÿåœ¨segment_command_64ä¹‹åã€‚ /* * The 64-bit segment load command indicates that a part of this file is to be * mapped into a 64-bit task's address space. If the 64-bit segment has * sections then section_64 structures directly follow the 64-bit segment * command and their size is reflected in cmdsize. */ struct segment_command_64 { /* for 64-bit architectures */ uint32_t cmd; /* LC_SEGMENT_64 */ uint32_t cmdsize; /* includes sizeof section_64 structs */ char segname[16]; /* segment name */ uint64_t vmaddr; /* memory address of this segment */ uint64_t vmsize; /* memory size of this segment */ uint64_t fileoff; /* file offset of this segment */ uint64_t filesize; /* amount to map from the file */ int32_t maxprot; /* maximum VM protection */ int32_t initprot; /* initial VM protection */ uint32_t nsects; /* number of sections in segment */ uint32_t flags; /* flags */ }; struct section_64 { /* for 64-bit architectures */ char sectname[16]; /* name of this section */ char segname[16]; /* segment this section goes in */ uint64_t addr; /* memory address of this section */ uint64_t size; /* size in bytes of this section */ uint32_t offset; /* file offset of this section */ uint32_t align; /* section alignment (power of 2) */ uint32_t reloff; /* file offset of relocation entries */ uint32_t nreloc; /* number of relocation entries */ uint32_t flags; /* flags (section type and attributes)*/ uint32_t reserved1; /* reserved (for offset or index) */ uint32_t reserved2; /* reserved (for count or sizeof) */ uint32_t reserved3; /* reserved */ }; segment å’Œ section éƒ½æœ‰åå­—ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œsegment ç”¨åŒä¸‹åˆ’çº¿+å¤§å†™å­—æ¯ï¼Œsection ç”¨åŒä¸‹åˆ’çº¿+å°å†™å­—æ¯ã€‚ å¯æ‰§è¡Œæ–‡ä»¶çš„ segment é€šå¸¸æœ‰ä»¥ä¸‹å…­ç§ç±»å‹ï¼š __PAGEZEROï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ª segmentï¼Œåœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€ä¸ºé›¶ï¼Œsize ä»£è¡¨è™šæ‹Ÿå†…å­˜ä¸­ä¸€é¡µçš„å¤§å°ã€‚ __TEXTï¼ŒåŒ…å«å¯æ‰§è¡Œçš„ä»£ç ã€åªè¯»æ•°æ®ã€‚å› ä¸ºä¸å¯å†™ï¼Œæ‰€ä»¥å¯ä»¥å½“åšå…±äº«å†…å­˜ï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿèƒ½è·å–ã€‚ä¾‹å¦‚è¿è¡ŒåŒä¸€ä¸ªç¨‹åºå¤šæ¬¡ã€Framework çš„ä»£ç ã€å…±äº«åº“ã€‚ __DATAï¼Œå¯è¯»å†™çš„æ•°æ®ã€‚å› æ­¤æ¯ä¸ªè¿›ç¨‹éƒ½è¦å•ç‹¬æ‹·è´ä¸€ä»½ Frameworkã€å…±äº«åº“çš„æ•°æ®ï¼Œæ‹·è´é‡‡ç”¨ copy-on-write ç­–ç•¥ã€‚ __OBJCï¼Œç”¨äºæ”¯æŒ Objective-C Runtime çš„ç›¸å…³æ•°æ® __IMPORTï¼ŒåŒ…å«ä¸€äº›æœªè¢«å®šä¹‰çš„ç¬¦å·ï¼Œåªä¸º IA-32 æ¶æ„ä½¿ç”¨ï¼Œç°åœ¨å¯ä»¥å¿½ç•¥ã€‚ __LINKEDITï¼ŒåŒ…å«ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨ã€é‡å®šä½è¡¨ç­‰æ•°æ®ã€‚ åœ¨ç”¨æˆ·æœ€ç»ˆé“¾æ¥æˆçš„ Mach-O æ–‡ä»¶ä¸­ï¼Œæœ€åä¸€ä¸ª segment ä¸º__LINKEDITã€‚ ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚ curPtr = curPtr + sizeof(mach_header_t); load_command_t *command; for (int i = 0; i &lt; header-&gt;ncmds; i++, curPtr += command-&gt;cmdsize) { command = (load_command_t *)curPtr; if (command-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) { segment_command_t *segment_command = (segment_command_t *)command; printf(&quot;segment: %s \\n&quot;, segment_command-&gt;segname); printf(&quot;sections:\\n&quot;); section_t *sections = (section_t *)(curPtr + sizeof(segment_command_t)); for (int j = 0; j &lt; segment_command-&gt;nsects; j++) { printf(&quot;%s %s \\n&quot;, sections[j].segname, sections[j].sectname); printf(&quot;flags: 0x%x \\n&quot;, sections[j].flags); } printf(&quot;\\n\\n&quot;); } } è¾“å‡ºç»“æœå¦‚ä¸‹ segment: sections: __TEXT __text flags: 0x80000400 __DATA __data flags: 0x0 __LD __compact_unwind__LD flags: 0x2000000 æ‰“å°ä¹‹åä½ ä¼šå‘ç°ï¼Œåªæœ‰ä¸€ä¸ª segmentï¼Œè€Œä¸”è¿˜æ²¡æœ‰åå­—ã€‚è¿™æ˜¯ä¸ºäº†ä¸­é—´ç›®æ ‡æ–‡ä»¶çš„ç´§å‡‘æ€§æ•…æ„å¤„ç†çš„ï¼Œè¿™ä¸ª segment é‡Œé¢åŒ…å«äº†å„ç§å„æ ·çš„ sectionï¼Œå±äºä¸åŒ segmentï¼Œä¼šåœ¨é™æ€é“¾æ¥æ—¶æ”¾ç½®åˆ°åˆç†çš„ä½ç½®ä¸Šã€‚ è¿™é‡Œæœ‰ä¸‰ä¸ª sectionã€‚ __compact_unwind__LDï¼Œè¿™æ˜¯ä¸€ä¸ª debug ç”¨çš„ï¼Œå¯ä»¥å¿½ç•¥ã€‚ __textï¼ŒåŒ…å«å¯æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤ã€‚ __dataï¼ŒåŒ…å«æœ‰åˆå§‹åŒ–å€¼çš„å˜é‡ã€‚åœ¨file_b.cä¸­ï¼Œæˆ‘ä»¬åªæœ‰int base = 0xfff0è¿™ä¹ˆä¸ªåˆå§‹åŒ–å˜é‡ã€‚ å¯ä»¥æ‰“å°å‡ºæ¥éªŒè¯ if (strcmp(sections[j].sectname, SECT_DATA) == 0) { int *value = (int *)(filePtr + sections[j].offset); printf(&quot;%x \\n&quot;, *value); } LC_SYMTAB å¯¹åº”ç»“æ„ä½“symtab_commandï¼Œæè¿°äº†ç¬¦å·è¡¨çš„ä½ç½®å’Œå¤§å°ã€‚æ‰€è°“çš„ç¬¦å·è¡¨ï¼Œæ˜¯ç”±nlist_64æ„æˆçš„ç»“æ„ä½“æ•°ç»„ã€‚ /* * The symtab_command contains the offsets and sizes of the link-edit 4.3BSD * &quot;stab&quot; style symbol table information as described in the header files * &lt;nlist.h&gt; and &lt;stab.h&gt;. */ struct symtab_command { uint32_t cmd; /* LC_SYMTAB */ uint32_t cmdsize; /* sizeof(struct symtab_command) */ uint32_t symoff; /* symbol table offset */ uint32_t nsyms; /* number of symbol table entries */ uint32_t stroff; /* string table offset */ uint32_t strsize; /* string table size in bytes */ }; /* * This is the symbol table entry structure for 64-bit architectures. */ struct nlist_64 { union { uint32_t n_strx; /* index into the string table */ } n_un; uint8_t n_type; /* type flag, see below */ uint8_t n_sect; /* section number or NO_SECT */ uint16_t n_desc; /* see &lt;mach-o/stab.h&gt; */ uint64_t n_value; /* value of this symbol (or stab offset) */ }; ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚ if (command-&gt;cmd == LC_SYMTAB) { symtab_command_t *symtab_command = (symtab_command_t *)command; nlist_t *nlists = (nlist_t *)(filePtr + symtab_command-&gt;symoff); uint32_t strOffset = symtab_command-&gt;stroff; for (int j = 0; j &lt; symtab_command-&gt;nsyms; j++) { nlist_t nlist = nlists[j]; printf(&quot;symbol: %s type:%u sect:%u desc:%u value:%llu \\n&quot;, (char *)(filePtr + strOffset + nlist.n_un.n_strx), nlist.n_type, nlist.n_sect, nlist.n_desc, nlist.n_value); } } è¾“å‡ºç»“æœä¸­ï¼Œå¯ä»¥çœ‹åˆ°ç¬¦å·_base å’Œ_getAddress symbol: ltmp0 type:14 sect:1 desc:0 value:0 symbol: ltmp1 type:14 sect:2 desc:0 value:32 symbol: ltmp2 type:14 sect:3 desc:0 value:40 symbol: _base type:15 sect:2 desc:0 value:32 symbol: _getAddress type:15 sect:1 desc:0 value:0 æ ¹æ® value å¯ä»¥çŸ¥é“_base æ˜¯ä¸€ä¸ªå…¨å±€ç¬¦å· #define N_GSYM 0x20 /* global symbol */ LC_DYSYMTAB å¯¹åº”ç»“æ„ä½“dysymtab_commandï¼Œæè¿°äº†ç”¨äºåŠ¨æ€é“¾æ¥éƒ¨åˆ†çš„ç¬¦å·è¡¨ã€‚ ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚ if (command-&gt;cmd == LC_DYSYMTAB) { dysymtab_command_t *dysymtab_command = (dysymtab_command_t *)command; printf(&quot;local: %u extdef: %u undef: %u \\n&quot;, dysymtab_command-&gt;nlocalsym, dysymtab_command-&gt;nextdefsym, dysymtab_command-&gt;nundefsym); } è¿™é‡Œæœ‰ä¸‰ä¸ªæœ¬åœ°ç¬¦å·ï¼Œä¸¤ä¸ªå¯¹å¤–ç¬¦å·ï¼Œç¬¦åˆé¢„æœŸ local: 3 extdef: 2 undef: 0 ğŸ§‘â€ğŸ’»Coding ç¯èŠ‚ file_b.o æˆ‘ä»¬å·²ç»æ‰’å¾—å·®ä¸å¤šäº†ï¼Œæ˜¯æ—¶å€™å†™ä¸ªæ–°çš„ä»£ç äº†ï¼Œå°±å« file_a.c #include &quot;file_b.h&quot; int printf(const char *, ...); int main(int argc, char *argv[]) { int offset = 0x10; int address = getAddress(base, offset); printf(&quot;address is %x&quot;, address); return 0; } file_a.c éœ€è¦ç”¨åˆ° base å’Œ getAddressï¼Œæ‰€ä»¥è¦æŠŠè¿™ä¸¤ä¸ªä¿¡æ¯æä¾›å‡ºæ¥ extern int base; int getAddress(int base, int offset); ç„¶åç¼–è¯‘ //å•ç‹¬ç¼–è¯‘ï¼Œä¸é“¾æ¥ clang -c file_a.c -o file_a.o æ¥ä¸‹æ¥çš„ä»£ç è·Ÿä¹‹å‰çš„ä¸€æ ·ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹è¾“å‡º magic: feedfacf cputype: 16777228 cpusubtype: 0 filetype: 1 ncmds: 4 sizeofcmds: 440 flags: 8192 segment: sections: __TEXT __text flags: 0x80000400 __TEXT __cstring flags: 0x2 __LD __compact_unwind__LD flags: 0x2000000 symbol: ltmp0 type:14 sect:1 desc:0 value:0 symbol: l_.str type:14 sect:2 desc:0 value:108 symbol: ltmp1 type:14 sect:2 desc:0 value:108 symbol: ltmp2 type:14 sect:3 desc:0 value:128 symbol: _main type:15 sect:1 desc:0 value:0 symbol: _base type:1 sect:0 desc:0 value:0 symbol: _getAddress type:1 sect:0 desc:0 value:0 symbol: _printf type:1 sect:0 desc:0 value:0 local: 4 extdef: 1 undef: 3 è¿™é‡Œå¤šäº†ä¸€ä¸ªå‰é¢æ²¡æœ‰çš„ section __cstringï¼Œé‡Œé¢åŒ…å« C å­—ç¬¦ä¸²ï¼Œå³&quot;address is %x&quot;ï¼Œå¯ä»¥éªŒè¯ä¸‹ if (sections[j].flags == S_CSTRING_LITERALS) { printf(&quot;%s \\n&quot;, (char *)(filePtr + sections[j].offset)); } ç„¶åä¹Ÿæ²¡æœ‰å¤šä½™çš„å¯åˆ†æäº†ï¼ŒæŠŠä¸¤ä¸ª Mach-O é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶çœ‹çœ‹ //é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶target.o ld -lSystem -syslibroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -o target.o file_a.o file_b.o //æ‰§è¡Œä¸€ä¸‹target.oï¼Œå¯æ­£å¸¸è¿è¡Œ ./target.o é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶åï¼Œåˆå¤šäº†å¥½å‡ ä¸ª load commandsï¼Œè¿™é‡ŒåŒæ ·åªæŒ‘å‡ ä¸ªæœ‰æ„æ€çš„è®²è®² LC_LOAD_DYLINKER å¯¹åº”ç»“æ„ä½“dylinker_commandï¼ŒæŒ‡ç¤ºäº†åŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„ã€‚ æ¯ä¸ªåŠ¨æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶éƒ½åŒ…å«è¯¥ commandï¼Œè¯¥ command åŒ…å«æŒ‡æ˜äº†å†…æ ¸åœ¨å¯åŠ¨è¿›ç¨‹æ—¶ï¼Œä»å“ªä¸ªåœ°æ–¹å¯åŠ¨ dyldã€‚å¦‚æœè¿™ä¸ªæ–‡ä»¶å°±æ˜¯åŠ¨æ€é“¾æ¥å™¨æœ¬èº«ï¼Œåˆ™é€šè¿‡ LC_ID_DYLINKER æŒ‡æ˜ã€‚ if (command-&gt;cmd == LC_LOAD_DYLINKER) { dylinker_command_t *dylinker_command = (dylinker_command_t *)command; uint32_t length = dylinker_command-&gt;cmdsize - sizeof(dylinker_command_t); uint32_t offset = dylinker_command-&gt;name.offset; printf(&quot;length: %u dylinker: %s \\n\\n&quot;, length, (char *)(curPtr + offset)); } è¾“å‡º length: 20 dylinker: /usr/lib/dyld LC_LOAD_DYLIB å¯¹åº”ç»“æ„ä½“dylib_commandï¼ŒæŒ‡ç¤ºäº†ä¾èµ–çš„åŠ¨æ€åº“ã€‚å‰é¢æè¿‡ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šæŠŠæ‰€æœ‰ä¾èµ–çš„åº“åŠ åˆ°è¿›ç¨‹ä¸­ï¼Œå¦‚æœåŠ¨æ€åº“ä¾èµ–å…¶ä»–åŠ¨æ€åº“ï¼Œåˆ™é€’å½’è¿›è¡ŒåŠ è½½ï¼Œç„¶åå†åšç¬¦å·ç»‘å®šã€‚ if (command-&gt;cmd == LC_LOAD_DYLIB) { dylib_command_t *dylib_command = (dylib_command_t *)command; uint32_t length = dylib_command-&gt;cmdsize - sizeof(dylib_command_t); //å¾—åˆ°dylib.nameçš„é•¿åº¦ uint32_t offset = dylib_command-&gt;dylib.name.offset; printf(&quot;length:%u dylib: %s \\n\\n&quot;, length, (char *)(curPtr + offset)); } è¾“å‡º length:32 dylib: /usr/lib/libSystem.B.dylib LC_MAIN å¯¹åº”ç»“æ„ä½“entry_point_commandï¼Œå³ main å‡½æ•°çš„åœ°å€ LC_DATA_IN_CODE å¯¹åº”ç»“æ„ä½“linkedit_data_commandï¼Œåœ¨ä»£ç æ®µçš„æ•°æ®ï¼Œå³åªè¯»æ•°æ®ã€‚ /* * The linkedit_data_command contains the offsets and sizes of a blob * of data in the __LINKEDIT segment. */ struct linkedit_data_command { uint32_t cmd; /* LC_CODE_SIGNATURE, LC_SEGMENT_SPLIT_INFO, LC_FUNCTION_STARTS, LC_DATA_IN_CODE, LC_DYLIB_CODE_SIGN_DRS, LC_LINKER_OPTIMIZATION_HINT, LC_DYLD_EXPORTS_TRIE, or LC_DYLD_CHAINED_FIXUPS. */ uint32_t cmdsize; /* sizeof(struct linkedit_data_command) */ uint32_t dataoff; /* file offset of data in __LINKEDIT segment */ uint32_t datasize; /* file size of data in __LINKEDIT segment */ }; linkedit_data_commandç»“æ„ä½“è¢«å¾ˆå¤š load command å…±ç”¨ã€‚ Data åœ¨æœ€ç»ˆçš„ target.o ä¸­ï¼Œå¤šäº†ä¸€ä¸ª segment,__DATA_CONSTï¼Œé‡Œé¢æœ‰ä¸€ä¸ª section,__gotã€‚è¿™å…¶å®å°±æ˜¯æˆ‘ä»¬ç¬¦å·ç»‘å®šæ—¶æåˆ°çš„é—´æ¥ç¬¦å·å¼•ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œå¼•ç”¨äº† printf è¿™ä¸ªåŠ¨æ€åº“ç¬¦å·ã€‚ å…³äºå¦‚ä½•åˆ¤æ–­è¿™ä¸ª section æ¯ä¸ªä½ç½®ä»£è¡¨å“ªä¸ªé—´æ¥ç¬¦å·å¼•ç”¨çš„åœ°å€ï¼Œå¯ä»¥å‚è€ƒfishhookä¸­çš„å®ç°ã€‚ å‚è€ƒèµ„æ–™ é™¤äº†ä¸Šé¢è´´è¿‡çš„é“¾æ¥å¤– https://github.com/aidansteele/osx-abi-macho-file-format-reference Mach-O Programming Topics Apple æ“ä½œç³»ç»Ÿå¯æ‰§è¡Œæ–‡ä»¶ Mach-O ã€ŠiOS åº”ç”¨å®‰å…¨ä¸é€†å‘ä¹‹é“ã€‹ åŠ¨æ€ä¿®æ”¹ C è¯­è¨€å‡½æ•°çš„å®ç° - é¢å‘ä¿¡ä»°ç¼–ç¨‹ ","link":"https://jayying007.github.io/post/Mach-Oæ–‡ä»¶çš„æ„å»ºã€è§£æä¸è¿è¡Œ/"},{"title":"ä¸€ä¸ªç®€å•çš„å¤©æ°”App","content":"è¿™ä¸¤å¤©çœ‹äº†ä¸€ä¸ª iOS å¼€å‘æ•™ç¨‹ï¼Œè™½ç„¶æ˜¯ iOS7 é‚£ä¼šçš„ï¼Œä½†è¿™ç¯‡æ•™ç¨‹éå¸¸ç»†è‡´ï¼Œå³ä½¿æ˜¯ä»Šå¤©ä¹Ÿæœ‰å¯å­¦ä¹ çš„åœ°æ–¹ã€‚å½“åšå¯¹ iOS å¼€å‘çš„å›é¡¾ä¹ŸæŒºä¸é”™çš„ã€‚ iOS 7 Best Practices; A Weather App Case Study: Part 1/2 iOS 7 Best Practices; A Weather App Case Study: Part 2/2 å°±æ˜¯ä½ æ˜¯ä¸€ä¸ª iOS å°ç™½ï¼Œç›¸ä¿¡ä¹Ÿèƒ½å¾ˆå®¹æ˜“å­¦ä¼šã€‚ çŸ¥è¯†ç‚¹ ä¸»è¦ç”¨çš„æŠ€æœ¯æœ‰ Mantleï¼ˆç±»ä¼¼ YYModelï¼‰ã€ReactiveCocoaã€‚ YYModel ä¹‹å‰åˆ†æè¿‡æºç ï¼ŒMantle å€’è¿˜æ²¡ç ”ç©¶è¿‡ï¼Œï¼ˆå°è±¡é‡Œ YYModel ä½œè€…çš„æµ‹è¯•ä¸­ï¼ŒMantle çš„æ€§èƒ½æ˜¯å¾ˆå·®çš„ï¼Œä½†å¥½åœ¨ç¨³å®šï¼‰ è¿™ä¸ª App å¯ä»¥å½“åš ReactiveCocoa ä½¿ç”¨çš„å…¥é—¨æ•™ç¨‹ï¼Œè™½ç„¶åªç”¨äº†å¾ˆå°‘éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä½†è¿˜æ˜¯å¯ä»¥æ„Ÿå—åˆ°å“åº”å¼ç¼–ç¨‹çš„æ€ç»´æ¨¡å¼ã€‚ï¼ˆå°±è¿™ä¸ªé¡¹ç›®ç”¨åˆ°çš„éƒ¨åˆ†åŠŸèƒ½ï¼Œä¸ªäººæ„Ÿè§‰å¦‚æœç”¨ä¹‹å‰çš„ç¼–ç¨‹æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ç”¨ KVO æˆ– Notification çš„æ–¹å¼è§£å†³ï¼Œåªæ˜¯ä»£ç ä½ç½®ç›¸å¯¹åˆ†æ•£ï¼‰ æœ€è¿‘ä¹Ÿæœ‰åš App å†…é€šçŸ¥ View çš„éœ€æ±‚ï¼Œæ‰€ä»¥é¡ºä¾¿å­¦ä¹ äº† TSMessage çš„æºç ã€‚ å°é—®é¢˜ å½“æ—¶çš„ iPhone è¿˜æ²¡æœ‰åˆ˜æµ·ï¼Œåœ¨æˆ‘çš„ iPhone 13 Pro ä¸Šï¼ŒUI å¸ƒå±€å…¶å®æ˜¯æœ‰ bug çš„ï¼Œå½“ç„¶è¿™ä¸æ˜¯é‡ç‚¹ã€‚ å¦ä¸€ä¸ªå°±æ˜¯ iOS8 ä¹‹åï¼Œè¯»å–ä½ç½®éœ€è¦æˆæƒï¼Œéœ€è¦åœ¨ Info.plist é‡Œé¢è¡¥å…… iOS9 ä¹‹å Https éœ€è¦é…ç½®ï¼Œåœ¨ Info.plist é‡Œé¢è¡¥å…… ä½œè€…ä½¿ç”¨çš„å…è´¹å¤©æ°” APIï¼Œåœ¨æˆ‘çš„å°è¯•æ—¶æ˜¯ç”¨ä¸äº†çš„ï¼Œç°åœ¨å®˜ç½‘ä¼šè¦æ±‚å¤šåŠ ä¸€ä¸ª appid çš„å‚æ•°ï¼Œç„¶è€Œå³ä½¿ä¼ äº†ï¼Œä¹Ÿæ˜¯è¿”å› 401ã€‚è¿™ä¹Ÿä¸æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥æˆ‘ç”¨äº†æœ¬åœ°æ¨¡æ‹Ÿçš„ json æ–‡ä»¶å»æ›¿ä»£ã€‚ ","link":"https://jayying007.github.io/post/ä¸€ä¸ªç®€å•çš„å¤©æ°”App/"},{"title":"mmap--è¯»å†™æ–‡ä»¶çš„å¦ä¸€ç§é€‰æ‹©","content":"å‰è¨€ åœ¨ç¼–å†™ C/C++ç­‰è¯­è¨€æ—¶ï¼Œå¦‚æœéœ€è¦è¯»å†™æ–‡ä»¶ï¼Œé€šå¸¸ä¼šæƒ³åˆ°ç”¨ read å’Œ write ä¸¤ä¸ªç³»ç»Ÿåº“æ¥å£ã€‚æˆ–è€…æ˜¯ freadã€fwrite ç­‰æ ‡å‡†åº“æ¥å£ã€‚ è¿‘æœŸåœ¨åšä¸€ä¸ªéœ€æ±‚ï¼Œä¸ºäº†é¿å…æ•°æ®ä¸¢å¤±ï¼Œæ¯æ¬¡æœ‰æ–°æ•°æ®æ—¶ï¼Œæˆ‘éƒ½ä¼šç«‹å³è°ƒç”¨ write ç›¸å…³æ¥å£å†™å…¥ç£ç›˜ã€‚å¦‚æœé¢‘ç‡å¾ˆé«˜ï¼Œå°±ä¼šé€ æˆå¤§é‡çš„ IOã€‚ äºæ˜¯å¼€å§‹å¯»æ‰¾æ˜¯å¦æœ‰èƒ½é¿å…é¢‘ç¹ IOï¼ŒåŒæ—¶åˆä¿è¯æ•°æ®ä¸ä¸¢å¤±çš„æ–¹å¼ï¼Œæœ€ç»ˆå‘ç°äº† mmapã€‚ mmap ä»‹ç» mmap æ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå®ç°æ–‡ä»¶ç£ç›˜åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸€æ®µè™šæ‹Ÿåœ°å€çš„ä¸€ä¸€å¯¹æ˜ å…³ç³»ã€‚å®ç°è¿™æ ·çš„æ˜ å°„å…³ç³»åï¼Œè¿›ç¨‹å°±å¯ä»¥é‡‡ç”¨æŒ‡é’ˆçš„æ–¹å¼è¯»å†™æ“ä½œè¿™ä¸€æ®µå†…å­˜ï¼Œè€Œç³»ç»Ÿä¼šè‡ªåŠ¨å›å†™è„é¡µé¢åˆ°å¯¹åº”çš„æ–‡ä»¶ç£ç›˜ä¸Šï¼Œå³å®Œæˆäº†å¯¹æ–‡ä»¶çš„æ“ä½œè€Œä¸å¿…å†è°ƒç”¨ read,write ç­‰ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚ç›¸åï¼Œå†…æ ¸ç©ºé—´å¯¹è¿™æ®µåŒºåŸŸçš„ä¿®æ”¹ä¹Ÿç›´æ¥åæ˜ ç”¨æˆ·ç©ºé—´ï¼Œä»è€Œå¯ä»¥å®ç°ä¸åŒè¿›ç¨‹é—´çš„æ–‡ä»¶å…±äº«ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç›¸å…³çš„æ¥å£æœ‰ï¼šmmap()ï¼Œmunmap()ï¼Œmsync() å…·ä½“çš„ç”¨æ³•å’Œå‚æ•°ç­‰è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒæ–‡æ¡£mmap(2) - Linux manual page è°ƒç”¨ mmap æ¥å£ï¼Œéœ€è¦ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ fdã€‚è€Œä¸€æ—¦åˆ›å»ºå®Œæˆï¼Œå°±å¯ä»¥å…³é—­æ–‡ä»¶æè¿°ç¬¦äº†ã€‚å› ä¸ºæ˜ å°„çš„æ˜¯ç£ç›˜çš„åœ°å€ï¼Œä¸æ˜¯æ–‡ä»¶æœ¬èº«ï¼Œå’Œæ–‡ä»¶å¥æŸ„æ— å…³ã€‚ mmap å’Œå¸¸è§„æ–‡ä»¶è¯»å†™çš„åŒºåˆ« å¸¸è§„æ–‡ä»¶è¯»å†™ è¿›ç¨‹å‘èµ·è¯»æ–‡ä»¶è¯·æ±‚ã€‚ å†…æ ¸é€šè¿‡æŸ¥æ‰¾è¿›ç¨‹æ–‡ä»¶ç¬¦è¡¨ï¼Œå®šä½åˆ°å†…æ ¸å·²æ‰“å¼€æ–‡ä»¶é›†ä¸Šçš„æ–‡ä»¶ä¿¡æ¯ï¼Œä»è€Œæ‰¾åˆ°æ­¤æ–‡ä»¶çš„ inodeã€‚ inode åœ¨ address_space ä¸ŠæŸ¥æ‰¾è¦è¯·æ±‚çš„æ–‡ä»¶é¡µæ˜¯å¦å·²ç»ç¼“å­˜åœ¨é¡µç¼“å­˜ä¸­ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ç‰‡æ–‡ä»¶é¡µçš„å†…å®¹ã€‚ å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™é€šè¿‡ inode å®šä½åˆ°æ–‡ä»¶ç£ç›˜åœ°å€ï¼Œå°†æ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°é¡µç¼“å­˜ã€‚ä¹‹åå†æ¬¡å‘èµ·è¯»é¡µé¢è¿‡ç¨‹ï¼Œè¿›è€Œå°†é¡µç¼“å­˜ä¸­çš„æ•°æ®å‘ç»™ç”¨æˆ·è¿›ç¨‹ã€‚ æ€»ç»“æ¥è¯´ï¼Œå¸¸è§„æ–‡ä»¶æ“ä½œä¸ºäº†æé«˜è¯»å†™æ•ˆç‡å’Œä¿æŠ¤ç£ç›˜ï¼Œä½¿ç”¨äº†é¡µç¼“å­˜æœºåˆ¶ã€‚è¿™æ ·é€ æˆè¯»æ–‡ä»¶æ—¶éœ€è¦å…ˆå°†æ–‡ä»¶é¡µä»ç£ç›˜æ‹·è´åˆ°é¡µç¼“å­˜ä¸­ï¼Œç”±äºé¡µç¼“å­˜å¤„åœ¨å†…æ ¸ç©ºé—´ï¼Œä¸èƒ½è¢«ç”¨æˆ·è¿›ç¨‹ç›´æ¥å¯»å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦å°†æ•°æ®é¡µä»é¡µç¼“å­˜ä¸­å†æ¬¡æ‹·è´åˆ°å†…å­˜å¯¹åº”çš„ç”¨æˆ·ç©ºé—´ä¸­ã€‚è¿™æ ·ï¼Œé€šè¿‡äº†ä¸¤æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œæ‰èƒ½å®Œæˆè¿›ç¨‹å¯¹æ–‡ä»¶å†…å®¹çš„è·å–ä»»åŠ¡ã€‚å†™æ“ä½œä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¾…å†™å…¥çš„ buffer åœ¨å†…æ ¸ç©ºé—´ä¸èƒ½ç›´æ¥è®¿é—®ï¼Œå¿…é¡»è¦å…ˆæ‹·è´è‡³å†…æ ¸ç©ºé—´å¯¹åº”çš„ä¸»å­˜ï¼Œå†å†™å›ç£ç›˜ä¸­ï¼ˆå»¶è¿Ÿå†™å›ï¼‰ï¼Œä¹Ÿæ˜¯éœ€è¦ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚ mmap è¯»å†™ è¿›ç¨‹å¯åŠ¨æ˜ å°„è¿‡ç¨‹ï¼Œå¹¶åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸ºæ˜ å°„åˆ›å»ºè™šæ‹Ÿæ˜ å°„åŒºåŸŸ è°ƒç”¨å†…æ ¸ç©ºé—´çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•° mmapï¼ˆä¸åŒäºç”¨æˆ·ç©ºé—´å‡½æ•°ï¼‰ï¼Œå®ç°æ–‡ä»¶ç‰©ç†åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€çš„ä¸€ä¸€æ˜ å°„å…³ç³» è¿›ç¨‹å‘èµ·å¯¹è¿™ç‰‡æ˜ å°„ç©ºé—´çš„è®¿é—®ï¼Œå¼•å‘ç¼ºé¡µå¼‚å¸¸ï¼Œå®ç°æ–‡ä»¶å†…å®¹åˆ°ç‰©ç†å†…å­˜ï¼ˆä¸»å­˜ï¼‰çš„æ‹·è´ **æ€»è€Œè¨€ä¹‹ï¼Œå¸¸è§„æ–‡ä»¶æ“ä½œéœ€è¦ä»ç£ç›˜åˆ°é¡µç¼“å­˜å†åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚è€Œ mmap æ“æ§æ–‡ä»¶ï¼Œåªéœ€è¦ä»ç£ç›˜åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸€æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ã€‚**è¯´ç™½äº†ï¼Œmmap çš„å…³é”®ç‚¹æ˜¯å®ç°äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®ç›´æ¥äº¤äº’è€Œçœå»äº†ç©ºé—´ä¸åŒæ•°æ®ä¸é€šçš„ç¹çè¿‡ç¨‹ã€‚å› æ­¤ mmap æ•ˆç‡æ›´é«˜ã€‚ mmap å›å†™æ—¶æœº mmap æ˜¯æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´çš„ï¼Œå¦‚æœåˆš memcpy ä¸€ä»½æ•°æ®ï¼Œè¿›ç¨‹å°±æŒ‚äº†ï¼Œé‚£æ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ ç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œä»¥ä¸‹æ˜¯ Linus çš„å›å¤ï¼š {% note %} Linus Torvalds The mapped pages are part of the filesystem cache,which means that even if the user process that made a change to that page dies, the page is still managed by the kernel and as all concurrent accesses to that file will go through the kernel, other processes will get served from that cache. In some old Linux kernels it was different, thatâ€™s the reason why some kernel documents still tell to force msync. {% endnote %} æŸ¥çœ‹ Linux å†…æ ¸ä»£ç ï¼Œå¯ä»¥å‘ç°åœ¨æ”¶åˆ°å¼‚å¸¸ä¿¡å·æ—¶ï¼Œæ˜¯ä¼šå¸®ä½ æŠŠ mmap æ•°æ®å†™ä¼šç£ç›˜çš„ã€‚ do_exit çš„ä»£ç åœ¨ kernel/exit.cï¼Œé‡Œé¢ä¼šè°ƒç”¨ exit_mmï¼Œexit_mm åˆè°ƒç”¨ mmput ä¸è¿‡æ­£å¦‚ Linus æ‰€è¯´ï¼Œéƒ¨åˆ†è€çš„ Linux å†…æ ¸å¯èƒ½è¡¨ç°ä¸åŒï¼Œæ‰€ä»¥ä¸ºäº†ç¡®ä¿æ•°æ®å›å†™ï¼Œä½ å¯ä»¥ç”¨ msync mmap ä¼˜ç¼ºç‚¹ ä¸€è·¯çœ‹ä¸‹æ¥ï¼Œå¥½åƒ mmap å®Œå…¨ç¢¾å‹ read ç³»ç»Ÿæ¥å£ï¼Ÿ mmap å‡å°‘äº†æ•°æ®çš„æ‹·è´æ¬¡æ•°ï¼Œç”¨å†…å­˜è¯»å†™å–ä»£ I/O è¯»å†™ï¼Œæé«˜äº†æ–‡ä»¶è¯»å–æ•ˆç‡ã€‚ mmap åœ¨éšæœºè®¿é—®åœºæ™¯ä¸‹å¾ˆæœ‰ä¼˜åŠ¿ã€‚ ä¸è¿‡ mmap ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼Œå› ä¸º mmap æ˜ å°„åˆ°äº†è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå…¶æœ€å°ç²’åº¦ä¸ºé¡µï¼Œæ‰€ä»¥å…¶å ç”¨å¤§å°åœ¨å†…å­˜ä¸­æ˜¯é¡µçš„æ•´æ•°å€ã€‚ å½“æŠŠä¸€ä¸ªæ–‡ä»¶å¤§å°ä¸ä¸ºé¡µçš„å€æ•°æ˜ å°„è¿›æ¥æ—¶ï¼Œå¯ä»¥è®¿é—®æœ€åé¡µå…¶ä»–éƒ¨åˆ†ï¼Œä¸ä¼šæŠ¥é”™ã€‚ä½†æ˜¯å¯¹è¯¥åŒºåŸŸçš„ä¿®æ”¹ä¹Ÿä¸ä¼šå½±å“åŸæ–‡ä»¶ã€‚ mmap åå†…å­˜å¤§å°å°±æ˜¯å›ºå®šçš„äº†ï¼Œå¦‚æœä¹‹åæœ‰å…¶ä»–åœ°æ–¹æ”¹å˜äº†æ–‡ä»¶çš„å¤§å°ï¼Œå°±ä¼šå‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µã€‚ å¦å¤–ï¼Œå› ä¸ºæ–‡ä»¶æ˜¯æ˜ å°„åˆ°å†…å­˜ç©ºé—´çš„ï¼Œå¦‚æœæ–‡ä»¶å¾ˆå¤§ï¼Œå°±ä¼šå ç”¨å¾ˆå¤šå†…å­˜ç©ºé—´ã€‚å³æŠŠæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜åï¼Œè¿™éƒ¨åˆ†å†…å­˜åœ°å€å°±ä¸èƒ½ç”¨åšå…¶ä»–äº†ï¼Œåªèƒ½ç”¨äºè¯¥æ–‡ä»¶è¯»å†™ã€‚è€Œä¸”è™šæ‹Ÿå†…å­˜ç©ºé—´ä¹Ÿå¾ˆéš¾æ‰¾åˆ°é‚£ä¹ˆå¤§ä¸€å—è¿ç»­çš„åœ°å€ã€‚ è®¨è®º å…³äºä»€ä¹ˆæ—¶å€™ç”¨ readã€writeï¼Œä»€ä¹ˆæ—¶å€™ç”¨ mmapï¼ŒStackOverflow ä¸Šæœ‰å¾ˆä¸é”™çš„è®¨è®ºï¼š ä¼ é€é—¨ï¼šWhen should I use mmap for file access? å‚è€ƒèµ„æ–™ mmap()çš„åŸç†ä¸åº”ç”¨ mmap ä¸ read write çš„å¯¹æ¯” ä»€ä¹ˆæ—¶å€™é€‰æ‹© mmap è€Œé read? - ç ç‘ä½ - åšå®¢å›­ linux ä¸­ mmap æ–‡ä»¶åˆ°å†…å­˜ä¸­ï¼Œè¯¥è¿›ç¨‹å‘ç”Ÿé”™è¯¯è¢«æŒ‚æ‰å mmap æ˜ å°„çš„å†…å­˜èƒ½å¦å†™å›åˆ°æ–‡ä»¶ä¸­çš„é—®é¢˜ ","link":"https://jayying007.github.io/post/mmap--è¯»å†™æ–‡ä»¶çš„å¦ä¸€ç§é€‰æ‹©/"},{"title":"æ·±å…¥ç†è§£Protobuf","content":"ç®€å•ä»‹ç» Protobuf æ˜¯åºåˆ—åŒ–æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚ æ¯”å¦‚åœ¨å‰åç«¯çš„æ•°æ®äº¤äº’ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½é‡‡ç”¨ xml æˆ–è€… json çš„æ•°æ®æ ¼å¼è¿›è¡Œé€šä¿¡ï¼Œè€Œ protobuf åˆ™æ˜¯å¦ä¸€ç§é€‰æ‹©ã€‚ ç›¸æ¯”å‰ä¸¤è€…ï¼Œprotobuf åºåˆ—åŒ–çš„æ•°æ®ä½“ç§¯æ›´å°ï¼Œåºåˆ—åŒ–é€Ÿåº¦æ›´å¿«ã€‚ Protobuf ç°åœ¨æœ‰ proto2 å’Œ proto3 ä¸¤ä¸ªç‰ˆæœ¬ï¼Œè¿™é‡Œé»˜è®¤ä½¿ç”¨ proto2 åŸºæœ¬ç”¨æ³•(ä»¥ iOS ä¸ºä¾‹) é¦–å…ˆåˆ›å»ºä¸€ä¸ª proto æ–‡ä»¶ï¼Œç„¶åå®šä¹‰ä½ çš„æ•°æ®ç»“æ„ message SearchRequest { required string query = 1; optional int32 page_number = 2; optional int32 result_per_page = 3; } æ¥ç€åˆ°Protobuf çš„ Github ç½‘å€ä¸‹è½½ä¸€ä¸ª protoc ç¼–è¯‘å™¨ï¼Œç”¨äºç¼–è¯‘ä¸Šé¢çš„ proto æ–‡ä»¶ å¤§è‡´å‘½ä»¤ä¸ºï¼š protoc --proto_path=src --objc_out=build/gen src/foo.proto å…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ•™ç¨‹ è¿™æ ·ä½ å°±å¾—åˆ°äº†ä¸€ä¸ª pbobjc.h å’Œ pbobjc.m æ–‡ä»¶ï¼Œå…¶ä¸­å°±æœ‰ SearchRequest è¿™ä¸ªç±»ï¼Œå†…å®¹å¤§æ¦‚å¦‚ä¸‹ @interface SearchRequest : GPBMessage @property(nonatomic, readwrite, copy, null_resettable) NSString *query; @property(nonatomic, readwrite) BOOL hasQuery; @property(nonatomic, readwrite) int32_t pageNumber; @property(nonatomic, readwrite) BOOL hasPageNumber; @property(nonatomic, readwrite) int32_t resultPerPage; @property(nonatomic, readwrite) BOOL hasResultPerPage; @end @implementation SearchRequest @dynamic hasQuery, query; @dynamic hasPageNumber, pageNumber; @dynamic hasResultPerPage, resultPerPage; typedef struct SearchRequest__storage_ { uint32_t _has_storage_[1]; int32_t pageNumber; int32_t resultPerPage; NSString *query; } SearchRequest__storage_; + (GPBDescriptor *)descriptor { //ä¸ç”¨å…³å¿ƒ } @end æ¥ä¸‹æ¥ä½ å°±å¯ä»¥æŠŠå®ƒå½“åšä¸€ä¸ª Model æ¥ä½¿ç”¨ï¼Œæˆ–è€…ç”¨ Java çš„æœ¯è¯­æ¥è¯´ï¼Œå« PoJo ç±»ã€‚ å½“ä½ éœ€è¦åºåˆ—åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨-[GPBMessage data]æ–¹æ³•ï¼› å½“ä½ éœ€è¦ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨+[GPBMessage parseFromData:error:]ç­‰æ–¹æ³•ã€‚ åŸºæœ¬è¯­æ³• è¿˜æ˜¯ä»¥ä¸Šé¢çš„ proto æ–‡ä»¶ä¸¾ä¾‹ message SearchRequest { required string query = 1; optional int32 page_number = 2; optional int32 result_per_page = 3; } 1 message å®šä¹‰äº†ä¸€ç§æ•°æ®ç»“æ„ï¼Œå…¶åè·Ÿç€å¯¹åº”çš„åç§°ã€‚ä¸€ä¸ª proto æ–‡ä»¶å¯ä»¥å®šä¹‰å¤šä¸ª messageï¼Œä½ ä¹Ÿå¯ä»¥ç”¨ import å…³é”®å­—ï¼Œå¼•å…¥å…¶ä»– protoï¼Œå°±åƒä»£ç å¼•å…¥å¤´æ–‡ä»¶ä¸€æ ·ã€‚ 2 æ¯ä¸ªå±æ€§å‰çš„å…³é”®å­—ï¼Œæœ‰ä¸‰ç§é€‰æ‹©ï¼šrequiredã€optionalã€repeatedï¼Œåˆ†åˆ«å¯¹åº”ï¼šå¿…å¡«ã€é€‰å¡«ã€é‡å¤å¡«ï¼ˆå³æ•°ç»„ï¼‰ 3 éšåæ˜¯å…¶æ•°æ®ç±»å‹ï¼ŒåŸºç¡€ç±»å‹å¦‚ä¸‹è¡¨ .proto Type Notes Objective-C Type double double float float int32 Uses variable-length encoding. Inefficient for encoding negative numbers â€“ if your field is likely to have negative values, use sint32 instead. int32_t int64 Uses variable-length encoding. Inefficient for encoding negative numbers â€“ if your field is likely to have negative values, use sint64 instead. int64_t uint32 Uses variable-length encoding. uint32_t uint64 Uses variable-length encoding. uint64_t sint32 Uses variable-length encoding. Signed int value. These more efficiently encode negative numbers than regular int32s. int32_t sint64 Uses variable-length encoding. Signed int value. These more efficiently encode negative numbers than regular int64s. int64_t fixed32 Always four bytes. More efficient than uint32 if values are often greater than 228. uint32_t fixed64 Always eight bytes. More efficient than uint64 if values are often greater than 256. uint64_t sfixed32 Always four bytes. int32_t sfixed64 Always eight bytes. int64_t bool BOOL string A string must always contain UTF-8 encoded text. NSString bytes May contain any arbitrary sequence of bytes. NSData æ­¤å¤–ä¹Ÿå¯ä»¥å®šä¹‰æšä¸¾å’Œ message enum Corpus { CORPUS_UNSPECIFIED = 0; CORPUS_UNIVERSAL = 1; CORPUS_WEB = 2; CORPUS_IMAGES = 3; CORPUS_LOCAL = 4; CORPUS_NEWS = 5; CORPUS_PRODUCTS = 6; CORPUS_VIDEO = 7; } message SearchRequest { required string query = 1; optional int32 page_number = 2; optional int32 result_per_page = 3; optional Corpus corpus = 4; } message SearchResponse { repeated Result result = 1; } message Result { required string url = 1; optional string title = 2; repeated string snippets = 3; } å¦å¤–ä½ è¿˜å¯ä»¥å®šä¹‰ Map ç±»å‹ï¼Œä½† Map æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ message æ•°æ®ç»“æ„è€Œå·²ã€‚ message Example { map&lt;key_type, value_type&gt; map_field = N; } || message MapFieldEntry { optional key_type key = 1; optional value_type value = 2; } message Example { repeated MapFieldEntry map_field = N; } 4 åç§°ä¸å¿…å¤šè¯´ï¼Œåªæ˜¯ç”Ÿæˆ ObjC ä»£ç æ—¶ï¼Œä¼šå°†è›‡å½¢å‘½åæ”¹ä¸ºé©¼å³°å‘½åã€‚ å½“ç„¶ï¼Œä¸€äº›æƒ…å†µä¹Ÿæ²¡è¿™ä¹ˆç®€å•ã€‚ 5 æœ€åå°±æ˜¯å±æ€§çš„ç¼–å·äº†ï¼Œå¯ä»¥ä» 1 åˆ° 536,870,911ï¼Œä½†ä¸€èˆ¬ä¹Ÿä¸ä¼šå®šä¹‰é‚£ä¹ˆå¤šå±æ€§ã€‚ å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€æ—¦ä¸€ä¸ªå±æ€§çš„ç¼–å·ç¡®å®šäº†ï¼Œå°±ä¸è¦éšæ„å»æ”¹åŠ¨å®ƒï¼Œä»¥é¿å…å‰åç‰ˆæœ¬æ•°æ®å…¼å®¹å¸¦æ¥çš„é—®é¢˜ã€‚ æ›´è¯¦ç»†çš„å†…å®¹ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ ç¼–ç åŸç† åœ¨è®²å…·ä½“çš„ç¼–ç ä¹‹å‰ï¼Œæœ‰å¿…è¦æä¸€ä¸‹ TLVï¼ˆTag-Length-Valueï¼‰ã€‚ è¿˜æ˜¯ä»¥ä¸Šé¢çš„ proto ä¸ºä¾‹å­ message SearchRequest { required string query = 1; optional int32 page_number = 2; optional int32 result_per_page = 3; } å¦‚æœæˆ‘ä»¬è¦ç¼–è¯‘è¿™æ®µæ•°æ®ï¼Œå°±å¯ä»¥ç”¨ TLV çš„æ–¹å¼ï¼š å†™å…¥åºå· 1ï¼Œä½ å¯ä»¥è‡ªå·±å†³å®šè¿™ä¸ªåºå·å å¤šå°‘å­—èŠ‚ï¼Œä½†åé¢æ‰€æœ‰åºå·å°±è¦å›ºå®šè¿™ä¸ªå­—èŠ‚æ•°äº†ï¼Œå‡è®¾ä¸º 4 å› ä¸º query æ˜¯ stringï¼Œå†™å…¥å­—æ®µçš„é•¿åº¦ï¼Œè¿™ä¸ªå å¤šå°‘å­—èŠ‚ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œå‡è®¾ä¸º 4 å†™å…¥ query æ•°æ®æœ¬èº« å†™å…¥åºå· 2ï¼ˆ4 ä¸ªå­—èŠ‚ï¼‰ å› ä¸º page_number æ˜¯ int32ï¼Œç›´æ¥ 4 ä¸ªå­—èŠ‚å†™å…¥å…¶å€¼ å†™å…¥åºå· 3ï¼ˆ4 ä¸ªå­—èŠ‚ï¼‰ å› ä¸º result_per_page æ˜¯ int32ï¼Œç›´æ¥ 4 ä¸ªå­—èŠ‚å†™å…¥å…¶å€¼ åªè¦ä½ æŒ‰ç…§è¿™ä¸ªæ ¼å¼å†™å…¥ï¼Œè§£æä¹Ÿå°±å¾ˆç®€å•ï¼š è¯»å– 4 ä¸ªå­—èŠ‚ï¼Œå¾—åˆ°åºå· 1 æŸ¥çœ‹ proto çŸ¥é“æ˜¯ string ç±»å‹ï¼Œæ¥ç€è¯»å– 4 ä¸ªå­—èŠ‚å¾—åˆ°é•¿åº¦ æ ¹æ®é•¿åº¦ï¼Œè¯»å–ç›¸åº”çš„å­—èŠ‚ï¼Œå¾—åˆ°çš„å°±æ˜¯ query çš„æ•°æ® è¯»å– 4 ä¸ªå­—èŠ‚ï¼Œå¾—åˆ°åºå· 2 æŸ¥çœ‹ proto çŸ¥é“æ˜¯ int32 ç±»å‹ï¼Œæ‰€ä»¥è¯» 4 ä¸ªå­—èŠ‚ï¼Œå¾—åˆ°çš„å°±æ˜¯ page_number çš„å€¼ è¯»å– 4 ä¸ªå­—èŠ‚ï¼Œå¾—åˆ°åºå· 3 æŸ¥çœ‹ proto çŸ¥é“æ˜¯ int32 ç±»å‹ï¼Œæ‰€ä»¥è¯» 4 ä¸ªå­—èŠ‚ï¼Œå¾—åˆ°çš„å°±æ˜¯ result_per_page çš„å€¼ æŒ‰ä¸Šé¢è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å®ç°æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè€Œä¸”æ•ˆæœè¿˜ä¸é”™ã€‚ å®é™…ä¸Šï¼ŒProtobuf å°±æ˜¯ç‰¹æ®Šçš„ TLVï¼Œåœ¨ä¼ ç»Ÿ TLV çš„åŸºç¡€ä¸Šï¼Œå¯¹éƒ¨åˆ†æ•°æ®è¿›è¡Œç²¾ç®€ï¼Œä»è€Œä½¿å¾—åºåˆ—åŒ–åä½“ç§¯æ›´å°ã€‚ åˆ†å‰²çº¿ å…ˆä»ä¸€ä¸ªç®€å•çš„ä¾‹å­å…¥æ‰‹ï¼Œå®šä¹‰ä¸€ä¸ª Test1 message Test1 { optional int32 a = 1; } ç„¶åç»™ a èµ‹å€¼ 150ï¼Œæ¥ç€æ‰“å° Test1 *test1 = [[Test1 alloc] init]; test1.a = 150; NSLog(@&quot;%@&quot;, test1.data); //{length = 3, bytes = 0x089601} ä½ ä¼šå¾ˆç¥å¥‡åœ°å‘ç°ï¼ŒæŒ‰æˆ‘ä»¬åˆšæ‰çš„åšæ³•éœ€è¦ 8 ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œåˆ°è¿™é‡Œ 3 ä¸ªå­—èŠ‚å°±æå®šäº†ï¼ï¼ï¼ Protobuf æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Œè¿™å°±è¦æ¶‰åŠåˆ°ä¸€ç§æ ¸å¿ƒç¼–ç æ–¹å¼Varintsã€‚ Varints Varints è¿™ä¸ªè¯æ‹†å‡ºæ¥ï¼Œå°±æ˜¯ var intï¼Œå³å¯å˜çš„ int ç±»å‹ï¼Œè¿™é‡Œçš„å¯å˜æŒ‡çš„æ˜¯é•¿åº¦å¯å˜ï¼Œå³ int32 ä¸ä¸€å®šå¯¹åº” 4 ä¸ªå­—èŠ‚ã€‚å› ä¸ºåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ç”¨ä¸æ»¡ 32bitï¼Œè¿™ä¼šå¯¼è‡´å¤§éƒ¨åˆ† bit ä½éƒ½æ˜¯ 0ï¼Œè€Œè¿™å°±æ˜¯æµªè´¹ã€‚ åœ¨ Varints ç¼–ç ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ª int64 å¯èƒ½å  1 åˆ° 10 ä¸ªå­—èŠ‚æ•°ã€‚æ¯ä¸ªå­—èŠ‚çš„ç¬¬ä¸€ä½æ˜¯æ ‡å¿—ä½ï¼ˆMSB - Most significant bitï¼‰ï¼Œå‰©ä¸‹ 7 ä½æ‰æ˜¯çœŸæ­£å­˜å‚¨æ•°æ®çš„ã€‚ 0000 0001 ^ msb æ¯”å¦‚ç¼–ç æ•°å­— 1ï¼Œåªéœ€è¦ä¸€ä¸ªå­—èŠ‚ï¼ŒMSB ä¸º 0 ä»£è¡¨ç»“æŸã€‚ 10010110 00000001 ^ msb ^ msb ç¼–ç æ•°å­— 150 éœ€è¦ä¸¤ä¸ªå­—èŠ‚ï¼ŒMSB ä¸º 1 ä»£è¡¨åé¢è¿˜æœ‰æ•°æ®ã€‚ è®¡ç®—æ•°å€¼æ—¶ï¼ŒæŠŠ MSB å»æ‰ï¼Œå› ä¸ºæ˜¯å°ç«¯åºï¼Œè¿˜è¦æŠŠå‰é¢çš„å­—èŠ‚æ”¾åˆ°åé¢ï¼Œå†æ‹¼èµ·æ¥ã€‚ è‡³æ­¤ï¼Œå¼€å¤´çš„é—®é¢˜åä¸¤ä¸ªå­—èŠ‚ 0x9601 æˆ‘ä»¬å·²ç»çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€äº†ï¼Œé‚£ç¬¬ä¸€ä¸ªå­—èŠ‚ 0x08 å‘¢ã€‚ è¿™ä¸ªå­—èŠ‚ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œfield_number å’Œ wire_typeï¼Œç»„åˆæ–¹å¼æ˜¯(field_number &lt;&lt; 3) | wire_typeï¼Œä¿—ç§° Tag field_number æˆ‘ä»¬çŸ¥é“æ˜¯ 1ï¼Œwire_type åˆ™å‚è€ƒä¸‹é¢è¡¨æ ¼ ID Name Used For 0 VARINT int32, int64, uint32, uint64, sint32, sint64, bool, enum 1 I64 fixed64, sfixed64, double 2 LEN string, bytes, embedded messages, packed repeated fields 3 SGROUP group start (deprecated) 4 EGROUP group end (deprecated) 5 I32 fixed32, sfixed32, float å› ä¸º int32 å±äº Varintsï¼Œæ‰€ä»¥ä¸º 0ï¼Œæ‹¼èµ·æ¥å°±å¾—åˆ°äº† 0x08 ä¹ä¸€çœ‹ï¼Œfield_number åªæœ‰ 5 ä¸ª bitï¼Œé‚£ä¸æ˜¯æœ€å¤šåªèƒ½å®šä¹‰ 32 ä¸ª field å—ã€‚å…¶å®ä¸æ˜¯ï¼Œè¿™ä¸ª Tag ä¹Ÿæ˜¯ä¸€ä¸ª Varintsï¼Œæ‰€ä»¥å®šä¹‰ fileid=16 åº”è¯¥é•¿ä¸‹é¢è¿™æ · Varints çš„å±€é™æ€§å’Œå¯¹ç­– Varints å¹¶ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œæœ‰äº›åœºæ™¯å®ƒæ˜¯ä½æ•ˆçš„ã€‚ å¯¹äº int32ã€int64ï¼Œæ¯”å¦‚ç¼–ç ä¸€ä¸ª-2ï¼Œéœ€è¦èŠ±è´¹ 10 ä¸ªå­—èŠ‚ 11111110 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 00000001 å¯¹äº sint32ã€sint64ï¼Œåˆ™æ¢äº†ç§æ€è·¯ï¼Œå…ˆé‡‡ç”¨ ZigZag ç®—æ³•ï¼Œç„¶åå†ç”¨ Varints ç¼–ç ã€‚ ZigZag è§„åˆ™ä¸ºï¼Œå¦‚æœæ˜¯è´Ÿæ•°ï¼Œåˆ™å­˜å‚¨å…¶ç»å¯¹å€¼çš„ 2 å€å‡ 1ï¼›å¦‚æœä¸ºéè´Ÿæ•°ï¼Œåˆ™å­˜å‚¨å…¶ç»å¯¹å€¼çš„ 2 å€ã€‚è¿™æ ·å°±æœ‰æ•ˆé™ä½äº†è´Ÿæ•°å ç”¨çš„å­—èŠ‚ç©ºé—´ã€‚ å‰©ä¸‹çš„ wire type ä¸­ï¼Œ I64 å’Œ I32ï¼Œä»£è¡¨è¯»å–å›ºå®š 8 ä¸ªå­—èŠ‚å’Œ 4 ä¸ªå­—èŠ‚ã€‚ LEN åˆ™ä»£è¡¨æ•°æ®çš„é•¿åº¦éœ€è¦ç”±ä¸‹ä¸€ä¸ªæ•°æ®ç¡®å®šã€‚ æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ message Test2 { optional string b = 2; } Test2 *test2 = [[Test2 alloc] init]; test2.b = @&quot;hello world&quot;; NSLog(@&quot;%@&quot;, test2.data); // {length = 13, bytes = 0x120b68656c6c6f20776f726c64} éœ€è¦æ³¨æ„è¿™ä¸ªé•¿åº¦ 11 ä¹Ÿæ˜¯ Varints ç¼–ç ã€‚ å‰©ä¸‹çš„ bytesã€message ä¹Ÿæ˜¯ç±»ä¼¼çš„è§£æã€‚ message Test3 { optional Test1 c = 3; } // æŒ‰å¼€å¤´çš„Test1ï¼Œå®ƒç¼–ç åæ˜¯è¿™æ ·çš„ // 1a 03 [08 96 01] repeated çš„è§£æ repeated åœ¨ proto2 å’Œ proto3 ä¸Šçš„å­˜å‚¨ç¨æœ‰ä¸åŒã€‚ message Test4 { repeated bool d = 1; } // proto2: 0x080108000800 // proto3: 0x0a03010000 æ¯”å¦‚ä¸Šé¢è¿™ä¸ªæ•°æ®ï¼Œå‡è®¾æˆ‘è®¾ç½®äº† YESã€NOã€NO ä¸‰ä¸ªæ•°æ®ã€‚ åœ¨ proto2 ä¸­å äº† 6 ä¸ªå­—èŠ‚ï¼Œè€Œåœ¨ proto3 ä¸­å äº† 5 ä¸ªå­—èŠ‚ è§£ç æµ…æ è§£ç å…¶å®æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯ç¼–ç åè¿‡æ¥è€Œå·²ã€‚ è¿™é‡Œä¸»è¦è¡¥å……ä¸€ä¸‹å¯¹é‡å¤æ¶ˆæ¯çš„å¤„ç†ï¼Œå³åœ¨æ•°æ®æµä¸­è§£æåˆ°ä¸€ä¸ª fileidï¼Œåé¢åˆå†è§£æåˆ°è¿™ä¸ª field è¯¥å¦‚ä½•å¤„ç†ï¼š å¦‚æœå­—æ®µä¸ºä¸å¯åˆ†å‰²çš„ç±»å‹ï¼Œåˆ™ç›´æ¥è¦†ç›– å¦‚æœå­—æ®µä¸º repeatedï¼Œåˆ™ append åˆ°å·²æœ‰å­—æ®µã€‚å…¶å®ä¸Šæ–‡ proto2 ä¸­å·²ç»å¯ä»¥å¾ˆæ¸…æ™°çœ‹åˆ°è¿™ç‚¹äº†ã€‚ å¦‚æœå­—æ®µä¸ºåµŒå¥—æ¶ˆæ¯ï¼Œåˆ™é€’å½’æ‰§è¡Œ merge å‚è€ƒèµ„æ–™ https://protobuf.dev/programming-guides/proto/ https://protobuf.dev/programming-guides/encoding/ https://github.com/protocolbuffers/protobuf ","link":"https://jayying007.github.io/post/æ·±å…¥ç†è§£Protobuf/"},{"title":"JSPatchæºç ç¬”è®°","content":"https://github.com/bang590/JSPatch ä½œè€…å±…ç„¶æ˜¯æ ¡å‹ï¼Œå“ˆå“ˆå“ˆ å…¶å®åœ¨ Github çš„ Wiki ä¸Šï¼Œå·²ç»æœ‰å¾ˆè¯¦ç»†çš„åŸç†è¯´æ˜äº†ï¼Œæ‰€ä»¥è¿™é‡Œçº¯ç²¹ä½œä¸ºæˆ‘ä¸ªäººé˜…è¯»æºç çš„ç¬”è®°ã€‚ è¿™ä¸ªé¡¹ç›®å¯¹äºå­¦ä¹  ObjC runtimeã€JavaScriptCore çš„åº”ç”¨éƒ½æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œå»ºè®®å‚è€ƒæ–‡æ¡£ç”¨ Safari è°ƒè¯•ä¸‹ JS ä»£ç ã€‚ defineClass æ–¹æ³•æ›¿æ¢ å¦‚æœæ˜¯æ›¿æ¢æ–¹æ³•ï¼Œä¼šç»™åŸ Class åŠ å…¥æ–°çš„ Methodï¼Œselector ä¸ºåŸæ–¹æ³•åç§°åŠ ä¸Š ORIG å‰ç¼€ï¼ŒIMP åˆ™æŒ‡å‘åŸæ–¹æ³•ã€‚ åŸæ–¹æ³•çš„ IMP åˆ™ä¿®æ”¹ä¸º_objc_msgForwardï¼Œå³å¼ºåˆ¶èµ°è½¬å‘æµç¨‹ã€‚ IMP msgForwardIMP = _objc_msgForward; if (class_respondsToSelector(cls, selector)) { NSString *originalSelectorName = [NSString stringWithFormat:@&quot;ORIG%@&quot;, selectorName]; SEL originalSelector = NSSelectorFromString(originalSelectorName); if(!class_respondsToSelector(cls, originalSelector)) { class_addMethod(cls, originalSelector, originalImp, typeDescription); } } _JSOverideMethods[cls][JPSelectorName] = function; class_replaceMethod(cls, selector, msgForwardIMP, typeDescription); è¿™ä¸ªè¿‡ç¨‹åŒæ—¶å°† JS å‡½æ•°è®°å½•ä¸‹æ¥ã€‚ï¼ˆ_JSOverideMethodsï¼‰ åœ¨ JS ä¸­ï¼Œä¹Ÿä¼šå°†è¯¥æ–¹æ³•è®°ä¸‹æ¥ï¼ˆ_ocClsï¼‰ var _setupJSMethod = function(className, methods, isInst, realClsName) { for (var name in methods) { var key = isInst ? 'instMethods': 'clsMethods', func = methods[name] _ocCls[className][key][name] = _wrapLocalMethod(name, func, realClsName) } } ... ... var ret = _OC_defineClass(declaration, newInstMethods, newClsMethods) var className = ret['cls'] var superCls = ret['superCls'] _ocCls[className] = { instMethods: {}, clsMethods: {}, } _setupJSMethod(className, instMethods, 1, realClsName) _setupJSMethod(className, clsMethods, 0, realClsName) return require(className) æœ€åçš„ require ç›¸å½“äºåœ¨ JS çš„å…¨å±€å˜é‡ä¸­å£°æ˜äº†è¿™ä¸ªå˜é‡ï¼Œåç»­ JS ä»£ç è°ƒç”¨å°±ä¸ä¼šæ‰¾ä¸åˆ°è¯¥å˜é‡äº†ã€‚ æ–¹æ³•æ·»åŠ  æ–¹æ³•æ·»åŠ å…¶å®è·Ÿä¸Šé¢çš„æµç¨‹å¾ˆåƒï¼Œæœ€åä¹Ÿæ˜¯åˆ©ç”¨ class_replaceMethod è¿™ä¸ªå‡½æ•°è¿›è¡Œæ–¹æ³•æ’å…¥ã€‚åªä¸è¿‡æ²¡æœ‰åŸæ–¹æ³•ï¼Œæ‰€ä»¥å…¶ IMP ç›´æ¥å°±æ˜¯_objc_msgForward è¿è¡Œ åœ¨ä¸€äº›å°å‹ patch ä¸Šï¼ŒdefineClass åŸºæœ¬å°±èƒ½è§£å†³é—®é¢˜äº†ã€‚åœ¨ JS è§£æè¿‡ç¨‹ä¸­ï¼Œæ— éå°±æ˜¯å°†è¿™äº›ç±»ã€æ–¹æ³•çš„ä¿¡æ¯åšä¸€ä¸‹å­˜å‚¨è®°å½•ã€‚ ç›´åˆ° App çœŸæ­£è¿è¡Œï¼Œæ‰§è¡Œåˆ°äº†è¢«æ›¿æ¢çš„æ–¹æ³•ï¼Œç„¶åæ¥åˆ°äº† JPForwardInvocation è¿™ä¸ªå‡½æ•°ã€‚ static void JPForwardInvocation(__unsafe_unretained id assignSlf, SEL selector, NSInvocation *invocation); è¿™é‡Œä» NSInvocation èƒ½æ‹¿åˆ°è¿”å›å€¼ã€è°ƒç”¨è€…ã€è°ƒç”¨æ–¹æ³•åã€è°ƒç”¨å‚æ•°ã€‚ ç»“åˆä¸Šé¢ä¿å­˜çš„ä¿¡æ¯ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”çš„ JS å‡½æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°ã€‚ JS å‡½æ•°é‡Œé¢ï¼Œå› ä¸ºåœ¨è§£æ JS è„šæœ¬ä¹‹å‰ï¼Œæ‰€æœ‰çš„æ–¹æ³•è°ƒç”¨å·²ç»è¢«è½¬ä¸º__c()è¿™ç§æ–¹æ³•è°ƒç”¨ handleBtn: function(sender) { var tableViewCtrl = JPTableViewController.__c(&quot;alloc&quot;)().__c(&quot;init&quot;)() self.__c(&quot;navigationController&quot;)().__c(&quot;pushViewController_animated&quot;)(tableViewCtrl, YES) } __c: function(methodName) { var slf = this if (slf instanceof Boolean) { return function() { return false } } if (slf[methodName]) { return slf[methodName].bind(slf); } if (!slf.__obj &amp;&amp; !slf.__clsName) { throw new Error(slf + '.' + methodName + ' is undefined') } if (slf.__isSuper &amp;&amp; slf.__clsName) { slf.__clsName = _OC_superClsName(slf.__obj.__realClsName ? slf.__obj.__realClsName: slf.__clsName); } var clsName = slf.__clsName if (clsName &amp;&amp; _ocCls[clsName]) { var methodType = slf.__obj ? 'instMethods': 'clsMethods' if (_ocCls[clsName][methodType][methodName]) { slf.__isSuper = 0; return _ocCls[clsName][methodType][methodName].bind(slf) } } return function(){ var args = Array.prototype.slice.call(arguments) return _methodFunc(slf.__obj, slf.__clsName, methodName, args, slf.__isSuper) } } __c æ–¹æ³•å…ˆåœ¨ä¹‹å‰çš„è®°å½•åˆ—è¡¨é‡Œé¢æŸ¥æ‰¾æ˜¯å¦æœ‰è¯¥ JS Functionï¼Œå¦‚æœæœ‰çš„è¯åˆ™è¿”å›å¯¹åº”çš„ JS Functionã€‚ å¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨_methodFuncã€‚ var _methodFunc = function ( instance, clsName, methodName, args, isSuper, isPerformSelector ) { var selectorName = methodName; if (!isPerformSelector) { methodName = methodName.replace(/__/g, &quot;-&quot;); selectorName = methodName.replace(/_/g, &quot;:&quot;).replace(/-/g, &quot;_&quot;); var marchArr = selectorName.match(/:/g); var numOfArgs = marchArr ? marchArr.length : 0; if (args.length &gt; numOfArgs) { selectorName += &quot;:&quot;; } } var ret = instance ? _OC_callI(instance, selectorName, args, isSuper) : _OC_callC(clsName, selectorName, args); return _formatOCToJS(ret); }; _methodFunc ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå…³é”®çš„æ–¹æ³•ï¼Œå®ƒå®ç°äº† JS è°ƒç”¨ä»»æ„ OC æ–¹æ³•ï¼Œä¸éš¾çŒœåˆ°ï¼Œ_OC_callI å’Œ_OC_callC çš„å®ç°é€»è¾‘å¤§æ¦‚å°±æ˜¯ï¼šæ ¹æ® clsName å’Œ selectorï¼Œæ‰¾åˆ°å¯¹åº”çš„ IMPï¼Œç„¶åæ‰§è¡Œã€‚ åˆ°è¿™é‡Œï¼ŒJSPatch çš„æ ¸å¿ƒåŸç†å·²ç»è®²å®Œäº†ã€‚ä»£ç ä¸ç®—å¤šï¼Œä½†å®ç°å¾ˆç²¾å¦™ã€‚ ç»†èŠ‚éƒ¨åˆ† super ä»¥ viewDidLoad ä¸ºä¾‹ viewDidLoad: function() { self.__c(&quot;super&quot;)().__c(&quot;viewDidLoad&quot;)() } JS ä¸Šä¸º Object å®šä¹‰äº† super æ–¹æ³•ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºæ‰“äº†ä¸€ä¸ª__isSuper çš„æ ‡è®°ã€‚ super: function() { var slf = this if (slf.__obj) { slf.__obj.__realClsName = slf.__realClsName; } return {__obj: slf.__obj, __clsName: slf.__clsName, __isSuper: 1} } ä¹‹åæ‰§è¡Œ viewDidLoad æ–¹æ³•æ—¶ï¼Œå°†è¯¥ä¿¡æ¯ä¼ é€’ç»™äº† callSector if (isSuper) { NSString *superSelectorName = [NSString stringWithFormat:@&quot;SUPER_%@&quot;, selectorName]; SEL superSelector = NSSelectorFromString(superSelectorName); Class superCls; if (realClsName.length) { Class defineClass = NSClassFromString(realClsName); superCls = defineClass ? [defineClass superclass] : [cls superclass]; } else { superCls = [cls superclass]; } Method superMethod = class_getInstanceMethod(superCls, selector); IMP superIMP = method_getImplementation(superMethod); class_addMethod(cls, superSelector, superIMP, method_getTypeEncoding(superMethod)); NSString *JPSelectorName = [NSString stringWithFormat:@&quot;_JP%@&quot;, selectorName]; JSValue *overideFunction = _JSOverideMethods[superCls][JPSelectorName]; if (overideFunction) { overrideMethod(cls, superSelectorName, overideFunction, NO, NULL); } selector = superSelector; superClassName = NSStringFromClass(superCls); } è¿™é‡ŒæŸ¥æ‰¾äº† superclassï¼Œä»¥åŠå¯¹åº” selector çš„ IMP å®ç°ï¼Œå¹¶å°†å…¶ä»¥å‰ç¼€ SUPER_çš„å½¢å¼åŠ å…¥å½“å‰ç±»çš„æ–¹æ³•åˆ—è¡¨ã€‚ struct JSValue åŸç”Ÿæ”¯æŒäº†å‡ ç§å¸¸è§ç»“æ„ä½“çš„è½¬æ¢ @interface JSValue (StructSupport) /*! @method @abstract Convert a JSValue to a CGPoint. @discussion Reads the properties named &lt;code&gt;x&lt;/code&gt; and &lt;code&gt;y&lt;/code&gt; from this JSValue, and converts the results to double. @result The new CGPoint. */ - (CGPoint)toPoint; /*! @method @abstract Convert a JSValue to an NSRange. @discussion Reads the properties named &lt;code&gt;location&lt;/code&gt; and &lt;code&gt;length&lt;/code&gt; from this JSValue and converts the results to double. @result The new NSRange. */ - (NSRange)toRange; /*! @method @abstract Convert a JSValue to a CGRect. @discussion Reads the properties named &lt;code&gt;x&lt;/code&gt;, &lt;code&gt;y&lt;/code&gt;, &lt;code&gt;width&lt;/code&gt;, and &lt;code&gt;height&lt;/code&gt; from this JSValue and converts the results to double. @result The new CGRect. */ - (CGRect)toRect; /*! @method @abstract Convert a JSValue to a CGSize. @discussion Reads the properties named &lt;code&gt;width&lt;/code&gt; and &lt;code&gt;height&lt;/code&gt; from this JSValue and converts the results to double. @result The new CGSize. */ - (CGSize)toSize; @end ä¸è¿‡ JSPatch æ”¯æŒä¼ é€’è‡ªå®šä¹‰çš„ç»“æ„ä½“ï¼Œä¸è¿‡è¿™éœ€è¦åœ¨ JSExtension ä¸­æå‰å®šä¹‰å¥½ç»“æ„ä½“çš„ä¿¡æ¯ã€‚ å…¶å® JSPatch ä¼ è¿‡æ¥çš„å‚æ•°å°±æ˜¯ä¸€ä¸ª NSDictionaryï¼Œè€Œç»“æ„ä½“æ— éå°±æ˜¯ malloc ä¸€æ®µå†…å­˜å—ï¼Œç„¶åæ ¹æ®ç»“æ„ä¿¡æ¯åœ¨ä¸åŒçš„åœ°å€å†™å…¥æ•°å€¼ã€‚ case '{': { NSString *typeString = extractStructName([NSString stringWithUTF8String:argumentType]); JSValue *val = arguments[i-2]; #define JP_CALL_ARG_STRUCT(_type, _methodName) \\ if ([typeString rangeOfString:@#_type].location != NSNotFound) { \\ _type value = [val _methodName]; \\ [invocation setArgument:&amp;value atIndex:i]; \\ break; \\ } JP_CALL_ARG_STRUCT(CGRect, toRect) JP_CALL_ARG_STRUCT(CGPoint, toPoint) JP_CALL_ARG_STRUCT(CGSize, toSize) JP_CALL_ARG_STRUCT(NSRange, toRange) @synchronized (_context) { NSDictionary *structDefine = _registeredStruct[typeString]; if (structDefine) { size_t size = sizeOfStructTypes(structDefine[@&quot;types&quot;]); void *ret = malloc(size); getStructDataWithDict(ret, valObj, structDefine); [invocation setArgument:ret atIndex:i]; free(ret); break; } } break; } è‡ªå®šä¹‰ç»“æ„ä½“çš„èµ‹å€¼å¯ä»¥æŸ¥çœ‹ getStructDataWithDict æ–¹æ³•ã€‚ C Function è¿™ä¸ªç”¨äº† ffi åº“ã€‚ å¤§è‡´æ€è·¯å°±æ˜¯é€šè¿‡å‡½æ•°åï¼Œåˆ©ç”¨ dlsym æ‰¾åˆ°å¯¹åº” C å‡½æ•°çš„å‡½æ•°åœ°å€ï¼Œç„¶åå°±èƒ½æ‰§è¡Œäº†ã€‚ block è¿™ä¸ªä¹Ÿæ˜¯ç”¨äº† ffi åº“ï¼Œä½†æ˜¯è°ƒè¯•æ—¶ block è°ƒç”¨é”™è¯¯ï¼Œissue ä¹Ÿæœ‰ä¸å°‘åé¦ˆï¼Œå¯èƒ½è·Ÿ iOS çš„ block ç»“æ„æ”¹å˜æœ‰å…³ï¼Ÿ ä¸è¿‡ä¹Ÿä¸å½±å“åŸç†çš„ç†è§£ global.block = function (args, cb) { var that = this; var slf = global.self; if (args instanceof Function) { cb = args; args = &quot;&quot;; } var callback = function () { var args = Array.prototype.slice.call(arguments); global.self = slf; return cb.apply(that, _formatOCToJS(args)); }; var ret = { args: args, cb: callback, argCount: cb.length, __isBlock: 1 }; if (global.__genBlock) { ret[&quot;blockObj&quot;] = global.__genBlock(args, cb); } return ret; }; JS è¿™é‡Œç»™ block æ‰“ä¸Šæ ‡è®°ï¼ŒåŒæ—¶ç»“åˆ JPBlock åˆ›å»ºäº†ä¸€ä¸ª BlockWrapper ä¼ é€’ç»™ OCã€‚ è¿™ä¸ª BlockWrapper åŒ…å«äº†å‡½æ•°çš„ç­¾åä¿¡æ¯ï¼Œä»¥åŠå¯¹åº”çš„ JS Functionã€‚æ‰€ä»¥è°ƒç”¨åŸ blockï¼Œå¯ä»¥ç†è§£ä¸ºåˆ›å»ºä¸€ä¸ªæ–°çš„ blockï¼Œè¿™ä¸ª block é‡Œé¢å†åˆ©ç”¨[JSValue callWithArgument:]è°ƒç”¨åˆ°åŸ block ","link":"https://jayying007.github.io/post/JSPatchæºç ç¬”è®°/"},{"title":"[è½¬] iOS APPå¯æ‰§è¡Œæ–‡ä»¶çš„ç»„æˆ","content":"ä¸ªäººæ„Ÿè§‰è¿™ä¸ªæ ‡é¢˜èµ·å¾—ä¸æ˜¯å¾ˆå¥½ï¼Œä¼šè¯¯è®¤ä¸ºæ˜¯åˆ†æ Math-O æ–‡ä»¶ï¼Œå®é™…ä¸Šæ˜¯ç»Ÿè®¡ä»£ç ç»„æˆã€‚ å‡ºäºå¥½å¥‡çœ‹äº†ä¸‹ä½œè€…ï¼ŒåŸæ¥æ˜¯ JSPatch çš„ä½œè€…ï¼Œè€Œä¸”è¿˜æ˜¯æ ¡å‹ï¼Œç”šè‡³è¿˜æ˜¯åŒäº‹ï¼Œä¸–ç•ŒçœŸå¥‡å¦™~ åŸæ–‡é“¾æ¥ï¼šiOS APP å¯æ‰§è¡Œæ–‡ä»¶çš„ç»„æˆ Â« bangâ€™s blog iOS APP ç¼–è¯‘åï¼Œé™¤äº†ä¸€äº›èµ„æºæ–‡ä»¶ï¼Œå‰©ä¸‹çš„å°±æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæœ‰æ—¶å€™é¡¹ç›®å¤§äº†ï¼Œå¼•å…¥çš„åº“å¤šäº†ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¾ˆå¤§ï¼Œæƒ³çŸ¥é“è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„æ„æˆæ˜¯æ€æ ·ï¼Œé‡Œé¢çš„å†…å®¹éƒ½æ˜¯äº›ä»€ä¹ˆï¼Œå“ªäº›åº“å ç”¨ç©ºé—´è¾ƒé«˜ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•å‹˜å¯Ÿï¼š 1.XCode å¼€å¯ç¼–è¯‘é€‰é¡¹ Write Link Map File XCode -&gt; Project -&gt; Build Settings -&gt; æœ map -&gt; æŠŠ Write Link Map File é€‰é¡¹è®¾ä¸º yesï¼Œå¹¶æŒ‡å®šå¥½ linkMap çš„å­˜å‚¨ä½ç½® 2.ç¼–è¯‘åï¼Œåˆ°ç¼–è¯‘ç›®å½•é‡Œæ‰¾åˆ°è¯¥ txt æ–‡ä»¶ï¼Œæ–‡ä»¶åå’Œè·¯å¾„å°±æ˜¯ä¸Šè¿°çš„ Path to Link Map File ä½äº~/Library/Developer/Xcode/DerivedData/XXX-eumsvrzbvgfofvbfsoqokmjprvuh/Build/Intermediates/XXX.build/Debug-iphoneos/XXX.build/ è¿™ä¸ª LinkMap é‡Œå±•ç¤ºäº†æ•´ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„å…¨è²Œï¼Œåˆ—å‡ºäº†ç¼–è¯‘åçš„æ¯ä¸€ä¸ª.o ç›®æ ‡æ–‡ä»¶çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬é™æ€é“¾æ¥åº“.a é‡Œçš„ï¼‰ï¼Œä»¥åŠæ¯ä¸€ä¸ªç›®æ ‡æ–‡ä»¶çš„ä»£ç æ®µï¼Œæ•°æ®æ®µå­˜å‚¨è¯¦æƒ…ã€‚ 1 ä»¥ä¼Šä¹¦é¡¹ç›®ä¸ºä¾‹ï¼Œåœ¨ LinkMap é‡Œé¦–å…ˆåˆ—å‡ºæ¥çš„æ˜¯ç›®æ ‡æ–‡ä»¶åˆ—è¡¨ï¼š # Object files: [ 0] linker synthesized [ 1] /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator7.0.sdk/usr/lib/crt1.o [ 2] /Users/bang/Library/Developer/Xcode/DerivedData/yishu-eyzgphknrrzpevagadjtwpzzeqag/Build/Intermediates/yishu.build/Debug-iphonesimulator/yishu.build/Objects-normal/i386/TKPFileInfo.o ... [280] /Users/bang/Downloads/yishu/yishu/Classes/lib/UMeng/MobClick/libMobClickLibrary.a(UMANJob.o) [281] /Users/bang/Downloads/yishu/yishu/Classes/lib/UMeng/MobClick/libMobClickLibrary.a(UMANWorker.o) [282] /Users/bang/Downloads/yishu/yishu/Classes/lib/UMeng/MobClick/libMobClickLibrary.a(MobClick.o) [283] /Users/bang/Downloads/yishu/yishu/Classes/lib/UMeng/MobClick/libMobClickLibrary.a(UMANLaunch.o) ... å‰é¢ä¸­æ‹¬å·é‡Œçš„æ˜¯è¿™ä¸ªæ–‡ä»¶çš„ç¼–å·ï¼Œåé¢ä¼šç”¨åˆ°ï¼Œåƒé¡¹ç›®é‡Œå¼•ç”¨åˆ°é™æ€é“¾æ¥åº“ libMobClickLibrary.a é‡Œçš„ç›®æ ‡æ–‡ä»¶éƒ½ä¼šåœ¨è¿™é‡Œåˆ—å‡ºæ¥ã€‚ 2 æ¥ç€æ˜¯ä¸€ä¸ªæ®µè¡¨ï¼Œæè¿°å„ä¸ªæ®µåœ¨æœ€åç¼–è¯‘æˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„åç§»ä½ç½®åŠå¤§å°ï¼ŒåŒ…æ‹¬äº†ä»£ç æ®µï¼ˆ**TEXTï¼Œä¿å­˜ç¨‹åºä»£ç æ®µç¼–è¯‘åçš„æœºå™¨ç ï¼‰å’Œæ•°æ®æ®µï¼ˆ**DATAï¼Œä¿å­˜å˜é‡å€¼ï¼‰ # Sections: # Address Size Segment Section 0x00002740 0x00273890 __TEXT __text 0x00275FD0 0x00000ADA __TEXT __symbol_stub 0x00276AAC 0x00001222 __TEXT __stub_helper 0x00277CCE 0x00019D9E __TEXT __objc_methname 0x00291A70 0x00012847 __TEXT __cstring 0x002A42B7 0x00001FC1 __TEXT __objc_classname 0x002A6278 0x000046A7 __TEXT __objc_methtype 0x002AA920 0x000061CE __TEXT __ustring 0x002B0AF0 0x00000764 __TEXT __const 0x002B1254 0x000028B8 __TEXT __gcc_except_tab 0x002B3B0C 0x00004EBC __TEXT __unwind_info 0x002B89C8 0x0003662C __TEXT __eh_frame 0x002EF000 0x00000014 __DATA __program_vars 0x002EF014 0x00000284 __DATA __nl_symbol_ptr 0x002EF298 0x0000073C __DATA __la_symbol_ptr 0x002EF9E0 0x000030A4 __DATA __const 0x002F2A84 0x00000590 __DATA __objc_classlist 0x002F3014 0x0000000C __DATA __objc_nlclslist 0x002F3020 0x0000006C __DATA __objc_catlist 0x002F308C 0x000000D8 __DATA __objc_protolist 0x002F3164 0x00000008 __DATA __objc_imageinfo 0x002F3170 0x0002BC80 __DATA __objc_const 0x0031EDF0 0x00003A30 __DATA __objc_selrefs 0x00322820 0x00000014 __DATA __objc_protorefs 0x00322834 0x000006B8 __DATA __objc_classrefs 0x00322EEC 0x00000394 __DATA __objc_superrefs 0x00323280 0x000037C8 __DATA __objc_data 0x00326A48 0x000096D0 __DATA __cfstring 0x00330118 0x00001424 __DATA __objc_ivar 0x00331540 0x00006080 __DATA __data 0x003375C0 0x0000001C __DATA __common 0x003375E0 0x000018E8 __DATA __bss é¦–åˆ—æ˜¯æ•°æ®åœ¨æ–‡ä»¶çš„åç§»ä½ç½®ï¼Œç¬¬äºŒåˆ—æ˜¯è¿™ä¸€æ®µå ç”¨å¤§å°ï¼Œç¬¬ä¸‰åˆ—æ˜¯æ®µç±»å‹ï¼Œä»£ç æ®µå’Œæ•°æ®æ®µï¼Œç¬¬å››åˆ—æ˜¯æ®µåç§°ã€‚ æ¯ä¸€è¡Œçš„æ•°æ®éƒ½ç´§è·Ÿåœ¨ä¸Šä¸€è¡Œåé¢ï¼Œå¦‚ç¬¬äºŒè¡Œsymbol_stub çš„åœ°å€ 0x00275FD0 å°±æ˜¯ç¬¬ä¸€è¡Œtext çš„åœ°å€ 0x00002740 åŠ ä¸Šå¤§å° 0x00273890ï¼Œæ•´ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¤§è‡´æ•°æ®åˆ†å¸ƒå°±æ˜¯è¿™æ ·ã€‚ è¿™é‡Œå¯ä»¥æ¸…æ¥šçœ‹åˆ°å„ç§ç±»å‹çš„æ•°æ®åœ¨æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶é‡Œå çš„æ¯”ä¾‹ï¼Œä¾‹å¦‚**text è¡¨ç¤ºç¼–è¯‘åçš„ç¨‹åºæ‰§è¡Œè¯­å¥ï¼Œ**data è¡¨ç¤ºå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡ï¼Œ**bss è¡¨ç¤ºæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡ï¼Œ**cstring è¡¨ç¤ºä»£ç é‡Œçš„å­—ç¬¦ä¸²å¸¸é‡ï¼Œç­‰ç­‰ã€‚ 3 æ¥ç€å°±æ˜¯æŒ‰ä¸Šè¡¨é¡ºåºï¼Œåˆ—å‡ºå…·ä½“çš„æŒ‰æ¯ä¸ªæ–‡ä»¶åˆ—å‡ºæ¯ä¸ªå¯¹åº”å­—æ®µçš„ä½ç½®å’Œå ç”¨ç©ºé—´ # Address Size File Name 0x00002740 0x0000003E [ 1] start 0x00002780 0x00000400 [ 2] +[TKPFileInfo parseWithDictionary:] 0x00002B80 0x00000030 [ 2] -[TKPFileInfo fileID] ... åŒæ ·é¦–åˆ—æ˜¯æ•°æ®åœ¨æ–‡ä»¶çš„åç§»åœ°å€ï¼Œç¬¬äºŒåˆ—æ˜¯å ç”¨å¤§å°ï¼Œç¬¬ä¸‰åˆ—æ˜¯æ‰€å±æ–‡ä»¶åºå·ï¼Œå¯¹åº”ä¸Šè¿° Object files åˆ—è¡¨ï¼Œæœ€åæ˜¯åå­—ã€‚ ä¾‹å¦‚ç¬¬äºŒè¡Œä»£è¡¨äº†æ–‡ä»¶åºå·ä¸º 2ï¼ˆåæŸ¥ä¸Šé¢å°±æ˜¯ TKPFileInfo.oï¼‰çš„ parseWithDictionary æ–¹æ³•å ç”¨äº† 1000byte å¤§å°ã€‚ ä½¿ç”¨ è¿™ä¸ªæ–‡ä»¶å¯ä»¥è®©ä½ äº†è§£æ•´ä¸ª APP ç¼–è¯‘åçš„æƒ…å†µï¼Œä¹Ÿè®¸ä»ä¸­å¯ä»¥å‘ç°ä¸€äº›å¼‚å¸¸ï¼Œè¿˜å¯ä»¥ç”¨è¿™ä¸ªæ–‡ä»¶è®¡ç®—é™æ€é“¾æ¥åº“åœ¨é¡¹ç›®é‡Œå çš„å¤§å°ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬åœ¨é¡¹ç›®é‡Œé“¾äº†å¾ˆå¤šç¬¬ä¸‰æ–¹åº“ï¼Œå¯¼è‡´ APP ä½“ç§¯å˜å¤§å¾ˆå¤šï¼Œæˆ‘ä»¬æƒ³ç¡®åˆ‡çŸ¥é“æ¯ä¸ªåº“å ç”¨äº†å¤šå¤§ç©ºé—´ï¼Œå¯ä»¥ç»™æˆ‘ä»¬ä¼˜åŒ–æä¾›æ–¹å‘ã€‚LinkMap é‡Œæœ‰äº†æ¯ä¸ªç›®æ ‡æ–‡ä»¶æ¯ä¸ªæ–¹æ³•æ¯ä¸ªæ•°æ®çš„å ç”¨å¤§å°æ•°æ®ï¼Œæ‰€ä»¥åªè¦å†™ä¸ªè„šæœ¬ï¼Œå°±å¯ä»¥ç»Ÿè®¡å‡ºæ¯ä¸ª.o æœ€åçš„å¤§å°ï¼Œå±äºä¸€ä¸ª.a é™æ€é“¾æ¥åº“çš„.o åŠ èµ·æ¥ï¼Œå°±æ˜¯è¿™ä¸ªåº“åœ¨ APP é‡Œå ç”¨çš„ç©ºé—´å¤§å°ã€‚ å†™äº†ä¸ª nodejs ç‰ˆç»Ÿè®¡ç¨‹åºå¯ä¾›ä½¿ç”¨ï¼šhttps://gist.github.com/bang590/8f3e9704f1c2661836cd ","link":"https://jayying007.github.io/post/[è½¬] iOS APPå¯æ‰§è¡Œæ–‡ä»¶çš„ç»„æˆ/"},{"title":"Xcodeå¼€å‘æ’ä»¶","content":"æœ€è¿‘åœ¨è€ƒå¤ä¸€äº› iOS åšå®¢ï¼Œå‘ç°è¿˜èƒ½ç”¨ Xcode æ¥å†™æ’ä»¶ã€‚ Github ä¸Šæœ‰ä¸€äº› star æ•°å¾ˆé«˜çš„å¼€æºé¡¹ç›®ï¼Œæ¯”å¦‚ è‡ªåŠ¨å¡«å……å›¾ç‰‡åç§°ï¼šhttps://github.com/ksuther/KSImageNamed-Xcode æ˜¾ç¤º RGB é¢œè‰²ï¼šhttps://github.com/omz/ColorSense-for-Xcode ä¹Ÿèƒ½æœåˆ°ä¸€äº›ä¸é”™çš„å…¥é—¨æ•™ç¨‹ Xcode 4 æ’ä»¶åˆ¶ä½œå…¥é—¨ How To Create an Xcode Plugin: Part 1/3 æœ¬æ¥æƒ³è‡ªå·±æ•´ä¸ªæ’ä»¶ç©ç©ï¼Œä½†è¯•äº†å‡ ä¸ªæ’ä»¶éƒ½ç”¨ä¸äº†ï¼Œæœ€å Google æ‰å‘ç° Xcode8 å¼€å§‹å·²ç»ä¸æ”¯æŒæ’ä»¶äº†ï¼Œå…·ä½“å¯ä»¥çœ‹è¿™ä¸ªè®¨è®ºXcode 8 wonâ€™t load plug-ins Â· Issue #475 Â· alcatraz/Alcatraz è‹¹æœåœ¨ã€ŠWWDC 2016 session about source editor extensionsã€‹ä¸­æ•´äº†ä¸€ä¸ªæ–°çš„ç©æ„ï¼Œä½†æ˜¯è¿™ç©æ„é™åˆ¶å¤ªå¤§ï¼Œåªèƒ½å¤„ç† Xcode å†…çš„ä»£ç ç¼–è¾‘ï¼Œåšä¸äº†ä»£ç æç¤ºè¿™ä¹ˆçµæ´»çš„äº‹æƒ…äº†ã€‚ æ¯”å¦‚è¿™ä¸ªé¡¹ç›®https://github.com/iDevOrz/JYLazyLoaderï¼Œæ ¹æ® property è‡ªåŠ¨ç”Ÿæˆæ‡’åŠ è½½æ–¹æ³•ã€‚ fuck Appleï¼ï¼ï¼ ","link":"https://jayying007.github.io/post/Xcodeå¼€å‘æ’ä»¶/"},{"title":"æ­£å¼è®°å½•è¯­é›€ç¬¬ä¸€ç¯‡æ–‡ç« ","content":"å‰è¨€ è¿™ä¸ªæ ‡é¢˜å¯èƒ½æœ‰ç‚¹è¯¯å¯¼ï¼Œå› ä¸ºæˆ‘ä» 2020 å¹´å°±å¼€å§‹ç”¨è¯­é›€äº†ã€‚ è¿™é‡ŒæŒ‡çš„å…¶å®æ˜¯ç”¨è¯­é›€åœ¨æˆ‘çš„åšå®¢å‘å¸ƒæ–‡ç« ã€‚ 2021 å¹´ç™½å«–ä¸€å°æœåŠ¡å™¨ä¹‹åï¼Œå°±åœ¨ä¸Šé¢æ­å»ºäº†ä¸ªäººåšå®¢ï¼Œä¹Ÿå‘äº†ä¸€äº›æ–‡ç« ã€‚è¿™é‡Œå†™æ–‡ç« éœ€è¦ä½¿ç”¨ Markdown è¯­æ³•ï¼Œå½“æ—¶ç”¨çš„æ˜¯ Typora+PicGo ç»„åˆï¼Œå…¶å®ä¹Ÿè¿˜ä¸é”™ã€‚ ä¸è¿‡è‡ªå»ºçš„ Hexo åšå®¢å…¶å®ç‰¹æ€§å¹¶æ²¡æœ‰è¯­é›€é‚£ä¹ˆå¤šï¼Œå°±ç¼–è¾‘ä½“éªŒè€Œè¨€ï¼Œä¹Ÿæ˜¯è¯­é›€ä¼˜ä¸€äº›ã€‚å¦å¤–ä½ ä¹Ÿéœ€è¦åŒæ—¶ç»´æŠ¤åšå®¢å’Œè¯­é›€ä¸¤å¥—ç³»ç»Ÿã€‚ ç»¼åˆè¿™äº›å› ç´ ï¼Œåé¢æˆ‘çš„æ–‡ç« ä¸»è¦è¾“å‡ºéƒ½åœ¨è¯­é›€ä¸Šã€‚2022 å¹´æˆ‘çš„ä¸ªäººåšå®¢åŸºæœ¬æ²¡æœ‰äº§å‡ºäº†ã€‚ å¦å¤–ï¼Œè™½ç„¶è¯­é›€ä¸Šé¢çš„æ–‡ç« ä¹Ÿæ˜¯å…¬å¼€çš„ï¼Œä½†æ˜¯çŒœæµ‹æ˜¯å› ä¸ºåçˆ¬ç­–ç•¥ï¼Œæœç´¢å¼•æ“ä¸Šä¹Ÿæ‰¾ä¸åˆ°æ–‡ç« ã€‚ äºæ˜¯æœ‰äº†éœ€æ±‚ï¼šåœ¨è¯­é›€ä¸Šé¢ç¼–è¾‘æ–‡ç« ï¼Œç„¶åè‡ªåŠ¨å‘å¸ƒåˆ°ä¸ªäººåšå®¢ä¸Šã€‚ å¼€æå§ ğŸ”¨ ç”¨æµç¨‹å›¾æ¥è¡¨ç¤ºï¼Œå¤§æ¦‚å¦‚å›¾æ‰€ç¤º åœ¨è¯­é›€ä¸Šå†™å®Œæ–‡ç« åï¼Œé€šè¿‡ WebHook çš„æ–¹å¼é€šçŸ¥åˆ°åšå®¢æœåŠ¡å™¨ï¼› æœåŠ¡å™¨é€šè¿‡è¯­é›€ Tokenï¼Œè®¿é—®å…¶å¼€æ”¾ API è¯»å–æ–‡ç« ï¼› é€šè¿‡ hexo å‘½ä»¤é‡æ–°ç”Ÿæˆé™æ€ç½‘ç«™ã€éƒ¨ç½²ã€‚ WebHook å¯ä»¥åœ¨çŸ¥è¯†åº“è®¾ç½®é‡Œé¢é€‰æ‹© æœåŠ¡å™¨çš„è¯ï¼Œå…¶å®æˆ‘ä»¬åªæ˜¯æƒ³æ”¶åˆ° Push é€šçŸ¥ï¼Œç„¶åè°ƒç”¨è„šæœ¬æ‰§è¡Œç›¸å…³å‘½ä»¤ã€‚ è¿™é‡Œé€‰æ‹©äº†æœ€ç®€å•çš„ Nodejs æ­å»ºæœåŠ¡å™¨ï¼Œä»£ç å¦‚ä¸‹ //å¯¼å…¥ç¬¬ä¸‰æ–¹æ¨¡å—ï¼šexpressï¼Œåˆ›å»ºåŸºäºNode.jsçš„WebæœåŠ¡å™¨ let express = require(&quot;express&quot;); const { exec } = require(&quot;child_process&quot;); //è°ƒç”¨ç¬¬ä¸‰æ–¹æ¨¡å—æä¾›çš„åŠŸèƒ½ let server = express(); //è¿è¡ŒWebæœåŠ¡å™¨ç›‘å¬ç‰¹å®šçš„ç«¯å£ let port = 5050; server.listen(port, function (req, rsp) { console.log(&quot;æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨ç›‘å¬ç«¯å£ï¼š&quot;, port); }); var isRuningScript = false; server.post(&quot;/yuque/xxx&quot;, function (req, res) { console.log(&quot;receive notify from yuque&quot;); if (isRuningScript) { console.log(&quot;is running&quot;); return; } isRuningScript = true; exec(&quot;xxx.sh&quot;, (err, stdout, stderr) =&gt; { // console.log(`stdout: ${stdout}`); // console.log(`stderr: ${stderr}`); isRuningScript = false; if (err) { console.log(&quot;fail to execute shell&quot;); return; } console.log(&quot;website is redeploy&quot;); }); }); ç„¶ååœ¨åå°è¿è¡Œ node main.js &gt;log.txt 2&gt;&amp;1 &amp; è„šæœ¬çš„é€»è¾‘åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šæ‹‰å–è¯­é›€æ–‡ç« ã€é‡æ–°éƒ¨ç½² hexoã€‚ æ‹‰å–è¯­é›€æ–‡ç« ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ç°æœ‰è½®å­yuque-hexoã€‚ è¿™æ ·æˆ‘ä»¬çš„è„šæœ¬å°±å¤§æ¦‚å¦‚ä¸‹ YUQUE_TOKEN=xxx yuque-hexo sync hexo clean hexo generate hexo deploy è¿›ä¸€æ­¥ â“ ä¸Šé¢å·²ç»è§£å†³äº†è¯­é›€å‘å¸ƒæ–‡ç« ï¼Œè‡ªåŠ¨åŒæ­¥ä¸ªäººåšå®¢ã€‚ä¸è¿‡è§‚å¯Ÿä¸Šé¢çš„æµç¨‹ï¼Œä½ ä¼šå‘ç°æˆ‘ä»¬æŠŠ Hexo æ•´ä¸ªæ–‡ä»¶å¤¹éƒ½æ”¾åˆ°æœåŠ¡å™¨ä¸Šé¢äº†ã€‚å¦‚æœæˆ‘æƒ³æ¢ä¸ªåšå®¢ä¸»é¢˜æˆ–è€…è°ƒæ•´ä¸‹é…ç½®ï¼Œå°±åªèƒ½åˆ°æœåŠ¡å™¨ä¸Šé¢æ”¹äº†ã€‚ è¿™æ˜¾ç„¶å¾ˆä¸æ–¹ä¾¿ï¼Œå®é™…ä¸Šï¼Œä¸ºäº†çŸ¥é“æŸä¸ªé…ç½®æ˜¯å¦è°ƒæ•´åˆé€‚ï¼Œä½ è¿˜æ˜¯éœ€è¦æœ¬åœ°è¿è¡Œçœ‹ä¸€éã€‚ äºæ˜¯éœ€æ±‚åˆæ¥äº†ï¼šæœ¬åœ°ä¿®æ”¹é…ç½®ï¼Œæäº¤ Commit åèƒ½è‡ªåŠ¨æ›´æ–°åšå®¢æ ·å¼ã€‚ æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š Github ä¸Šé¢ä¹Ÿæœ‰ WebHookï¼ŒæœåŠ¡å™¨æ²¿ç”¨ Nodejs çš„ä»£ç å³å¯ï¼Œå’Œè¯­é›€å¾ˆç›¸ä¼¼ï¼Œç»™ä¸ªæ–°æ¥å£åŒºåˆ†ä¸‹ server.post(&quot;/github/yyy&quot;, function (req, res) { console.log(&quot;receive notify from github&quot;); if (isRuningScript) { console.log(&quot;is running&quot;); return; } isRuningScript = true; exec(&quot;yyy.sh&quot;, (err, stdout, stderr) =&gt; { // console.log(`stdout: ${stdout}`); // console.log(`stderr: ${stderr}`); isRuningScript = false; if (err) { console.log(&quot;fail to execute shell&quot;); return; } console.log(&quot;website is redeploy&quot;); }); }); è¿™é‡Œå› ä¸ºä¸å­˜åœ¨è¯­é›€æ–‡æ¡£çš„æ›´æ–°ï¼Œæ‰€ä»¥è„šæœ¬åªæ˜¯æ›´æ–°ä»£ç ã€é‡æ–°éƒ¨ç½² Hexoã€‚ npm update git fetch origin master git reset --hard origin/master git submodule update hexo clean hexo generate hexo deploy è¿™æ ·å°±å¥½äº†å— è¦çŸ¥é“ï¼Œæˆ‘åŸå…ˆ Hexo ä¸Šé¢æœ‰å¥½äº›æ–‡ç« çš„ï¼Œä½†æ˜¯ä½¿ç”¨ yuque-hexo æ’ä»¶ä¹‹åï¼Œå®ƒæŠŠæˆ‘çš„æ–‡ç« å…¨åˆ æ‰äº†ï¼Œæ›¿æ¢ä¸ºè¯­é›€ä¸Šçš„æ–‡ç« ã€‚ ä½†æˆ‘è¿˜æƒ³ä¿ç•™åŸå…ˆ Hexo ä¸Šçš„æ–‡ç« ï¼Œä¸€ç§åšæ³•æ˜¯ä¿®æ”¹ yuque-hexo çš„ä»£ç ï¼ŒæŠŠé‚£æ®µåˆ é™¤çš„é€»è¾‘ç»™å»æ‰ï¼Œå®é™…ä¸Šæˆ‘å·²ç»æäº†Â· Issue #135 Â· x-cold/yuque-hexo å‰ç«¯çš„é€»è¾‘æˆ‘ä¸å¤ªç†Ÿã€‚å®é™…ä¸Šï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•ä¸ç”¨æ”¹ yuque-hexo ä»£ç å°±èƒ½å®ç°ä¸Šé¢çš„æ•ˆæœï¼š åœ¨æäº¤ Hexo ä»£ç çš„æ—¶å€™ï¼Œå°†å…¶ä¸­çš„æ–‡ç«  copy åˆ°æŸä¸ªè·¯å¾„ï¼Œä¹Ÿåšæäº¤ã€‚ç„¶ååšå®¢æœåŠ¡å™¨æ‹‰å–ä»£ç æ—¶ï¼Œå°±èƒ½æŠŠè¿™éƒ¨åˆ†ä¹Ÿæ‹‰ä¸‹æ¥ã€‚åé¢æ‰§è¡Œ yuque-hexo æ¸…ç†äº†åŸè·¯å¾„åï¼ŒæŠŠ copy çš„é‚£ä»½å†æŒªå›å»å°±å¯ä»¥äº†ã€‚ ä¸ºäº†å®ç°è¿™ä¸ªé€»è¾‘ï¼Œå¤§æ¦‚éœ€è¦å¦‚ä¸‹ä¿®æ”¹ï¼š åˆ©ç”¨ Git hooksï¼Œåœ¨ pre-commit å’Œ commit-msg ä¸­åŠ ä¸Šä»¥ä¸‹ä»£ç  origin_post_dir=source/_posts_origin if [ ! -d &quot;$origin_post_dir&quot; ]; then mkdir $origin_post_dir fi exec cp source/_posts/* $origin_post_dir åœ¨ post-commit åŠ ä¸Šä»¥ä¸‹ä»£ç  git add source/_posts_origin git commit --no-verify -m &quot;auto commit _posts_origin&quot; ä¹‹åæ‹‰å–è¯­é›€çš„è„šæœ¬åšä¸‹æ›´æ–° YUQUE_TOKEN=xxx yuque-hexo sync cp source/_posts_origin/* source/_posts hexo clean hexo generate hexo deploy è¿™æ ·åšå®Œå°±å¾ˆå®Œç¾äº†_ æ‰©å±• åœ¨ç½‘ä¸ŠæŸ¥æ‰¾èµ„æ–™çš„æ—¶å€™ï¼Œå‘ç°å¤§å¤šæ•°éƒ½æ˜¯ç”¨çš„ Github Actionã€Github Pages ç­‰è‡ªåŠ¨åŒ–éƒ¨ç½²æ–¹æ¡ˆï¼Œæ¯•ç«Ÿåªæœ‰æˆ‘çš„æœåŠ¡å™¨æ˜¯ç™½å«–çš„ ğŸ¶ã€‚å¦‚æœæ˜¯è¿™ç§éœ€æ±‚çš„ï¼Œå¯ä»¥å‚è€ƒè¿™äº›ï¼š å¦‚ä½•å°†è¯­é›€æ–‡ç« å‘å¸ƒåˆ° Hexo åšå®¢ Hexoï¼šè¯­é›€äº‘ç«¯å†™ä½œ Github Actions æŒç»­é›†æˆ | HONGWEI å¦ä¸€ä¸ªç‚¹æ˜¯ï¼Œå¦‚æœä½ å¹¶ä¸è¿½æ±‚åŠæ—¶åŒæ­¥è¯­é›€çš„æ–‡ç« åˆ°åšå®¢ä¸Šï¼Œä½ å®Œå…¨ä¸éœ€è¦ WebHookï¼Œä¸éœ€è¦æ­å»º Nodejs æœåŠ¡å™¨ã€‚ åªéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå†™ä¸€ä¸ªå®šæ—¶è„šæœ¬ï¼Œå®šæœŸæ‹‰å–è¯­é›€å’Œæ‹‰å–ä»£ç å³å¯ã€‚ å…¶ä»–èµ„æ–™ è¯­é›€çš„å¼€æ”¾ API æ–‡æ¡£å¼€å‘è€…æ–‡æ¡£ æˆ‘çš„ Hexo Next ä¸»é¢˜ https://github.com/jayying007/hexo-theme-next ","link":"https://jayying007.github.io/post/æ­£å¼è®°å½•è¯­é›€ç¬¬ä¸€ç¯‡æ–‡ç« /"},{"title":"ç¥ç§˜çš„RSS","content":"æ˜¥èŠ‚æ”¾å‡æ—¶å¶ç„¶é—´æœåˆ°RSSè¿™ä¸ªç©æ„ï¼Œé—²æ¥æ— äº‹ï¼Œå°±ç¨å¾®ç ”ç©¶äº†ä¸€ä¸‹ã€‚ æˆ‘æœ¬äººæ˜¯ä¸å¤§å–œæ¬¢æ‰‹æœºä¸Šè£…ä¸€å¤§å †Appçš„ï¼Œä½†æˆ‘åˆæƒ³çŸ¥é“å¤–ç•Œå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ã€‚æ‰€ä»¥æˆ‘ä¸€ç›´ç”¨â€œä»Šæ—¥çƒ­æ¦œâ€œè¿™æ¬¾Appæ¥è·Ÿè¸ªä¸€äº›çƒ­æ–°é—»ã€‚ åœ¨iPhoneä¸Šï¼Œéœ€è¦ç”¨ä¸€ä¸ªå¤–å›½åŒºçš„è´¦å·ï¼Œæ‰èƒ½åœ¨App Storeä¸Šæœåˆ°è¿™ä¸ªAppï¼Œå›½å†…ç”±äºä¸€äº›ä¸å¯æŠ—æ‹’çš„åŸå› è¢«ä¸‹çº¿äº†ã€‚ RSSç®€ä»‹ RSSå…¶å®è·Ÿæˆ‘ä¸Šé¢æåˆ°çš„é‚£æ¬¾Appå¾ˆç±»ä¼¼ï¼Œä¸è¿‡å€ŸåŠ©ä¸€äº›æ’ä»¶ï¼Œå¯ä»¥æŠ“å–åˆ°æ›´ç»†èŠ‚çš„ä¸€äº›ä¿¡æ¯ã€‚ æˆ‘ä¸æ‰“ç®—è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œæœ‰ç¯‡ä¸é”™çš„æ–‡ç«  RSSåŸç†æµ…æ çœ‹é˜®ä¸€å³°çš„ä¸¤ä¸ªRSSæºï¼Œå…¶å®å°±æ˜¯ä¸€äº›Xmlæ•°æ®ã€‚ https://feeds.feedburner.com/ruanyifeng https://www.ruanyifeng.com/blog/atom.xml åªè¦çŸ¥é“è¿™ä¸ªXmlçš„ç»“æ„ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªRSSé˜…è¯»å™¨ï¼Œç”šè‡³ä¸éœ€è¦è‡ªå·±åšå†…å®¹æ¸²æŸ“ï¼Œå†…åµŒä¸€ä¸ªWebViewå³å¯ã€‚ ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ä¸åœ¨ä¹RSSæºæ˜¯ä»å“ªé‡Œæ¥çš„ï¼Œåªè¦å®ƒèƒ½è¿”å›Xmlæ•°æ®å°±è¡Œï¼Œäºæ˜¯å°±æœ‰äº†RSSHubè¿™æ ·çš„ä¸­é—´äººã€‚ RSSHub RSSHubå®˜ç½‘è¢«å¢™äº†ï¼Œæˆ‘å¾ˆè¯§å¼‚ã€‚ä¸è¿‡è‡ªå·±æ­å»ºéš¾åº¦ä¹Ÿä¸é«˜ï¼Œæ¯”å¦‚æˆ‘è¿™ä¸ªåšå®¢å°±éƒ¨ç½²äº†RSSHubï¼Œhttp://www.zhuangjieying.com:1200 #ç”¨dockerçœŸçš„å¾ˆæ–¹ä¾¿ sudo docker run -d --name rsshub -p 1200:1200 -e CACHE_EXPIRE=3600 diygod/rsshub ä¸€å¼€å§‹æˆ‘ä»¥ä¸ºRSSHubæ˜¯çˆ¬å–äº†å¯¹åº”ç½‘ç«™çš„æ•°æ®ï¼Œç„¶åè¯·æ±‚æ—¶å†æ‹¼æ¥æˆXmlè¿”å›ç»™æˆ‘ä»¬ã€‚ ä½†æˆ‘è¯•äº†è®¢é˜…Bilibiliçš„è§†é¢‘è¯„è®ºï¼Œå‘ç°å®ƒå…¶å®æ˜¯è°ƒç”¨äº†Bilibiliçš„APIã€‚ ä¾‹å¦‚è¿™ä¸ªï¼šhttps://api.bilibili.com/x/v2/reply?type=1&amp;oid=BV1L24y1z7sw&amp;sort=0 å½“ç„¶ï¼Œåº”è¯¥ä¸ä¸€å®šæœ‰é‚£ä¹ˆå¤šç½‘ç«™æœ‰è¿™ç§å¼€æ”¾èƒ½åŠ›ï¼Œæ‰€ä»¥RSSHubåº”è¯¥æ˜¯ç”¨äº†å„ç§ä¸åŒçš„æŠ“å–ç­–ç•¥ã€‚ ","link":"https://jayying007.github.io/post/LUXfkV4cdh/"},{"title":"IOSéŸ³é¢‘æŠ€æœ¯ï¼ˆä¸€ï¼‰Audio Session","content":"ç®€ä»‹ Audio Sessionæ˜¯IOSæä¾›çš„ä¸€ä¸ªç”¨æ¥ç®¡ç†éŸ³é¢‘çš„ç±»ã€‚é€šè¿‡Audio Sessionï¼Œä½ å¯ä»¥æè¿°å¦‚ä½•å¤„ç†ä½ çš„Appçš„éŸ³é¢‘è·Ÿå…¶ä»–Appçš„éŸ³é¢‘çš„å…³ç³»ã€‚åŒæ—¶ä¹Ÿå¯ä»¥å‘Šè¯‰æ“ä½œç³»ç»Ÿä½ å°†å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶è®¾å¤‡ï¼Œæ¯”å¦‚éº¦å…‹é£ã€æ‰¬å£°å™¨ã€‚Audio Sessionæ˜¯æˆ‘ä»¬è·ŸéŸ³é¢‘ç¡¬ä»¶æ‰“äº¤é“çš„ä¸­ä»‹ã€‚ ç³»ç»Ÿæä¾›äº†AVAudioSessionè¿™ä¸ªç±»æ¥ä»£è¡¨Audio Sessionï¼Œå®ƒæ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œåœ¨Appå¯åŠ¨ä¹‹åç³»ç»Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ–ã€‚ä¸»è¦æä¾›çš„åŠŸèƒ½æœ‰ä»¥ä¸‹ï¼š è®¾ç½®Appçš„éŸ³é¢‘è¡¨ç°å½¢å¼ æ¥å—Audio Sessionç›¸å…³é€šçŸ¥ï¼Œæ¯”å¦‚AudioInterruptã€RouteChange é…ç½®éŸ³é¢‘è®¾å¤‡çš„ä¸€äº›æ’­æ”¾å‚æ•°ï¼Œå¦‚é‡‡æ ·ç‡ã€é€šé“æ•° è®¾ç½®Appçš„éŸ³é¢‘è¡¨ç°å½¢å¼ æ¯”å¦‚å½“ä½ æƒ³æ’­æ”¾éŸ³é¢‘æ—¶ï¼Œå…¶ä»–Appä¹Ÿåœ¨æ’­æ”¾éŸ³é¢‘ã€‚è¿™æ—¶å€™ä½ æœ‰å‡ ç§é€‰æ‹©ï¼š æš‚åœå…¶ä»–Appçš„éŸ³é¢‘ï¼ˆéœ€è¦å…¶ä»–Appæ˜¯non-mixableï¼‰ ä¸€èµ·æ’­æ”¾ï¼ˆè‡ªå·±æˆ–å…¶ä»–Appæ˜¯mixableï¼‰ ä¸€èµ·æ’­æ”¾ä½†æ˜¯å‡å°‘å…¶ä»–Appçš„éŸ³é‡ã€‚ ç³»ç»Ÿæä¾›äº†å¾ˆå¤šç§Categoryï¼Œé€šè¿‡è®¾ç½®ä¸åŒçš„Categoryï¼Œå¯ä»¥è¡¨æ˜ä½ çš„Appçš„éŸ³é¢‘è¡¨ç°ï¼Œå…·ä½“çœ‹ä¸‹é¢è¿™å¼ è¡¨ï¼š Category æŒ‰ä¸‹é™éŸ³é”®oré”å±æ—¶é™éŸ³ ä¸­æ–­å…¶ä»–æ— æ³•æ··åˆæ’­æ”¾çš„App å…è®¸è¾“å…¥ï¼ˆå½•éŸ³ï¼‰å’Œè¾“å‡ºï¼ˆæ’­æ”¾ï¼‰ AVAudioSessionCategoryAmbient Yes No åªæœ‰è¾“å‡º AVAudioSessionCategorySoloAmbient (Default) Yes Yes åªæœ‰è¾“å‡º AVAudioSessionCategoryPlayback No Yes åªæœ‰è¾“å‡º AVAudioSessionCategoryRecord No (é”å±æ—¶ç»§ç»­å½•éŸ³) Yes åªæœ‰è¾“å…¥ AVAudioSessionCategoryPlayAndRecord No Yes è¾“å…¥å’Œè¾“å‡º AVAudioSessionCategoryMultiRoute No Yes è¾“å…¥å’Œè¾“å‡º æ³¨æ„æœ€åä¸€ä¸ªCategoryï¼Œè‹¹æœçš„å®šä¹‰æ˜¯ï¼š The category for routing distinct streams of audio data to different output devices at the same time. å°±æ˜¯è™½ç„¶å¯ä»¥æ‰¬å£°å™¨å’Œè€³æœºåŒæ—¶æ’­æ”¾ï¼Œä½†éœ€è¦æ˜¯ä¸åŒçš„éŸ³é¢‘æµ ä¸Šè¿°ä¸€äº›æ‰“æ–­å…¶ä»–Appæ’­æ”¾çš„Categoryï¼Œå¦‚æœä½ æƒ³å®ç°æ··åˆæ’­æ”¾ï¼Œåˆ™å¯é€šè¿‡å¢åŠ Optionï¼šAVAudioSessionCategoryOptionMixWithOthersæ¥å®ç°ã€‚ å®Œæ•´çš„APIæ˜¯è¿™ä¸ªï¼šsetCategory:mode:options:error:,è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªModeå‚æ•°ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ä¸åŒéŸ³é¢‘åœºæ™¯ä¸‹ï¼Œè®©ç³»ç»Ÿåšç›¸å…³çš„ä¿¡å·å¤„ç†ä¼˜åŒ–ï¼Œè§ä¸‹è¡¨ï¼š Mode identifiers Compatible categories AVAudioSessionModeDefault All AVAudioSessionModeMoviePlayback AVAudioSessionCategoryPlayback AVAudioSessionModeVideoRecording AVAudioSessionCategoryPlayAndRecord``AVAudioSessionCategoryRecord AVAudioSessionModeVoiceChat AVAudioSessionCategoryPlayAndRecord AVAudioSessionModeGameChat AVAudioSessionCategoryPlayAndRecord AVAudioSessionModeVideoChat AVAudioSessionCategoryPlayAndRecord AVAudioSessionModeSpokenAudio AVAudioSessionCategoryPlayback AVAudioSessionModeMeasurement AVAudioSessionCategoryPlayAndRecord``AVAudioSessionCategoryRecord``AVAudioSessionCategoryPlayback ä¸€ä¸ªä¾‹å­ æ¯”å¦‚ä½ è¦å®ç°éŸ³é¢‘å¯ä»¥åœ¨åå°æ’­æ”¾ï¼Œå¦‚æœæœ‰å…¶ä»–Appçš„éŸ³é¢‘åˆ™é™ä½å…¶éŸ³é‡ï¼Œä»£ç å¦‚ä¸‹ï¼š [[AVAudioSession sharedInstance] setActive:NO error:nil]; [[AVAudioSession sharedInstance] setCategory:AVAudioSessionCategoryPlayback withOptions:AVAudioSessionCategoryOptionDuckOthers error:nil]; [[AVAudioSession sharedInstance] setActive:YES error:nil]; æ³¨æ„éœ€è¦åœ¨Xcodeçš„Capabilitiesä¸­å¼€å¯Background Mode æœ‰æ—¶æˆ‘ä»¬è¦æ’­æ”¾Appæ—¶ï¼Œéœ€è¦åˆ¤æ–­å…¶ä»–Appæ˜¯å¦åœ¨ä½¿ç”¨Audioï¼Œè¿™æ—¶å¯é€šè¿‡secondaryAudioShouldBeSilencedHintè¿™ä¸ªå±æ€§æ¥è·å–ï¼Œä¸ºtrueæ—¶è¯´æ˜åœ¨playingã€‚æ®æ­¤é…ç½®AudioSessionå’ŒUIå±‚çš„è¡¨ç° æœ‰ä¸ªæ¯”è¾ƒè›‹ç–¼çš„è®¾å®šæ˜¯ï¼šä½ æ— æ³•ä¸­æ–­å…¶ä»–Mixableçš„éŸ³é¢‘ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœå…¶ä»–Appé…ç½®äº†Mixableï¼Œé‚£ä½ çš„Appæ’­æ”¾çš„éŸ³é¢‘ä¸€å®šä¼šè·Ÿå®ƒæ··æ’­ï¼Œè€Œä¸èƒ½å•ç‹¬æ’­æ”¾ã€‚ AudioSessionçš„é€šçŸ¥ å¸¸ç”¨çš„é€šçŸ¥æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š AudioInterrupt æŒ‡æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘è¢«ä¸­æ–­äº†ï¼Œæ¯”å¦‚ç³»ç»Ÿæ¥ç”µã€é—¹é’Ÿã€å…¶ä»–ä¸å…è®¸ä¸€èµ·æ’­æ”¾çš„Appå¯åŠ¨äº†éŸ³é¢‘æ’­æ”¾ã€‚è¿™ä¸ªæ—¶å€™ä½ Appçš„AudioSessionä¼šè¢«ç³»ç»ŸDeactiveæ‰ï¼Œä¹Ÿå°±é™éŸ³äº†ã€‚ ä»£ç æ¨¡æ¿å¦‚ä¸‹ï¼š - (void)viewDidLoad { [super viewDidLoad]; [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(onAudioInterrupt:) name:AVAudioSessionInterruptionNotification object:nil]; } - (void)onAudioInterrupt:(NSNotification *)notification { NSDictionary *userInfo = [notification userInfo]; NSNumber *value = (NSNumber *)userInfo[AVAudioSessionInterruptionTypeKey]; if ([value intValue] == AVAudioSessionInterruptionTypeBegan) { NSLog(@&quot;interrupt begin&quot;); //ä¿å­˜æ’­æ”¾ä¸Šä¸‹æ–‡ } else if ([value intValue] == AVAudioSessionInterruptionTypeEnded) { NSLog(@&quot;interrupt end&quot;); //æ ¹æ®æƒ…å†µçœ‹çœ‹æ˜¯å¦æ¢å¤æ’­æ”¾ } } å½“ç„¶ï¼Œä½ å¯ä»¥åœ¨ä¸­æ–­å¼€å§‹çš„æ—¶å€™åˆæ¢å¤æ’­æ”¾ï¼Œæœ‰æœºä¼šæŠŠå…¶ä»–Appæš‚åœæ‰ğŸ˜œï¼Œä½¿å¾—æœ‰ä½ Appåœ¨å…¶ä»–Appå°±ä¸èƒ½æ’­æ”¾ï¼Œä¸è¿‡ç›¸ä¿¡ä½ ä¼šè¢«ç”¨æˆ·æŠ•è¯‰çš„ã€‚ RouteChange ç”¨æˆ·æ’æ‹”è€³æœºï¼Œä½¿å¾—è¾“å…¥è¾“å‡ºéŸ³é¢‘è®¾å¤‡æœ‰å˜åŒ–æ—¶è§¦å‘è¯¥é€šçŸ¥ã€‚ç³»ç»Ÿéµå¾ªLast in winsåŸåˆ™ï¼Œoutputçš„è®¾å¤‡æ˜¯æœ€åæ’å…¥çš„ï¼Œä¸”æœ‰ä»¥ä¸‹è¡¨ç°ï¼šï¼ˆæœ‰æ—¶æ‹¿ä¸‹è€³æœºå£°éŸ³è¿˜åœ¨ï¼Œè¯¡å¼‚ã€‚ã€‚ï¼‰ ä»£ç æ¨¡æ¿ï¼š - (void)viewDidLoad { [super viewDidLoad]; [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(onRouteChange:) name:AVAudioSessionRouteChangeNotification object:nil]; } - (void)onRouteChange:(NSNotification *)notification { NSLog(@&quot;routeChange&quot;); NSDictionary *userInfo = notification.userInfo; NSNumber *value = userInfo[AVAudioSessionRouteChangeReasonKey]; if ([value intValue] == AVAudioSessionRouteChangeReasonNewDeviceAvailable) { NSLog(@&quot;new device in&quot;); //éå†[AVAudioSession sharedInstance].currentRoute.outputsï¼Œçœ‹çœ‹æ˜¯ä»€ä¹ˆæ¥å…¥ } else if ([value intValue] == AVAudioSessionRouteChangeReasonOldDeviceUnavailable) { NSLog(@&quot;old device remove&quot;); AVAudioSessionRouteDescription *previousRoute = userInfo[AVAudioSessionRouteChangePreviousRouteKey]; NSLog(@&quot;previous: %@&quot;, previousRoute); NSLog(@&quot;current: %@&quot;, [AVAudioSession sharedInstance].currentRoute); } } é…ç½®éŸ³é¢‘è®¾å¤‡å‚æ•° ä¸»è¦æœ‰å‡ ä¸ª setPreferredSampleRateï¼šè®¾ç½®é‡‡æ ·ç‡ï¼ˆä½†æœ€ç»ˆç³»ç»Ÿé‡‡ç”¨çš„ä¸ä¸€å®šæ˜¯è¿™ä¸ªï¼‰ setPreferredIOBufferDurationï¼šæ—¶é—´è¶Šå°å»¶è¿Ÿè¶Šä½ï¼Œä½†æ˜¯I/Oä¼šæ›´é¢‘ç¹ setPreferredInputï¼šè®¾ç½®è¾“å…¥ ... ä»£åŠ å–ä¸‹ä¸€åªè€³æœºï¼ŒéŸ³ä¹æš‚åœ å‚è€ƒèµ„æ–™ https://developer.apple.com/library/archive/documentation/Audio/Conceptual/AudioSessionProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40007875-CH1-SW1 https://mikemikezhu.github.io/dev/2019/02/19/audio-session.html ","link":"https://jayying007.github.io/post/IOSéŸ³é¢‘æŠ€æœ¯ï¼ˆä¸€ï¼‰Audio-Session/"},{"title":"æ•°å­—éŸ³é¢‘æŠ€æœ¯ä»‹ç»","content":"1 å£°éŸ³ éŸ³é¢‘æŠ€æœ¯æ˜¯ä¸ºäº†è®°å½•ã€å­˜å‚¨å’Œå›æ”¾å£°å­¦ç°è±¡æ‰å‘æ˜çš„ï¼Œäº†è§£å£°å­¦ç°è±¡å¯¹å­¦ä¹ æ•°å­—éŸ³é¢‘æ˜¯æœ‰å¾ˆå¤§å¸®åŠ©ã€‚ æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå£°éŸ³æ˜¯ç”±ç‰©ä½“æŒ¯åŠ¨è€Œäº§ç”Ÿçš„ã€‚å½“æ‹æ‰“æŸä¸ªç‰©ä½“æ—¶ï¼Œç‰©ä½“çš„æŒ¯åŠ¨å¼•èµ·ç©ºæ°”åˆ†å­æœ‰èŠ‚å¥çš„æŒ¯åŠ¨ï¼Œä½¿å‘¨å›´çš„ç©ºæ°”äº§ç”Ÿç–å¯†å˜åŒ–ï¼Œå½¢æˆç–å¯†ç›¸é—´çš„çºµæ³¢ï¼Œä»è€Œäº§ç”Ÿå£°æ³¢ã€‚ å£°æ³¢çš„ä¸‰è¦ç´ æ˜¯ï¼šéŸ³è°ƒã€å“åº¦ã€éŸ³è‰²ã€‚ éŸ³è°ƒï¼šåˆç§°é¢‘ç‡ï¼Œé¢‘ç‡é«˜çš„æ³¢é•¿çŸ­ï¼Œäººè€³èƒ½å¬åˆ°çš„é¢‘ç‡èŒƒå›´å¤§æ¦‚ä¸º20Hz~20kHz å“åº¦ï¼šåˆç§°æŒ¯å¹…ï¼Œä»£è¡¨ç€èƒ½é‡çš„å¤§å°ï¼Œå¸¸ç”¨åˆ†è´DBæ¥æè¿°å“åº¦çš„å¤§å° éŸ³è‰²ï¼šæŒ¯åŠ¨çš„ä»‹è´¨ä¸åŒï¼Œæ³¢å½¢ä¹Ÿä¸åŒï¼Œå¬èµ·æ¥è‡ªç„¶ä¸ä¸€æ · ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªç‰©ä½“å‘å‡ºçš„å£°æ³¢é¢‘ç‡éƒ½æ˜¯å›ºå®šçš„ï¼ˆäººçš„å£°å¸¦å¼•èµ·ä¸åŒéƒ¨ä½æŒ¯åŠ¨ï¼Œèƒ½åŒæ—¶äº§ç”Ÿä¸åŒé¢‘ç‡ï¼‰ï¼Œå‡è®¾æˆ‘ä»¬ä»¥ä¸€å®šé¢‘ç‡æ•²å‡»æ¯å­ï¼Œå…¶è¡¨ç°å°†ä¼šæ˜¯ä¸‹é¢è¿™æ ·ï¼šéšç€æ—¶é—´çš„å˜åŒ–ï¼Œå…¶æŒ¯å¹…ä»¥å›ºå®šé¢‘ç‡ä¸Šä¸‹æ³¢åŠ¨ ä¸è¿‡ç°å®ç”Ÿæ´»ä¸­æˆ‘ä»¬å¬åˆ°çš„å£°éŸ³éƒ½æ˜¯å¤šä¸ªå£°æ³¢æ··åˆè€Œæˆçš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™å¼ å›¾ï¼ˆå®é™…å£°éŸ³ä¿¡å·æ˜¯è¿ç»­çš„ï¼Œä¸‹é¢è¿™å¼ å›¾æ˜¯ç¦»æ•£çš„ï¼Œè¿™é‡Œå¿½ç•¥ï¼‰ï¼š æ­¤å¤„æ¥ä¸€ä¸ªğŸ®ğŸºçš„æŠ€æœ¯ï¼šå‚…ç«‹å¶å˜æ¢ï¼Œå®ƒèƒ½å¤Ÿå°†ä¸Šè¿°çš„æ—¶åŸŸå›¾è½¬ä¸ºé¢‘åŸŸå›¾ã€‚ åœ¨é¢‘åŸŸå›¾ä¸‹æˆ‘ä»¬å¯ä»¥å¯¹ç‰¹å®šé¢‘ç‡åšå¤„ç†ï¼Œç„¶åå†å˜æ¢å›å»ï¼Œä»è€Œè¾¾åˆ°å¯¹éŸ³é¢‘çš„ç‰¹æ®Šå¤„ç†ã€‚ é¢˜å¤–è¯ğŸ¤” äººçš„å£°å¸¦å¼•èµ·ä¸åŒéƒ¨ä½æŒ¯åŠ¨ï¼Œèƒ½åŒæ—¶äº§ç”Ÿä¸åŒé¢‘ç‡ã€‚ æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€ç‚¹æ˜¯ä¸»åŠ¨é™å™ªè€³æœºï¼Œé€šè¿‡äº§ç”Ÿä¸€ä¸ªè·Ÿå¤–ç•Œå£°éŸ³ç›¸ä½ç›¸åçš„éŸ³é¢‘ï¼Œä½¿å£°éŸ³æŠµæ¶ˆäº†ã€‚ https://vdn1.vzuu.com/SD/56bfedde-1f57-11eb-abed-422f8ef9d330.mp4?disable_local_cache=1&amp;auth_key=1639326243-0-0-5b107e55ec782294b920c439212d28e1&amp;f=mp4&amp;bu=pico&amp;expiration=1639326243&amp;v=hw 2 æ•°å­—éŸ³é¢‘çš„é‡‡é›† ä¸»è¦æ¶‰åŠå°†æ¨¡æ‹Ÿä¿¡å·è½¬ä¸ºæ•°å­—ä¿¡å·ï¼Œè¿™ä¸ªæ¦‚å¿µåœ¨è®¡ç®—æœºç½‘ç»œä¸­åŒæ ·æœ‰ä»‹ç»åˆ°ã€‚ä¸»è¦è¿‡ç¨‹æœ‰ï¼šé‡‡æ ·ã€é‡åŒ–ã€ç¼–ç ã€‚ é‡‡æ ·ï¼šåœ¨æ—¶é—´è½´ä¸Šå¯¹ä¿¡å·è¿›è¡Œæ•°å­—åŒ–ï¼Œæ¯”å¦‚æ¯éš”0.01sé‡‡é›†ä¸€æ¬¡ï¼Œæ­¤æ—¶é‡‡æ ·é¢‘ç‡ä¸º 1/0.01 = 100Hz é‡åŒ–ï¼šåœ¨æŒ¯å¹…è½´ä¸Šå¯¹ä¿¡å·è¿›è¡Œæ•°å­—åŒ–ï¼Œæ¯”å¦‚ç”¨16bitæ¥è¡¨ç¤ºä¸€ä¸ªé‡‡æ ·ï¼Œåˆ™æŒ¯å¹…èŒƒå›´å¯ä»¥åˆ†ä¸º65536å±‚ ç¼–ç ï¼šé‡‡é›†åˆ°çš„æ•°æ®å¦‚ä½•å­˜å‚¨ï¼Œæ˜¯é¡ºåºå­˜å‚¨è¿˜æ˜¯å‹ç¼©å­˜å‚¨ï¼Œå–å†³äºä½ é‡‡ç”¨çš„ç¼–ç æ ¼å¼ï¼Œæ¯”å¦‚å¸¸è§çš„wavã€mp3ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œé‡‡é›†åˆ°çš„éŸ³é¢‘è£¸æ•°æ®éƒ½æ˜¯å¾ˆå¤§çš„ï¼Œéœ€è¦é‡‡ç”¨åˆé€‚çš„éŸ³é¢‘å‹ç¼©æŠ€æœ¯å‡å°å…¶å¤§å°ã€‚ 3 æ•°å­—éŸ³é¢‘çš„è¡¨ç¤º è„‰å†²è°ƒåˆ¶ç¼–ç ï¼ˆPluse Code Modulationï¼ŒPCMï¼‰ï¼Œæ˜¯ä½¿ç”¨æœ€å¤šçš„æ— å‹ç¼©éŸ³é¢‘æ ¼å¼ï¼Œå…¶å®å°±æ˜¯ä¸Šä¸€èŠ‚å£°éŸ³é‡‡é›†åˆ°çš„è£¸æ•°æ®ã€‚ æè¿°ä¸€æ®µPCMæ•°æ®é€šå¸¸éœ€è¦ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µï¼š é‡‡æ ·ç‡ï¼ˆSampleRateï¼‰ï¼šåœ¨å‰é¢æœ‰æåˆ° å£°é“æ•°ï¼ˆChannelï¼‰ï¼šå¸¸è§çš„å°±æ˜¯å•å£°é“æˆ–è€…ç«‹ä½“å£°é“ ä½æ·±åº¦ï¼ˆDepthï¼‰ï¼šå‰é¢æåˆ°çš„é‡åŒ– æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—ä¸€æ®µPCMéŸ³é¢‘1sä¼šäº§ç”Ÿå¤šå°‘æ•°æ®ï¼Œæˆ–è€…çŸ¥é“æ€»å¤§å°åæ¨PCMéŸ³é¢‘çš„æ—¶é•¿ã€‚ æ¯”å¦‚CDçš„éŸ³è´¨ï¼šé‡‡æ ·ç‡44100ï¼ŒåŒå£°é“ï¼Œ16bitæ·±åº¦ï¼Œåˆ™1ç§’äº§ç”Ÿçš„æ•°æ®å¤§å°ä¸ºï¼š1 * 44100 * 2 * 16 = 1411200ï¼ˆbitï¼‰ = 176400ï¼ˆbytesï¼‰ = 172.3KB é™¤äº†ä¸Šé¢å‡ ä¸ªå¤–ï¼Œæè¿°éŸ³é¢‘æ•°æ®çš„è¿˜æœ‰ä¸‹é¢å‡ ä¸ªæœ¯è¯­ï¼š æ ·æœ¬ï¼ˆSampleï¼‰ï¼šä»£è¡¨é‡‡é›†åˆ°çš„ä¸€æ¡é€šé“çš„æ•°æ® å¸§ï¼ˆFrameï¼‰ï¼šæŸä¸€æ—¶åˆ»æ‰€æœ‰Sampleçš„é›†åˆï¼Œæ¯”å¦‚ç«‹ä½“å£°ä¸‹ï¼Œä¸€ä¸ªFrameåŒ…å«ä¸¤ä¸ªSamleï¼Œåˆ†åˆ«ä¸ºå·¦å£°é“å’Œå³å£°é“çš„ åŒ…ï¼ˆPacketï¼‰ï¼šä¸€ä¸ªæˆ–å¤šä¸ªè¿ç»­çš„Frameï¼Œåœ¨linear PCMä¸‹ï¼Œä¸€ä¸ªPacketæ€»æ˜¯å¯¹åº”ä¸€ä¸ªFrameã€‚å…¶ä»–å‹ç¼©çš„éŸ³é¢‘æ ¼å¼ï¼Œä¸€ä¸ªPacketåˆ™å¯èƒ½å¯¹åº”å¤šä¸ªFrameã€‚ä¸€ä¸ªPacketæ˜¯ä¸€ç»„å…·æœ‰æ„ä¹‰çš„æœ€å°‘Framesçš„é›†åˆï¼ˆå°±å¥½åƒä¸€ç»„æ–¹ç¨‹å¼ï¼Œåªæœ‰å®ƒä»¬åœ¨ä¸€èµ·æ‰èƒ½å¾—å‡ºå”¯ä¸€è§£ï¼‰ å‚è€ƒèµ„æ–™ å£°æ³¢çš„æ¦‚å¿µ https://www.bilibili.com/video/BV1Zq4y1u7Lq?from=search&amp;seid=6426463179542804956&amp;spm_id_from=333.337.0.0 åŸºç¡€ä¹è°±ğŸ¼çŸ¥è¯† https://www.lightnote.co/ äººæ˜¯æ€ä¹ˆæ„ŸçŸ¥å£°éŸ³é¢‘ç‡é«˜ä½çš„ï¼Ÿ https://www.zhihu.com/question/307507978/answer/563839879 å‚…ç«‹å¶å˜æ¢ https://www.bilibili.com/video/BV1A4411Y7vj?spm_id_from=333.999.0.0 ","link":"https://jayying007.github.io/post/æ•°å­—éŸ³é¢‘æŠ€æœ¯ä»‹ç»/"},{"title":"IOS15å¯¼èˆªæ é€æ˜çš„é—®é¢˜","content":"æè¿° å½“æˆ‘å†™ä¸Šä»¥ä¸‹ä»£ç æ—¶ï¼Œå¯¼èˆªæ çœ‹èµ·æ¥å°±æ˜¯é€æ˜çš„ @interface ViewController () &lt;UITableViewDataSource&gt; @end @implementation ViewController - (void)viewWillAppear:(BOOL)animated { self.navigationController.navigationBar.backgroundColor = UIColor.redColor; } - (void)viewDidLoad { [super viewDidLoad]; self.title = @&quot;Title&quot;; UITableView *tableView = [[UITableView alloc] initWithFrame:self.view.bounds]; tableView.backgroundColor = UIColor.lightGrayColor; tableView.dataSource = self; [self.view addSubview:tableView]; } - (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section { return 2; } - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath { UITableViewCell *cell = [[UITableViewCell alloc] init]; cell.textLabel.text = [NSString stringWithFormat:@&quot;%ld&quot;, indexPath.row]; return cell; } @end åªæœ‰å½“æˆ‘æ»šåŠ¨tableViewæ—¶ï¼Œå¯¼èˆªæ æ‰ä¼šå‡ºç°ã€‚ è§£å†³æ–¹æ³• - (void)viewWillAppear:(BOOL)animated { if (@available(iOS 13.0, *)) { UINavigationBarAppearance *appearance = [[UINavigationBarAppearance alloc] init]; [appearance configureWithOpaqueBackground]; appearance.backgroundColor = UIColor.redColor; self.navigationController.navigationBar.standardAppearance = appearance; self.navigationController.navigationBar.scrollEdgeAppearance = appearance; } else { self.navigationController.navigationBar.backgroundColor = UIColor.redColor; } } å…¶ä»– è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„å°±æ˜¯æ˜¾ç¤ºoréšè—å¯¼èˆªæ åº•éƒ¨çš„é‚£æ¡çº¿ ä»£ç ï¼š - (void)viewWillAppear:(BOOL)animated { if (@available(iOS 13.0, *)) { UINavigationBarAppearance *appearance = [[UINavigationBarAppearance alloc] init]; [appearance configureWithOpaqueBackground]; appearance.backgroundColor = UIColor.whiteColor; appearance.shadowColor = UIColor.clearColor; // éšè—çº¿ self.navigationController.navigationBar.standardAppearance = appearance; self.navigationController.navigationBar.scrollEdgeAppearance = appearance; } else { self.navigationController.navigationBar.backgroundColor = UIColor.whiteColor; [self.navigationController.navigationBar setShadowImage:nil]; //éšè—çº¿ } } ","link":"https://jayying007.github.io/post/IOS15å¯¼èˆªæ é€æ˜çš„é—®é¢˜/"},{"title":"IOSä¸­çš„hitTestå’ŒpointInside","content":"äº‹ä»¶å¤„ç†æµç¨‹ 1.å½“ç”¨æˆ·ç‚¹å‡»å±å¹•æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªè§¦æ‘¸äº‹ä»¶ï¼Œç³»ç»Ÿä¼šå°†è¯¥äº‹ä»¶åŠ å…¥åˆ°ä¸€ä¸ªç”±UIApplicationç®¡ç†çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ 2.UIApplicationä¼šä»äº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºæœ€å‰é¢çš„äº‹ä»¶è¿›è¡Œåˆ†å‘ä»¥ä¾¿å¤„ç†ï¼Œé€šå¸¸ï¼Œå…ˆå‘é€äº‹ä»¶ç»™åº”ç”¨ç¨‹åºçš„ä¸»çª—å£(UIWindow) 3.ä¸»çª—å£ä¼šè°ƒç”¨hitTest:withEvent:æ–¹æ³•åœ¨è§†å›¾(UIView)å±‚æ¬¡ç»“æ„ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„UIViewæ¥å¤„ç†è§¦æ‘¸äº‹ä»¶ (hitTest:withEvent:å…¶å®æ˜¯UIViewçš„ä¸€ä¸ªæ–¹æ³•ï¼ŒUIWindowç»§æ‰¿è‡ªUIViewï¼Œå› æ­¤ä¸»çª—å£UIWindowä¹Ÿæ˜¯å±äºè§†å›¾çš„ä¸€ç§) è¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æè¿° @interface JJView : UIView @property (nonatomic) NSString *viewID; @end @implementation JJView - (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event { NSLog(@&quot;%@:%s&quot;, self.viewID, __func__); if ([self pointInside:point withEvent:event] == NO) { return nil; } NSArray *subviews = self.subviews; for (int i = (int)subviews.count - 1; i &gt;= 0; i--) { UIView *view = subviews[i]; CGPoint viewPoint = [view convertPoint:point fromView:self]; UIView *hitSubview = [view hitTest:viewPoint withEvent:event]; if (hitSubview) { return hitSubview; } } return self; } - (BOOL)pointInside:(CGPoint)point withEvent:(UIEvent *)event { NSLog(@&quot;%@:%s&quot;, self.viewID, __func__); return CGRectContainsPoint(self.bounds, point); } @end åº”ç”¨åœºæ™¯ é€šè¿‡åˆç†çš„é‡è½½åœ¨ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å®ç°ä¸€äº›ç‰¹æ®Šçš„æ•ˆæœã€‚ 1. æ‰©å¤§ç‚¹å‡»åŒºåŸŸ @interface JJView : UIView @property (nonatomic) UIEdgeInsets touchInsets; @end @implementation JJView - (BOOL)pointInside:(CGPoint)point withEvent:(UIEvent *)event { CGRect responsibleRect = CGRectMake(-self.touchInsets.left, -self.touchInsets.top, self.frame.size.width + self.touchInsets.left + self.touchInsets.right, self.frame.size.height + self.touchInsets.top + self.touchInsets.bottom); return CGRectContainsPoint(responsibleRect, point); } @end 2. å­Viewè¶…å‡ºçˆ¶Viewéƒ¨åˆ†ä»å¯å“åº” - (BOOL)pointInside:(CGPoint)point withEvent:(UIEvent *)event { for (UIView *view in self.subviews) { if (CGRectContainsPoint(view.frame, point)){ return YES; } } return NO; } ","link":"https://jayying007.github.io/post/IOSä¸­çš„hitTestå’ŒpointInside/"},{"title":"IOSä¸­ä½¿ç”¨HealthKitè·å–æ­¥æ•°ã€è¿åŠ¨è®°å½•ç­‰æ•°æ®","content":"åœ¨IOSä¸­æƒ³è¦è·å–æ­¥æ•°ç­‰ä¿¡æ¯ï¼Œéœ€è¦å€ŸåŠ©HealthKitï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä»æ‰‹æœºçš„å¥åº·Appä¸Šè·å–æ•°æ®ã€‚ åªè¦ç”¨æˆ·æˆæƒäº†ï¼Œä½ çš„Appå°±å¯ä»¥è¯»å–å’Œå†™å…¥æ•°æ®åˆ°å¥åº·Appä¸­ æ¡†æ¶å¯¼å…¥ é¦–å…ˆä½ éœ€è¦å¼•å…¥HealthKitåˆ°ä½ çš„é¡¹ç›®ä¸­ã€‚ æˆæƒæ–‡æ¡ˆ å¦å¤–éœ€è¦åœ¨info.plisté…ç½®ä¸€ä¸‹æˆæƒè¯´æ˜ï¼Œå¦åˆ™è¯·æ±‚æˆæƒæ—¶å°±ä¼šcrashã€‚ Appleæä¾›äº†HKActivityRingViewæ¥ç»˜åˆ¶è¿åŠ¨ç¯ï¼Œä¹‹å‰ä¸çŸ¥é“ï¼Œè¿˜è‡ªå·±ç”»äº†ä¸€ä¸ªğŸ˜“ æ³¨æ„âš ï¸çš„é—®é¢˜ HealthKitåœ¨IOS13ä¸‹æœ‰ä¸€ä¸ªbugï¼Œä¼šå¯¼è‡´crash https://developer.apple.com/forums/thread/693289 è·å–æˆæƒçŠ¶æ€åº”è¯¥åœ¨å­çº¿ç¨‹åšï¼Œå› ä¸ºå…¶å†…éƒ¨ä¼šwait semaphoreï¼Œä¸ç„¶ä¼šå¯¼è‡´å¡é¡¿ ä»£ç å·²åŒæ­¥Github https://github.com/jayying007/ios-kit/tree/master/healthkit HKActivityRingViewçš„è¡¨ç¤ºï¼šåœ¨Appleè‡ªå¸¦çš„å¥èº«Appä¸­ï¼Œæ•°å€¼æ˜¯å‘ä¸‹å–æ•´æ¥è¡¨ç¤ºçš„ï¼Œä½†æ˜¯ç¯çš„ç»˜åˆ¶è¿˜æ˜¯ç”¨åŸæ¥çš„å€¼ï¼ˆæµ®ç‚¹æ•°ï¼‰ æ— æ³•é€šè¿‡ç³»ç»ŸAPIç¡®è®¤ç”¨æˆ·æ˜¯å¦åŒæ„oræ‹’ç»æˆæƒï¼Œåªèƒ½çŸ¥é“ä¹‹å‰æ˜¯å¦å‡ºç°è¿‡å¼¹çª— ","link":"https://jayying007.github.io/post/IOSä¸­ä½¿ç”¨HealthKitè·å–æ­¥æ•°ã€è¿åŠ¨è®°å½•ç­‰æ•°æ®/"},{"title":"UISwitchåœ¨IOS12ä¸‹çš„Bug","content":"é‡ç°æ–¹å¼ åœ¨UISwitchçš„ValueChangeäº‹ä»¶ä¸­ï¼Œä¿®æ”¹UISwitchçš„onå±æ€§ã€‚ ç¤ºä¾‹ä»£ç  @interface ViewController () @property (nonatomic) UISwitch *oSwitch; @end @implementation ViewController - (void)viewDidLoad { [super viewDidLoad]; self.view.backgroundColor = UIColor.whiteColor; _oSwitch = [[UISwitch alloc] initWithFrame:CGRectMake(50, 100, 100, 60)]; [self.view addSubview:_oSwitch]; [_oSwitch addTarget:self action:@selector(valueChange:) forControlEvents:UIControlEventValueChanged]; } - (void)valueChange:(UISwitch *)oSwitch { NSLog(@&quot;change&quot;); oSwitch.on = !oSwitch.on; } @end è¾“å‡ºç»“æœ 2021-12-01 20:21:31.674948+0800 demo-switch[56902:576481] change 2021-12-01 20:21:31.675095+0800 demo-switch[56902:576481] change ç‚¹å‡»å¼€å…³åˆ‡æ¢ï¼Œå¯ä»¥çœ‹åˆ°valueChangeæ–¹æ³•è¢«è°ƒç”¨äº†ä¸¤æ¬¡ï¼ï¼ è§£å†³æ–¹æ³• æŠŠUISwitchä¸­onå±æ€§çš„ä¿®æ”¹æ”¾åˆ°ä¸‹ä¸€ä¸ªRunloopä¸­ - (void)valueChange:(UISwitch *)oSwitch { NSLog(@&quot;change&quot;); dispatch_async(dispatch_get_main_queue(), ^{ oSwitch.on = !oSwitch.on; }); } ","link":"https://jayying007.github.io/post/UISwitchåœ¨IOS12ä¸‹çš„Bug/"},{"title":"OCä¸­çš„é“¾å¼è¯­æ³•","content":"ç‚¹è¯­æ³• 1.åœ¨OCä¸­ï¼Œè®¿é—®å¯¹è±¡çš„propertyæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç‚¹è¯­æ³•çš„æ–¹å¼è®¿é—® 2.è°ƒç”¨æ— å‚æ•°çš„æ–¹æ³•æ—¶ï¼Œä¹Ÿå¯ä½¿ç”¨ç‚¹è¯­æ³•ã€‚ æœ€ç»ˆæ•ˆæœ è¾“å…¥ person.say(@&quot;Hello, World!&quot;).walk(); è¾“å‡º è¿™ä¸ªäººè¯´ï¼šHello, World! ç»•äº†åœ°çƒä¸¤åœˆ è¿™åœ¨å…¶ä»–è¯­è¨€ä¸­æ˜¯å¾ˆå®¹æ˜“å®ç°çš„ï¼Œæ¯”å¦‚C++å’ŒJavaï¼Œå…¶è°ƒç”¨æ–¹æ³•æœ¬èº«å°±æ˜¯é€šè¿‡ç‚¹è¯­æ³•çš„æ–¹å¼è¿›è¡Œï¼Œåªè¦è¿”å›å€¼æ˜¯selfå°±è¡Œã€‚ OCå¦‚ä½•å®ç°è¿™ç§æ•ˆæœ ç­”æ¡ˆæ˜¯å€ŸåŠ©Blockã€‚ æ‹¿ä¸Šé¢çš„ä»£ç è¿›è¡Œæ‹†åˆ†ï¼š person.say(@&quot;Hello, World!&quot;).walk(); å‰åŠæ®µperson.sayå¯ä»¥ç†è§£ä¸ºè°ƒç”¨äº†æ— å‚æ•°çš„sayæ–¹æ³•ï¼Œè€Œåé¢è¿˜æœ‰å°æ‹¬å·å’Œå‚æ•°(@&quot;Hello, World!&quot;)ã€‚é‚£åªè¦sayæ–¹æ³•è¿”å›ä¸€ä¸ªBlockï¼Œè¿™ä¸ªBlockéœ€è¦ä¸€ä¸ªæ‰§è¡Œå‚æ•°å³å¯ã€‚ç›¸å½“äºå‰åŠæ®µä»£ç æ‰§è¡Œäº†è¿™ä¸ªBlockã€‚ è€Œåé¢è¿˜éœ€è¦è°ƒç”¨walkæ–¹æ³•ï¼Œåˆ™éœ€è¦è¿™ä¸ªBlockè¿”å›å¯¹è±¡æœ¬èº«ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒååŠæ®µæ˜¯.walk()è€Œä¸æ˜¯.walkï¼Œåè€…æ‰§è¡Œæ‰§è¡Œäº†walkæ–¹æ³•ï¼Œä½†å´æ²¡æœ‰æ‰§è¡Œå¯¹åº”è¿”å›çš„Blockã€‚ ä»£ç ç¤ºä¾‹ #import &lt;Foundation/Foundation.h&gt; @class Person; typedef Person* (^Sayback)(NSString *); typedef Person* (^Walkback)(void); @interface Person : NSObject - (Sayback)say; - (Walkback)walk; @end #import &quot;Person.h&quot; @implementation Person - (Sayback)say { return ^Person *(NSString *word) { NSLog(@&quot;è¿™ä¸ªäººè¯´ï¼š%@&quot;, word); return self; }; } - (Walkback)walk { return ^Person *() { NSLog(@&quot;ç»•äº†åœ°çƒä¸¤åœˆ&quot;); return self; }; } @end æ€»ç»“ é“¾å¼è¯­æ³•è®©ä»£ç å†™å¾—æ›´ç®€æ´äº†ï¼Œä½†æ˜¯å…¶è°ƒç”¨æ¬¡æ•°ä¹Ÿç¿»å€äº† åŸå…ˆæ˜¯ç›´æ¥è°ƒç”¨æ–¹æ³•ï¼Œç°åœ¨å˜æˆè°ƒç”¨æ–¹æ³•ä¼šè¿”å›Blockï¼Œç„¶åå†æ‰§è¡Œè¿™ä¸ªBlock åœ¨Java8ä¸­å‡ºç°äº†æµå¼ç¼–ç¨‹Java Streamï¼Œå¯å°†ä»£ç å†™å¾—å¾ˆç²¾è‡´ï¼Œå¦‚ä¸‹é¢æ‰€ç¤ºï¼Œä¹Ÿå¥½å¥‡ğŸ¤”OCèƒ½å¦ä¹Ÿå®ç°è¿™ç§æ•ˆæœ Stream.of(&quot;apple&quot;, &quot;banana&quot;, &quot;orange&quot;, &quot;waltermaleon&quot;, &quot;grape&quot;) .mapToInt(e -&gt; e.length()) //è½¬æˆint .forEach(e -&gt; System.out.println(e)); Stream.of(1,2,3,1,2,5,6,7,8,0,0,1,2,3,1) .filter(e-&gt;e&gt;=5) //è¿‡æ»¤å°äº5çš„ .forEach(e-&gt;System.out.println(e)); ","link":"https://jayying007.github.io/post/OCä¸­çš„é“¾å¼è¯­æ³•/"},{"title":"Objective-Cä¸­çš„blockè¯­æ³•","content":"Objective-Cä¸­çš„blockè¯­æ³• å‰è¨€ ä¹‹å‰å­¦ä¹ Obj-Cçš„æ—¶å€™ï¼Œçœ‹è¿‡ã€ŠObjective-Cé«˜çº§ç¼–ç¨‹ã€‹ï¼Œæ˜¯ä¸­æ–‡ç¿»è¯‘ç‰ˆçš„ï¼Œè¯»èµ·æ¥æ€»æ„Ÿè§‰å°‘äº†äº›å‘³é“ã€‚ ä¸è¿‡ä½œè€…æ˜¯æ—¥æœ¬çš„ï¼ŒåŸç‰ˆæ—¥æ–‡æˆ‘æ›´çœ‹ä¸æ‡‚ï¼Œå¹¸å¥½è‹±æ–‡ç‰ˆçš„ç¿»è¯‘å¥½äº†å¾ˆå¤šï¼Œè€Œä¸”è‹±è¯­å…­çº§ä¹Ÿè¿‡äº†ğŸ¶ï¼Œè¿™æ¬¡çœ‹å¾—ä¸‹å»ã€‚Blockçš„çŸ¥è¯†åœ¨ç¬¬å››ç« å’Œç¬¬äº”ç« ã€‚ æœ¬ç¯‡æ–‡ç« å¤§éƒ¨åˆ†å›¾ç‰‡ä¹Ÿæ˜¯ä»é‡Œé¢æ‘˜è¿‡æ¥çš„ã€‚ Blockç®€ä»‹ ç®€å•å›é¡¾ä¸€ä¸‹Blockçš„ç”¨æ³• Blockå¯ä»¥ç®—æ˜¯å¯¹Cè¯­è¨€è¯­æ³•çš„ä¸€ç§æ‰©å±•ï¼Œå€ŸåŠ©ç»“æ„ä½“å’Œå‡½æ•°æŒ‡é’ˆçš„æŠ€æœ¯å³å¯å®ç°ã€‚å¦‚æœä½ å¯¹å‡½æ•°æŒ‡é’ˆæ¯”è¾ƒç†Ÿæ‚‰ï¼Œé‚£ä½ å¾ˆå®¹æ˜“ç†è§£Blockã€‚ä¸è¿‡è·Ÿå‡½æ•°æŒ‡é’ˆç¨å¾®æœ‰äº›åŒºåˆ«ï¼Œå‡½æ•°æŒ‡é’ˆéœ€è¦å¯¹åº”å‡½æ•°çš„å‡½æ•°åï¼Œä½†æ˜¯Blockä¸éœ€è¦ï¼Œå®ƒåªè¦ä¸€ä¸ªåŒ¿åå‡½æ•°å³å¯ã€‚ åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥çœ‹ä»£ç ï¼š int main() { (void)(^blk_t)(void) = ^void (void) { printf(&quot;Hello world.&quot;); }; } è¿™é‡Œçš„blk_tå°±æ˜¯å­˜æ”¾Blockçš„å˜é‡ï¼Œé€šè¿‡blk_t()å°±å¯ä»¥æ‰§è¡Œè¿™ä¸ªBlockï¼Œè¾“å‡ºHello worldã€‚å£°æ˜Blockå˜é‡çš„æ–¹å¼è·Ÿå£°æ˜å‡½æ•°æŒ‡é’ˆæœ‰ç‚¹åƒï¼Œçœ‹èµ·æ¥å°±æ˜¯æŠŠ*æ¢æˆäº†^ã€‚Blockçš„åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡æœ‰å‚æ•°åˆ—è¡¨ï¼Œåˆ™å¯ä»¥è¿›ä¸€æ­¥çœç•¥ã€‚ Blockå†…éƒ¨å¯ä»¥ä½¿ç”¨å¤–é¢çš„å±€éƒ¨å˜é‡ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬é™æ€å˜é‡ã€å…¨å±€å˜é‡ç­‰ã€‚ä½†æ˜¯è¿™ä¸ªä½¿ç”¨çš„å˜é‡çš„å€¼åªæ˜¯åœ¨Blockåˆ›å»ºé‚£ä¸€åˆ»å¤åˆ¶çš„ï¼Œåé¢ä¿®æ”¹æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œè€Œä¸”ä½ ä¹Ÿä¸èƒ½åœ¨Blockå†…éƒ¨å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œä¿®æ”¹ã€‚ int main() { int val = 10; (void)(^blk_t)(void) = ^void (void) { printf(&quot;value is :%d&quot;, val); }; val = 2222; blk_t(); } æ­¤æ—¶è¾“å‡ºä¸ºvalue is 10 è¦æƒ³åœ¨Blockå†…éƒ¨ä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œåªéœ€è¦åœ¨å˜é‡å‰åŠ ä¸Š__blockå³å¯ï¼Œå˜æˆ__block int val = 10;ã€‚æˆ–è€…è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡æŒ‡é’ˆï¼Œå°±å¥½æ¯”è°ƒç”¨å‡½æ•°æ—¶çš„å®å‚å’Œå½¢å‚ï¼Œä¼ çš„å‚æ•°æ˜¯æŒ‡é’ˆå°±å¯ä¿®æ”¹åˆ°å¯¹åº”çš„æ•°å€¼ã€‚ int main() { int val = 10; int *p = &amp;val; (void)(^blk_t)(void) = ^void (void) { *p = 2222; }; printf(&quot;value is :%d&quot;, val); blk_t(); printf(&quot;value is :%d&quot;, val); } æŒ‡é’ˆçš„è¿™ç§æ–¹å¼ï¼Œåªè¦ä½ ä¸åœ¨Blockå†…éƒ¨ä¿®æ”¹å˜é‡pçš„å€¼å°±ä¸ä¼šæŠ¥é”™ï¼Œè‡³äºä¿®æ”¹å˜é‡pæŒ‡å‘çš„å†…å­˜ï¼Œåˆ™æ— æ‰€è°“ã€‚åŒç†å¯å¾—ä¸‹é¢è¿™ç§ä¹Ÿæ˜¯æ­£ç¡®çš„ï¼š int main() { id array = [[NSMutableArray alloc] init]; (void)(^blk_t)(void) = ^void (void) { id obj = [[NSObject alloc] init]; [array addObject:obj]; }; blk_t(); } Blockçš„å®ç°åŸç† å€ŸåŠ©Clangï¼Œæˆ‘ä»¬å¯ä»¥å°†OCçš„ä»£ç è½¬æ¢ä¸ºC++ä»£ç ï¼Œä»è€Œçœ‹åˆ°Blockåœ¨Cå±‚é¢ä¸Šæ˜¯å¦‚ä½•å®ç°çš„ã€‚ clang -rewrite-objc filename.m åé¢å¦‚æœä»£ç å«æœ‰__weakï¼Œåˆ™éœ€è¦è¡¥å……å¤šå‡ ä¸ªå‚æ•° clang -rewrite-objc -fobjc-arc -fobjc-runtime=ios-14.0.0 filename.m ç¬¬ä¸€ç»„ï¼ˆä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œä½†æ˜¯ä¸ä½¿ç”¨__blockï¼‰ æºä»£ç  #import &lt;Foundation/Foundation.h&gt; int main() { int val = 10; void (^blk)(void) = ^ { printf(&quot;val:%d&quot;, val); }; blk(); return 0; } clangè½¬æ¢åçš„ä»£ç ï¼ˆçœç•¥ä¸€äº›æ— å…³çš„ï¼Œéƒ½æ˜¯importå¸¦æ¥çš„ä¸œè¥¿...ï¼‰ struct __block_impl { void *isa; int Flags; int Reserved; void *FuncPtr; }; struct __main_block_impl_0 { struct __block_impl impl; struct __main_block_desc_0* Desc; int val; __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _val, int flags=0) : val(_val) { impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; } }; static void __main_block_func_0(struct __main_block_impl_0 *__cself) { int val = __cself-&gt;val; // bound by copy printf(&quot;val:%d&quot;, val); } static struct __main_block_desc_0 { size_t reserved; size_t Block_size; } __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)}; int main() { int val = 10; void (*blk)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, val)); ((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk); return 0; } ç¬¬ä¸€æ¬¡çœ‹èµ·æ¥ç¡®å®æœ‰ç‚¹å¤´ç–¼ï¼Œä¸è¿‡ä¹¦ä¸­è®²çš„ä¹Ÿæ¯”è¾ƒè¯¦ç»†ï¼Œå¤šçœ‹å‡ éå°±å¥½äº†ã€‚ çœ‹åˆ°ç»“æ„ä½“__main_block_impl_0ï¼Œè¿™å°±æ˜¯Blockåœ¨Cå±‚é¢ä¸‹çš„é¢ç›®äº†ã€‚é‡Œé¢æœ‰ä¸ªå­—æ®µvalï¼Œé€šè¿‡æ„é€ å‡½æ•°ä¼ é€’è¿‡æ¥çš„_valè¿›è¡Œèµ‹å€¼ã€‚ è€ŒåŸæœ¬blockçš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°è¢«æ”¾åˆ°å‡½æ•°__main_block_func_0é‡Œé¢å»äº†ï¼Œè€Œä¸”é‡Œé¢çš„valä¹Ÿä¸æ˜¯åŸå…ˆçš„å±€éƒ¨å˜é‡çš„ï¼Œå°±æ˜¯ç»“æ„ä½“è‡ªå·±çš„å˜é‡è€Œå·²ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆå±€éƒ¨å˜é‡çš„å€¼æ”¹äº†ï¼ŒBlockæ‰§è¡Œçš„è¾“å‡ºç¡®è¿˜æ˜¯ä¹‹å‰çš„ï¼Œå› ä¸ºè¿™å·²ç»æ˜¯ä¸¤ä¸ªä¸åŒçš„å˜é‡äº†ã€‚ ç¬¬äºŒç»„ï¼ˆä½¿ç”¨__blockï¼‰ æºä»£ç  #import &lt;Foundation/Foundation.h&gt; int main() { __block int val = 10; void (^blk)(void) = ^ { val = 222; }; printf(&quot;val:%d&quot;, val); blk(); printf(&quot;val:%d&quot;, val); return 0; } clangè½¬æ¢åçš„ä»£ç  struct __block_impl { void *isa; int Flags; int Reserved; void *FuncPtr; }; struct __Block_byref_val_0 { void *__isa; __Block_byref_val_0 *__forwarding; int __flags; int __size; int val; }; struct __main_block_impl_0 { struct __block_impl impl; struct __main_block_desc_0* Desc; __Block_byref_val_0 *val; // by ref __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, __Block_byref_val_0 *_val, int flags=0) : val(_val-&gt;__forwarding) { impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; } }; static void __main_block_func_0(struct __main_block_impl_0 *__cself) { __Block_byref_val_0 *val = __cself-&gt;val; // bound by ref (val-&gt;__forwarding-&gt;val) = 222; } static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) { _Block_object_assign((void*)&amp;dst-&gt;val, (void*)src-&gt;val, 8/*BLOCK_FIELD_IS_BYREF*/); } static void __main_block_dispose_0(struct __main_block_impl_0*src) { _Block_object_dispose((void*)src-&gt;val, 8/*BLOCK_FIELD_IS_BYREF*/); } static struct __main_block_desc_0 { size_t reserved; size_t Block_size; void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*); void (*dispose)(struct __main_block_impl_0*); } __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0}; int main() { __attribute__((__blocks__(byref))) __Block_byref_val_0 val = {(void*)0,(__Block_byref_val_0 *)&amp;val, 0, sizeof(__Block_byref_val_0), 10}; void (*blk)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_val_0 *)&amp;val, 570425344)); printf(&quot;val:%d&quot;, (val.__forwarding-&gt;val)); ((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk); printf(&quot;val:%d&quot;, (val.__forwarding-&gt;val)); return 0; } ä»£ç åˆå¤æ‚äº†ä¸€äº›ï¼Œå…¶å®ä¸»è¦æ˜¯å¤šäº†ä¸€ä¸ªç»“æ„ä½“__Block_byref_val_0ï¼Œç»†çœ‹è¿™ä¸ªç»“æ„ä½“ï¼Œä½ ä¼šå‘ç°å®ƒè®°å½•äº†ä¹‹å‰å±€éƒ¨å˜é‡çš„å€¼ã€‚æ‰€ä»¥__blockåŸºæœ¬ä¸Šå°±æŠŠå˜é‡åŒ…è£…æˆä¸€ä¸ªç»“æ„ä½“äº†ã€‚ å¯¹valçš„è®¿é—®å°±å˜æˆäº†val.__forwarding-&gt;valï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¸ª__forwarding,è¿™ä¸»è¦å› ä¸ºBlockå¯ä»¥åœ¨æ ˆã€å †ã€å…¨å±€ä¸Šï¼Œå…·ä½“ç»†èŠ‚çœ‹ä¹¦ã€‚ å…³äºBlockå†…éƒ¨å¯¹å˜é‡çš„è¯»å†™ å‰é¢æˆ‘ä»¬çŸ¥é“å¯é€šè¿‡æ·»åŠ __blockå®ç°ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›æƒ…å†µæ˜¯ä¸éœ€è¦çš„ã€‚ æ¯”å¦‚å½“ä½ è¿™ä¸ªå˜é‡æ˜¯å…¨å±€å˜é‡ã€é™æ€å…¨å±€å˜é‡ã€é™æ€å±€éƒ¨å˜é‡ï¼Œä¸éœ€è¦åœ¨å˜é‡åå‰å¢åŠ ä¿®é¥°ç¬¦ä¹Ÿå¯ä»¥è¯»å†™ã€‚ å‰ä¸¤ä¸ªå®¹æ˜“ç†è§£ï¼Œå› ä¸ºBlockæœ€ç»ˆè¿˜æ˜¯è½¬æ¢æˆå‡½æ•°ï¼Œåœ¨å‡½æ•°å†…éƒ¨è®¿é—®å…¨å±€å˜é‡æ˜¯OKçš„ï¼ŒBlockç»“æ„ä½“ä¸ç”¨æ–°å¢ä»€ä¹ˆå­—æ®µï¼› é™æ€å±€éƒ¨å˜é‡åˆ™å¤šäº†äº›å·¥ä½œé‡ï¼Œé€šè¿‡clangè½¬æ¢ä»£ç åï¼Œå‘ç°Blockçš„ç»“æ„ä½“å†…éƒ¨ä¼šæœ‰ä¸€ä¸ªæŒ‡é’ˆå˜é‡æŒ‡å‘è¿™ä¸ªé™æ€å±€éƒ¨å˜é‡ã€‚ å¾ªç¯å¼•ç”¨ å‰é¢æˆ‘ä»¬åœ¨Blockä¸­ç”¨çš„éƒ½æ˜¯ä¸€äº›åŸºç¡€æ•°æ®ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨objectçš„ä¼šæ€æ ·å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯ä¼šé€ æˆå¾ªç¯å¼•ç”¨ã€‚æ¯”å¦‚ä¸‹é¢è¿™ç§å†™æ³• æˆ‘ä»¬çœ‹çœ‹Clangè½¬æ¢åçš„ä»£ç ï¼Œå…¶ä¸­å¸¦ä¸Šäº†__strongæ ‡è®°ï¼Œå¼•ç”¨è®¡æ•°+1 åœ¨å‰é¢åŠ ä¸Š__blockä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯å¼ºå¼•ç”¨ è§£å†³æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ”¹ä¸ºå¼±å¼•ç”¨å³å¯ è¡¥å……ä¸€ å®é™…å¼€å‘ä¸­ä¸€èˆ¬é‡åˆ°çš„æ˜¯ä¸‹é¢è¿™ç§æƒ…å†µï¼Œä¸€ä¸ªObjectå¯¹è±¡æœ‰ä¸€ä¸ªå±æ€§Blockï¼Œç›¸äº’æŒæœ‰ã€‚ æˆ–è€…æŠŠselfç”¨__blockä¿®é¥°ï¼Œå½¢æˆä¸‹é¢è¿™ç§å¾ªç¯å¼•ç”¨ã€‚ è¿™ç§æ¯”è¾ƒæœ‰æ„æ€ï¼Œä½ å¯ä»¥åœ¨Blockå†…éƒ¨ç‰¹å®šæ—¶æœºå°†__block variableé‡Šæ”¾ï¼Œä»è€Œè§£é™¤å¾ªç¯å¼•ç”¨ï¼Œè¿™ç§ç”¨æ³•æ¯”è¾ƒé«˜çº§ã€‚ è¡¥å……äºŒ ä¸€èˆ¬åœ¨Blockå‰ä½¿ç”¨__weakå°±å¯ä»¥äº†ï¼Œä½†æ˜¯å¯¹äºè®¿é—®æˆå‘˜å˜é‡å´è¡Œä¸é€šï¼Œè€Œä¿®æ”¹æˆå‘˜å˜é‡ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡æŒ‡é’ˆæ“ä½œã€‚ __weak typeof(self) weakSelf = self; blk = ^(id obj) { weakSelf.money = 100000; weakSelf-&gt;height = 222; }; è¿™é‡Œç¬¬äºŒå¥weakSelf-&gt;height = 222;ç¼–è¯‘å™¨ä¼šæç¤ºé”™è¯¯ï¼Œå› ä¸ºweakSelfæœ‰å¯èƒ½å˜æˆnilï¼Œä¼šå¯¼è‡´éæ³•çš„å†…å­˜è®¿é—®ã€‚ å¦ä¸€ç§ä¿®æ”¹æˆå‘˜å˜é‡çš„æ–¹æ³•æ˜¯é€šè¿‡__blockçš„æ–¹å¼ ä¹Ÿä¸ºäº†é˜²æ­¢Blockæ‰§è¡Œè¿‡ç¨‹ä¸­selfçªç„¶é‡Šæ”¾äº†ï¼Œåœ¨Blockä¸­ä¸€èˆ¬ä¼šå…ˆå¼ºå¼•ç”¨ä¸€ä¸‹selfï¼Œè€Œç¦»å¼€äº†Blockä½œç”¨åŸŸï¼Œå¼ºå¼•ç”¨è‡ªç„¶æ¶ˆå¤±äº†ï¼› __weak typeof(self) weakSelf = self; blk = ^(id obj) { __strong typeof(self) strongSelf = weakSelf; strongSelf.money = 100000; strongSelf-&gt;height = 222; }; ä¸è¿‡ä¸Šé¢è¿™ç§ä¹Ÿæœ‰ä¸€å®šæ¦‚ç‡crashï¼Œå³æœ‰å¯èƒ½strongSelfæ˜¯nilï¼› æ¯”å¦‚å½“Blockæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡çš„æ—¶å€™ï¼Œè€ŒObjectç”Ÿå‘½å‘¨æœŸå…ˆç»“æŸå˜æˆnilï¼Œæ­¤æ—¶å†æ‰§è¡ŒBlockå°±ä¼šcrashã€‚å¦‚æœBlockæ˜¯Objectçš„ä¸€ä¸ªå±æ€§æˆ–æˆå‘˜å˜é‡ï¼Œä¹Ÿä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚ å¦å¤–ï¼Œåœ¨å¼€å‘ä¸­ä¸€èˆ¬ä¹Ÿä¸ä¼šå»å†™è¿™ä¹ˆé•¿çš„weakSelfå’ŒstrongSelfï¼Œæˆ‘ä»¬æ˜¯å¸Œæœ›ç›´æ¥ç”¨selfã€‚(æ¯”å¦‚ä½ çµæœºä¸€åŠ¨ï¼Œæƒ³ä»å…¶ä»–åœ°æ–¹copyä¸€ä»½ä»£ç ç›´æ¥æ”¾åˆ°Blockï¼Œç»“æœå‘ç°å¾—ä¸€æ­¥æ­¥æŠŠselfæ›¿æ¢æˆstrongSelfï¼Œè¿‡ç¨‹ç›¸å½“ç—›è‹¦ğŸ˜–) è¿™éƒ¨åˆ†å†…å®¹RACæœ‰ç›¸å…³çš„å®ç°ï¼Œé€šè¿‡@weakify(self)å’Œ@strongify(self)ã€‚è¿™é‡Œæˆ‘ç®€åŒ–äº†ä¸€ä¸‹å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š #define weakify(VAR) __weak typeof(VAR) _weak_ = VAR; #define strongify(VAR) __strong typeof(VAR) VAR = _weak_; //ä½¿ç”¨å®å®šä¹‰åçš„æ•ˆæœ weakify(self); blk = ^(id obj) { strongify(self); self.money = 100000; self-&gt;height = 222; }; ","link":"https://jayying007.github.io/post/Objective-Cä¸­çš„blockè¯­æ³•/"},{"title":"iosæ’­æ”¾åŠ¨æ€å›¾","content":"é¡¹ç›®ä¸­å¶å°”ä¼šéœ€è¦æ’­æ”¾åŠ¨æ€å›¾ç‰‡ï¼Œæ¯”å¦‚ä¸€äº›åŠ¨æ€çš„è¡¨æƒ…åŒ…ã€‚å¸¸è§çš„åŠ¨æ€å›¾æ ¼å¼å¤§å®¶å¯èƒ½éƒ½çŸ¥é“Gifï¼Œä½†å…¶å®è¿˜æœ‰ä¸€ä¸ªAPNGæ ¼å¼ä¹Ÿæ˜¯åŠ¨æ€çš„ï¼Œè¿™ä¹Ÿæ˜¯è®¾è®¡å¸ˆç»™æˆ‘è®¾è®¡ç¨¿æ—¶æˆ‘æ‰çŸ¥é“æœ‰è¿™ç§æ ¼å¼çš„åŠ¨æ€å›¾ã€‚ é—®é¢˜ IOSè‡ªå¸¦çš„ImageViewå¹¶ä¸èƒ½æ’­æ”¾åŠ¨æ€å›¾ï¼Œå®ƒåªä¼šæ˜¾ç¤ºç¬¬ä¸€å¸§ ImageViewæœ‰ä¸ªæ–¹æ³•setAnimationImagesï¼Œç¡®å®èƒ½æ’­æ”¾å›¾ç‰‡ã€‚ä½†æ³¨æ„è¿™é‡ŒGIFå’ŒAPNGéƒ½æ˜¯å•å¼ å›¾ç‰‡ï¼Œæ‰€ä»¥ImageViewå¹¶ä¸é€‚ç”¨ã€‚ - (void)loadData { NSString *gifPath = [[NSBundle mainBundle] pathForResource:@&quot;1.gif&quot; ofType:nil]; self.gifData = [NSData dataWithContentsOfFile:gifPath]; NSString *apngPath = [[NSBundle mainBundle] pathForResource:@&quot;2.png&quot; ofType:nil]; self.apngData = [NSData dataWithContentsOfFile:apngPath]; } - (void)showWithImageView { UILabel *label = [[UILabel alloc] initWithFrame:CGRectMake(10, 150, 100, 40)]; label.text = @&quot;UIImageView&quot;; [self.view addSubview:label]; UIImageView *gifImageView = [[UIImageView alloc] initWithFrame:CGRectMake(120, 100, 100, 100)]; gifImageView.image = [UIImage imageWithData:self.gifData]; [self.view addSubview:gifImageView]; UILabel *gifLabel = [[UILabel alloc] initWithFrame:CGRectMake(160, 200, 100, 40)]; gifLabel.text = @&quot;Gif&quot;; [self.view addSubview:gifLabel]; UIImageView *apngImageView = [[UIImageView alloc] initWithFrame:CGRectMake(240, 100, 100, 100)]; apngImageView.image = [UIImage imageWithData:self.apngData]; [self.view addSubview:apngImageView]; UILabel *apngLabel = [[UILabel alloc] initWithFrame:CGRectMake(280, 200, 100, 40)]; apngLabel.text = @&quot;Apng&quot;; [self.view addSubview:apngLabel]; } æ–¹æ³•ä¸€ ä½¿ç”¨WebViewå±•ç¤ºï¼ŒåŸºæœ¬ä¸Šåªè¦ä½ çš„æµè§ˆå™¨èƒ½æ’­æ”¾åŠ¨æ€å›¾ï¼Œä½¿ç”¨WebViewä¹Ÿå°±èƒ½æ˜¾ç¤ºäº†ï¼Œä½†å¥½åƒæ— æ³•æ”¹å˜å›¾ç‰‡å¤§å° - (void)showWithWebView { UILabel *label = [[UILabel alloc] initWithFrame:CGRectMake(10, 270, 100, 40)]; label.text = @&quot;WKWebView&quot;; [self.view addSubview:label]; WKWebView *gifWebView = [[WKWebView alloc] initWithFrame:CGRectMake(120, 270, 100, 100)]; [gifWebView loadData:self.gifData MIMEType:@&quot;image/gif&quot; characterEncodingName:@&quot;UTF-8&quot; baseURL:nil]; [self.view addSubview:gifWebView]; UILabel *gifLabel = [[UILabel alloc] initWithFrame:CGRectMake(160, 320, 100, 40)]; gifLabel.text = @&quot;Gif&quot;; [self.view addSubview:gifLabel]; WKWebView *apngWebView = [[WKWebView alloc] initWithFrame:CGRectMake(240, 270, 100, 100)]; [apngWebView loadData:self.apngData MIMEType:@&quot;image/png&quot; characterEncodingName:@&quot;UTF-8&quot; baseURL:nil]; [self.view addSubview:apngWebView]; UILabel *apngLabel = [[UILabel alloc] initWithFrame:CGRectMake(280, 320, 100, 40)]; apngLabel.text = @&quot;Apng&quot;; [self.view addSubview:apngLabel]; } æ–¹æ³•äºŒ å€ŸåŠ©ImageIOçš„APIæ¥å£ï¼Œæˆ‘ä»¬è‡ªå·±å°è£…ä¸€ä¸ªAnimateImageViewã€‚è¿™é‡Œæˆ‘ä»¬æ—¢èƒ½è°ƒæ•´å›¾ç‰‡å¤§å°ï¼Œä¹Ÿèƒ½é€šè¿‡å‚æ•°æ§åˆ¶æ’­æ”¾é€Ÿåº¦ç­‰ï¼Œéå¸¸çµæ´»ã€‚ AnimateImageView.h // // AnimateImageView.h // demo-image // // Created by jieying zhuang on 2021/9/5. // #import &lt;UIKit/UIKit.h&gt; NS_ASSUME_NONNULL_BEGIN @interface AnimateImageView : UIImageView - (instancetype)initWithData:(NSData *)data; - (void)startPlay; //å›åˆ°ç¬¬ä¸€å¸§ - (void)stopPlay; @end NS_ASSUME_NONNULL_END AnimateImageView.m // // AnimateImageView.m // demo-image // // Created by jieying zhuang on 2021/9/5. // #import &quot;AnimateImageView.h&quot; #import &lt;ImageIO/CGImageAnimation.h&gt; /** å¯ä»¥ç”¨æ¥æ˜¾ç¤ºGifï¼ŒAPngè¿™ç±»åŠ¨æ€å›¾ï¼› é™åˆ¶ï¼šIOS13.0åŠä»¥ä¸Š */ @interface AnimateImageView () @property (nonatomic, strong) UIImage *firstFrameImage; @property (nonatomic, strong) NSData *data; @property (nonatomic) NSUInteger beginningFrameIndex; //ä»å“ªä¸€å¸§å¼€å§‹ @property (nonatomic) CGFloat delayPerFrame; //æ¯ä¸€å¸§æ’­æ”¾æ—¶é•¿ @property (nonatomic) NSUInteger loopCount; //å¾ªç¯æ¬¡æ•° @property (nonatomic) BOOL stopPlayback; //æ˜¯å¦åœæ­¢æ’­æ”¾ @end @implementation AnimateImageView - (instancetype)initWithData:(NSData *)data { if ([super init]) { self.firstFrameImage = [UIImage imageWithData:data]; self.data = data; self.beginningFrameIndex = 0; self.delayPerFrame = 0.04f; self.loopCount = 0; self.stopPlayback = NO; self.image = self.firstFrameImage; } return self; } - (void)startPlay { self.stopPlayback = NO; [self startAnimateImage]; } - (void)stopPlay { self.stopPlayback = YES; } #pragma mark - Private - (void)startAnimateImage { __weak typeof(self) weakSelf = self; NSDictionary *options = [self animationOptionsDictionary]; if (@available(iOS 13.0, *)) { CGAnimateImageDataWithBlock((CFDataRef)self.data, (CFDictionaryRef)options, ^(size_t index, CGImageRef _Nonnull image, bool *_Nonnull stop) { *stop = weakSelf.stopPlayback; if (weakSelf.stopPlayback) { weakSelf.image = weakSelf.firstFrameImage; } else { weakSelf.image = [UIImage imageWithCGImage:image]; } }); } } - (NSDictionary *)animationOptionsDictionary { NSMutableDictionary&lt;NSString *, NSNumber *&gt; *options = [NSMutableDictionary new]; if (@available(iOS 13.0, *)) { [options addEntriesFromDictionary:@{ (NSString *)kCGImageAnimationStartIndex : @(self.beginningFrameIndex), (NSString *)kCGImageAnimationDelayTime : @(self.delayPerFrame) }]; if (self.loopCount &gt; 0) { options[(NSString *)kCGImageAnimationLoopCount] = @(self.loopCount); } } return [options copy]; } @end ä½¿ç”¨æ–¹æ³• - (void)showAnimateImageView { UILabel *label = [[UILabel alloc] initWithFrame:CGRectMake(10, 450, 150, 40)]; label.text = @&quot;AnimateImageView&quot;; [self.view addSubview:label]; AnimateImageView *gifImageView = [[AnimateImageView alloc] initWithData:self.gifData]; gifImageView.frame = CGRectMake(160, 400, 100, 100); [gifImageView startPlay]; [self.view addSubview:gifImageView]; UILabel *gifLabel = [[UILabel alloc] initWithFrame:CGRectMake(200, 520, 100, 40)]; gifLabel.text = @&quot;Gif&quot;; [self.view addSubview:gifLabel]; AnimateImageView *apngImageView = [[AnimateImageView alloc] initWithData:self.apngData]; apngImageView.frame = CGRectMake(270, 400, 100, 100); [apngImageView startPlay]; [self.view addSubview:apngImageView]; UILabel *apngLabel = [[UILabel alloc] initWithFrame:CGRectMake(310, 520, 100, 40)]; apngLabel.text = @&quot;Apng&quot;; [self.view addSubview:apngLabel]; } å‚è€ƒèµ„æ–™ https://www.swiftjectivec.com/animating-images-using-image-io/ ","link":"https://jayying007.github.io/post/iosæ’­æ”¾åŠ¨æ€å›¾/"},{"title":"iosè‡ªå®šä¹‰è½¬åœºåŠ¨ç”»","content":"æœ€è¿‘å·¥ä½œéœ€è¦å¯¹è½¬åœºæ—¶å¯¼èˆªæ åšæ ·å¼å˜åŒ–ï¼Œåœ¨ç½‘ä¸Šæ‰¾åˆ°ä¸€ä¸ªå¯¹äºè½¬åœºæ¥è¯´ä¸é”™çš„æ•™ç¨‹ã€‚ åŸæ–‡é“¾æ¥ï¼šhttps://www.jianshu.com/p/28b9523d70a9 ä»¥ä¸‹å¤§éƒ¨åˆ†æ¥è‡ªè½¬è½½çš„å†…å®¹ï¼š iOS7.0åè‹¹æœæä¾›äº†è‡ªå®šä¹‰è½¬åœºåŠ¨ç”»çš„APIï¼Œåˆ©ç”¨è¿™äº›APIæˆ‘ä»¬å¯ä»¥æ”¹å˜ pushå’Œpopï¼ˆnavigationéæ¨¡æ€ï¼‰ï¼Œpresentå’Œdismissï¼ˆæ¨¡æ€ï¼‰ï¼Œæ ‡ç­¾åˆ‡æ¢ï¼ˆtabbarï¼‰çš„é»˜è®¤è½¬åœºåŠ¨ç”»ã€‚ ä¸»è¦æ¶‰åŠçš„API 1ã€UIViewControllerAnimatedTransitioningï¼šè½¬åœºåŠ¨ç”»åè®®ï¼Œå®ç°æ­¤åè®®å®šä¹‰è½¬åœºçš„åŠ¨ç”»è¡Œä¸ºã€‚ // å®šä¹‰è½¬åœºåŠ¨ç”»çš„æ—¶é—´ - (NSTimeInterval)transitionDuration:(nullable id &lt;UIViewControllerContextTransitioning&gt;)transitionContext; // å®šä¹‰è½¬åœºåŠ¨ç”»çš„è¡Œä¸º - (void)animateTransition:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext; 2ã€ UIViewControllerContextTransitioningï¼šè½¬åœºåŠ¨ç”»ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªåè®®å®šä¹‰äº†è½¬åœºåŠ¨ç”»å…·ä½“å‚æ•°ï¼Œæ§åˆ¶è½¬åœºåŠ¨ç”»çš„çŠ¶æ€ï¼Œè¿™ä¸ªåè®®ä¸€èˆ¬ç”±ç³»ç»Ÿå®ç°ï¼Œåœ¨è½¬åœºå‘ç”Ÿæ—¶æä¾›ç»™æˆ‘ä»¬ä½¿ç”¨ã€‚ Fromå’ŒToï¼šè½¬åœºæ˜¯ä¸¤ä¸ªè§†å›¾æ§åˆ¶å™¨ï¼ˆViewControllerï¼‰çš„è¡Œä¸ºï¼Œç”±ä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨ï¼ŒåŸå…ˆå‘ˆç°çš„è§†å›¾æ§åˆ¶å™¨å«FromViewControllerï¼Œå°†è¦å‘ˆç°çš„è§†å›¾æ§åˆ¶å™¨å«ToViewControllerï¼Œé‚£ä¹ˆFromViewControllerçš„viewå«åšFromViewï¼ŒToViewControllerçš„viewå«åšToViewã€‚ å¯¹åº”pushå’Œpopæ¥è¯´æ˜¯ä¸¤ä¸ªä¸åŒçš„è½¬åœºï¼Œå®ƒä»¬çš„Fromå’ŒToåœ¨ä¸¤ä¸ªè½¬åœºä¸­ä½¿ç›¸äº’è°ƒæ¢çš„ã€‚ containerView:è½¬åœºåŠ¨ç”»å®Œæˆéƒ½æ˜¯åœ¨containerViewé‡Œé¢ã€‚ 3ã€UIViewControllerInteractiveTransitioningï¼šè½¬åœºçš„äº¤äº’åè®®ï¼Œç”¨æ¥æ§åˆ¶è½¬åœºåŠ¨ç”»çš„çŠ¶æ€æˆ–è¿›åº¦ã€‚ //è®¾ç½®è½¬åœºè¿›åº¦, å–å€¼èŒƒå›´ [0..1] - (void)updateInteractiveTransition:(CGFloat)percentComplete; //å®Œæˆè½¬åœºï¼Œå‘ˆç°to - (void)finishInteractiveTransition; //å–æ¶ˆè½¬åœºï¼Œå‘ˆç°from - (void)cancelInteractiveTransition; 4ã€UIPercentDrivenInteractiveTransitionï¼šå®˜æ–¹æä¾›çš„å®ç°UIViewControllerInteractiveTransitioningåè®®çš„ç±»ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ ä¸Šé¢ç®€å•çš„ä»‹ç»äº†è½¬åœºåŠ¨ç”»æ¶‰åŠçš„APIï¼Œè¿™ä¸€èŠ‚ä¸»è¦é€šè¿‡å¯¼èˆªæ§åˆ¶å™¨çš„pushå’Œpopè½¬åœºåŠ¨ç”»æ¥ä»‹ç»è¿™äº›è‡ªå®šä¹‰è½¬åœºåŠ¨ç”»çš„æµç¨‹ã€‚ pushè½¬åœºåŠ¨ç”» 1ã€å‡†å¤‡å·¥ä½œï¼š å¸¦æœ‰å¯¼èˆªæ§åˆ¶å™¨çš„ViewControllerç±»ï¼Œè¦pushåˆ°çš„ä¸‹ä¸€çº§æ§åˆ¶å™¨SecondViewControllerç±»ã€‚ 2ã€åœ¨ç±»HSPushAnimationä¸­å®ç°UIViewControllerAnimatedTransitioningåè®®ï¼Œå®šä¹‰pushè½¬åœºåŠ¨ç”»è¡Œä¸ºã€‚ @interface HSPushAnimation : NSObject &lt;UIViewControllerAnimatedTransitioning&gt; @end @implementation HSPushAnimation //è®¾ç½®è½¬åœºåŠ¨ç”»çš„æ—¶é•¿ - (NSTimeInterval)transitionDuration:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext{ return 2.f; } - (void)animateTransition:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext{ //from UIViewController *toViewController = [transitionContext viewControllerForKey:UITransitionContextToViewControllerKey]; //to UIViewController *fromViewController = [transitionContext viewControllerForKey:UITransitionContextFromViewControllerKey]; UIView* toView = nil; UIView* fromView = nil; //UITransitionContextFromViewKeyå’ŒUITransitionContextToViewKeyå®šä¹‰åœ¨iOS8.0ä»¥åçš„SDKä¸­ï¼Œæ‰€ä»¥åœ¨iOS8.0ä»¥ä¸‹SDKä¸­å°†toViewControllerå’ŒfromViewControllerçš„viewè®¾ç½®ç»™toViewå’ŒfromView //iOS8.0 ä¹‹å‰å’Œä¹‹åviewçš„å±‚æ¬¡ç»“æ„å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥iOS8.0ä»¥åUITransitionContextFromViewKeyè·å¾—viewå¹¶ä¸æ˜¯fromViewControllerçš„view if ([transitionContext respondsToSelector:@selector(viewForKey:)]) { fromView = [transitionContext viewForKey:UITransitionContextFromViewKey]; toView = [transitionContext viewForKey:UITransitionContextToViewKey]; } else { fromView = fromViewController.view; toView = toViewController.view; } //è¿™ä¸ªéå¸¸é‡è¦ï¼Œå°†toViewåŠ å…¥åˆ°containerViewä¸­ [[transitionContext containerView] addSubview:toView]; CGFloat width = [UIScreen mainScreen].bounds.size.width; CGFloat height = [UIScreen mainScreen].bounds.size.height; toView.frame = CGRectMake(width, 0, width, height); [UIView animateWithDuration:[self transitionDuration:transitionContext] animations:^{ toView.frame = CGRectMake(0, 0, width, height); } completion:^(BOOL finished) { [transitionContext completeTransition:YES]; }]; } @end ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªéå¸¸ç®€å•çš„åŠ¨ç”»ï¼ŒtoViewä»å·¦åˆ°å³è¦†ç›–fromViewï¼Œå’Œç³»ç»Ÿé»˜è®¤åŠ¨ç”»ä¸€æ ·ï¼Œåªæ˜¯æ—¶é—´è®¾ç½®çš„æ¯”è¾ƒé•¿ã€‚ è½¬åœºåŠ¨ç”»æ‰€æœ‰è¦å‘ˆç°çš„å…ƒç´ éƒ½è¦æ”¾åœ¨containerViewä¸­ï¼ŒfromViewé»˜è®¤å·²ç»åœ¨containerViewä¸­äº†ã€‚ 3ã€æŒ‡å®špushè¦ä½¿ç”¨çš„è½¬åœºåŠ¨ç”»è¡Œä¸ºï¼šç”±äºè¦è‡ªå®šä¹‰è½¬åœºåŠ¨ç”»æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŒ‡å®šè½¬åœºåŠ¨ç”»è¡Œä¸ºã€‚pushè½¬åœºçš„åŠ¨ç”»è¡Œä¸ºæ˜¯ç”±UINavigationControllerDelegateåè®®æŒ‡å®šï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ViewControllerè®¾ç½®å¯¼èˆªæ§åˆ¶å™¨çš„Delegateï¼š - (void)viewDidAppear:(BOOL)animated{ [super viewDidAppear:animated]; self.navigationController.delegate = self; } å®ç°ä»¥ä¸‹åè®®ï¼ŒæŒ‡å®šåŠ¨ç”»ç±»ï¼š - (id&lt;UIViewControllerAnimatedTransitioning&gt;)navigationController:(UINavigationController *)navigationController animationControllerForOperation:(UINavigationControllerOperation)operation fromViewController:(UIViewController *)fromVC toViewController:(UIViewController *)toVC{ if (operation == UINavigationControllerOperationPush) { return [[HSPushAnimation alloc] init]; } return nil; } è¿™ä¸ªæ–¹æ³•å¯ä»¥åˆ†åˆ«æŒ‡å®špushå’Œpopçš„åŠ¨ç”»ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬åªå®šä¹‰pushåŠ¨ç”»ï¼Œæ‰€ä»¥åªè¦æŒ‡å®šUINavigationControllerOperationPushæ—¶çš„åŠ¨ç”»è¡Œä¸ºå³å¯ã€‚ è¿™æ ·pushè½¬åœºåŠ¨ç”»å°±å®Œæˆäº†ï¼Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š popè½¬åœºåŠ¨ç”» 1ã€popè½¬åœºåŠ¨ç”»å’Œpushè½¬åœºåŠ¨ç”»ç±»ä¼¼ï¼Œåœ¨ç±»HSPopAnimationä¸­å®ç°UIViewControllerAnimatedTransitioningåè®®ã€‚ @implementation HSPopAnimation - (NSTimeInterval)transitionDuration:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext{ return 0.5; } - (void)animateTransition:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext{ UIViewController *toViewController = [transitionContext viewControllerForKey:UITransitionContextToViewControllerKey]; UIViewController *fromViewController = [transitionContext viewControllerForKey:UITransitionContextFromViewControllerKey]; UIView* toView = nil; UIView* fromView = nil; if ([transitionContext respondsToSelector:@selector(viewForKey:)]) { fromView = [transitionContext viewForKey:UITransitionContextFromViewKey]; toView = [transitionContext viewForKey:UITransitionContextToViewKey]; } else { fromView = fromViewController.view; toView = toViewController.view; } //å°†toViewåŠ åˆ°fromViewçš„ä¸‹é¢ï¼Œéå¸¸é‡è¦ï¼ï¼ï¼ [[transitionContext containerView] insertSubview:toView belowSubview:fromView]; CGFloat width = [UIScreen mainScreen].bounds.size.width; CGFloat height = [UIScreen mainScreen].bounds.size.height; fromView.frame = CGRectMake(0, 0, width, height); [UIView animateWithDuration:[self transitionDuration:transitionContext] animations:^{ fromView.frame = CGRectMake(width, 0, width, height); } completion:^(BOOL finished) { [transitionContext completeTransition:!transitionContext.transitionWasCancelled]; }]; } @end è¿™é‡ŒpopåŠ¨ç”»åŸºæœ¬å’ŒpushåŠ¨ç”»æ˜¯ç›¸åçš„è¿‡ç¨‹ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æŒ‡å®šåˆ«çš„æ–¹å¼çš„åŠ¨ç”»ã€‚ è¿™é‡Œfromã€toå’ŒpushåŠ¨ç”»é‡Œé¢çš„fromã€toå€¼å·²ç»äº’æ¢äº†ï¼Œæ‰€ä»¥å¦‚æœå°†pushå’ŒpopåŠ¨ç”»å†™åœ¨ä¸€èµ·çš„è¯ï¼Œè¦ç‰¹åˆ«æ³¨æ„ï¼Œä¸è¿‡å»ºè®®å°†pushå’ŒpopåŠ¨ç”»åˆ†åˆ«å®šä¹‰åˆ°ä¸åŒçš„ç±»ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚ 2ã€åœ¨SecondViewControlleç±»ä¸­è®¾ç½®å¯¼èˆªæ§åˆ¶å™¨çš„Delegateï¼Œå¹¶å®ç°ä»¥ä¸‹åè®®ï¼š - (id&lt;UIViewControllerAnimatedTransitioning&gt;)navigationController:(UINavigationController *)navigationController animationControllerForOperation:(UINavigationControllerOperation)operation fromViewController:(UIViewController *)fromVC toViewController:(UIViewController *)toVC{ if (operation == UINavigationControllerOperationPop) { return [[HSPopAnimation alloc] init]; } return nil; } popè½¬åœºåŠ¨ç”»å°±å®Œæˆäº†ï¼Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š å¯äº¤äº’è½¬åœºåŠ¨ç”» å…ˆæ¥çœ‹çœ‹å¯äº¤äº’è½¬åœºåŠ¨ç”»æ•ˆæœ å¯äº¤äº’è½¬åœºåŠ¨ç”»çš„å®ç°éœ€è¦å®ç°UIViewControllerInteractiveTransitioningåè®®ï¼Œå¹¸å¥½å®˜æ–¹ç»™æˆ‘ä»¬æä¾›äº†UIPercentDrivenInteractiveTransitionç±»å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä½ ä¹Ÿå¯ä»¥ç»§æ‰¿UIPercentDrivenInteractiveTransitionæ¥ä½¿ç”¨ã€‚ UIViewControllerInteractiveTransitioningåè®®çš„åŠŸèƒ½ä¸»è¦æ˜¯æ§åˆ¶è½¬åœºåŠ¨ç”»çš„çŠ¶æ€ï¼Œå³åŠ¨ç”»å®Œæˆçš„ç™¾åˆ†æ¯”ï¼Œæ‰€ä»¥åªæœ‰åœ¨è½¬åœºä¸­æ‰æœ‰ç”¨ã€‚ æ¯”å¦‚æˆ‘ä»¬é€šè¿‡[self.navigationController popViewControllerAnimated:YES]è§¦å‘popè½¬åœºåŠ¨ç”»ï¼Œç„¶ååœ¨è½¬åœºåŠ¨ç”»ç»“æŸä¹‹å‰é€šè¿‡- (void)updateInteractiveTransition:(CGFloat)percentCompleteæ›´æ”¹è½¬åœºåŠ¨ç”»çš„å®Œæˆçš„ç™¾åˆ†æ¯”ï¼Œé‚£ä¹ˆè½¬åœºåŠ¨ç”»å°†ç”±å®ç°UIViewControllerInteractiveTransitioningçš„ç±»æ¥ç®¡ï¼Œè€Œä¸æ˜¯ç”±å®šæ—¶å™¨ç®¡ç†ï¼Œä¹‹åå°±å¯ä»¥éšæ„è®¾ç½®åŠ¨ç”»çŠ¶æ€äº†ã€‚ äº¤äº’åŠ¨ç”»å¾€å¾€é…åˆæ‰‹åŠ¿æ“ä½œï¼Œæ‰‹åŠ¿æ“ä½œäº§ç”Ÿä¸€åºåˆ—ç™¾åˆ†æ¯”æ•°é€šè¿‡updateInteractiveTransitionæ–¹æ³•å®æ—¶æ›´æ–°è½¬åœºåŠ¨ç”»çŠ¶æ€ã€‚ 1ã€ç°åœ¨æ·»åŠ ä¸ºSecondViewControlleçš„viewæ·»åŠ æ‰‹åŠ¿ï¼š //æ·»åŠ panæ‰‹åŠ¿ UIPanGestureRecognizer * pan = [[UIPanGestureRecognizer alloc] init]; [pan addTarget:self action:@selector(panGestureRecognizerAction:)]; [self.view addGestureRecognizer:pan]; 2ã€è§¦å‘è½¬åœºåŠ¨ç”»ï¼Œé€šè¿‡æ‰‹åŠ¿äº§ç”Ÿç™¾åˆ†æ¯”æ•°å€¼ï¼Œæ›´æ–°è½¬åœºåŠ¨ç”»çŠ¶æ€ï¼š - (void)panGestureRecognizerAction:(UIPanGestureRecognizer *)pan{ //äº§ç”Ÿç™¾åˆ†æ¯” CGFloat process = [pan translationInView:self.view].x / ([UIScreen mainScreen].bounds.size.width); process = MIN(1.0,(MAX(0.0, process))); if (pan.state == UIGestureRecognizerStateBegan) { self.interactiveTransition = [UIPercentDrivenInteractiveTransition new]; //è§¦å‘popè½¬åœºåŠ¨ç”» [self.navigationController popViewControllerAnimated:YES]; }else if (pan.state == UIGestureRecognizerStateChanged){ [self.interactiveTransition updateInteractiveTransition:process]; }else if (pan.state == UIGestureRecognizerStateEnded || pan.state == UIGestureRecognizerStateCancelled){ if (process &gt; 0.5) { [ self.interactiveTransition finishInteractiveTransition]; }else{ [ self.interactiveTransition cancelInteractiveTransition]; } self.interactiveTransition = nil; } } æ‰‹åŠ¿å¼€å§‹çŠ¶æ€ï¼šæ‰‹åŠ¿å¼€å§‹æ—¶åˆ›å»ºUIPercentDrivenInteractiveTransitionå¯¹è±¡ï¼Œé€šè¿‡popViewControllerAnimatedæ–¹æ³•è§¦å‘è½¬åœºåŠ¨ç”»ã€‚ æ‰‹åŠ¿å˜åŒ–çŠ¶æ€ï¼šé€šè¿‡è®¡ç®—å¾—åˆ°çš„ç™¾åˆ†æ¯”å®æ—¶æ›´æ–°è½¬åœºåŠ¨ç”»çš„çŠ¶æ€ã€‚ æ‰‹åŠ¿å–æ¶ˆæˆ–è€…ç»“æŸçŠ¶æ€ï¼šæ ¹æ®å®Œæˆçš„ç™¾åˆ†æ¯”å†³å®šæ˜¯å¦å®Œæˆè½¬åœºæˆ–è€…å–æ¶ˆè½¬åœºã€‚ 3ã€å¼€å§‹è½¬åœºåŠ¨ç”»æ—¶ï¼Œå°±éœ€è¦æŒ‡å®šä¸€ä¸ªå®ç°UIViewControllerInteractiveTransitioningåè®®çš„å¯¹è±¡æ¥æ§åˆ¶è½¬åœºåŠ¨ç”»çš„çŠ¶æ€ï¼Œå¦åˆ™è½¬åœºåŠ¨ç”»çŠ¶æ€ç”±å®šæ—¶å™¨ç®¡ç†ã€‚åœ¨SecondViewControlleç±»ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡UINavigationControllerDelegateåè®®å°†interactiveTransitionå¯¹è±¡ä¼ ç»™UIKitï¼š - (void)viewDidAppear:(BOOL)animated{ [super viewDidAppear:animated]; self.navigationController.delegate = self; } - (id&lt;UIViewControllerInteractiveTransitioning&gt;)navigationController:(UINavigationController *)navigationController interactionControllerForAnimationController:(id&lt;UIViewControllerAnimatedTransitioning&gt;)animationController{ if ([animationController isKindOfClass:[HSPopAnimation class]]) { return self.interactiveTransition; } return nil; } ä»¥ä¸Šæ­¥éª¤å°±å°†popçš„å¯äº¤äº’è½¬åœºåŠ¨ç”»å®Œæˆäº†ã€‚ pushå’Œpopè½¬åœºåŠ¨ç”»åŸºæœ¬æµç¨‹ Noteï¼š åŠ¨ç”»çš„çŠ¶æ€å’Œè½¬åœºçš„çŠ¶æ€æ˜¯ä¸ä¸€æ ·çš„ï¼ŒåŠ¨ç”»å®Œæˆåï¼Œä¸ä»£è¡¨è½¬åœºå®Œæˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åœ¨åŠ¨ç”»çš„completioné‡Œé¢å†³å®šæ˜¯å¦å®Œæˆè½¬åœºï¼š[transitionContext completeTransition:!transitionContext.transitionWasCancelled]; è½¬åœºæ˜¯ä¸€ä¸ªè¿‡ç¨‹ï¼Œæ‰€æœ‰çš„åŠ¨ç”»éƒ½åœ¨containerViewé‡Œé¢å®Œæˆã€‚ ä¸éœ€è¦äº¤äº’çš„è½¬åœºinteractionControllerForAnimationControlleræ–¹æ³•ä¸€å®šè¦è¿”å›nil è¡¥å…… ç†Ÿæ‚‰äº†ä¸Šé¢çš„è‡ªå®šä¹‰æµç¨‹åï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„åšå‡ºæˆ‘ä»¬æƒ³è¦çš„åŠ¨ç”»æ•ˆæœã€‚ åœºæ™¯ä¸€ï¼šä»æœ‰å¯¼èˆªæ vcè¿›å…¥å…¨å±vcï¼Œè¿”å›çš„æ—¶å€™å¯¼èˆªæ ä½ç½®å›ºå®šï¼Œé€æ¸æ˜¾ç¤ºï¼› è§£æ³•ï¼šè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œåœ¨æˆ‘ä»¬å‰é¢çš„åŸºç¡€ä¹‹ä¸Šï¼Œè®¾ç½®å¯¼èˆªæ çš„éšè—å’Œæ˜¾ç¤ºå³å¯ã€‚ åœ¨SecondViewControlleræ·»åŠ ä»¥ä¸‹ä»£ç ï¼š - (void)viewWillAppear:(BOOL)animated { [self.navigationController setNavigationBarHidden:YES animated:animated]; } - (void)viewWillDisappear:(BOOL)animated { [self.navigationController setNavigationBarHidden:NO animated:animated]; } åœºæ™¯äºŒï¼šä»æœ‰å¯¼èˆªæ vcè¿›å…¥å…¨å±vcï¼Œè¿”å›çš„æ—¶å€™å¯¼èˆªæ åº”è¯¥è·Ÿåœ¨toViewä¸€èµ·æ‹‰è¿‡æ¥ã€‚ è§£æ³•ï¼šå»¶ç”¨åœºæ™¯ä¸€çš„ä»£ç ï¼Œç„¶ååœ¨å‰é¢çš„HSPopAnimationçš„animateTransitionæ–¹æ³•ä¸­è¡¥å……navigationBarçš„åŠ¨ç”»å³å¯ã€‚ ç»™ä¸€ä¸‹å®Œæ•´çš„ä»£ç ï¼š @implementation HSPopAnimation - (NSTimeInterval)transitionDuration:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext{ return 0.5; } - (void)animateTransition:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext{ UIViewController *toViewController = [transitionContext viewControllerForKey:UITransitionContextToViewControllerKey]; UIViewController *fromViewController = [transitionContext viewControllerForKey:UITransitionContextFromViewControllerKey]; UIView* toView = nil; UIView* fromView = nil; if ([transitionContext respondsToSelector:@selector(viewForKey:)]) { fromView = [transitionContext viewForKey:UITransitionContextFromViewKey]; toView = [transitionContext viewForKey:UITransitionContextToViewKey]; } else { fromView = fromViewController.view; toView = toViewController.view; } //å°†toViewåŠ åˆ°fromViewçš„ä¸‹é¢ï¼Œéå¸¸é‡è¦ï¼ï¼ï¼ [[transitionContext containerView] insertSubview:toView belowSubview:fromView]; CGFloat width = [UIScreen mainScreen].bounds.size.width; CGFloat height = [UIScreen mainScreen].bounds.size.height; fromView.frame = CGRectMake(0, 0, width, height); //è®¾ç½®å¯¼èˆªæ åˆå§‹ä½ç½® UINavigationBar *navBar = toViewController.navigationController.navigationBar; CGRect navRect = navBar.frame; navBar.frame = CGRectMake(-width, navRect.origin.y, navRect.size.width, navRect.size.height); [UIView animateWithDuration:[self transitionDuration:transitionContext] animations:^{ fromView.frame = CGRectMake(width, 0, width, height); navBar.frame = CGRectMake(0, navRect.origin.y, navRect.size.width, navRect.size.height); } completion:^(BOOL finished) { [transitionContext completeTransition:!transitionContext.transitionWasCancelled]; }]; } @end ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°è¿™é‡Œå¯¼èˆªæ çš„é€æ˜åº¦æ˜¯é€æ¸å˜åŒ–çš„ï¼Œè¦æ˜¯æƒ³å›ºå®šé€æ˜åº¦100%ï¼Œæ”¹ä¸€ä¸‹æ–¹æ³•å³å¯ [self.navigationController setNavigationBarHidden:NO animated:NO]; å…¶ä»–èµ„æ–™ https://tech.meituan.com/2018/10/25/navigation-transition-solution-and-best-practice-in-meituan.html ","link":"https://jayying007.github.io/post/iosè‡ªå®šä¹‰è½¬åœºåŠ¨ç”»/"},{"title":"NSTimerçš„ä¸€äº›ç†è§£&RunLoopç®€ä»‹","content":"RunLoop The purpose of a run loop is to keep your thread busy when there is work to do and put your thread to sleep when there is none. The app frameworks automatically set up and run the run loop on the main thread as part of the application startup process. You must be sure to add one or more input sources, timers, or run-loop observers to any modes you create for them to be useful. é”™è¯¯åšæ³•ï¼š dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{ NSRunLoop *runLoop = [NSRunLoop currentRunLoop]; [runLoop run]; [NSTimer scheduledTimerWithTimeInterval:3 repeats:YES block:^(NSTimer * _Nonnull timer) { NSLog(@&quot;in other thread.&quot;); }]; }); æ­£ç¡®åšæ³•ï¼š dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{ NSRunLoop *runLoop = [NSRunLoop currentRunLoop]; [NSTimer scheduledTimerWithTimeInterval:3 repeats:YES block:^(NSTimer * _Nonnull timer) { NSLog(@&quot;in other thread.&quot;); }]; [runLoop run]; }); RunLoopæœ‰å¤šç§Modesï¼Œåœ¨æŸä¸€æ—¶åˆ»åªä¼šè¿è¡Œåœ¨ä¸€ç§Modeä¸‹ï¼Œå¤„ç†è¿™ä¸ªModeä¸‹å¯¹åº”çš„sourcesã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé¡¹ç›®ä¸­éƒ½ä¸éœ€è¦æˆ‘ä»¬å»ä½¿ç”¨RunLoopï¼Œå› ä¸ºä¸»çº¿ç¨‹çš„å·²ç»é»˜è®¤å¼€å¯äº†ã€‚å­çº¿ç¨‹çš„è¯ï¼Œé™¤éä½ éœ€è¦Timerã€performSelectorè¿™ç±»éœ€è¦è¿è¡Œåœ¨RunLoopä¸Šçš„ä¸œè¥¿æ—¶æ‰å¼€å¯ã€‚ NSTimer ä»RunLoopçš„ç‰¹æ€§æˆ‘ä»¬çŸ¥é“ï¼Œä¸€èˆ¬æƒ…å†µä¸‹NSTimerè¿è¡Œåœ¨NSDefaultRunLoopModeæ¨¡å¼ï¼Œå½“scrollviewæ»‘åŠ¨æ—¶ï¼ŒRunLoopæ˜¯è¿è¡Œåœ¨UITrackingRunLoopModeæ¨¡å¼ä¸‹çš„ï¼Œæ­¤æ—¶NSTimerå°±ä¸å·¥ä½œäº†ï¼Œåˆ°äº†æŒ‡å®šæ—¶é—´ä¹Ÿä¸ä¼šè§¦å‘äº‹ä»¶ã€‚ If a timer is not in the mode currently being monitored by the run loop, it does not fire until you run the run loop in one of the timerâ€™s supported modes. NSTimerå¹¶ä¸æ˜¯å®æ—¶çš„ï¼Œå¦‚æœå½“å‰RunLoopæœ‰ä»»åŠ¡åœ¨æ‰§è¡Œï¼ŒTimerå°†ç­‰ä»»åŠ¡ç»“æŸå†å¤„ç†ã€‚å¦‚æœä½ æ˜¯ä¸€ä¸ªé‡å¤çš„Timerï¼Œåœ¨5ç§’ã€10ç§’ã€15ç§’è¿™äº›æ—¶é—´ç‚¹è§¦å‘ï¼Œç¬¬ä¸€æ¬¡å› ä¸ºå»¶è¿Ÿè€Œåœ¨7ç§’çš„æ—¶å€™æ‰æ‰§è¡Œï¼Œé‚£ä¹ˆä¸‹æ¬¡æ‰§è¡Œæ—¶é—´è¿˜æ˜¯10ç§’ã€‚ If the firing time is delayed so much that it misses one or more of the scheduled firing times, the timer is fired only once for the missed time period. æ¯”å¦‚ä¸‹é¢æ¯éš”åç§’æ‰§è¡Œçš„Timerï¼š 49ç§’çš„æ—¶å€™delayï¼Œç›´åˆ°53ç§’æ‰§è¡Œï¼› 59ç§’çš„æ—¶å€™delayï¼Œç›´åˆ°08ç§’æ‰§è¡Œï¼› 39ç§’ã€49ç§’çš„æ—¶å€™delayï¼Œä¹Ÿåªåœ¨56ç§’æ‰§è¡Œä¸€æ¬¡ã€‚ å»¶è¿Ÿåè¦ä¸è¦æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡è®¾ç½®toleranceå»åš æ³¨æ„ç‚¹ Run loops maintain strong references to their timers, so you donâ€™t have to maintain your own strong reference to a timer after you have added it to a run loop RunLoopå¼ºå¼•ç”¨Timerï¼ŒTimerå¼ºå¼•ç”¨Targetï¼Œæ‰€ä»¥Timerå­˜åœ¨çš„è¯ï¼ŒTargetå°±ä¸ä¼šæ¶ˆäº¡ã€‚é€šè¿‡invalidateæ–¹æ³•å¯ä»¥ä»RunLoopä¸­ç§»é™¤Timerã€‚ä¸è¿‡å¦‚æœä½ æŠŠinvalidateå†™åœ¨targetçš„deallocé‡Œé¢ï¼Œé‚£å°±æ˜¯å¾ªç¯å¼•ç”¨äº† å…³äºåå°è¿è¡Œ ç†è®ºä¸Šï¼Œappè¿›å…¥åå°ï¼ŒçŸ­æš‚å¾…ä¸€ä¼šå°±è¿›å…¥æŒ‚èµ·çŠ¶æ€ã€‚ä½ å¯ä»¥åœ¨é¡¹ç›®ä¸­è®¾ç½®ä¸€ä¸ªé‡å¤çš„Timerå»éªŒè¯ã€‚ æ‰€ä»¥é—®é¢˜æ˜¯ï¼Œå¦‚æœä½ æƒ³åœ¨å‡ ä¸ªå°æ—¶åï¼ˆæ¯”å¦‚ä½ çš„Appæ˜¯ç±»ä¼¼é—¹é’Ÿä¹‹ç±»çš„ä¸œè¥¿ï¼‰æ‰§è¡ŒæŸäº›ä»£ç é€»è¾‘ï¼Ÿ è¿™é‡Œæœ‰ä¸€äº›æ–¹æ³•ä¾›å‚è€ƒï¼š è®¾ç½®æœ¬åœ°é€šçŸ¥ã€‚é€šçŸ¥æ˜¯ç”±IOSç®¡ç†çš„ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒAppè¢«killæ‰ï¼Œåªè¦æ—¶é—´ä¸€åˆ°ï¼ŒIOSå°±ä¼šè§¦å‘é€šçŸ¥ ç±»ä¼¼äºåå°æ’­æ”¾éŸ³ä¹ã€å®šä½ã€VOIPè¿™äº›ï¼ˆè¿™äº›å¯èƒ½éœ€è¦ç”³è¯·æƒé™ï¼Œè€Œä¸”æ»¥ç”¨çš„è¯è‹¹æœå®¡æ ¸ä¼°è®¡ä¹Ÿä¸é€šè¿‡ï¼‰ï¼Œå¯ä»¥åå°æ’­æ”¾é™éŸ³æ–‡ä»¶ï¼ˆä¼ªè£…ä½ åœ¨æ’­æ”¾éŸ³ä¹ï¼Œå®é™…æ˜¯åšå®ƒç”¨ï¼‰ï¼Œè¿™æ ·ä½ çš„Appå°±èƒ½ä¸€ç›´è¿è¡Œäº†ã€‚ã€‚ å¦‚æœä¸æ˜¯è¦ç²¾ç¡®çš„æ—¶é—´çš„è¯ï¼Œå¯ä»¥åœ¨ä¸‹æ¬¡Appå¯åŠ¨çš„æ—¶å€™å»åšä¸ªæ—¶é—´æ£€æŸ¥ï¼Œè¿‡äº†æ—¶é—´ç‚¹çš„å°±å¯ä»¥æ‰§è¡Œç›¸å…³çš„é€»è¾‘ã€‚ å‚è€ƒèµ„æ–™ https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW1 https://blog.csdn.net/totogo2010/article/details/107321490?spm=1001.2014.3001.5501 https://www.jianshu.com/p/11fae16ab622 https://developer.apple.com/documentation/foundation/nstimer iosåº”ç”¨ç¨‹åºçŠ¶æ€å˜è¿ ","link":"https://jayying007.github.io/post/å¯¹NSTimerçš„ä¸€äº›ç†è§£/"},{"title":"åˆ†äº«ä¸€é“ç®—æ³•è®¾è®¡é¢˜","content":"é¢˜ç›® æœ‰ä¸€ä¸ªå‡½æ•°rand()èƒ½ç”Ÿæˆ1-65536ä¹‹é—´çš„æ•´æ•°ï¼Œåˆ©ç”¨è¿™ä¸ªå‡½æ•°ï¼Œè®©30ä¸‡äººä¸­æœ‰5ä¸‡äººä¸­å¥–ï¼Œè¦æ±‚ä¿è¯å…¬å¹³ï¼ˆå³æ¯ä¸ªäººçš„ä¸­å¥–å‡ ç‡ä¸€æ ·ï¼‰ã€‚ | | | | | | | | | æ€è·¯ é¦–å…ˆè§£å†³å¦‚ä½•åšåˆ°30ä¸‡äººæŠ½å‡º5ä¸‡äººï¼Œè¿˜ä¿è¯å…¬å¹³ã€‚ å‡è®¾èƒ½å®ç°ä¸€ä¸ªå‡½æ•°randX()ï¼Œä»–èƒ½è¿”å›1-30ä¸‡ä¹‹é—´çš„æ•´æ•°ï¼Œé‚£ä¹ˆæˆ‘å¯ä»¥åˆ¶å®šä¸€ä¸ªç­–ç•¥ï¼Œä»éšæœºåˆ°çš„æ•°å‘åå–5ä¸‡ä¸ªã€‚å¦‚ä¸‹å›¾æ‰€ç¤º å½“åé¢ä¸è¶³5ä¸‡ä¸ªæ—¶ï¼Œä»å¤´éƒ¨è¡¥ä¸€äº› è¿™ç§æ–¹å¼çœŸçš„èƒ½ä¿è¯å…¬å¹³å—ï¼Œè®©æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ æ¯ä¸ªäººçš„ä¸­å¥–æ¦‚ç‡ä¸º 5ä¸‡/30ä¸‡ = 1/6 ä¸Šé¢çš„è¿™ç§æ–¹æ³•ï¼Œçº¢è‰²éƒ¨åˆ†å…±æœ‰30ä¸‡ç§å¯èƒ½ï¼ˆåˆå§‹ä½ç½®ä»1-30ä¸‡ï¼‰ï¼Œè€Œæ¯ä¸€ä¸ªä½ç½®ï¼Œæ¯”å¦‚5ä¸‡è¿™ä¸ªä½ç½®ï¼Œçº¢è‰²éƒ¨åˆ†å…±æœ‰5ä¸‡ç§å¯èƒ½ä¼šè¦†ç›–åˆ°è¿™ä¸ªæ•°ï¼Œæ‰€ä»¥è¿™ä¸ªä½ç½®è¢«é€‰åˆ°çš„æ¦‚ç‡ä¹Ÿæ˜¯ 5ä¸‡/30ä¸‡ = 1/6 ç°åœ¨é—®é¢˜è½¬ä¸ºå¦‚ä½•è®¾è®¡ä¸€ä¸ªrandX()ï¼Œä½¿å…¶è¿”å›1-30ä¸‡ä¹‹é—´çš„æ•´æ•°ï¼Œä¸”å…¬å¹³ ä¸€ä¸ªé”™è¯¯æ–¹å¼æ˜¯å°†rand() * (300000/65536)ï¼Œè¿™ç§æ–¹å¼è™½ç„¶èƒ½å¾—åˆ°1-300000ä¹‹é—´çš„æ•´æ•°ï¼Œä½†æ˜¯æœ‰äº›æ•°å´æ°¸è¿œå–ä¸åˆ°ã€‚ rand()=1æ—¶ï¼Œrand()*(300000/65536)=4.5776,é‚£ä¹ˆæ— è®ºå¦‚ä½•ä½ å°±å–ä¸åˆ°1ï¼Œ2ï¼Œ3äº† é‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿä¸€ç§æ–¹æ³•æ˜¯åˆ†åŒºé—´ æ¯”å¦‚æŠŠ30ä¸‡åˆ’åˆ†ä¸º5ä¸ªä¸€æ ·å¤§çš„åŒºåˆ«ï¼Œæ¯ä¸ªåŒºé—´åªæœ‰6ä¸‡ æˆ‘ä»¬å…ˆéšæœºå–1-5ä¹‹é—´çš„æ•°ï¼Œä»è€Œç¡®å®šåœ¨é‚£ä¸ªåŒºé—´å–ã€‚ ä¸€ä¸ªåŒºé—´åªæœ‰6ä¸‡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨rand()æ¥å–1-6ä¸‡ä¹‹é—´çš„æ•´æ•°äº†ï¼Œæœ€ååŠ ä¸ŠåŒºé—´èµ·å§‹ä½ç½®çš„æ•°å°±å¯ä»¥äº†ã€‚ è¿™æ ·å°±æ²¡é—®é¢˜äº†å—ï¼Ÿ å…¶å®å¦‚æœé€‰æ‹©ä¸æ…ï¼Œè¿˜æ˜¯ä¸å…¬å¹³çš„ã€‚ æ¯”å¦‚ä¸€ä¸ªèƒ½ç”Ÿæˆ1-10éšæœºæ•°çš„å‡½æ•°randï¼Œç”¨å®ƒæ¥ç”Ÿæˆ1-4çš„éšæœºæ•°ï¼Œå¦‚æœå†™æˆrand%4+1ï¼Œé‚£ç»“æœå°±æ˜¯é”™çš„ã€‚ æˆ‘ä»¬å¯ä»¥åˆ—å‡ºæ‰€æœ‰è®¡ç®—çš„å¯èƒ½æƒ…å†µ ç”Ÿæˆ1: 1 5 9 ç”Ÿæˆ2: 2 6 10 ç”Ÿæˆ3: 3 7 ç”Ÿæˆ4: 4 8 å¯è§ç”Ÿæˆä¸åŒéšæœºæ•°çš„æ¦‚ç‡å…¶å®æ˜¯ä¸ä¸€æ ·çš„ï¼Œç”Ÿæˆ1çš„æ¦‚ç‡æ˜¯ååˆ†ä¹‹ä¸‰ï¼Œç”Ÿæˆ4çš„æ¦‚ç‡æ˜¯ååˆ†ä¹‹äºŒã€‚ è¦å®ç°ä¸€ä¸ªå…¬å¹³çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼Œéœ€è¦ä¿è¯ç”Ÿæˆçš„æœ€å¤§æ•°ä¸ºåŸæ¥éšæœºå™¨æœ€å¤§æ•°çš„å› æ•°ã€‚æ¯”å¦‚1-10å¯¹åº”èƒ½åˆ¶é€ ç”Ÿæˆ1-2å’Œ1-5ä¸¤ç§éšæœºå™¨ï¼Œä¸”ä¿è¯å…¬å¹³ã€‚ è€Œé’ˆå¯¹ä¸Šé¢è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬èƒ½åšçš„æ˜¯æ‹’ç»é‡‡æ ·ï¼ˆreject samplingï¼‰ï¼Œå½“å¾—åˆ°çš„æ•°ä¸º9æˆ–10æ—¶ï¼Œè®©å®ƒé‡æ–°ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ç›´åˆ°æ»¡è¶³æ¡ä»¶ã€‚ å¯¹äºæœ¬æ–‡çš„é¢˜ï¼Œ65536çš„å› æ•°éƒ½æ˜¯2çš„æŒ‡æ•°æ¬¡å¹‚ï¼Œè€Œ30ä¸‡ä¸æ˜¯ï¼Œæ‰€ä»¥ä¹Ÿåªèƒ½é‡‡ç”¨æ‹’ç»é‡‡æ ·çš„æ–¹æ³•ã€‚ ","link":"https://jayying007.github.io/post/åˆ†äº«ä¸€é“ç®—æ³•è®¾è®¡é¢˜/"},{"title":"åŸºäºæ¶ˆæ¯è¡¨çš„åˆ†å¸ƒå¼äº‹åŠ¡","content":"åœ¨åˆ†å¸ƒå¼æ•°æ®åº“ä¸­ï¼Œé€šè¿‡é¿å…å¼ºä¸€è‡´æ€§å¯ä»¥å¸¦æ¥ä¼¸ç¼©æ€§çš„å·¨å¤§æå‡ã€‚ ç®€ä»‹ éšç€ä½ å…¬å¸Webåº”ç”¨çš„å‘å±•ï¼Œæ•°æ®åº“å®¹æ˜“é™·å…¥ç“¶é¢ˆã€‚é€šå¸¸æœ‰ä¸¤ç§æ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå‚ç›´æ‰©å±•å’Œæ°´å¹³æ‰©å±•ã€‚ å‚ç›´æ‰©å±•é€šè¿‡æå‡ç¡¬ä»¶æ€§èƒ½ï¼Œä½†ä¸€èˆ¬æ¯”è¾ƒæ˜‚è´µã€‚ æ°´å¹³æ‰©å±•æ˜¯æœ¬æ–‡ä¸»è¦è®¨è®ºçš„æ–¹æ³•ï¼Œç›¸æ¯”å‚ç›´æ‰©å±•è¦å¤æ‚ä¸€äº›ã€‚ æ°´å¹³æ‰©å±•çš„æ–¹å¼é€šå¸¸ä¹Ÿæœ‰ä¸¤ç§ï¼šæŒ‰æ¨¡å—åˆ‡åˆ†ï¼Œæ•°æ®è¡¨åšåˆ‡ç‰‡ï¼ˆShardingï¼‰ æŒ‰æ¨¡å—åˆ‡åˆ†çš„æ–¹å¼ï¼Œå°† Users, products, and transactionsåˆ‡åˆ†åˆ°ä¸åŒçš„æ•°æ®åº“ã€‚ä¸åŒæ¨¡å—é€šè¿‡è®¾è®¡åˆé€‚çš„å¤–é”®è¿›è¡Œå…³è”è®¿é—®ã€‚ æ¯ä¸ªæ¨¡å—å¯ä»¥æ ¹æ®å…·ä½“å®¹é‡å†è¿›è¡Œåˆ‡åˆ† ACIDä¸BASE æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å•ä¸ªæ•°æ®åº“ä¸‹ï¼Œæ˜¯å¯ä»¥å®ç°ACIDçš„ã€‚è€Œåœ¨è·¨å¤šä¸ªæ•°æ®åº“çš„æƒ…å†µä¸‹ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡2PCå®ç°ã€‚2PCä¿è¯äº†å¼ºä¸€è‡´æ€§ï¼Œè€Œæ ¹æ®CAPç†è®ºå¯ä»¥å¾—çŸ¥ï¼Œå…¶å¯ç”¨æ€§åˆ™æ— æ³•å®Œå…¨å®ç°ã€‚ é‚£å¦‚æœæˆ‘ä»¬æƒ³è¦å¯ç”¨æ€§ï¼Œä¸è¦æ±‚å¼ºä¸€è‡´æ€§å‘¢ï¼Ÿå¯ä»¥è¯•è¯•BASEã€‚ å¦‚æœè¯´ACIDæ˜¯æ‚²è§‚çš„ï¼Œè¦æ±‚æ¯ä¸ªæ“ä½œéƒ½ä¸¥æ ¼ä¸€è‡´ï¼Œé‚£ä¹ˆBASEåˆ™æ˜¯ä¹è§‚çš„ï¼Œå…è®¸æµåŠ¨ï¼ˆfluxï¼‰çš„çŠ¶æ€ã€‚ BASEçš„é«˜å¯ç”¨å¹¶ä¸æ˜¯ä¿è¯æ¯ä¸ªç”¨æˆ·è¯·æ±‚éƒ½è¢«æ‰§è¡Œã€‚æ¯”å¦‚æœ‰5å°æ•°æ®åº“æœåŠ¡å™¨ï¼Œå½“æœ‰ä¸€å°æœåŠ¡å™¨å®•æœºäº†ï¼Œé‚£ä¹ˆå¤§çº¦åªæœ‰20%çš„ç”¨æˆ·è®¿é—®ä¸äº†ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä»ç„¶è®¤ä¸ºç³»ç»Ÿæ˜¯å¯ç”¨çš„ã€‚ ä¸‹é¢æˆ‘ä»¬ä»¥ä¸€ä¸ªä¾‹å­æ¼”ç¤ºä»å•æœºåˆ°å¤šæœºçš„å˜åŒ–ã€‚ ä¾‹å­ å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹æ•°æ®è¡¨Userå’ŒTransactionï¼Œå®ƒä»¬å­˜æ”¾åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­ã€‚æ¯å½“æœ‰ä¸€ä»¶å•†å“å–å‡ºæ—¶ï¼Œå‘Transactionè¡¨æ’å…¥ä¸€æ¡æ•°æ®ï¼Œç„¶åæ›´æ–°ä¹°å®¶å’Œå–å®¶çš„userè¡¨ã€‚ ä¸Šé¢è¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€šè¿‡ä¸‹é¢çš„SQLäº‹åŠ¡è¡¨ç¤º å½“æˆ‘ä»¬æŒ‰æ¨¡å—åˆ’åˆ†åï¼Œuserå’Œtransactionä½äºä¸åŒçš„æ•°æ®åº“æœåŠ¡å™¨ä¸Šï¼Œæ­¤æ—¶å†æ‰§è¡Œåˆ™å˜æˆäº†ä¸¤ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼Œè‹¥äº‹åŠ¡1æ‰§è¡ŒæˆåŠŸï¼Œäº‹åŠ¡2æ‰§è¡Œå¤±è´¥ï¼Œå°±å‡ºç°äº†æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚æ€ä¹ˆè§£å†³è¿™ç§é—®é¢˜å‘¢ï¼Ÿè¿™é‡Œå°±å¼•å…¥äº†æˆ‘ä»¬æœ¬æ–‡çš„ä¸»è§’ï¼Œæ¶ˆæ¯è¡¨ã€‚ å®ç°æ¶ˆæ¯è¡¨çš„æ–¹æ³•å¯èƒ½æœ‰å¾ˆå¤šï¼Œä½†ä¸ç®¡æ€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å°†æ¶ˆæ¯çš„æ‰§è¡Œä¹Ÿåˆ’å½’åˆ°æˆ‘ä»¬çš„äº‹åŠ¡å†…ã€‚å¼•å…¥æ¶ˆæ¯è¡¨åï¼Œæˆ‘ä»¬çš„SQLè¯­å¥ä¼šå˜æˆä¸‹é¢è¿™æ ·ã€‚ å¯ä»¥åˆ›å»ºä¸€ä¸ªåå°è¿›ç¨‹ï¼ŒæŸ¥è¯¢æ¶ˆæ¯è¡¨ï¼Œç„¶åæ ¹æ®æ¶ˆæ¯å†…å®¹æ›´æ–°userè¡¨ã€‚ ä¸è¿‡ä¸Šè¿°çš„ä»£ç å…¶å®æœ‰é—®é¢˜ï¼Œå› ä¸ºæ¶ˆæ¯è¡¨æ˜¯å’Œtransactionè¡¨ä¸€èµ·çš„ï¼Œè·Ÿuserè¡¨åœ¨ä¸åŒçš„æ•°æ®åº“æœåŠ¡å™¨ä¸Šï¼Œå¦‚æœæŒ‰ç…§ä¸Šé¢é‚£ç§æ–¹æ³•ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸­æœ‰updateæ¶ˆæ¯è¡¨å’Œuserè¡¨ï¼Œåˆå›åˆ°äº†ä½¿ç”¨2PCã€‚ å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿè¿™é‡Œè¦å…ˆå¼•å…¥ä¸€ä¸ªæ¦‚å¿µï¼Œå¹‚ç­‰æ€§ã€‚ å¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œä¸€æ¬¡æˆ–å‡ æ¬¡çš„ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å¹‚ç­‰çš„ã€‚å¦‚æœä¸€ä¸ªæ“ä½œæ˜¯å¹‚ç­‰çš„ï¼Œé‚£ä¹ˆå¯ä»¥å®ç°ï¼šå³ä½¿æ“ä½œå¤±è´¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥é‡è¯•ç›´åˆ°æˆåŠŸï¼Œè€Œé‡è¯•ä¸ä¼šå½±å“æœ€ç»ˆç»“æœã€‚ æˆ‘ä»¬ä¸Šé¢çš„è¿™ä¸ªä¾‹å­åˆ™ä¸æ”¯æŒå¹‚ç­‰ï¼Œæ¯æ¬¡æ“ä½œéƒ½ä¼šæ”¹å˜è´­ä¹°é‡æˆ–é”€å”®é‡ã€‚æ€ä¹ˆè§£å†³å‘¢ï¼Ÿå¯ä»¥åœ¨userè¡¨æ‰€åœ¨æ•°æ®åº“æœåŠ¡å™¨ä¸Šå†åŠ ä¸€ä¸ªè¡¨ ç„¶åå°†SQLè¯­å¥æ”¹ä¸ºä¸‹é¢è¿™ç§ ä»ä¸Šé¢çš„SQLè¯­å¥ä¸­å¯ä»¥çœ‹å‡ºï¼Œmessageè¢«ç§»åˆ°äº†äº‹åŠ¡å¤–é¢ï¼Œè¿™æ ·ä½¿å¾—åªæœ‰åœ¨äº‹åŠ¡æ“ä½œæˆåŠŸçš„æ—¶å€™æ‰å°†å…¶ä»æ¶ˆæ¯è¡¨ä¸­ç§»é™¤ã€‚ å½“äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œåœ¨ç§»é™¤æ¶ˆæ¯è¡¨ä¹‹å‰å®•æœºï¼Œé‡å¯ä¹‹ååˆé‡æ–°æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯ã€‚è€Œäº‹åŠ¡ä¸­æœ‰å¯¹å·²æ¶ˆè´¹ä¿¡æ¯çš„åˆ¤æ–­ï¼Œä»è€Œè§£å†³äº†é‡å¤æ¶ˆè´¹çš„é—®é¢˜ã€‚è¿™æ ·ä¿è¯äº†æ•°æ®åœ¨æœ€åèƒ½è¾¾åˆ°ä¸€è‡´æ€§ã€‚ å‚è€ƒèµ„æ–™ https://queue.acm.org/detail.cfm?id=1394128 ","link":"https://jayying007.github.io/post/åŸºäºæ¶ˆæ¯è¡¨çš„åˆ†å¸ƒå¼äº‹åŠ¡/"},{"title":"ç®€è¿°åƒåœ¾å›æ”¶ç®—æ³•","content":"æ¦‚å¿µ åƒåœ¾å›æ”¶(Garbage Collection),ç®€ç§°GC,ä¸»è¦æ˜¯å¯¹é‚£äº›å·²ç»åˆ†é…çš„ç©ºé—´è¿›è¡Œå›æ”¶åˆ©ç”¨,å®ç°å†åˆ†é…. æ¯”å¦‚ä¸‹é¢çš„Javaä»£ç  public void test() { List&lt;Integer&gt; list = new ArrayList&lt;&gt;(); list.add(1); System.out.println(list); } åœ¨è¿™ä¸ªå‡½æ•°ä¸­,æˆ‘åˆ›å»ºäº†ä¸€ä¸ªArrayListå¯¹è±¡,Javaåˆ™åœ¨å†…å­˜å †ä¸Šä¸ºå…¶åˆ†é…ç©ºé—´.ä½†æ˜¯ä¸€æ—¦å‡ºäº†è¿™ä¸ªå‡½æ•°,æˆ‘ä»¬å°±å†ä¹Ÿè®¿é—®ä¸åˆ°è¿™å—ç©ºé—´äº†,å¦‚æœä¸è¿›è¡Œå›æ”¶,é‚£ä¹ˆå†…å­˜å †çš„è¿™ä¸ªä½ç½®å°±æµªè´¹äº†. æ‰€ä»¥GCè¦å®Œæˆçš„ä¸»è¦æœ‰ä¸¤ä»¶äº‹: æ‰¾åˆ°å†…å­˜ä¸­çš„åƒåœ¾ å›æ”¶è¿™éƒ¨åˆ†åƒåœ¾,ä»¥ä¾¿ä¹‹åå¯ä»¥å†åˆ†é… å…³äºå¯¹è±¡åœ¨å †ä¸Šçš„å¸ƒå±€ ä¸€èˆ¬ä¸€ä¸ªå¯¹è±¡åœ¨å †ä¸­å­˜å‚¨ä¸¤éƒ¨åˆ†ä¿¡æ¯,ä¸€éƒ¨åˆ†æ˜¯å¯¹è±¡çš„å…ƒæ•°æ®,æ¯”å¦‚å¯¹è±¡çš„å¤§å°,hashcodeçš„å€¼ä»¥åŠç”¨æ¥æ ‡è¯†åƒåœ¾å›æ”¶çš„ä¿¡æ¯ç­‰.å¦ä¸€éƒ¨åˆ†å°±æ˜¯å¯¹è±¡çš„å…·ä½“æ•°æ®.è¿™éƒ¨åˆ†ä¸»è¦åˆ†ä¸¤ç§,å¦‚æœæ˜¯åŸºæœ¬æ•°æ®ç±»å‹,é‚£ä¹ˆè¿™ä¸ªä½ç½®å­˜çš„å°±æ˜¯å®ƒçš„å€¼.å¦‚æœä¸æ˜¯,é‚£ä¹ˆè¿™ä¸ªä½ç½®å­˜æ”¾çš„æ˜¯æŒ‡å‘å…·ä½“å†…å­˜åœ°å€çš„æŒ‡é’ˆ. å¦‚ä½•æ‰¾åˆ°å†…å­˜ä¸­çš„åƒåœ¾ è¿™é‡Œé‡‡ç”¨å¯è¾¾æ€§åˆ†æ,é¦–å…ˆæˆ‘ä»¬ä¼šå°†ä¸€äº›å¯¹è±¡ä½œä¸ºæ ¹,è¿™äº›å¯¹è±¡æˆ‘ä»¬æŠŠå®ƒæ ‡è®°ä¸ºå¯è¾¾çš„,ç„¶åç”±è¿™äº›æ ¹æ‰€èƒ½æŒ‡å‘çš„å…¶ä»–å¯¹è±¡,æˆ‘ä»¬ä¹Ÿæ ‡è®°ä¸ºå¯è¾¾...è¿™æ ·ä¸€ç›´ä¼ é€’ä¸‹å»,åˆ°æœ€å,æˆ‘ä»¬å¯ä»¥éå†æ•´ä¸ªå †,ç„¶åæŠŠé‚£äº›ä¸å¯è¾¾çš„å¯¹è±¡ç»™å›æ”¶æ‰. å“ªäº›å¯¹è±¡å¯ä»¥ä½œä¸ºæ ¹å‘¢ ---&gt; è°ƒç”¨æ ˆã€å¯„å­˜å™¨ä»¥åŠå…¨å±€å˜é‡ ä¸è¿‡,è¿™äº›æ ¹å¯èƒ½è¿˜æœ‰æ½œåœ¨çš„é—®é¢˜. æ€ä¹ˆåˆ¤æ–­è¿™ä¸ªå€¼æ˜¯æŒ‡é’ˆçš„åœ°å€è¿˜æ˜¯ä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹å‘¢? å°±æ¦‚ç‡ä¸Šè®²,æ•°å€¼åˆšå¥½ä½äºå †åœ°å€èŒƒå›´å†…,ä¸”åˆšå¥½æ˜¯å¯¹è±¡å¤´çš„åœ°å€,æƒ…å†µè¿˜æ˜¯æ¯”è¾ƒå°‘çš„. æˆ‘ä»¬å¯ä»¥å°†é”™å°±é”™,ä¸è¿‡åœ¨è¿™ç§æƒ…å†µä¸‹,å¯èƒ½ä¸€ä¸ªæœ¬è¯¥å›æ”¶çš„å¯¹è±¡å°±è¢«æˆ‘ä»¬åˆ—ä¸ºæ ¹äº†. å½“å­˜åœ¨è²Œä¼¼æŒ‡é’ˆçš„éæŒ‡é’ˆæ—¶ï¼Œä¿å®ˆå¼GCä¼šæŠŠè¢«å¼•ç”¨çš„å¯¹è±¡é”™è¯¯è¯†åˆ«ä¸ºæ´»åŠ¨å¯¹è±¡ã€‚å¦‚æœè¿™ä¸ªå¯¹è±¡å­˜åœ¨å¤§é‡çš„å­å¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒä»¬ä¸€å¾‹éƒ½ä¼šè¢«çœ‹æˆæ´»åŠ¨å¯¹è±¡ è¦ä¸¥æ ¼åŒºåˆ«æŒ‡é’ˆä¸éæŒ‡é’ˆ,éœ€è¦è¯­è¨€å¤„ç†ç¨‹åºçš„ä¸€äº›æ”¯æŒ.è¿™ä¸€å—ä¸ä½œå±•å¼€. GCç®—æ³•è¯„ä»·æŒ‡æ ‡ ååé‡ å¦‚å †çš„å¤§å°ä¸ºHEAP_SIZE,GCæ€»å…±èŠ±è´¹çš„æ—¶é—´ä¸ºï¼ˆA+B+C),åˆ™ååé‡ä¸ºHEAP_SIZE/ï¼ˆA+B+Cï¼‰ã€‚ æœ€å¤§æš‚åœæ—¶é—´ æœ€å¤§æš‚åœæ—¶é—´æŒ‡çš„æ˜¯â€œå› æ‰§è¡ŒGCè€Œæš‚åœæ‰§è¡Œmutatorçš„æœ€é•¿æ—¶é—´â€,æ¯”å¦‚ä¸‹å›¾æŒ‡çš„å°±æ˜¯B. å¦‚æœæš‚åœæ—¶é—´å¤ªé•¿,å°±ä¼šå‡ºç°Stop-The-World å †ä½¿ç”¨æ•ˆç‡ ä¸åŒçš„GCç®—æ³•,ä¼šåœ¨å †ä¸­å¯¹è±¡çš„å¯¹è±¡å¤´å­˜æ”¾ä¸€äº›ä¿¡æ¯,å¤§å°ä¸ä¸€,æˆ–è€…ä¼šå°†å †åšåˆ’åˆ†. è®¿é—®çš„å±€éƒ¨æ€§ æˆ‘ä»¬çŸ¥é“è®¡ç®—æœºæ˜¯æœ‰é«˜é€Ÿç¼“å­˜è¿™ä¹ˆä¸ªä¸œè¥¿.ä¸€èˆ¬è€Œè¨€,å…·æœ‰å¼•ç”¨å…³ç³»çš„å¯¹è±¡ä¹‹é—´é€šå¸¸å¾ˆå¯èƒ½å­˜åœ¨è¿ç»­è®¿é—®çš„æƒ…å†µã€‚æ‰€ä»¥å¦‚æœåœ¨å †ä¸­è¿™ä¸¤ä¸ªå¯¹è±¡å­˜æ”¾ä½ç½®è¿ç»­,é‚£å½“è¯»å–ç¬¬ä¸€ä¸ªå¯¹è±¡æ—¶,åé¢çš„å¯¹è±¡ä¹Ÿè·Ÿç€è¢«è¯»è¿›äº†ç¼“å­˜,åç»­è®¿é—®çš„é€Ÿåº¦å°±åŠ å¿«äº†. GCç®—æ³•ä»‹ç» æ ‡è®°æ¸…é™¤ç®—æ³• è¿™ä¸ªå…¶å®åœ¨å‰é¢ä¹Ÿæœ‰æåˆ°,ä»æ ¹é›†åˆå‡ºå‘,å°†èƒ½è®¿é—®åˆ°çš„å¯¹è±¡æ‰“ä¸Šæ ‡è®°,ç„¶åéå†å †,å°†æ²¡æœ‰æ ‡è®°çš„å¯¹è±¡æ¸…é™¤.ä¼ªä»£ç æè¿°å¦‚ä¸‹: mark_sweep() { //æ ‡è®°é˜¶æ®µ for(r : $roots) { mark(*r) } //æ¸…é™¤é˜¶æ®µ sweeping = $heap_start while(sweeping &lt; $heap_end) if(sweeping.mark == TRUE) sweeping.mark = FALSE else sweeping.next = $free_list $free_list = sweeping sweeping += sweeping.size } //æ ‡è®°å‡½æ•° mark(obj) { if(obj.mark == FALSE) { obj.mark = TRUE for(child : children(obj)) mark(*child) } } è¿™ç§æ–¹å¼ä¸ä¼šæŒªåŠ¨å¯¹è±¡åœ¨å †ä¸­çš„ä½ç½®,ä½†æ˜¯å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡.å…³äºå›æ”¶åçš„å†…å­˜å¦‚ä½•åˆ†é…ä½¿ç”¨,å¯ä»¥æ‰¾æ›´ç›¸å…³çš„èµ„æ–™.æ¯”å¦‚å‚è€ƒmallocåº“çš„å®ç°,åœ¨&lt;&lt;æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ&gt;&gt;ä¸€ä¹¦ä¸­ä¹Ÿæœ‰æ‰€æ¶‰åŠ. å¼•ç”¨è®¡æ•°æ³• é¡¾åæ€ä¹‰,åœ¨å¯¹è±¡å¤´è®°å½•æœ‰å¤šå°‘ä¸ªå¼•ç”¨äº†è¿™ä¸ªå¯¹è±¡.å½“è®¡æ•°å˜ä¸º0çš„æ—¶å€™,æˆ‘ä»¬å°±å¯ä»¥ç«‹å³å¯¹è¿™éƒ¨åˆ†å†…å­˜è¿›è¡Œå›æ”¶. å®ƒçš„æœ€å¤§æš‚åœæ—¶é—´çŸ­,ä½†æ˜¯å­˜åœ¨å¤šä¸ªæ— ç”¨å¯¹è±¡å¾ªç¯å¼•ç”¨æ— æ³•é‡Šæ”¾å†…å­˜çš„é—®é¢˜. Pythonçš„GCé‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•,å¯ä»¥å»äº†è§£å®ƒå¦‚ä½•è§£å†³å¾ªç¯å¼•ç”¨çš„ æ ‡è®°å¤åˆ¶ç®—æ³• è¿™ç§ç®—æ³•æŠŠå †åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†,æ¯æ¬¡åˆ†é…å¯¹è±¡çš„æ—¶å€™åªä½¿ç”¨å…¶ä¸­ä¸€åŠ.å½“æ ‡è®°è¿‡ç¨‹ç»“æŸå,æŠŠå­˜æ´»çš„å¯¹è±¡å…¨éƒ½æŒªåˆ°å †çš„å¦ä¸€åŠä¸­. è¿™ç§çš„å¥½å¤„æ˜¯é¿å…äº†å†…å­˜ç¢ç‰‡,å› ä¸ºæ¯æ¬¡éƒ½æœ‰ä¸€æ•´å—çš„ç©ºé—²ç©ºé—´ç”¨äºåˆ†é…å¯¹è±¡.ä½†æ˜¾ç„¶å †çš„ä½¿ç”¨æ•ˆç‡é™ä½äº† æ³¨æ„ åœ¨è¿™ç§ç®—æ³•ä¸­,ç”±äºæŒªåŠ¨äº†å¯¹è±¡,æ‰€ä»¥åŸå…ˆæŒ‡å‘è¿™äº›å¯¹è±¡çš„æŒ‡é’ˆ,è¦åšä¸€ä¸ªæ˜ å°„,ä½¿å…¶è®¿é—®åˆ°æ–°çš„å†…å­˜ä½ç½®. è§£å†³æ–¹æ³•å¯ä»¥é‡‡ç”¨å¥æŸ„çš„æ–¹å¼é—´æ¥å¤„ç†å¯¹è±¡. (é‡‡ç”¨æŒ‡å‘æŒ‡é’ˆçš„æŒ‡é’ˆä¹Ÿå¯ä»¥) é€šè¿‡å¼•å…¥å¥æŸ„,å½“æˆ‘ä»¬ç§»åŠ¨å¯¹è±¡çš„æ—¶å€™,åªéœ€è¦ä¿®æ”¹å¥æŸ„é‡Œçš„æŒ‡é’ˆ,è€Œä¸ç”¨æ›´æ–°æ ¹çš„å€¼. æ ‡è®°æ•´ç†ç®—æ³• è¿™ç§ç®—æ³•å¯ä»¥ç†è§£ä¸ºå…ˆæ‰§è¡Œäº†æ ‡è®°æ¸…é™¤ç®—æ³•,ç„¶åæŠŠå­˜æ´»çš„å¯¹è±¡éƒ½æŒªåˆ°ä¸€èµ·,è¿™æ ·ç©ºé—²çš„ç©ºé—´å°±æ˜¯è¿ç»­çš„äº†. åŒæ ·çš„,ç”±äºç§»åŠ¨äº†å¯¹è±¡,æ‰€ä»¥æŒ‡é’ˆçš„è®¿é—®ä¹Ÿè¦åšäº›ä¿®æ”¹. åˆ†ä»£å›æ”¶ åœ¨å¯¹è±¡å¤´éƒ¨åˆ†å¤šäº†å¯¹è±¡çš„å­˜æ´»å¹´é¾„,æ®æ­¤åˆ’åˆ†äº†æ–°ç”Ÿä»£,è€å¹´ä»£å¯¹è±¡.åœ¨å †ä¸­ä¹Ÿæ˜¯åˆ’åˆ†å­˜å‚¨. æ ¹æ®ç»éªŒæ˜¾ç¤º,æ–°ç”Ÿä»£çš„å¯¹è±¡å­˜æ´»ç‡è¾ƒä½,æ‰€ä»¥è¿™éƒ¨åˆ†ä¼šæœ‰å¤§é‡å¯¹è±¡å›æ”¶.å¯¹è¿™éƒ¨åˆ†é‡‡å–æ ‡è®°å¤åˆ¶ç®—æ³•æ”¶ç›Šæ¯”è¾ƒå¥½; è€Œé’ˆå¯¹è€å¹´ä»£å¯¹è±¡,åˆ™é‡‡ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•. å½“éœ€è¦GCæ—¶,ä¼˜å…ˆä»æ–°ç”Ÿä»£å…¥æ‰‹. å½“æˆ‘ä»¬å¯¹æ–°ç”Ÿä»£è¿›è¡ŒGCæ—¶,å¦‚æœæœ‰è€å¹´ä»£çš„æŒ‡å‘æ–°ç”Ÿä»£çš„å¼•ç”¨,æ€ä¹ˆåŠ? å¦‚æœéå†è€å¹´ä»£å»æ ‡è®°,é‚£å…¶å®åˆè·Ÿéå†æ•´ä¸ªå †æ²¡åŒºåˆ«äº†. æ‰€ä»¥è¿™é‡Œå¼•å…¥äº†è®°å½•é›†å’Œå†™å…¥å±éšœ è®°å½•é›†ä¸Šé¢ä¿å­˜äº†è€å¹´ä»£å¯¹è±¡çš„æŒ‡é’ˆ. å®ƒæ˜¯åœ¨æˆ‘ä»¬æ›´æ–°å¯¹è±¡æŒ‡é’ˆçš„æ—¶å€™,é€šè¿‡å†™å…¥å±éšœçš„æ–¹å¼åŠ å…¥çš„. write_barrier(obj, field, new_obj) { if(obj &gt;= $old_start &amp;&amp; new_obj &lt; $old_start &amp;&amp; obj.remembered == FALSE) $rs[$rs_index] = obj $rs_index++ obj.remembered = TRUE *field = new_obj } å¦‚ä¸Šè¿°ä¼ªä»£ç é‚£æ ·,å½“è€å¹´ä»£å¯¹è±¡æœ‰æŸä¸ªå±æ€§æŒ‡å‘æ–°ç”Ÿä»£å¯¹è±¡æ—¶,å°†å…¶åŠ å…¥è®°å½•é›†ä¸­. è¿™æ ·çš„å¥½å¤„æ˜¯å½“æ–°ç”Ÿä»£å¯¹è±¡çš„å†…å­˜ä½ç½®ç§»åŠ¨æ—¶,èƒ½å¤ŸçŸ¥é“è¦æ›´æ–°å“ªä¸ªè€å¹´ä»£å¯¹è±¡çš„æŒ‡é’ˆ å¢é‡å¼åƒåœ¾å›æ”¶ ä¸Šé¢æåˆ°çš„GCéƒ½æœ‰ä¸€ä¸ªé—®é¢˜,å®ƒä»¬åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ä¼šé˜»å¡ä¸»çº¿ç¨‹,ç›´åˆ°åƒåœ¾å›æ”¶ç»“æŸ. è¿™é‡Œä¸»è¦è®²ä¸€ç§å¢é‡GCçš„ç®—æ³•,å®ƒçš„GCè¦åˆ†å¥½å‡ ä¸ªé˜¶æ®µå®Œæˆ,è¿™æ ·ä¿è¯æœ€å¤§æš‚åœæ—¶é—´å˜å°. ä¸‰è‰²æ ‡è®°ç®—æ³• è¿™æ˜¯Edsger W. Dijkstraç­‰äººæå‡ºçš„ä¸‰è‰²æ ‡è®°ç®—æ³•ï¼ˆTri-color markingï¼‰,å®ƒå°†æ¯ä¸ªå¯¹è±¡éƒ½æ ‡è®°äº†ä¸€ä¸ªé¢œè‰²: ç™½è‰²ï¼šè¿˜æœªæœç´¢è¿‡çš„å¯¹è±¡ ç°è‰²ï¼šæ­£åœ¨æœç´¢çš„å¯¹è±¡ é»‘è‰²ï¼šæœç´¢å®Œæˆçš„å¯¹è±¡ GCå¼€å§‹è¿è¡Œå‰æ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ç™½è‰²ã€‚GCä¸€å¼€å§‹è¿è¡Œï¼Œæ‰€æœ‰ä»æ ¹èƒ½åˆ°è¾¾çš„å¯¹è±¡éƒ½ä¼šè¢«æ ‡è®°ï¼Œç„¶åè¢«å †åˆ°æ ˆé‡Œã€‚GCåªæ˜¯å‘ç°äº†è¿™æ ·çš„å¯¹è±¡ï¼Œä½†è¿˜æ²¡æœ‰æœç´¢å®Œå®ƒä»¬ï¼Œæ‰€ä»¥è¿™äº›å¯¹è±¡å°±æˆäº†ç°è‰²å¯¹è±¡ã€‚ç°è‰²å¯¹è±¡ä¼šè¢«ä¾æ¬¡ä»æ ˆä¸­å–å‡ºï¼Œå…¶å­å¯¹è±¡ä¹Ÿä¼šè¢«æ¶‚æˆç°è‰²ã€‚å½“å…¶æ‰€æœ‰çš„å­å¯¹è±¡éƒ½è¢«æ¶‚æˆç°è‰²æ—¶ï¼Œå¯¹è±¡å°±ä¼šè¢«æ¶‚æˆé»‘è‰²ã€‚å½“GCç»“æŸæ—¶å·²ç»ä¸å­˜åœ¨ç°è‰²å¯¹è±¡äº†ï¼Œæ´»åŠ¨å¯¹è±¡å…¨éƒ¨ä¸ºé»‘è‰²ï¼Œåƒåœ¾åˆ™ä¸ºç™½è‰²ã€‚ å®ƒå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ: æ ¹æŸ¥æ‰¾é˜¶æ®µ,æ ‡è®°é˜¶æ®µ,æ¸…é™¤é˜¶æ®µ æ ¹æŸ¥æ‰¾é˜¶æ®µæŠŠèƒ½ç›´æ¥ä»æ ¹å¼•ç”¨çš„å¯¹è±¡æ¶‚æˆç°è‰²ã€‚ æ ‡è®°é˜¶æ®µæŸ¥æ‰¾ç°è‰²å¯¹è±¡ï¼Œå°†å…¶å­å¯¹è±¡ä¹Ÿæ¶‚æˆç°è‰²ï¼ŒæŸ¥æ‰¾ç»“æŸåå°†ç°è‰²å¯¹è±¡æ¶‚æˆé»‘è‰²ã€‚ æ¸…é™¤é˜¶æ®µåˆ™æŸ¥æ‰¾å †ï¼Œå°†ç™½è‰²å¯¹è±¡è¿æ¥åˆ°ç©ºé—²é“¾è¡¨ï¼Œå°†é»‘è‰²å¯¹è±¡å˜å›ç™½è‰². // åœ¨æ ‡è®°,æ¸…é™¤é˜¶æ®µä¸­,å…¶éƒ½æ˜¯å¢é‡å¼çš„,å³æ¯æ¬¡åªæ ‡è®°æˆ–æ¸…é™¤ä¸€å®šæ•°é‡çš„å¯¹è±¡ååˆ‡å›ä¸»çº¿ç¨‹. è¿™é‡Œè¿˜æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹. é—®é¢˜1 å¦‚å›¾,å½“Aæ ‡è®°å®Œæ‰€æœ‰å­å¯¹è±¡å,è‡ªå·±å˜é»‘. æ­¤æ—¶åˆ‡æ¢å›ä¸»çº¿ç¨‹,ç„¶åä¸»çº¿ç¨‹çš„ä»£ç åšäº†ä¸ªæ“ä½œ,å°†B--Cä¹‹é—´çš„å¼•ç”¨åˆ æ‰,ç„¶ååŠ äº†A--Cçš„å¼•ç”¨. è¿™æ—¶å†å›æ¥GCçš„æ—¶å€™,ç”±äºAå·²ç»é»‘äº†,æ‰€ä»¥ä¸ä¼šå†å¯¹å…¶å­å¯¹è±¡åšæ ‡è®°, è¿™æ ·å°±ä¼šé”™è¿‡å¯¹è±¡C, è¿™æ ·ä¼šè¯¯å›æ”¶å¯¹è±¡!! è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•åŒæ ·ä½¿ç”¨å†™å…¥å±éšœ, åœ¨æ·»åŠ AæŒ‡å‘Cçš„å¼•ç”¨æ—¶, å¦‚æœCæ˜¯ç™½è‰²çš„,å°±å°†å…¶æ ‡é»‘. write_barrier(obj, field, newobj) { if(newobj.mark == FALSE) { newobj.mark = TRUE push(newobj, $mark_stack) } *field = newobj } é—®é¢˜2 å¦‚å›¾,å½“GCå¼€å§‹æ¸…é™¤é˜¶æ®µæ—¶,å®ƒä¼šæŠŠæ²¡æœ‰æ ‡é»‘çš„å¯¹è±¡ç»™æ¸…é™¤æ‰. å¦‚æœè¿™æ—¶åˆ‡æ¢å›ä¸»çº¿ç¨‹,è€Œæˆ‘ä»¬åˆè¦åˆ†é…æ–°çš„å¯¹è±¡æ—¶å°±è¦æ³¨æ„äº†, å¦‚æœåˆ†é…çš„æ–°å¯¹è±¡ä½ç½®åœ¨$sweepingçš„å³è¾¹, é‚£æˆ‘ä»¬è¦æŠŠæ–°åˆ†é…çš„å¯¹è±¡ç»™æ ‡æˆé»‘è‰²çš„,ä»¥é˜²è¢«è¯¯æ¸…é™¤. å‚è€ƒèµ„æ–™ &lt;&lt;åƒåœ¾å›æ”¶çš„ç®—æ³•ä¸å®ç°&gt;&gt; ----- [æ—¥]ä¸­æ‘æˆæ´‹ï¼Œ[æ—¥]ç›¸å·å…‰ ","link":"https://jayying007.github.io/post/ç®€è¿°åƒåœ¾å›æ”¶ç®—æ³•/"},{"title":"è‡ªå·±æ‰‹åŠ¨ç”ŸæˆäºŒç»´ç ","content":"è™½ç„¶ç”ŸæˆäºŒç»´ç ä¸æ˜¯ä»€ä¹ˆéš¾äº‹ï¼Œæ¯•ç«Ÿæœ‰é‚£ä¹ˆå¤šè½®å­ï¼Œå·¥ä½œä¸­ä½ å°±æ˜¯è°ƒä¸€ä¸‹SDKï¼Œå¹¶ä¸ä¼šå»å…³å¿ƒå®ƒå…·ä½“æ€ä¹ˆå®ç°çš„ï¼ˆæ¯”å¦‚zxingç®—ä¸€ä¸ªï¼Œä¸æƒ³éº»çƒ¦çš„å¯ä»¥ç”¨è¿™ä¸ªï¼‰ã€‚ä½†æ˜¯ä¸¤ä¸‰è¡Œè°ƒç”¨åˆ«äººçš„ä»£ç å°±å®Œäº‹æ„Ÿè§‰æ²¡ä»€ä¹ˆæ„æ€ï¼Œå…¶å®è¿˜æ˜¯æƒ³æŠ˜è…¾ã€‚ å¦‚æœå¯¹äºŒç»´ç çš„åŸç†ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥å‚è€ƒæˆ‘è½¬è½½çš„è¿™ç¯‡åšå®¢https://blog.csdn.net/qq_17190121/article/details/104715136 åšä¸»å†™å¾—å¾ˆæ¸…æ¥šäº†ï¼Œçœ‹ä¸€ä¸¤éç„¶åå°±æ‡‚äº† æ‰¾ä¸åˆ°å®˜æ–¹æ–‡æ¡£ï¼Œè²Œä¼¼ISOè¦æ”¶è´¹ã€‚ã€‚ç„¶åå°±åœ¨ç™¾åº¦æ–‡åº“ä¸­æ‰¾äº†ä¸­æ–‡ç‰ˆçš„https://wenku.baidu.com/view/ef77275f312b3169a451a4a4.html?pn=50 è‡ªæˆ‘æ„Ÿè§‰ä»£ç å†™å¾—ä¸€èˆ¬ï¼Œä½†é€»è¾‘å¾ˆæ¸…æ™°ï¼ŒåŸºæœ¬æ­¥éª¤å¦‚å›¾ å…¶å®ä¸Šé¢è¿™ä¸ªå›¾æ˜¯åœ¨å†™ä»£ç å‡ºç°bugæ—¶æƒ³åˆ°çš„ä¸€ä¸ªåŠæ³•ï¼Œå—¯...ï¼Œè¿˜æŒºå¥½çœ‹çš„ å› ä¸ºç›®çš„æ˜¯ç”¨æ‰‹æœºæ‰«ç ï¼Œæ‰€ä»¥äºŒç»´ç çš„è§„æ ¼ä¸ç”¨ç‰¹åˆ«å¤§ï¼Œä¸€èˆ¬åªéœ€è¦å­˜ä¸€ä¸ªç½‘ç«™çš„åœ°å€å³å¯ï¼Œå¾®ä¿¡/æ”¯ä»˜å®æ‰«åˆ°äºŒç»´ç æ—¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°è¿™ä¸ªç½‘å€ã€‚ æˆ‘è¿™é‡Œç”¨çš„è§„æ ¼ ç‰ˆæœ¬ çº é”™ç­‰çº§ ç¼–ç æ–¹å¼ 6 H Byte Mode å‚è€ƒæ–‡æ¡£ä½ç½® åˆå§‹åŒ–æ•°æ® # ç›¸å…³ä¿¡æ¯ self.version = 6 # Hçº é”™ç­‰çº§çš„æŒ‡ç¤ºç ï¼Œç‰ˆæœ¬6çš„å­—èŠ‚æ•°ï¼Œåˆ’åˆ†æ•°æ®å—æ•°ï¼Œæ¯å—æ•°æ®æ•°ï¼Œæ¯å—çº é”™æ•° self.relate_info = {'err_code': '10', 'total_bytes': 172, 'number_of_block': 4, 'per_block_data': 15, 'per_block_err': 28} # å¯¹é½å›¾æ¡ˆä¸­å¿ƒç‚¹ä½ç½® self.align_pos = 34 self.size = 21 + (self.version - 1) * 4 # 0è¡¨ç¤ºç™½ï¼Œ1è¡¨ç¤ºé»‘ï¼Œ2è¡¨ç¤ºæœªä½¿ç”¨ self.pattern = np.ones([self.size, self.size], dtype=int) * 2 self.data = data # æ ¼å¼ï¼š{'000':[[1,0,0,1]...[0,1,1,0],'001':...} self.masking_pattern = None self.masking_coding = None self.draw = True ç»˜åˆ¶å®šä½å›¾æ¡ˆ ç‰ˆæœ¬ç¡®å®šäº†ï¼Œä½ç½®ä¹Ÿå°±ç¡®å®šäº† def get_position_pattern(self): # ç”»å¥½ä¸€ä¸ªå®šä½å›¾æ¡ˆ position_pattern = np.ones([7, 7], dtype=int) for i in range(1, 6): for j in range(1, 6): if i == 1 or i == 5: position_pattern[i][j] = 0 continue if j == 1 or j == 5: position_pattern[i][j] = 0 continue # æ”¾åœ¨ä¸‰ä¸ªä½ç½® for i in range(0, 7): for j in range(0, 7): self.pattern[i][j] = position_pattern[i][j] self.pattern[i][j + self.size - 7] = position_pattern[i][j] self.pattern[i + self.size - 7][j] = position_pattern[i][j] if self.draw: self.dynamic_draw() ç»˜åˆ¶å®šä½å›¾æ¡ˆç™½è¾¹ def get_position_round_pattern(self): for i in range(0, 8): self.pattern[i][7] = 0 self.pattern[7][i] = 0 self.pattern[i][self.size - 8] = 0 self.pattern[self.size - 8][i] = 0 self.pattern[i + self.size - 8][7] = 0 self.pattern[7][i + self.size - 8] = 0 if self.draw: self.dynamic_draw() ç»˜åˆ¶å¯¹é½å›¾æ¡ˆ def get_alignment_pattern(self): # ç”»å¥½ä¸€ä¸ªå¯¹é½å›¾æ¡ˆ alignment_pattern = np.ones([5, 5], dtype=int) for i in range(1, 4): for j in range(1, 4): if i == 1 or i == 3: alignment_pattern[i][j] = 0 continue if j == 1 or j == 3: alignment_pattern[i][j] = 0 continue # åªæ”¾ç½®åœ¨ä¸€ä¸ªä½ç½® for i in range(0, 5): for j in range(0, 5): self.pattern[i + self.align_pos - 2][j + self.align_pos - 2] = alignment_pattern[i][j] if self.draw: self.dynamic_draw() ç»˜åˆ¶æ—¶åºå›¾æ¡ˆ def get_timing_pattern(self): fill_black = True for i in range(8, self.size - 7): if fill_black: self.pattern[6][i] = 1 self.pattern[i][6] = 1 else: self.pattern[6][i] = 0 self.pattern[i][6] = 0 fill_black = not fill_black if self.draw: self.dynamic_draw() ç»˜åˆ¶ä¸´æ—¶çš„æ ¼å¼å›¾æ¡ˆ ä¸»è¦æ˜¯ä¸ºäº†å å‘ï¼Œè®©åé¢å¡«å……æ•°æ®çš„æ“ä½œæ›´ç®€å• def get_tmp_format_pattern(self): # å³ä¸Šè§’0-7 for i in range(0, 8): self.pattern[8][self.size - 1 - i] = 0 # å·¦ä¸‹è§’8-14 for i in range(0, 7): self.pattern[self.size - 7 + i][8] = 0 # å›ºå®šé»‘ç‚¹ self.pattern[self.size - 8][8] = 0 # å·¦ä¸Šè§’éƒ¨åˆ† for i in range(0, 6): self.pattern[i][8] = 0 for i in range(0, 6): self.pattern[8][5 - i] = 0 # ä½ç½®æ˜¯å›ºå®šçš„ self.pattern[7][8] = 0 self.pattern[8][8] = 0 self.pattern[8][7] = 0 ç»˜åˆ¶ç‰ˆæœ¬å›¾æ¡ˆ è¿™ä¸ªç‰ˆæœ¬åˆšå¥½ä¸ç”¨ï¼Œç‰ˆæœ¬7ä»¥ä¸Šæ‰éœ€è¦ def get_version_pattern(self): # version7åŠä»¥ä¸Šæ‰æœ‰ pass è·å–æ©è†œå›¾æ¡ˆ è¿™ä¸ªç‰ˆæœ¬æ˜¯é•¿è¿™æ ·çš„ çœ‹çœ‹å¦‚ä½•ç”Ÿæˆè¿™ä¹ˆå¥‡æ€ªçš„å½¢çŠ¶ def get_masking_area(self): masking_area = np.zeros([self.size, self.size], dtype=int) for i in range(self.size): for j in range(self.size): if self.pattern[i][j] == 2: masking_area[i][j] = 1 return masking_area def get_masking_pattern(self): # å…«ä¸ªæ¨¡æ¿ masking_array = {} masking_area = self.get_masking_area() ########## code = &quot;000&quot; masking = np.zeros([self.size, self.size], dtype=int) for i in range(self.size): for j in range(self.size): if (i + j) % 2 == 0: masking[i][j] = masking_area[i][j] masking_array[code] = masking ########## code = &quot;001&quot; masking = np.zeros([self.size, self.size], dtype=int) for i in range(self.size): for j in range(self.size): if i % 2 == 0: masking[i][j] = masking_area[i][j] masking_array[code] = masking ########## code = &quot;010&quot; masking = np.zeros([self.size, self.size], dtype=int) for i in range(self.size): for j in range(self.size): if j % 3 == 0: masking[i][j] = masking_area[i][j] masking_array[code] = masking ########## code = &quot;011&quot; masking = np.zeros([self.size, self.size], dtype=int) for i in range(self.size): for j in range(self.size): if (i + j) % 3 == 0: masking[i][j] = masking_area[i][j] masking_array[code] = masking ########## code = &quot;100&quot; masking = np.zeros([self.size, self.size], dtype=int) for i in range(self.size): for j in range(self.size): # è¿™é‡Œæœ‰ä¸€ç‚¹å‘,ä¸è½¬ä¸ºintä¼šå˜æˆfloat+float if (int(i / 2) + int(j / 3)) % 2 == 0: masking[i][j] = masking_area[i][j] masking_array[code] = masking ########## code = &quot;101&quot; masking = np.zeros([self.size, self.size], dtype=int) for i in range(self.size): for j in range(self.size): if ((i * j) % 2 + (i * j) % 3) == 0: masking[i][j] = masking_area[i][j] masking_array[code] = masking ########## code = &quot;110&quot; masking = np.zeros([self.size, self.size], dtype=int) for i in range(self.size): for j in range(self.size): if ((i * j) % 2 + (i * j) % 3) % 2 == 0: masking[i][j] = masking_area[i][j] masking_array[code] = masking ########## code = &quot;111&quot; masking = np.zeros([self.size, self.size], dtype=int) for i in range(self.size): for j in range(self.size): if ((i * j) % 3 + (i + j) % 2) % 2 == 0: masking[i][j] = masking_area[i][j] masking_array[code] = masking self.masking_pattern = masking_array å¡«å……æœ€åˆçš„æ•°æ® def fill_data(self): # å³ä¸‹è§’å¼€å§‹å¡«å……ï¼Œå…ˆå³åå·¦ï¼Œè›‡å½¢èµ°ä½ x = self.size - 1 y = self.size - 1 pos_right = True direct = 1 # 0å‘ä¸‹ 1å‘ä¸Š index = 0 data = _rsEncode(self.data, self.relate_info['per_block_data'], self.relate_info['number_of_block'], self.relate_info['per_block_err']) remainder = 7 while index &lt; len(data) + remainder: if self.pattern[x][y] == 2: if index &lt; len(data): self.pattern[x][y] = int(data[index]) # æŠŠå‰©ä¸‹7ä¸ªç©ºç™½è¡¥ä¸Š--ç‰ˆæœ¬6å‰©ä¸‹7ä¸ªç©ºç™½ä½ç½® else: self.pattern[x][y] = 0 index = index + 1 if pos_right: y = y - 1 else: x = x + (-1) ** direct y = y + 1 pos_right = not pos_right # å‘ä¸Šé£å‡ºå¤©äº† if x &lt; 0: direct = 0 x = 0 y = y - 2 # åˆšå¥½ç¢°åˆ°æ—¶åºçº¿,è¿™ä¸ªçš„ä½ç½®å›ºå®šyä¸º6ï¼Œè¦å·¦ç§»ä¸€æ ¼ if y == 6: y = y - 1 # å‘ä¸‹é’»å‡ºåœ°äº† if x &gt; 40: direct = 1 x = 40 y = y - 2 if self.draw: self.dynamic_draw() ä¸æ‰€æœ‰æ©è†œåšå¼‚æˆ–ï¼Œé€‰æ‹©å¤„ç½šæœ€ä½çš„ è¿™é‡Œçš„è¯„ä»·ä¸€å¼€å§‹ä»£ç å†™çš„å¾ˆæ™•ï¼Œå› ä¸ºä¸­æ–‡æ–‡æ¡£çš„è¡¨è¿°ä¸æ˜¯å¾ˆæ¸…æ¥šã€‚æ‰€ä»¥æˆ‘æ‰¾äº†è‹±æ–‡çš„æ¥çœ‹ï¼Œå®ƒä¸‹é¢æœ‰è¯¦ç»†çš„è§£é‡Šï¼Œç†è§£èµ·æ¥å®¹æ˜“å¾ˆå¤š def find_best_masking_and_set(self): coding = '' score = 0 for key in self.masking_pattern.keys(): mask_score = self.get_mask_score(self.masking_pattern[key], key) print(key, mask_score) if coding == '': coding = key score = mask_score else: if score &gt; mask_score: score = mask_score coding = key self.masking_coding = coding # set # å¯ä»¥é’ˆå¯¹å»è°ƒæ•´è¯„ä»·ç®—æ³• masking_pattern = self.masking_pattern[coding] # æ‰§è¡Œå¼‚æˆ–æ“ä½œ for i in range(self.size): for j in range(self.size): self.pattern[i][j] = masking_pattern[i][j] ^ self.pattern[i][j] if self.draw: self.dynamic_draw() self.get_format_pattern() def get_mask_score(self, masking_pattern, key): array = np.zeros([self.size, self.size], dtype=int) self.masking_coding = key self.get_format_pattern() # æ‰§è¡Œå¼‚æˆ–æ“ä½œ for i in range(self.size): for j in range(self.size): array[i][j] = masking_pattern[i][j] ^ self.pattern[i][j] n1 = 0 n2 = 0 n3 = 0 n4 = 0 # æ¨ªç«–å­˜é»‘ç™½ç›¸é—´æ¬¡æ•°çš„æ•°ç»„ row_interval = [] col_interval = [] # æ¨ªç«–è¿ç»­5ä¸ªä»¥ä¸Šé¢œè‰²ç›¸åŒï¼Œåˆ†æ•°ï¼šä¸ªæ•°-2 i = 0 while i &lt; self.size: j = 0 interval = [] while j &lt; self.size: times = 0 k = j while k &lt; self.size and array[i][k] == array[i][j]: k = k + 1 times = times + 1 interval.append(times) if times &gt;= 5: n1 = n1 + times - 2 j = k i = i + 1 row_interval.append(interval) i = 0 while i &lt; self.size: j = 0 interval = [] while j &lt; self.size: times = 0 k = j while k &lt; self.size and array[k][i] == array[j][i]: k = k + 1 times = times + 1 interval.append(times) if times &gt;= 5: n1 = n1 + times - 2 j = k i = i + 1 col_interval.append(interval) # å­˜åœ¨2X2é¢œè‰²ç›¸åŒçš„å— for i in range(self.size - 1): for j in range(self.size - 1): if array[i][j] == array[i + 1][j] and array[i][j] == array[i][j + 1]: if array[i][j] == array[i + 1][j + 1]: n2 = n2 + 3 # æ¨ªç«–å‡ºç°1:1:3:1:1 çš„é»‘ç™½é»‘ç™½é»‘ï¼Œä¸”å‰é¢æˆ–åé¢æœ‰4ä¸ªä»¥ä¸Šç™½ for i in range(self.size): if array[i][0] == 1: first_dark = True else: first_dark = False # bug warning for j in range(1, len(row_interval[i])-5): if row_interval[i][j] == row_interval[i][j+1] and row_interval[i][j]*3 == row_interval[i][j+2]: if row_interval[i][j] == row_interval[i][j+3] and row_interval[i][j] == row_interval[i][j+4]: if row_interval[i][j-1] &gt;= 4 and not first_dark: n3 = n3 + 40 first_dark = not first_dark continue if row_interval[i][j+5] &gt;= 4 and not first_dark: n3 = n3 + 40 first_dark = not first_dark continue for i in range(self.size): if array[0][i] == 1: first_dark = True else: first_dark = False # bug warning for j in range(1, len(col_interval[i])-5): if col_interval[i][j] == col_interval[i][j+1] and col_interval[i][j]*3 == col_interval[i][j+2]: if col_interval[i][j] == col_interval[i][j+3] and col_interval[i][j] == col_interval[i][j+4]: if col_interval[i][j-1] &gt;= 4 and not first_dark: n3 = n3 + 40 first_dark = not first_dark continue if col_interval[i][j+5] &gt;= 4 and not first_dark: n3 = n3 + 40 first_dark = not first_dark continue # é»‘è‰²å—çš„æ•°é‡ dark_num = array.sum() dark_rate = dark_num * 100 / (self.size * self.size) n4 = n4 + int(math.fabs(dark_rate - 50) / 5) * 10 return n1 + n2 + n3 + n4 def get_format_pattern(self): code = int(self.relate_info['err_code'] + self.masking_coding, 2) format_code = '{:015b}'.format(_fmtEncode(code)) # é»˜è®¤é«˜ä½åœ¨å‰ï¼Œåè½¬ä¸€ä¸‹ format_code = format_code[::-1] # å³ä¸Šè§’0-7 for i in range(0, 8): self.pattern[8][self.size - 1 - i] = int(format_code[i]) # å·¦ä¸‹è§’8-14 for i in range(0, 7): self.pattern[self.size - 7 + i][8] = int(format_code[i + 8]) # å›ºå®šé»‘ç‚¹ self.pattern[self.size - 8][8] = 1 # å·¦ä¸Šè§’éƒ¨åˆ† for i in range(0, 6): self.pattern[i][8] = int(format_code[i]) self.pattern[8][5 - i] = int(format_code[9 + i]) # ä½ç½®æ˜¯å›ºå®šçš„ self.pattern[7][8] = int(format_code[6]) self.pattern[8][8] = int(format_code[7]) self.pattern[8][7] = int(format_code[8]) æœ€åè°ƒç”¨ç”»å›¾ï¼Œçœ‹çœ‹è‡ªå·±åšçš„äºŒç»´ç  def dynamic_draw(self): self.show() plt.pause(0.001) plt.clf() def show(self): pic = np.zeros([self.size, self.size], dtype=int) for i in range(self.size): for j in range(self.size): if self.pattern[i][j] == 1: pic[i][j] = 0 elif self.pattern[i][j] == 0: pic[i][j] = 255 else: pic[i][j] = 200 plt.imshow(pic, cmap=&quot;gray&quot;) plt.axis('off') plt.show() logoæ˜¯æˆ‘åæœŸåŠ ä¸Šå»çš„ã€‚ã€‚ã€‚ å…³äºå…¶ä¸­æ¶‰åŠåˆ°çš„ä¸¤ç§ç¼–ç  ç¼–æ•°æ®çš„ç”¨åˆ°çš„é‡Œå¾·-æ‰€ç½—é—¨ç ï¼šè¿™é‡Œç”¨äº†ç¬¬ä¸‰æ–¹åº“ï¼Œè™½ç„¶ç½‘ä¸Šä¹Ÿèƒ½æ‰¾åˆ°æºä»£ç ï¼Œä½†æœ‰å‡ åè¡Œï¼Œæˆ‘å°±ä¸æ·»åŠ äº†ï¼Œç›´æ¥ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œä¸€ä¸¤è¡Œä»£ç æå®š ç¼–æ ¼å¼ç”¨åˆ°çš„BCHç ï¼šä»£ç æœ‰ç‚¹å°‘ï¼Œæ‰€ä»¥ç”¨äº†æºç  from reedsolo import RSCodec def _fmtEncode(fmt): &quot;&quot;&quot;Encode the 15-bit format code using BCH code.&quot;&quot;&quot; g = 0x537 code = fmt &lt;&lt; 10 for i in range(4, -1, -1): if code &amp; (1 &lt;&lt; (i + 10)): code ^= g &lt;&lt; i return ((fmt &lt;&lt; 10) ^ code) ^ 0b101010000010010 def _rsEncode(data, per_block_data, number_of_block, per_block_err): # Byte mode prefix 0100. bitstring = '0100' # Character count in 8 binary bits. bitstring += '{:08b}'.format(len(data)) # Encode every character in ISO-8859-1 in 8 binary bits. for c in data: bitstring += '{:08b}'.format(ord(c.encode('iso-8859-1'))) # Terminator 0000. bitstring += '0000' res = list() # Convert string to byte numbers. while bitstring: res.append(int(bitstring[:8], 2)) bitstring = bitstring[8:] total_data_length = per_block_data * number_of_block # Add padding pattern. while len(res) &lt; total_data_length: res.append(int('11101100', 2)) res.append(int('00010001', 2)) # Slice to 60 bytes for V6-H. res = res[:total_data_length] ecc = RSCodec(per_block_err) blocks = [] for i in range(number_of_block): block = ecc.encode(res[:per_block_data]) blocks.append(block) res = res[per_block_data:] # å…ˆæ‹¼æ¥æ•°æ®ï¼Œå†æ‹¼æ¥çº é”™ç¼–ç  final_res = '' # å¦‚æœä½¿ç”¨å…¶ä»–ç‰ˆæœ¬ï¼Œå¯èƒ½ä¸åŒæ•°æ®å—é•¿åº¦ä¸åŒï¼Œè¯·æ³¨æ„ï¼Œè¿™é‡Œå››ä¸ªæ•°æ®å—é•¿åº¦éƒ½æ˜¯43 for i in range(per_block_data): for j in range(4): final_res = final_res + '{:08b}'.format(blocks[j][i]) for i in range(per_block_data, per_block_data+per_block_err): for j in range(4): final_res = final_res + '{:08b}'.format(blocks[j][i]) return final_res æ³¨æ„ï¼šBCHç æœ€åå†™å›å­—ç¬¦ä¸²æ—¶çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯äºŒè¿›åˆ¶çš„é«˜ä½ï¼Œæ‰€ä»¥è¦åè½¬ä¸€ä¸‹ æ•°æ®è¿›è¡Œç¼–ç æ—¶ï¼Œæœ€ç»ˆæ•°æ® = 4ä½ç¼–ç æ ¼å¼ + å­—ç¬¦é•¿åº¦(è¿™é‡Œåˆšå¥½æ˜¯8ä½) + åŸæ•°æ®çš„äºŒè¿›åˆ¶ + 4ä½ç»“æŸç¬¦ åˆ†å—æ—¶ï¼Œå°†æœ€ç»ˆæ•°æ®åˆ†æˆè‹¥å¹²ä»½ï¼Œå†å„è‡ªè¿›è¡Œé‡Œå¾·-æ‰€ç½—é—¨ç çš„ç¼–ç ï¼Œç„¶åå†æŒ‰è§„å®šé¡ºåºé‡æ–°ç»„åˆæ’åˆ— æ€»ç»“ ä»£ç ï¼šhttps://github.com/jayying007/QR_Code å‰ä¸¤å¤©ä¸€çªä¸é€šï¼Œåªè§‰å¾—äºŒç»´ç æŒºæœ‰è¶£çš„ï¼Œæœ‰ç‚¹åƒå¯†ç å­¦ï¼Œåˆ°ä»Šå¤©æ‰å¤§è‡´ç†è§£å…¶åŸç† åæœŸä¸¤ç§çº é”™ç¼–ç å¯ä»¥å»äº†è§£ä¸€ä¸‹ åæœŸå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¦‚æ·»åŠ logoï¼Œæ›´æ”¹å½¢çŠ¶å’Œé¢œè‰²ç­‰ï¼Œåªè¦èƒ½è¯†åˆ«å°±å¯ä»¥ å…¶å®è¿™åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œåé¢è¿˜æœ‰ä¸¤æ­¥ï¼šæ‹ç…§æ—¶å®šä½åˆ°äºŒç»´ç å¹¶åšé¢„å¤„ç†ï¼Œå°†äºŒç»´ç è¿˜åŸä¸ºåŸå§‹ä¿¡æ¯ ä¸­é—´æœ‰é‡åˆ°å¾ˆéš¾ç†è§£çš„éƒ¨åˆ†ï¼Œä¹Ÿæƒ³è¿‡æ”¾å¼ƒï¼ˆé‚£ä¼šè¦å‡†å¤‡å®ä¹ ï¼Œå¾—ç–¯ç‹‚è¡¥çŸ¥è¯†ï¼‰ï¼Œä½†å¥½åœ¨åšæŒäº†ä¸‹æ¥ï¼ŒèŠ±è´¹äº†ä¸¤å¤©å¤šæ—¶é—´æˆ‘è§‰å¾—å€¼ã€‚ ","link":"https://jayying007.github.io/post/è‡ªå·±æ‰‹åŠ¨ç”ŸæˆäºŒç»´ç /"},{"title":"å¿«é€Ÿå¹‚","content":"â€‹ ä»Šå¤©ä»‹ç»ä¸€ä¸ªåœ¨ä¸­ä½éš¾åº¦ç®—æ³•ç«èµ›ä¸­ç»å¸¸ç¢°åˆ°çš„ç®—æ³•---å¿«é€Ÿå¹‚ï¼Œäºæ­¤ç›¸åŒ¹é…çš„è¿˜æœ‰ä¸€ä¸ªå«çŸ©é˜µå¿«é€Ÿå¹‚çš„ä¸œè¥¿ã€‚ä¸è¿‡è¿™ç¯‡æ–‡ç« åªä»‹ç»å¿«é€Ÿå¹‚ï¼ŒçŸ©é˜µå¿«é€Ÿå¹‚åªæ˜¯æŠŠä¸¤ä¸ªæ•°çš„ä¹˜æ³•æ¢æˆä¸¤ä¸ªçŸ©é˜µçš„ä¹˜æ³•è€Œå·²ã€‚ å¿«é€Ÿå¹‚ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¿«é€Ÿæ±‚è§£æŸä¸€ä¸ªæ•°çš„æŒ‡æ•°æ¬¡æ–¹ç»“æœä¸ºå¤šå°‘ã€‚ æ™®é€šæ±‚è§£ å¦‚è®©ä½ æ±‚2^5æ¬¡æ–¹ï¼Œä½ å¯ä»¥å¾ˆå¿«è®¡ç®—å‡ºç»“æœä¸º2*2*2*2*2=32ã€‚ è¿™ç§æ–¹å¼åœ¨è®¡ç®—æœºä¸­å¯ä»¥ä½¿ç”¨powå‡½æ•°è§£å†³ï¼Œå³powï¼ˆ2,5ï¼‰=32ã€‚å¼•å…¥å¤´æ–‡ä»¶cmathå°±è¡Œäº†ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æ‰‹å†™ã€‚ powå‡½æ•°çš„å®ç°æ–¹å¼å¤§è‡´å¦‚ä¸‹ typedef long long ll; ll pow(ll a,ll b,ll c) { ll d=1; while(b--){ d=d*a%c; } return d; } ä¸éš¾çœ‹å‡ºï¼Œè¿™ç§è®¡ç®—æ–¹å¼çš„é€Ÿåº¦æ˜¯ç”±bå†³å®šçš„ï¼Œå³æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆbï¼‰ï¼Œè€Œå¦‚æœbå¾ˆå¤§çš„ï¼Œé‚£å°±è¶…æ—¶äº†å•Šï¼ å¿«é€Ÿå¹‚ ä¸‹é¢å°±è¿›å…¥æœ¬èŠ‚çš„ä¸»è¦å†…å®¹ï¼Œç”¨å¿«é€Ÿå¹‚æ±‚è§£ï¼Œè¿™å…¶å®æ˜¯å¯¹äºŒè¿›åˆ¶çš„å·§å¦™ä½¿ç”¨ã€‚ è®²ä¸€ä¸ªä¾‹å­ï¼Œç°åœ¨è¦æ±‚311ï¼ŒæŒ‰ä¸Šè¿°æ–¹æ³•éœ€è¦è®¡ç®—11æ¬¡ï¼Œä½†å¿«é€Ÿå¹‚å¯ä»¥å°†æ±‚311ç®€åŒ–ä¸º(38)*(32)*(3^1)ï¼Œè¿™æ ·å°±åªè®¡ç®—äº†3æ¬¡ï¼Œå…¶å®æ€»å…±æ¯”è¾ƒäº†4æ¬¡ï¼Œå¾€ä¸‹çœ‹å°±æ‡‚äº†ã€‚ æ¥ä¸€æ³¢åˆ†æï¼š å°†æŒ‡æ•°11è½¬åŒ–ä¸ºäºŒè¿›åˆ¶ï¼Œå³00...001011ï¼ˆ32ä½ï¼Œå‰é¢çš„0æˆ‘å°±çœç•¥ä¸å†™äº†ï¼Œå¤ªå¤šå®¹æ˜“çœ‹ä¹±ï¼‰ ä»å³åˆ°å·¦å¼€å§‹ï¼Œ32ä½çš„01ä¸²æˆ‘ä»¬åœ¨ä¸‹é¢ç»™å®ƒä»¬ä¸€ä¸ªæ•°å€¼æ ‡è¯†ï¼Œä»3^1å¼€å§‹ï¼Œä»¥å¹³æ–¹çš„æ–¹å¼ä¸æ–­é€’å¢ï¼Œå¦‚ä¸‹é¢çš„è¡¨æ ¼æ‰€ç¤ºï¼ˆæ³¨æ„åªç»™å‡ºæœ€åè¾¹çš„6ä½ï¼Œintç±»å‹æ€»å…±åº”è¯¥æœ‰32ä½ï¼‰ 0 0 1 0 1 1 3^32 3^16 3^8 3^4 3^2 3^1 å…¶å®ä¸‹é¢çš„æŒ‡æ•°ä¹Ÿå¯ä»¥æœ‰å¦å¤–ä¸€ç§æ–¹å¼ç†è§£ï¼Œå³å½“å‰ä½ç½®çš„1è¡¨ç¤ºåè¿›åˆ¶çš„å“ªä¸ªæ•°ï¼ŒæŒ‡æ•°å°±æ˜¯å“ªä¸ªã€‚ æ‰€ä»¥ä¸‹é¢çš„æ“ä½œå°±å¾ˆç®€å•äº†ï¼Œ311=3(8+2+1)ï¼Œä¸ºä»€ä¹ˆè¦æ‹†æˆè¿™å‡ ä¸ªæ•°å‘¢ï¼Œå› ä¸ºä»–ä»¬å°±æ˜¯11è½¬æˆäºŒè¿›åˆ¶åï¼Œå¯¹åº”çš„1çš„ä½ç½®æ•°å€¼çš„è¡¨ç¤ºå•Šï¼ˆä¸Šé¢çš„è¡¨æ ¼ï¼‰ï¼Œè€Œè¿™äº›ä½ç½®çš„1ä»£è¡¨çš„æ•°åŠ èµ·æ¥å°±æ˜¯11. é‚£ä¹ˆè®¡ç®—çš„æ€è·¯å°±æ˜¯ï¼Œè¯»å–11çš„äºŒè¿›åˆ¶æ•°ï¼Œè‹¥è¯¥ä½ç½®ä¸º1ï¼Œå°±ä¹˜ä¸Šè¯¥ä½ç½®æ‰€ä»£è¡¨çš„æ•°ï¼Œè‹¥ä¸º0åˆ™ä¸ä½œå¤„ç†ã€‚ æ—¶é—´å¤æ‚åº¦ä»O(N)é™åˆ°äº†O(logN) å…·ä½“æ–¹æ³•ï¼šå°†11ä¸1åšæŒ‰ä½ä¸ä½è¿ç®—ï¼Œè‹¥ç»“æœä¸º1ï¼Œè¯´æ˜11äºŒè¿›åˆ¶æœ€åçš„æ•°ä¸º1ï¼Œæ‰€ä»¥ä¹˜ä¸Šã€‚ ç„¶åä¸‹ä¸€æ­¥æˆ‘ä»¬è®©11åšå³ç§»ä½è¿ç®—ï¼Œå³å°†32ä¸ª01é›†ä½“å¾€å³ç§»åŠ¨1ä½ï¼Œè¿™æ—¶æœ€å·¦ä¾§ä¼šè¡¥ä¸Š0ï¼Œè€Œæœ€å³ä¾§çš„1å·²ç»ä¸è§äº†ã€‚ç›¸å½“äºç»§ç»­æ¯”è¾ƒä¸‹ä¸€ä½ï¼Œè‹¥å½“å‰æ•°å€¼ä¸º0ï¼Œå³äºŒè¿›åˆ¶32ä¸ªéƒ½ä¸º0ï¼Œè¯´æ˜å·²ç»æ²¡æœ‰1äº†ï¼Œå°±å¯ä»¥ç»“æŸå¾ªç¯ã€‚ å…·ä½“çš„ä»£ç å®ç° #include &lt;iostream&gt; using namespace std; typedef long long ll; ll quickPow(ll a,ll b,ll c) { ll d=1; while(b){ if(b&amp;1){ d=d*a%c; } a=a*a%c;//æ›´æ–°å½“å‰ä½ç½®ä»£è¡¨çš„æ•° b=b&gt;&gt;1;//å³ç§»1ä½ } return d; } int main() { cout&lt;&lt;&quot;10çš„1äº¿æ¬¡æ–¹mod3çš„ç»“æœä¸º: &quot;&lt;&lt;quickPow(10,1e9,3); return 0; } çŸ©é˜µå¿«é€Ÿå¹‚ è¿™é‡Œæ”¾ä¸€ä¸‹çŸ©é˜µå¿«é€Ÿå¹‚çš„æ¨¡æ¿ typedef long long ll; const int mod=1e9+7; const int MaxN=105;//çŸ©é˜µå¤§å° struct Mat{ ll m[MaxN][MaxN]; }ans,a;//ç»“æœä¸è¾“å…¥çŸ©é˜µ Mat Mul(Mat a,Mat b,int n){ Mat c; memset(c.m,0,sizeof(c.m)); for(int i=1;i&lt;=n;i++) for(int j=1;j&lt;=n;j++) for(int k=1;k&lt;=n;k++) c.m[i][j]=(c.m[i][j]+(a.m[i][k]*b.m[k][j])%mod)%mod; return c; } Mat _power(Mat a,ll b,int n){ for(int i=1;i&lt;=n;i++) ans.m[i][i]=1; while(b){ if(b&amp;1) ans=Mul(ans,a,n); a=Mul(a,a,n); b&gt;&gt;=1; } return ans; } ","link":"https://jayying007.github.io/post/å¿«é€Ÿå¹‚/"},{"title":"å­—å…¸æ ‘","content":" å­—å…¸æ ‘ä¸€èˆ¬ç”¨äºå­—ç¬¦ä¸²çš„åŒ¹é…ï¼Œå½“æ•°é‡å¤šçš„æ—¶å€™æ•ˆç‡è¿˜æ˜¯æŒºæ˜æ˜¾çš„ã€‚ è¿™é‡Œä»¥ä¸€é“æ´›è°·çš„é¢˜ä¸ºä¾‹å­ï¼Œhttps://www.luogu.org/problem/P2580 é¢˜ç›®çš„å¤§è‡´æ„æ€æ—¶ï¼Œå…ˆç»™ä½ nä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åå†ç»™ä½ mä¸ªå­—ç¬¦ä¸²ï¼Œæ±‚è¿™mä¸ªå­—ç¬¦ä¸²æ˜¯å¦åœ¨nä¸ªå­—ç¬¦ä¸²ä¸­å‡ºç°è¿‡æˆ–æ˜¯å¦é‡å¤å‡ºç°äº†ã€‚ è‹¥é‡‡ç”¨æœ´ç´ ä¸€å¯¹ä¸€çš„æ¯”è¾ƒæ–¹å¼ï¼Œé‚£æ—¶é—´å¤æ‚åº¦å°±æ˜¯O(n X m X â€˜å­—ç¬¦ä¸²é•¿åº¦â€™)ï¼Œæ‰€ä»¥è¿˜æ˜¯ç®—äº†ã€‚ è§£å†³çš„æ–¹æ³•ä¾¿æ˜¯åˆ©ç”¨å­—å…¸æ ‘ï¼Œå°†nä¸ªå­—ç¬¦ä¸²æ­å»ºæˆä¸€ä¸ªå­—å…¸æ ‘ã€‚ ä»€ä¹ˆæ˜¯å­—å…¸æ ‘ï¼Ÿï¼Ÿï¼Ÿï¼Ÿæ¯”å¦‚å­—ç¬¦ä¸²ï¼ˆab,ac,b,bca,bcdï¼‰æ„æˆçš„å­—å…¸æ ‘å¦‚ä¸‹ çº¢è‰²æ ‡è®°çš„ç»“ç‚¹å³è¯¥ç»“ç‚¹ä¸ºæŸä¸€å­—ç¬¦ä¸²çš„ç»“æŸç»“ç‚¹ï¼Œæ³¨æ„å­—å…¸æ ‘çš„æ ¹ç»“ç‚¹ä¸å­˜ä»»ä½•å­—ç¬¦ æ„å»ºå®Œå­—å…¸æ ‘åï¼Œåé¢çš„æ“ä½œå°±ç®€å•äº†ã€‚å¾…æŸ¥è¯¢çš„mä¸ªå­—ç¬¦ä¸²ä¾æ¬¡ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥è¯¢ï¼Œå½“å‰ç»“ç‚¹å­˜åœ¨è¯¥å­—ç¬¦ï¼Œåˆ™æ›´æ–°å½“å‰ä½ç½®åˆ°è¯¥å­—ç¬¦æ‰€åœ¨ç»“ç‚¹ï¼Œå¦åˆ™å°±è¯æ˜æŸ¥è¯¢ä¸åˆ°ã€‚åˆ°æœ€åä¸€ä¸ªå­—ç¬¦åŒ¹é…ä¸”è¯¥ç»“ç‚¹æ˜¯ç»“æŸç»“ç‚¹ï¼Œè¯´æ˜æŸ¥è¯¢æˆåŠŸã€‚ ä¸‹é¢æ˜¯é¢˜ç›®çš„ä»£ç  #include&lt;iostream&gt; using namespace std; int n,m,cnt; string s; struct node { int vis[26]; int state;//0 æ™®é€šèŠ‚ç‚¹ 1 ç»“æŸèŠ‚ç‚¹ 2 ç»“æŸä¸”å·²è®¿é—® }tried[500010]; void Build_tree(string s) { int len=s.length(); int now=0; for(int i=0;i&lt;len;i++){ if(tried[now].vis[s[i]-'a']==0){ tried[now].vis[s[i]-'a']=++cnt; } now=tried[now].vis[s[i]-'a']; } tried[now].state=1; } void Query_str(string s) { int len=s.length(); int now=0; for(int i=0;i&lt;len;i++){ if(tried[now].vis[s[i]-'a']){ now=tried[now].vis[s[i]-'a']; if(i==len-1&amp;&amp;tried[now].state==1){ cout&lt;&lt;&quot;OK&quot;&lt;&lt;endl; tried[now].state=2; } else if(i==len-1&amp;&amp;tried[now].state==2){ cout&lt;&lt;&quot;REPEAT&quot;&lt;&lt;endl; } } else{ cout&lt;&lt;&quot;WRONG&quot;&lt;&lt;endl; break; } } } int main() { cin&gt;&gt;n; for(int i=0;i&lt;n;i++){ cin&gt;&gt;s; Build_tree(s); } cin&gt;&gt;m; for(int i=0;i&lt;m;i++){ cin&gt;&gt;s; Query_str(s); } return 0; } ","link":"https://jayying007.github.io/post/å­—å…¸æ ‘/"},{"title":"éƒ¨ç½²Tensorflowæ¨¡å‹åˆ°æœåŠ¡å™¨-æ–¹æ³•äºŒ","content":"ç¯å¢ƒ python 3.8.3 tensorflow 2.4.0 åˆ¶ä½œæµ‹è¯•æ¨¡å‹ æ³¨æ„: tensorflowç‰ˆæœ¬1å’Œç‰ˆæœ¬2çš„æ¥å£ä¸åŒ, æˆ‘è¿™é‡Œå¥—ç”¨åŸæ¥çš„ä»£ç , ä¿®æ”¹éƒ¨åˆ†éœ€è¦å…¼å®¹çš„ä»£ç .æ¯”å¦‚ tf.placeholder() --&gt; tf.compat.v1.placeholder()ã€‚å¦‚æœä½ ç”¨çš„æ˜¯ç‰ˆæœ¬1åˆ™ä¸ç”¨ä¿®æ”¹ import tensorflow as tf import numpy as np import os # æ–‡ä»¶å¤¹ä¸å­˜åœ¨æ—¶,ä¼šæŠ¥utf-8è§£æé”™è¯¯ if not os.path.exists('./model'): os.mkdir('./model') tf.compat.v1.disable_eager_execution() x = tf.compat.v1.placeholder(tf.float32, name='inputX') feed = np.random.rand(100) y = 2 * x + 1 w = tf.Variable(0.) b = tf.Variable(0.) y_ = tf.add(tf.multiply(w, x), b, name='outputY') loss = tf.reduce_mean(tf.square(y - y_)) optimizer = tf.compat.v1.train.GradientDescentOptimizer(0.2) train = optimizer.minimize(loss) init = tf.compat.v1.global_variables_initializer() with tf.compat.v1.Session() as sess: sess.run(init) for i in range(200): sess.run(train, feed_dict={x: feed}) if i % 5 == 0: print(i, sess.run([w, b])) constant_graph = tf.compat.v1.graph_util.convert_variables_to_constants(sess, sess.graph_def, ['outputY']) with tf.compat.v1.gfile.FastGFile('./model/linear.pb', mode='wb') as f: f.write(constant_graph.SerializeToString()) éƒ¨ç½²ä¸Šçº¿ è¿™é‡Œä½¿ç”¨pythonçš„webæœåŠ¡å™¨æ¡†æ¶Flaskï¼Œå¾ˆå®¹æ˜“ä¸Šæ‰‹çš„ï¼Œè€Œä¸”Pycharmåœ¨åˆ›å»ºé¡¹ç›®æ—¶å°±èƒ½é€‰æ‹©ã€‚ è¿™é‡Œç›´æ¥è´´ä»£ç  app.py import tensorflow as tf from flask import Flask from flask import request app = Flask(__name__) with tf.compat.v1.gfile.FastGFile('./model/linear.pb', 'rb') as f: graph_def = tf.compat.v1.GraphDef() graph_def.ParseFromString(f.read()) tf.import_graph_def(graph_def, name='') sess = tf.compat.v1.Session() output = sess.graph.get_tensor_by_name('outputY:0') @app.route('/predict', methods=[&quot;GET&quot;]) def testPredict(): inputX = request.args.get(&quot;inputX&quot;) return str(sess.run(output, feed_dict={'inputX:0': inputX})) if __name__ == '__main__': app.run() éªŒè¯ç»“æœ ç¨‹åºå¯åŠ¨åï¼Œé»˜è®¤ç›‘å¬çš„æ˜¯5000ç«¯å£ï¼Œæˆ‘ä»¬ç”¨æµè§ˆå™¨è®¿é—® http://localhost:5000/predict?inputX=2ï¼Œå¯ä»¥çœ‹åˆ°ç»“æœ å®Œç»“æ’’èŠ±â€â€â€ ","link":"https://jayying007.github.io/post/éƒ¨ç½²Tensorflowæ¨¡å‹åˆ°æœåŠ¡å™¨-æ–¹æ³•äºŒ/"},{"title":"éƒ¨ç½²Tensorflowæ¨¡å‹åˆ°æœåŠ¡å™¨--æ–¹æ³•ä¸€","content":"åŸºæœ¬æ€è·¯ï¼šåˆ©ç”¨tensorflowå®˜æ–¹æä¾›çš„tensorflow servingè¿›è¡Œéƒ¨ç½²ï¼ŒåŒæ—¶ï¼Œä¸ºäº†å…å»ç¯å¢ƒé…ç½®ç­‰éº»çƒ¦æ“ä½œï¼Œå¯å€ŸåŠ©dockerå®¹å™¨ã€‚ ä¸€ã€æœåŠ¡å™¨ç¯å¢ƒé€‰æ‹© é¦–å…ˆè‚¯å®šè¦å»ç§Ÿä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¾‹å¦‚é˜¿é‡Œäº‘ã€‚ä¸€å¼€å§‹é€‰äº†window server2012ï¼Œç»“æœå¾ˆå‘ï¼Œè£…ä¸äº†dockerã€‚ä¸Šç½‘æƒ³æŸ¥è§£å†³æ–¹æ³•ï¼Œå‘ç°åˆ«äººä¹Ÿé‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜ã€‚ äº†è§£çš„åŸå› å¤§æ¦‚æ˜¯ï¼šdockeréœ€è¦åœ¨linuxçš„ç¯å¢ƒä¸‹è¿è¡Œã€‚ä½†é€šè¿‡åœ¨window server2012ä¸‹ä½¿ç”¨vitural boxè¿è¡Œlinuxè™šæ‹Ÿæœºçš„åŠæ³•ä¸è¡Œï¼Œå› ä¸ºè¿™æ ·ä¼šé€ æˆäºŒæ¬¡è™šæ‹Ÿï¼ˆå®˜æ–¹è§£é‡Šï¼šé˜¿é‡Œäº‘ç»™çš„è½»é‡åº”ç”¨æœåŠ¡å™¨æ˜¯è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šçš„ï¼Œæ‰€ä»¥ä¸èƒ½å†å¼€è™šæ‹Ÿæœºï¼‰ã€‚ ä¸è¿‡ç½‘ä¸Šä¸€äº›å¤§ä½¬å¥½åƒä¹Ÿç»™å‡ºäº†éªšæ“ä½œï¼Œä½†æ€»ä¹‹å¤ªè¿‡éº»çƒ¦ï¼Œä¸æƒ³å»æŠ˜è…¾ï¼Œå°±æ²¡å»å°è¯•ã€‚ æ­£å½“æˆ‘è§‰å¾—å‡‰å‡‰ï¼Œæƒ³é‡æ–°ä¹°linuxæœåŠ¡å™¨çš„æ—¶å€™ï¼Œæ‰å‘ç°é˜¿é‡Œäº‘çš„æ§åˆ¶å°ä¸Šå¯ä»¥é‡æ–°æ›´æ”¹ç³»ç»Ÿé•œåƒï¼Œäºæ˜¯å¾ˆæ„‰å¿«åœ°æ¢æˆäº†ubuntu18.04. äºŒã€Ubuntuä¸‹dockerå®¹å™¨çš„å®‰è£… å‰ææ¡ä»¶ï¼šDocker è¦æ±‚ Ubuntu ç³»ç»Ÿçš„å†…æ ¸ç‰ˆæœ¬é«˜äº 3.10 ï¼Œé€šè¿‡ uname -r å‘½ä»¤æŸ¥çœ‹ä½ å½“å‰çš„å†…æ ¸ç‰ˆæœ¬ã€‚ æ¥ä¸‹æ¥å°±æ˜¯åœ¨linuxç»ˆç«¯æ•²å‘½ä»¤äº†ï¼š 1.è·å–dockerå®‰è£…åŒ… wget -qO- https://get.docker.com/ | sh å®Œæˆåä¼šæœ‰ä¸€æ®µæç¤º If you would like to use Docker as a non-root user, you should now consider adding your user to the &quot;docker&quot; group with something like: sudo usermod -aG docker runoob Remember that you will have to log out and back in for this to take effect! ä¸€èˆ¬å«Œéº»çƒ¦çš„è¯ï¼Œä»¥åæ‰§è¡Œdockerå‘½ä»¤éƒ½åœ¨rootä¸‹è¿›è¡Œå°±å¯ä»¥äº† 2.è¿è¡Œdockerå®¹å™¨ sudo service docker start 3.æµ‹è¯•hello-worldç¨‹åº docker run hello-world ç¬¬ä¸€æ¬¡åº”è¯¥ä¼šå¤±è´¥ï¼Œå› ä¸ºå®¹å™¨é‡Œè¿˜æ²¡æœ‰è¿™ä¸ªé¡¹ç›®ï¼Œæ‰€ä»¥dockerä¼šå»ä¸‹è½½ï¼Œç¬¬äºŒæ¬¡è¿è¡Œå°±å¯ä»¥äº†ã€‚ ä¸‰ã€æ¨¡å‹çš„éƒ¨ç½² 1.æ‹‰å–å¸¦tensorflow servingçš„dockeré•œåƒ docker pull tensorflow/serving 2.å…ˆæ¥æµ‹è¯•ä¸€ä¸‹å®˜æ–¹ä¾‹å­ cd /root/software/ git clone https://github.com/tensorflow/serving å°†GitHubä¸Šçš„TensorFlow-servingæ‹·è´ä¸‹æ¥ï¼Œé‡Œé¢å·²ç»æœ‰ä¸€äº›æ¨¡å‹ï¼Œæˆ‘ä»¬é€šè¿‡éƒ¨ç½²ä¸€ä¸ªç®€å•çš„æ¨¡å‹ä¸Šdockeræ¥è§‚å¯Ÿç»“æœ docker run -p 8501:8501 \\ --mount type=bind,\\ source=/root/software/serving/tensorflow_serving/servables/tensorflow/testdata/saved_model_half_plus_two_cpu,\\ target=/models/half_plus_two \\ -e MODEL_NAME=half_plus_two -t tensorflow/serving &amp; è¿è¡ŒæˆåŠŸåï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªPythonçš„ä»£ç æµ‹è¯• import requests import json pdata={&quot;instances&quot;:[1,2,3]} param=json.dumps(pdata) res=requests.post('http://localhost:8501/v1/models/half_plus_two:predict',data=param) print(res.text) å¯ä»¥çœ‹åˆ°resè¿”å›çš„ç»“æœï¼Œå¯¹åº”çš„æ˜¯æˆ‘ä»¬è¾“å…¥çš„1,2,3ï¼Œä¹‹åæˆ‘ä»¬å°±åˆ©ç”¨è¿™ç§æ–¹å¼ä¼ é€’å›¾ç‰‡æˆ–å…¶ä»–æ•°æ®è¿‡å» { &quot;predictions&quot;: [2.5, 3.0, 3.5 ] } ç»“æœåˆ†æï¼š å¯åŠ¨dockerçš„æ—¶å€™ï¼Œå¼€å¯äº†8501ç«¯å£ï¼Œåé¢urlé€šè¿‡è¯¥ç«¯å£è¿›è¡Œè®¿é—® å‚æ•°sourceè¡¨ç¤ºä½ æ¨¡å‹å­˜æ”¾çš„æ–‡ä»¶å¤¹ï¼Œå¦‚æœä½ å»æ‰¾è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œä½ ä¼šå‘ç°é‡Œé¢æ¨¡å‹å­˜æ”¾çš„æ ¼å¼æœ‰äº›ç‰¹åˆ«ï¼Œåé¢æˆ‘ä»¬è¦éƒ¨ç½²æ¨¡å‹æ—¶ä¹Ÿéœ€è¦å…ˆè½¬ä¸ºè¿™ç§ç±»å‹ model_nameæ˜¯dockerä¸Šæ¨¡å‹çš„åç§°ï¼Œåœ¨urlä¸Šä¹Ÿå¯ä»¥çœ‹åˆ° targetæ˜¯å­˜æ”¾åœ¨dockerä¸Šçš„è·¯å¾„ ä¸‹é¢å°±å¼€å§‹éƒ¨ç½²æˆ‘ä»¬è‡ªå·±çš„æ¨¡å‹äº† 4.éƒ¨ç½²è‡ªå·±æ¨¡å‹ åˆšæ‰ç¬¬ä¸‰æ­¥è¯´è¿‡ï¼Œè¦å°†æ¨¡å‹å¯¼å‡ºä¸ºç‰¹æ®Šçš„ç±»å‹ï¼ˆæœ‰ä¸€ä¸ªvariablesæ–‡ä»¶å¤¹ï¼ŒåŒç›®å½•ä¸‹ä¸€ä¸ªpbæ¨¡å‹ï¼Œè¿™ä¸ªpbæ¨¡å‹å’Œä¹‹å‰çš„è¿˜ä¸å¤§ä¸€æ ·ï¼‰ã€‚ é¦–å…ˆéœ€è¦æˆ‘ä»¬è®­ç»ƒå®Œæ¨¡å‹åä¸€ä¸ªæ­£å¸¸çš„checkpointï¼Œè½¬æ¢çš„æ–¹æ³•å¯ä»¥å‚è€ƒä¸‹é¢çš„åšæ³• import tensorflow as tf import numpy as np x = tf.placeholder(tf.float32, name='input_x') feed = np.random.rand(100) y = x + 1 w = tf.Variable(0.) b = tf.Variable(0.) y_ = tf.add(tf.multiply(w, x), b) loss = tf.reduce_mean(tf.square(y-y_)) optimizer = tf.train.GradientDescentOptimizer(0.2) train = optimizer.minimize(loss) init = tf.global_variables_initializer() saver = tf.train.Saver() with tf.Session() as sess: sess.run(init) for i in range(200): sess.run(train, feed_dict={x: feed}) if i % 5 == 0: print(i, sess.run([w,b])) saver.save(sess, './linear/linear.ckpt') with tf.Session() as sess2: sess2.run(init) saver.restore(sess2, './linear/linear.ckpt') # å°†è®­ç»ƒå¥½çš„æ¨¡å‹ä¿å­˜åœ¨modelNameä¸‹ï¼Œç‰ˆæœ¬ä¸º1ï¼Œå½“ç„¶ä½ çš„ç‰ˆæœ¬å¯ä»¥éšä¾¿å†™ builder = tf.saved_model.builder.SavedModelBuilder(&quot;./modelName/1&quot;) inputs = { # æ³¨æ„ï¼Œè¿™é‡Œæ˜¯ä½ é¢„æµ‹æ¨¡å‹çš„æ—¶å€™éœ€è¦ä¼ çš„å‚æ•°ï¼Œè°ƒç”¨æ¨¡å‹çš„æ—¶å€™ï¼Œä¼ å‚å¿…é¡»å’Œè¿™é‡Œä¸€è‡´ # è¿™é‡Œçš„input_xå°±æ˜¯æ¨¡å‹é‡Œé¢å®šä¹‰çš„è¾“å…¥placeholder &quot;input_x&quot;: tf.saved_model.utils.build_tensor_info(x) } outputs = { &quot;output_y&quot;: tf.saved_model.utils.build_tensor_info(y), } prediction_signature = tf.saved_model.signature_def_utils.build_signature_def( inputs=inputs, outputs=outputs, method_name=tf.saved_model.signature_constants.PREDICT_METHOD_NAME ) builder.add_meta_graph_and_variables( sess2, [tf.saved_model.tag_constants.SERVING], {tf.saved_model.signature_constants.DEFAULT_SERVING_SIGNATURE_DEF_KEY: prediction_signature} ) builder.save() ä¹‹åä»¿ç…§æ ·ä¾‹æ¨¡å‹ï¼Œç”¨dockerè¿è¡Œè¿™ä¸ªæ¨¡å‹å°±å¯ä»¥äº†ï¼Œç«¯å£å·ã€è·¯å¾„å’Œæ¨¡å‹åç§°ä»€ä¹ˆçš„è‡ªå®šä¹‰å³å¯ï¼Œä¸å†²çªå°±è¡Œã€‚ docker run -p 8502:8501 \\ --mount type=bind,\\source=/root/software/serving/tensorflow_serving/servables/tensorflow/testdata/face/face2,\\target=/models/face2 \\ -e MODEL_NAME=face2 -t tensorflow/serving &amp; ä¸€æ®µæµ‹è¯•ä»£ç ï¼Œè·Ÿä¸Šé¢çš„æœ‰ä¸€ç‚¹ç±»ä¼¼ï¼Œå…·ä½“ä»€ä¹ˆå‚æ•°çœ‹è‡ªå·±çš„æ¨¡å‹ import requests import numpy as np import json # jsonæ ¼å¼åºåˆ—è°ƒæ•´ class NumpyEncoder(json.JSONEncoder): def default(self, obj): if isinstance(obj, np.ndarray): return obj.tolist() return json.JSONEncoder.default(self, obj) feature=np.array(range(128)) param = { &quot;instances&quot;:[ #æ¯ä¸€ä¸ªå¤§æ‹¬å·æ˜¯ä¸€æ¬¡è¯·æ±‚ï¼Œé‡Œé¢æ˜¯æ¯æ¬¡è¯·æ±‚çš„å‚æ•° { &quot;in&quot;:feature } ] } param = json.dumps(param, cls=NumpyEncoder) res = requests.post(&quot;http://localhost:8502/v1/models/face2:predict&quot;, data=param) # æ ¹æ®è‡ªå·±è®¾å®šçš„è¿”å›æ•°æ®è¯»å– # softmax = json.loads(res2.text)[&quot;predictions&quot;][0] è‡³æ­¤ï¼Œå¤§åŠŸå‘Šæˆã€‚ PSï¼šå¦‚æœæœ‰å¤šä¸ªæ¨¡å‹éœ€è¦éƒ¨ç½²ï¼Œåªéœ€è¦ä¿®æ”¹æœ¬åœ°ç«¯å£å·å³å¯ï¼Œä¸éœ€è¦ä¿®æ”¹dockerçš„ç«¯å£å·ã€‚ï¼ˆå°±æ˜¯docker runå‘½ä»¤çš„æ—¶å€™ï¼Œåªæ”¹ç¬¬ä¸€ä¸ª8501ï¼Œä¸éœ€è¦æ”¹ç¬¬äºŒä¸ª8501ï¼‰ ","link":"https://jayying007.github.io/post/éƒ¨ç½²Tensorflowæ¨¡å‹åˆ°æœåŠ¡å™¨-æ–¹æ³•ä¸€/"},{"title":"k-meansç®—æ³•","content":"ç®€ä»‹ æ®è¯´æ˜¯æœºå™¨å­¦ä¹ ä¸­æœ€ç®€å•çš„ä¸€ç§æ–¹æ³•ï¼Œå±äºéç›‘ç£å­¦ä¹ è¿™ä¸€ç±»ã€‚é€šä¿—ä¸€ç‚¹è®²ï¼Œç»™æœºå™¨ä¸€å †æ•°æ®ï¼Œå‘Šè¯‰æœºå™¨è¦åˆ†æˆå¤šå°‘ç§ç±»åˆ«ï¼Œç„¶åæœºå™¨å°±æ ¹æ®ç®—æ³•è¿›è¡Œå„ç§æ“ä½œã€‚ å®ç°åŸç† éœ€è¦æˆ‘ä»¬ç¡®å®šå˜é‡kï¼Œå³æœ€ç»ˆ çš„æ•°æ®ä¼šæœ‰å‡ ç§ç±»åˆ«ã€‚ æ€»å…±æœ‰kä¸ªä¸­å¿ƒåæ ‡ï¼Œä¸€å¼€å§‹å¯ä»¥éšæœºèµ‹å€¼ï¼Œé€šè¿‡è®¡ç®—ç›®æ ‡ç‚¹åæ ‡ä¸æ‰€æœ‰ä¸­å¿ƒåæ ‡çš„è·ç¦»ï¼Œå°†å…¶å½’ç±»åœ¨è·ç¦»è¾ƒè¿‘çš„ç±»åˆ«ä¸­ã€‚ ä¹‹åæ ¹æ®ç±»åˆ«ä¸­çš„ç›®æ ‡ç‚¹è®¡ç®—å¹³å‡å€¼é‡æ–°å¾—åˆ°ä¸­å¿ƒåæ ‡ï¼Œå†é‡å¤ä¸Šé¢çš„å·¥ä½œã€‚ è·ç¦»å…¬å¼ å¸¸ç”¨çš„è·ç¦»å…¬å¼å¦‚æ¬§å¼è·ç¦»ï¼Œé©¬æ°è·ç¦»ï¼Œæ›¼å“ˆé¡¿è·ç¦»ã€‚ å€ŸåŠ©ç§‘å­¦è®¡ç®—åº“å¯ä»¥å¸®æˆ‘ä»¬èŠ‚çœä¸€äº›æ—¶é—´ã€‚ from scipy.spatial.distance import pdist pdist(np.array([dot[j], center[k]]), 'euclidean')#æ¬§æ°è·ç¦» å°å°ç¤ºä¾‹ import numpy as np import matplotlib.pyplot as plt from scipy.spatial.distance import pdist dimension = 2 # ç”Ÿæˆå¤šä¸ªéšæœºç‚¹ï¼ŒèŒƒå›´[0,10) dot_num = 100 dot = np.random.rand(dot_num,dimension)*10 # ç”Ÿæˆå¤šä¸ªéšæœºä¸­å¿ƒç‚¹ï¼ŒèŒƒå›´[0,10) center_num = 4 center = np.random.rand(center_num,dimension)*10 # å¾ªç¯è¿­ä»£ times = 50 for i in range(times): plt.clf() # æ•°æ®æ˜ å°„ belong = np.zeros([dot_num]) # è®¡ç®—éšæœºç‚¹ä¸ä¸­å¿ƒç‚¹çš„è·ç¦»ï¼Œå°†å…¶å½’å±äºè·ç¦»è¿‘çš„ä¸­å¿ƒç‚¹ dist = np.zeros([dot_num,center_num]) for j in range(dot_num): for k in range(center_num): dist[j][k] = pdist(np.array([dot[j], center[k]]), 'euclidean') belong[j] = np.argmax(dist[j]) # ç»˜å›¾ for j in range(center_num): temp_dot = [] for k in range(dot_num): if(belong[k] == j): temp_dot.append(dot[k]) # æ ¹æ®éšæœºç‚¹æ±‚å–å‡å€¼ï¼Œå¾—å‡ºæ–°çš„ä¸­å¿ƒç‚¹ if(len(temp_dot) != 0): temp_dot = np.array(temp_dot) plt.scatter(temp_dot[:,0],temp_dot[:,1]) for k in range(dimension): center[j][k] = np.sum(temp_dot[:,k])/len(temp_dot) else: center[j] = np.zeros([dimension]) # print(center) plt.pause(1) # æ»¡è¶³è¿­ä»£æ¬¡æ•°æˆ–ä¸­å¿ƒç‚¹ä¸å†æ”¹å˜ï¼Œç»“æŸå‘½ä»¤ è¯´æ˜ ä¸Šè¿°ä»£ç ä¸ºåŠ¨æ€å®æ—¶æ›´æ–°ç”»æ¿å†…å®¹ï¼Œå…¶ä¸­çš„å…³é”®ä»£ç å¦‚ä¸‹ import matplotlib.pyplot as plt for i in range(5): # æ¸…é™¤ç”»å¸ƒ plt.clf() # ç»˜åˆ¶æ•£ç‚¹ plt.scatter(temp_dot[:,0],temp_dot[:,1]) # æš‚åœé—´éš” plt.pause(1) ","link":"https://jayying007.github.io/post/k-meansç®—æ³•/"},{"title":"äºŒåˆ†æŸ¥æ‰¾","content":"æ¦‚å¿µ äºŒåˆ†æŸ¥æ‰¾ï¼Œåˆç§°æŠ˜åŠæŸ¥æ‰¾ã€‚é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨ä¸€å †æœ‰åºæ’åˆ—çš„å…ƒç´ ä¸­æŸ¥æ‰¾æŸä¸€æŒ‡å®šæ•°å€¼ã€‚è¿”å›æ•°å€¼å¯¹åº”çš„ä¸‹æ ‡æˆ–-1ï¼ˆæŸ¥ä¸åˆ°ï¼‰ã€‚ åœºæ™¯æ¨¡æ‹Ÿ çœ‹å…¶ä»–æ–‡ç« éƒ½æ˜¯åƒç¯‡ä¸€å¾‹çš„çŒœæ•°å­—ï¼Œæˆ‘ä»¬æ¢ä¸€æ¢é£æ ¼ï¼Œæ¥çŒœä¸€çŒœä»·æ ¼å§ã€‚è¿™ä¸æ˜¯ä¸€æ ·çš„å—ï¼Ÿ æ¯”å¦‚è¯´ç°åœ¨è®©ä½ çŒœä¸€ä»¶å•†å“çš„ä»·æ ¼ï¼Œå·²çŸ¥å•†å“çš„ä»·æ ¼åœ¨1-1000å…ƒä¹‹é—´ï¼Œä¸”ä¸ºæ•´æ•°ï¼Œç°åœ¨è®©ä½ å°½å¿«çŒœä¸­å•†å“çš„ä»·æ ¼ï¼Œä½ è¦æ€ä¹ˆåšå‘¢ï¼Ÿï¼ˆä½ æ¯çŒœä¸€ä¸ªä»·æ ¼ï¼Œéƒ½èƒ½å¾—çŸ¥è¿™ä¸ªä»·æ ¼ä¸æ­£ç¡®ä»·æ ¼ç›¸æ¯”æ˜¯ç›¸åŒçš„ï¼Œè¿˜æ˜¯å°äº†æˆ–å¤§äº†ï¼‰ é²è½çš„æ–¹æ³•ï¼šä»1å…ƒå¼€å§‹çŒœåˆ°1000å…ƒï¼Œæ€»ä¼šçŒœåˆ°çš„ã€‚è¿æ°”å¥½çš„è¯ï¼Œä»·æ ¼åˆšå¥½æ˜¯1å…ƒï¼ŒçŒœä¸€æ¬¡å°±ä¸­äº†ã€‚è¿æ°”ä¸å¥½çš„è¯ï¼Œä»·æ ¼æ˜¯1000å…ƒï¼Œè¦çŒœ1000æ¬¡æ‰èƒ½çŒœä¸­ã€‚ è¿™ç§æ–¹æ³•å…¶å®æ²¡æœ‰å……åˆ†åˆ©ç”¨çŒœä»·æ ¼å¾—åˆ°çš„åé¦ˆä¿¡æ¯ï¼Œå³ä»1å…ƒå¼€å§‹çŒœåˆ°1000å…ƒçš„è¿‡ç¨‹ä¸­ï¼Œä½ å¾—åˆ°çš„åé¦ˆåªæœ‰æ­£ç¡®æˆ–è€…å°äº†ï¼Œç»å¯¹ä¸ä¼šå‡ºç°å¤§äº†ã€‚ ç¿æ™ºçš„æ–¹æ³•ï¼šæ—¢ç„¶ä»·æ ¼åœ¨1å…ƒåˆ°1000å…ƒä¹‹é—´ï¼Œé‚£æˆ‘å°±çŒœ500å…ƒï¼Œå³ï¼ˆ1+1000ï¼‰/2ã€‚è¿™æ—¶å¯èƒ½çš„åé¦ˆä¿¡æ¯åˆ†åˆ«æœ‰ æ¯”æ­£ç¡®ä»·æ ¼å°ï¼šè¿™æ ·æˆ‘ä»¬å°±çŸ¥é“å•†å“çš„ä»·æ ¼ä¸åœ¨1å…ƒåˆ°500å…ƒä¹‹é—´ï¼Œè€Œæ˜¯åœ¨501å…ƒåˆ°1000å…ƒä¹‹é—´ã€‚ ä¸æ­£ç¡®ä»·æ ¼ç›¸åŒï¼šå³æˆ‘ä»¬çŒœä¸­äº†ï¼Œæ‰€ä»¥å°±ç›´æ¥è¿”å›è¿™ä¸ªç»“æœå°±å¯ä»¥äº†ã€‚ æ¯”æ­£ç¡®ä»·æ ¼å¤§ï¼šæ‰€ä»¥å•†å“ä»·æ ¼ä¸åœ¨500å…ƒåˆ°1000å…ƒä¹‹é—´ï¼Œè€Œæ˜¯åœ¨1å…ƒåˆ°499å…ƒä¹‹é—´ã€‚ **ä¸éš¾çœ‹å‡ºï¼Œåªç»è¿‡ä¸€æ¬¡çŒœæµ‹ï¼Œå¯èƒ½çŒœä¸­æˆ–è€…æŠŠçŒœæµ‹èŒƒå›´ç¼©å°ä¸€åŠã€‚åé¢ç”¨åŒæ ·çš„æ–¹å¼çŒœæµ‹ï¼Œåˆ™åˆå¯ä»¥å°†çŒœæµ‹èŒƒå›´ç¼©å°ä¸€åŠã€‚**è¿™ä¸ªä¸å°±æ˜¯é€’å½’å—ï¼Ÿè™½ç„¶ç”¨å¾ªç¯ä¹Ÿå¯ä»¥åš ç”¨äºŒåˆ†æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆlogNï¼‰ ä»£ç æ¨¡æ¿ #include&lt;iostream&gt; #include&lt;vector&gt; using namespace std; void binarySearch(vector&lt;int&gt; arr,int aim) { /* * å‚æ•°è¯´æ˜ï¼šarrå³æŸ¥æ‰¾çš„å®¹å™¨åºåˆ—ï¼Œaimä¸ºéœ€è¦æŸ¥æ‰¾çš„å…ƒç´  * è¦æ±‚ï¼šarrå®¹å™¨éœ€ä¿è¯å…ƒç´ å‡åº */ int left=0,right=arr.size()-1,mid=(left+right)/2; while(left&lt;=right) { if(arr[mid]&lt;aim){ left=mid+1; } else if(arr[mid]==aim){ cout&lt;&lt;&quot;æ‰¾åˆ°äº†&quot;; return; } else if(arr[mid]&gt;aim){ right=mid-1; } mid=(left+right)/2; } cout&lt;&lt;&quot;æ‰¾ä¸åˆ°&quot;; return; } int main() { vector&lt;int&gt; arr; for(int i=1;i&lt;=10;i++){ arr.push_back(i*2); } binarySearch(arr,7); return 0; } ","link":"https://jayying007.github.io/post/äºŒåˆ†æŸ¥æ‰¾/"},{"title":"KVO&KVOControlleråŠå…¶åŸç†","content":"KVOä»‹ç» KVOå…¨åKey Value Observingï¼Œæ˜¯ä¸€ç§é€šçŸ¥æœºåˆ¶ï¼Œä½¿å¾—å½“æŸä¸ªObjectçš„Propertyå‘ç”Ÿå˜åŒ–æ—¶ï¼Œèƒ½å¤Ÿå¾—åˆ°é€šçŸ¥ï¼Œå®ƒåŸºäºKVCå®ç°ã€‚ KVOä¸€èˆ¬ä»£ç å®ç°åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š æ·»åŠ è§‚å¯Ÿ @implementation Person - (void)observeNTESStock { [self.stock addObserver:self forKeyPath:@&quot;price&quot; options:NSKeyValueObservingOptionNew context:nil]; } @end æ·»åŠ å›è°ƒ - (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context { // To Do SomethingÂ·Â·Â· } ç§»é™¤è§‚å¯Ÿ [self.stock removeObserver:self forKeyPath:@&quot;price&quot;]; ä½†æ˜¯KVOåœ¨ä½¿ç”¨ä¸­ä¹Ÿæœ‰ä¸€äº›é—®é¢˜ï¼š ç”±äºè§‚å¯Ÿè€…å¯ä»¥è§‚å¯Ÿå¤šä¸ªé”®å€¼ï¼Œå½“è§‚å¯Ÿçš„é”®å€¼æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œåœ¨å›è°ƒçš„æ–¹æ³•ä¸­ä¼šå­˜åœ¨å¤§é‡çš„ifè¯­å¥å»åˆ¤æ–­è¢«è§‚å¯Ÿè€…ä»¥åŠKeyPath éœ€è¦æ‰‹åŠ¨ç§»é™¤è§‚å¯Ÿï¼Œæ“ä½œä¸å½“å®¹æ˜“Crash å¯é‡å¤æ·»åŠ è§‚å¯Ÿï¼ˆå¯¼è‡´å¤šæ¬¡å›è°ƒï¼‰ï¼Œå½“ç§»é™¤è§‚å¯Ÿæ–¹æ³• &gt; æ·»åŠ è§‚å¯Ÿæ–¹æ³•çš„æ¬¡æ•°æ—¶ï¼Œä¼šcrash åœ¨å¤šçº¿ç¨‹å¹¶å‘ä¸‹ï¼Œå¯èƒ½å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼š çº¿ç¨‹ä¸€ï¼šè§‚å¯Ÿè€…æ­£åœ¨æ‰§è¡Œdeallocæ–¹æ³•ï¼Œå¹¶ä¸”è¿˜æœªæ‰§è¡ŒremoveObserver çº¿ç¨‹äºŒï¼šè¢«è§‚å¯Ÿå¯¹è±¡çš„é”®å€¼å‘ç°æ”¹å˜ï¼Œè§¦å‘äº†KVOçš„observeValueForKeyPathå›è°ƒï¼Œä½†æ­¤æ—¶è§‚å¯Ÿè€…å·²ç»å˜æˆé‡æŒ‡é’ˆäº† KVOControllerä»‹ç» KVOControlleræ˜¯FaceBookå¼€æºçš„åŸºäºKVOå°è£…çš„æ¡†æ¶ï¼Œæé«˜äº†ä»£ç çš„å¯è¯»æ€§å’Œå®‰å…¨æ€§ã€‚ä¸‹å›¾æ˜¯å…¶åœ¨Githubä¸Šçš„ä»‹ç»ï¼š å¼•å…¥KVOControllerä»¥åï¼Œé”®å€¼è§‚å¯Ÿçš„å®ç°å°†å˜å¾—éå¸¸ç®€å•ã€‚ @interface ViewController () @property (nonatomic, strong) FBKVOController *KVOController; @end @implementation ViewController - (void)viewDidLoad { [super viewDidLoad]; self.KVOController = [[FBKVOController alloc] initWithObserver:self]; Person *person = [[Person alloc] init]; [self.KVOController observe:person keyPath:@&quot;name&quot; options:NSKeyValueObservingOptionNew block:^(id _Nullable observer, id _Nonnull object, NSDictionary&lt;NSKeyValueChangeKey,id&gt; * _Nonnull change) { NSLog(@&quot;%@&quot;, change); }]; person.name = @&quot;Jane&quot;; } @end =====è¾“å‡º===== { FBKVONotificationKeyPathKey = name; kind = 1; new = Jane; } KVOControlleræä¾›äº†Blockã€Actionã€åŸç”Ÿæ–¹æ³•ä¸‰ç§å›è°ƒæ–¹æ³•ã€‚ KVOControllerä¹Ÿå¯¹NSObjectåšäº†categoryï¼ŒåŠ¨æ€ç»‘å®šäº†KVOControllerå±æ€§ï¼Œä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ã€‚ KVOControlleræºç åˆ†æ KVOControllerçš„æºç éå¸¸å°‘ï¼Œä¸€å…±äº”ä¸ªæ–‡ä»¶ã€‚ NSObject+FBKVOControllerä¸»è¦æ˜¯åŠ¨æ€å¢åŠ äº†NSObjectçš„ä¸¤ä¸ªå±æ€§ï¼ŒåŒºåˆ«åœ¨äºæ˜¯å¦æŒæœ‰è¢«è§‚å¯Ÿå¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œå®ƒä»¬éƒ½é‡‡ç”¨äº†æ‡’åŠ è½½ã€‚ @interface NSObject (FBKVOController) @property (nonatomic, strong) FBKVOController *KVOController; @property (nonatomic, strong) FBKVOController *KVOControllerNonRetaining; @end static void *NSObjectKVOControllerKey = &amp;NSObjectKVOControllerKey; static void *NSObjectKVOControllerNonRetainingKey = &amp;NSObjectKVOControllerNonRetainingKey; @implementation NSObject (FBKVOController) - (FBKVOController *)KVOController { id controller = objc_getAssociatedObject(self, NSObjectKVOControllerKey); // lazily create the KVOController if (nil == controller) { controller = [FBKVOController controllerWithObserver:self]; self.KVOController = controller; } return controller; } - (void)setKVOController:(FBKVOController *)KVOController { objc_setAssociatedObject(self, NSObjectKVOControllerKey, KVOController, OBJC_ASSOCIATION_RETAIN_NONATOMIC); } - (FBKVOController *)KVOControllerNonRetaining { id controller = objc_getAssociatedObject(self, NSObjectKVOControllerNonRetainingKey); if (nil == controller) { controller = [[FBKVOController alloc] initWithObserver:self retainObserved:NO]; self.KVOControllerNonRetaining = controller; } return controller; } - (void)setKVOControllerNonRetaining:(FBKVOController *)KVOControllerNonRetaining { objc_setAssociatedObject(self, NSObjectKVOControllerNonRetainingKey, KVOControllerNonRetaining, OBJC_ASSOCIATION_RETAIN_NONATOMIC); } @end åˆå§‹åŒ–ä¸é”€æ¯ä»£ç  FBKVOControllerå†…çš„å±æ€§_objectInfosMap æ ¹æ®retainObservedæ˜¯YESè¿˜æ˜¯NOï¼Œåœ¨åˆå§‹åŒ–æ—¶é€‰æ‹©å¯¹Keyå€¼è¿›è¡Œå¼ºå¼•ç”¨è¿˜æ˜¯å¼±å¼•ç”¨ã€‚_objectInfosMapçš„Keyè®°å½•äº†è¢«è§‚å¯Ÿè€…ï¼ŒValueè®°å½•äº†è¢«è§‚å¯Ÿè€…çš„æ‰€æœ‰FBKVOInfoé›†åˆã€‚ ä¸‹å›¾æè¿°äº†KVOControllerå’ŒKVOInfoçš„å…³ç³»ï¼š KVOControlleræŠŠè§‚å¯Ÿçš„é”®å€¼è·¯å¾„ã€å›è°ƒblockç­‰ä¿¡æ¯å°è£…åˆ°ä¸€ä¸ªKVOInfoä¸­ï¼Œå†…éƒ¨é‡å†™äº†hashå’ŒisEqualæ–¹æ³•ã€‚ æ·»åŠ è§‚å¯Ÿè€… è¿™é‡Œä»¥Blockçš„ä¸ºä¾‹ã€‚é¦–å…ˆå°†å‚æ•°å°è£…åˆ°FBKVOInfoä¸­ï¼Œç„¶åè°ƒç”¨å†…éƒ¨çš„_observe:infoæ–¹æ³• å†…éƒ¨çš„_observe:infoæ–¹æ³•ï¼Œå°†FBKVOInfoåŠ å…¥åˆ°å¯¹åº”objectçš„é›†åˆä¸­ã€‚æœ€åè°ƒç”¨äº†_FBKVOSharedControllerçš„æ–¹æ³•ï¼Œè¿™ä¸ªFBKVOSharedControlleré‡‡ç”¨å•ä¾‹å®ç°ï¼Œæ‰€æœ‰çš„FBKVOControllerå…±äº«ã€‚ åœ¨è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†åŸç”Ÿçš„addObserveræ–¹æ³•äº†ã€‚ ObserveræŒ‡å®šä¸ºselfï¼Œæ‰€ä»¥å½“é”®å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šå›è°ƒè¿™ä¸ªFBKVOSharedControlleré‡Œé¢çš„æ–¹æ³•ã€‚è¿™é‡Œä¼šä¾æ¬¡åˆ¤æ–­FBKVOInfoä¸­æ˜¯å¦æœ‰Blockã€Actionã€é»˜è®¤å›è°ƒæ–¹æ³•ï¼Œé€‰æ‹©ä¸€ä¸ªæ‰§è¡Œã€‚ ä½¿ç”¨äº†KVOControllerè¿›è¡Œé”®å€¼ç›‘å¬çš„ï¼Œæ‰€æœ‰çš„å›è°ƒéƒ½ä¼šå›åˆ°KVOSharedControllerè¿™ä¸ªç±»ä¸­ï¼Œç„¶ååœ¨æ ¹æ®KVOInfoé‡Œé¢çš„ä¿¡æ¯è¿›è¡Œè½¬å‘ã€‚ ç§»é™¤è§‚å¯Ÿè€…çš„æµç¨‹å’Œä¸Šé¢ç±»ä¼¼ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚ KVOControlleræ³¨æ„äº‹é¡¹ è™½ç„¶KVOControllerå·²ç»ä¿®å¤äº†KVOçš„ä¸€äº›é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœç”¨å¾—ä¸æ°å½“ï¼Œè¿˜æ˜¯ä¼šæœ‰Crashå‘ç”Ÿã€‚å¦‚æœåœ¨deallocä¸­ç¬¬ä¸€æ¬¡è°ƒç”¨äº†KVOControllerï¼Œå°±ä¼šå¯¼è‡´Crashã€‚ @implementation SecondViewController - (void)viewDidLoad { [super viewDidLoad]; //æ¨¡æ‹Ÿä¸€ç§æƒ…å†µï¼Œæ»¡è¶³æŸç§æ¡ä»¶æ—¶æ‰ä½¿ç”¨KVOController if(arc4random_uniform(4) == 1) { NSLog(@&quot;%@&quot;, self.KVOController); } } - (void)dealloc { [self.KVOController unobserveAll]; } @end åŸå› ä¹Ÿæ¯”è¾ƒç®€å•ï¼ŒKVOControlleré‡‡ç”¨äº†æ‡’åŠ è½½ï¼Œåœ¨initæ–¹æ³•ä¸­ä¼šæŠŠå½“å‰å¯¹è±¡èµ‹å€¼ç»™å…¶å†…éƒ¨å±æ€§observerï¼Œä½†æ˜¯å½“å‰å¯¹è±¡å·²ç»åˆ°äº†deallocçš„å¤„ç†æµç¨‹ï¼Œæ— æ³•èµ‹å€¼ã€‚ ä¸è¿‡ä¸€èˆ¬ä¹Ÿä¸éœ€è¦åœ¨å½“å‰å¯¹è±¡çš„deallocæ–¹æ³•ä¸­ç§»é™¤ç›‘å¬ï¼Œå› ä¸ºKVOControllerçš„deallocæ–¹æ³•å·²ç»åšäº†è¿™æ ·çš„å¤„ç†ã€‚ åˆæ¯”å¦‚å½“è§‚å¯Ÿçš„å¯¹è±¡æ˜¯æœ¬èº«æ—¶ï¼Œéœ€è¦æ³¨æ„é¿å…å‡ºç°å¾ªç¯å¼•ç”¨ã€‚ KVOçš„åŸºæœ¬åŸç† KVOControlleræœ¬è´¨æ˜¯å¯¹åŸæœ‰KVOçš„å°è£…ï¼Œé‚£ä¹ˆåŸæœ‰KVOåˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ è‹¹æœæ–‡æ¡£ä¸­å¯¹å…¶è¿›è¡Œäº†æè¿°ï¼š Automatic key-value observing is implemented using a technique called isa-swizzling. The isa pointer, as the name suggests, points to the object's class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data. When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance. You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance. å½“å¯¹è±¡æ·»åŠ äº†KVOç›‘å¬ä¹‹åï¼Œç³»ç»Ÿä¼šä¿®æ”¹å¯¹è±¡çš„isaæŒ‡é’ˆï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºisa-swizzlingã€‚æ–°isaæŒ‡é’ˆæŒ‡å‘çš„ç±»æ˜¯åŸæ¥çš„å­ç±»ï¼Œé€šè¿‡è¿è¡Œæ—¶æœºåˆ¶ç”Ÿæˆï¼Œå…¶ä¸­é‡å†™äº†setæ–¹æ³•ã€‚setæ–¹æ³•è°ƒç”¨äº† Fundationæ¡†æ¶ä¸­Cè¯­è¨€å‡½æ•° _NSsetIntValueAndNotifysetï¼Œè¿™ä¸ªæ–¹æ³•çš„å¤§è‡´è°ƒç”¨é€»è¾‘ä¸ºï¼šè°ƒç”¨willChangeValueForKeyæ–¹æ³•ï¼Œç„¶åè°ƒç”¨åŸæ¥çš„setæ–¹æ³•ï¼Œæœ€åè°ƒç”¨didChangeValueForKeyã€‚å…¶ä¸­didChangeValueForKeyæ–¹æ³•å†…éƒ¨è°ƒç”¨äº†observeValueForKeyPath:ofObject:change:context:ç›‘å¬æ–¹æ³•ã€‚ æœªæ·»åŠ KVOæ—¶ æ·»åŠ KVOä¹‹å ä¸‹é¢é€šè¿‡ä»£ç è°ƒè¯•æ¥éªŒè¯ä¸Šé¢è¿™ä¸ªç»“è®ºã€‚ åˆ›å»ºä¸€ä¸ªPersonç±»ï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ªageå±æ€§ @interface Person : NSObject @property (nonatomic, assign) int age; @end @implementation Person @end ä»£ç ä¸­åˆ›å»ºä¸¤ä¸ªPersonå¯¹è±¡p1å’Œp2ã€‚é¦–å…ˆæ‰“å°å‡ºæœªæ·»åŠ KVOä¹‹å‰çš„IMPæŒ‡é’ˆï¼Œç„¶åç»™p1æ·»åŠ KVOï¼Œå†æ‰“å°IMPæŒ‡é’ˆã€‚æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œåœ¨æ·»åŠ KVOç›‘å¬ä¹‹åï¼Œp1çš„setAgeæ–¹æ³•çš„IMPå·²ç»å˜äº†ã€‚ æŠŠè¿™ä¸¤ä¸ªIMPæ‰“å°å‡ºæ¥ï¼Œå‘ç°p1çš„å·²ç»å˜æˆäº†NSSetIntValueAndNotifyã€‚ ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹p1æŒ‡å‘çš„ç±»æ˜¯å¦å·²ç»æ”¹å˜ï¼Œå¹¶æŸ¥çœ‹è¯¥ç±»çš„å†…éƒ¨ç»“æ„ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œp1æŒ‡å‘çš„ç±»å·²ç»å˜ä¸ºNSKVONotifying_Personï¼Œé‡Œé¢æœ‰å››ä¸ªæ–¹æ³•ã€‚ ä¸ºä»€ä¹ˆæœ‰classæ–¹æ³•ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¯¹å¤–å±è”½è¿™ä¸ªå­ç±»çš„å­˜åœ¨ã€‚è¦å–å¾—çœŸå®çš„classç±»å‹ï¼Œéœ€è¦é€šè¿‡object_getClassçš„æ–¹å¼ ä¸‹é¢éªŒè¯didChangeValueForKey:å†…éƒ¨ä¼šè°ƒç”¨observerçš„observeValueForKeyPath:ofObject:change:context:æ–¹æ³• çŸ¥é“è¿™ä¸ªç‰¹ç‚¹åï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥åœ¨ä¸æ›´æ–°å±æ€§çš„æƒ…å†µä¸‹è°ƒç”¨KVOå›è°ƒæ–¹æ³•ã€‚ä¸è¿‡æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šç›´æ¥è¿™ä¹ˆåšï¼Œè€Œæ˜¯å…ˆé€šè¿‡+ (BOOL)automaticallyNotifiesObserversForKey:(NSString *)theKeyç½®ä¸ºNOï¼Œè¡¨ç¤ºæ‰‹åŠ¨è§¦å‘KVOã€‚ æ‰©å±•é˜…è¯» KVOä½äºFoundationæ¡†æ¶ä¸­ï¼Œè€Œè¿™éƒ¨åˆ†ä»£ç è‹¹æœæ²¡æœ‰å¼€æºã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥å‚è€ƒGNU Stepä¸­çš„ç›¸å…³å®ç°é€»è¾‘ã€‚ GNU Stepçš„ä»£ç å¯ä»¥ä»è¿™é‡Œè·å–ï¼šhttps://github.com/gnustep/libs-base è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹å…¶ä¸­çš„é€»è¾‘ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒAè§‚å¯ŸBä¸­priceçš„å˜åŒ–ï¼ŒCè§‚å¯ŸBä¸­priceå’Œnameçš„å˜åŒ–ã€‚KVOä¼šä¸ºæ¯ä¸€ä¸ªå¯¹è±¡å…³è”ä¸€ä»½GSKVOInfoï¼Œé‡Œé¢Keyä¸ºå±æ€§åï¼ŒValueä¸ºGSKVOPathInfoï¼ŒGSKVOPathInfoå†…éƒ¨åŒ…å«ä¸€ä¸ªGSKVOObservationæ„æˆçš„æ•°ç»„ï¼Œé‡Œé¢å¼±å¼•ç”¨ç€Aå’ŒCã€‚ å½“ç„¶ï¼Œé™¤äº†å‚è€ƒGNU Stepé‡Œé¢çš„å†™æ³•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±ä»¿é€ å†™ä¸€ä¸ªKVOã€‚ è¿™é‡Œæˆ‘å†™äº†ä¸€ä¸ªä¾‹å­ï¼šhttps://github.com/jayying007/demo-KVO æ€»ç»“ æœ¬ç¯‡ä»‹ç»äº†KVOä»¥åŠå…¶å®ç°åŸç†ï¼Œé’ˆå¯¹KVOåœ¨å¼€å‘è¿‡ç¨‹ä¸­çš„é—®é¢˜ï¼Œä»‹ç»äº†æ›´å¥½çš„æ›¿ä»£æ–¹å¼--é‡‡ç”¨KVOControllerã€‚ å¦å¤–ï¼Œå¯¹ä¸€äº›å¸¸è§çš„é—®é¢˜æˆ‘ä»¬ä¹Ÿèƒ½è§£ç­”ï¼š è®¾ç½®æˆå‘˜å˜é‡ _ageï¼Œæ²¡æœ‰è§¦å‘ setter æ–¹æ³• ï¼Œä¹Ÿä¸ä¼šè§¦å‘ KVO ç›¸å…³çš„ä»£ç ï¼› ä¸€ä¸ªè¢«å£°æ˜ä¸ºpublicçš„å˜é‡ï¼Œè€Œä¸æ˜¯ç±»çš„å±æ€§ï¼Œåªè¦å…¶æ‹¥æœ‰å¯¹åº”çš„setteræ–¹æ³•ï¼Œä¹Ÿå¯ä»¥è§¦å‘KVOï¼› å½“è§‚å¯Ÿçš„é”®å€¼æ¯”è¾ƒå¤æ‚ï¼Œæ¯”å¦‚Personçš„dog.nameçš„æ—¶å€™ï¼ŒåŠ¨æ€ç”Ÿæˆçš„ç±»åŒ…å«Personå’ŒDogï¼Œå³Personçš„dogå±æ€§å’ŒDogçš„nameå±æ€§å˜åŒ–æ—¶ï¼Œéƒ½ä¼šè§¦å‘KVOï¼› é€šè¿‡setValue:ForKeyçš„æ–¹å¼ä¹Ÿå¯ä»¥è§¦å‘KVOï¼Œå› ä¸ºå…¶é€»è¾‘å°±æ˜¯æ‰¾setXXXï¼Œ_setXXXè¿™äº›æ–¹æ³•ã€‚ å‚è€ƒèµ„æ–™ ä½ çš„KVOç”¨å¯¹äº†å— KVOControlleræºç  è‹¹æœå®˜æ–¹KVOæ–‡æ¡£ å¦‚ä½•ä¼˜é›…åœ°ä½¿ç”¨KVO KVOåº•å±‚å®ç°åŸç† ","link":"https://jayying007.github.io/post/KVO&KVOControlleråŠå…¶åŸç†/"},{"title":"æ­å»ºä¸ªäººåšå®¢","content":"æœåŠ¡å™¨é€‰è´­ æˆ‘è¿™æ¬¡é‡‡ç”¨çš„æ˜¯è…¾è®¯äº‘ï¼Œå› ä¸ºæˆ‘æœ‰å‡ ç™¾å—çš„ä»£é‡‘åŠµï¼Œå“ˆå“ˆã€‚ æ“ä½œç³»ç»Ÿï¼šUbuntu 20.04 LTS ç¡¬ä»¶é…ç½®ï¼š1æ ¸ 2GB 2Mbps ç³»ç»Ÿé…ç½® é€šè¿‡SSHè·å–å¯†ç ç™»å½•ç³»ç»Ÿï¼Œç„¶åéœ€è¦ä¿®æ”¹ä¸€ä¸‹DNSæœåŠ¡å™¨çš„é…ç½®ã€‚ é»˜è®¤å¥½åƒå¼€å¯äº†systemd-resolvedè¿™ä¸ªæœåŠ¡ï¼Œä¸€å¼€å§‹ä¸€ç›´è§£æä¸äº†DNSã€‚ å…³äºsystemd-resolvedï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼šhttps://www.freedomwolf.cc/2020/01/dns_by_systemd/ åœ¨/etc/systemd/resolved.confä¸­ï¼ŒæŠŠ#DNS= æ”¹ä¸ºDNS=1.1.1.1ï¼Œç„¶åé‡å¯æœåŠ¡å°±å¯ä»¥äº†ã€‚ sudo systemctl restart systemd-resolved.service ç„¶è€Œï¼Œç°åœ¨æ˜¯å¯ä»¥ping www.baidu.comäº†ï¼Œä½†æ˜¯tencentå†…éƒ¨çš„ä¸€äº›åŸŸåå°±è§£æä¸äº†äº†ã€‚ å½“æˆ‘æ‰§è¡Œsudo apt-get updateçš„æ—¶å€™ï¼Œä¼šå‡ºç°ä¸‹é¢è¿™æ®µå†…å®¹ Err:1 http://mirrors.tencentyun.com/ubuntu focal InRelease Something wicked happened resolving 'mirrors.tencentyun.com:http' (-5 - No address associated with hostname) Err:2 http://mirrors.tencentyun.com/ubuntu focal-security InRelease Something wicked happened resolving 'mirrors.tencentyun.com:http' (-5 - No address associated with hostname) Err:3 http://mirrors.tencentyun.com/ubuntu focal-updates InRelease Something wicked happened resolving 'mirrors.tencentyun.com:http' (-5 - No address associated with hostname) Reading package lists... Done W: Failed to fetch http://mirrors.tencentyun.com/ubuntu/dists/focal/InRelease Something wicked happened resolving 'mirrors.tencentyun.com:http' (-5 - No address associated with hostname) W: Failed to fetch http://mirrors.tencentyun.com/ubuntu/dists/focal-security/InRelease Something wicked happened resolving 'mirrors.tencentyun.com:http' (-5 - No address associated with hostname) W: Failed to fetch http://mirrors.tencentyun.com/ubuntu/dists/focal-updates/InRelease Something wicked happened resolving 'mirrors.tencentyun.com:http' (-5 - No address associated with hostname) W: Some index files failed to download. They have been ignored, or old ones used instead. ä¸€ç§æ–¹æ³•æ˜¯ä¿®æ”¹aptçš„é•œåƒæºï¼Œåœ¨/etc/apt/sources.listä¸­é…ç½®å…¶ä»–é•œåƒåœ°å€ å¦å¤–å°±æ˜¯ä½¿ç”¨è…¾è®¯çš„DNSæœåŠ¡å™¨äº†ã€‚åœ¨https://cloud.tencent.com/document/product/213/5225è¿™é‡Œæ‰¾ã€‚ æˆ‘çš„æ˜¯å¹¿å·å…­åŒºï¼Œæ‰¾ä¸åˆ°ï¼Œé—®äº†ä¸€ä¸‹å®¢æœï¼Œé€‰æ‹©äº†â€œç§æœ‰ç½‘ç»œ-æ‰€æœ‰åœ°åŸŸâ€è¿™ä¸ªç±»å‹çš„ipåœ°å€ï¼Œç„¶åå°±å¯ä»¥äº†ã€‚ Wordpressçš„æ­å»º è¿™ä¸ªæ ¹æ®æŸä½åšä¸»çš„æŒ‡å¼•ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªä¸é”™çš„è§†é¢‘æ•™ç¨‹ https://www.bilibili.com/video/BV1j4411C7Qf ä¹‹å‰ç”¨WordPressæ­å»ºäº†ä¸€éï¼Œä½†æ˜¯æ„Ÿè§‰WordPresså¯¹ä»£ç å’Œmarkdownçš„æ”¯æŒä¸å¤ªå¥½ï¼Œåé¢å°±æ”¹æ¢Hexoäº†ã€‚ å¦‚ä½•å®‰è£…Hexoå¯ä»¥åœ¨å®˜ç½‘å¾—åˆ°è¯¦ç»†çš„æ•™ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œä¸æ‰“ç®—å±•å¼€è®²ï¼Œä¸‹é¢è®²è®²å®˜ç½‘æ²¡æåˆ°çš„ã€‚ å®˜ç½‘æœ‰çš„å†…å®¹ å¦‚ä½•å®‰è£…Hexoæ¡†æ¶ å¦‚ä½•å»ºç½‘ç«™ã€å»ºæ–‡ç« ã€æœ¬åœ°å‘å¸ƒ æˆ‘è¦è®²çš„ åšå®¢ä¸»é¢˜ è¿™é‡Œæˆ‘é€‰æ‹©äº†NexTï¼Œæ¯”è¾ƒç®€æ´ï¼Œåœ°å€ï¼šhttps://theme-next.js.orgï¼Œç½‘ç«™é‡Œé¢ä¹Ÿä»‹ç»äº†å¦‚ä½•é…ç½®å„ç§ä¸œè¥¿ã€‚ å¦‚æœä½ ä¸æ¸…æ¥šæŸä¸€ä¸ªé…ç½®é¡¹å¦‚ä½•å®ç°çš„ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€ å¢åŠ åˆ†ç±»å’Œæ ‡ç­¾é¡µé¢ åœ¨sourceé‡Œé¢å¢åŠ categorieså’Œtagsä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œé‡Œé¢éƒ½æ·»åŠ ä¸€ä¸ªindex.mdæ–‡ä»¶ï¼Œå†…å®¹åˆ†åˆ«ä¸ºï¼š --- title: categories date: 2021-06-13 10:16:14 type: categories --- --- title: tags date: 2021-06-13 09:10:25 type: tags --- æœ€åè®°å¾—åœ¨NexTçš„é…ç½®ä¸­å¼€å¯è¿™ä¸¤ä¸ªï¼Œæ¯”å¦‚æˆ‘å½“å‰çš„é…ç½®å¦‚ä¸‹ï¼š menu: home: / || fa fa-home #about: /about/ || fa fa-user tags: /tags/ || fa fa-tags categories: /categories/ || fa fa-th archives: /archives/ || fa fa-archive #schedule: /schedule/ || fa fa-calendar #sitemap: /sitemap.xml || fa fa-sitemap #commonweal: /404/ || fa fa-heartbeat éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Š è¿™é‡Œé‡‡ç”¨Gitçš„æ–¹å¼éƒ¨ç½²ï¼Œé¦–å…ˆéœ€è¦å®‰è£…Gitéƒ¨ç½²æ’ä»¶ npm install hexo-deployer-git --save æœ¬åœ°é…ç½®æ·»åŠ ï¼ˆIPæ”¹ä¸ºä½ çš„æœåŠ¡å™¨åœ°å€ï¼ŒåŒæ—¶è¦å…ˆé…ç½®å¥½SSHï¼Œæ¯”å¦‚æˆ‘æœ¬åœ°é…ç½®äº†SSHå…å¯†ç™»é™†æœåŠ¡å™¨ï¼Œä¸ç„¶æ¯æ¬¡éƒ½éœ€è¦è¾“å…¥å¯†ç ï¼Œå½“ç„¶è¿™ä¹Ÿçœ‹ä½ ä¸ªäººæ„æ„¿ï¼‰ deploy: type: git repo: ubuntu@11.22.33.44:/home/ubuntu/hexo branch: master ç„¶ååœ¨æœåŠ¡å™¨ä¸Šé¢åˆ›å»ºä¸€ä¸ªhexoçš„gitä»“åº“ å†™åšå®¢çš„å‡ ä¸ªæ­¥éª¤ï¼š hexo new 'new blog title' å†™å†…å®¹... hexo clean hexo generate hexo deploy å¦‚æœä½ æŒ‰æˆ‘ä¸Šé¢è¯´çš„ï¼Œå½“ä½ deployçš„æ—¶å€™ï¼Œä¼šå‡ºé”™ On branch master nothing to commit, working tree clean Enumerating objects: 90, done. Counting objects: 100% (90/90), done. Delta compression using up to 8 threads Compressing objects: 100% (77/77), done. Writing objects: 100% (90/90), 54.96 KiB | 3.92 MiB/s, done. Total 90 (delta 15), reused 0 (delta 0), pack-reused 0 remote: error: refusing to update checked out branch: refs/heads/master remote: error: By default, updating the current branch in a non-bare repository remote: is denied, because it will make the index and work tree inconsistent remote: with what you pushed, and will require 'git reset --hard' to match remote: the work tree to HEAD. remote: remote: You can set the 'receive.denyCurrentBranch' configuration variable remote: to 'ignore' or 'warn' in the remote repository to allow pushing into remote: its current branch; however, this is not recommended unless you remote: arranged to update its work tree to match what you pushed in some remote: other way. remote: remote: To squelch this message and still keep the default behaviour, set remote: 'receive.denyCurrentBranch' configuration variable to 'refuse'. To 159.75.249.140:/home/ubuntu/hexo ! [remote rejected] HEAD -&gt; master (branch is currently checked out) error: failed to push some refs to '159.75.249.140:/home/ubuntu/hexo' FATAL { err: Error: Spawn failed at ChildProcess.&lt;anonymous&gt; (/Users/jieyingzhuang/Desktop/blog/node_modules/hexo-util/lib/spawn.js:51:21) at ChildProcess.emit (node:events:394:28) at Process.ChildProcess._handle.onexit (node:internal/child_process:290:12) { code: 1 } } Something's wrong. Maybe you can find the solution here: %s https://hexo.io/docs/troubleshooting.html ä½ å¯ä»¥æŒ‰ç…§æç¤ºè¾“å…¥å‘½ä»¤git config receive.denyCurrentBranch ignoreè§£å†³ï¼Œè¿™é‡Œæˆ‘é‡‡ç”¨å¦ä¸€ç§æ–¹æ³•è§£å†³ï¼š åˆ›å»ºè£¸ä»“åº“ï¼Œå’Œä»£ç æ–‡ä»¶åˆ†å¼€å­˜æ”¾ åˆ›å»ºä¸€ä¸ªå«hexo.gitçš„è£¸ä»“åº“ï¼Œæ‰€ä»¥hexoçš„é…ç½®ä¿¡æ¯ä¹Ÿè¦æ¢æˆhexo.gitï¼Œåˆ›å»ºhexoç©ºæ–‡ä»¶å¤¹ã€‚ç„¶åæ·»åŠ é’©å­post-receiveå¹¶è®¾ç½®ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‡Œé¢çš„å†…å®¹ä¸º git --work-tree=/home/ubuntu/hexo --git-dir=/home/ubuntu/hexo.git checkout -f è¿™æ ·ï¼Œå½“ä½ deployçš„æ—¶å€™ï¼Œä¼šæŠŠç½‘ç«™çš„å†…å®¹åˆ°å­˜åˆ°hexoæ–‡ä»¶å¤¹ä¸­ã€‚åé¢ä½ è¿˜éœ€è¦é…ç½®æœåŠ¡å™¨ï¼Œç”¨Apacheæˆ–è€…Nginxï¼Œç„¶åæŒ‡å®šç½‘ç«™çš„æ ¹ç›®å½•ä¸ºhexoï¼Œå³å¯æ­£å¸¸è®¿é—®ã€‚ æ²¡è®²çš„ä¸œè¥¿ æ„Ÿè§‰å±äºå…¶ä»–æ–¹é¢çš„çŸ¥è¯†ï¼Œæˆ‘å°±æ²¡æœ‰ç»†è¯´ã€‚è¿™äº›ä¹Ÿå¯ä»¥æ‰¾å…¶ä»–åšå®¢çœ‹çœ‹ã€‚ SSHå…å¯†ç™»é™† é…ç½®NginxæœåŠ¡å™¨ï¼ˆé…ç½®SSLè¯ä¹¦ï¼‰ Hexoå…·ä½“çš„é…ç½®ä¿¡æ¯ï¼ˆä¸»è¦çœ‹å„è‡ªå–œå¥½ï¼‰ ","link":"https://jayying007.github.io/post/æ­å»ºä¸ªäººåšå®¢/"}]}